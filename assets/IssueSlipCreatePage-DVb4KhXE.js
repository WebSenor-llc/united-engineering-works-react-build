import{u as X,i as Z,a as ee,r as m,h as b,e as y,y as _,j as e,B as q,A as te}from"./index-DSLs68fz.js";import{F as se}from"./FormHeader-CWTf_50F.js";import{T as j}from"./TextInput-CWb4FDJ1.js";import{S as re}from"./Select-BUgIEQte.js";import{L as ae}from"./ListWrapper-CfuZSALB.js";import{T as ie}from"./TableActions-Dv38ne2k.js";import{T as oe,a as ne,b as u}from"./TableWrapper-DIs52MZg.js";import{T as le}from"./TableDelete-CCBWysz_.js";import{u as me,b as de,C as l}from"./index.esm-51NyA9dG.js";import{L as ue}from"./Loading-C52XRUuf.js";import{u as ce}from"./useMachineStore-DLWAG8AX.js";import{u as pe}from"./useMaterialRequestStore-Da1p-v_o.js";import{o as _e,k as fe}from"./yup-DwIng6A-.js";import{C as he}from"./CommonFilter-BAP9ZFyE.js";import"./BackButton-DsxJG3yl.js";const f={mr:"",machine:"",for_party:"",for_mines:"",issued_to:"",purpose:"",items:[{item_name:"",item_code:"",item_id:"",item_unit:"",required_qty:"",issued_qty:""}]},Ee=()=>{const N=X(),[R]=Z(),a=R.get("editId"),{selectedBranchId:E}=ee(),{materials:o,fetchMaterials:g}=pe(),[P,I]=m.useState(!1),[M,v]=m.useState(!1),{machines:$,fetchMachines:F}=ce(),[xe,k]=m.useState([]),[A,D]=m.useState({}),L=[{name:"mr_number",label:"MR Number",placeholder:"Enter MR Number"},{name:"item_name",label:"Item Name",placeholder:"Enter Item Name"},{name:"date_from",label:"Date From",type:"date"},{name:"date_to",label:"Date To",type:"date"}],{control:n,handleSubmit:U,setValue:c,reset:w,watch:V,formState:{errors:p}}=me({defaultValues:f,resolver:_e(fe)}),{fields:O,append:B,remove:H}=de({control:n,name:"items"}),i=V("mr");m.useEffect(()=>{g(),F()},[g,F]),m.useEffect(()=>{o&&o.length>0&&k(o)},[o]);const Q=async t=>{D(t);const s={};t.requested_by&&(s.requested_by=t.requested_by),t.mr_number&&(s.mr_number=t.mr_number),t.item_name&&(s.item_name=t.item_name),t.date_from&&t.date_to?t.date_from===t.date_to?s.date=t.date_from:(s.date_from=t.date_from,s.date_to=t.date_to):(t.date_from&&(s.date_from=t.date_from),t.date_to&&(s.date_to=t.date_to)),await g(s)},C=m.useCallback(async t=>{try{const s=o&&o.find(h=>h.mr_number===t);if(!s)return;const S=(await b.get(y.material_requisition.details(s.id))).data?.material_requisition;if(S?.items?.length>0){const h=S.items.map(d=>{const x=d.item,Y=x?.id||d.item_id,z=x?.item_name||d.item_name,G=x?.item_code||d.item_code,J=x?.unit?.unit_name||d.unit?.unit_name||d.item_unit,K=d.quantity_required||d.quantity||d.required_qty;return{item_id:Y?.toString()||"",item_name:z||"",item_code:G||"",item_unit:J||"",required_qty:K?.toString()||"",issued_qty:""}});c("items",h),_.success(`Loaded ${h.length} items from MR ${t}`)}else c("items",f.items),_.info("No items found for the selected MR")}catch(s){console.error("Failed to fetch MR details:",s),_.error("Failed to load MR details")}},[o,c]),T=m.useCallback(async()=>{if(a){I(!0);try{const t=await b.get(y.issue_slips.details(Number(a))),s=t.data.slip||t.data.data||t.data;w({mr:s.mr,machine:s.machine?String(s.machine):"",for_party:s.for_party??"",for_mines:s.for_mines??"",issued_to:s.issued_for??"",purpose:s.purpose??"",items:s.items?.map(r=>({item_id:r.item_id?.toString()||"",item_code:r.item?.item_code||"",item_name:r.item?.item_name||"",item_unit:r.item?.unit?.unit_name||"",required_qty:r.required_qty?.toString()||"",issued_qty:r.issued_qty?.toString()||""}))||f.items})}finally{I(!1)}}},[a,w]);m.useEffect(()=>{a&&T()},[a,T]),m.useEffect(()=>{i&&!a&&o&&o.length>0?C(i):!i&&!a&&c("items",f.items)},[i,a,o,C,c]);const W=async t=>{v(!0);const s={mr:t.mr,branch_id:E,machine_id:t.machine?Number(t.machine):null,for_party:t.for_party,for_mines:t.for_mines,issued_for:t.issued_to,purpose:t.purpose,items:t.items.filter(r=>r.item_id).map(r=>({item_id:Number(r.item_id),required_qty:Number(r.required_qty)||0,issued_qty:Number(r.issued_qty),transaction_type:"opening_stock"}))};try{const r=a?y.issue_slips.update(Number(a)):y.issue_slips.create;await(a?b.put:b.post)(r,s),_.success(a?"Issue slip updated successfully":"Issue slip created successfully"),N(te.ISSUE_SLIP.LIST)}catch(r){console.error(r),_.error(r.response?.data?.message||"Failed to save issue slip")}finally{v(!1)}};return P?e.jsx("div",{className:"flex justify-center py-20",children:e.jsx(ue,{})}):e.jsxs("div",{className:"w-full h-full overflow-auto space-y-8 p-4 pb-20",children:[e.jsx(se,{title:a?"Edit Issue Slip":"Create Issue Slip",subtitle:a?"Update the Issue Slip details":"Fill out the form to submit a new Issue Slip"}),e.jsx(he,{fields:L,onFilter:Q,defaultValues:A}),e.jsxs("div",{className:"grid grid-cols-2 gap-5 ml-2 mr-5",children:[e.jsx(l,{name:"mr",control:n,render:({field:t})=>e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-semibold text-gray-700 mb-1",children:"Issued To MR"}),e.jsxs("select",{...t,disabled:!!a,className:"w-full h-[45px] rounded-lg border border-gray-300 px-4 mt-1 text-sm",children:[e.jsx("option",{value:"",children:"Select Material Requisition"}),o&&o.length>0?o.map(s=>e.jsxs("option",{value:s.mr_number,children:[s.mr_number," - ",s.department||"Unknown Dept"]},s.mr_number)):e.jsx("option",{disabled:!0,children:"No Material Requisitions Available"})]})]})}),e.jsx(l,{name:"machine",control:n,render:({field:t})=>e.jsxs(re,{...t,label:"For Machine",error:p.machine?.message,children:[e.jsx("option",{value:"",children:"Select Machine"}),$.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})}),e.jsx(l,{name:"for_party",control:n,render:({field:t})=>e.jsx(j,{...t,label:"For Party",placeholder:"Enter Party Name",error:p.for_party?.message})}),e.jsx(l,{name:"for_mines",control:n,render:({field:t})=>e.jsx(j,{...t,label:"For Mines",placeholder:"Enter Mine",error:p.for_mines?.message})}),e.jsx(l,{name:"issued_to",control:n,render:({field:t})=>e.jsx(j,{...t,label:"Issued To",placeholder:"Enter Name ",error:p.issued_to?.message})}),e.jsx(l,{name:"purpose",control:n,render:({field:t})=>e.jsx(j,{...t,label:"Purpose",placeholder:"Enter Purpose",error:p.purpose?.message})})]}),e.jsxs(ae,{title:"Items to Issue",children:[e.jsx("div",{className:"flex justify-end mb-2",children:!i&&e.jsx(q,{className:"bg-red-600 text-white px-3 py-1",onClick:()=>B({...f.items[0]}),children:"+ Add Item"})}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(oe,{children:[e.jsx(ne,{cols:[{title:"Item Name"},{title:"Item Code"},{title:"Item Unit"},{title:"Required QTY"},{title:"Issued QTY"},{title:"Action"}]}),e.jsx("tbody",{children:O.map((t,s)=>e.jsxs("tr",{className:"align-middle",children:[e.jsx(u,{children:s+1}),e.jsx(u,{children:e.jsx(l,{name:`items.${s}.item_name`,control:n,render:({field:r})=>e.jsx("input",{...r,readOnly:!!i,className:`w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm ${i?"bg-gray-50":""}`,placeholder:"Item Name"})})}),e.jsx(u,{children:e.jsx(l,{name:`items.${s}.item_code`,control:n,render:({field:r})=>e.jsx("input",{...r,readOnly:!!i,className:`w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm ${i?"bg-gray-50":""}`,placeholder:"Code"})})}),e.jsx(u,{children:e.jsx(l,{name:`items.${s}.item_unit`,control:n,render:({field:r})=>e.jsx("input",{...r,readOnly:!!i,className:`w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm ${i?"bg-gray-50":""}`,placeholder:"Unit"})})}),e.jsx(u,{children:e.jsx(l,{name:`items.${s}.required_qty`,control:n,render:({field:r})=>e.jsx("input",{...r,type:"number",readOnly:!!i,className:`w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm ${i?"bg-gray-50":""}`,placeholder:"0"})})}),e.jsx(u,{children:e.jsx(l,{name:`items.${s}.issued_qty`,control:n,render:({field:r})=>e.jsx("input",{...r,type:"number",className:"w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm",placeholder:"0"})})}),e.jsx(u,{children:e.jsx(ie,{children:!i&&e.jsx(le,{onClick:()=>H(s)})})})]},t.id))})]})})]}),e.jsxs("div",{className:"flex justify-end gap-3 mr-5",children:[e.jsx(q,{variant:"outline",onClick:()=>N(-1),children:"Cancel"}),e.jsx(q,{className:"bg-red-600 text-white",onClick:U(W),loading:M,disabled:M,children:a?"Update Issue Slip":"Submit Issue Slip"})]})]})};export{Ee as default};
