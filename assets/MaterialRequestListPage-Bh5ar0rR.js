import{r as d,a as S,j as e,M as a,y as N,e as c,h as E,u as L,k as B,D as C,P as T,T as O,H as q,A as P}from"./index-DHxjsmS_.js";import{L as M}from"./ListWrapper-Cc4XzfgT.js";import{T as k,a as H,b as o}from"./TableWrapper-Cc34JFCi.js";import{T as Y}from"./TableRow-CUJFv1cP.js";import{u as V}from"./usePagination-CsbUaw-r.js";import{T as $,a as I}from"./TableDelete-CBS2zXrt.js";import{T as U}from"./TableEdit-DAgKBokJ.js";import{R as w}from"./ReasonModal-DHuqEBq0.js";import{S as J}from"./StatusFilter-DIAqaz0-.js";const F=({materialRequisition:r,onStatusUpdate:_})=>{const[g,b]=d.useState(!1),[D,l]=d.useState(!1),[R,u]=d.useState(!1),[m,x]=d.useState(null),{user:A}=S(),p=async(s,i)=>{b(!0);try{let n="",y={};if((s===a.REJECTED_BY_DEPT_HEAD||s===a.CANCELLED_BY_STORE)&&!i){N.error("Reason is required");return}switch(s){case a.PENDING_DEPT_APPROVAL:n=c.material_requisition.submit(r.id),await E.post(n);break;case a.APPROVED_BY_DEPT_HEAD:n=c.material_requisition.approveDept(r.id),await E.post(n,{action:"approve"});break;case a.REJECTED_BY_DEPT_HEAD:n=c.material_requisition.reject(r.id),y={action:"reject",cancellation_reason:i||"No reason provided"},await E.post(n,y);break;case a.APPROVED_BY_STORE:n=c.material_requisition.approveStore(r.id),await E.post(n);break;case a.CANCELLED_BY_STORE:n=c.material_requisition.cancel(r.id),y={action:"cancel",cancellation_reason:i||"No reason provided"},await E.post(n,y);break;case a.COMPLETED:N.success("Material Requisition marked as Completed");break;default:throw new Error("Invalid status change")}N.success("Status updated successfully"),_()}catch(n){console.error("Failed to update status:",n),N.error(n.response?.data?.message||"Failed to update status")}finally{b(!1)}},t=(()=>{const s=r.status,i=A?.role?.role_name;switch(s){case a.PENDING_DEPT_APPROVAL:return i==="Department Head"?[{value:a.APPROVED_BY_DEPT_HEAD,label:"Approve"},{value:a.REJECTED_BY_DEPT_HEAD,label:"Reject"}]:[];case a.APPROVED_BY_DEPT_HEAD:if(i==="Store Manager")return[{value:a.APPROVED_BY_STORE,label:"Approve"},{value:a.CANCELLED_BY_STORE,label:"Cancel"}];break;default:return[]}return[]})(),v=s=>{s===a.REJECTED_BY_DEPT_HEAD?(x({status:s,actionType:"reject"}),l(!0)):s===a.CANCELLED_BY_STORE?(x({status:s,actionType:"cancel"}),l(!0)):p(s)},h=s=>{m&&(p(m.status,s),x(null)),l(!1)},j=()=>{x(null),l(!1)};return t.length===0?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs px-2 py-1 bg-gray-100 text-gray-700 rounded border",children:r.status}),(r.status===a.CANCELLED_BY_STORE||r.status===a.REJECTED_BY_DEPT_HEAD)&&r.cancellation_reason&&e.jsx("button",{onClick:()=>u(!0),className:"text-xs px-2 py-1 bg-red-100 text-red-700 rounded border border-red-200 hover:bg-red-200 transition-colors",title:"View reason",children:"View Reason"})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex items-center gap-2",children:g?e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"}),e.jsx("span",{className:"text-xs text-gray-500",children:"Updating..."})]}):e.jsxs(e.Fragment,{children:[e.jsxs("select",{className:"text-xs border border-gray-300 rounded px-2 py-1 focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white min-w-[120px]",value:"",onChange:s=>{s.target.value&&(v(s.target.value),s.target.value="")},children:[e.jsx("option",{value:"",children:r.status}),t.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))]}),(r.status===a.CANCELLED_BY_STORE||r.status===a.REJECTED_BY_DEPT_HEAD)&&r.cancellation_reason&&e.jsx("button",{onClick:()=>u(!0),className:"text-xs px-2 py-1 bg-red-100 text-red-700 rounded border border-red-200 hover:bg-red-200 transition-colors",title:"View reason",children:"View Reason"})]})}),e.jsx(w,{open:R,onClose:()=>u(!1),title:r.status===a.CANCELLED_BY_STORE?"Cancellation Reason":"Rejection Reason",message:r.cancellation_reason||"No reason provided",readonly:!0}),e.jsx(w,{open:D,onClose:j,onSubmit:h,title:m?.actionType==="reject"?"Rejection Reason":"Cancellation Reason",message:m?.actionType==="reject"?"Please provide a reason for rejecting this material request:":"Please provide a reason for cancelling this material request:"})]})},se=()=>{const{renderPagination:r}=V(),_=L(),{selectedBranchId:g,user:b}=S(),{setMaterialRequisitions:D}=B(),[l,R]=d.useState(""),[u,m]=d.useState([]),[x,A]=d.useState(!0),p=async()=>{A(!0);try{const t=g?`${c.material_requisition.items}&branch_id=${g}`:c.material_requisition.items,h=(await E.get(t)).data?.material_requisitions||[];m(h);const j=b?.role?.role_name;let s=0;j==="Department Head"?s=h.filter(i=>i.status==="Pending Approval (Dept Head)").length:j==="Store Manager"?s=h.filter(i=>i.status==="Approved - With Head").length:j==="Super Admin"&&(s=h.filter(i=>i.status==="Approved - With Store").length),D(s)}catch(t){console.error("Error fetching material requests:",t)}finally{A(!1)}};d.useEffect(()=>{p()},[g]);const f=l?u.filter(t=>t.status===l):u;return e.jsxs("div",{className:"space-y-6",children:[e.jsx(J,{module:"materialRequisition",selectedStatus:l,onChange:t=>R(t)}),e.jsxs(M,{title:`Material Requests (${f.length})`,createOnClick:T.hasPermission("material_requisition_create")?()=>_(P.MATERIAL_REQUEST.CREATE):void 0,children:[e.jsxs(k,{children:[e.jsx(H,{cols:[{title:"MR Number"},{title:"Department"},{title:"Priority"},{title:"Requested By"},{title:"Required By"},{title:"Status"},{title:"Created At"},{title:"Actions"}]}),e.jsx("tbody",{children:x&&f.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:10,className:"px-6 py-12 text-center",children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("svg",{className:"w-12 h-12 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),e.jsx("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"No material requests"}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:l?`No requests found with status "${l}"`:"Get started by creating a new material request."})]})})}):f.map((t,v)=>e.jsxs(Y,{children:[e.jsx(o,{className:"w-12 text-center font-medium",children:e.jsx("div",{className:"text-sm text-gray-900",children:v+1})}),e.jsx(o,{className:"w-40",children:e.jsx("div",{className:"flex items-center",children:e.jsx("div",{className:"text-sm font-medium text-gray-900",children:t.mr_number})})}),e.jsx(o,{className:"w-36",children:e.jsx("div",{className:"text-sm text-gray-900",children:t.department})}),e.jsx(o,{className:"w-28",children:e.jsx("span",{className:"inline-flex items-center justify-center px-2 py-1 text-xs font-medium bg-gray-100 text-gray-800 rounded-full",children:t.priority})}),e.jsx(o,{className:"w-48",children:e.jsx("div",{className:"flex items-center",children:e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:t.requested_by?.full_name||"â€”"}),e.jsx("div",{className:"text-sm text-gray-500",children:t.requested_by?.employee_code||""})]})})}),e.jsx(o,{className:"w-32",children:e.jsx("div",{className:"text-sm text-gray-900",children:C.date(t.required_by_date)})}),e.jsx(o,{className:"w-40",children:e.jsx(F,{materialRequisition:{id:t.id,status:t.status,mr_number:t.mr_number},onStatusUpdate:p})}),e.jsx(o,{className:"w-32",children:e.jsx("div",{className:"text-sm text-gray-500",children:C.date(t.created_at)})}),e.jsx(o,{className:"w-20",children:e.jsxs($,{children:[T.hasPermission("material_requisition_update")&&e.jsx(O,{title:`View Material Request ${t.mr_number}`,children:e.jsx("button",{onClick:()=>_(`${P.MATERIAL_REQUEST.CREATE}?id=${t.id}`),className:"flex items-center justify-center w-8 h-8 sm:w-9 sm:h-9 rounded-full hover:bg-gray-200 hover:text-gray-700 transition bg-gray-200 text-gray-700 disabled:cursor-not-allowed disabled:opacity-40 touch-manipulation",children:e.jsx(q,{className:"w-4 h-4"})})}),T.hasPermission("material_requisition_update")&&e.jsx(U,{onClick:()=>_(`${P.MATERIAL_REQUEST.CREATE}?id=${t.id}`)}),T.hasPermission("material_requisition_delete")&&e.jsx(I,{refetch:p,endpoint:c.material_requisition.delete(t.id)})]})})]},t.id))})]}),f.length>0&&r()]})]})};export{se as default};
