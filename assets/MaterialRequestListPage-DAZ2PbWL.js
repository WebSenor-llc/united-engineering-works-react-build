import{r as d,a as V,j as e,M as s,y as T,e as p,h as x,u as Y,k,D as M,P as S,A as L}from"./index-B2Kq7pF4.js";import{L as q}from"./ListWrapper-BCNScaty.js";import{T as H,a as F,b as c}from"./TableWrapper-jqHXbh_L.js";import{T as I}from"./TableRow-BJlAj-zV.js";import{u as U}from"./usePagination-Cnfjy3pF.js";import{T as J}from"./TableActions-v4FwT6Lt.js";import{T as $}from"./TableEdit-DKIDQymF.js";import{T as W}from"./TableDelete-DKVpIjq0.js";import{R as O}from"./ReasonModal-BQ8FdC37.js";import{c as G}from"./rolePermissions-B_cCEq_W.js";import{T as Q}from"./TableView-zLOjK5Bn.js";import{C as z}from"./CommonFilter-DYIt7Pg1.js";import"./index.esm-B19_P2AP.js";import"./TextInput-D6Nk2HMm.js";const K=({materialRequisition:r,onStatusUpdate:f})=>{const[v,g]=d.useState(!1),[b,m]=d.useState(!1),[N,_]=d.useState(!1),[l,u]=d.useState(null),{user:y}=V(),j=async(a,i)=>{g(!0);try{let t="",o={};if((a===s.REJECTED_BY_DEPT_HEAD||a===s.CANCELLED_BY_STORE)&&!i){T.error("Reason is required");return}switch(a){case s.PENDING_DEPT_APPROVAL:t=p.material_requisition.submit(r.id),await x.post(t);break;case s.APPROVED_BY_DEPT_HEAD:t=p.material_requisition.approveDept(r.id),await x.post(t,{action:"approve"});break;case s.REJECTED_BY_DEPT_HEAD:t=p.material_requisition.reject(r.id),o={action:"reject",cancellation_reason:i||"No reason provided"},await x.post(t,o);break;case s.APPROVED_BY_STORE:t=p.material_requisition.approveStore(r.id),await x.post(t);break;case s.CANCELLED_BY_STORE:t=p.material_requisition.cancel(r.id),o={action:"cancel",cancellation_reason:i||"No reason provided"},await x.post(t,o);break;case s.COMPLETED:T.success("Material Requisition marked as Completed");break;default:throw new Error("Invalid status change")}T.success("Status updated successfully"),f()}catch(t){console.error("Failed to update status:",t),T.error(t.response?.data?.message||"Failed to update status")}finally{g(!1)}},n=(()=>{const a=r.status,i=y?.role?.role_name||"";switch(a){case s.PENDING_DEPT_APPROVAL:return G(i)?[{value:s.APPROVED_BY_DEPT_HEAD,label:"Approve"},{value:s.REJECTED_BY_DEPT_HEAD,label:"Reject"}]:[];case s.APPROVED_BY_DEPT_HEAD:if(i==="Store Manager")return[{value:s.APPROVED_BY_STORE,label:"Approve"},{value:s.CANCELLED_BY_STORE,label:"Cancel"}];break;default:return[]}return[]})(),P=a=>{a===s.REJECTED_BY_DEPT_HEAD?(u({status:a,actionType:"reject"}),m(!0)):a===s.CANCELLED_BY_STORE?(u({status:a,actionType:"cancel"}),m(!0)):j(a)},h=a=>{l&&(j(l.status,a),u(null)),m(!1)},C=()=>{u(null),m(!1)};return n.length===0?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs px-2 py-1 bg-gray-100 text-gray-700 rounded border",children:r.status}),(r.status===s.CANCELLED_BY_STORE||r.status===s.REJECTED_BY_DEPT_HEAD)&&r.cancellation_reason&&e.jsx("button",{onClick:()=>_(!0),className:"text-xs px-2 py-1 bg-red-100 text-red-700 rounded border border-red-200 hover:bg-red-200 transition-colors",title:"View reason",children:"View Reason"})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex items-center gap-2",children:v?e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"}),e.jsx("span",{className:"text-xs text-gray-500",children:"Updating..."})]}):e.jsxs(e.Fragment,{children:[e.jsxs("select",{className:"text-xs border border-gray-300 rounded px-2 py-1 focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white min-w-[120px]",value:"",onChange:a=>{a.target.value&&(P(a.target.value),a.target.value="")},children:[e.jsx("option",{value:"",children:r.status}),n.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))]}),(r.status===s.CANCELLED_BY_STORE||r.status===s.REJECTED_BY_DEPT_HEAD)&&r.cancellation_reason&&e.jsx("button",{onClick:()=>_(!0),className:"text-xs px-2 py-1 bg-red-100 text-red-700 rounded border border-red-200 hover:bg-red-200 transition-colors",title:"View reason",children:"View Reason"})]})}),e.jsx(O,{open:N,onClose:()=>_(!1),title:r.status===s.CANCELLED_BY_STORE?"Cancellation Reason":"Rejection Reason",message:r.cancellation_reason||"No reason provided",readonly:!0}),e.jsx(O,{open:b,onClose:C,onSubmit:h,title:l?.actionType==="reject"?"Rejection Reason":"Cancellation Reason",message:l?.actionType==="reject"?"Please provide a reason for rejecting this material request:":"Please provide a reason for cancelling this material request:"})]})},ue=()=>{const{page:r,rowsPerPage:f,setTotal:v,renderPagination:g}=U(),b=Y(),{selectedBranchId:m,user:N}=V(),{setMaterialRequisitions:_}=k(),[l]=d.useState(""),[u,y]=d.useState([]),[j,R]=d.useState(!0),[n,P]=d.useState({date_from:"",date_to:"",item_name:"",mr_number:""}),h=async()=>{R(!0);try{const t={page:r+1,rowsPerPage:f,...m&&{branch_id:m}};n.date_from&&(t.date_from=n.date_from),n.date_to&&(t.date_to=n.date_to),n.item_name&&(t.item_name=n.item_name),n.mr_number&&(t.mr_number=n.mr_number);const o=await x.get(p.material_requisition.items,{params:t}),A=o.data?.material_requisitions||[],B=o.data?.pagination;y(A),B?.total!==void 0&&v(B.total);const w=N?.role?.role_name;let D=0;w==="Department Head"?D=A.filter(E=>E.status==="Pending Approval (Dept Head)").length:w==="Store Manager"?D=A.filter(E=>E.status==="Approved - With Head").length:w==="Super Admin"&&(D=A.filter(E=>E.status==="Approved - With Store").length),_(D)}catch(t){console.error("Error fetching material requests:",t)}finally{R(!1)}};d.useEffect(()=>{h()},[r,f,m,n]);const C=[{name:"mr_number",label:"MR Number",type:"text",placeholder:"Enter MR Number"},{name:"item_name",label:"Item Name",type:"text",placeholder:"Enter Item Name"},{name:"date_from",label:"Date From",type:"date"},{name:"date_to",label:"Date To",type:"date"}],a=t=>{P(t)},i=l?u.filter(t=>t.status===l):u;return e.jsx("div",{className:"space-y-6",children:e.jsxs(q,{title:`Material Requests (${i.length})`,createOnClick:S.hasPermission("material_requisition_create")?()=>b(L.MATERIAL_REQUEST.CREATE):void 0,children:[e.jsx(z,{fields:C,onFilter:a,defaultValues:n}),e.jsxs(H,{children:[e.jsx(F,{cols:[{title:"MR Number"},{title:"Department"},{title:"Priority"},{title:"Requested By"},{title:"Required By"},{title:"Status"},{title:"Created At"},{title:"Actions"}]}),e.jsx("tbody",{children:j&&i.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:10,className:"px-6 py-12 text-center",children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("svg",{className:"w-12 h-12 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),e.jsx("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"No material requests"}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:l?`No requests found with status "${l}"`:"Get started by creating a new material request."})]})})}):i.map((t,o)=>e.jsxs(I,{children:[e.jsx(c,{className:"w-12 text-center font-medium",children:e.jsx("div",{className:"text-sm text-gray-900",children:o+1})}),e.jsx(c,{className:"w-40",children:e.jsx("div",{className:"flex items-center",children:e.jsx("div",{className:"text-sm font-medium text-gray-900",children:t.mr_number})})}),e.jsx(c,{className:"w-36",children:e.jsx("div",{className:"text-sm text-gray-900",children:t.department})}),e.jsx(c,{className:"w-28",children:e.jsx("span",{className:"inline-flex items-center justify-center px-2 py-1 text-xs font-medium bg-gray-100 text-gray-800 rounded-full",children:t.priority})}),e.jsx(c,{className:"w-48",children:e.jsx("div",{className:"flex items-center",children:e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:t.requested_by?.full_name||"â€”"}),e.jsx("div",{className:"text-sm text-gray-500",children:t.requested_by?.employee_code||""})]})})}),e.jsx(c,{className:"w-32",children:e.jsx("div",{className:"text-sm text-gray-900",children:M.date(t.required_by_date)})}),e.jsx(c,{className:"w-40",children:e.jsx(K,{materialRequisition:{id:t.id,status:t.status,mr_number:t.mr_number},onStatusUpdate:h})}),e.jsx(c,{className:"w-32",children:e.jsx("div",{className:"text-sm text-gray-500",children:M.date(t.created_at)})}),e.jsx(c,{className:"w-20",children:e.jsxs(J,{children:[e.jsx(Q,{url:`${L.MATERIAL_REQUEST.DETAILS.replace(":id","")}${t.id}`,tooltip:"View Material Request Details"}),S.hasPermission("material_requisition_update")&&e.jsx($,{onClick:()=>b(`${L.MATERIAL_REQUEST.CREATE}?id=${t.id}`)}),S.hasPermission("material_requisition_delete")&&e.jsx(W,{refetch:h,endpoint:p.material_requisition.delete(t.id)})]})})]},t.id))})]}),i.length>0&&g()]})})};export{ue as default};
