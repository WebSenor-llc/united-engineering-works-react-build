import{r as d,a as w,j as e,M as a,y as T,e as c,h as E,u as L,k as B,D as C,P as y,A as P}from"./index-zSIHDd_i.js";import{L as O}from"./ListWrapper-DoFaRH6P.js";import{T as q,a as M,b as o}from"./TableWrapper-Bwk1LSIu.js";import{T as Y}from"./TableRow-F8MSZPbu.js";import{u as k}from"./usePagination-mcOS4Aak.js";import{T as V,a as H}from"./TableDelete-BEyOmHVS.js";import{T as I}from"./TableEdit-D3e67rz4.js";import{R as S}from"./ReasonModal-DW2EcTJL.js";import{c as $}from"./rolePermissions-NXJEoSR0.js";import{S as U}from"./StatusFilter-CSiUwQ3Q.js";import{T as J}from"./TableView-CevgA90s.js";const F=({materialRequisition:r,onStatusUpdate:j})=>{const[_,b]=d.useState(!1),[N,l]=d.useState(!1),[R,u]=d.useState(!1),[m,x]=d.useState(null),{user:A}=w(),p=async(t,i)=>{b(!0);try{let n="",D={};if((t===a.REJECTED_BY_DEPT_HEAD||t===a.CANCELLED_BY_STORE)&&!i){T.error("Reason is required");return}switch(t){case a.PENDING_DEPT_APPROVAL:n=c.material_requisition.submit(r.id),await E.post(n);break;case a.APPROVED_BY_DEPT_HEAD:n=c.material_requisition.approveDept(r.id),await E.post(n,{action:"approve"});break;case a.REJECTED_BY_DEPT_HEAD:n=c.material_requisition.reject(r.id),D={action:"reject",cancellation_reason:i||"No reason provided"},await E.post(n,D);break;case a.APPROVED_BY_STORE:n=c.material_requisition.approveStore(r.id),await E.post(n);break;case a.CANCELLED_BY_STORE:n=c.material_requisition.cancel(r.id),D={action:"cancel",cancellation_reason:i||"No reason provided"},await E.post(n,D);break;case a.COMPLETED:T.success("Material Requisition marked as Completed");break;default:throw new Error("Invalid status change")}T.success("Status updated successfully"),j()}catch(n){console.error("Failed to update status:",n),T.error(n.response?.data?.message||"Failed to update status")}finally{b(!1)}},s=(()=>{const t=r.status,i=A?.role?.role_name||"";switch(t){case a.PENDING_DEPT_APPROVAL:return $(i)?[{value:a.APPROVED_BY_DEPT_HEAD,label:"Approve"},{value:a.REJECTED_BY_DEPT_HEAD,label:"Reject"}]:[];case a.APPROVED_BY_DEPT_HEAD:if(i==="Store Manager")return[{value:a.APPROVED_BY_STORE,label:"Approve"},{value:a.CANCELLED_BY_STORE,label:"Cancel"}];break;default:return[]}return[]})(),v=t=>{t===a.REJECTED_BY_DEPT_HEAD?(x({status:t,actionType:"reject"}),l(!0)):t===a.CANCELLED_BY_STORE?(x({status:t,actionType:"cancel"}),l(!0)):p(t)},h=t=>{m&&(p(m.status,t),x(null)),l(!1)},f=()=>{x(null),l(!1)};return s.length===0?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs px-2 py-1 bg-gray-100 text-gray-700 rounded border",children:r.status}),(r.status===a.CANCELLED_BY_STORE||r.status===a.REJECTED_BY_DEPT_HEAD)&&r.cancellation_reason&&e.jsx("button",{onClick:()=>u(!0),className:"text-xs px-2 py-1 bg-red-100 text-red-700 rounded border border-red-200 hover:bg-red-200 transition-colors",title:"View reason",children:"View Reason"})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex items-center gap-2",children:_?e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"}),e.jsx("span",{className:"text-xs text-gray-500",children:"Updating..."})]}):e.jsxs(e.Fragment,{children:[e.jsxs("select",{className:"text-xs border border-gray-300 rounded px-2 py-1 focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white min-w-[120px]",value:"",onChange:t=>{t.target.value&&(v(t.target.value),t.target.value="")},children:[e.jsx("option",{value:"",children:r.status}),s.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))]}),(r.status===a.CANCELLED_BY_STORE||r.status===a.REJECTED_BY_DEPT_HEAD)&&r.cancellation_reason&&e.jsx("button",{onClick:()=>u(!0),className:"text-xs px-2 py-1 bg-red-100 text-red-700 rounded border border-red-200 hover:bg-red-200 transition-colors",title:"View reason",children:"View Reason"})]})}),e.jsx(S,{open:R,onClose:()=>u(!1),title:r.status===a.CANCELLED_BY_STORE?"Cancellation Reason":"Rejection Reason",message:r.cancellation_reason||"No reason provided",readonly:!0}),e.jsx(S,{open:N,onClose:f,onSubmit:h,title:m?.actionType==="reject"?"Rejection Reason":"Cancellation Reason",message:m?.actionType==="reject"?"Please provide a reason for rejecting this material request:":"Please provide a reason for cancelling this material request:"})]})},re=()=>{const{renderPagination:r}=k(),j=L(),{selectedBranchId:_,user:b}=w(),{setMaterialRequisitions:N}=B(),[l,R]=d.useState(""),[u,m]=d.useState([]),[x,A]=d.useState(!0),p=async()=>{A(!0);try{const s=_?`${c.material_requisition.items}&branch_id=${_}`:c.material_requisition.items,h=(await E.get(s)).data?.material_requisitions||[];m(h);const f=b?.role?.role_name;let t=0;f==="Department Head"?t=h.filter(i=>i.status==="Pending Approval (Dept Head)").length:f==="Store Manager"?t=h.filter(i=>i.status==="Approved - With Head").length:f==="Super Admin"&&(t=h.filter(i=>i.status==="Approved - With Store").length),N(t)}catch(s){console.error("Error fetching material requests:",s)}finally{A(!1)}};d.useEffect(()=>{p()},[_]);const g=l?u.filter(s=>s.status===l):u;return e.jsxs("div",{className:"space-y-6",children:[e.jsx(U,{module:"materialRequisition",selectedStatus:l,onChange:s=>R(s)}),e.jsxs(O,{title:`Material Requests (${g.length})`,createOnClick:y.hasPermission("material_requisition_create")?()=>j(P.MATERIAL_REQUEST.CREATE):void 0,children:[e.jsxs(q,{children:[e.jsx(M,{cols:[{title:"MR Number"},{title:"Department"},{title:"Priority"},{title:"Requested By"},{title:"Required By"},{title:"Status"},{title:"Created At"},{title:"Actions"}]}),e.jsx("tbody",{children:x&&g.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:10,className:"px-6 py-12 text-center",children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("svg",{className:"w-12 h-12 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),e.jsx("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"No material requests"}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:l?`No requests found with status "${l}"`:"Get started by creating a new material request."})]})})}):g.map((s,v)=>e.jsxs(Y,{children:[e.jsx(o,{className:"w-12 text-center font-medium",children:e.jsx("div",{className:"text-sm text-gray-900",children:v+1})}),e.jsx(o,{className:"w-40",children:e.jsx("div",{className:"flex items-center",children:e.jsx("div",{className:"text-sm font-medium text-gray-900",children:s.mr_number})})}),e.jsx(o,{className:"w-36",children:e.jsx("div",{className:"text-sm text-gray-900",children:s.department})}),e.jsx(o,{className:"w-28",children:e.jsx("span",{className:"inline-flex items-center justify-center px-2 py-1 text-xs font-medium bg-gray-100 text-gray-800 rounded-full",children:s.priority})}),e.jsx(o,{className:"w-48",children:e.jsx("div",{className:"flex items-center",children:e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:s.requested_by?.full_name||"â€”"}),e.jsx("div",{className:"text-sm text-gray-500",children:s.requested_by?.employee_code||""})]})})}),e.jsx(o,{className:"w-32",children:e.jsx("div",{className:"text-sm text-gray-900",children:C.date(s.required_by_date)})}),e.jsx(o,{className:"w-40",children:e.jsx(F,{materialRequisition:{id:s.id,status:s.status,mr_number:s.mr_number},onStatusUpdate:p})}),e.jsx(o,{className:"w-32",children:e.jsx("div",{className:"text-sm text-gray-500",children:C.date(s.created_at)})}),e.jsx(o,{className:"w-20",children:e.jsxs(V,{children:[e.jsx(J,{url:`${P.MATERIAL_REQUEST.DETAILS.replace(":id","")}${s.id}`,tooltip:"View Material Request Details"}),y.hasPermission("material_requisition_update")&&e.jsx(I,{onClick:()=>j(`${P.MATERIAL_REQUEST.CREATE}?id=${s.id}`)}),y.hasPermission("material_requisition_delete")&&e.jsx(H,{refetch:p,endpoint:c.material_requisition.delete(s.id)})]})})]},s.id))})]}),g.length>0&&r()]})]})};export{re as default};
