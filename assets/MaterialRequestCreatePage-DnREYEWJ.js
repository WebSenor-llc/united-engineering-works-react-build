import{ae as V,h as f,e as v,u as W,i as Y,r as p,a as z,j as e,B as q,y as b,A as E}from"./index-BSu8tAiZ.js";import{T as x}from"./TextInput-D6aQJwfz.js";import{S as g}from"./Select-D_LcaTTR.js";import{T as J,a as K}from"./TableDelete-DRG1O2DM.js";import{T as X,a as Z,b as m}from"./TableWrapper-B1xaUZht.js";import{T as ee}from"./TableRow-CXVjsK1A.js";import{u as se,b as re,c as te,C as n}from"./index.esm-Djn9WKK3.js";import{u as ae}from"./useItemsStore-Bi6i_eYU.js";import{u as ne}from"./useMachineStore-Db4U0UjI.js";import{F as le}from"./FormHeader-CwefNpHx.js";import{o as ie,m as oe}from"./yup-C0tTlyFl.js";import{I as ce}from"./ItemSelect-BJ1C7-_D.js";const de=V(h=>({branches:[],loading:!1,error:null,fetchBranches:async()=>{h({loading:!0,error:null});try{const _=await f.get(v.branches.all);h({branches:_.data?.branches||[],loading:!1})}catch(_){h({loading:!1,error:_?.message||"Failed to fetch branches"})}}})),me={department_from:"",department_to:"Store Department",required_date:"",priority:"Normal",purpose:"",Note:"",project_use:"",project_note:"",machine_use:"",machine_note:"",site_use:"",site_note:"",general_use:"",general_note:"",inspection:"",items:[{item_id:0,item_name:"",item_code:"",item_unit:"",req_qty:0,stock:null,remark:"",max_stock_level:0}]},ue="w-full h-10 rounded-md border border-gray-300 px-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white",we=()=>{const h=W(),[_]=Y(),i=_.get("id")?Number(_.get("id")):void 0,[T,S]=p.useState(!1),[w,k]=p.useState(!1),[c,M]=p.useState(null),{selectedBranchId:A,user:P}=z(),{control:t,handleSubmit:F,formState:{errors:o},setValue:u,reset:U}=se({defaultValues:me,resolver:ie(oe)}),{fields:R,append:$,remove:D}=re({control:t,name:"items"}),{items:B,fetchItems:N}=ae(),{machines:L,fetchMachines:C}=ne(),{branches:H,fetchBranches:I}=de(),j=P?.role,y=te({control:t});p.useEffect(()=>{N(),C(),I()},[N,C,I]),p.useEffect(()=>{j?.role_name&&(j?.role_name==="Store Manager"&&u("department_from","Store Department"),["Workshop Supervisor","Dept Head","Super Admin"].includes(j?.role_name)&&u("department_from","Production Department"))},[j?.role_name,u]),p.useEffect(()=>{i&&y&&console.log("Current form values:",y)},[y,i]);const Q=async()=>{if(i){S(!0);try{const s=await f.get(v.material_requisition.details(i)),r=s.data.data?.material_requisition||s.data.material_requisition||s.data,a=l=>l?new Date(l).toISOString().split("T")[0]:"";if(!r){console.error("No data found in API response"),b.error("No data found for this material request");return}M(r);const d={department_from:r.department||"Production Department",department_to:"Store Department",purpose:r.remarks||"",required_date:a(r.required_by_date||""),priority:r.priority||"Normal",Note:"",project_use:"",project_note:"",machine_use:"",machine_note:"",site_use:"",site_note:"",general_use:"",general_note:"",items:r.items&&r.items.length>0?r.items.map(l=>({item_id:l.item_id||0,item_name:l.item?.item_name||"",item_code:l.item?.item_code||"",item_unit:l.item?.unit?.unit_name||"",req_qty:Number(l.quantity_required||0),approved_qty:null,inspection:"",remark:l.remarks||"",max_stock_level:l.item?.max_stock_level||0,stock:l.item?.current_stock||null})):[{item_id:0,item_name:"",item_code:"",item_unit:"",req_qty:0,stock:null,approved_qty:null,inspection:"",remark:"",max_stock_level:0}]};U(d)}catch(s){console.error("Error loading request details:",s),b.error("Failed to load material request details")}finally{S(!1)}}};p.useEffect(()=>{N().then(()=>{i&&Q()})},[i]);const G=async s=>{k(!0);try{const r={department:s.department_from,required_by_date:s.required_date,priority:s.priority,remarks:s.purpose||"",project_use:s.project_use||null,project_note:s.project_note||null,machine_use:s.machine_use?Number(s.machine_use):null,machine_note:s.machine_note||null,site_use:s.site_use?Number(s.site_use):null,site_note:s.site_note||null,general_use:s.general_use||null,general_note:s.general_note||null,branch_id:A,inspection:s.inspection,items:s.items.map(l=>({item_id:Number(l.item_id),quantity_required:Number(l.req_qty),specification:l.item_unit,remarks:l.remark||""}))},a=i?v.material_requisition.update(i):v.material_requisition.create;await(i?f.put:f.post)(a,r),b.success(i?"Material Request Updated Successfully":"Material Request Created Successfully"),h(E.MATERIAL_REQUEST.LIST)}catch(r){console.error("Error:",r),b.error(r.response?.data?.message||"Failed to save material request")}finally{k(!1)}},O=()=>{h(E.MATERIAL_REQUEST.LIST)};return T?e.jsx("div",{className:"flex justify-center items-center min-h-screen",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-red-600"})}):e.jsx("div",{className:"w-full min-h-screen bg-gray-50 p-4",children:e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsx(le,{title:"Material Requisition Form",subtitle:"Provide department details and list every item you need in this request."}),e.jsxs("form",{onSubmit:F(G),className:"space-y-8 mt-8",children:[e.jsxs("section",{className:"bg-white rounded-lg shadow-sm p-4 sm:p-6 space-y-6",children:[e.jsxs("div",{className:"border-b border-gray-200 pb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Request Details"}),e.jsx("div",{className:"text-sm font-semibold text-gray-700 mt-2",children:e.jsx("p",{children:"Please fill atleast one pair among Project use/Machine use/Site use/General use/Note"})})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 sm:gap-6 sm:grid-cols-2 lg:grid-cols-3",children:[i&&c&&e.jsx("div",{className:"col-span-full",children:e.jsxs("div",{className:"bg-gray-50 border border-gray-200 rounded p-3",children:[e.jsx("h4",{className:"font-semibold text-gray-800 mb-2",children:"Material Request Details"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("p",{className:"text-sm text-gray-700",children:[e.jsx("strong",{children:"MR Number:"})," ",c.mr_number||"N/A"]}),e.jsxs("p",{className:"text-sm text-gray-700",children:[e.jsx("strong",{children:"Department:"})," ",c.department||"N/A"]}),e.jsxs("p",{className:"text-sm text-gray-700",children:[e.jsx("strong",{children:"Status:"})," ",c.status||"N/A"]})]}),(c.status?.includes("Cancelled")||c.status?.includes("Rejected"))&&e.jsx("div",{className:"mt-2 p-2 bg-red-50 border border-red-200 rounded",children:e.jsxs("p",{className:"text-sm text-red-800",children:[e.jsxs("strong",{children:[c.status?.includes("Cancelled")?"Cancellation":"Rejection"," ","Reason:"]})," ",c.cancellation_reason||c.rejection_reason||c.dept_head_comments||c.super_admin_comments||"No reason provided"]})})]})}),e.jsx(n,{name:"department_from",control:t,render:({field:s})=>e.jsxs(g,{...s,label:"Department From",required:!0,error:o.department_from?.message,children:[e.jsx("option",{value:"Production Department",children:"Production Department"}),e.jsx("option",{value:"Store Department",children:"Store Department"})]})}),e.jsx(n,{name:"department_to",control:t,render:({field:s})=>e.jsx(x,{required:!0,...s,label:"Department To"})}),e.jsx(n,{name:"required_date",control:t,render:({field:s})=>e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs("label",{className:"text-sm font-semibold text-gray-700",children:["Required Date ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{...s,type:"date",className:ue}),o.required_date&&e.jsx("span",{className:"text-xs text-red-600 mt-1",children:o.required_date?.message})]})}),e.jsx(n,{name:"priority",control:t,render:({field:s})=>e.jsxs(g,{...s,label:"Priority",required:!0,error:o.priority?.message,children:[e.jsx("option",{value:"Urgent",children:"High"}),e.jsx("option",{value:"Emergency",children:"Medium"}),e.jsx("option",{value:"Normal",children:"Low"})]})}),e.jsx(n,{name:"inspection",control:t,render:({field:s})=>e.jsxs(g,{...s,required:!0,label:"Inspection",value:s.value===void 0?"":String(s.value),onChange:r=>s.onChange(r.target.value==="true"),children:[e.jsx("option",{value:"",children:"Select"}),e.jsx("option",{value:"true",children:"Yes"}),e.jsx("option",{value:"false",children:"No"})]})}),e.jsx("div",{className:"col-span-full",children:e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsx(n,{name:"project_use",control:t,render:({field:s})=>e.jsx(x,{...s,value:s.value??"",label:"Project Use",error:o?.project_use?.message,placeholder:"Enter project details"})}),e.jsx(n,{name:"project_note",control:t,render:({field:s})=>e.jsx(x,{...s,value:s.value??"",label:"Project Note",error:o?.project_note?.message,placeholder:"Enter project note"})})]})}),e.jsx("div",{className:"col-span-full",children:e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsx(n,{name:"machine_use",control:t,render:({field:s})=>e.jsxs(g,{...s,value:s.value??"",label:"Machine Use",error:o?.machine_use?.message,children:[e.jsx("option",{value:"",children:"Select Machine"}),L.map(r=>e.jsx("option",{value:r.id,children:r.name},r.id))]})}),e.jsx(n,{name:"machine_note",control:t,render:({field:s})=>e.jsx(x,{...s,value:s.value??"",label:"Machine Note",error:o?.machine_note?.message,placeholder:"Enter machine note"})})]})}),e.jsx("div",{className:"col-span-full",children:e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsx(n,{name:"site_use",control:t,render:({field:s})=>e.jsxs(g,{...s,value:s.value??"",label:"Site Use",error:o?.site_use?.message,children:[e.jsx("option",{value:"",children:"Select Branch"}),H.map(r=>e.jsx("option",{value:r.id,children:r.branch_name},r.id))]})}),e.jsx(n,{name:"site_note",control:t,render:({field:s})=>e.jsx(x,{...s,value:s.value??"",label:"Site Note",error:o?.site_note?.message,placeholder:"Enter site note"})})]})}),e.jsx("div",{className:"col-span-full",children:e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsx(n,{name:"general_use",control:t,render:({field:s})=>e.jsx(x,{...s,value:s.value??"",label:"General Use",error:o?.general_use?.message,placeholder:"Enter general use details"})}),e.jsx(n,{name:"general_note",control:t,render:({field:s})=>e.jsx(x,{...s,value:s.value??"",label:"General Note",error:o?.general_note?.message,placeholder:"Enter general note"})})]})})]})]}),e.jsxs("section",{className:"bg-white rounded-lg shadow-sm p-4 sm:p-6 space-y-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsx("div",{children:e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Items Requested"})}),e.jsx(q,{className:"bg-red-600 text-white px-4 py-2 w-full sm:w-auto",onClick:()=>$({item_id:0,item_name:"",item_code:"",item_unit:"",req_qty:0,stock:null,remark:"",max_stock_level:0}),children:"+Add Item"})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(X,{children:[e.jsx(Z,{cols:[{title:"Item Name"},{title:"Item Code"},{title:"Item Unit"},{title:"Req Qty"},{title:"Stock In Store"},{title:"Remark"},{title:"Actions"}]}),e.jsx("tbody",{children:R.map((s,r)=>e.jsxs(ee,{children:[e.jsx(m,{className:"w-12 text-center font-medium",children:r+1}),e.jsx(m,{className:"w-64 relative",children:e.jsx(n,{name:`items.${r}.item_id`,control:t,render:()=>e.jsx(ce,{control:t,name:`items.${r}.item_id`,disabled:!1,onChange:a=>{const d=B.find(l=>l.id===a);d&&(u(`items.${r}.item_id`,d.id),u(`items.${r}.item_code`,d.item_code),u(`items.${r}.item_name`,d.item_name),u(`items.${r}.item_unit`,d.unit?.unit_name||""))}})})}),e.jsx(m,{className:"w-32",children:e.jsx(n,{name:`items.${r}.item_code`,control:t,render:({field:a})=>e.jsx("input",{...a,className:"w-full h-[45px] border border-gray-300 rounded-lg px-3 text-sm bg-gray-50 font-mono",placeholder:"Code",readOnly:!0})})}),e.jsx(m,{className:"w-24",children:e.jsx(n,{name:`items.${r}.item_unit`,control:t,render:({field:a})=>e.jsx("input",{...a,className:"w-full h-[45px] border border-gray-300 rounded-lg px-3 text-sm bg-gray-50 text-center",placeholder:"Unit",readOnly:!0})})}),e.jsx(m,{className:"w-24",children:e.jsx(n,{name:`items.${r}.req_qty`,control:t,render:({field:a})=>e.jsx("input",{...a,className:"w-full h-[45px] border border-gray-300 rounded-lg px-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-center",placeholder:"Qty",type:"number",min:"1",onFocus:()=>{a.value===0&&a.onChange("")}})})}),e.jsx(m,{className:"w-28",children:e.jsx(n,{name:`items.${r}.stock`,control:t,render:({field:a})=>e.jsx("input",{...a,className:"w-full h-[45px] border border-gray-300 rounded-lg px-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-center",value:a.value??"",placeholder:"Stock",type:"number"})})}),e.jsx(m,{className:"w-40",children:e.jsx(n,{name:`items.${r}.remark`,control:t,render:({field:a})=>e.jsx("input",{...a,className:"w-full h-[45px] border border-gray-300 rounded-lg px-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",value:a.value??"",placeholder:"Remark"})})}),e.jsx(m,{className:"w-16",children:e.jsx(J,{children:e.jsx(K,{onClick:()=>{R.length>1&&D(r)}})})})]},s.id))})]})})]}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx(q,{variant:"outline",type:"button",onClick:O,children:"Cancel"}),e.jsx(q,{className:"bg-red-600 text-white",type:"submit",loading:w,disabled:w,children:i?"Update Material Request":"Submit Material Request"})]})]})]})})};export{we as default};
