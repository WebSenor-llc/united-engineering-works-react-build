import{r as c,a as W,j as e,B as S,h as C,e as P,y as U,i as Y}from"./index-B2Kq7pF4.js";import{S as Z}from"./Select-B7UTEZjZ.js";import{L as ee}from"./ListWrapper-BCNScaty.js";import{T as te,a as re,b as u}from"./TableWrapper-jqHXbh_L.js";import{u as H,C as g,c as ae}from"./index.esm-B19_P2AP.js";import{o as R,r as se,t as f,v as ne}from"./yup-CzgU9FQc.js";import{L as de}from"./Loading-OOr2nQlv.js";import{F as ie}from"./FormHeader-CQNygXHB.js";import{B as oe}from"./BaseModal-Da4Si1VO.js";import{T as N}from"./TextInput-D6Nk2HMm.js";import{C as ce}from"./CommonFilter-DYIt7Pg1.js";import"./BackButton-D6lHrR0A.js";const le=se().shape({expected_delivery_date:f().required("Expected delivery date is required"),delivery_address:f().required("Delivery address is required"),delivery_contact_person:f().required("Contact person is required"),delivery_contact_phone:f().required("Contact phone is required"),special_instructions:f().optional()}),me=({open:O,onClose:n,vendorId:p,vendorName:b,csId:I,branchId:l,items:d,onSuccess:q})=>{const[o,j]=c.useState(!1),{control:m,handleSubmit:x,formState:{errors:h},reset:D}=H({resolver:R(le),defaultValues:{expected_delivery_date:"",delivery_address:"",delivery_contact_person:"",delivery_contact_phone:"",special_instructions:""}}),{user:F}=W(),V=F?.id,T=async i=>{j(!0);try{const v={...i,vendor_id:p,created_by:V,comparative_statement_id:I,branch_id:l,items:d.map(_=>({item_id:_.item_id,quantity_ordered:_.quantity_ordered,unit_price:_.rate,discount_percentage:_.discount_percentage,tax_percentage:_.tax_percentage,total_price:_.total_price,branch_id:l}))};await C.post(P.purchase_order.create,v),U.success(`Purchase Order generated for ${b}`),D(),q(),n()}catch(v){console.error(v),U.error("Failed to generate Purchase Order")}finally{j(!1)}};return e.jsx(oe,{open:O,onClose:n,title:`Generate PO for ${b}`,maxWidth:"max-w-2xl",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"max-h-[60vh] overflow-y-auto pr-2 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 ml-1",children:[e.jsx(g,{name:"expected_delivery_date",control:m,render:({field:i})=>e.jsx(N,{...i,type:"date",label:"Expected Delivery Date",error:h.expected_delivery_date?.message})}),e.jsx(g,{name:"delivery_contact_person",control:m,render:({field:i})=>e.jsx(N,{...i,label:"Delivery Contact Person",error:h.delivery_contact_person?.message})}),e.jsx(g,{name:"delivery_contact_phone",control:m,render:({field:i})=>e.jsx(N,{...i,label:"Delivery Contact Phone",error:h.delivery_contact_phone?.message})}),e.jsx(g,{name:"delivery_address",control:m,render:({field:i})=>e.jsx(N,{...i,label:"Delivery Address",error:h.delivery_address?.message})})]}),e.jsx("div",{className:"ml-1",children:e.jsx(g,{name:"special_instructions",control:m,render:({field:i})=>e.jsx(N,{...i,label:"Special Instructions",error:h.special_instructions?.message})})})]}),e.jsxs("div",{className:"flex justify-end pt-4 space-x-3",children:[e.jsx(S,{variant:"outline",onClick:n,disabled:o,children:"Cancel"}),e.jsx(S,{onClick:x(T),loading:o,children:"Generate Purchase Order"})]})]})})},_e={vendor_id:0,branch_id:0,comparative_statement_id:0,expected_delivery_date:"",delivery_address:"",delivery_contact_person:"",delivery_contact_phone:"",special_instructions:"",items:[{item_id:0,item_name:"",item_code:"",item_unit:"",quantity_ordered:0,unit:"",unit_price:0,discount_percentage:0,tax_percentage:0,total_price:0,rate:"0"}]},Ce=()=>{const[O]=Y(),n=O.get("editId"),[p,b]=c.useState([]),[I,l]=c.useState(!1),[d,q]=c.useState(null),{selectedBranchId:o}=W(),[j,m]=c.useState(!1),[x,h]=c.useState(null),[D,F]=c.useState({}),V=[{name:"statement_number",label:"Statement Number",placeholder:"Enter statement number"},{name:"date_from",label:"Date From",type:"date",placeholder:"Select start date"},{name:"date_to",label:"Date To",type:"date",placeholder:"Select end date"}],T=async a=>{if(!o)return;F(a);const r={branch_id:o};a.statement_number&&(r.statement_number=a.statement_number),a.date_from&&a.date_to?a.date_from===a.date_to?r.date=a.date_from:(r.date_from=a.date_from,r.date_to=a.date_to):(a.date_from&&(r.date_from=a.date_from),a.date_to&&(r.date_to=a.date_to)),l(!0);try{const t=await C.get(P.comparative_statement.items,{params:r});b(t.data?.statements||[])}catch(t){console.error("Error filtering comparative statements:",t)}finally{l(!1)}},{control:i,setValue:v,reset:_}=H({defaultValues:_e,resolver:R(ne)}),y=ae({control:i,name:"comparative_statement_id"}),G=async()=>{if(o){l(!0);try{const a=await C.get(P.comparative_statement.items,{params:{branch_id:o}});b(a.data?.statements||[])}catch(a){console.error(a)}finally{l(!1)}}};c.useEffect(()=>{G()},[o]),c.useEffect(()=>{if(!n||p.length===0)return;(async()=>{l(!0);try{const r=await C.get(P.purchase_order.details(Number(n))),t=r.data?.purchaseOrder||r.data?.purchase_order||r.data;t&&(q(t),v("comparative_statement_id",t.comparative_statement_id||0),_({branch_id:t.branch_id||o,vendor_id:t.vendor_id||0,comparative_statement_id:t.comparative_statement_id||0,expected_delivery_date:t.expected_delivery_date?t.expected_delivery_date.split("T")[0]:"",delivery_address:t.delivery_address||"",delivery_contact_person:t.delivery_contact_person||"",delivery_contact_phone:t.delivery_contact_phone||"",special_instructions:t.special_instructions||"",items:(t.items||[]).map(s=>({item_id:s.item_id||0,item_name:s.item?.item_name||"",item_code:s.item?.item_code||"",item_unit:s.item?.unit?.unit_name||"",quantity_ordered:Number(s.quantity_ordered)||0,unit:s.item?.unit?.unit_name||"",unit_price:Number(s.unit_price)||0,discount_percentage:Number(s.discount_percentage)||0,tax_percentage:Number(s.tax_percentage)||0,total_price:Number(s.total_price)||0,rate:String(s.unit_price||0)}))}))}catch(r){console.error("Error loading PO details:",r)}finally{l(!1)}})()},[n,p.length,v,_,o]);const A=c.useMemo(()=>{if(!y)return{};const a=p.find(t=>t.id===y);if(!a||!a.items)return{};console.log("Selected CS:",a);const r={};if(a.items.forEach(t=>{const s=t.selected_vendor?.id||t.selected_vendor_id;if(!s)return;if(!r[s]){const E=a.vendors_with_po_status?.find(X=>X.vendor_id===s);r[s]={vendor:t.selected_vendor,items:[],all_items_have_po:!!E?.allItemsHavePo,po_items:n&&d?(d.items||[]).filter(()=>d.vendor_id===s):[]}}const w=Number(t.quantity)||0,k=Number(t.selected_vendor_rate_details?.rate)||0,B=Number(t.selected_vendor_rate_details?.discount_percentage)||0,L=Number(t.selected_vendor_rate_details?.gst_percentage)||0,$=w*k,Q=$*B/100,M=$-Q,z=M*L/100,J=Number((M+z).toFixed(2)),K=n&&d&&d.items?.some(E=>E.item_id===t.item_id);r[s].items.push({item_id:t.item_id,item_name:t.item?.item_name||"Unknown Item",quantity_ordered:w,rate:k,discount_percentage:B,tax_percentage:L,total_price:J,has_po:K})}),n&&d){const t=d.vendor_id,s={};return t&&r[t]&&(s[t]=r[t]),s}return r},[p,y,n,d]);return I?e.jsx("div",{className:"flex justify-center py-20",children:e.jsx(de,{})}):e.jsxs("div",{className:"w-full h-full overflow-auto space-y-8 p-4 pb-20",children:[e.jsx("div",{className:"space-y-1 ml-2",children:e.jsx(ie,{title:n?"Edit Purchase Order":"Create Purchase Order",subtitle:n?"Update the Purchase Order details":"Fill out the form to submit a new Purchase Order."})}),e.jsx(ce,{fields:V,onFilter:T,defaultValues:D}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-5 ml-4",children:[e.jsx(g,{name:"comparative_statement_id",control:i,render:({field:a})=>e.jsxs(Z,{...a,label:"Comparative Statement",value:a.value||0,onChange:r=>a.onChange(Number(r.target.value)),disabled:!!n,children:[e.jsx("option",{value:0,children:"Select Comparative Statement"}),p.map(r=>e.jsx("option",{value:r.id,children:r.statement_number},r.id))]})}),n&&d&&e.jsxs("div",{className:"bg-gray-50 border border-gray-200 rounded p-3",children:[e.jsx("h4",{className:"font-semibold text-gray-800 mb-2",children:"Purchase Order Details"}),e.jsxs("p",{className:"text-sm text-gray-700",children:[e.jsx("strong",{children:"PO Number:"})," ",d.po_number||"N/A"]}),e.jsxs("p",{className:"text-sm text-gray-700",children:[e.jsx("strong",{children:"Vendor:"})," ",d.vendor?.party_name||"N/A"]}),e.jsxs("p",{className:"text-sm text-gray-700",children:[e.jsx("strong",{children:"Status:"})," ",d.status||"N/A"]}),(d.status?.toLowerCase().includes("cancel")||d.status==="Cancelled")&&d.cancellation_reason&&e.jsx("div",{className:"mt-2 p-2 bg-red-50 border border-red-200 rounded",children:e.jsxs("p",{className:"text-sm text-red-800",children:[e.jsx("strong",{children:"Cancellation Reason:"})," ",d.cancellation_reason||"No reason provided"]})})]})]}),y&&Object.keys(A).length>0?e.jsx("div",{className:"space-y-6",children:Object.entries(A).map(([a,r])=>e.jsxs(ee,{title:`Vendor: ${r.vendor?.party_name||"Unknown"}`,children:[e.jsxs("div",{className:"mb-4 flex justify-between items-center",children:[e.jsxs("div",{className:"text-sm text-gray-600",children:[e.jsxs("p",{children:["Total Items: ",r.items.length]}),e.jsxs("p",{className:"font-semibold text-gray-900",children:["Grand Total: ₹",r.items.reduce((t,s)=>t+s.total_price,0).toLocaleString("en-IN",{minimumFractionDigits:2})]})]}),n?e.jsx(S,{variant:"outline",disabled:!0,className:"bg-green-100 !text-green-600 !border-green-300",children:"Current PO Vendor"}):r.all_items_have_po?e.jsx(S,{variant:"outline",disabled:!0,className:"bg-gray-100 !text-gray-400 !border-gray-300 pointer-events-none",children:"Generated"}):e.jsx(S,{onClick:()=>{h({...r,vendorId:Number(a)}),m(!0)},children:"Generate PO"})]}),e.jsxs(te,{children:[e.jsx(re,{cols:[{title:"Item"},{title:"Qty"},{title:"Rate"},{title:"Disc%"},{title:"GST%"},{title:"Total"},...n?[{title:"Status"}]:[]]}),e.jsx("tbody",{children:r.items.map((t,s)=>e.jsxs("tr",{className:`border-t ${n&&t.has_po?"bg-green-50":""}`,children:[e.jsx(u,{children:s+1}),e.jsx(u,{children:t.item_name}),e.jsx(u,{children:t.quantity_ordered}),e.jsx(u,{children:t.rate}),e.jsxs(u,{children:[t.discount_percentage,"%"]}),e.jsxs(u,{children:[t.tax_percentage,"%"]}),e.jsxs(u,{children:["₹",t.total_price.toFixed(2)]}),n&&e.jsx(u,{children:t.has_po?e.jsx("span",{className:"text-xs bg-green-100 text-green-800 px-2 py-1 rounded",children:"In PO"}):e.jsx("span",{className:"text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded",children:"Available"})})]},s))})]})]},a))}):e.jsx("div",{className:"p-8 text-center text-gray-500 bg-gray-50 rounded-lg",children:y?"No items found for this Comparative Statement.":"Please select a Comparative Statement to view items grouped by vendor."}),j&&x&&e.jsx(me,{open:j,onClose:()=>m(!1),vendorId:x.vendorId,vendorName:x.vendor?.party_name||"Unknown",csId:y,branchId:o,items:x.items,onSuccess:()=>{m(!1),G()}})]})};export{Ce as default};
