import{u as V,i as z,a as $,r as _,j as e,B as j,h as f,e as g,y as L,A as G}from"./index-DTUaUizH.js";import{T as P}from"./TextInput-DjvRLXTc.js";import{L as J}from"./ListWrapper-Dr0Tmx23.js";import{T as K}from"./TableActions-uzQqphGO.js";import{T as X,a as Y,b as c}from"./TableWrapper-C013oIpb.js";import{T as Z}from"./TableDelete-CG-AnBcY.js";import{u as ee,b as te,c as ie,C as d}from"./index.esm-CyPm2lQV.js";import{u as se}from"./useItemsStore-B3yPCmOV.js";import{u as ae}from"./useMaterialRequestStore-BWqtroNa.js";import{L as re}from"./Loading-C80BVErt.js";import{F as oe}from"./FormHeader-CKox6KWu.js";import{B as de}from"./BranchUserSelect-B-3BSgMq.js";import"./BackButton-DXTvHfQF.js";const ne={reason:"",deposited_by:"",recieved_by:"Store",branch_id:"",material_requisition_id:"",item_id:"",quantity_to_deposit:"",quantity_deposited:"",items:[{item_id:"",item_name:"",item_code:"",item_unit:"",qty_to_deposit:"",qty_deposited:""}]},ve=()=>{const v=V(),[R]=z(),r=R.get("editId"),{selectedBranchId:b}=$(),{control:a,handleSubmit:A,setValue:m,reset:E,formState:{errors:x}}=ee({defaultValues:ne}),{fields:F,append:B,remove:M}=te({control:a,name:"items"}),U=ie({control:a,name:"items"}),{user:q}=$(),{items:y,fetchItems:N}=se(),{materials:u,fetchMaterials:S}=ae(),[k,C]=_.useState(!1),[I,w]=_.useState(!1),[D,H]=_.useState(!1);_.useEffect(()=>{(async()=>{await Promise.all([N(),S()]),H(!0)})()},[N,S]);const O=async()=>{if(r){C(!0);try{const s=await f.get(g.deposit_slip.details(Number(r))),i=s.data.slip||s.data;E({branch_id:i.branch_id?String(i.branch_id):b?String(b):"",material_requisition_id:i.material_requisition_id?String(i.material_requisition_id):"",recieved_by:i.recieved_by,deposited_by:i.deposited_by,reason:i.reason||"",items:(i.items||[]).map(t=>({item_id:t.item_id,item_code:t.item?.item_code||"",item_name:t.item?.item_name||"",item_unit:t.unit?.unit_name||"",qty_to_deposit:t.quantity_to_deposit,qty_deposited:t.quantity_deposited}))})}catch(s){console.error("Failed to load details:",s),L.error("Failed to load deposit slip details")}finally{C(!1)}}};_.useEffect(()=>{r&&D&&O()},[r,D]);const W=async s=>{w(!0);const i={branch_id:b,material_requisition_id:s.material_requisition_id?Number(s.material_requisition_id):null,recieved_by:s.recieved_by,deposited_by:s.deposited_by,reason:s.reason,items:s.items.map(t=>({item_id:Number(t.item_id),quantity_to_deposit:Number(t.qty_to_deposit),quantity_deposited:Number(t.qty_deposited)}))};try{const t=r?g.deposit_slip.update(Number(r)):g.deposit_slip.create;await(r?f.put:f.post)(t,i),v(G.DEPOSITE_SLIP.LIST)}catch(t){console.error(t),L.error(t.response?.data?.message||"Failed to save deposit slip")}finally{w(!1)}};return k?e.jsx("div",{className:"flex justify-center py-20",children:e.jsx(re,{})}):e.jsxs("div",{className:"w-full h-full overflow-auto space-y-8 p-4 pb-20",children:[e.jsx("div",{className:"space-y-1 ml-2",children:e.jsx(oe,{title:r?"Edit Deposite Slip":"Create Deposite Slip",subtitle:r?"Update the Deposite Slip details":"Fill out the form to submit a new Deposite Slip"})}),e.jsxs("div",{className:"grid grid-cols-2 gap-5 ml-2 mr-5",children:[e.jsx(d,{name:"material_requisition_id",control:a,render:({field:s})=>e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-semibold text-gray-700 mb-1",children:"Material Request"}),e.jsxs("select",{...s,className:"w-full h-[45px] rounded-lg border border-gray-300 px-4 mt-1 text-sm",onChange:i=>{const t=i.target.value;if(s.onChange(t),t){const n=u&&u.find(p=>p.id===Number(t));if(n&&n.items&&n.items.length>0){const p=n.items.map(o=>({item_id:o.item?.id||o.item_id||"",item_code:o.item?.item_code||"",item_name:o.item?.item_name||"",item_unit:o.item?.unit?.unit_name||"",qty_to_deposit:o.quantity_required||o.quantity||"",qty_deposited:""}));m("items",p)}}},children:[e.jsx("option",{value:"",children:"Select Material Request"}),u&&u.length>0&&u.map(i=>e.jsxs("option",{value:i.id,children:[i.mr_number," - ",i.department||"Unknown Dept"]},i.id))]})]})}),e.jsx(d,{name:"reason",control:a,render:({field:s})=>e.jsx(P,{...s,label:"Reason for deposing",error:x.reason?.message,placeholder:"Enter reason for deposing"})}),e.jsx(de,{label:"Deposited By",name:"deposited_by",control:a,branchId:q?.branch?.id||q?.branch_id,error:x.deposited_by?.message}),e.jsx(d,{name:"recieved_by",control:a,render:({field:s})=>e.jsx(P,{...s,label:"Recieved By",error:x.recieved_by?.message})})]}),e.jsxs(J,{title:"Items Requested",children:[e.jsx("div",{className:"flex justify-end mb-2",children:e.jsx(j,{className:"bg-red-600 text-white px-3 py-1",onClick:()=>B({item_id:"",item_name:"",item_code:"",item_unit:"",qty_to_deposit:"",qty_deposited:""}),children:"+ Add Item"})}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(X,{children:[e.jsx(Y,{cols:[{title:"Item Name"},{title:"Item Code"},{title:"Item Unit"},{title:"Qty to Deposite"},{title:"Qty Deposited"},{title:"Action"}]}),e.jsx("tbody",{children:F.map((s,i)=>e.jsxs("tr",{className:"align-middle",children:[e.jsx(c,{children:i+1}),e.jsxs(c,{children:[e.jsx(d,{name:`items.${i}.item_id`,control:a,render:({field:t})=>{const n=U?.[i],p=n?.item_name,o=n?.item_code;return e.jsxs("select",{...t,value:t.value||"",className:"w-full h-[45px] rounded-lg border border-gray-300 px-5 mt-1 text-sm",onChange:l=>{const T=l.target.value;t.onChange(T);const h=y.find(Q=>Q.id===Number(T));h?(m(`items.${i}.item_name`,h.item_name),m(`items.${i}.item_code`,h.item_code),m(`items.${i}.item_unit`,h.unit?.unit_name||"")):(m(`items.${i}.item_name`,""),m(`items.${i}.item_code`,""),m(`items.${i}.item_unit`,""))},children:[e.jsx("option",{value:"",children:"Select Item"}),t.value&&!y.find(l=>l.id===Number(t.value))&&p&&e.jsxs("option",{value:t.value,children:[p," (",o,")"]}),y.map(l=>e.jsxs("option",{value:l.id,children:[l.item_name," (",l.item_code,")"]},l.id))]})}}),e.jsx(d,{name:`items.${i}.item_name`,control:a,render:({field:t})=>e.jsx("input",{...t,type:"hidden"})})]}),e.jsx(c,{children:e.jsx(d,{name:`items.${i}.item_code`,control:a,render:({field:t})=>e.jsx("input",{...t,className:"w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm bg-gray-50",placeholder:"Code",readOnly:!0})})}),e.jsx(c,{children:e.jsx(d,{name:`items.${i}.item_unit`,control:a,render:({field:t})=>e.jsx("input",{...t,className:"w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm bg-gray-50",placeholder:"Unit",readOnly:!0})})}),e.jsx(c,{children:e.jsx(d,{name:`items.${i}.qty_to_deposit`,control:a,render:({field:t})=>e.jsx("input",{...t,type:"number",className:"w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm",placeholder:"0"})})}),e.jsx(c,{children:e.jsx(d,{name:`items.${i}.qty_deposited`,control:a,render:({field:t})=>e.jsx("input",{...t,type:"number",className:"w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm",placeholder:"0"})})}),e.jsx(c,{children:e.jsx(K,{children:e.jsx(Z,{onClick:()=>M(i)})})})]},s.id))})]})})]}),e.jsxs("div",{className:"flex justify-end gap-3 mr-5",children:[e.jsx(j,{variant:"outline",onClick:()=>v(-1),children:"Cancel"}),e.jsx(j,{className:"bg-red-600 text-white",onClick:A(W),loading:I,disabled:I,children:r?"Update Deposit Slip":"Submit Deposit Slip"})]})]})};export{ve as default};
