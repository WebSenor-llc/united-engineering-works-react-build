import{r as p,j as e,B as z,h as J,e as K,y as O,u as $e,b as qe,a as Fe,A as le}from"./index-QEJ2HCdw.js";import{T as h}from"./TextInput-BdJuYdFC.js";import{S as de}from"./Select-D60uqtBY.js";import{B as me}from"./BaseModal-DCaDQrbd.js";import{u as ue,C as $,b as Ee}from"./index.esm-Bd1pinfN.js";import{o as Re,e as Pe}from"./yup-Dt7c8rJX.js";import{u as Te}from"./useItemsStore-BCPqe280.js";import{u as Ae}from"./useMaterialRequestStore-BDQCiv3U.js";import{F as Me}from"./FormHeader-BVmIKXpM.js";import{L as ke}from"./Loading-BUzEJx3P.js";import{u as xe}from"./usePartyStore-Db_3YUow.js";import{C as Oe}from"./CommonFilter-5OTEYuSH.js";import{S as Le}from"./SearchableSelect-5Z_5MaTW.js";import"./BackButton-8FL22_V2.js";const Be=({open:V,onClose:L,onSuccess:j})=>{const[B,E]=p.useState([]),[q,I]=p.useState([]),[R,U]=p.useState([]),[Q,W]=p.useState(!1),{control:N,handleSubmit:T,reset:C,watch:G,formState:{errors:b}}=ue({defaultValues:{party_type:"vendor",party_name:"",company_name:"",address:"",city:"",state:"",pincode:"",gstin:"",contact_person:"",phone:"",credit_limit:"",email:"",country:"India",pan:"",bank_name:"",bank_account_number:"",bank_ifsc_code:"",is_active:!0},resolver:Re(Pe)}),g=G("country"),l=G("state");p.useEffect(()=>{V&&(async()=>{try{const d=await J.get(K.party_master.countries);E(d.data.data||d.data||[])}catch(d){console.error("Failed to fetch countries",d)}})()},[V]),p.useEffect(()=>{if(!g||!V){I([]);return}(async()=>{const d=B.find(v=>v.name===g);if(d)try{const v=await J.get(`${K.party_master.states}?country=${d.name}`);I(v.data.data||v.data||[])}catch(v){console.error("Failed to fetch states",v)}})()},[g,B,V]),p.useEffect(()=>{if(!l||!V){U([]);return}(async()=>{const d=q.find(v=>v.name===l);if(d)try{const v=await J.get(`${K.party_master.cities}?state=${d.name}`);U(v.data.data||v.data||[])}catch(v){console.error("Failed to fetch cities",v)}})()},[l,q,V]);const D=async m=>{W(!0);try{await J.post(K.party_master.create,m),O.success("Party Created Successfully"),j(),L(),C()}catch(d){console.error(d),O.error(d.response?.data?.message||"Failed to save party")}finally{W(!1)}};return e.jsx(me,{open:V,onClose:()=>{L(),C()},title:"Create New Party",maxWidth:"max-w-4xl",children:e.jsxs("div",{className:"space-y-6 max-h-[80vh] overflow-y-auto px-1 py-2",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[e.jsx($,{name:"party_type",control:N,render:({field:m})=>e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("label",{className:"text-sm font-semibold text-gray-700 mb-1",children:["Party Type ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{...m,className:"w-full rounded-lg border border-gray-300 mt-1 px-3 py-2 text-gray-700 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white",children:[e.jsx("option",{value:"",children:"Select Party Type"}),e.jsx("option",{value:"vendor",children:"Vendor"}),e.jsx("option",{value:"customer",children:"Customer"})]}),b?.party_type?.message&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:b.party_type.message})]})}),e.jsx($,{name:"party_name",control:N,render:({field:m})=>e.jsx(h,{required:!0,...m,label:"Party Name",error:b?.party_name?.message,className:"text-sm py-2"})}),e.jsx($,{name:"contact_person",control:N,render:({field:m})=>e.jsx(h,{required:!0,...m,label:"Contact Person",error:b?.contact_person?.message,className:"text-sm py-2"})}),e.jsx($,{name:"company_name",control:N,render:({field:m})=>e.jsx(h,{required:!0,...m,label:"Company Name",error:b?.company_name?.message,className:"text-sm py-2"})}),e.jsx($,{name:"address",control:N,render:({field:m})=>e.jsx(h,{required:!0,...m,label:"Address",error:b?.address?.message,className:"text-sm py-2"})}),e.jsx($,{name:"country",control:N,render:({field:m})=>e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("label",{className:"text-sm font-semibold text-gray-700 mb-1",children:["Country ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{...m,className:"w-full rounded-lg border border-gray-300 mt-1 px-3 py-2 text-gray-700 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white",children:[e.jsx("option",{value:"",children:"Select Country"}),B.map(d=>e.jsx("option",{value:d.name,children:d.name},d.id||d.name))]}),b?.country?.message&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:b.country.message})]})}),e.jsx($,{name:"state",control:N,render:({field:m})=>e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("label",{className:"text-sm font-semibold text-gray-700 mb-1",children:["State ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{...m,disabled:!q.length,className:"w-full rounded-lg border border-gray-300 mt-1 px-3 py-2 text-gray-700 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white disabled:bg-gray-100",children:[e.jsx("option",{value:"",children:"Select State"}),q.map(d=>e.jsx("option",{value:d.name,children:d.name},d.id||d.name))]}),b?.state?.message&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:b.state.message})]})}),e.jsx($,{name:"city",control:N,render:({field:m})=>e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("label",{className:"text-sm font-semibold text-gray-700 mb-1",children:["City ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{...m,disabled:!R.length,className:"w-full rounded-lg border border-gray-300 mt-1 px-3 py-2 text-gray-700 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white disabled:bg-gray-100",children:[e.jsx("option",{value:"",children:"Select City"}),R.map(d=>e.jsx("option",{value:d.name,children:d.name},d.id||d.name))]}),b?.city?.message&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:b.city.message})]})}),e.jsx($,{name:"pincode",control:N,render:({field:m})=>e.jsx(h,{required:!0,...m,label:"Pincode",error:b?.pincode?.message,className:"text-sm py-2"})}),e.jsx($,{name:"phone",control:N,render:({field:m})=>e.jsx(h,{required:!0,...m,label:"Mobile No",type:"tel",error:b?.phone?.message,className:"text-sm py-2"})}),e.jsx($,{name:"email",control:N,render:({field:m})=>e.jsx(h,{required:!0,...m,label:"Email",type:"email",error:b?.email?.message,className:"text-sm py-2"})}),e.jsx($,{control:N,name:"is_active",render:({field:m})=>e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("label",{className:"block text-sm font-semibold text-gray-700 mb-1",children:["Is Active ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{...m,value:m.value?"true":"false",onChange:d=>m.onChange(d.target.value==="true"),className:"w-full border border-gray-300 rounded-lg px-3 py-2 bg-white text-gray-800 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"true",children:"Active"}),e.jsx("option",{value:"false",children:"Inactive"})]})]})})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t border-slate-200",children:[e.jsx(z,{onClick:()=>{L(),C()},variant:"outline",className:"text-sm px-4",children:"Cancel"}),e.jsx(z,{onClick:T(D),loading:Q,disabled:Q,className:"bg-red-600 text-white text-sm px-4",children:"Create Party"})]})]})})},pe=p.forwardRef(({value:V,onChange:L,placeholder:j="Select Vendor to Add",disabled:B=!1,error:E,className:q,excludeVendorIds:I=[],onMount:R},U)=>{const{parties:Q,fetchParties:W,loading:N}=xe(),T=p.useRef(!1);p.useEffect(()=>{!T.current&&R&&(T.current=!0,R())},[R]);const C=Q.filter(g=>(g.party_type?.toLowerCase()==="vendor"||!g.party_type)&&g.is_active&&!I.includes(g.id));console.log("Available Vendors:",C);const G=C.map(g=>({value:g.id,label:g.party_name})),b=g=>{g.length>=3?W({search:g,party_type:"Vendor"}):g.length===0&&W({party_type:"Vendor"})};return e.jsx(Le,{ref:U,options:G,value:V?Number(V):void 0,onChange:g=>L(g.toString()),placeholder:N?"Loading vendors...":j,disabled:B||N,error:E,className:q,onSearch:b})});pe.displayName="VendorSearchSelect";const Ie={quantity:"",rate:"",discount_percent:"",gst_percent:"",net_amount:"",total_amount:"",loading_charges:"",freight_charges:"",cutting_charges:""},st=()=>{const V=$e(),[L]=qe(),j=L.get("editId"),{fetchItems:B}=Te(),{materials:E,fetchMaterials:q}=Ae(),[I,R]=p.useState(!1),[U,Q]=p.useState(!1),{selectedBranchId:W}=Fe(),{parties:N,fetchParties:T}=xe(),C=p.useRef(!1),G=p.useRef(!1),[b,g]=p.useState(!1),[l,D]=p.useState(null),[m,d]=p.useState(""),[v,A]=p.useState(""),[he,ie]=p.useState(!1),oe=p.useRef(null),{control:ae,handleSubmit:ge,getValues:M,watch:X,setValue:P,register:H,trigger:re}=ue({defaultValues:{branch_id:"",material_requisition_id:"",items:[]}}),{fields:ee}=Ee({control:ae,name:"items",keyName:"fieldId"}),_e=[{name:"mr_number",label:"MR Number",placeholder:"Enter MR number"},{name:"item_name",label:"Item Name",placeholder:"Enter Item Name"},{name:"date_from",label:"Date From",type:"date",placeholder:"Enter Date from"},{name:"date_to",label:"Date To",type:"date",placeholder:"Enter Date To"}],fe=async t=>{ye(t);const s={};t.mr_number&&(s.mr_number=t.mr_number),t.item_name&&(s.item_name=t.item_name),t.branch_id&&(s.branch_id=t.branch_id),t.date_from&&t.date_to?t.date_from===t.date_to?s.date=t.date_from:(s.date_from=t.date_from,s.date_to=t.date_to):(t.date_from&&(s.date_from=t.date_from),t.date_to&&(s.date_to=t.date_to)),await q(s)},[S,k]=p.useState({}),[be,ye]=p.useState({});p.useEffect(()=>{B(),q()},[]);const je=async()=>{if(j){R(!0);try{const s=(await J.get(K.comparative_statement.details(Number(j)))).data?.statement;if(!s){O.error("Comparative statement not found"),V(le.COMPERATIVE_STATEMENT.LIST);return}const a=s.items||[],c=s.material_requisition_id;if(a.length===0){O.error("No items found in comparative statement"),V(le.COMPERATIVE_STATEMENT.LIST);return}c&&(E?.some(u=>u.id===c)||await q()),P("material_requisition_id",c?String(c):"");const r=[],o={};a.forEach((n,u)=>{const x={item_id:String(n.item_id||n.item?.id||""),item_name:n.item?.item_name||n.item_name||n.name||"",item_unit:n.item?.unit?.unit_name||n.item?.unit?.unit_symbol||n.item_unit||n.unit||"",description:n.item?.description||n.description||"",quantity:String(n.quantity||""),last_purchase_rate:String(n.last_purchase_rate||"0"),selected_vendor_id:n.selected_vendor_id?`v_${n.selected_vendor_id}`:"",vendors:[]};o[u]={};const w=n.vendors||[],y=new Set;if(w.forEach(i=>{const _=`v_${i.vendor_id||i.id}`,f=i.vendor?.party_name||i.party_name||`Vendor ${i.vendor_id}`;y.has(_)||(x.vendors.push({id:_,name:f,vendor_id:i.vendor_id||i.id}),y.add(_)),o[u][_]={quantity:String(i.quantity||x.quantity||""),rate:String(i.rate??i.unit_price??i.price??""),discount_percent:String(i.discount_percent??i.discount_percentage??i.discount??""),gst_percent:String(i.gst_percent??i.gst_percentage??i.tax_percent??""),net_amount:String(i.net_amount??""),total_amount:String(i.total_amount??""),loading_charges:String(i.loading_charges??""),freight_charges:String(i.freight_charges??""),cutting_charges:String(i.cutting_charges??"")}}),n.selected_vendor&&n.selected_vendor_id){const i=`v_${n.selected_vendor_id}`;y.has(i)||(x.vendors.push({id:i,name:n.selected_vendor_rate_details?.vendor_name||n.selected_vendor?.party_name||"Selected Vendor",vendor_id:n.selected_vendor_rate_details?.vendor_id||n.selected_vendor_id}),o[u][i]||(o[u][i]={quantity:String(n.quantity||""),rate:String(n.selected_vendor_rate_details?.rate??""),discount_percent:String(n.selected_vendor_rate_details?.discount_percentage??""),gst_percent:String(n.selected_vendor_rate_details?.gst_percentage??""),net_amount:String(n.selected_vendor_rate_details?.net_amount??""),total_amount:String(n.selected_vendor_rate_details?.total_amount??""),loading_charges:String(n.selected_vendor_rate_details?.loading_charges??""),freight_charges:String(n.selected_vendor_rate_details?.freight_charges??""),cutting_charges:String(n.selected_vendor_rate_details?.cutting_charges??"")}))}r.push(x)}),P("items",r),k(o),O.success("Comparative statement loaded successfully")}catch(t){console.error("Failed to load comparative statement:",t),console.error("Error response:",t.response?.data),O.error(t.response?.data?.message||"Failed to load comparative statement details")}finally{R(!1)}}};p.useEffect(()=>{(async()=>{j&&(await q(),await je())})()},[j]);const Ne=t=>{if(!t){P("items",[]);return}const s=E?.find(a=>a.id===Number(t));if(s&&s.items&&s.items.length>0){const a=s.items.map(r=>({item_id:String(r.item?.id||r.item_id||""),item_name:r.item?.item_name||r.item_name||r.name||"",item_unit:r.item?.unit?.unit_name||r.item?.unit?.unit_symbol||r.item_unit||r.unit||"",description:r.item?.description||r.description||"",quantity:String(r.quantity_required||r.quantity||""),last_purchase_rate:"0",selected_vendor_id:"",vendors:[]}));P("items",a);const c={};a.forEach((r,o)=>{c[o]={}}),k(c)}},ve=t=>{D(t),g(!0),!G.current&&!C.current&&(G.current=!0,C.current=!0,T({party_type:"Vendor"}).finally(()=>{C.current=!1}));const s=M(`items.${t}`);s.selected_vendor_id?(A(s.selected_vendor_id),d(s.selected_vendor_id)):s.vendors&&s.vendors.length>0?A(s.vendors[0].id):A("")},ce=()=>{g(!1),D(null),d(""),A("")},Se=(t,s,a)=>{if(!t)return"";const c=t*(s/100||0),r=t-c,o=r*(a/100||0),n=r+o;return Number.isFinite(n)?n.toFixed(2):""},te=(t,s,a=0,c=0,r=0)=>{const o=parseFloat(t)||0,n=parseFloat(s)||0,u=parseFloat(a)||0,x=parseFloat(c)||0,w=parseFloat(r)||0,i=o*n+u+x+w;return Number.isFinite(i)?i.toFixed(2):""},Y=(t,s,a,c)=>{const r={...S,[t]:{...S[t],[s]:{...S[t]?.[s],[a]:c}}};if(a==="quantity"){const _=r[t][s],f=_.net_amount,se=M(`items.${t}.quantity`),Z=te(se,f,_.loading_charges,_.freight_charges,_.cutting_charges);r[t][s].total_amount=Z,k(r);return}if(a==="loading_charges"||a==="freight_charges"||a==="cutting_charges"){const _=r[t][s],f=_.net_amount,se=M(`items.${t}.quantity`),Z=te(se,f,_.loading_charges,_.freight_charges,_.cutting_charges);r[t][s].total_amount=Z,k(r);return}const o=r[t][s],n=parseFloat(o?.rate||"0")||0,u=parseFloat(o?.discount_percent||"0")||0,x=parseFloat(o?.gst_percent||"0")||0,w=Se(n,u,x);r[t][s].net_amount=w;const y=M(`items.${t}.quantity`),i=te(y,w,o.loading_charges,o.freight_charges,o.cutting_charges);r[t][s].total_amount=i,k(r)},Ce=async t=>{if(!t||l===null)return;const s=parseInt(t);let a=N.find(f=>f.id===s);if(!a&&!C.current){C.current=!0;try{await T({party_type:"Vendor"}),a=N.find(f=>f.id===s)}finally{C.current=!1}if(!a)return}const c=a;if(!c)return;const o=M(`items.${l}`).vendors||[],n=o.filter(f=>f.vendor_id===s),u=n.length+1,x=`v_${s}_${u}`,w=n.length>0?`${c.party_name} (Rate ${u})`:c.party_name,y={id:x,name:c.party_name,vendor_id:s,rate_tier:u,display_name:w},i=[...o,y];P(`items.${l}.vendors`,i),A(x);const _=i.map(f=>f.vendor_id===s&&i.filter(Z=>Z.vendor_id===s).length>1?{...f,display_name:`${f.name} (Rate ${f.rate_tier||1})`}:f);P(`items.${l}.vendors`,_),k(f=>({...f,[l]:{...f[l],[x]:{...Ie}}})),d(""),await re()},Ve=async(t,s)=>{const a=M(`items.${t}`),c=a.vendors[s],r=c.id,o=a.vendors.filter((u,x)=>x!==s),n=o.map((u,x)=>{if(u.vendor_id===c.vendor_id){const w=o.filter(i=>i.vendor_id===u.vendor_id).length,y=o.filter((i,_)=>i.vendor_id===u.vendor_id&&_<=x).length;return w>1?{...u,rate_tier:y,display_name:`${u.name} (Rate ${y})`,id:`v_${u.vendor_id}_${y}`}:{...u,rate_tier:1,display_name:u.name,id:`v_${u.vendor_id}_1`}}return u});P(`items.${t}.vendors`,n),k(u=>{const x={...u};if(x[t]){delete x[t][r];const w={};n.forEach(y=>{const i=Object.keys(x[t]).find(_=>_.startsWith(`v_${y.vendor_id}_`));i&&i!==y.id?(w[y.id]=x[t][i],delete x[t][i]):x[t][y.id]&&(w[y.id]=x[t][y.id])}),x[t]={...x[t],...w}}return x}),a.selected_vendor_id===r&&P(`items.${t}.selected_vendor_id`,""),v===r&&n.length>0&&A(n[0].id),await re()},ne=t=>t?!!(t.rate||t.net_amount||t.total_amount):!1,we=async t=>{Q(!0);const s={branch_id:Number(W),material_requisition_id:t.material_requisition_id?Number(t.material_requisition_id):null,items:t.items.map((a,c)=>{const r=a.selected_vendor_id?S[c]?.[a.selected_vendor_id]:null;return{item_id:Number(a.item_id),quantity:Number(a.quantity),last_purchase_rate:Number(a.last_purchase_rate)||0,selected_vendor_id:a.selected_vendor_id?Number(a.selected_vendor_id.replace(/^v_(\d+)(_\d+)?$/,"$1")):null,vendors:a.selected_vendor_id?[{vendor_id:Number(a.selected_vendor_id.replace(/^v_(\d+)(_\d+)?$/,"$1")),quantity:Number(a.quantity),rate:r&&Number(r.rate)||0,unit_price:r&&Number(r.rate)||0,discount_percent:r&&Number(r.discount_percent)||0,gst_percent:r&&Number(r.gst_percent)||0,discount_percentage:r&&Number(r.discount_percent)||0,gst_percentage:r&&Number(r.gst_percent)||0,tax_percentage:r&&Number(r.gst_percent)||0,net_amount:r&&Number(r.net_amount)||0,total_amount:r&&Number(r.total_amount)||0,loading_charges:r&&Number(r.loading_charges)||0,freight_charges:r&&Number(r.freight_charges)||0,cutting_charges:r&&Number(r.cutting_charges)||0}]:[]}}).filter(a=>a.selected_vendor_id)};try{const a=j?K.comparative_statement.update(Number(j)):K.comparative_statement.create;await(j?J.put:J.post)(a,s),O.success(j?"Comparative statement updated successfully":"Comparative statement created successfully"),V(le.COMPERATIVE_STATEMENT.LIST)}catch(a){console.error(a),O.error(a.response?.data?.message||"Failed to save comparative statement")}finally{Q(!1)}};if(I)return e.jsx("div",{className:"flex justify-center py-20",children:e.jsx(ke,{})});const F=l!==null?M(`items.${l}.vendors`)||[]:[];return e.jsxs("div",{className:"w-full h-full overflow-auto bg-slate-50",children:[e.jsxs("div",{className:"max-w-7xl mx-auto space-y-8 px-6 py-5 pb-10",children:[e.jsx(Me,{title:j?"Edit Comparative Statement":"Create Comparative Statement",subtitle:j?"Update the comparative statement details":"Compare rates from multiple vendors and select the best option."}),e.jsx(Oe,{fields:_e,onFilter:fe,defaultValues:be}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm p-4 sm:p-6 space-y-6",children:[e.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-xs font-semibold text-slate-500 uppercase mb-1",children:"Material Request"}),e.jsx($,{name:"material_requisition_id",control:ae,render:({field:t})=>e.jsxs(de,{...t,className:"text-sm py-2",onChange:s=>{t.onChange(s.target.value),Ne(s.target.value)},disabled:!!j,children:[e.jsx("option",{value:"",children:"Select Material Request"}),E&&E.length>0&&E.map(s=>e.jsxs("option",{value:s.id,children:[s.mr_number," - ",s.department||"Unknown Dept"]},s.id))]})})]})}),ee.length>0&&e.jsxs("div",{className:"mt-6",children:[e.jsxs("h3",{className:"text-sm font-semibold text-slate-700 mb-3",children:["Material Request Items (",ee.length,")"]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border-collapse",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-slate-100 border-b border-slate-200",children:[e.jsx("th",{className:"text-left text-xs font-semibold text-slate-600 p-3",children:"Item Name"}),e.jsx("th",{className:"text-center text-xs font-semibold text-slate-600 p-3",children:"Unit"}),e.jsx("th",{className:"text-left text-xs font-semibold text-slate-600 p-3",children:"Item Description"}),e.jsx("th",{className:"text-center text-xs font-semibold text-slate-600 p-3",children:"Quantity"}),e.jsx("th",{className:"text-center text-xs font-semibold text-slate-600 p-3",children:"Last Rate"}),e.jsx("th",{className:"text-center text-xs font-semibold text-slate-600 p-3",children:"Selected Vendor"}),e.jsx("th",{className:"text-center text-xs font-semibold text-slate-600 p-3",children:"Action"})]})}),e.jsx("tbody",{children:ee.map((t,s)=>{const a=X(`items.${s}.vendors`)||[],c=X(`items.${s}.selected_vendor_id`),r=a.find(o=>o.id===c);return e.jsxs("tr",{className:"border-b border-slate-100 hover:bg-slate-50",children:[e.jsx("td",{className:"p-3",children:e.jsx(h,{...H(`items.${s}.item_name`),className:"bg-slate-50 border-slate-200 text-sm py-2",readOnly:!0})}),e.jsx("td",{className:"p-3",children:e.jsx(h,{...H(`items.${s}.item_unit`),className:"bg-slate-50 border-slate-200 text-center text-sm py-2",readOnly:!0})}),e.jsx("td",{className:"p-3",children:e.jsx(h,{...H(`items.${s}.description`),className:"bg-slate-50 border-slate-200 text-sm py-2",readOnly:!0,placeholder:"No description"})}),e.jsx("td",{className:"p-3",children:e.jsx(h,{...H(`items.${s}.quantity`),type:"number",className:"text-center text-sm py-2",placeholder:"0"})}),e.jsx("td",{className:"p-3",children:e.jsx(h,{...H(`items.${s}.last_purchase_rate`),type:"number",className:`text-center text-sm py-2 ${j?"bg-slate-50 border-slate-200":""}`,placeholder:"0.00",readOnly:!!j})}),e.jsx("td",{className:"p-3",children:r?e.jsx("div",{className:"bg-green-50 border border-green-300 rounded px-3 py-2 text-center",children:e.jsx("span",{className:"text-sm font-medium text-green-800",children:r.name})}):e.jsx("div",{className:"bg-gray-50 border border-gray-200 rounded px-3 py-2 text-center",children:e.jsx("span",{className:"text-xs text-gray-400",children:"Not Selected"})})}),e.jsx("td",{className:"p-3 text-center",children:e.jsx(z,{variant:"outline",onClick:()=>ve(s),className:"text-xs py-1 px-3",children:"Select Vendor"})})]},t.fieldId)})})]})})]}),!M("material_requisition_id")&&e.jsx("div",{className:"text-center p-12 bg-white border border-dashed border-slate-300 rounded-lg text-slate-500",children:"Please select a material request to view items."}),e.jsxs("div",{className:"flex justify-end items-center gap-3 mt-6",children:[e.jsx(z,{variant:"outline",onClick:()=>V(-1),children:"Cancel"}),e.jsx(z,{className:"bg-red-600 text-white",onClick:ge(we),loading:U,disabled:U||ee.length===0,children:j?"Update Statement":"Submit Statement"})]})]})]}),e.jsx(me,{open:b,onClose:ce,title:"Select Vendors",maxWidth:"max-w-5xl",children:l!==null&&e.jsxs("div",{className:"space-y-4 max-h-[80vh] overflow-y-auto pr-2",children:[e.jsx("div",{className:"bg-slate-50 p-4 rounded-lg border border-slate-200",children:e.jsxs("div",{className:"grid grid-cols-4 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-xs text-slate-500 block mb-1",children:"Item:"}),e.jsx("p",{className:"font-medium",children:X(`items.${l}.item_name`)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-xs text-slate-500 block mb-1",children:"Unit:"}),e.jsx("p",{className:"font-medium",children:X(`items.${l}.item_unit`)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-slate-500 block mb-1",children:"Quantity:"}),e.jsx(h,{...H(`items.${l}.quantity`),type:"number",className:"text-sm py-2 font-medium",placeholder:"0",onChange:t=>{P(`items.${l}.quantity`,t.target.value),(X(`items.${l}.vendors`)||[]).forEach(a=>{const c=S[l]?.[a.id],r=c?.net_amount||"";if(r){const o=te(t.target.value,r,c?.loading_charges,c?.freight_charges,c?.cutting_charges);k(n=>({...n,[l]:{...n[l],[a.id]:{...n[l]?.[a.id],total_amount:o}}}))}})}})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-slate-500 block mb-1",children:"Last Rate:"}),e.jsx(h,{...H(`items.${l}.last_purchase_rate`),type:"number",className:"text-sm py-2 font-medium",placeholder:"0.00"})]})]})}),e.jsxs("div",{className:"flex items-end gap-4 w-full",children:[e.jsxs("div",{className:"flex-1 flex flex-col",children:[e.jsx("label",{className:"text-xs font-semibold text-slate-500 uppercase mb-1 hover:text-black cursor-default transition-colors",children:"Add Vendor"}),e.jsx(pe,{ref:oe,value:m,onChange:t=>{d(t),Ce(t)},placeholder:"Select Vendor to Add",disabled:I,excludeVendorIds:[],onMount:()=>{}})]}),e.jsx("div",{className:"pb-0.5",children:e.jsx(z,{variant:"outline",className:"text-xs py-2 px-4 h-[40px] border-slate-300 hover:bg-slate-100 whitespace-nowrap",onClick:()=>{ie(!0),oe.current?.close()},children:"+ Add Party"})}),e.jsxs("div",{className:"flex-1 flex flex-col",children:[e.jsx("label",{className:"text-xs font-semibold text-slate-500 uppercase mb-1",children:"Select Vendor (Final Choice)"}),e.jsx($,{name:`items.${l}.selected_vendor_id`,control:ae,render:({field:t})=>e.jsxs(de,{...t,className:"text-sm py-2 bg-green-50 border-green-300",onChange:s=>{const a=s.target.value;t.onChange(a),a&&A(a),re(`items.${l}.selected_vendor_id`)},children:[e.jsx("option",{value:"",children:"Select Vendor"}),F.filter(s=>{const a=S[l]?.[s.id];return ne(a)}).map(s=>e.jsxs("option",{value:s.id,children:[s.display_name||s.name||"Vendor"," - ₹",S[l]?.[s.id]?.rate||"0"]},s.id))]})})]})]}),F.length>0&&e.jsx("div",{className:"space-y-4",children:(()=>{const t=F.find(a=>a.id===v)||F[0];if(!t)return null;const s=F.findIndex(a=>a.id===t.id);return e.jsxs("div",{className:"bg-slate-50 rounded-lg border border-slate-200 p-4 shadow-sm",children:[e.jsxs("div",{className:"flex justify-between items-center mb-3 pb-2 border-b border-slate-300",children:[e.jsx("span",{className:"font-semibold text-slate-700 text-sm",children:t.display_name||t.name||`Vendor ${s+1}`}),F.length>1&&e.jsx("button",{type:"button",onClick:()=>Ve(l,s),className:"text-red-400 hover:text-red-600 font-bold ml-2",children:"✕"})]}),e.jsxs("div",{className:"grid grid-cols-5 gap-3",children:[e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-xs text-slate-500 text-center font-medium",children:"Rate"}),e.jsx(h,{type:"number",className:"text-sm text-right py-2 px-2",placeholder:"0.00",value:S[l]?.[t.id]?.rate||"",onChange:a=>{Y(l,t.id,"rate",a.target.value)}})]}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-xs text-slate-500 text-center font-medium",children:"Disc%"}),e.jsx(h,{type:"number",className:"text-sm text-right py-2 px-2",placeholder:"0",value:S[l]?.[t.id]?.discount_percent||"",onChange:a=>{Y(l,t.id,"discount_percent",a.target.value)}})]}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-xs text-slate-500 text-center font-medium",children:"GST%"}),e.jsx(h,{type:"number",className:"text-sm text-right py-2 px-2",placeholder:"0",value:S[l]?.[t.id]?.gst_percent||"",onChange:a=>{Y(l,t.id,"gst_percent",a.target.value)}})]}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-xs text-slate-500 text-center font-medium",children:"Net Amount"}),e.jsx(h,{readOnly:!0,className:"bg-white border-slate-200 text-sm text-right font-medium py-2 px-2",value:S[l]?.[t.id]?.net_amount||""})]}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-xs text-slate-500 text-center font-medium",children:"Total Amount"}),e.jsx(h,{readOnly:!0,className:"bg-blue-50 border-blue-200 text-sm text-right font-semibold py-2 px-2",value:S[l]?.[t.id]?.total_amount||""})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-3 mt-3 pt-3 border-t border-slate-200",children:[e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-xs text-slate-500 text-center font-medium",children:"Loading Charges"}),e.jsx(h,{type:"number",className:"text-sm text-right py-2 px-2",placeholder:"0.00",value:S[l]?.[t.id]?.loading_charges||"",onChange:a=>{Y(l,t.id,"loading_charges",a.target.value)}})]}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-xs text-slate-500 text-center font-medium",children:"Freight Charges"}),e.jsx(h,{type:"number",className:"text-sm text-right py-2 px-2",placeholder:"0.00",value:S[l]?.[t.id]?.freight_charges||"",onChange:a=>{Y(l,t.id,"freight_charges",a.target.value)}})]}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-xs text-slate-500 text-center font-medium",children:"Cutting Charges"}),e.jsx(h,{type:"number",className:"text-sm text-right py-2 px-2",placeholder:"0.00",value:S[l]?.[t.id]?.cutting_charges||"",onChange:a=>{Y(l,t.id,"cutting_charges",a.target.value)}})]})]})]},t.id)})()}),F.length>0&&e.jsxs("div",{className:"mt-6 border-t border-slate-200 pt-4",children:[e.jsxs("h3",{className:"text-sm font-semibold text-slate-700 mb-3",children:["Participating Vendors (",F.filter(t=>ne(S[l]?.[t.id])).length,")"]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:F.map(t=>{const s=t.id===v,a=t.id===X(`items.${l}.selected_vendor_id`);let c,r;a?(c="p-4 border-2 border-green-500 bg-green-50 rounded-lg shadow-sm cursor-pointer",r="font-semibold text-sm text-green-800"):s?(c="p-4 border border-gray-600 bg-gray-400 text-white rounded-lg shadow-sm cursor-pointer",r="font-semibold text-sm text-white"):(c="p-4 border border-slate-200 bg-white rounded-lg shadow-sm cursor-pointer hover:border-slate-300",r="font-semibold text-slate-800 text-sm");const o=S[l]?.[t.id];return ne(o)?e.jsxs("div",{className:c,onClick:()=>A(t.id),children:[e.jsx("div",{className:"flex justify-between mb-2 items-center",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h4",{className:r,children:t.display_name||t.name}),a&&e.jsx("span",{className:"text-xs bg-green-500 text-white px-2 py-1 rounded-full",children:"Selected"})]})}),e.jsx("div",{className:"space-y-2",children:e.jsx("div",{className:a?"border border-green-200 rounded p-2 bg-green-100":s?"border border-gray-500/40 rounded p-2 bg-gray-500/30":"border border-slate-100 rounded p-2 bg-slate-50",children:e.jsxs("div",{className:"grid grid-cols-2 gap-1 text-[11px]",children:[e.jsxs("span",{className:a?"text-green-700":s?"text-white":"",children:["Rate: ₹",o?.rate||"0"]}),e.jsxs("span",{className:a?"text-green-700":s?"text-white":"",children:["Disc: ",o?.discount_percent||"0","%"]}),e.jsxs("span",{className:a?"text-green-700":s?"text-white":"",children:["GST: ",o?.gst_percent||"0","%"]}),e.jsxs("span",{className:`font-semibold ${a?"text-green-700":s?"text-white":""}`,children:["Net: ₹",o?.net_amount||"0"]}),(o?.loading_charges||o?.freight_charges||o?.cutting_charges)&&e.jsxs(e.Fragment,{children:[e.jsxs("span",{className:`text-[10px] ${a?"text-green-600":s?"text-white/90":"text-slate-600"}`,children:["Load: ₹",o?.loading_charges||"0"]}),e.jsxs("span",{className:`text-[10px] ${a?"text-green-600":s?"text-white/90":"text-slate-600"}`,children:["Freight: ₹",o?.freight_charges||"0"]}),e.jsxs("span",{className:`text-[10px] col-span-2 ${a?"text-green-600":s?"text-white/90":"text-slate-600"}`,children:["Cutting: ₹",o?.cutting_charges||"0"]})]}),e.jsxs("span",{className:`col-span-2 font-semibold ${a?"text-green-800":s?"text-white":"text-blue-700"}`,children:["Total: ₹",o?.total_amount||"0"]})]})})})]},t.id):null})})]}),F.length===0&&e.jsx("div",{className:"text-center p-8 bg-yellow-50 border border-yellow-200 rounded-lg text-yellow-700 text-sm",children:"Please add at least one vendor to compare rates."}),e.jsx("div",{className:"flex justify-end gap-3 mt-6 pt-4 border-t border-slate-200 sticky bottom-0 bg-white",children:e.jsx(z,{variant:"outline",onClick:ce,children:"Close"})})]})}),e.jsx(Be,{open:he,onClose:()=>ie(!1),onSuccess:()=>{C.current||(C.current=!0,T({party_type:"Vendor"}).finally(()=>{C.current=!1}))}})]})};export{st as default};
