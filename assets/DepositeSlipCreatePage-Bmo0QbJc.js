import{u as H,i as Q,a as w,r as u,j as e,B as x,h as b,e as y,y as I,A as V}from"./index-CHv2um3-.js";import{T}from"./TextInput-DLaHSu5O.js";import{L as W}from"./ListWrapper-uuw8VAoB.js";import{T as O}from"./TableActions-FoDa3IvB.js";import{T as z,a as G,b as l}from"./TableWrapper-BsErbKM7.js";import{T as J}from"./TableDelete-B3qkP8R2.js";import{u as K,b as X,C as n}from"./index.esm-BXq0dTbn.js";import{u as Y}from"./useItemsStore-FRvsqFPc.js";import{u as Z}from"./useMaterialRequestStore-DQrdMXRi.js";import{L as ee}from"./Loading-sZj5B-qA.js";import{F as te}from"./FormHeader-B3DVUoW0.js";import{B as ie}from"./BranchUserSelect-DC3Wj6-k.js";import"./BackButton-C8N1R7JM.js";const se={reason:"",deposited_by:"",recieved_by:"Store",branch_id:"",material_requisition_id:"",item_id:"",quantity_to_deposit:"",quantity_deposited:"",items:[{item_name:"",item_code:"",item_id:"",item_unit:"",qty_to_deposit:"",qty_deposited:""}]},be=()=>{const f=H(),[L]=Q(),o=L.get("editId"),{selectedBranchId:_}=w(),{control:d,handleSubmit:P,setValue:c,reset:R,formState:{errors:h}}=K({defaultValues:se}),{fields:$,append:A,remove:E}=X({control:d,name:"items"}),{user:j}=w(),{items:g,fetchItems:q}=Y(),{materials:p,fetchMaterials:v}=Z(),[F,S]=u.useState(!1),[N,C]=u.useState(!1),[D,B]=u.useState(!1);u.useEffect(()=>{(async()=>{await Promise.all([q(),v()]),B(!0)})()},[q,v]);const M=async()=>{if(o){S(!0);try{const s=await b.get(y.deposit_slip.details(Number(o))),i=s.data.slip||s.data;R({branch_id:i.branch_id?String(i.branch_id):_?String(_):"",material_requisition_id:i.material_requisition_id?String(i.material_requisition_id):"",recieved_by:i.recieved_by,deposited_by:i.deposited_by,reason:i.reason||"",items:(i.items||[]).map(t=>({item_id:t.item_id,item_code:t.item?.item_code||"",item_name:t.item?.item_name||"",item_unit:t.unit?.unit_name||"",qty_to_deposit:t.quantity_to_deposit,qty_deposited:t.quantity_deposited}))})}catch(s){console.error("Failed to load details:",s),I.error("Failed to load deposit slip details")}finally{S(!1)}}};u.useEffect(()=>{o&&D&&M()},[o,D]);const U=async s=>{C(!0);const i={branch_id:_,material_requisition_id:s.material_requisition_id?Number(s.material_requisition_id):null,recieved_by:s.recieved_by,deposited_by:s.deposited_by,reason:s.reason,items:s.items.map(t=>({item_id:Number(t.item_id),quantity_to_deposit:Number(t.qty_to_deposit),quantity_deposited:Number(t.qty_deposited)}))};try{const t=o?y.deposit_slip.update(Number(o)):y.deposit_slip.create;await(o?b.put:b.post)(t,i),f(V.DEPOSITE_SLIP.LIST)}catch(t){console.error(t),I.error(t.response?.data?.message||"Failed to save deposit slip")}finally{C(!1)}};return F?e.jsx("div",{className:"flex justify-center py-20",children:e.jsx(ee,{})}):e.jsxs("div",{className:"w-full h-full overflow-auto space-y-8 p-4 pb-20",children:[e.jsx("div",{className:"space-y-1 ml-2",children:e.jsx(te,{title:o?"Edit Deposite Slip":"Create Deposite Slip",subtitle:o?"Update the Deposite Slip details":"Fill out the form to submit a new Deposite Slip"})}),e.jsxs("div",{className:"grid grid-cols-2 gap-5 ml-2 mr-5",children:[e.jsx(n,{name:"material_requisition_id",control:d,render:({field:s})=>e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-semibold text-gray-700 mb-1",children:"Material Request"}),e.jsxs("select",{...s,className:"w-full h-[45px] rounded-lg border border-gray-300 px-4 mt-1 text-sm",onChange:i=>{const t=i.target.value;if(s.onChange(t),t){const r=p&&p.find(m=>m.id===Number(t));if(r&&r.items&&r.items.length>0){const m=r.items.map(a=>({item_id:a.item?.id||a.item_id||"",item_code:a.item?.item_code||"",item_name:a.item?.item_name||"",item_unit:a.item?.unit?.unit_name||"",qty_to_deposit:a.quantity_required||a.quantity||"",qty_deposited:""}));c("items",m)}}},children:[e.jsx("option",{value:"",children:"Select Material Request"}),p&&p.length>0&&p.map(i=>e.jsxs("option",{value:i.id,children:[i.mr_number," - ",i.department||"Unknown Dept"]},i.id))]})]})}),e.jsx(n,{name:"reason",control:d,render:({field:s})=>e.jsx(T,{...s,label:"Reason for deposing",error:h.reason?.message,placeholder:"Enter reason for deposing"})}),e.jsx(ie,{label:"Deposited By",name:"deposited_by",control:d,branchId:j?.branch?.id||j?.branch_id,error:h.deposited_by?.message}),e.jsx(n,{name:"recieved_by",control:d,render:({field:s})=>e.jsx(T,{...s,label:"Recieved By",error:h.recieved_by?.message})})]}),e.jsxs(W,{title:"Items Requested",children:[e.jsx("div",{className:"flex justify-end mb-2",children:e.jsx(x,{className:"bg-red-600 text-white px-3 py-1",onClick:()=>A({item_name:"",item_code:"",item_id:"",item_unit:"",qty_to_deposit:"",qty_deposited:""}),children:"+ Add Item"})}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(z,{children:[e.jsx(G,{cols:[{title:"Item Name"},{title:"Item Code"},{title:"Item Unit"},{title:"Qty to Deposite"},{title:"Qty Deposited"},{title:"Action"}]}),e.jsx("tbody",{children:$.map((s,i)=>e.jsxs("tr",{className:"align-middle",children:[e.jsx(l,{children:i+1}),e.jsx(l,{children:e.jsx(n,{name:`items.${i}.item_code`,control:d,render:({field:t})=>e.jsxs("select",{...t,className:"w-full h-[45px] rounded-lg border border-gray-300 px-5 mt-1 text-sm",onChange:r=>{const m=r.target.value;t.onChange(m);const a=g.find(k=>k.item_code===m);a&&(c(`items.${i}.item_name`,a.item_name),c(`items.${i}.item_code`,a.item_code),c(`items.${i}.item_unit`,a.unit?.unit_name||""),c(`items.${i}.item_id`,a.id))},children:[e.jsx("option",{value:"",children:"Select Item"}),g.map(r=>e.jsxs("option",{value:r.item_code,children:[r.item_name," (",r.item_code,")"]},r.id))]})})}),e.jsx(l,{children:e.jsx(n,{name:`items.${i}.item_code`,control:d,render:({field:t})=>e.jsx("input",{...t,className:"w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm",placeholder:"Code"})})}),e.jsx(l,{children:e.jsx(n,{name:`items.${i}.item_unit`,control:d,render:({field:t})=>e.jsx("input",{...t,className:"w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm",placeholder:"Unit"})})}),e.jsx(l,{children:e.jsx(n,{name:`items.${i}.qty_to_deposit`,control:d,render:({field:t})=>e.jsx("input",{...t,type:"number",className:"w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm",placeholder:"0"})})}),e.jsx(l,{children:e.jsx(n,{name:`items.${i}.qty_deposited`,control:d,render:({field:t})=>e.jsx("input",{...t,type:"number",className:"w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm",placeholder:"0"})})}),e.jsx(l,{children:e.jsx(O,{children:e.jsx(J,{onClick:()=>E(i)})})})]},s.id))})]})})]}),e.jsxs("div",{className:"flex justify-end gap-3 mr-5",children:[e.jsx(x,{variant:"outline",onClick:()=>f(-1),children:"Cancel"}),e.jsx(x,{className:"bg-red-600 text-white",onClick:P(U),loading:N,disabled:N,children:o?"Update Deposit Slip":"Submit Deposit Slip"})]})]})};export{be as default};
