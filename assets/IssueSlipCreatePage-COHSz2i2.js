import{u as ie,b as re,a as le,r as f,h as I,e as v,y,j as e,B as w,i as S,A as ne}from"./index-5cgORhEY.js";import{F as oe}from"./FormHeader-Cf55-c6p.js";import{T as h}from"./TextInput-79R6YI_q.js";import{S as me}from"./Select-DIBfegq0.js";import{L as de}from"./ListWrapper-Blim2baA.js";import{T as ue}from"./TableActions-C1Z13Nh8.js";import{T as x}from"./TableData-ONbj5s7v.js";import{T as ce}from"./TableDelete-D0k4l_Ns.js";import{T as pe,a as xe}from"./TableWrapper-Dj_EV8so.js";import{u as _e,b as he,C as c}from"./index.esm-DJg7NxZA.js";import{L as fe}from"./Loading-B1FFLWWP.js";import{u as ye}from"./useMachineStore-A9LXgzDK.js";import{u as be}from"./useMaterialRequestStore-CBL-THvg.js";import{o as ge,k as je}from"./yup-GURQQu5j.js";import{C as qe}from"./CommonFilter-BDafyRYm.js";import"./BackButton-C2V7tOX5.js";const F={mr:"",machine:"",for_party:"",for_mines:"",issued_to:"",purpose:"",items:[{item_name:"",item_code:"",item_id:"",item_unit:"",required_qty:"",issued_qty:""}]},Oe=()=>{const T=ie(),[L]=re(),n=L.get("editId"),{selectedBranchId:U}=le(),{materials:_,fetchMaterials:C}=be(),[B,E]=f.useState(!1),[Q,R]=f.useState(!1),{machines:H,fetchMachines:$}=ye(),[W,Y]=f.useState({}),z=[{name:"mr_number",label:"MR Number",placeholder:"Enter MR Number"},{name:"item_name",label:"Item Name",placeholder:"Enter Item Name"},{name:"date_from",label:"Date From",type:"date"},{name:"date_to",label:"Date To",type:"date"}],{control:u,handleSubmit:G,setValue:N,reset:P,watch:k,formState:{errors:b}}=_e({defaultValues:F,resolver:ge(je)}),{fields:J,append:K,remove:X}=he({control:u,name:"items"}),o=k("mr");f.useEffect(()=>{C(),$()},[C,$]);const Z=async t=>{Y(t);const s={};t.requested_by&&(s.requested_by=t.requested_by),t.mr_number&&(s.mr_number=t.mr_number),t.item_name&&(s.item_name=t.item_name),t.date_from&&t.date_to?t.date_from===t.date_to?s.date=t.date_from:(s.date_from=t.date_from,s.date_to=t.date_to):(t.date_from&&(s.date_from=t.date_from),t.date_to&&(s.date_to=t.date_to)),await C(s)},D=f.useCallback(async t=>{try{const s=_&&_.find(a=>a.mr_number===t);if(!s)return;const d=(await I.get(v.material_requisition.details(s.id))).data?.material_requisition;if(d?.items?.length>0){const a=d.issue_slips||[],p={};a.forEach(i=>{i.items?.forEach(m=>{const r=m.item_id,j=parseFloat(m.issued_qty)||0;p[r]=(p[r]||0)+j})});const g=d.items.map(i=>{const m=i.item,r=m?.id||i.item_id,j=m?.item_name||i.item_name,q=m?.item_code||i.item_code,M=m?.unit?.unit_name||i.unit?.unit_name||i.item_unit,A=i.quantity_required||i.quantity||i.required_qty,te=m?.balance_quantity||"0",V=p[r]||0,se=parseFloat(A)||0,ae=V>=se;return{item_id:r?.toString()||"",item_name:j||"",item_code:q||"",item_unit:M||"",required_qty:A?.toString()||"",issued_qty:"",total_issued_qty:V.toString(),is_fully_fulfilled:ae,balance_quantity:te}});N("items",g),y.success(`Loaded ${g.length} items from MR ${t}`)}else N("items",F.items),y.info("No items found for the selected MR")}catch(s){console.error("Failed to fetch MR details:",s),y.error("Failed to load MR details")}},[_,N]),O=f.useCallback(async()=>{if(n){E(!0);try{const t=await I.get(v.issue_slips.details(Number(n))),s=t.data.slip||t.data.data||t.data;P({mr:s.mr,machine:s.machine_id?String(s.machine_id):s.machine?String(s.machine):"",for_party:s.for_party??"",for_mines:s.for_mines??"",issued_to:s.issued_for??s.issued_to??"",purpose:s.purpose??"",items:s.items?.map(l=>({item_id:l.item_id?.toString()||"",item_code:l.item?.item_code||"",item_name:l.item?.item_name||"",item_unit:l.item?.unit?.unit_name||"",required_qty:l.required_qty?.toString()||"",issued_qty:l.issued_qty?.toString()||""}))||F.items})}finally{E(!1)}}},[n,P]);f.useEffect(()=>{n&&O()},[n,O]),f.useEffect(()=>{o&&!n&&_&&_.length>0?D(o):!o&&!n&&N("items",F.items)},[o,n,_,D,N]);const ee=async t=>{const s=t.items.filter(a=>a.item_id&&a.issued_qty&&Number(a.issued_qty)>0);if(s.length===0){y.error("Please enter issued quantity for at least one item");return}const l=[];if(s.forEach(a=>{const p=parseFloat(a.required_qty||"0"),g=parseFloat(a.total_issued_qty||"0"),i=Math.max(0,p-g),m=parseFloat(a.issued_qty||"0");m>i&&l.push(`${a.item_name}: Cannot issue ${m}, only ${i.toFixed(3)} remaining`)}),l.length>0){y.error(e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:"Issued quantity exceeds remaining quantity:"}),e.jsx("ul",{className:"list-disc pl-5 mt-2",children:l.map((a,p)=>e.jsx("li",{children:a},p))})]}),{autoClose:8e3});return}R(!0);const d={mr:t.mr,branch_id:U,machine_id:t.machine?Number(t.machine):null,for_party:t.for_party||null,for_mines:t.for_mines||null,issued_for:t.issued_to||null,purpose:t.purpose||null,items:s.map(a=>({item_id:Number(a.item_id),required_qty:Number(a.required_qty)||0,issued_qty:Number(a.issued_qty),transaction_type:"opening_stock"}))};console.log("Submitting payload:",d);try{const a=n?v.issue_slips.update(Number(n)):v.issue_slips.create;await(n?I.put:I.post)(a,d),y.success(n?"Issue slip updated successfully":"Issue slip created successfully"),T(ne.ISSUE_SLIP.LIST)}catch(a){console.error("Error submitting issue slip:",a),console.error("Error response:",a.response?.data),y.error(a.response?.data?.message||"Failed to save issue slip")}finally{R(!1)}};return B?e.jsx("div",{className:"flex justify-center py-20",children:e.jsx(fe,{})}):e.jsxs("div",{className:"w-full h-full flex flex-col overflow-hidden bg-gray-50",children:[e.jsxs("div",{className:"flex justify-between items-center p-4 bg-white border-b sticky top-0 z-10 shadow-sm shrink-0",children:[e.jsx(oe,{title:n?"Edit Issue Slip":"Create Issue Slip",subtitle:n?"Update the Issue Slip details":"Fill out the form to submit a new Issue Slip"}),e.jsxs("div",{className:"flex justify-end gap-3 mr-5",children:[e.jsx(w,{variant:"outline",onClick:()=>T(-1),children:"Cancel"}),e.jsx(w,{className:"bg-red-600 text-white",onClick:G(ee),loading:Q,disabled:Q,children:n?"Update Issue Slip":"Submit Issue Slip"})]})]}),e.jsxs("div",{className:"flex-1 overflow-auto p-4 space-y-8 pb-20",children:[e.jsx(qe,{fields:z,onFilter:Z,defaultValues:W}),e.jsxs("div",{className:"grid grid-cols-2 gap-5 ml-2 mr-5",children:[e.jsx(c,{name:"mr",control:u,render:({field:t})=>e.jsxs("div",{children:[e.jsxs("label",{className:"text-sm font-semibold text-gray-700 mb-1",children:["Issued To MR ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{...t,disabled:!!n,className:"w-full h-[45px] rounded-lg border border-gray-300 px-4 mt-1 text-sm",children:[e.jsx("option",{value:"",children:"Select Material Requisition"}),_&&_.length>0?_.map(s=>e.jsxs("option",{value:s.mr_number,children:[s.mr_number," - ",s.department||"Unknown Dept"]},s.mr_number)):e.jsx("option",{disabled:!0,children:"No Material Requisitions Available"})]}),b.mr?.message&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:b.mr.message})]})}),e.jsx(c,{name:"machine",control:u,render:({field:t})=>e.jsxs(me,{...t,label:"For Machine",error:b.machine?.message,children:[e.jsx("option",{value:"",children:"Select Machine (Optional)"}),H.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})}),e.jsx(c,{name:"for_party",control:u,render:({field:t})=>e.jsx(h,{...t,label:"For Party",placeholder:"Enter Party Name (Optional)",error:b.for_party?.message})}),e.jsx(c,{name:"for_mines",control:u,render:({field:t})=>e.jsx(h,{...t,label:"For Mines",placeholder:"Enter Mine (Optional)",error:b.for_mines?.message})}),e.jsx(c,{name:"issued_to",control:u,render:({field:t})=>e.jsx(h,{...t,label:"Issued To",placeholder:"Enter Name (Optional)",error:b.issued_to?.message})}),e.jsx(c,{name:"purpose",control:u,render:({field:t})=>e.jsx(h,{...t,label:"Purpose",placeholder:"Enter Purpose (Optional)",error:b.purpose?.message})})]}),e.jsxs(de,{title:"Items to Issue",children:[e.jsx("div",{className:"flex justify-end mb-2",children:!o&&e.jsx(w,{className:"bg-red-600 text-white px-3 py-1",onClick:()=>K({...F.items[0]}),children:"+ Add Item"})}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(pe,{children:[e.jsx(xe,{cols:[{title:"Item Name"},{title:"Item Code"},{title:"Item Description"},{title:"Item Unit"},{title:"Required QTY"},{title:"Total Issued"},{title:"Issued QTY"},{title:"Balance QTY"},{title:"Status"},{title:"Action"}]}),e.jsx("tbody",{children:J.map((t,s)=>{const l=k(`items.${s}`),d=l?.is_fully_fulfilled||!1,a=l?.total_issued_qty||"0",p=parseFloat(l?.required_qty||"0"),g=parseFloat(a),i=Math.max(0,p-g),m=parseFloat(l?.balance_quantity||"0");return e.jsxs("tr",{className:"align-middle",children:[e.jsx(x,{children:s+1}),e.jsx(x,{children:e.jsx(c,{name:`items.${s}.item_name`,control:u,render:({field:r})=>e.jsx(h,{...r,readOnly:!!o,className:S("mb-0 h-[40px]",o&&"bg-gray-50"),placeholder:"Item Name"})})}),e.jsx(x,{children:e.jsx(c,{name:`items.${s}.item_code`,control:u,render:({field:r})=>e.jsx(h,{...r,readOnly:!!o,className:S("mb-0 h-[40px]",o&&"bg-gray-50"),placeholder:"Code"})})}),e.jsx(x,{children:e.jsx(c,{name:`items.${s}.item_unit`,control:u,render:({field:r})=>e.jsx(h,{...r,readOnly:!!o,className:S("mb-0 h-[40px]",o&&"bg-gray-50"),placeholder:"Unit"})})}),e.jsx(x,{children:e.jsx(c,{name:`items.${s}.required_qty`,control:u,render:({field:r})=>e.jsx(h,{...r,type:"number",readOnly:!!o,className:S("mb-0 h-[40px]",o&&"bg-gray-50"),placeholder:"0"})})}),e.jsx(x,{children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:`text-sm font-medium ${d?"text-green-600":"text-gray-700"}`,children:a}),o&&e.jsxs("span",{className:"text-xs text-gray-500",children:["Remaining: ",i.toFixed(3)]})]})}),e.jsx(x,{children:e.jsx(c,{name:`items.${s}.issued_qty`,control:u,render:({field:r})=>e.jsx(h,{...r,type:"number",step:"0.001",readOnly:d,disabled:d,className:S("mb-0 h-[40px]",d&&"bg-gray-100 cursor-not-allowed text-gray-500"),placeholder:d?"Fulfilled":"0",max:i,title:d?"This item is fully fulfilled":`Maximum: ${i.toFixed(3)}`,onChange:j=>{const q=j.target.value;parseFloat(q)>i?(r.onChange(i.toString()),y.warning(`Cannot issue more than ${i.toFixed(3)} for ${l.item_name}`,{autoClose:3e3})):r.onChange(q)},onBlur:j=>{const q=j.target.value;parseFloat(q)>i&&r.onChange(i.toString())}})})}),e.jsx(x,{children:e.jsx("div",{className:"flex flex-col items-center",children:e.jsx("span",{className:`text-sm font-medium ${m<0?"text-red-600":m===0?"text-orange-600":"text-blue-600"}`,children:m.toFixed(3)})})}),e.jsx(x,{children:o&&e.jsx("div",{className:"flex justify-start",children:d?e.jsx("span",{className:"px-2 py-1 text-xs font-semibold text-green-800 bg-green-100 rounded-full",children:"Fulfilled"}):g>0?e.jsx("span",{className:"px-2 py-1 text-xs font-semibold text-yellow-800 bg-yellow-100 rounded-full",children:"Partial"}):e.jsx("span",{className:"px-2 py-1 text-xs font-semibold text-gray-800 bg-gray-100 rounded-full",children:"Pending"})})}),e.jsx(x,{children:e.jsx(ue,{children:!o&&e.jsx(ce,{onClick:()=>X(s)})})})]},t.id)})})]})})]})]})]})};export{Oe as default};
