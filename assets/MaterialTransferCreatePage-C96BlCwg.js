import{u as V,i as W,a as z,r as f,h as b,e as j,y as _,j as e,B as y,A as G}from"./index-jDfkN2r4.js";import{F as J}from"./FormHeader-rtnPN1Zb.js";import{T as K}from"./TextInput-BI1n9-MI.js";import{L as X}from"./ListWrapper-CdcYWlKR.js";import{T as Y}from"./TableActions-CJhLK9s8.js";import{T as Z,a as ee,b as p}from"./TableWrapper-BjLYclM7.js";import{T as te}from"./TableDelete-BoG9eQR7.js";import{u as re,b as ae,C as c}from"./index.esm-DafRD7gC.js";import{u as se}from"./useItemsStore-C3LUPxMY.js";import{L as ie}from"./Loading-QSf8-D6b.js";import{o as ne,n as le}from"./yup-Pctspe1l.js";import"./BackButton-DFo0oY_K.js";const g={mr_number:"",transfer_from:"",transfer_to:"",instruction_of:"",items:[{item_name:"",item_code:"",item_id:"",unit:"",actual_required_qty:"",transferred_qty:""}]},ye=()=>{const q=V(),[P]=W(),s=P.get("editId"),{selectedBranchId:$}=z(),{items:N,fetchItems:v}=se(),[x,F]=f.useState([]),A=!!s,I=re({defaultValues:g,mode:"onChange",resolver:ne(le)}),{control:o,reset:S,setValue:m,watch:T,handleSubmit:E,formState:{errors:u}}=I,{fields:L,append:k,remove:U}=ae({control:o,name:"items"}),[O,M]=f.useState(!1),[w,D]=f.useState(!1);f.useEffect(()=>{v(),B()},[v]);const B=async()=>{try{const r=await b.get(j.material_requisition.all),t=r.data?.data?.material_requisitions||r.data?.material_requisitions||[];F(t)}catch(r){console.error("Failed to fetch material requisitions",r)}},C=f.useCallback(async r=>{try{const t=x.find(l=>l.mr_number===r);if(!t)return;const a=await b.get(j.material_requisition.details(t.id)),n=a.data?.material_requisition||a.data?.data||a.data;if(n&&n.items&&n.items.length>0){const l=n.items.map(d=>({item_id:d.item?.id?.toString()||d.item_id?.toString()||"",item_name:d.item?.item_name||"",item_code:d.item?.item_code||"",unit:d.item?.unit?.unit_name||"",actual_required_qty:d.quantity_required?.toString()||d.quantity?.toString()||"",transferred_qty:""}));m("items",l),_.success(`Loaded ${l.length} items from Material Requisition ${r}`)}else m("items",g.items),_.info("No items found for the selected Material Requisition")}catch(t){console.error("Failed to fetch MR details:",t),_.error("Failed to load Material Requisition details")}},[x,m]),R=f.useCallback(async()=>{if(s){M(!0);try{const r=await b.get(j.material_transfer.details(Number(s))),t=r.data.transfer||r.data.data||r.data,a={mr_number:t.mr_number||t.mr||"",transfer_from:t.transfer_from||"",transfer_to:t.transfer_to||"",instruction_of:t.instruction_of||t.instruction||"",items:(t.items||[]).map(n=>({item_id:n.item_id?.toString()||"",item_code:n.item?.item_code||"",item_name:n.item?.item_name||"",unit:n.item?.unit?.unit_name||"",actual_required_qty:n.actual_required_qty?.toString()||"",transferred_qty:n.transferred_qty?.toString()||""}))};S(a)}catch(r){console.error("Failed to load details:",r),_.error("Failed to load material transfer details")}finally{M(!1)}}},[s,S]);f.useEffect(()=>{s&&R()},[s,R]);const i=T("mr_number");f.useEffect(()=>{i&&!s&&x.length>0?C(i):!i&&!s&&m("items",g.items)},[i,s,C,m]);const H=async r=>{D(!0);const t={mr:r.mr_number,branch_id:$,material_requisition_id:r.mr_number?x.find(a=>a.mr_number===r.mr_number)?.id:null,transfer_from:r.transfer_from,transfer_to:r.transfer_to,instruction_of:r.instruction_of,items:r.items.filter(a=>a.item_id&&a.transferred_qty).map(a=>({item_id:Number(a.item_id),actual_required_qty:Number(a.actual_required_qty)||0,transferred_qty:Number(a.transferred_qty)}))};try{const a=s?j.material_transfer.update(Number(s)):j.material_transfer.create;await(s?b.put:b.post)(a,t),_.success(s?"Material transfer updated successfully":"Material transfer created successfully"),q(G.MATERIAL_TRANSFER.LIST)}catch(a){console.error(a),_.error(a.response?.data?.message||"Failed to save material transfer")}finally{D(!1)}};return O?e.jsx("div",{className:"flex justify-center py-20",children:e.jsx(ie,{})}):e.jsxs("div",{className:"w-full h-full overflow-auto space-y-8 p-4 pb-20",children:[e.jsx("div",{className:"space-y-1 ml-2",children:e.jsx(J,{title:s?"Edit Material Transfer":"Create Material Transfer",subtitle:s?"Update the Material Transfer details":"Fill out the form to submit a new Material Transfer"})}),e.jsxs("div",{className:"grid grid-cols-2 gap-5 ml-2 mr-5",children:[e.jsx(c,{name:"transfer_from",control:o,render:({field:r})=>e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("label",{className:"font-medium",children:"Transfer From"}),e.jsxs("select",{...r,className:"border border-gray-300 rounded px-3 py-2",children:[e.jsx("option",{value:"",children:"Select Department"}),e.jsx("option",{value:"store",children:"Store Department"}),e.jsx("option",{value:"purchase",children:"Purchase Department"}),e.jsx("option",{value:"production",children:"Production Department"})]}),u.transfer_from&&e.jsx("p",{className:"text-red-500 text-sm",children:u.transfer_from.message})]})}),e.jsx(c,{name:"transfer_to",control:o,render:({field:r})=>e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("label",{className:"font-medium",children:"Transfer To"}),e.jsxs("select",{...r,className:`border rounded px-3 py-2 text-sm ${u.transfer_to?"border-red-500":"border-gray-300"}`,children:[e.jsx("option",{value:"",children:"Select Department"}),e.jsx("option",{value:"Store Department",children:"Store Department"}),e.jsx("option",{value:"Purchase Department",children:"Purchase Department"}),e.jsx("option",{value:"Production Department",children:"Production Department"})]}),u.transfer_to&&e.jsx("span",{className:"text-red-500 text-xs mt-1",children:u.transfer_to.message})]})}),e.jsx(c,{name:"mr_number",control:o,render:({field:r})=>e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-semibold text-gray-700 mb-1",children:"Material Requisition Number"}),e.jsxs("select",{...r,disabled:A,className:"w-full h-[45px] rounded-lg border border-gray-300 px-4 mt-1 text-sm",children:[e.jsx("option",{value:"",children:"Select Material Requisition"}),x.map(t=>e.jsxs("option",{value:t.mr_number,children:[t.mr_number," - ",t.department||"Unknown Dept"]},t.mr_number))]}),u.mr_number&&e.jsx("span",{className:"text-red-500 text-xs mt-1",children:u.mr_number.message})]})}),e.jsx(c,{name:"instruction_of",control:o,render:({field:r})=>e.jsx(K,{...r,label:"Instruction",error:u.instruction_of?.message,placeholder:"Enter any special instructions here"})})]}),e.jsxs(X,{title:"Items to Transfer",children:[i?e.jsx("div",{className:"flex justify-between items-center mb-2"}):e.jsx("div",{className:"flex justify-end mb-2",children:e.jsx(y,{className:"bg-red-600 text-white px-3 py-1",onClick:()=>k({item_name:"",item_code:"",item_id:"",unit:"",actual_required_qty:"",transferred_qty:""}),children:"+ Add Item"})}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(Z,{children:[e.jsx(ee,{cols:[{title:"Item Name"},{title:"Item Code"},{title:"Unit"},{title:"Actual Required Qty"},{title:"Transferred Qty"},{title:"Action"}]}),e.jsx("tbody",{children:L.map((r,t)=>e.jsxs("tr",{className:"align-middle",children:[e.jsx(p,{children:t+1}),e.jsx(p,{children:e.jsx(c,{name:`items.${t}.item_name`,control:o,render:({field:a})=>a.value&&i?e.jsx("input",{...a,readOnly:!0,className:"w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm bg-gray-50",placeholder:"Item Name"}):e.jsxs("select",{value:T(`items.${t}.item_code`)||"",className:"w-full h-[45px] rounded-lg border border-gray-300 px-3 mt-1 text-sm",onChange:l=>{const d=l.target.value,h=N.find(Q=>Q.item_code===d);h&&(m(`items.${t}.item_name`,h.item_name),m(`items.${t}.item_code`,h.item_code),m(`items.${t}.unit`,h.unit?.unit_name||""),m(`items.${t}.item_id`,h.id))},children:[e.jsx("option",{value:"",children:"Select Item"}),N.map(l=>e.jsxs("option",{value:l.item_code,children:[l.item_name," (",l.item_code,")"]},l.id))]})})}),e.jsx(p,{children:e.jsx(c,{name:`items.${t}.item_code`,control:o,render:({field:a})=>e.jsx("input",{...a,readOnly:!!i,className:`w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm ${i?"bg-gray-50":""}`,placeholder:"Code"})})}),e.jsx(p,{children:e.jsx(c,{name:`items.${t}.unit`,control:o,render:({field:a})=>e.jsx("input",{...a,readOnly:!!i,className:`w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm ${i?"bg-gray-50":""}`,placeholder:"Unit"})})}),e.jsx(p,{children:e.jsx(c,{name:`items.${t}.actual_required_qty`,control:o,render:({field:a})=>e.jsx("input",{...a,type:"number",readOnly:!!i,className:`w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm ${i?"bg-gray-50":""}`,placeholder:"0"})})}),e.jsx(p,{children:e.jsx(c,{name:`items.${t}.transferred_qty`,control:o,render:({field:a})=>e.jsx("input",{...a,type:"number",className:"w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm",placeholder:"0"})})}),e.jsx(p,{children:e.jsx(Y,{children:!i&&e.jsx(te,{onClick:()=>U(t)})})})]},r.id))})]})})]}),e.jsxs("div",{className:"flex justify-end gap-3 mr-5",children:[e.jsx(y,{variant:"outline",onClick:()=>q(-1),children:"Cancel"}),e.jsx(y,{className:"bg-red-600 text-white",onClick:E(H),loading:w,disabled:w,children:s?"Update Material Transfer":"Submit Material Transfer"})]})]})};export{ye as default};
