import{u as V,b as W,r as _,a as Y,a4 as v,a5 as z,f as J,j as e,B as N,h as y,e as f,y as x,A as $}from"./index-CRQb4Yqg.js";import{T as m}from"./TextInput-CzX_TrPD.js";import{S as j}from"./Select-CnXyV_N3.js";import{S as K}from"./SearchableSelect-Cb8Eg5jM.js";import{T as X}from"./TableActions-0FNBzKkW.js";import{T as u}from"./TableData-CkLqvJ1i.js";import{T as Z}from"./TableDelete-D7zkuIZO.js";import{T as ee,a as te}from"./TableWrapper-C6CZttTh.js";import{T as se}from"./TableRow-wtH-nwdU.js";import{u as re,b as ae,C as i}from"./index.esm-WRMWCj7W.js";import{u as ie}from"./useItemsStore-Cp1yXBzI.js";import{u as ne}from"./useMachineStore-ObrXcFLs.js";import{u as le}from"./useBranchStore-C0BC-4A9.js";import{F as oe}from"./FormHeader-Bu48ZAf1.js";import{o as me,m as ce}from"./yup-DTrWT5lm.js";import{I as de}from"./ItemSelect-BGQIYTmP.js";import"./BackButton-BvQEtBeB.js";const ue={department_from:"",department_to:"Store Department",required_date:"",priority:"Normal",branch_id:null,purpose:"",Note:"",project_use:"",project_note:"",machine_use:"",machine_note:"",site_use:"",site_note:"",general_use:"",general_note:"",inspection:"",items:[{item_id:0,item_name:"",item_code:"",item_unit:"",item_description:"",req_qty:0,balance_quantity:0,remark:"",max_stock_level:0}]},Ee=()=>{const q=V(),[S]=W(),c=S.get("id")?Number(S.get("id")):void 0,[,w]=_.useState(!1),[R,k]=_.useState(!1),[g,P]=_.useState(null),{selectedBranchId:h,user:T}=Y(),U=T?.id,{control:r,handleSubmit:F,formState:{errors:l},setValue:o,reset:B}=re({defaultValues:ue,resolver:me(ce)}),{fields:C,append:L,remove:D}=ae({control:r,name:"items"}),{items:E,fetchItems:b}=ie(),{machines:O,fetchMachines:M}=ne(),{branches:A,fetchBranches:I}=le(),p=T?.role;_.useEffect(()=>{b(),M(),I()},[b,M,I]),_.useEffect(()=>{!p?.role_name||c||(v(p?.role_name)?o("department_from","Store Department"):(z(p?.role_name)||J(p?.role_name))&&o("department_from","Production Department"))},[p?.role_name,o,c]),_.useEffect(()=>{h!==null&&o("branch_id",h)},[h,o]);const H=async()=>{if(c){w(!0);try{const t=(await y.get(f.material_requisition.details(c))).data.material_requisition;console.log("data",t);const a=n=>n?new Date(n).toISOString().split("T")[0]:"";if(!t){console.error("No data found in API response"),x.error("No data found for this material request");return}P(t);const d={department_from:t.department||"Production Department",department_to:"Store Department",purpose:t.remarks||"",required_date:a(t.required_by_date||""),priority:t.priority||"Normal",branch_id:t.branch_id||null,Note:t.general_note||"",project_use:t.project_use||"",project_note:t.project_note||"",machine_use:t.machine_use?String(t.machine_use):"",machine_note:t.machine_note||"",site_use:t.site_use?typeof t.site_use=="object"?String(t.site_use.id):String(t.site_use):"",site_note:t.site_note||"",general_use:t.general_use||"",general_note:t.general_note||"",inspection:t.inspection!==void 0?String(t.inspection):"",items:t.items&&t.items.length>0?t.items.map(n=>({item_id:n.item_id||0,item_name:n.item?.item_name||"",item_code:n.item?.item_code||"",item_unit:n.item?.unit?.unit_name||"",item_description:n.item?.description||"",req_qty:Number(n.quantity_required||0),remark:n.remarks||"",max_stock_level:n.item?.current_stock||0,stock:n.item?.balance_quantity||0})):[{item_id:0,item_name:"",item_code:"",item_unit:"",item_description:"",req_qty:0,stock:0,remark:"",max_stock_level:0}]};console.log("Resetting form with data:",d),B(d)}catch(s){console.error("Error loading request details:",s),x.error("Failed to load material request details")}finally{w(!1)}}};_.useEffect(()=>{if(c){if(E.length===0){b();return}H()}},[c,E.length]);const Q=async s=>{k(!0);try{const t={department:s.department_from,required_by_date:s.required_date,created_by:U,priority:s.priority,remarks:s.purpose||"",project_use:s.project_use||null,project_note:s.project_note||null,machine_use:s.machine_use?Number(s.machine_use):null,machine_note:s.machine_note||null,site_use:s.site_use?Number(s.site_use):null,site_note:s.site_note||null,general_use:s.general_use||null,general_note:s.general_note||null,branch_id:s.branch_id,inspection:s.inspection,items:s.items.map(n=>({item_id:Number(n.item_id),quantity_required:Number(n.req_qty),specification:n.item_unit,remarks:n.remark||""}))},a=c?f.material_requisition.update(c):f.material_requisition.create;await(c?y.put:y.post)(a,t),x.success(c?"Material Request Updated Successfully":"Material Request Created Successfully"),q($.MATERIAL_REQUEST.LIST)}catch(t){console.error("Error:",t),x.error(t.response?.data?.message||"Failed to save material request")}finally{k(!1)}},G=()=>{q($.MATERIAL_REQUEST.LIST)};return e.jsx("div",{className:"w-full min-h-screen bg-gray-50 p-4",children:e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsx(oe,{title:"Material Requisition Form",subtitle:"Provide department details and list every item you need in this request."}),e.jsxs("form",{onSubmit:F(Q),className:"space-y-8 mt-8",children:[e.jsxs("section",{className:"bg-white rounded-lg shadow-sm p-4 sm:p-6 space-y-6",children:[e.jsxs("div",{className:"border-b border-gray-200 pb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Request Details"}),e.jsx("div",{className:"text-sm font-semibold text-gray-700 mt-2",children:e.jsx("p",{children:"Please fill atleast one pair among Project use/Machine use/Site use/General use/Note"})})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 sm:gap-6 sm:grid-cols-2 lg:grid-cols-3",children:[c&&g&&e.jsx("div",{className:"col-span-full",children:e.jsxs("div",{className:"bg-gray-50 border border-gray-200 rounded p-3",children:[e.jsx("h4",{className:"font-semibold text-gray-800 mb-2",children:"Material Request Details"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("p",{className:"text-sm text-gray-700",children:[e.jsx("strong",{children:"MR Number:"})," ",g.mr_number||"N/A"]}),e.jsxs("p",{className:"text-sm text-gray-700",children:[e.jsx("strong",{children:"Department:"})," ",g.department||"N/A"]}),e.jsxs("p",{className:"text-sm text-gray-700",children:[e.jsx("strong",{children:"Status:"})," ",g.status||"N/A"]})]})]})}),e.jsx(i,{name:"department_from",control:r,render:({field:s})=>e.jsx(m,{...s,label:"Department From",required:!0,error:l.department_from?.message})}),e.jsx(i,{name:"department_to",control:r,render:({field:s})=>e.jsx(m,{...s,label:"Department To",required:!0,readOnly:!0,className:"bg-gray-50"})}),e.jsx(i,{name:"required_date",control:r,render:({field:s})=>e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx(m,{...s,type:"date",label:"Required Date",required:!0,error:l.required_date?.message}),l.required_date&&e.jsx("span",{className:"text-xs text-red-600 mt-1",children:l.required_date?.message})]})}),e.jsx(i,{name:"priority",control:r,render:({field:s})=>e.jsxs(j,{...s,label:"Priority",required:!0,error:l.priority?.message,children:[e.jsx("option",{value:"Urgent",children:"High"}),e.jsx("option",{value:"Emergency",children:"Medium"}),e.jsx("option",{value:"Normal",children:"Low"})]})}),e.jsx(i,{name:"branch_id",control:r,render:({field:s})=>e.jsxs(j,{...s,label:"Branch",required:!0,disabled:h!==null,error:l.branch_id?.message,value:s.value||"",onChange:t=>s.onChange(Number(t.target.value)),className:h!==null?"bg-gray-100":"",children:[e.jsx("option",{value:"",children:"Select Branch"}),A.map(t=>e.jsx("option",{value:t.id,children:t.branch_name},t.id))]})}),e.jsx(i,{name:"inspection",control:r,render:({field:s})=>e.jsxs(j,{...s,required:!0,label:"Inspection",value:s.value===void 0?"":String(s.value),onChange:t=>s.onChange(t.target.value==="true"),children:[e.jsx("option",{value:"",children:"Select"}),e.jsx("option",{value:"true",children:"Yes"}),e.jsx("option",{value:"false",children:"No"})]})}),e.jsx("div",{className:"col-span-full",children:e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsx(i,{name:"project_use",control:r,render:({field:s})=>e.jsx(m,{...s,value:s.value??"",label:"Project Use",error:l?.project_use?.message,placeholder:"Enter project details"})}),e.jsx(i,{name:"project_note",control:r,render:({field:s})=>e.jsx(m,{...s,value:s.value??"",label:"Project Note",error:l?.project_note?.message,placeholder:"Enter project note"})})]})}),e.jsx("div",{className:"col-span-full",children:e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsx(i,{name:"machine_use",control:r,render:({field:s})=>e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("label",{className:"text-sm font-semibold text-gray-700",children:"Machine Use"}),e.jsx(K,{value:s.value?Number(s.value):void 0,onChange:t=>s.onChange(String(t)),options:O.map(t=>({value:Number(t.id),label:t.name})),placeholder:"Select Machine",error:l?.machine_use?.message})]})}),e.jsx(i,{name:"machine_note",control:r,render:({field:s})=>e.jsx(m,{...s,value:s.value??"",label:"Machine Note",error:l?.machine_note?.message,placeholder:"Enter machine note"})})]})}),e.jsx("div",{className:"col-span-full",children:e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsx(i,{name:"site_use",control:r,render:({field:s})=>e.jsxs(j,{...s,value:s.value??"",label:"Site Use",error:l?.site_use?.message,children:[e.jsx("option",{value:"",children:"Select Branch"}),A.map(t=>e.jsx("option",{value:t.id,children:t.branch_name},t.id))]})}),e.jsx(i,{name:"site_note",control:r,render:({field:s})=>e.jsx(m,{...s,value:s.value??"",label:"Site Note",error:l?.site_note?.message,placeholder:"Enter site note"})})]})}),e.jsx("div",{className:"col-span-full",children:e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsx(i,{name:"general_use",control:r,render:({field:s})=>e.jsx(m,{...s,value:s.value??"",label:"General Use",error:l?.general_use?.message,placeholder:"Enter general use details"})}),e.jsx(i,{name:"general_note",control:r,render:({field:s})=>e.jsx(m,{...s,value:s.value??"",label:"General Note",error:l?.general_note?.message,placeholder:"Enter general note"})})]})})]})]}),e.jsxs("section",{className:"bg-white rounded-lg shadow-sm p-4 sm:p-6 space-y-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsx("div",{children:e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Items Requested"})}),e.jsx(N,{className:"bg-red-600 text-white px-4 py-2 w-full sm:w-auto",onClick:()=>L({item_id:0,item_name:"",item_code:"",item_unit:"",item_description:"",req_qty:0,balance_quantity:0,remark:"",max_stock_level:0}),children:"+Add Item"})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(ee,{children:[e.jsx(te,{cols:[{title:"Item Name"},{title:"Item Code"},{title:"Item Description"},{title:"Item Unit"},{title:"Req Qty"},...v(p?.role_name)?[{title:"Stock In Store"}]:[],{title:"Remark"},{title:"Actions"}]}),e.jsx("tbody",{children:C.map((s,t)=>e.jsxs(se,{children:[e.jsx(u,{className:"w-12 text-center font-medium",children:t+1}),e.jsx(u,{className:"w-64 relative",children:e.jsx(de,{control:r,name:`items.${t}.item_id`,disabled:!1,error:l.items?.[t]?.item_id?.message,onChange:(a,d)=>{if(!d){o(`items.${t}.item_code`,""),o(`items.${t}.item_name`,""),o(`items.${t}.item_unit`,""),o(`items.${t}.item_description`,""),o(`items.${t}.balance_quantity`,0);return}o(`items.${t}.item_code`,d.item_code??""),o(`items.${t}.item_name`,d.item_name??""),o(`items.${t}.item_unit`,d.unit?.unit_name??""),o(`items.${t}.item_description`,d.description??""),o(`items.${t}.balance_quantity`,Number(d.balance_quantity??0))}})}),e.jsx(u,{className:"w-32",children:e.jsx(i,{name:`items.${t}.item_code`,control:r,render:({field:a})=>e.jsx(m,{...a,className:"mb-0 h-[45px] bg-gray-50 font-mono",placeholder:"Code",readOnly:!0})})}),e.jsx(u,{className:"w-40",children:e.jsx(i,{name:`items.${t}.item_description`,control:r,render:({field:a})=>e.jsx(m,{...a,className:"mb-0 h-[45px] bg-gray-50",placeholder:"Description",readOnly:!0})})}),e.jsx(u,{className:"w-24",children:e.jsx(i,{name:`items.${t}.item_unit`,control:r,render:({field:a})=>e.jsx(m,{...a,className:"mb-0 h-[45px] bg-gray-50",placeholder:"Unit",readOnly:!0})})}),e.jsx(u,{className:"w-24",children:e.jsx(i,{name:`items.${t}.req_qty`,control:r,render:({field:a})=>e.jsx(m,{...a,className:"mb-0 h-[45px]",placeholder:"Qty",type:"number",min:"1",onFocus:()=>{a.value===0&&a.onChange("")}})})}),v(p?.role_name)&&e.jsx(u,{className:"w-28",children:e.jsx(i,{name:`items.${t}.balance_quantity`,control:r,render:({field:a})=>e.jsx(m,{...a,className:"mb-0 h-[45px] bg-gray-50",value:a.value??"",placeholder:"Stock",type:"number",readOnly:!0})})}),e.jsx(u,{className:"w-40",children:e.jsx(i,{name:`items.${t}.remark`,control:r,render:({field:a})=>e.jsx(m,{...a,className:"mb-0 h-[45px]",value:a.value??"",placeholder:"Remark"})})}),e.jsx(u,{className:"w-16",children:e.jsx(X,{children:e.jsx(Z,{onClick:()=>{C.length>1&&D(t)}})})})]},s.id))})]})})]}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx(N,{variant:"outline",type:"button",onClick:G,children:"Cancel"}),e.jsx(N,{className:"bg-red-600 text-white",type:"submit",loading:R,disabled:R,children:c?"Update Material Request":"Submit Material Request"})]})]})]})})};export{Ee as default};
