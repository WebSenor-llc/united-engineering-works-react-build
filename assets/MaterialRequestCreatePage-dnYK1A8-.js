import{u as W,i as Y,r as _,a as z,j as e,B as f,h as N,e as y,y as h,A}from"./index-DQLLPGln.js";import{T as d}from"./TextInput-BPUrDGK5.js";import{S as g}from"./Select-BHdS60jG.js";import{T as J}from"./TableActions-BtqL2JIQ.js";import{T as K,a as X,b as m}from"./TableWrapper-dhiQGSew.js";import{T as Z}from"./TableDelete-DNYHMsVC.js";import{T as ee}from"./TableRow-BJ6MC2zs.js";import{u as te,b as re,C as i}from"./index.esm-wpl3r5_B.js";import{u as se}from"./useItemsStore-CKnaVHV5.js";import{u as ae}from"./useMachineStore-DfkXaf7g.js";import{u as ne}from"./useBranchStore-BK4kK2m_.js";import{F as ie}from"./FormHeader-QrKZYlW6.js";import{o as le,m as oe}from"./yup-BlqvSa7I.js";import{I as ce}from"./ItemSelect-CyE057zX.js";import{a as v,b as me,c as de}from"./rolePermissions-DshASey1.js";import"./BackButton-Cz3v4pmP.js";import"./SearchableSelect-f2xAmRxr.js";const ue={department_from:"",department_to:"Store Department",required_date:"",priority:"Normal",purpose:"",Note:"",project_use:"",project_note:"",machine_use:"",machine_note:"",site_use:"",site_note:"",general_use:"",general_note:"",inspection:"",items:[{item_id:0,item_name:"",item_code:"",item_unit:"",item_description:"",req_qty:0,stock:0,remark:"",max_stock_level:0}]},pe="w-full h-10 rounded-md border border-gray-300 px-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white",Ee=()=>{const q=W(),[S]=Y(),l=S.get("id")?Number(S.get("id")):void 0,[,w]=_.useState(!1),[k,R]=_.useState(!1),[x,P]=_.useState(null),{selectedBranchId:$,user:I}=z(),U=I?.id,{control:a,handleSubmit:F,formState:{errors:o},setValue:c,reset:D}=te({defaultValues:ue,resolver:le(oe)}),{fields:T,append:L,remove:O}=re({control:a,name:"items"}),{items:j,fetchItems:b}=se(),{machines:B,fetchMachines:E}=ae(),{branches:H,fetchBranches:C}=ne(),u=I?.role;_.useEffect(()=>{b(),E(),C()},[b,E,C]),_.useEffect(()=>{!u?.role_name||l||(v(u?.role_name)?c("department_from","Store Department"):(me(u?.role_name)||de(u?.role_name))&&c("department_from","Production Department"))},[u?.role_name,c,l]);const Q=async()=>{if(l){w(!0);try{const r=(await N.get(y.material_requisition.details(l))).data.material_requisition;console.log("data",r);const n=s=>s?new Date(s).toISOString().split("T")[0]:"";if(!r){console.error("No data found in API response"),h.error("No data found for this material request");return}P(r);const p={department_from:r.department||"Production Department",department_to:"Store Department",purpose:r.remarks||"",required_date:n(r.required_by_date||""),priority:r.priority||"Normal",Note:r.general_note||"",project_use:r.project_use||"",project_note:r.project_note||"",machine_use:r.machine_use?String(r.machine_use):"",machine_note:r.machine_note||"",site_use:r.site_use?.id?String(r.site_use.id):"",site_note:r.site_note||"",general_use:r.general_use||"",general_note:r.general_note||"",inspection:r.inspection!==void 0?String(r.inspection):"",items:r.items&&r.items.length>0?r.items.map(s=>({item_id:s.item_id||0,item_name:s.item?.item_name||"",item_code:s.item?.item_code||"",item_unit:s.item?.unit?.unit_name||"",item_description:s.item?.description||"",req_qty:Number(s.quantity_required||0),remark:s.remarks||"",max_stock_level:s.item?.current_stock||0,stock:s.item?.current_stock||0})):[{item_id:0,item_name:"",item_code:"",item_unit:"",item_description:"",req_qty:0,stock:0,remark:"",max_stock_level:0}]};console.log("Resetting form with data:",p),D(p)}catch(t){console.error("Error loading request details:",t),h.error("Failed to load material request details")}finally{w(!1)}}};_.useEffect(()=>{if(l){if(j.length===0){b();return}Q()}},[l,j.length]);const G=async t=>{R(!0);try{const r={department:t.department_from,required_by_date:t.required_date,created_by:U,priority:t.priority,remarks:t.purpose||"",project_use:t.project_use||null,project_note:t.project_note||null,machine_use:t.machine_use?Number(t.machine_use):null,machine_note:t.machine_note||null,site_use:t.site_use?Number(t.site_use):null,site_note:t.site_note||null,general_use:t.general_use||null,general_note:t.general_note||null,branch_id:$,inspection:t.inspection,items:t.items.map(s=>({item_id:Number(s.item_id),quantity_required:Number(s.req_qty),specification:s.item_unit,remarks:s.remark||""}))},n=l?y.material_requisition.update(l):y.material_requisition.create;await(l?N.put:N.post)(n,r),h.success(l?"Material Request Updated Successfully":"Material Request Created Successfully"),q(A.MATERIAL_REQUEST.LIST)}catch(r){console.error("Error:",r),h.error(r.response?.data?.message||"Failed to save material request")}finally{R(!1)}},V=()=>{q(A.MATERIAL_REQUEST.LIST)};return e.jsx("div",{className:"w-full min-h-screen bg-gray-50 p-4",children:e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsx(ie,{title:"Material Requisition Form",subtitle:"Provide department details and list every item you need in this request."}),e.jsxs("form",{onSubmit:F(G),className:"space-y-8 mt-8",children:[e.jsxs("section",{className:"bg-white rounded-lg shadow-sm p-4 sm:p-6 space-y-6",children:[e.jsxs("div",{className:"border-b border-gray-200 pb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Request Details"}),e.jsx("div",{className:"text-sm font-semibold text-gray-700 mt-2",children:e.jsx("p",{children:"Please fill atleast one pair among Project use/Machine use/Site use/General use/Note"})})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 sm:gap-6 sm:grid-cols-2 lg:grid-cols-3",children:[l&&x&&e.jsx("div",{className:"col-span-full",children:e.jsxs("div",{className:"bg-gray-50 border border-gray-200 rounded p-3",children:[e.jsx("h4",{className:"font-semibold text-gray-800 mb-2",children:"Material Request Details"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("p",{className:"text-sm text-gray-700",children:[e.jsx("strong",{children:"MR Number:"})," ",x.mr_number||"N/A"]}),e.jsxs("p",{className:"text-sm text-gray-700",children:[e.jsx("strong",{children:"Department:"})," ",x.department||"N/A"]}),e.jsxs("p",{className:"text-sm text-gray-700",children:[e.jsx("strong",{children:"Status:"})," ",x.status||"N/A"]})]})]})}),e.jsx(i,{name:"department_from",control:a,render:({field:t})=>e.jsx(d,{...t,label:"Department From",required:!0,readOnly:!0,className:"bg-gray-50",error:o.department_from?.message})}),e.jsx(i,{name:"department_to",control:a,render:({field:t})=>e.jsx(d,{...t,label:"Department To",required:!0,readOnly:!0,className:"bg-gray-50"})}),e.jsx(i,{name:"required_date",control:a,render:({field:t})=>e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs("label",{className:"text-sm font-semibold text-gray-700",children:["Required Date ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{...t,type:"date",className:pe}),o.required_date&&e.jsx("span",{className:"text-xs text-red-600 mt-1",children:o.required_date?.message})]})}),e.jsx(i,{name:"priority",control:a,render:({field:t})=>e.jsxs(g,{...t,label:"Priority",required:!0,error:o.priority?.message,children:[e.jsx("option",{value:"Urgent",children:"High"}),e.jsx("option",{value:"Emergency",children:"Medium"}),e.jsx("option",{value:"Normal",children:"Low"})]})}),e.jsx(i,{name:"inspection",control:a,render:({field:t})=>e.jsxs(g,{...t,required:!0,label:"Inspection",value:t.value===void 0?"":String(t.value),onChange:r=>t.onChange(r.target.value==="true"),children:[e.jsx("option",{value:"",children:"Select"}),e.jsx("option",{value:"true",children:"Yes"}),e.jsx("option",{value:"false",children:"No"})]})}),e.jsx("div",{className:"col-span-full",children:e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsx(i,{name:"project_use",control:a,render:({field:t})=>e.jsx(d,{...t,value:t.value??"",label:"Project Use",error:o?.project_use?.message,placeholder:"Enter project details"})}),e.jsx(i,{name:"project_note",control:a,render:({field:t})=>e.jsx(d,{...t,value:t.value??"",label:"Project Note",error:o?.project_note?.message,placeholder:"Enter project note"})})]})}),e.jsx("div",{className:"col-span-full",children:e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsx(i,{name:"machine_use",control:a,render:({field:t})=>e.jsxs(g,{...t,value:t.value??"",label:"Machine Use",error:o?.machine_use?.message,children:[e.jsx("option",{value:"",children:"Select Machine"}),B.map(r=>e.jsx("option",{value:r.id,children:r.name},r.id))]})}),e.jsx(i,{name:"machine_note",control:a,render:({field:t})=>e.jsx(d,{...t,value:t.value??"",label:"Machine Note",error:o?.machine_note?.message,placeholder:"Enter machine note"})})]})}),e.jsx("div",{className:"col-span-full",children:e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsx(i,{name:"site_use",control:a,render:({field:t})=>e.jsxs(g,{...t,value:t.value??"",label:"Site Use",error:o?.site_use?.message,children:[e.jsx("option",{value:"",children:"Select Branch"}),H.map(r=>e.jsx("option",{value:r.id,children:r.branch_name},r.id))]})}),e.jsx(i,{name:"site_note",control:a,render:({field:t})=>e.jsx(d,{...t,value:t.value??"",label:"Site Note",error:o?.site_note?.message,placeholder:"Enter site note"})})]})}),e.jsx("div",{className:"col-span-full",children:e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsx(i,{name:"general_use",control:a,render:({field:t})=>e.jsx(d,{...t,value:t.value??"",label:"General Use",error:o?.general_use?.message,placeholder:"Enter general use details"})}),e.jsx(i,{name:"general_note",control:a,render:({field:t})=>e.jsx(d,{...t,value:t.value??"",label:"General Note",error:o?.general_note?.message,placeholder:"Enter general note"})})]})})]})]}),e.jsxs("section",{className:"bg-white rounded-lg shadow-sm p-4 sm:p-6 space-y-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsx("div",{children:e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Items Requested"})}),e.jsx(f,{className:"bg-red-600 text-white px-4 py-2 w-full sm:w-auto",onClick:()=>L({item_id:0,item_name:"",item_code:"",item_unit:"",item_description:"",req_qty:0,stock:0,remark:"",max_stock_level:0}),children:"+Add Item"})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(K,{children:[e.jsx(X,{cols:[{title:"Item Name"},{title:"Item Code"},{title:"Item Description"},{title:"Item Unit"},{title:"Req Qty"},...v(u?.role_name)?[{title:"Stock In Store"}]:[],{title:"Remark"},{title:"Actions"}]}),e.jsx("tbody",{children:T.map((t,r)=>e.jsxs(ee,{children:[e.jsx(m,{className:"w-12 text-center font-medium",children:r+1}),e.jsx(m,{className:"w-64 relative",children:e.jsx(i,{name:`items.${r}.item_id`,control:a,render:({field:n})=>e.jsx(ce,{control:a,name:`items.${r}.item_id`,disabled:!1,onChange:p=>{n.onChange(p);const s=j.find(M=>M.id===p);s&&(c(`items.${r}.item_id`,s.id),c(`items.${r}.item_code`,s.item_code),c(`items.${r}.item_name`,s.item_name),c(`items.${r}.item_unit`,s.unit?.unit_name||""),c(`items.${r}.item_description`,s.description||""),c(`items.${r}.stock`,Number(s.current_stock??0)))}})})}),e.jsx(m,{className:"w-32",children:e.jsx(i,{name:`items.${r}.item_code`,control:a,render:({field:n})=>e.jsx("input",{...n,className:"w-full h-[45px] border border-gray-300 rounded-lg px-3 text-sm bg-gray-50 font-mono",placeholder:"Code",readOnly:!0})})}),e.jsx(m,{className:"w-40",children:e.jsx(i,{name:`items.${r}.item_description`,control:a,render:({field:n})=>e.jsx("input",{...n,className:"w-full h-[45px] border border-gray-300 rounded-lg px-3 text-sm bg-gray-50",placeholder:"Description",readOnly:!0})})}),e.jsx(m,{className:"w-24",children:e.jsx(i,{name:`items.${r}.item_unit`,control:a,render:({field:n})=>e.jsx("input",{...n,className:"w-full h-[45px] border border-gray-300 rounded-lg px-3 text-sm bg-gray-50 text-center",placeholder:"Unit",readOnly:!0})})}),e.jsx(m,{className:"w-24",children:e.jsx(i,{name:`items.${r}.req_qty`,control:a,render:({field:n})=>e.jsx("input",{...n,className:"w-full h-[45px] border border-gray-300 rounded-lg px-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-center",placeholder:"Qty",type:"number",min:"1",onFocus:()=>{n.value===0&&n.onChange("")}})})}),v(u?.role_name)&&e.jsx(m,{className:"w-28",children:e.jsx(i,{name:`items.${r}.stock`,control:a,render:({field:n})=>e.jsx("input",{...n,className:`w-full h-[45px] border border-gray-300 rounded-lg px-3 text-sm\r
                     focus:outline-none focus:ring-2 focus:ring-blue-500\r
                     focus:border-blue-500 text-center`,value:n.value??"",placeholder:"Stock",type:"number",readOnly:!0})})}),e.jsx(m,{className:"w-40",children:e.jsx(i,{name:`items.${r}.remark`,control:a,render:({field:n})=>e.jsx("input",{...n,className:"w-full h-[45px] border border-gray-300 rounded-lg px-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",value:n.value??"",placeholder:"Remark"})})}),e.jsx(m,{className:"w-16",children:e.jsx(J,{children:e.jsx(Z,{onClick:()=>{T.length>1&&O(r)}})})})]},t.id))})]})})]}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx(f,{variant:"outline",type:"button",onClick:V,children:"Cancel"}),e.jsx(f,{className:"bg-red-600 text-white",type:"submit",loading:k,disabled:k,children:l?"Update Material Request":"Submit Material Request"})]})]})]})})};export{Ee as default};
