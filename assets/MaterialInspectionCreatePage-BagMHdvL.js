import{u as X,i as Y,a as Z,r as u,j as e,B as G,h as f,e as j,y as g,A as w}from"./index-C1K7pf_x.js";import{F as ee}from"./FormHeader-BZP_citL.js";import{T as q}from"./TextInput-k6ei2VeJ.js";import{L as te}from"./ListWrapper-Dh0A8ncV.js";import{T as re}from"./TableActions-BXo33jLE.js";import{T as ae,a as ne,b as d}from"./TableWrapper-DsVaOnkl.js";import{T as se}from"./TableDelete-ByO5Nix7.js";import{u as ie,b as le,C as o}from"./index.esm-DiLaVBJl.js";import{u as oe}from"./useItemsStore-Dayqk0vg.js";import{L as ce}from"./Loading-CCwfYO4Q.js";import"./BackButton-B2Rfagm-.js";const y={department_from:"Store Department",department_to:"",grn_number:"",grn_date:"",ms:"",items:[{item_id:"",item_code:"",description_of_goods:"",unit:"",qty:"",thick_bl:"",length_bl:"",width_bl:"",thick_actual:"",length_actual:"",width_actual:"",accepted_quantity:"",rejected_quantity:"",reason_if_reject:"",remark:""}]},ye=()=>{const x=X(),[T]=Y(),p=T.get("id"),l=T.get("grnId"),{selectedBranchId:F}=Z(),[L,$]=u.useState(!1),[B,N]=u.useState(!1),k=u.useRef(null),{control:i,handleSubmit:W,setValue:m,watch:U,reset:E}=ie({defaultValues:y}),[R,M]=u.useState([]),[S,P]=u.useState(!1),[A,v]=u.useState(null),{items:C,loading:V,fetchItems:D}=oe(),{fields:H,append:Q}=le({control:i,name:"items"}),z=async()=>{P(!0);try{const s=await f.get(j.grn.pendingInspection);M(s.data?.grns||[])}catch(s){console.error("Error fetching GRNs for inspection:",s),M([])}finally{P(!1)}};u.useEffect(()=>{D(),z()},[D]),u.useEffect(()=>{if(!p)return;(async()=>{N(!0);try{const r=await f.get(j.material_inspection_report.details(parseInt(p,10))),t=r.data?.report||r.data?.data||r.data,n=(t.items||[]).map(a=>({item_id:a.item_id?.toString()||"",item_code:a.item?.item_code||"",description_of_goods:a.item?.item_name||"",unit:a.item?.unit?.unit_name||"",qty:a.quantity?.toString()||"",thick_bl:a.bill_thick?.toString()||"",length_bl:a.bill_length?.toString()||"",width_bl:a.bill_width?.toString()||"",thick_actual:a.actual_req_thick?.toString()||"",length_actual:a.actual_req_length?.toString()||"",width_actual:a.actual_req_width?.toString()||"",accepted_quantity:a.accepted_quantity?.toString()||"",rejected_quantity:a.rejected_quantity?.toString()||"",reason_if_reject:a.reject_reason||"",remark:""}));E({department_from:t.from_department||y.department_from,department_to:t.to_department||y.department_to,grn_number:t.grn_number||"",grn_date:"",ms:t.ms||"",items:n.length>0?n:y.items})}catch(r){console.error(r),g.error("Failed to load inspection report details"),x(w.MATERIAL_INSPECTION_REPORT.LIST)}finally{N(!1)}})()},[p,E,x]),u.useEffect(()=>{if(!l)return;(async()=>{N(!0);try{const r=await f.get(j.grn.details(parseInt(l,10))),t=r.data?.grn||r.data?.data||r.data;if(!t){g.error("GRN not found"),x(w.GOOD_RECEIVE_REPORT.LIST);return}v(t);const n=a=>{if(!a)return"";const[c]=a.split("T"),[b,I,K]=c.split("-");return`${K}-${I}-${b}`};if(m("grn_number",t.grn_number||""),m("grn_date",n(t.grn_date||"")),m("ms",t.vendor?.party_name||""),t.items?.length){const a=t.items.map(c=>({item_id:c.item_id?.toString()||"",item_code:c.item?.item_code||"",description_of_goods:c.item?.item_name||"",unit:c.item?.unit?.unit_name||"PCS",qty:c.quantity_received?.toString()||"",thick_bl:"",length_bl:"",width_bl:"",thick_actual:"",length_actual:"",width_actual:"",accepted_quantity:c.quantity_received?.toString()||"",rejected_quantity:"0",reason_if_reject:c.inspection_remarks||"",remark:c.remarks||""}));m("items",a)}}catch(r){console.error(r),g.error("Failed to load GRN details"),x(w.GOOD_RECEIVE_REPORT.LIST)}finally{N(!1)}})()},[l,m,x]);const _=u.useMemo(()=>l?[]:R.filter(s=>s.status==="pending_inspection"),[R,l]);u.useEffect(()=>{R.length===0&&console.log("No GRNs available for inspection")},[R.length,_.length,l]);const h=U("grn_number"),O=u.useCallback(s=>{if(!s){k.current=null,v(null),m("items",y.items);return}if(k.current===s||_.length===0)return;const r=_.find(n=>n.grn_number===s);if(!r)return;if(k.current=s,v(r),m("grn_date",(n=>{if(!n)return"";const[a]=n.split("T"),[c,b,I]=a.split("-");return`${I}-${b}-${c}`})(r.grn_date)),m("ms",r.vendor?.party_name||""),r.items?.length){const n=r.items.map(a=>({item_id:a.item_id?.toString()||"",item_code:a.item?.item_code||"",description_of_goods:a.item?.item_name||"",unit:a.item?.unit?.unit_name||"PCS",qty:a.quantity_received?.toString()||"",thick_bl:"",length_bl:"",width_bl:"",thick_actual:"",length_actual:"",width_actual:"",accepted_quantity:a.quantity_received?.toString()||"",rejected_quantity:"0",reason_if_reject:a.inspection_remarks||"",remark:a.remarks||""}));m("items",n,{shouldDirty:!1})}},[_,m]);u.useEffect(()=>{!l&&h&&_.length>0&&O(h)},[h,O,l,_.length]);const J=async s=>{try{$(!0);const r=(s.items||[]).map(n=>({item_id:n.item_id?Number(n.item_id):void 0,quantity:n.qty?Number(n.qty):0,bill_thick:n.thick_bl?Number(n.thick_bl):0,bill_length:n.length_bl?Number(n.length_bl):0,bill_width:n.width_bl?Number(n.width_bl):0,actual_req_thick:n.thick_actual?Number(n.thick_actual):0,actual_req_length:n.length_actual?Number(n.length_actual):0,actual_req_width:n.width_actual?Number(n.width_actual):0,accepted_quantity:n.accepted_quantity?Number(n.accepted_quantity):0,rejected_quantity:n.rejected_quantity?Number(n.rejected_quantity):0,reject_reason:n.reason_if_reject||""})),t={from_department:s.department_from,to_department:s.department_to,grn_number:s.grn_number,ms:s.ms,grn_id:l?parseInt(l,10):A?.id||null,branch_id:F,items:r};p?(await f.put(j.material_inspection_report.update(parseInt(p,10)),t),g.success("Material inspection report updated successfully")):(await f.post(j.material_inspection_report.create,t),g.success("Material inspection report created successfully")),x(w.MATERIAL_INSPECTION_REPORT.LIST)}catch(r){console.error(r),g.error(r?.response?.data?.message||`Failed to ${p?"update":"create"} material inspection report`)}finally{$(!1)}};return B?e.jsx("div",{className:"flex justify-center py-20",children:e.jsx(ce,{})}):e.jsxs("div",{className:"w-full h-full overflow-auto space-y-8 p-4 pb-20",children:[e.jsx("div",{className:"space-y-1 ml-2",children:e.jsx(ee,{title:p?"Edit Material Inspection Report Form":"Material Inspection Report Form",subtitle:p?"Update the Material Inspection Report details":"Fill out the form to submit a new material inspection report."})}),e.jsxs("div",{className:"grid grid-cols-2 gap-5 ml-2 mr-5",children:[e.jsx(o,{name:"department_from",control:i,render:({field:s})=>e.jsx(q,{required:!0,...s,label:"Department From"})}),e.jsx(o,{name:"department_to",control:i,render:({field:s})=>e.jsx(q,{required:!0,...s,label:"Department To"})}),e.jsx(o,{name:"grn_number",control:i,render:({field:s})=>e.jsxs("div",{children:[e.jsxs("label",{className:"text-sm font-semibold text-gray-700 mb-1",children:["GRN Number",!l&&e.jsx("span",{className:"text-xs text-gray-500 ml-2",children:"(Only GRNs pending inspection)"})]}),l?e.jsx("input",{...s,readOnly:!0,className:"w-full h-[45px] rounded-lg border border-gray-300 px-4 mt-1 text-sm bg-gray-50"}):e.jsxs("select",{...s,className:"w-full h-[45px] rounded-lg border border-gray-300 px-4 mt-1 text-sm",children:[e.jsx("option",{value:"",children:S?"Loading...":"Select GRN"}),_.length===0&&!S?e.jsx("option",{value:"",disabled:!0,children:"No GRNs pending inspection"}):_.map(r=>e.jsxs("option",{value:r.grn_number,children:[r.grn_number," - ",r.vendor?.party_name||"Unknown Vendor"]},r.id))]}),!l&&_.length===0&&!S&&e.jsx("p",{className:"text-xs text-amber-600 mt-1",children:"No GRNs are currently pending inspection. Please ensure GRNs have been created and are awaiting inspection."}),l&&e.jsx("p",{className:"text-xs text-green-600 mt-1",children:"Items loaded from selected GRN for inspection."}),!l&&h&&e.jsx("p",{className:"text-xs text-green-600 mt-1",children:"Items will be automatically loaded from the selected GRN."})]})}),e.jsx(o,{name:"grn_date",control:i,render:({field:s})=>e.jsx(q,{...s,label:"GRN Date",placeholder:"Date",readOnly:!0})}),e.jsx(o,{name:"ms",control:i,render:({field:s})=>e.jsx(q,{...s,label:"M/S"})})]}),e.jsxs(te,{title:"Items for Inspection",children:[h||l?e.jsx("div",{className:"flex justify-between items-center mb-2",children:e.jsxs("div",{className:"text-sm text-blue-600 bg-blue-50 px-3 py-2 rounded-lg",children:[e.jsx("span",{className:"font-medium",children:"Items loaded from GRN:"})," ",h||A?.grn_number]})}):e.jsx("div",{className:"flex justify-end mb-2",children:e.jsx(G,{className:"bg-red-600 text-white px-3 py-1",onClick:()=>Q({item_id:"",item_code:"",description_of_goods:"",unit:"",qty:"",thick_bl:"",length_bl:"",width_bl:"",thick_actual:"",length_actual:"",width_actual:"",accepted_quantity:"",rejected_quantity:"",reason_if_reject:"",remark:""}),children:"+ Add Item"})}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(ae,{children:[e.jsx(ne,{cols:[{title:"Description of Goods"},{title:"Item Code"},{title:"Unit"},{title:"Received Qty"},{title:"Thick in MM (B/L)"},{title:"Length in MM (B/L)"},{title:"Width in MM (B/L)"},{title:"Thick in MM (Actual)"},{title:"Length in MM (Actual)"},{title:"Width in MM (Actual)"},{title:"Accepted Qty"},{title:"Rejected Qty"},{title:"Reason If Reject"},{title:"Remark"},{title:"Actions"}]}),e.jsx("tbody",{children:H.map((s,r)=>e.jsxs("tr",{className:"align-middle",children:[e.jsx(d,{children:r+1}),e.jsx(d,{children:e.jsx(o,{name:`items.${r}.description_of_goods`,control:i,render:({field:t})=>t.value&&(h||l)?e.jsx("input",{...t,readOnly:!0,className:"w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm bg-gray-50",placeholder:"Item Name"}):e.jsxs("select",{...t,className:"w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm",onChange:a=>{t.onChange(a);const c=C.find(b=>b.item_name===a.target.value);c&&(m(`items.${r}.item_code`,c.item_code),m(`items.${r}.unit`,c.unit?.unit_name||""),m(`items.${r}.item_id`,c.id.toString()))},children:[e.jsx("option",{value:"",children:V?"Loading...":"Select Item"}),C.map(a=>e.jsx("option",{value:a.item_name,children:a.item_name},a.id))]})})}),e.jsx(d,{children:e.jsx(o,{name:`items.${r}.item_code`,control:i,render:({field:t})=>e.jsx("input",{...t,readOnly:!0,className:"w-[80px] h-[40px] border border-gray-300 rounded-lg px-3 text-sm bg-gray-50",placeholder:"Code"})})}),e.jsx(d,{children:e.jsx(o,{name:`items.${r}.unit`,control:i,render:({field:t})=>e.jsx("input",{...t,readOnly:!0,className:"w-[80px] h-[40px] border border-gray-300 rounded-lg px-3 text-sm bg-gray-50",placeholder:"Unit"})})}),e.jsx(d,{children:e.jsx(o,{name:`items.${r}.qty`,control:i,render:({field:t})=>e.jsx("input",{...t,type:"number",className:"w-[100px] h-[40px] border border-gray-300 rounded-lg px-3 text-sm",placeholder:"0"})})}),e.jsx(d,{children:e.jsx(o,{name:`items.${r}.thick_bl`,control:i,render:({field:t})=>e.jsx("input",{...t,className:"w-[127px] h-[40px] border border-gray-300 rounded-lg px-3 text-sm",placeholder:"Thick (B/L)"})})}),e.jsx(d,{children:e.jsx(o,{name:`items.${r}.length_bl`,control:i,render:({field:t})=>e.jsx("input",{...t,className:"w-[127px] h-[40px] border border-gray-300 rounded-lg px-3 text-sm",placeholder:"Length (B/L)"})})}),e.jsx(d,{children:e.jsx(o,{name:`items.${r}.width_bl`,control:i,render:({field:t})=>e.jsx("input",{...t,className:"w-[127px] h-[40px] border border-gray-300 rounded-lg px-3 text-sm",placeholder:"Width (B/L)"})})}),e.jsx(d,{children:e.jsx(o,{name:`items.${r}.thick_actual`,control:i,render:({field:t})=>e.jsx("input",{...t,className:"w-[127px] h-[40px] border border-gray-300 rounded-lg px-3 text-sm",placeholder:"Thick (Actual)"})})}),e.jsx(d,{children:e.jsx(o,{name:`items.${r}.length_actual`,control:i,render:({field:t})=>e.jsx("input",{...t,className:"w-[127px] h-[40px] border border-gray-300 rounded-lg px-3 text-sm",placeholder:"Length (Actual)"})})}),e.jsx(d,{children:e.jsx(o,{name:`items.${r}.width_actual`,control:i,render:({field:t})=>e.jsx("input",{...t,className:"w-[127px] h-[40px] border border-gray-300 rounded-lg px-3 text-sm",placeholder:"Width (Actual)"})})}),e.jsx(d,{children:e.jsx(o,{name:`items.${r}.accepted_quantity`,control:i,render:({field:t})=>e.jsx("input",{...t,type:"number",className:"w-[100px] h-[40px] border border-gray-300 rounded-lg px-3 text-sm",placeholder:"0"})})}),e.jsx(d,{children:e.jsx(o,{name:`items.${r}.rejected_quantity`,control:i,render:({field:t})=>e.jsx("input",{...t,type:"number",className:"w-[100px] h-[40px] border border-gray-300 rounded-lg px-3 text-sm",placeholder:"0"})})}),e.jsx(d,{children:e.jsx(o,{name:`items.${r}.reason_if_reject`,control:i,render:({field:t})=>e.jsx("input",{...t,className:"w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm",placeholder:"Reason"})})}),e.jsx(d,{children:e.jsx(o,{name:`items.${r}.remark`,control:i,render:({field:t})=>e.jsx("input",{...t,className:"w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm",placeholder:"Remark"})})}),e.jsx(d,{children:e.jsxs(re,{children:[!(h||l)&&e.jsx(se,{}),(h||l)&&e.jsx("span",{className:"text-xs text-gray-500 px-2",children:"From GRN"})]})})]},s.id))})]})})]}),e.jsxs("div",{className:"flex justify-end gap-3 mr-5",children:[e.jsx(G,{variant:"outline",onClick:()=>x(-1),children:"Cancel"}),e.jsx(G,{className:"bg-red-600 text-white",onClick:W(J),loading:L,disabled:L,children:p?"Update Report":"Submit Report"})]})]})};export{ye as default};
