import{u as ve,i as Ne,r as _,a as je,j as e,B as E,h as U,e as Q,y as V,A as G}from"./index-B2Kq7pF4.js";import{T as h}from"./TextInput-D6Nk2HMm.js";import{S as H}from"./Select-B7UTEZjZ.js";import{B as ye}from"./BaseModal-Da4Si1VO.js";import{u as Se,b as Ve,C as te}from"./index.esm-B19_P2AP.js";import{u as we}from"./useItemsStore-bYVehqqh.js";import{u as Ce}from"./useMaterialRequestStore-7-sZ9I5l.js";import{F as qe}from"./FormHeader-CQNygXHB.js";import{L as $e}from"./Loading-OOr2nQlv.js";import{u as Ae}from"./usePartyStore-Bjdb6AuV.js";import{C as Ee}from"./CommonFilter-DYIt7Pg1.js";import"./BackButton-D6lHrR0A.js";const F={quantity:"",rate:"",discount_percent:"",gst_percent:"",net_amount:"",total_amount:""},He=()=>{const q=ve(),[se]=Ne(),c=se.get("editId"),{items:Fe,fetchItems:W}=we(),{materials:$,fetchMaterials:T}=Ce(),[M,z]=_.useState(!1),[J,K]=_.useState(!1),{selectedBranchId:ae}=je(),{parties:ne,fetchParties:X}=Ae(),[re,Y]=_.useState(!1),[d,Z]=_.useState(null),[le,w]=_.useState(""),[R,g]=_.useState(""),{control:P,handleSubmit:de,getValues:N,watch:j,setValue:f,register:y,trigger:I}=Se({defaultValues:{branch_id:"",material_requisition_id:"",items:[]}}),{fields:A}=Ve({control:P,name:"items",keyName:"fieldId"}),ie=[{name:"mr_number",label:"MR Number",placeholder:"Enter MR number"},{name:"item_name",label:"Item Name",placeholder:"Enter Item Name"},{name:"date_from",label:"Date From",type:"date",placeholder:"Enter Date from"},{name:"date_to",label:"Date To",type:"date",placeholder:"Enter Date To"}],oe=async t=>{me(t);const s={};t.mr_number&&(s.mr_number=t.mr_number),t.item_name&&(s.item_name=t.item_name),t.date_from&&t.date_to?t.date_from===t.date_to?s.date=t.date_from:(s.date_from=t.date_from,s.date_to=t.date_to):(t.date_from&&(s.date_from=t.date_from),t.date_to&&(s.date_to=t.date_to)),await T(s)},[u,b]=_.useState({}),[ce,me]=_.useState({}),D=ne.filter(t=>(t.party_type?.toLowerCase()==="vendor"||!t.party_type)&&t.is_active);_.useEffect(()=>{X()},[X]),_.useEffect(()=>{W(),T()},[W,T]);const ue=async()=>{if(c){z(!0);try{const s=(await U.get(Q.comparative_statement.details(Number(c)))).data?.statement;if(!s){V.error("Comparative statement not found"),q(G.COMPERATIVE_STATEMENT.LIST);return}const a=s.items||[],i=s.material_requisition_id;if(a.length===0){V.error("No items found in comparative statement"),q(G.COMPERATIVE_STATEMENT.LIST);return}f("material_requisition_id",i?String(i):"");const n=[],r={};a.forEach((l,x)=>{const v={item_id:String(l.item_id||l.item?.id||""),item_name:l.item?.item_name||l.item_name||l.name||"",item_unit:l.item?.unit?.unit_name||l.item?.unit?.unit_symbol||l.item_unit||l.unit||"",quantity:String(l.quantity||""),last_purchase_rate:String(l.last_purchase_rate||"0"),selected_vendor_id:l.selected_vendor_id?`v_${l.selected_vendor_id}`:"",vendors:[]};r[x]={};const m=l.vendors||[],C=new Set;if(m.forEach(o=>{const S=`v_${o.vendor_id||o.id}`,B=o.vendor?.party_name||o.party_name||`Vendor ${o.vendor_id}`;C.has(S)||(v.vendors.push({id:S,name:B,vendor_id:o.vendor_id||o.id}),C.add(S)),r[x][S]={quantity:String(o.quantity||v.quantity||""),rate:String(o.rate??o.unit_price??o.price??""),discount_percent:String(o.discount_percent??o.discount_percentage??o.discount??""),gst_percent:String(o.gst_percent??o.gst_percentage??o.tax_percent??""),net_amount:String(o.net_amount??""),total_amount:String(o.total_amount??"")}}),l.selected_vendor&&l.selected_vendor_id){const o=`v_${l.selected_vendor_id}`;C.has(o)||(v.vendors.push({id:o,name:l.selected_vendor_rate_details?.vendor_name||l.selected_vendor?.party_name||"Selected Vendor",vendor_id:l.selected_vendor_rate_details?.vendor_id||l.selected_vendor_id}),r[x][o]||(r[x][o]={quantity:String(l.quantity||""),rate:String(l.selected_vendor_rate_details?.rate??""),discount_percent:String(l.selected_vendor_rate_details?.discount_percentage??""),gst_percent:String(l.selected_vendor_rate_details?.gst_percentage??""),net_amount:String(l.selected_vendor_rate_details?.net_amount??""),total_amount:String(l.selected_vendor_rate_details?.total_amount??"")}))}n.push(v)}),f("items",n),b(r),V.success("Comparative statement loaded successfully")}catch(t){console.error("Failed to load comparative statement:",t),console.error("Error response:",t.response?.data),V.error(t.response?.data?.message||"Failed to load comparative statement details")}finally{z(!1)}}};_.useEffect(()=>{c&&ue()},[c]);const xe=t=>{if(!t){f("items",[]);return}const s=$?.find(a=>a.id===Number(t));if(s&&s.items&&s.items.length>0){const a=s.items.map(n=>({item_id:String(n.item?.id||n.item_id||""),item_name:n.item?.item_name||n.item_name||n.name||"",item_unit:n.item?.unit?.unit_name||n.item?.unit?.unit_symbol||n.item_unit||n.unit||"",quantity:String(n.quantity_required||n.quantity||""),last_purchase_rate:"0",selected_vendor_id:"",vendors:[]}));f("items",a);const i={};a.forEach((n,r)=>{i[r]={}}),b(i)}},pe=t=>{Z(t),Y(!0);const s=N(`items.${t}`);s.selected_vendor_id?(g(s.selected_vendor_id),w(s.selected_vendor_id)):s.vendors&&s.vendors.length>0?g(s.vendors[0].id):g("")},ee=()=>{Y(!1),Z(null),w(""),g("")},_e=(t,s,a)=>{if(!t)return"";const i=t*(s/100||0),n=t-i,r=n*(a/100||0),l=n+r;return Number.isFinite(l)?l.toFixed(2):""},k=(t,s)=>{const a=parseFloat(t)||0,i=parseFloat(s)||0,n=a*i;return Number.isFinite(n)?n.toFixed(2):""},L=(t,s,a,i)=>{const n={...u,[t]:{...u[t],[s]:{...u[t]?.[s],[a]:i}}};if(a==="quantity"){const S=n[t][s].net_amount,B=N(`items.${t}.quantity`),fe=k(B,S);n[t][s].total_amount=fe,b(n);return}const r=n[t][s],l=parseFloat(r?.rate||"0")||0,x=parseFloat(r?.discount_percent||"0")||0,v=parseFloat(r?.gst_percent||"0")||0,m=_e(l,x,v);n[t][s].net_amount=m;const C=N(`items.${t}.quantity`),o=k(C,m);n[t][s].total_amount=o,b(n)},he=async t=>{if(!t||d===null)return;const s=parseInt(t),a=D.find(m=>m.id===s);if(!a)return;const n=N(`items.${d}`).vendors||[],r=`v_${s}`;if(n.some(m=>m.vendor_id===s)){g(r),b(m=>({...m,[d]:{...m[d],[r]:{...F}}})),w(""),await I();return}const x={id:r,name:a.party_name,vendor_id:s},v=[...n,x];f(`items.${d}.vendors`,v),g(r),b(m=>({...m,[d]:{...m[d],[r]:{...F}}})),w(""),await I()},ge=async(t,s)=>{const a=N(`items.${t}`),i=a.vendors[s].id,n=a.vendors.filter((r,l)=>l!==s);f(`items.${t}.vendors`,n),b(r=>{const l={...r};return l[t]&&delete l[t][i],l}),a.selected_vendor_id===i&&f(`items.${t}.selected_vendor_id`,""),R===i&&n.length>0&&g(n[0].id),await I()},O=t=>t?!!(t.rate||t.net_amount||t.total_amount):!1,be=async t=>{K(!0);const s={branch_id:Number(ae),material_requisition_id:t.material_requisition_id?Number(t.material_requisition_id):null,items:t.items.map((a,i)=>({item_id:Number(a.item_id),quantity:Number(a.quantity),last_purchase_rate:Number(a.last_purchase_rate)||0,selected_vendor_id:a.selected_vendor_id?Number(a.selected_vendor_id.replace("v_","")):null,vendors:a.vendors.map(n=>{const r=u[i]?.[n.id]||F,l=Number(r.discount_percent)||0,x=Number(r.gst_percent)||0;return{vendor_id:n.vendor_id,quantity:Number(r.quantity)||Number(a.quantity),rate:Number(r.rate)||0,unit_price:Number(r.rate)||0,discount_percent:l,gst_percent:x,discount_percentage:l,gst_percentage:x,tax_percentage:x,net_amount:Number(r.net_amount)||0,total_amount:Number(r.total_amount)||0}})}))};console.log("Submitting Comparative Statement Payload:",s);try{const a=c?Q.comparative_statement.update(Number(c)):Q.comparative_statement.create;await(c?U.put:U.post)(a,s),V.success(c?"Comparative statement updated successfully":"Comparative statement created successfully"),q(G.COMPERATIVE_STATEMENT.LIST)}catch(a){console.error(a),V.error(a.response?.data?.message||"Failed to save comparative statement")}finally{K(!1)}};if(M)return e.jsx("div",{className:"flex justify-center py-20",children:e.jsx($e,{})});const p=d!==null?N(`items.${d}.vendors`)||[]:[];return e.jsxs("div",{className:"w-full h-full overflow-auto bg-slate-50",children:[e.jsxs("div",{className:"max-w-7xl mx-auto space-y-8 px-6 py-5 pb-10",children:[e.jsx(qe,{title:c?"Edit Comparative Statement":"Create Comparative Statement",subtitle:c?"Update the comparative statement details":"Compare rates from multiple vendors and select the best option."}),e.jsx(Ee,{fields:ie,onFilter:oe,defaultValues:ce}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm p-4 sm:p-6 space-y-6",children:[e.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-xs font-semibold text-slate-500 uppercase mb-1",children:"Material Request"}),e.jsx(te,{name:"material_requisition_id",control:P,render:({field:t})=>e.jsxs(H,{...t,className:"text-sm py-2",onChange:s=>{t.onChange(s.target.value),xe(s.target.value)},disabled:!!c,children:[e.jsx("option",{value:"",children:"Select Material Request"}),$&&$.length>0&&$.map(s=>e.jsxs("option",{value:s.id,children:[s.mr_number," - ",s.department||"Unknown Dept"]},s.id))]})})]})}),A.length>0&&e.jsxs("div",{className:"mt-6",children:[e.jsxs("h3",{className:"text-sm font-semibold text-slate-700 mb-3",children:["Material Request Items (",A.length,")"]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border-collapse",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-slate-100 border-b border-slate-200",children:[e.jsx("th",{className:"text-left text-xs font-semibold text-slate-600 p-3",children:"Item Description"}),e.jsx("th",{className:"text-center text-xs font-semibold text-slate-600 p-3",children:"Unit"}),e.jsx("th",{className:"text-center text-xs font-semibold text-slate-600 p-3",children:"Quantity"}),e.jsx("th",{className:"text-center text-xs font-semibold text-slate-600 p-3",children:"Last Rate"}),e.jsx("th",{className:"text-center text-xs font-semibold text-slate-600 p-3",children:"Selected Vendor"}),e.jsx("th",{className:"text-center text-xs font-semibold text-slate-600 p-3",children:"Action"})]})}),e.jsx("tbody",{children:A.map((t,s)=>{const a=j(`items.${s}.vendors`)||[],i=j(`items.${s}.selected_vendor_id`),n=a.find(r=>r.id===i);return e.jsxs("tr",{className:"border-b border-slate-100 hover:bg-slate-50",children:[e.jsx("td",{className:"p-3",children:e.jsx(h,{...y(`items.${s}.item_name`),className:"bg-slate-50 border-slate-200 text-sm py-2",readOnly:!0})}),e.jsx("td",{className:"p-3",children:e.jsx(h,{...y(`items.${s}.item_unit`),className:"bg-slate-50 border-slate-200 text-center text-sm py-2",readOnly:!0})}),e.jsx("td",{className:"p-3",children:e.jsx(h,{...y(`items.${s}.quantity`),type:"number",className:"text-center text-sm py-2",placeholder:"0"})}),e.jsx("td",{className:"p-3",children:e.jsx(h,{...y(`items.${s}.last_purchase_rate`),type:"number",className:`text-center text-sm py-2 ${c?"bg-slate-50 border-slate-200":""}`,placeholder:"0.00",readOnly:!!c})}),e.jsx("td",{className:"p-3",children:n?e.jsx("div",{className:"bg-green-50 border border-green-300 rounded px-3 py-2 text-center",children:e.jsx("span",{className:"text-sm font-medium text-green-800",children:n.name})}):e.jsx("div",{className:"bg-gray-50 border border-gray-200 rounded px-3 py-2 text-center",children:e.jsx("span",{className:"text-xs text-gray-400",children:"Not Selected"})})}),e.jsx("td",{className:"p-3 text-center",children:e.jsx(E,{variant:"outline",onClick:()=>pe(s),className:"text-xs py-1 px-3",children:"Select Vendor"})})]},t.fieldId)})})]})})]}),!N("material_requisition_id")&&e.jsx("div",{className:"text-center p-12 bg-white border border-dashed border-slate-300 rounded-lg text-slate-500",children:"Please select a material request to view items."}),e.jsxs("div",{className:"flex justify-end items-center gap-3 mt-6",children:[e.jsx(E,{variant:"outline",onClick:()=>q(-1),children:"Cancel"}),e.jsx(E,{className:"bg-red-600 text-white",onClick:de(be),loading:J,disabled:J||A.length===0,children:c?"Update Statement":"Submit Statement"})]})]})]}),e.jsx(ye,{open:re,onClose:ee,title:"Select Vendors",maxWidth:"max-w-5xl",children:d!==null&&e.jsxs("div",{className:"space-y-4 max-h-[80vh] overflow-y-auto pr-2",children:[e.jsx("div",{className:"bg-slate-50 p-4 rounded-lg border border-slate-200",children:e.jsxs("div",{className:"grid grid-cols-4 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-xs text-slate-500 block mb-1",children:"Item:"}),e.jsx("p",{className:"font-medium",children:j(`items.${d}.item_name`)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-xs text-slate-500 block mb-1",children:"Unit:"}),e.jsx("p",{className:"font-medium",children:j(`items.${d}.item_unit`)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-slate-500 block mb-1",children:"Quantity:"}),e.jsx(h,{...y(`items.${d}.quantity`),type:"number",className:"text-sm py-2 font-medium",placeholder:"0",onChange:t=>{f(`items.${d}.quantity`,t.target.value),(j(`items.${d}.vendors`)||[]).forEach(a=>{const i=u[d]?.[a.id]?.net_amount||"";if(i){const n=k(t.target.value,i);b(r=>({...r,[d]:{...r[d],[a.id]:{...r[d]?.[a.id],total_amount:n}}}))}})}})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-slate-500 block mb-1",children:"Last Rate:"}),e.jsx(h,{...y(`items.${d}.last_purchase_rate`),type:"number",className:"text-sm py-2 font-medium",placeholder:"0.00"})]})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("label",{className:"text-xs font-semibold text-slate-500 uppercase mb-1",children:"Add Vendor"}),e.jsxs(H,{value:le,onChange:t=>{w(t.target.value),he(t.target.value)},className:"text-sm py-2",disabled:M,children:[e.jsx("option",{value:"",children:M?"Loading vendors...":"Select Vendor to Add"}),D.filter(t=>!p.some(s=>s.vendor_id===t.id)).map(t=>e.jsx("option",{value:t.id.toString(),children:t.party_name},t.id))]})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("label",{className:"text-xs font-semibold text-slate-500 uppercase mb-1",children:"Select Vendor (Final Choice)"}),e.jsx(te,{name:`items.${d}.selected_vendor_id`,control:P,render:({field:t})=>e.jsxs(H,{...t,className:"text-sm py-2 bg-green-50 border-green-300",onChange:s=>{const a=s.target.value,i=t.value;t.onChange(a),i&&i!==a&&b(n=>({...n,[d]:{...n[d],[i]:{...F}}})),a&&g(a)},children:[e.jsx("option",{value:"",children:"Select Vendor"}),p.filter(s=>{const a=u[d]?.[s.id];return O(a)}).map(s=>e.jsx("option",{value:s.id,children:s.name||"Vendor"},s.id))]})})]})]}),p.length>0&&e.jsx("div",{className:"space-y-4",children:(()=>{const t=p.find(a=>a.id===R)||p[0];if(!t)return null;const s=p.findIndex(a=>a.id===t.id);return e.jsxs("div",{className:"bg-slate-50 rounded-lg border border-slate-200 p-4 shadow-sm",children:[e.jsxs("div",{className:"flex justify-between items-center mb-3 pb-2 border-b border-slate-300",children:[e.jsx("span",{className:"font-semibold text-slate-700 text-sm",children:t.name||`Vendor ${s+1}`}),p.length>1&&e.jsx("button",{type:"button",onClick:()=>ge(d,s),className:"text-red-400 hover:text-red-600 font-bold ml-2",children:"✕"})]}),e.jsxs("div",{className:"grid grid-cols-5 gap-3",children:[e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-xs text-slate-500 text-center font-medium",children:"Rate"}),e.jsx(h,{type:"number",className:"text-sm text-right py-2 px-2",placeholder:"0.00",value:u[d]?.[t.id]?.rate||"",onChange:a=>{L(d,t.id,"rate",a.target.value)}})]}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-xs text-slate-500 text-center font-medium",children:"Disc%"}),e.jsx(h,{type:"number",className:"text-sm text-right py-2 px-2",placeholder:"0",value:u[d]?.[t.id]?.discount_percent||"",onChange:a=>{L(d,t.id,"discount_percent",a.target.value)}})]}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-xs text-slate-500 text-center font-medium",children:"GST%"}),e.jsx(h,{type:"number",className:"text-sm text-right py-2 px-2",placeholder:"0",value:u[d]?.[t.id]?.gst_percent||"",onChange:a=>{L(d,t.id,"gst_percent",a.target.value)}})]}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-xs text-slate-500 text-center font-medium",children:"Net Amount"}),e.jsx(h,{readOnly:!0,className:"bg-white border-slate-200 text-sm text-right font-medium py-2 px-2",value:u[d]?.[t.id]?.net_amount||""})]}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-xs text-slate-500 text-center font-medium",children:"Total Amount"}),e.jsx(h,{readOnly:!0,className:"bg-blue-50 border-blue-200 text-sm text-right font-semibold py-2 px-2",value:u[d]?.[t.id]?.total_amount||""})]})]})]},t.id)})()}),p.length>0&&e.jsxs("div",{className:"mt-6 border-t border-slate-200 pt-4",children:[e.jsxs("h3",{className:"text-sm font-semibold text-slate-700 mb-3",children:["Participating Vendors (",p.filter(t=>O(u[d]?.[t.id])).length,")"]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:p.map(t=>{const s=t.id===R,a=t.id===j(`items.${d}.selected_vendor_id`);let i,n;a?(i="p-4 border-2 border-green-500 bg-green-50 rounded-lg shadow-sm cursor-pointer",n="font-semibold text-sm text-green-800"):s?(i="p-4 border border-gray-600 bg-gray-400 text-white rounded-lg shadow-sm cursor-pointer",n="font-semibold text-sm text-white"):(i="p-4 border border-slate-200 bg-white rounded-lg shadow-sm cursor-pointer hover:border-slate-300",n="font-semibold text-slate-800 text-sm");const r=u[d]?.[t.id];return O(r)?e.jsxs("div",{className:i,onClick:()=>g(t.id),children:[e.jsx("div",{className:"flex justify-between mb-2 items-center",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h4",{className:n,children:t.name}),a&&e.jsx("span",{className:"text-xs bg-green-500 text-white px-2 py-1 rounded-full",children:"Selected"})]})}),e.jsx("div",{className:"space-y-2",children:e.jsx("div",{className:a?"border border-green-200 rounded p-2 bg-green-100":s?"border border-gray-500/40 rounded p-2 bg-gray-500/30":"border border-slate-100 rounded p-2 bg-slate-50",children:e.jsxs("div",{className:"grid grid-cols-2 gap-1 text-[11px]",children:[e.jsxs("span",{className:a?"text-green-700":s?"text-white":"",children:["Rate: ₹",r?.rate||"0"]}),e.jsxs("span",{className:a?"text-green-700":s?"text-white":"",children:["Disc: ",r?.discount_percent||"0","%"]}),e.jsxs("span",{className:a?"text-green-700":s?"text-white":"",children:["GST: ",r?.gst_percent||"0","%"]}),e.jsxs("span",{className:`col-span-2 font-semibold ${a?"text-green-800":s?"text-white":""}`,children:["Net: ₹",r?.net_amount||"0"]}),e.jsxs("span",{className:`col-span-2 font-semibold ${a?"text-green-800":s?"text-white":"text-blue-700"}`,children:["Total: ₹",r?.total_amount||"0"]})]})})})]},t.id):null})})]}),p.length===0&&e.jsx("div",{className:"text-center p-8 bg-yellow-50 border border-yellow-200 rounded-lg text-yellow-700 text-sm",children:"Please add at least one vendor to compare rates."}),e.jsx("div",{className:"flex justify-end gap-3 mt-6 pt-4 border-t border-slate-200 sticky bottom-0 bg-white",children:e.jsx(E,{variant:"outline",onClick:ee,children:"Close"})})]})})]})};export{He as default};
