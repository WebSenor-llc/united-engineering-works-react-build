import{r as l,a as L,j as e,B as f,h as G,e as T,y as B,i as z}from"./index-pN5-d-m8.js";import{S as J}from"./Select-DGZSDaXy.js";import{L as K}from"./ListWrapper-CqihWRKm.js";import{T as X,a as Y,b as _}from"./TableWrapper-CZQA7s35.js";import{u as $,C as y,c as Z}from"./index.esm-JoiVXGND.js";import{o as M,r as ee,t as b,v as te}from"./yup-CX38gN5W.js";import{L as re}from"./Loading-C_BG2GFI.js";import{F as ae}from"./FormHeader-CvljVmNp.js";import{B as se}from"./BaseModal-CQoGGfSx.js";import{T as j}from"./TextInput-CDui9bNy.js";import"./BackButton-ATDamMVI.js";const ne=ee().shape({expected_delivery_date:b().required("Expected delivery date is required"),delivery_address:b().required("Delivery address is required"),delivery_contact_person:b().required("Contact person is required"),delivery_contact_phone:b().required("Contact phone is required"),special_instructions:b().optional()}),ie=({open:O,onClose:n,vendorId:p,vendorName:N,csId:I,branchId:u,items:i,onSuccess:q})=>{const[c,g]=l.useState(!1),{control:o,handleSubmit:h,formState:{errors:x},reset:S}=$({resolver:M(ne),defaultValues:{expected_delivery_date:"",delivery_address:"",delivery_contact_person:"",delivery_contact_phone:"",special_instructions:""}}),{user:P}=L(),C=P?.id,m=async d=>{g(!0);try{const v={...d,vendor_id:p,created_by:C,comparative_statement_id:I,branch_id:u,items:i.map(s=>({item_id:s.item_id,quantity_ordered:s.quantity_ordered,unit_price:s.rate,discount_percentage:s.discount_percentage,tax_percentage:s.tax_percentage,total_price:s.total_price,branch_id:u}))};await G.post(T.purchase_order.create,v),B.success(`Purchase Order generated for ${N}`),S(),q(),n()}catch(v){console.error(v),B.error("Failed to generate Purchase Order")}finally{g(!1)}};return e.jsx(se,{open:O,onClose:n,title:`Generate PO for ${N}`,maxWidth:"max-w-2xl",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"max-h-[60vh] overflow-y-auto pr-2 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 ml-1",children:[e.jsx(y,{name:"expected_delivery_date",control:o,render:({field:d})=>e.jsx(j,{...d,type:"date",label:"Expected Delivery Date",error:x.expected_delivery_date?.message})}),e.jsx(y,{name:"delivery_contact_person",control:o,render:({field:d})=>e.jsx(j,{...d,label:"Delivery Contact Person",error:x.delivery_contact_person?.message})}),e.jsx(y,{name:"delivery_contact_phone",control:o,render:({field:d})=>e.jsx(j,{...d,label:"Delivery Contact Phone",error:x.delivery_contact_phone?.message})}),e.jsx(y,{name:"delivery_address",control:o,render:({field:d})=>e.jsx(j,{...d,label:"Delivery Address",error:x.delivery_address?.message})})]}),e.jsx("div",{className:"ml-1",children:e.jsx(y,{name:"special_instructions",control:o,render:({field:d})=>e.jsx(j,{...d,label:"Special Instructions",error:x.special_instructions?.message})})})]}),e.jsxs("div",{className:"flex justify-end pt-4 space-x-3",children:[e.jsx(f,{variant:"outline",onClick:n,disabled:c,children:"Cancel"}),e.jsx(f,{onClick:h(m),loading:c,children:"Generate Purchase Order"})]})]})})},de={vendor_id:0,branch_id:0,comparative_statement_id:0,expected_delivery_date:"",delivery_address:"",delivery_contact_person:"",delivery_contact_phone:"",special_instructions:"",items:[{item_id:0,item_name:"",item_code:"",item_unit:"",quantity_ordered:0,unit:"",unit_price:0,discount_percentage:0,tax_percentage:0,total_price:0,rate:"0"}]},ge=()=>{const[O]=z(),n=O.get("editId"),[p,N]=l.useState([]),[I,u]=l.useState(!1),[i,q]=l.useState(null),{selectedBranchId:c}=L(),[g,o]=l.useState(!1),[h,x]=l.useState(null),{control:S,setValue:P,reset:C}=$({defaultValues:de,resolver:M(te)}),m=Z({control:S,name:"comparative_statement_id"}),d=async()=>{if(c){u(!0);try{const s=await G.get(T.comparative_statement.items,{params:{branch_id:c}});N(s.data?.statements||[])}catch(s){console.error(s)}finally{u(!1)}}};l.useEffect(()=>{d()},[c]),l.useEffect(()=>{if(!n||p.length===0)return;(async()=>{u(!0);try{const a=await G.get(T.purchase_order.details(Number(n))),t=a.data?.purchaseOrder||a.data?.purchase_order||a.data;t&&(q(t),P("comparative_statement_id",t.comparative_statement_id||0),C({branch_id:t.branch_id||c,vendor_id:t.vendor_id||0,comparative_statement_id:t.comparative_statement_id||0,expected_delivery_date:t.expected_delivery_date?t.expected_delivery_date.split("T")[0]:"",delivery_address:t.delivery_address||"",delivery_contact_person:t.delivery_contact_person||"",delivery_contact_phone:t.delivery_contact_phone||"",special_instructions:t.special_instructions||"",items:(t.items||[]).map(r=>({item_id:r.item_id||0,item_name:r.item?.item_name||"",item_code:r.item?.item_code||"",item_unit:r.item?.unit?.unit_name||"",quantity_ordered:Number(r.quantity_ordered)||0,unit:r.item?.unit?.unit_name||"",unit_price:Number(r.unit_price)||0,discount_percentage:Number(r.discount_percentage)||0,tax_percentage:Number(r.tax_percentage)||0,total_price:Number(r.total_price)||0,rate:String(r.unit_price||0)}))}))}catch(a){console.error("Error loading PO details:",a)}finally{u(!1)}})()},[n,p.length,P,C,c]);const v=l.useMemo(()=>{if(!m)return{};const s=p.find(t=>t.id===m);if(!s||!s.items)return{};console.log("Selected CS:",s);const a={};if(s.items.forEach(t=>{const r=t.selected_vendor?.id||t.selected_vendor_id;if(!r)return;if(!a[r]){const D=s.vendors_with_po_status?.find(Q=>Q.vendor_id===r);a[r]={vendor:t.selected_vendor,items:[],all_items_have_po:!!D?.allItemsHavePo,po_items:n&&i?(i.items||[]).filter(()=>i.vendor_id===r):[]}}const V=Number(t.quantity)||0,A=Number(t.selected_vendor_rate_details?.rate)||0,E=Number(t.selected_vendor_rate_details?.discount_percentage)||0,F=Number(t.selected_vendor_rate_details?.gst_percentage)||0,k=V*A,U=k*E/100,w=k-U,W=w*F/100,H=Number((w+W).toFixed(2)),R=n&&i&&i.items?.some(D=>D.item_id===t.item_id);a[r].items.push({item_id:t.item_id,item_name:t.item?.item_name||"Unknown Item",quantity_ordered:V,rate:A,discount_percentage:E,tax_percentage:F,total_price:H,has_po:R})}),n&&i){const t=i.vendor_id,r={};return t&&a[t]&&(r[t]=a[t]),r}return a},[p,m,n,i]);return I?e.jsx("div",{className:"flex justify-center py-20",children:e.jsx(re,{})}):e.jsxs("div",{className:"w-full h-full overflow-auto space-y-8 p-4 pb-20",children:[e.jsx("div",{className:"space-y-1 ml-2",children:e.jsx(ae,{title:n?"Edit Purchase Order":"Create Purchase Order",subtitle:n?"Update the Purchase Order details":"Fill out the form to submit a new Purchase Order."})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-5 ml-4",children:[e.jsx(y,{name:"comparative_statement_id",control:S,render:({field:s})=>e.jsxs(J,{...s,label:"Comparative Statement",value:s.value||0,onChange:a=>s.onChange(Number(a.target.value)),disabled:!!n,children:[e.jsx("option",{value:0,children:"Select Comparative Statement"}),p.map(a=>e.jsx("option",{value:a.id,children:a.statement_number},a.id))]})}),n&&i&&e.jsxs("div",{className:"bg-gray-50 border border-gray-200 rounded p-3",children:[e.jsx("h4",{className:"font-semibold text-gray-800 mb-2",children:"Purchase Order Details"}),e.jsxs("p",{className:"text-sm text-gray-700",children:[e.jsx("strong",{children:"PO Number:"})," ",i.po_number||"N/A"]}),e.jsxs("p",{className:"text-sm text-gray-700",children:[e.jsx("strong",{children:"Vendor:"})," ",i.vendor?.party_name||"N/A"]}),e.jsxs("p",{className:"text-sm text-gray-700",children:[e.jsx("strong",{children:"Status:"})," ",i.status||"N/A"]}),(i.status?.toLowerCase().includes("cancel")||i.status==="Cancelled")&&i.cancellation_reason&&e.jsx("div",{className:"mt-2 p-2 bg-red-50 border border-red-200 rounded",children:e.jsxs("p",{className:"text-sm text-red-800",children:[e.jsx("strong",{children:"Cancellation Reason:"})," ",i.cancellation_reason||"No reason provided"]})})]})]}),m&&Object.keys(v).length>0?e.jsx("div",{className:"space-y-6",children:Object.entries(v).map(([s,a])=>e.jsxs(K,{title:`Vendor: ${a.vendor?.party_name||"Unknown"}`,children:[e.jsxs("div",{className:"mb-4 flex justify-between items-center",children:[e.jsxs("div",{className:"text-sm text-gray-600",children:[e.jsxs("p",{children:["Total Items: ",a.items.length]}),e.jsxs("p",{className:"font-semibold text-gray-900",children:["Grand Total: ₹",a.items.reduce((t,r)=>t+r.total_price,0).toLocaleString("en-IN",{minimumFractionDigits:2})]})]}),n?e.jsx(f,{variant:"outline",disabled:!0,className:"bg-green-100 !text-green-600 !border-green-300",children:"Current PO Vendor"}):a.all_items_have_po?e.jsx(f,{variant:"outline",disabled:!0,className:"bg-gray-100 !text-gray-400 !border-gray-300 pointer-events-none",children:"Generated"}):e.jsx(f,{onClick:()=>{x({...a,vendorId:Number(s)}),o(!0)},children:"Generate PO"})]}),e.jsxs(X,{children:[e.jsx(Y,{cols:[{title:"Item"},{title:"Qty"},{title:"Rate"},{title:"Disc%"},{title:"GST%"},{title:"Total"},...n?[{title:"Status"}]:[]]}),e.jsx("tbody",{children:a.items.map((t,r)=>e.jsxs("tr",{className:`border-t ${n&&t.has_po?"bg-green-50":""}`,children:[e.jsx(_,{children:r+1}),e.jsx(_,{children:t.item_name}),e.jsx(_,{children:t.quantity_ordered}),e.jsx(_,{children:t.rate}),e.jsxs(_,{children:[t.discount_percentage,"%"]}),e.jsxs(_,{children:[t.tax_percentage,"%"]}),e.jsxs(_,{children:["₹",t.total_price.toFixed(2)]}),n&&e.jsx(_,{children:t.has_po?e.jsx("span",{className:"text-xs bg-green-100 text-green-800 px-2 py-1 rounded",children:"In PO"}):e.jsx("span",{className:"text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded",children:"Available"})})]},r))})]})]},s))}):e.jsx("div",{className:"p-8 text-center text-gray-500 bg-gray-50 rounded-lg",children:m?"No items found for this Comparative Statement.":"Please select a Comparative Statement to view items grouped by vendor."}),g&&h&&e.jsx(ie,{open:g,onClose:()=>o(!1),vendorId:h.vendorId,vendorName:h.vendor?.party_name||"Unknown",csId:m,branchId:c,items:h.items,onSuccess:()=>{o(!1),d()}})]})};export{ge as default};
