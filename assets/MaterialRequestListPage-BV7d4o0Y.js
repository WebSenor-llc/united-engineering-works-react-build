import{r as m,a as U,j as e,M as i,y as A,e as _,h as C,u as Y,k as z,D as q,P as M,A as O}from"./index-CJSsBkhT.js";import{L as W}from"./ListWrapper-B-2AH1s6.js";import{T as F,a as $,b as u}from"./TableWrapper-Dj27ssIq.js";import{T as G}from"./TableRow-DSWYAKtL.js";import{u as J}from"./usePagination-iM4RzRER.js";import{T as Q}from"./TableActions-DOn7XnR-.js";import{T as K}from"./TableDelete-DvDgU1bD.js";import{R as V}from"./ReasonModal-zCzzqUmW.js";import{c as Z}from"./rolePermissions-DtNSEKkh.js";import{T as X}from"./TableView-CtV0nAby.js";import{C as ee}from"./CommonFilter-DxiTwGUQ.js";import{D as te,P as se,S as ae,V as l,I as le,T as a,a as re,p as ne}from"./react-pdf.browser-DK5a595X.js";import"./index.esm-BT8ElwEF.js";import"./TextInput-BOX4cYB8.js";const ie=({materialRequisition:s,onStatusUpdate:g})=>{const[c,f]=m.useState(!1),[S,y]=m.useState(!1),[P,D]=m.useState(!1),[h,b]=m.useState(null),{user:B}=U(),N=async(n,p)=>{f(!0);try{let o="",r={};if((n===i.REJECTED_BY_DEPT_HEAD||n===i.CANCELLED_BY_STORE)&&!p){A.error("Reason is required");return}switch(n){case i.PENDING_DEPT_APPROVAL:o=_.material_requisition.submit(s.id),await C.post(o);break;case i.APPROVED_BY_DEPT_HEAD:o=_.material_requisition.approveDept(s.id),await C.post(o,{action:"approve"});break;case i.REJECTED_BY_DEPT_HEAD:o=_.material_requisition.reject(s.id),r={action:"reject",cancellation_reason:p||"No reason provided"},await C.post(o,r);break;case i.APPROVED_BY_STORE:o=_.material_requisition.approveStore(s.id),await C.post(o);break;case i.CANCELLED_BY_STORE:o=_.material_requisition.cancel(s.id),r={action:"cancel",cancellation_reason:p||"No reason provided"},await C.post(o,r);break;case i.COMPLETED:A.success("Material Requisition marked as Completed");break;default:throw new Error("Invalid status change")}A.success("Status updated successfully"),g()}catch(o){console.error("Failed to update status:",o),A.error(o.response?.data?.message||"Failed to update status")}finally{f(!1)}},d=(()=>{const n=s.status,p=B?.role?.role_name||"";switch(n){case i.PENDING_DEPT_APPROVAL:return Z(p)?[{value:i.APPROVED_BY_DEPT_HEAD,label:"Approve"},{value:i.REJECTED_BY_DEPT_HEAD,label:"Reject"}]:[];case i.APPROVED_BY_DEPT_HEAD:if(p==="Store Manager")return[{value:i.APPROVED_BY_STORE,label:"Approve"},{value:i.CANCELLED_BY_STORE,label:"Cancel"}];break;default:return[]}return[]})(),L=n=>{n===i.REJECTED_BY_DEPT_HEAD?(b({status:n,actionType:"reject"}),y(!0)):n===i.CANCELLED_BY_STORE?(b({status:n,actionType:"cancel"}),y(!0)):N(n)},w=n=>{h&&(N(h.status,n),b(null)),y(!1)},I=()=>{b(null),y(!1)};return d.length===0?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs px-2 py-1 bg-gray-100 text-gray-700 rounded border",children:s.status}),(s.status===i.CANCELLED_BY_STORE||s.status===i.REJECTED_BY_DEPT_HEAD)&&s.cancellation_reason&&e.jsx("button",{onClick:()=>D(!0),className:"text-xs px-2 py-1 bg-red-100 text-red-700 rounded border border-red-200 hover:bg-red-200 transition-colors",title:"View reason",children:"View Reason"})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex items-center gap-2",children:c?e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"}),e.jsx("span",{className:"text-xs text-gray-500",children:"Updating..."})]}):e.jsxs(e.Fragment,{children:[e.jsxs("select",{className:"text-xs border border-gray-300 rounded px-2 py-1 focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white min-w-[120px]",value:"",onChange:n=>{n.target.value&&(L(n.target.value),n.target.value="")},children:[e.jsx("option",{value:"",children:s.status}),d.map(n=>e.jsx("option",{value:n.value,children:n.label},n.value))]}),(s.status===i.CANCELLED_BY_STORE||s.status===i.REJECTED_BY_DEPT_HEAD)&&s.cancellation_reason&&e.jsx("button",{onClick:()=>D(!0),className:"text-xs px-2 py-1 bg-red-100 text-red-700 rounded border border-red-200 hover:bg-red-200 transition-colors",title:"View reason",children:"View Reason"})]})}),e.jsx(V,{open:P,onClose:()=>D(!1),title:s.status===i.CANCELLED_BY_STORE?"Cancellation Reason":"Rejection Reason",message:s.cancellation_reason||"No reason provided",readonly:!0}),e.jsx(V,{open:S,onClose:I,onSubmit:w,title:h?.actionType==="reject"?"Rejection Reason":"Cancellation Reason",message:h?.actionType==="reject"?"Please provide a reason for rejecting this material request:":"Please provide a reason for cancelling this material request:"})]})},H=s=>s?new Date(s).toLocaleDateString("en-IN",{day:"2-digit",month:"2-digit",year:"numeric"}):"-",oe=({mr:s})=>{const g=s.items||[];return e.jsx(te,{children:e.jsxs(se,{size:"A4",style:t.page,children:[e.jsxs(l,{style:t.headerContainer,children:[e.jsx(l,{style:t.logoSection,children:e.jsx(le,{src:"/assets/images/logo.png",style:t.logo})}),e.jsxs(l,{style:t.companyInfo,children:[e.jsx(a,{style:t.companyName,children:"UNITED ENGINEERING WORKS"}),e.jsx(a,{style:t.companyAddress,children:"N.H. 8, Nehla Village, By Pass Road, Near Govardhan Vilas, Udaipur- 313001 (Raj.) INDIA"}),e.jsx(a,{style:t.companyContact,children:"Phone: +91-9829232445 +91-9829657145 | GSTIN: 08ABQPK8948J3ZP | Email: info@unitedengineeringworks.com"})]})]}),e.jsx(a,{style:t.title,children:"MATERIAL REQUISITION"}),e.jsxs(l,{style:t.infoContainer,children:[e.jsxs(l,{style:t.detailsBox,children:[e.jsxs(l,{style:t.detailRow,children:[e.jsx(a,{style:t.label,children:"MR Number:"}),e.jsx(a,{style:t.value,children:s.mr_number||"-"})]}),e.jsxs(l,{style:t.detailRow,children:[e.jsx(a,{style:t.label,children:"Department:"}),e.jsx(a,{style:t.value,children:s.department||"-"})]}),e.jsxs(l,{style:t.detailRow,children:[e.jsx(a,{style:t.label,children:"Required Date:"}),e.jsx(a,{style:t.value,children:H(s.required_by_date)})]}),e.jsxs(l,{style:t.detailRow,children:[e.jsx(a,{style:t.label,children:"Priority:"}),e.jsx(a,{style:t.value,children:s.priority||"-"})]})]}),e.jsxs(l,{style:t.detailsBox,children:[e.jsxs(l,{style:t.detailRow,children:[e.jsx(a,{style:t.label,children:"Requested By:"}),e.jsx(a,{style:t.value,children:s.requested_by?.full_name||"-"})]}),e.jsxs(l,{style:t.detailRow,children:[e.jsx(a,{style:t.label,children:"Employee Code:"}),e.jsx(a,{style:t.value,children:s.requested_by?.employee_code||"-"})]}),e.jsxs(l,{style:t.detailRow,children:[e.jsx(a,{style:t.label,children:"Inspection:"}),e.jsx(a,{style:t.value,children:s.inspection?"Yes":"No"})]}),e.jsxs(l,{style:t.detailRow,children:[e.jsx(a,{style:t.label,children:"Created Date:"}),e.jsx(a,{style:t.value,children:H(s.created_at)})]})]})]}),(s.purpose||s.remarks)&&e.jsxs(l,{style:t.remarksSection,children:[e.jsx(a,{style:t.remarksLabel,children:"Purpose / Remarks:"}),e.jsx(a,{style:t.remarksText,children:s.purpose||s.remarks||"-"})]}),e.jsxs(l,{style:t.tableContainer,children:[e.jsxs(l,{style:t.tableHeaderRow,children:[e.jsx(l,{style:[t.tableCell,t.snoCol,t.headerCell],children:e.jsx(a,{style:t.headerText,children:"S.No"})}),e.jsx(l,{style:[t.tableCell,t.itemNameCol,t.headerCell],children:e.jsx(a,{style:t.headerText,children:"Item Description"})}),e.jsx(l,{style:[t.tableCell,t.itemCodeCol,t.headerCell],children:e.jsx(a,{style:t.headerText,children:"Item Code"})}),e.jsx(l,{style:[t.tableCell,t.unitCol,t.headerCell],children:e.jsx(a,{style:t.headerText,children:"Unit"})}),e.jsx(l,{style:[t.tableCell,t.qtyCol,t.headerCell],children:e.jsx(a,{style:t.headerText,children:"Qty"})}),e.jsx(l,{style:[t.tableCell,t.stockCol,t.headerCell],children:e.jsx(a,{style:t.headerText,children:"Stock in Store"})}),e.jsx(l,{style:[t.tableCell,t.remarksCol,t.headerCell],children:e.jsx(a,{style:t.headerText,children:"Remarks"})})]}),g.map((c,f)=>e.jsxs(l,{style:t.tableRow,children:[e.jsx(l,{style:[t.tableCell,t.snoCol],children:e.jsx(a,{style:t.cellText,children:f+1})}),e.jsx(l,{style:[t.tableCell,t.itemNameCol],children:e.jsx(a,{style:t.cellText,children:c.item?.item_name||"-"})}),e.jsx(l,{style:[t.tableCell,t.itemCodeCol],children:e.jsx(a,{style:t.cellText,children:c.item?.item_code||"-"})}),e.jsx(l,{style:[t.tableCell,t.unitCol],children:e.jsx(a,{style:t.cellText,children:c.item?.unit?.unit_name||"-"})}),e.jsx(l,{style:[t.tableCell,t.qtyCol],children:e.jsx(a,{style:t.cellText,children:c.quantity_required||0})}),e.jsx(l,{style:[t.tableCell,t.stockCol],children:e.jsx(a,{style:t.cellText,children:c.item?.current_stock??"-"})}),e.jsx(l,{style:[t.tableCell,t.remarksCol],children:e.jsx(a,{style:t.cellText,children:c.remarks||"-"})})]},f))]}),(s.project_use||s.machine_use||s.site_use||s.general_use)&&e.jsxs(l,{style:t.usageSection,children:[e.jsx(a,{style:t.usageTitle,children:"Usage Details:"}),s.project_use&&e.jsxs(a,{style:t.usageText,children:["Project Use: ",s.project_use,s.project_note&&` - ${s.project_note}`]}),s.machine_use&&e.jsxs(a,{style:t.usageText,children:["Machine Use: ",s.machine_use,s.machine_note&&` - ${s.machine_note}`]}),s.site_use&&e.jsxs(a,{style:t.usageText,children:["Site Use: ",s.site_use,s.site_note&&` - ${s.site_note}`]}),s.general_use&&e.jsxs(a,{style:t.usageText,children:["General Use: ",s.general_use,s.general_note&&` - ${s.general_note}`]})]}),e.jsxs(l,{style:t.signatureContainer,children:[e.jsxs(l,{style:t.signatureBox,children:[e.jsx(a,{style:t.signatureTitle,children:"Prepared By"}),e.jsx(l,{style:t.signatureLine}),e.jsx(a,{style:t.signatureText,children:"Signature"})]}),e.jsxs(l,{style:t.signatureBox,children:[e.jsx(a,{style:t.signatureTitle,children:"Approved By"}),e.jsx(l,{style:t.signatureLine}),e.jsx(a,{style:t.signatureText,children:"Dept. Head"})]}),e.jsxs(l,{style:t.signatureBox,children:[e.jsx(a,{style:t.signatureTitle,children:"To Purchase Dept."}),e.jsx(l,{style:t.signatureLine}),e.jsx(a,{style:t.signatureText,children:"Signature"})]})]})]})})},t=ae.create({page:{padding:20,fontSize:10,fontFamily:"Helvetica",lineHeight:1.3},headerContainer:{flexDirection:"row",alignItems:"center",marginBottom:15,paddingBottom:10,borderBottomWidth:2,borderBottomColor:"#000",gap:20},logoSection:{width:"20%",marginRight:20},logo:{width:90,height:50},companyInfo:{width:"80%",alignItems:"flex-start",paddingLeft:20},companyName:{fontSize:16,fontWeight:"bold",marginBottom:3},companyAddress:{fontSize:10,marginBottom:2},companyContact:{fontSize:10},title:{fontSize:18,textAlign:"center",marginBottom:15,fontWeight:"bold",textDecoration:"underline"},infoContainer:{flexDirection:"row",marginBottom:15,justifyContent:"space-between"},detailsBox:{width:"48%",padding:8},detailRow:{flexDirection:"row",marginBottom:3},label:{width:"40%",fontSize:9,fontWeight:"bold"},value:{width:"60%",fontSize:9},remarksSection:{marginBottom:10,padding:8,backgroundColor:"#f9f9f9",borderWidth:.5,borderColor:"#ccc"},remarksLabel:{fontSize:9,fontWeight:"bold",marginBottom:3},remarksText:{fontSize:9},tableContainer:{marginBottom:15,borderWidth:.25,borderColor:"#000"},tableHeaderRow:{flexDirection:"row",backgroundColor:"#e0e0e0"},tableRow:{flexDirection:"row"},tableCell:{padding:2,borderWidth:.25,borderColor:"#000",justifyContent:"center",alignItems:"center"},headerCell:{backgroundColor:"#f0f0f0"},headerText:{fontSize:9,fontWeight:"bold",textAlign:"center"},cellText:{fontSize:8,textAlign:"center"},snoCol:{width:"8%"},itemNameCol:{width:"25%"},itemCodeCol:{width:"15%"},unitCol:{width:"10%"},qtyCol:{width:"10%"},stockCol:{width:"12%"},remarksCol:{width:"20%"},usageSection:{marginBottom:15,padding:8},usageTitle:{fontSize:9,fontWeight:"bold",marginBottom:5,textDecoration:"underline"},usageText:{fontSize:9,marginBottom:2},signatureContainer:{marginTop:40,flexDirection:"row",justifyContent:"space-between"},signatureBox:{width:"30%",alignItems:"center"},signatureTitle:{fontSize:9,fontWeight:"bold",marginBottom:30},signatureLine:{width:120,height:1,backgroundColor:"#000",marginBottom:5},signatureText:{fontSize:8}}),Ee=()=>{const{page:s,rowsPerPage:g,setTotal:c,renderPagination:f}=J(),S=Y(),{selectedBranchId:y,user:P}=U(),{setMaterialRequisitions:D}=z(),[h]=m.useState(""),[b,B]=m.useState([]),[N,k]=m.useState(!0),[d,L]=m.useState({date_from:"",date_to:"",item_name:"",mr_number:""}),w=async()=>{k(!0);try{const r={page:s+1,rowsPerPage:g,...y&&{branch_id:y}};d.date_from&&(r.date_from=d.date_from),d.date_to&&(r.date_to=d.date_to),d.item_name&&(r.item_name=d.item_name),d.mr_number&&(r.mr_number=d.mr_number);const x=await C.get(_.material_requisition.items,{params:r}),E=x.data?.material_requisitions||[],v=x.data?.pagination;B(E),v?.total!==void 0&&c(v.total);const T=P?.role?.role_name;let j=0;T==="Department Head"?j=E.filter(R=>R.status==="Pending Approval (Dept Head)").length:T==="Store Manager"?j=E.filter(R=>R.status==="Approved - With Head").length:T==="Super Admin"&&(j=E.filter(R=>R.status==="Approved - With Store").length),D(j)}catch(r){console.error("Error fetching material requests:",r)}finally{k(!1)}};m.useEffect(()=>{w()},[s,g,y,d]);const I=[{name:"mr_number",label:"MR Number",type:"text",placeholder:"Enter MR Number"},{name:"item_name",label:"Item Name",type:"text",placeholder:"Enter Item Name"},{name:"date_from",label:"Date From",type:"date"},{name:"date_to",label:"Date To",type:"date"}],n=r=>{L(r)},p=async r=>{try{const x=await C.get(_.material_requisition.details(r.id)),E=x.data.data?.material_requisition||x.data.material_requisition||x.data,v=await ne(e.jsx(oe,{mr:E})).toBlob(),T=URL.createObjectURL(v),j=document.createElement("a");j.href=T,j.download=`${r.mr_number}.pdf`,j.click(),URL.revokeObjectURL(T)}catch(x){console.error("Error downloading MR PDF:",x)}},o=h?b.filter(r=>r.status===h):b;return e.jsx("div",{className:"space-y-6",children:e.jsxs(W,{title:`Material Requests (${o.length})`,createOnClick:M.hasPermission("material_requisition_create")?()=>S(O.MATERIAL_REQUEST.CREATE):void 0,children:[e.jsx(ee,{fields:I,onFilter:n,defaultValues:d}),e.jsxs(F,{children:[e.jsx($,{cols:[{title:"MR Number"},{title:"Department"},{title:"Priority"},{title:"Requested By"},{title:"Required By"},{title:"Status"},{title:"Created At"},{title:"Actions"}]}),e.jsx("tbody",{children:N&&o.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:10,className:"px-6 py-12 text-center",children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("svg",{className:"w-12 h-12 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),e.jsx("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"No material requests"}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:h?`No requests found with status "${h}"`:"Get started by creating a new material request."})]})})}):o.map((r,x)=>e.jsxs(G,{children:[e.jsx(u,{className:"px-5",children:s*g+x+1}),e.jsx(u,{className:"w-40",children:e.jsx("div",{className:"flex items-center",children:e.jsx("div",{className:"text-sm font-medium text-gray-900",children:r.mr_number})})}),e.jsx(u,{className:"w-36",children:e.jsx("div",{className:"text-sm text-gray-900",children:r.department})}),e.jsx(u,{className:"w-28",children:e.jsx("span",{className:"inline-flex items-center justify-center px-2 py-1 text-xs font-medium bg-gray-100 text-gray-800 rounded-full",children:r.priority})}),e.jsx(u,{className:"w-48",children:e.jsx("div",{className:"flex items-center",children:e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:r.requested_by?.full_name||"â€”"}),e.jsx("div",{className:"text-sm text-gray-500",children:r.requested_by?.employee_code||""})]})})}),e.jsx(u,{className:"w-32",children:e.jsx("div",{className:"text-sm text-gray-900",children:q.date(r.required_by_date)})}),e.jsx(u,{className:"w-40",children:e.jsx(ie,{materialRequisition:{id:r.id,status:r.status,mr_number:r.mr_number},onStatusUpdate:w})}),e.jsx(u,{className:"w-32",children:e.jsx("div",{className:"text-sm text-gray-500",children:q.date(r.created_at)})}),e.jsx(u,{className:"w-52",children:e.jsxs(Q,{children:[e.jsx(X,{url:`${O.MATERIAL_REQUEST.DETAILS.replace(":id","")}${r.id}`,tooltip:"View Material Request Details"}),e.jsx(re,{title:"Download MR PDF",onClick:()=>p(r)}),M.hasPermission("material_requisition_delete")&&e.jsx(K,{refetch:w,endpoint:_.material_requisition.delete(r.id)})]})})]},r.id))})]}),o.length>0&&f()]})})};export{Ee as default};
