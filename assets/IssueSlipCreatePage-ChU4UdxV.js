import{u as ae,i as re,a as ie,r as f,h as S,e as F,y as h,j as e,B as M,A as le}from"./index-BrwORqfZ.js";import{F as ne}from"./FormHeader-BmUnx_r8.js";import{T as I}from"./TextInput-BNvsxhCk.js";import{S as oe}from"./Select-xqkIbLwE.js";import{L as de}from"./ListWrapper-BaH-EqLI.js";import{T as me}from"./TableActions-CxOZpC0K.js";import{T as ue,a as ce,b as x}from"./TableWrapper-6sipL8t3.js";import{T as pe}from"./TableDelete-BqsgYPpv.js";import{u as xe,b as _e,C as c}from"./index.esm-DAnzzIlF.js";import{L as fe}from"./Loading-BE8U9Iu2.js";import{u as he}from"./useMachineStore-DUDdbS9D.js";import{u as ye}from"./useMaterialRequestStore-R9MdjFO6.js";import{o as ge,k as be}from"./yup-qIakR7c9.js";import{C as je}from"./CommonFilter-cd2KA1z9.js";import"./BackButton-1mGFTD4R.js";const N={mr:"",machine:"",for_party:"",for_mines:"",issued_to:"",purpose:"",items:[{item_name:"",item_code:"",item_id:"",item_unit:"",required_qty:"",issued_qty:""}]},Oe=()=>{const w=ae(),[V]=re(),n=V.get("editId"),{selectedBranchId:L}=ie(),{materials:_,fetchMaterials:v}=ye(),[U,$]=f.useState(!1),[T,E]=f.useState(!1),{machines:B,fetchMachines:Q}=he(),[H,W]=f.useState({}),Y=[{name:"mr_number",label:"MR Number",placeholder:"Enter MR Number"},{name:"item_name",label:"Item Name",placeholder:"Enter Item Name"},{name:"date_from",label:"Date From",type:"date"},{name:"date_to",label:"Date To",type:"date"}],{control:u,handleSubmit:z,setValue:q,reset:R,watch:P,formState:{errors:y}}=xe({defaultValues:N,resolver:ge(be)}),{fields:G,append:J,remove:K}=_e({control:u,name:"items"}),o=P("mr");f.useEffect(()=>{v(),Q()},[v,Q]);const X=async t=>{W(t);const s={};t.requested_by&&(s.requested_by=t.requested_by),t.mr_number&&(s.mr_number=t.mr_number),t.item_name&&(s.item_name=t.item_name),t.date_from&&t.date_to?t.date_from===t.date_to?s.date=t.date_from:(s.date_from=t.date_from,s.date_to=t.date_to):(t.date_from&&(s.date_from=t.date_from),t.date_to&&(s.date_to=t.date_to)),await v(s)},O=f.useCallback(async t=>{try{const s=_&&_.find(a=>a.mr_number===t);if(!s)return;const m=(await S.get(F.material_requisition.details(s.id))).data?.material_requisition;if(m?.items?.length>0){const a=m.issue_slips||[],p={};a.forEach(r=>{r.items?.forEach(d=>{const i=d.item_id,b=parseFloat(d.issued_qty)||0;p[i]=(p[i]||0)+b})});const g=m.items.map(r=>{const d=r.item,i=d?.id||r.item_id,b=d?.item_name||r.item_name,j=d?.item_code||r.item_code,C=d?.unit?.unit_name||r.unit?.unit_name||r.item_unit,A=r.quantity_required||r.quantity||r.required_qty,ee=d?.balance_quantity||"0",D=p[i]||0,te=parseFloat(A)||0,se=D>=te;return{item_id:i?.toString()||"",item_name:b||"",item_code:j||"",item_unit:C||"",required_qty:A?.toString()||"",issued_qty:"",total_issued_qty:D.toString(),is_fully_fulfilled:se,balance_quantity:ee}});q("items",g),h.success(`Loaded ${g.length} items from MR ${t}`)}else q("items",N.items),h.info("No items found for the selected MR")}catch(s){console.error("Failed to fetch MR details:",s),h.error("Failed to load MR details")}},[_,q]),k=f.useCallback(async()=>{if(n){$(!0);try{const t=await S.get(F.issue_slips.details(Number(n))),s=t.data.slip||t.data.data||t.data;R({mr:s.mr,machine:s.machine_id?String(s.machine_id):s.machine?String(s.machine):"",for_party:s.for_party??"",for_mines:s.for_mines??"",issued_to:s.issued_for??s.issued_to??"",purpose:s.purpose??"",items:s.items?.map(l=>({item_id:l.item_id?.toString()||"",item_code:l.item?.item_code||"",item_name:l.item?.item_name||"",item_unit:l.item?.unit?.unit_name||"",required_qty:l.required_qty?.toString()||"",issued_qty:l.issued_qty?.toString()||""}))||N.items})}finally{$(!1)}}},[n,R]);f.useEffect(()=>{n&&k()},[n,k]),f.useEffect(()=>{o&&!n&&_&&_.length>0?O(o):!o&&!n&&q("items",N.items)},[o,n,_,O,q]);const Z=async t=>{const s=t.items.filter(a=>a.item_id&&a.issued_qty&&Number(a.issued_qty)>0);if(s.length===0){h.error("Please enter issued quantity for at least one item");return}const l=[];if(s.forEach(a=>{const p=parseFloat(a.required_qty||"0"),g=parseFloat(a.total_issued_qty||"0"),r=Math.max(0,p-g),d=parseFloat(a.issued_qty||"0");d>r&&l.push(`${a.item_name}: Cannot issue ${d}, only ${r.toFixed(3)} remaining`)}),l.length>0){h.error(e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:"Issued quantity exceeds remaining quantity:"}),e.jsx("ul",{className:"list-disc pl-5 mt-2",children:l.map((a,p)=>e.jsx("li",{children:a},p))})]}),{autoClose:8e3});return}E(!0);const m={mr:t.mr,branch_id:L,machine_id:t.machine?Number(t.machine):null,for_party:t.for_party||null,for_mines:t.for_mines||null,issued_for:t.issued_to||null,purpose:t.purpose||null,items:s.map(a=>({item_id:Number(a.item_id),required_qty:Number(a.required_qty)||0,issued_qty:Number(a.issued_qty),transaction_type:"opening_stock"}))};console.log("Submitting payload:",m);try{const a=n?F.issue_slips.update(Number(n)):F.issue_slips.create;await(n?S.put:S.post)(a,m),h.success(n?"Issue slip updated successfully":"Issue slip created successfully"),w(le.ISSUE_SLIP.LIST)}catch(a){console.error("Error submitting issue slip:",a),console.error("Error response:",a.response?.data),h.error(a.response?.data?.message||"Failed to save issue slip")}finally{E(!1)}};return U?e.jsx("div",{className:"flex justify-center py-20",children:e.jsx(fe,{})}):e.jsxs("div",{className:"w-full h-full overflow-auto space-y-8 p-4 pb-20",children:[e.jsx(ne,{title:n?"Edit Issue Slip":"Create Issue Slip",subtitle:n?"Update the Issue Slip details":"Fill out the form to submit a new Issue Slip"}),e.jsx(je,{fields:Y,onFilter:X,defaultValues:H}),e.jsxs("div",{className:"grid grid-cols-2 gap-5 ml-2 mr-5",children:[e.jsx(c,{name:"mr",control:u,render:({field:t})=>e.jsxs("div",{children:[e.jsxs("label",{className:"text-sm font-semibold text-gray-700 mb-1",children:["Issued To MR ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{...t,disabled:!!n,className:"w-full h-[45px] rounded-lg border border-gray-300 px-4 mt-1 text-sm",children:[e.jsx("option",{value:"",children:"Select Material Requisition"}),_&&_.length>0?_.map(s=>e.jsxs("option",{value:s.mr_number,children:[s.mr_number," - ",s.department||"Unknown Dept"]},s.mr_number)):e.jsx("option",{disabled:!0,children:"No Material Requisitions Available"})]}),y.mr?.message&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:y.mr.message})]})}),e.jsx(c,{name:"machine",control:u,render:({field:t})=>e.jsxs(oe,{...t,label:"For Machine",error:y.machine?.message,children:[e.jsx("option",{value:"",children:"Select Machine (Optional)"}),B.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})}),e.jsx(c,{name:"for_party",control:u,render:({field:t})=>e.jsx(I,{...t,label:"For Party",placeholder:"Enter Party Name (Optional)",error:y.for_party?.message})}),e.jsx(c,{name:"for_mines",control:u,render:({field:t})=>e.jsx(I,{...t,label:"For Mines",placeholder:"Enter Mine (Optional)",error:y.for_mines?.message})}),e.jsx(c,{name:"issued_to",control:u,render:({field:t})=>e.jsx(I,{...t,label:"Issued To",placeholder:"Enter Name (Optional)",error:y.issued_to?.message})}),e.jsx(c,{name:"purpose",control:u,render:({field:t})=>e.jsx(I,{...t,label:"Purpose",placeholder:"Enter Purpose (Optional)",error:y.purpose?.message})})]}),e.jsxs(de,{title:"Items to Issue",children:[e.jsx("div",{className:"flex justify-end mb-2",children:!o&&e.jsx(M,{className:"bg-red-600 text-white px-3 py-1",onClick:()=>J({...N.items[0]}),children:"+ Add Item"})}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(ue,{children:[e.jsx(ce,{cols:[{title:"Item Name"},{title:"Item Code"},{title:"Item Unit"},{title:"Required QTY"},{title:"Total Issued"},{title:"Issued QTY"},{title:"Balance QTY"},{title:"Status"},{title:"Action"}]}),e.jsx("tbody",{children:G.map((t,s)=>{const l=P(`items.${s}`),m=l?.is_fully_fulfilled||!1,a=l?.total_issued_qty||"0",p=parseFloat(l?.required_qty||"0"),g=parseFloat(a),r=Math.max(0,p-g),d=parseFloat(l?.balance_quantity||"0");return e.jsxs("tr",{className:"align-middle",children:[e.jsx(x,{children:s+1}),e.jsx(x,{children:e.jsx(c,{name:`items.${s}.item_name`,control:u,render:({field:i})=>e.jsx("input",{...i,readOnly:!!o,className:`w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm ${o?"bg-gray-50":""}`,placeholder:"Item Name"})})}),e.jsx(x,{children:e.jsx(c,{name:`items.${s}.item_code`,control:u,render:({field:i})=>e.jsx("input",{...i,readOnly:!!o,className:`w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm ${o?"bg-gray-50":""}`,placeholder:"Code"})})}),e.jsx(x,{children:e.jsx(c,{name:`items.${s}.item_unit`,control:u,render:({field:i})=>e.jsx("input",{...i,readOnly:!!o,className:`w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm ${o?"bg-gray-50":""}`,placeholder:"Unit"})})}),e.jsx(x,{children:e.jsx(c,{name:`items.${s}.required_qty`,control:u,render:({field:i})=>e.jsx("input",{...i,type:"number",readOnly:!!o,className:`w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm ${o?"bg-gray-50":""}`,placeholder:"0"})})}),e.jsx(x,{children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:`text-sm font-medium ${m?"text-green-600":"text-gray-700"}`,children:a}),o&&e.jsxs("span",{className:"text-xs text-gray-500",children:["Remaining: ",r.toFixed(3)]})]})}),e.jsx(x,{children:e.jsx(c,{name:`items.${s}.issued_qty`,control:u,render:({field:i})=>e.jsx("input",{...i,type:"number",step:"0.001",readOnly:m,disabled:m,className:`w-full h-[40px] border rounded-lg px-3 text-sm ${m?"bg-gray-100 border-gray-300 cursor-not-allowed text-gray-500":"border-gray-300"}`,placeholder:m?"Fulfilled":"0",max:r,title:m?"This item is fully fulfilled":`Maximum: ${r.toFixed(3)}`,onChange:b=>{const j=b.target.value;parseFloat(j)>r?(i.onChange(r.toString()),h.warning(`Cannot issue more than ${r.toFixed(3)} for ${l.item_name}`,{autoClose:3e3})):i.onChange(j)},onBlur:b=>{const j=b.target.value;parseFloat(j)>r&&i.onChange(r.toString())}})})}),e.jsx(x,{children:e.jsx("div",{className:"flex flex-col items-center",children:e.jsx("span",{className:`text-sm font-medium ${d<0?"text-red-600":d===0?"text-orange-600":"text-blue-600"}`,children:d.toFixed(3)})})}),e.jsx(x,{children:o&&e.jsx("div",{className:"flex justify-start",children:m?e.jsx("span",{className:"px-2 py-1 text-xs font-semibold text-green-800 bg-green-100 rounded-full",children:"Fulfilled"}):g>0?e.jsx("span",{className:"px-2 py-1 text-xs font-semibold text-yellow-800 bg-yellow-100 rounded-full",children:"Partial"}):e.jsx("span",{className:"px-2 py-1 text-xs font-semibold text-gray-800 bg-gray-100 rounded-full",children:"Pending"})})}),e.jsx(x,{children:e.jsx(me,{children:!o&&e.jsx(pe,{onClick:()=>K(s)})})})]},t.id)})})]})})]}),e.jsxs("div",{className:"flex justify-end gap-3 mr-5",children:[e.jsx(M,{variant:"outline",onClick:()=>w(-1),children:"Cancel"}),e.jsx(M,{className:"bg-red-600 text-white",onClick:z(Z),loading:T,disabled:T,children:n?"Update Issue Slip":"Submit Issue Slip"})]})]})};export{Oe as default};
