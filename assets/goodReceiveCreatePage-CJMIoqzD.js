import{u as X,i as Y,a as Z,r as u,j as e,B as k,A as R,h as f,e as j,y}from"./index-B2Kq7pF4.js";import{T as o}from"./TextInput-D6Nk2HMm.js";import{S as ee}from"./Select-B7UTEZjZ.js";import{L as re}from"./ListWrapper-BCNScaty.js";import{T as ae,a as te,b as m}from"./TableWrapper-jqHXbh_L.js";import{T as se}from"./TableRow-BJlAj-zV.js";import{o as ne,j as le}from"./yup-CzgU9FQc.js";import{u as ie,b as de,C as d}from"./index.esm-B19_P2AP.js";import{L as ce}from"./Loading-OOr2nQlv.js";import{F as oe}from"./FormHeader-CQNygXHB.js";import{C as me}from"./CommonFilter-DYIt7Pg1.js";import"./BackButton-D6lHrR0A.js";const ue={purchase_order_id:0,grn_date:new Date().toISOString().split("T")[0],delivery_challan_no:"",delivery_challan_date:"",purchase_order_no:"",purchase_order_date:"",items:[]},C=h=>{if(!h)return"";const b=new Date(h);return isNaN(b.getTime())?"":b.toISOString().split("T")[0]};function we(){const h=X(),[b]=Y(),l=b.get("editId"),{selectedBranchId:P,user:V}=Z(),[Q,A]=u.useState([]),[$,E]=u.useState(null),[U,v]=u.useState(!1),[O,I]=u.useState(!1),[T,D]=u.useState(!1),[_,B]=u.useState({po_number:"",date_from:"",date_to:""}),{control:i,handleSubmit:H,watch:W,reset:G,setValue:S,formState:{errors:x}}=ie({defaultValues:ue,resolver:ne(le)}),{fields:F,replace:L}=de({control:i,name:"items"}),N=W("purchase_order_id");u.useEffect(()=>{(async()=>{D(!0);try{const r={per_page:1e3,status:["Sent_to_Vendor"],is_fully_received:0,branch_id:P};_.po_number&&(r.po_number=_.po_number),_.date_from&&(r.date_from=_.date_from),_.date_to&&(r.date_to=_.date_to);const q=((await f.get(j.purchase_order.list,{params:r,paramsSerializer:p=>{const c=new URLSearchParams;return Object.entries(p).forEach(([w,g])=>{Array.isArray(g)?g.forEach(M=>c.append(`${w}[]`,M)):c.append(w,String(g))}),c.toString()}})).data.purchase_orders||[]).filter(p=>!p.items||p.items.length===0?!1:p.items.some(c=>{const w=c.quantity_ordered||0,g=c.quantity_received||0;return w>g}));A(q)}catch(t){console.log(t),y.error("Failed to fetch Purchase Orders")}finally{D(!1)}})()},[P,_]),u.useEffect(()=>{l&&(async()=>{v(!0);try{const r=(await f.get(j.grn.details(parseInt(l)))).data.grn;G({purchase_order_id:r.purchase_order_id,grn_date:C(r.grn_date),delivery_challan_no:r.delivery_challan_no||"",delivery_challan_date:C(r.delivery_challan_date),items:r.items.map(a=>({id:a.id,po_item_id:a.po_item_id,item_id:a.item_id,item_name:a.item?.item_name||a.item_name||"",item_code:a.item?.item_code||a.item_code||"",unit_name:a.item?.unit?.unit_name||a.item_unit||"",quantity_received:a.quantity_received||0,actual_require_qty:a.actual_require_qty||0,purchase_order_quantity:a.purchase_order_quantity||0,short_qty:a.short_qty||0,excess_qty:a.excess_qty||0,pending_quantity:a.pending_quantity||0,remarks:a.remarks||""}))}),E({...r.purchase_order,vendor:r.vendor||r.purchase_order?.vendor,branch:r.branch||r.purchase_order?.branch})}catch(t){console.log(t),y.error("Failed to load GRN data"),h(R.GOOD_RECEIVE_REPORT.LIST)}finally{v(!1)}})()},[l,G,h]),u.useEffect(()=>{(async()=>{if(N&&N>0&&!l){v(!0);try{const t=await f.get(j.purchase_order.details(N)),r=t.data.purchase_order||t.data.data;if(r){E(r),S("purchase_order_no",r.po_number),S("purchase_order_date",C(r.po_date));const a=(r.items||[]).map(s=>{const q=Number(s.quantity_ordered)||0,p=Number(s.quantity_received)||0,c=q-p;return{po_item_id:s.id,item_id:s.item_id,item_name:s.item?.item_name||s.item_name||"",item_code:s.item?.item_code||s.item_code||"",unit_name:s.item?.unit?.unit_name||s.item_unit||s.unit||"",quantity_received:0,actual_require_qty:c>0?c:0,purchase_order_quantity:q,short_qty:0,excess_qty:0,pending_quantity:c>0?c:0,remarks:""}});L(a)}}catch(t){console.log(t),y.error("Failed to fetch Purchase Order details")}finally{v(!1)}}})()},[N,l,L,S]);const z=[{name:"po_number",label:"PO Number",type:"text",placeholder:"Enter PO Number"},{name:"date_from",label:"Date From",type:"date"},{name:"date_to",label:"Date To",type:"date"}],J=n=>{B(n)},K=async n=>{const t=n.items.map(a=>{const s={po_item_id:a.po_item_id,quantity_received:a.quantity_received,actual_require_qty:a.actual_require_qty,purchase_order_quantity:a.purchase_order_quantity,short_qty:a.short_qty,excess_qty:a.excess_qty,pending_quantity:a.pending_quantity,remarks:a.remarks};return l&&a.id&&(s.id=a.id),s});if(t.length===0){y.error("Please enter quantity received for at least one item");return}const r={grn_date:n.grn_date,delivery_challan_no:n.delivery_challan_no||null,delivery_challan_date:n.delivery_challan_date||null,branch_id:P,items:t};l||(r.purchase_order_id=n.purchase_order_id),I(!0);try{l?(await f.put(j.grn.update(parseInt(l)),r),y.success("GRN updated successfully")):(await f.post(j.grn.create,r),y.success("GRN created successfully")),h(R.GOOD_RECEIVE_REPORT.LIST)}catch(a){console.log(a),y.error(a.response?.data?.message||"Failed to save GRN")}finally{I(!1)}};return U?e.jsx("div",{className:"flex justify-center py-20",children:e.jsx(ce,{})}):e.jsxs("div",{className:"w-full h-full overflow-auto space-y-8 p-4 pb-20",children:[e.jsx("div",{className:"space-y-1",children:e.jsx(oe,{title:l?"Edit GRN":"Create Goods Receipt Note (GRN)",subtitle:l?"Update the GRN details":"Select a Purchase Order and enter received quantities"})}),e.jsxs(e.Fragment,{children:[e.jsx(me,{fields:z,onFilter:J,defaultValues:_}),e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-lg font-semibold mb-4",children:"GRN Details"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-5",children:[e.jsx(d,{name:"purchase_order_id",control:i,render:({field:n})=>e.jsxs(ee,{...n,label:"Select Purchase Order",required:!0,error:x.purchase_order_id?.message,disabled:!!l||T,onChange:t=>{n.onChange(parseInt(t.target.value)||0)},children:[e.jsx("option",{value:"",children:T?"Loading...":"Select Purchase Order"}),Q.map(t=>e.jsxs("option",{value:t.id,children:[t.po_number," - ",t.vendor?.party_name]},t.id))]})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Vendor"}),e.jsx("p",{className:"text-gray-900 bg-gray-100 px-3 py-2 rounded-lg min-h-[42px] flex items-center",children:$?.vendor?.party_name||"-"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Branch"}),e.jsx("p",{className:"text-gray-900 bg-gray-100 px-3 py-2 rounded-lg min-h-[42px] flex items-center",children:V?.branch?.branch_name||"Udaipur Head Office"})]}),e.jsx(d,{name:"purchase_order_no",control:i,render:({field:n})=>e.jsx(o,{...n,label:"Purchase Order No",placeholder:"Enter Purchase Order No",error:x.purchase_order_no?.message})}),e.jsx(d,{name:"purchase_order_date",control:i,render:({field:n})=>e.jsx(o,{...n,type:"date",label:"Purchase Order Date",error:x.purchase_order_date?.message})}),e.jsx(d,{name:"delivery_challan_no",control:i,render:({field:n})=>e.jsx(o,{...n,label:"Challan No",placeholder:"Enter Challan No",error:x.delivery_challan_no?.message})}),e.jsx(d,{name:"delivery_challan_date",control:i,render:({field:n})=>e.jsx(o,{...n,type:"date",label:"Challan Date",error:x.delivery_challan_date?.message})})]})]}),e.jsx(re,{title:"Items to Receive",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(ae,{children:[e.jsx(te,{cols:[{title:"Item Name"},{title:"Item Code"},{title:"Unit"},{title:"Received Qty"},{title:"Actual Req Qty"},{title:"P.O. Qty"},{title:"Short Qty"},{title:"Excess Qty"},{title:"Pending Qty"},{title:"Remarks"}]}),e.jsx("tbody",{children:F.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:11,className:"text-center py-8 text-gray-500",children:"No items found in selected Purchase Order"})}):F.map((n,t)=>e.jsxs(se,{children:[e.jsx(m,{className:"text-center w-16",children:t+1}),e.jsx(m,{className:"min-w-[200px]",children:e.jsx("span",{className:"font-medium text-sm",children:n.item_name})}),e.jsx(m,{className:"min-w-[120px] text-sm",children:n.item_code}),e.jsx(m,{className:"min-w-[80px] text-sm",children:n.unit_name}),e.jsx(m,{className:"min-w-[120px]",children:e.jsx(d,{name:`items.${t}.quantity_received`,control:i,render:({field:r})=>e.jsx(o,{...r,type:"number",placeholder:"Qty",className:"w-full min-w-[100px]",error:x.items?.[t]?.quantity_received?.message,onChange:a=>{const s=a.target.value;r.onChange(s===""?"":Number(s))}})})}),e.jsx(m,{className:"min-w-[100px]",children:e.jsx(d,{name:`items.${t}.actual_require_qty`,control:i,render:({field:r})=>e.jsx(o,{...r,type:"number",placeholder:"Req Qty",className:"w-full min-w-[90px]",onChange:a=>{const s=a.target.value;r.onChange(s===""?"":Number(s))}})})}),e.jsx(m,{className:"min-w-[100px]",children:e.jsx(d,{name:`items.${t}.purchase_order_quantity`,control:i,render:({field:r})=>e.jsx(o,{...r,type:"number",placeholder:"PO Qty",className:"w-full min-w-[90px]"})})}),e.jsx(m,{className:"min-w-[120px]",children:e.jsx(d,{name:`items.${t}.short_qty`,control:i,render:({field:r})=>e.jsx(o,{...r,type:"number",placeholder:"Short",className:"w-full min-w-[100px]",onChange:a=>{const s=a.target.value;r.onChange(s===""?"":Number(s))}})})}),e.jsx(m,{className:"min-w-[120px]",children:e.jsx(d,{name:`items.${t}.excess_qty`,control:i,render:({field:r})=>e.jsx(o,{...r,type:"number",placeholder:"Excess",className:"w-full min-w-[100px]",onChange:a=>{const s=a.target.value;r.onChange(s===""?"":Number(s))}})})}),e.jsx(m,{className:"min-w-[120px]",children:e.jsx(d,{name:`items.${t}.pending_quantity`,control:i,render:({field:r})=>e.jsx(o,{...r,type:"number",placeholder:"Pending",className:"w-full min-w-[100px]",onChange:a=>{const s=a.target.value;r.onChange(s===""?"":Number(s))}})})}),e.jsx(m,{className:"min-w-[150px]",children:e.jsx(d,{name:`items.${t}.remarks`,control:i,render:({field:r})=>e.jsx(o,{...r,placeholder:"Remarks",className:"w-full min-w-[130px]"})})})]},n.id))})]})})}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx(k,{variant:"outline",onClick:()=>h(R.GOOD_RECEIVE_REPORT.LIST),disabled:O,children:"Cancel"}),e.jsx(k,{onClick:H(K),loading:O,disabled:O,children:l?"Update GRN":"Create GRN"})]})]})]})}export{we as default};
