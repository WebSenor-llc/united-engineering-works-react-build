import{u as H,i as W,a as w,r as n,j as e,B as h,h as _,e as b,y as x,A as Q}from"./index-C-HhpDkY.js";import{T as D}from"./TextInput-DE9vic5T.js";import{L as V}from"./ListWrapper-DOgiLfWA.js";import{T as z}from"./TableActions-DN0qvBjN.js";import{T as G,a as J,b as m}from"./TableWrapper-ClISlYEF.js";import{T as K}from"./TableDelete-BioVSJwJ.js";import{u as X,b as Y,c as Z,C as o}from"./index.esm-BpE9IZoC.js";import{u as ee}from"./useItemsStore-Dz1iYhwF.js";import{L as te}from"./Loading-C6uwP82P.js";import{F as se}from"./FormHeader-CfaYIVJ8.js";import{B as ie}from"./BranchUserSelect-B4DRgvZ5.js";import"./BackButton-CqCim-1U.js";const ae={reason:"",deposited_by:"",recieved_by:"Store",branch_id:"",material_requisition_id:"",item_id:"",quantity_to_deposit:"",quantity_deposited:"",items:[{item_id:"",item_name:"",item_code:"",item_unit:"",qty_to_deposit:"",qty_deposited:""}]},he=()=>{const f=H(),[C]=W(),r=C.get("editId"),{selectedBranchId:c}=w(),{control:a,handleSubmit:I,setValue:T,reset:F,formState:{errors:y}}=X({defaultValues:ae}),{fields:L,append:R,remove:A}=Y({control:a,name:"items"}),E=Z({control:a,name:"items"}),{user:j}=w(),{fetchItems:M}=ee(),[P,g]=n.useState(!1),[q,S]=n.useState(!1),[v,$]=n.useState(!1),[p,B]=n.useState([]),[,N]=n.useState(!1),U=async()=>{N(!0);try{const i=await _.get(b.material_requisition.all,{params:{branch_id:c}});B(i.data.material_requisitions||i.data||[])}catch(i){console.error("Failed to fetch material requests",i),x.error("Failed to load material requests")}finally{N(!1)}};n.useEffect(()=>{(async()=>{await M(),await U(),$(!0)})()},[c]);const k=async()=>{if(r){g(!0);try{const i=await _.get(b.deposit_slip.details(Number(r))),s=i.data.slip||i.data;F({branch_id:s.branch_id?String(s.branch_id):c?String(c):"",material_requisition_id:s.material_requisition_id?String(s.material_requisition_id):"",recieved_by:s.recieved_by,deposited_by:s.deposited_by,reason:s.reason||"",items:(s.items||[]).map(t=>({item_id:t.item_id,item_code:t.item?.item_code||"",item_name:t.item?.item_name||"",item_unit:t.unit?.unit_name||"",qty_to_deposit:t.quantity_to_deposit,qty_deposited:t.quantity_deposited}))})}catch(i){console.error("Failed to load details:",i),x.error("Failed to load deposit slip details")}finally{g(!1)}}};n.useEffect(()=>{r&&v&&k()},[r,v]);const O=async i=>{S(!0);const s={branch_id:c,material_requisition_id:i.material_requisition_id?Number(i.material_requisition_id):null,recieved_by:i.recieved_by,deposited_by:i.deposited_by,reason:i.reason,items:i.items.map(t=>({item_id:Number(t.item_id),quantity_to_deposit:Number(t.qty_to_deposit),quantity_deposited:Number(t.qty_deposited)}))};try{const t=r?b.deposit_slip.update(Number(r)):b.deposit_slip.create;await(r?_.put:_.post)(t,s),f(Q.DEPOSITE_SLIP.LIST)}catch(t){console.error(t),x.error(t.response?.data?.message||"Failed to save deposit slip")}finally{S(!1)}};return P?e.jsx("div",{className:"flex justify-center py-20",children:e.jsx(te,{})}):e.jsxs("div",{className:"w-full h-full overflow-auto space-y-8 p-4 pb-20",children:[e.jsx("div",{className:"space-y-1 ml-2",children:e.jsx(se,{title:r?"Edit Deposit Slip":"Create Deposit Slip",subtitle:r?"Update the Deposit Slip details":"Fill out the form to submit a new Deposit Slip"})}),e.jsxs("div",{className:"grid grid-cols-2 gap-5 ml-2 mr-5",children:[e.jsx(o,{name:"material_requisition_id",control:a,render:({field:i})=>e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-semibold text-gray-700 mb-1",children:"Material Request"}),e.jsxs("select",{...i,className:"w-full h-[45px] rounded-lg border border-gray-300 px-4 mt-1 text-sm",onChange:s=>{const t=s.target.value;if(i.onChange(t),t){const d=p&&p.find(u=>u.id===Number(t));if(d&&d.items&&d.items.length>0){const u=d.items.map(l=>({item_id:l.item?.id||l.item_id||"",item_code:l.item?.item_code||"",item_name:l.item?.item_name||"",item_unit:l.item?.unit?.unit_name||"",qty_to_deposit:l.quantity_required||l.quantity||"",qty_deposited:""}));T("items",u)}}},children:[e.jsx("option",{value:"",children:"Select Material Request"}),p&&p.length>0&&p.map(s=>e.jsxs("option",{value:s.id,children:[s.mr_number," - ",s.department||"Unknown Dept"]},s.id))]})]})}),e.jsx(o,{name:"reason",control:a,render:({field:i})=>e.jsx(D,{...i,label:"Reason for deposing",error:y.reason?.message,placeholder:"Enter reason for deposing"})}),e.jsx(ie,{label:"Deposited By",name:"deposited_by",control:a,branchId:j?.branch?.id||j?.branch_id,error:y.deposited_by?.message}),e.jsx(o,{name:"recieved_by",control:a,render:({field:i})=>e.jsx(D,{...i,label:"Recieved By",error:y.recieved_by?.message})})]}),e.jsxs(V,{title:"Items Requested",children:[e.jsx("div",{className:"flex justify-end mb-2",children:e.jsx(h,{className:"bg-red-600 text-white px-3 py-1",onClick:()=>R({item_id:"",item_name:"",item_code:"",item_unit:"",qty_to_deposit:"",qty_deposited:""}),children:"+ Add Item"})}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(G,{children:[e.jsx(J,{cols:[{title:"Item Name"},{title:"Item Code"},{title:"Item Unit"},{title:"Qty to Deposite"},{title:"Qty Deposited"},{title:"Action"}]}),e.jsx("tbody",{children:L.map((i,s)=>e.jsxs("tr",{className:"align-middle",children:[e.jsx(m,{children:s+1}),e.jsxs(m,{children:[e.jsx(o,{name:`items.${s}.item_id`,control:a,render:()=>{const t=E?.[s],d=t?.item_name,u=t?.item_code;return e.jsx("input",{value:d?`${d} (${u})`:"",className:"w-full h-[45px] rounded-lg border border-gray-300 px-5 mt-1 text-sm bg-gray-50",placeholder:"Item will be auto-filled from MR",readOnly:!0})}}),e.jsx(o,{name:`items.${s}.item_name`,control:a,render:({field:t})=>e.jsx("input",{...t,type:"hidden"})})]}),e.jsx(m,{children:e.jsx(o,{name:`items.${s}.item_code`,control:a,render:({field:t})=>e.jsx("input",{...t,className:"w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm bg-gray-50",placeholder:"Code",readOnly:!0})})}),e.jsx(m,{children:e.jsx(o,{name:`items.${s}.item_unit`,control:a,render:({field:t})=>e.jsx("input",{...t,className:"w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm bg-gray-50",placeholder:"Unit",readOnly:!0})})}),e.jsx(m,{children:e.jsx(o,{name:`items.${s}.qty_to_deposit`,control:a,render:({field:t})=>e.jsx("input",{...t,type:"number",className:"w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm",placeholder:"0"})})}),e.jsx(m,{children:e.jsx(o,{name:`items.${s}.qty_deposited`,control:a,render:({field:t})=>e.jsx("input",{...t,type:"number",className:"w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm",placeholder:"0"})})}),e.jsx(m,{children:e.jsx(z,{children:e.jsx(K,{onClick:()=>A(s)})})})]},i.id))})]})})]}),e.jsxs("div",{className:"flex justify-end gap-3 mr-5",children:[e.jsx(h,{variant:"outline",onClick:()=>f(-1),children:"Cancel"}),e.jsx(h,{className:"bg-red-600 text-white",onClick:I(O),loading:q,disabled:q,children:r?"Update Deposit Slip":"Submit Deposit Slip"})]})]})};export{he as default};
