import{u as X,i as Y,a as Z,r as p,j as e,B as k,A as E,h as v,e as N,y as g}from"./index-CVLuNvHl.js";import{T as h}from"./TextInput-Dp3LUHBy.js";import{S as ee}from"./Select-C6R4wcQV.js";import{L as te}from"./ListWrapper-8iziPijS.js";import{T as re,a as ae,b as c}from"./TableWrapper-4tTsxnyx.js";import{T as se}from"./TableRow-JWYm0EGd.js";import{o as ne,j as ie}from"./yup-BK6Tl6ch.js";import{u as le,b as de,C as _}from"./index.esm-BcaIv3UJ.js";import{L as oe}from"./Loading-DNOjMSnZ.js";import{F as ce}from"./FormHeader-C_h7Soci.js";import{C as me}from"./CommonFilter-CK1Jbfb1.js";import"./BackButton-OhCUJKaV.js";const ue={purchase_order_id:0,grn_date:new Date().toISOString().split("T")[0],delivery_challan_no:"",delivery_challan_date:"",purchase_order_no:"",purchase_order_date:"",items:[]},F=y=>{if(!y)return"";const w=new Date(y);return isNaN(w.getTime())?"":w.toISOString().split("T")[0]};function Oe(){const y=X(),[w]=Y(),o=w.get("editId"),{selectedBranchId:R,user:V}=Z(),[A,U]=p.useState([]),[B,C]=p.useState(null),[H,O]=p.useState(!1),[S,I]=p.useState(!1),[T,D]=p.useState(!1),[x,M]=p.useState({po_number:"",date_from:"",date_to:""}),{control:m,handleSubmit:W,watch:G,reset:$,setValue:q,formState:{errors:b}}=le({defaultValues:ue,resolver:ne(ie)}),{fields:L,replace:Q}=de({control:m,name:"items"}),P=G("purchase_order_id");p.useEffect(()=>{(async()=>{D(!0);try{const r={per_page:1e3,status:["Sent_to_Vendor","partially_received"],is_fully_received:0,branch_id:R};x.po_number&&(r.po_number=x.po_number),x.date_from&&(r.date_from=x.date_from),x.date_to&&(r.date_to=x.date_to);const j=((await v.get(N.purchase_order.list,{params:r,paramsSerializer:n=>{const l=new URLSearchParams;return Object.entries(n).forEach(([i,d])=>{Array.isArray(d)?d.forEach(f=>l.append(`${i}[]`,f)):l.append(i,String(d))}),l.toString()}})).data.purchase_orders||[]).filter(n=>!n.items||n.items.length===0?!1:n.items.some(l=>{const i=l.quantity_ordered||0,d=l.quantity_received||0;return i>d}));U(j)}catch(a){console.log(a),g.error("Failed to fetch Purchase Orders")}finally{D(!1)}})()},[R,x]),p.useEffect(()=>{o&&(async()=>{O(!0);try{const r=(await v.get(N.grn.details(parseInt(o)))).data.grn;$({purchase_order_id:r.purchase_order_id,grn_date:F(r.grn_date),delivery_challan_no:r.delivery_challan_no||"",delivery_challan_date:F(r.delivery_challan_date),items:r.items.map(t=>({id:t.id,po_item_id:t.po_item_id,item_id:t.item_id,item_name:t.item?.item_name||t.item_name||"",item_code:t.item?.item_code||t.item_code||"",item_description:t.item?.description||t.description||"",unit_name:t.item?.unit?.unit_name||t.item_unit||"",quantity_received:t.quantity_received||0,purchase_order_quantity:t.purchase_order_quantity||0,short_quantity:t.short_quantity||0,excess_quantity:t.excess_quantity||0,remarks:t.remarks||""}))}),C({...r.purchase_order,vendor:r.vendor||r.purchase_order?.vendor,branch:r.branch||r.purchase_order?.branch})}catch(a){console.log(a),g.error("Failed to load GRN data"),y(E.GOOD_RECEIVE_REPORT.LIST)}finally{O(!1)}})()},[o,$,y]),p.useEffect(()=>{(async()=>{if(P&&P>0&&!o){O(!0);try{const a=await v.get(N.purchase_order.details(P)),r=a.data.purchase_order||a.data.data;if(r){C(r),q("purchase_order_no",r.po_number),q("purchase_order_date",F(r.po_date));const t=r.grns||[],u={};t.forEach(n=>{n.items?.forEach(l=>{const i=l.po_item_id,d=parseFloat(l.quantity_received)||0;u[i]=(u[i]||0)+d})});const j=(r.items||[]).map(n=>{const l=parseFloat(n.quantity_ordered)||0,i=u[n.id]||0,d=i>=l;return{po_item_id:n.id,item_id:n.item_id,item_name:n.item?.item_name||n.item_name||"",item_code:n.item?.item_code||n.item_code||"",item_description:n.item?.description||n.description||"",unit_name:n.item?.unit?.unit_name||n.item_unit||n.unit||"",quantity_received:0,purchase_order_quantity:l,short_quantity:0,excess_quantity:0,remarks:"",total_received_qty:i,is_fully_received:d}});Q(j)}}catch(a){console.log(a),g.error("Failed to fetch Purchase Order details")}finally{O(!1)}}})()},[P,o,Q,q]);const z=[{name:"po_number",label:"PO Number",type:"text",placeholder:"Enter PO Number"},{name:"date_from",label:"Date From",type:"date"},{name:"date_to",label:"Date To",type:"date"}],J=s=>{M(s)},K=async s=>{const a=s.items.map(t=>{const u={po_item_id:t.po_item_id,quantity_received:t.quantity_received,purchase_order_quantity:t.purchase_order_quantity,short_quantity:t.short_quantity,excess_quantity:t.excess_quantity,remarks:t.remarks};return o&&t.id&&(u.id=t.id),u});if(a.length===0){g.error("Please enter quantity received for at least one item");return}const r={grn_date:s.grn_date,delivery_challan_no:s.delivery_challan_no||null,delivery_challan_date:s.delivery_challan_date||null,branch_id:R,items:a,purchase_order_id:s.purchase_order_id};o&&(r.purchase_order_id=s.purchase_order_id),I(!0);try{o?(await v.put(N.grn.update(parseInt(o)),r),g.success("GRN updated successfully")):(await v.post(N.grn.create,r),g.success("GRN created successfully")),y(E.GOOD_RECEIVE_REPORT.LIST)}catch(t){console.log(t),g.error(t.response?.data?.message||"Failed to save GRN")}finally{I(!1)}};return H?e.jsx("div",{className:"flex justify-center py-20",children:e.jsx(oe,{})}):e.jsxs("div",{className:"w-full h-full overflow-auto space-y-8 p-4 pb-20",children:[e.jsx("div",{className:"space-y-1",children:e.jsx(ce,{title:o?"Edit GRN":"Create Goods Receipt Note (GRN)",subtitle:o?"Update the GRN details":"Select a Purchase Order and enter received quantities"})}),e.jsxs(e.Fragment,{children:[e.jsx(me,{fields:z,onFilter:J,defaultValues:x}),e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-lg font-semibold mb-4",children:"GRN Details"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-5",children:[e.jsx(_,{name:"purchase_order_id",control:m,render:({field:s})=>e.jsxs(ee,{...s,label:"Select Purchase Order",required:!0,error:b.purchase_order_id?.message,disabled:!!o||T,onChange:a=>{s.onChange(parseInt(a.target.value)||0)},children:[e.jsx("option",{value:"",children:T?"Loading...":"Select Purchase Order"}),A.map(a=>e.jsxs("option",{value:a.id,children:[a.po_number," - ",a.vendor?.party_name]},a.id))]})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Vendor"}),e.jsx("p",{className:"text-gray-900 bg-gray-100 px-3 py-2 rounded-lg min-h-[42px] flex items-center",children:B?.vendor?.party_name||"-"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Branch"}),e.jsx("p",{className:"text-gray-900 bg-gray-100 px-3 py-2 rounded-lg min-h-[42px] flex items-center",children:V?.branch?.branch_name||"Udaipur Head Office"})]}),e.jsx(_,{name:"purchase_order_no",control:m,render:({field:s})=>e.jsx(h,{...s,label:"Purchase Order No",placeholder:"Enter Purchase Order No",error:b.purchase_order_no?.message})}),e.jsx(_,{name:"purchase_order_date",control:m,render:({field:s})=>e.jsx(h,{...s,type:"date",label:"Purchase Order Date",error:b.purchase_order_date?.message})}),e.jsx(_,{name:"delivery_challan_no",control:m,render:({field:s})=>e.jsx(h,{...s,label:"Challan/Invoice No",placeholder:"Enter Challan No",error:b.delivery_challan_no?.message})}),e.jsx(_,{name:"delivery_challan_date",control:m,render:({field:s})=>e.jsx(h,{...s,type:"date",label:"Challan Date",error:b.delivery_challan_date?.message})})]})]}),e.jsx(te,{title:"Items to Receive",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(re,{children:[e.jsx(ae,{cols:[{title:"Item Name"},{title:"Item Code"},{title:"Item Description"},{title:"Unit"},{title:"P.O. Qty"},{title:"Total Received"},{title:"Received Qty"},{title:"Short Qty"},{title:"Excess Qty"},{title:"Status"},{title:"Remarks"}]}),e.jsx("tbody",{children:L.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:11,className:"text-center py-8 text-gray-500",children:"No items found in selected Purchase Order"})}):L.map((s,a)=>{const r=G(`items.${a}`),t=r?.is_fully_received||!1,u=r?.total_received_qty||0,j=parseFloat(r?.purchase_order_quantity||"0"),n=parseFloat(u),l=Math.max(0,j-n);return e.jsxs(se,{children:[e.jsx(c,{className:"text-center w-16",children:a+1}),e.jsx(c,{className:"min-w-[200px]",children:e.jsx("span",{className:"font-medium text-sm",children:s.item_name})}),e.jsx(c,{className:"min-w-[120px] text-sm",children:s.item_code}),e.jsx(c,{className:"min-w-[150px] text-sm",children:s.item_description||"-"}),e.jsx(c,{className:"min-w-[80px] text-sm",children:s.unit_name}),e.jsx(c,{className:"min-w-[100px]",children:e.jsx(_,{name:`items.${a}.purchase_order_quantity`,control:m,render:({field:i})=>e.jsx(h,{...i,type:"number",placeholder:"PO Qty",className:"w-full min-w-[90px] bg-gray-50",readOnly:!0})})}),e.jsx(c,{className:"min-w-[120px]",children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:`text-sm font-medium ${t?"text-green-600":"text-gray-700"}`,children:u}),e.jsxs("span",{className:"text-xs text-gray-500",children:["Remaining: ",l.toFixed(3)]})]})}),e.jsx(c,{className:"min-w-[120px]",children:e.jsx(_,{name:`items.${a}.quantity_received`,control:m,render:({field:i})=>e.jsx(h,{...i,type:"number",placeholder:t?"Fulfilled":"Qty",className:`w-full min-w-[100px] ${t?"bg-gray-100 cursor-not-allowed":""}`,error:b.items?.[a]?.quantity_received?.message,onChange:d=>i.onChange(d.target.value),readOnly:t,disabled:t,max:l,title:t?"This item is fully received":`Maximum: ${l.toFixed(3)}`})})}),e.jsx(c,{className:"min-w-[120px]",children:e.jsx(_,{name:`items.${a}.short_quantity`,control:m,render:({field:i})=>e.jsx(h,{...i,type:"number",placeholder:"Short",className:`w-full min-w-[100px] ${t?"bg-gray-100 cursor-not-allowed":""}`,onChange:d=>{const f=d.target.value;i.onChange(f===""?"":Number(f))},readOnly:t,disabled:t})})}),e.jsx(c,{className:"min-w-[120px]",children:e.jsx(_,{name:`items.${a}.excess_quantity`,control:m,render:({field:i})=>e.jsx(h,{...i,type:"number",placeholder:"Excess",className:`w-full min-w-[100px] ${t?"bg-gray-100 cursor-not-allowed":""}`,onChange:d=>{const f=d.target.value;i.onChange(f===""?"":Number(f))},readOnly:t,disabled:t})})}),e.jsx(c,{className:"min-w-[100px]",children:e.jsx("div",{className:"flex justify-center",children:t?e.jsx("span",{className:"px-2 py-1 text-xs font-semibold text-green-800 bg-green-100 rounded-full",children:"Fulfilled"}):n>0?e.jsx("span",{className:"px-2 py-1 text-xs font-semibold text-yellow-800 bg-yellow-100 rounded-full",children:"Partial"}):e.jsx("span",{className:"px-2 py-1 text-xs font-semibold text-gray-800 bg-gray-100 rounded-full",children:"Pending"})})}),e.jsx(c,{className:"min-w-[150px]",children:e.jsx(_,{name:`items.${a}.remarks`,control:m,render:({field:i})=>e.jsx(h,{...i,placeholder:"Remarks",className:`w-full min-w-[130px] ${t?"bg-gray-100 cursor-not-allowed":""}`,readOnly:t,disabled:t})})})]},s.id)})})]})})}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx(k,{variant:"outline",onClick:()=>y(E.GOOD_RECEIVE_REPORT.LIST),disabled:S,children:"Cancel"}),e.jsx(k,{onClick:W(K),loading:S,disabled:S,children:o?"Update GRN":"Create GRN"})]})]})]})}export{Oe as default};
