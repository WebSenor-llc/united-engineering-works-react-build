import{r as m,a as Y,j as e,B as b,h as E,e as I,y as C,b as oe,u as ce,A as G}from"./index-QEJ2HCdw.js";import{S as le}from"./Select-D60uqtBY.js";import{T as g}from"./TextInput-BdJuYdFC.js";import{T as X}from"./TextArea-CjsnLDln.js";import{L as me}from"./ListWrapper-oJvLtNe1.js";import{T as l}from"./TableData-g3n0MGbp.js";import{T as _e,a as ue}from"./TableWrapper-D9k17eub.js";import{u as Z,C as _,c as pe}from"./index.esm-Bd1pinfN.js";import{o as ee,r as he,t as D,v as xe}from"./yup-Dt7c8rJX.js";import{L as ge}from"./Loading-BUzEJx3P.js";import{F as ve}from"./FormHeader-BVmIKXpM.js";import{B as ye}from"./BaseModal-DCaDQrbd.js";import{C as be}from"./CommonFilter-5OTEYuSH.js";import"./BackButton-8FL22_V2.js";const je=he().shape({expected_delivery_date:D().required("Expected delivery date is required"),delivery_address:D().required("Delivery address is required"),delivery_contact_person:D().required("Contact person is required"),delivery_contact_phone:D().trim().transform(u=>u&&`+91${u.replace(/\D/g,"").replace(/^91/,"")}`).test("is-ten-digits","Phone number must be exactly 10 digits",u=>u?u.replace(/\D/g,"").replace(/^91/,"").length===10:!1).required("Contact phone is required"),special_instructions:D().optional()}),fe=({open:u,onClose:p,vendorId:n,vendorName:j,csId:F,branchId:T,items:f,onSuccess:d})=>{const[q,o]=m.useState(!1),{control:x,handleSubmit:O,formState:{errors:c},reset:A}=Z({resolver:ee(je),defaultValues:{expected_delivery_date:"",delivery_address:"",delivery_contact_person:"",delivery_contact_phone:"",special_instructions:""}}),{user:R}=Y(),L=R?.id,N=async i=>{o(!0);try{const v={...i,vendor_id:n,created_by:L,comparative_statement_id:F,branch_id:T,items:f.map(h=>({item_id:h.item_id,quantity_ordered:h.quantity_ordered,unit_price:h.rate,discount_percentage:h.discount_percentage,tax_percentage:h.tax_percentage,total_price:h.total_price,branch_id:T}))};await E.post(I.purchase_order.create,v),C.success(`Purchase Order generated for ${j}`),A(),d(),p()}catch(v){console.error(v),C.error("Failed to generate Purchase Order")}finally{o(!1)}};return e.jsx(ye,{open:u,onClose:p,title:`Generate PO for ${j}`,maxWidth:"max-w-2xl",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"max-h-[60vh] overflow-y-auto pr-2 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 ml-1",children:[e.jsx(_,{name:"expected_delivery_date",control:x,render:({field:i})=>e.jsx(g,{...i,type:"date",label:"Expected Delivery Date",error:c.expected_delivery_date?.message})}),e.jsx(_,{name:"delivery_contact_person",control:x,render:({field:i})=>e.jsx(g,{...i,label:"Delivery Contact Person",error:c.delivery_contact_person?.message})}),e.jsx(_,{name:"delivery_contact_phone",control:x,render:({field:i})=>e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("label",{className:"text-sm font-semibold text-gray-700 mb-1",children:["Delivery Contact Phone ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"px-3 py-3 bg-gray-100 border border-gray-300 rounded-lg text-gray-700 text-sm",children:"+91"}),e.jsx(g,{...i,type:"tel",maxLength:10,placeholder:"Enter 10 digit mobile number",className:"mb-0 flex-1",onChange:v=>{const h=v.target.value.replace(/\D/g,"");i.onChange(h)}})]}),c.delivery_contact_phone?.message&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:c.delivery_contact_phone.message})]})}),e.jsx(_,{name:"delivery_address",control:x,render:({field:i})=>e.jsx(g,{...i,label:"Delivery Address",error:c.delivery_address?.message})})]}),e.jsx("div",{className:"ml-1",children:e.jsx(_,{name:"special_instructions",control:x,render:({field:i})=>e.jsx(g,{...i,label:"Special Instructions",error:c.special_instructions?.message})})})]}),e.jsxs("div",{className:"flex justify-end pt-4 space-x-3",children:[e.jsx(b,{variant:"outline",onClick:p,disabled:q,children:"Cancel"}),e.jsx(b,{onClick:O(N),loading:q,children:"Generate Purchase Order"})]})]})})},Ne={vendor_id:0,branch_id:0,comparative_statement_id:0,expected_delivery_date:"",delivery_address:"",delivery_contact_person:"",delivery_contact_phone:"",special_instructions:"",items:[{item_id:0,item_name:"",item_code:"",item_unit:"",quantity_ordered:0,unit:"",unit_price:0,discount_percentage:0,tax_percentage:0,total_price:0,rate:"0"}]},Ge=()=>{const[u]=oe(),p=ce(),n=u.get("editId"),[j,F]=m.useState([]),[T,f]=m.useState(!1),[d,q]=m.useState(null),{selectedBranchId:o}=Y(),[x,O]=m.useState(!1),[c,A]=m.useState(null),[R,L]=m.useState({}),[N,i]=m.useState(!1),v=[{name:"statement_number",label:"Statement Number",placeholder:"Enter statement number"},{name:"mr_number",label:"MR Number",placeholder:"Enter MR number"},{name:"item_name",label:"Item Name",placeholder:"Enter item name"},{name:"date_from",label:"Date From",type:"date",placeholder:"Select start date"},{name:"date_to",label:"Date To",type:"date",placeholder:"Select end date"}],h=async r=>{if(!o)return;L(r);const a={branch_id:o};r.statement_number&&(a.statement_number=r.statement_number),r.mr_number&&(a.mr_number=r.mr_number),r.item_name&&(a.item_name=r.item_name),r.date_from&&r.date_to?r.date_from===r.date_to?a.date=r.date_from:(a.date_from=r.date_from,a.date_to=r.date_to):(r.date_from&&(a.date_from=r.date_from),r.date_to&&(a.date_to=r.date_to)),f(!0);try{const t=await E.get(I.comparative_statement.items,{params:a});F(t.data?.statements||[])}catch(t){console.error("Error filtering comparative statements:",t)}finally{f(!1)}},{control:y,setValue:U,reset:k,handleSubmit:te,formState:{errors:S}}=Z({defaultValues:Ne,resolver:ee(xe)}),P=pe({control:y,name:"comparative_statement_id"}),B=async()=>{if(o){f(!0);try{const r=await E.get(I.comparative_statement.items,{params:{branch_id:o}});F(r.data?.statements||[])}catch(r){console.error(r)}finally{f(!1)}}};m.useEffect(()=>{B()},[o]),m.useEffect(()=>{if(!n)return;(async()=>{i(!0);try{const a=await E.get(I.purchase_order.details(Number(n))),t=a.data?.purchase_order||a.data?.purchaseOrder||a.data;t&&(q(t),k({branch_id:t.branch_id||o,vendor_id:t.vendor_id||0,comparative_statement_id:t.comparative_statement_id||0,expected_delivery_date:t.expected_delivery_date?t.expected_delivery_date.split("T")[0]:"",delivery_address:t.delivery_address||"",delivery_contact_person:t.delivery_contact_person||"",delivery_contact_phone:t.delivery_contact_phone||"",special_instructions:t.special_instructions||"",items:(t.items||[]).map(s=>({item_id:s.item_id||0,item_name:s.item?.item_name||"",item_code:s.item?.item_code||"",item_unit:s.item?.unit?.unit_symbol||"",quantity_ordered:Number(s.quantity_ordered)||0,unit:s.item?.unit?.unit_symbol||"",unit_price:Number(s.unit_price)||0,discount_percentage:Number(s.discount_percentage)||0,tax_percentage:Number(s.tax_percentage)||0,total_price:Number(s.total_price)||0,rate:String(s.unit_price||0)}))}),U("comparative_statement_id",t.comparative_statement_id||0))}catch(a){console.error("Error loading PO details:",a),C.error("Failed to load Purchase Order details"),p(G.PURCHASE_ORDER.LIST)}finally{i(!1)}})()},[n,U,k,o,p]);const H=m.useMemo(()=>{if(!P)return{};const r=j.find(t=>t.id===P);if(!r||!r.items)return{};console.log("Selected CS:",r);const a={};if(r.items.forEach(t=>{const s=t.selected_vendor?.id||t.selected_vendor_id;if(!s)return;if(!a[s]){const w=r.vendors_with_po_status?.find(ie=>ie.vendor_id===s);a[s]={vendor:t.selected_vendor,items:[],all_items_have_po:!!w?.allItemsHavePo,po_items:n&&d?(d.items||[]).filter(()=>d.vendor_id===s):[]}}const $=Number(t.quantity)||0,V=Number(t.selected_vendor_rate_details?.rate)||0,M=Number(t.selected_vendor_rate_details?.discount_percentage)||0,W=Number(t.selected_vendor_rate_details?.gst_percentage)||0,Q=Number(t.selected_vendor_rate_details?.loading_charges)||0,z=Number(t.selected_vendor_rate_details?.freight_charges)||0,J=Number(t.selected_vendor_rate_details?.cutting_charges)||0,ae=V*(M/100),K=(V-ae)*$,se=K*(W/100),ne=Number((K+se+Q+z+J).toFixed(2)),de=n&&d&&d.items?.some(w=>w.item_id===t.item_id);a[s].items.push({item_id:t.item_id,item_name:t.item?.item_name||"Unknown Item",quantity_ordered:$,rate:V,discount_percentage:M,tax_percentage:W,loading_charges:Q,freight_charges:z,cutting_charges:J,total_price:ne,has_po:de})}),n&&d){const t=d.vendor_id,s={};return t&&a[t]&&(s[t]=a[t]),s}return a},[j,P,n,d]),re=async r=>{if(!n){C.error("Edit mode is required for form submission");return}i(!0);try{const a={...r,branch_id:o};await E.put(I.purchase_order.update(Number(n)),a),C.success("Purchase Order updated successfully"),p(G.PURCHASE_ORDER.LIST)}catch(a){console.error("Error updating Purchase Order:",a),C.error(a.response?.data?.message||"Failed to update Purchase Order")}finally{i(!1)}};return T||N?e.jsx("div",{className:"flex justify-center py-20",children:e.jsx(ge,{})}):e.jsxs("div",{className:"w-full h-full overflow-auto space-y-8 p-4 pb-20",children:[e.jsx("div",{className:"space-y-1 ml-2",children:e.jsx(ve,{title:n?"Edit Purchase Order":"Create Purchase Order",subtitle:n?"Update the Purchase Order details":"Fill out the form to submit a new Purchase Order."})}),e.jsx(be,{fields:v,onFilter:h,defaultValues:R}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-5 ml-4",children:[e.jsx(_,{name:"comparative_statement_id",control:y,render:({field:r})=>e.jsxs(le,{...r,label:"Comparative Statement",value:r.value||0,onChange:a=>r.onChange(Number(a.target.value)),disabled:!!n,error:S.comparative_statement_id?.message,children:[e.jsx("option",{value:0,children:"Select Comparative Statement"}),j.map(a=>e.jsx("option",{value:a.id,children:a.statement_number},a.id))]})}),n&&d&&e.jsxs("div",{className:"bg-gray-50 border border-gray-200 rounded p-3",children:[e.jsx("h4",{className:"font-semibold text-gray-800 mb-2",children:"Purchase Order Details"}),e.jsxs("p",{className:"text-sm text-gray-700",children:[e.jsx("strong",{children:"PO Number:"})," ",d.po_number||"N/A"]}),e.jsxs("p",{className:"text-sm text-gray-700",children:[e.jsx("strong",{children:"Vendor:"})," ",d.vendor?.party_name||"N/A"]}),e.jsxs("p",{className:"text-sm text-gray-700",children:[e.jsx("strong",{children:"Status:"})," ",d.status||"N/A"]}),(d.status?.toLowerCase().includes("cancel")||d.status==="Cancelled")&&d.cancellation_reason&&e.jsx("div",{className:"mt-2 p-2 bg-red-50 border border-red-200 rounded",children:e.jsxs("p",{className:"text-sm text-red-800",children:[e.jsx("strong",{children:"Cancellation Reason:"})," ",d.cancellation_reason||"No reason provided"]})})]})]}),n&&d&&e.jsx("form",{onSubmit:te(re),className:"space-y-6",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Purchase Order Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx(_,{name:"expected_delivery_date",control:y,render:({field:r})=>e.jsx(g,{...r,type:"date",label:"Expected Delivery Date",error:S.expected_delivery_date?.message})}),e.jsx(_,{name:"delivery_contact_person",control:y,render:({field:r})=>e.jsx(g,{...r,label:"Delivery Contact Person",placeholder:"Enter contact person name",error:S.delivery_contact_person?.message})}),e.jsx(_,{name:"delivery_contact_phone",control:y,render:({field:r})=>e.jsx(g,{...r,label:"Delivery Contact Phone",placeholder:"Enter contact phone number",error:S.delivery_contact_phone?.message})}),e.jsx("div",{className:"md:col-span-2",children:e.jsx(_,{name:"delivery_address",control:y,render:({field:r})=>e.jsx(X,{...r,label:"Delivery Address",placeholder:"Enter delivery address",rows:3,error:S.delivery_address?.message})})}),e.jsx("div",{className:"md:col-span-2",children:e.jsx(_,{name:"special_instructions",control:y,render:({field:r})=>e.jsx(X,{...r,label:"Special Instructions",placeholder:"Enter any special instructions",rows:3,error:S.special_instructions?.message})})})]}),e.jsxs("div",{className:"flex justify-end gap-3 mt-6",children:[e.jsx(b,{type:"button",variant:"outline",onClick:()=>p(G.PURCHASE_ORDER.LIST),disabled:N,children:"Cancel"}),e.jsx(b,{type:"submit",disabled:N,className:"bg-blue-600 text-white",children:N?"Updating...":"Update Purchase Order"})]})]})}),P&&Object.keys(H).length>0?e.jsx("div",{className:"space-y-6",children:Object.entries(H).map(([r,a])=>e.jsxs(me,{title:`Vendor: ${a.vendor?.party_name||"Unknown"}`,children:[e.jsxs("div",{className:"mb-4 flex justify-between items-center",children:[e.jsxs("div",{className:"text-sm text-gray-600",children:[e.jsxs("p",{children:["Total Items: ",a.items.length]}),e.jsxs("p",{className:"font-semibold text-gray-900",children:["Grand Total: ₹",a.items.reduce((t,s)=>t+s.total_price,0).toLocaleString("en-IN",{minimumFractionDigits:2})]})]}),n?e.jsx(b,{variant:"outline",disabled:!0,className:"bg-green-100 !text-green-600 !border-green-300",children:"Current PO Vendor"}):a.all_items_have_po?e.jsx(b,{variant:"outline",disabled:!0,className:"bg-gray-100 !text-gray-400 !border-gray-300 pointer-events-none",children:"Generated"}):e.jsx(b,{onClick:()=>{A({...a,vendorId:Number(r)}),O(!0)},children:"Generate PO"})]}),e.jsxs(_e,{children:[e.jsx(ue,{cols:[{title:"Item"},{title:"Qty"},{title:"Rate"},{title:"Disc%"},{title:"GST%"},{title:"Loading"},{title:"Freight"},{title:"Cutting"},{title:"Total"},...n?[{title:"Status"}]:[]]}),e.jsx("tbody",{children:a.items.map((t,s)=>e.jsxs("tr",{className:`border-t ${n&&t.has_po?"bg-green-50":""}`,children:[e.jsx(l,{children:s+1}),e.jsx(l,{children:t.item_name}),e.jsx(l,{children:t.quantity_ordered}),e.jsx(l,{children:t.rate}),e.jsxs(l,{children:[t.discount_percentage,"%"]}),e.jsxs(l,{children:[t.tax_percentage,"%"]}),e.jsxs(l,{children:["₹",t.loading_charges||0]}),e.jsxs(l,{children:["₹",t.freight_charges||0]}),e.jsxs(l,{children:["₹",t.cutting_charges||0]}),e.jsxs(l,{children:["₹",t.total_price.toFixed(2)]}),n&&e.jsx(l,{children:t.has_po?e.jsx("span",{className:"text-xs bg-green-100 text-green-800 px-2 py-1 rounded",children:"In PO"}):e.jsx("span",{className:"text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded",children:"Available"})})]},s))})]})]},r))}):e.jsx("div",{className:"p-8 text-center text-gray-500 bg-gray-50 rounded-lg",children:P?"No items found for this Comparative Statement.":"Please select a Comparative Statement to view items grouped by vendor."}),x&&c&&e.jsx(fe,{open:x,onClose:()=>O(!1),vendorId:c.vendorId,vendorName:c.vendor?.party_name||"Unknown",csId:P,branchId:o,items:c.items,onSuccess:()=>{O(!1),B()}})]})};export{Ge as default};
