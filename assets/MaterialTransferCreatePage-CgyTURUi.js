import{u as z,b as G,a as J,r as f,h as j,e as y,y as p,j as e,B as g,i as q,A as K}from"./index-DZUejYSu.js";import{F as X}from"./FormHeader-DC4am5AO.js";import{T as x}from"./TextInput-CfYT9kxn.js";import{L as Y}from"./ListWrapper-B8opYR8T.js";import{T as Z}from"./TableActions-Df8LXwIU.js";import{T as _}from"./TableData-CgIR3Yxt.js";import{T as ee}from"./TableDelete-DqVMD4Nf.js";import{T as te,a as re}from"./TableWrapper-eUq9a7Bu.js";import{u as ae,b as se,C as d}from"./index.esm-8JYv16KU.js";import{u as ie}from"./useItemsStore-DfwQBoXa.js";import{L as ne}from"./Loading-BZ-_58ep.js";import{o as le,n as oe}from"./yup-CyIqaq5C.js";import"./BackButton-DGqmmXaI.js";const N={mr_number:"",transfer_from:"",transfer_to:"",instruction_of:"",items:[{item_name:"",item_code:"",item_id:"",unit:"",actual_required_qty:"",transferred_qty:""}]},qe=()=>{const v=z(),[$]=G(),s=$.get("editId"),{selectedBranchId:A}=J(),{items:T,fetchItems:S}=ie(),[h,I]=f.useState([]),E=!!s,L=ae({defaultValues:N,mode:"onChange",resolver:le(oe)}),{control:o,reset:M,setValue:m,watch:w,handleSubmit:k,formState:{errors:u}}=L,{fields:U,append:O,remove:B}=se({control:o,name:"items"}),[H,D]=f.useState(!1),[C,R]=f.useState(!1);f.useEffect(()=>{S(),Q()},[S]);const Q=async()=>{try{const r=await j.get(y.material_requisition.all),t=r.data?.data?.material_requisitions||r.data?.material_requisitions||[];I(t)}catch(r){console.error("Failed to fetch material requisitions",r)}},P=f.useCallback(async r=>{try{const t=h.find(l=>l.mr_number===r);if(!t)return;const a=await j.get(y.material_requisition.details(t.id)),n=a.data?.material_requisition||a.data?.data||a.data;if(n&&n.items&&n.items.length>0){const l=n.items.map(c=>({item_id:c.item?.id?.toString()||c.item_id?.toString()||"",item_name:c.item?.item_name||"",item_code:c.item?.item_code||"",unit:c.item?.unit?.unit_name||"",actual_required_qty:c.quantity_required?.toString()||c.quantity?.toString()||"",transferred_qty:""}));m("items",l),p.success(`Loaded ${l.length} items from Material Requisition ${r}`)}else m("items",N.items),p.info("No items found for the selected Material Requisition")}catch(t){console.error("Failed to fetch MR details:",t),p.error("Failed to load Material Requisition details")}},[h,m]),F=f.useCallback(async()=>{if(s){D(!0);try{const r=await j.get(y.material_transfer.details(Number(s))),t=r.data.transfer||r.data.data||r.data,a={mr_number:t.mr_number||t.mr||"",transfer_from:t.transfer_from||"",transfer_to:t.transfer_to||"",instruction_of:t.instruction_of||t.instruction||"",items:(t.items||[]).map(n=>({item_id:n.item_id?.toString()||"",item_code:n.item?.item_code||"",item_name:n.item?.item_name||"",unit:n.item?.unit?.unit_name||"",actual_required_qty:n.actual_required_qty?.toString()||"",transferred_qty:n.transferred_qty?.toString()||""}))};M(a)}catch(r){console.error("Failed to load details:",r),p.error("Failed to load material transfer details")}finally{D(!1)}}},[s,M]);f.useEffect(()=>{s&&F()},[s,F]);const i=w("mr_number");f.useEffect(()=>{i&&!s&&h.length>0?P(i):!i&&!s&&m("items",N.items)},[i,s,P,m]);const V=async r=>{R(!0);const t={mr:r.mr_number,branch_id:A,material_requisition_id:r.mr_number?h.find(a=>a.mr_number===r.mr_number)?.id:null,transfer_from:r.transfer_from,transfer_to:r.transfer_to,instruction_of:r.instruction_of,items:r.items.filter(a=>a.item_id&&a.transferred_qty).map(a=>({item_id:Number(a.item_id),actual_required_qty:Number(a.actual_required_qty)||0,transferred_qty:Number(a.transferred_qty)}))};try{const a=s?y.material_transfer.update(Number(s)):y.material_transfer.create;await(s?j.put:j.post)(a,t),p.success(s?"Material transfer updated successfully":"Material transfer created successfully"),v(K.MATERIAL_TRANSFER.LIST)}catch(a){console.error(a),p.error(a.response?.data?.message||"Failed to save material transfer")}finally{R(!1)}};return H?e.jsx("div",{className:"flex justify-center py-20",children:e.jsx(ne,{})}):e.jsxs("div",{className:"w-full h-full overflow-auto space-y-8 p-4 pb-20",children:[e.jsx("div",{className:"space-y-1 ml-2",children:e.jsx(X,{title:s?"Edit Material Transfer":"Create Material Transfer",subtitle:s?"Update the Material Transfer details":"Fill out the form to submit a new Material Transfer"})}),e.jsxs("div",{className:"grid grid-cols-2 gap-5 ml-2 mr-5",children:[e.jsx(d,{name:"transfer_from",control:o,render:({field:r})=>e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("label",{className:"font-medium",children:"Transfer From"}),e.jsxs("select",{...r,className:"border border-gray-300 rounded px-3 py-2",children:[e.jsx("option",{value:"",children:"Select Department"}),e.jsx("option",{value:"store",children:"Store Department"}),e.jsx("option",{value:"purchase",children:"Purchase Department"}),e.jsx("option",{value:"production",children:"Production Department"})]}),u.transfer_from&&e.jsx("p",{className:"text-red-500 text-sm",children:u.transfer_from.message})]})}),e.jsx(d,{name:"transfer_to",control:o,render:({field:r})=>e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("label",{className:"font-medium",children:"Transfer To"}),e.jsxs("select",{...r,className:`border rounded px-3 py-2 text-sm ${u.transfer_to?"border-red-500":"border-gray-300"}`,children:[e.jsx("option",{value:"",children:"Select Department"}),e.jsx("option",{value:"Store Department",children:"Store Department"}),e.jsx("option",{value:"Purchase Department",children:"Purchase Department"}),e.jsx("option",{value:"Production Department",children:"Production Department"})]}),u.transfer_to&&e.jsx("span",{className:"text-red-500 text-xs mt-1",children:u.transfer_to.message})]})}),e.jsx(d,{name:"mr_number",control:o,render:({field:r})=>e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-semibold text-gray-700 mb-1",children:"Material Requisition Number"}),e.jsxs("select",{...r,disabled:E,className:"w-full h-[45px] rounded-lg border border-gray-300 px-4 mt-1 text-sm",children:[e.jsx("option",{value:"",children:"Select Material Requisition"}),h.map(t=>e.jsxs("option",{value:t.mr_number,children:[t.mr_number," - ",t.department||"Unknown Dept"]},t.mr_number))]}),u.mr_number&&e.jsx("span",{className:"text-red-500 text-xs mt-1",children:u.mr_number.message})]})}),e.jsx(d,{name:"instruction_of",control:o,render:({field:r})=>e.jsx(x,{...r,label:"Instruction",error:u.instruction_of?.message,placeholder:"Enter any special instructions here"})})]}),e.jsxs(Y,{title:"Items to Transfer",children:[i?e.jsx("div",{className:"flex justify-between items-center mb-2"}):e.jsx("div",{className:"flex justify-end mb-2",children:e.jsx(g,{className:"bg-red-600 text-white px-3 py-1",onClick:()=>O({item_name:"",item_code:"",item_id:"",unit:"",actual_required_qty:"",transferred_qty:""}),children:"+ Add Item"})}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(te,{children:[e.jsx(re,{cols:[{title:"Item Name"},{title:"Item Code"},{title:"Item Description"},{title:"Unit"},{title:"Actual Required Qty"},{title:"Transferred Qty"},{title:"Action"}]}),e.jsx("tbody",{children:U.map((r,t)=>e.jsxs("tr",{className:"align-middle",children:[e.jsx(_,{children:t+1}),e.jsx(_,{children:e.jsx(d,{name:`items.${t}.item_name`,control:o,render:({field:a})=>a.value&&i?e.jsx(x,{...a,readOnly:!0,className:"mb-0 w-full h-[40px] bg-gray-50",placeholder:"Item Name"}):e.jsxs("select",{value:w(`items.${t}.item_code`)||"",className:"w-full h-[45px] rounded-lg border border-gray-300 px-3 mt-1 text-sm",onChange:l=>{const c=l.target.value,b=T.find(W=>W.item_code===c);b&&(m(`items.${t}.item_name`,b.item_name),m(`items.${t}.item_code`,b.item_code),m(`items.${t}.unit`,b.unit?.unit_name||""),m(`items.${t}.item_id`,b.id))},children:[e.jsx("option",{value:"",children:"Select Item"}),T.map(l=>e.jsxs("option",{value:l.item_code,children:[l.item_name," (",l.item_code,")"]},l.id))]})})}),e.jsx(_,{children:e.jsx(d,{name:`items.${t}.item_code`,control:o,render:({field:a})=>e.jsx(x,{...a,readOnly:!!i,className:q("mb-0 w-full h-[40px]",i&&"bg-gray-50"),placeholder:"Code"})})}),e.jsx(_,{children:e.jsx(d,{name:`items.${t}.unit`,control:o,render:({field:a})=>e.jsx(x,{...a,readOnly:!!i,className:q("mb-0 w-full h-[40px]",i&&"bg-gray-50"),placeholder:"Unit"})})}),e.jsx(_,{children:e.jsx(d,{name:`items.${t}.actual_required_qty`,control:o,render:({field:a})=>e.jsx(x,{...a,type:"number",readOnly:!!i,className:q("mb-0 w-full h-[40px]",i&&"bg-gray-50"),placeholder:"0"})})}),e.jsx(_,{children:e.jsx(d,{name:`items.${t}.transferred_qty`,control:o,render:({field:a})=>e.jsx(x,{...a,type:"number",className:"mb-0 w-full h-[40px]",placeholder:"0"})})}),e.jsx(_,{children:e.jsx(Z,{children:!i&&e.jsx(ee,{onClick:()=>B(t)})})})]},r.id))})]})})]}),e.jsxs("div",{className:"flex justify-end gap-3 mr-5",children:[e.jsx(g,{variant:"outline",onClick:()=>v(-1),children:"Cancel"}),e.jsx(g,{className:"bg-red-600 text-white",onClick:k(V),loading:C,disabled:C,children:s?"Update Material Transfer":"Submit Material Transfer"})]})]})};export{qe as default};
