import{r as _,j as e,W as te,X as G,Y as K,Z as ae,$ as ne,a0 as oe,y as O,u as le,b as ie,a as Q,B as H,A as V,h as T,e as A}from"./index-XrqdkMlQ.js";import{L as de}from"./Loading-De0ina5-.js";import{F as ce}from"./FormHeader-BMqyVJC0.js";import{T as me,a as pe}from"./TableWrapper-BfKmYKz6.js";import{T as ue}from"./TableRow-DbFK36gc.js";import{T as F}from"./TableData-D2335yaW.js";import{T as xe}from"./TableActions-BqxsRnCX.js";import{T as ge}from"./TableDelete-RE0NQPTb.js";import{o as fe,w as he}from"./yup-WSW8GMws.js";import{u as je,b as be,C as p}from"./index.esm-2ny8XQ-U.js";import{u as _e}from"./useMachineStore-_HjJSUkP.js";import{b as X}from"./rolePermissions-BvMMyxfj.js";import"./BackButton-BuSwY49K.js";import"./enum-SoLNwffs.js";const ye=({label:h="Upload Files",required:u=!1,maxFiles:i=10,value:l=[],onChange:y,error:N,acceptedTypes:w=["image/*","application/pdf","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"]})=>{const[k,C]=_.useState(!1),I=_.useRef(null),$=t=>{t.preventDefault(),C(!0)},R=t=>{t.preventDefault(),C(!1)},D=t=>{t.preventDefault(),C(!1);const a=Array.from(t.dataTransfer.files);J(a)},M=t=>{if(t.target.files){const a=Array.from(t.target.files);J(a)}},J=t=>{const a=t.filter(f=>{const S=f.type&&typeof f.type=="string"&&f.type.startsWith("image/"),v=f.type==="application/pdf",U=f.type&&(f.type.includes("excel")||f.type.includes("spreadsheet"));return S||v||U});a.length!==t.length&&O.error("Only images, PDF, and Excel files are allowed.");const m=Array.isArray(l)?l.filter(f=>f instanceof File):[],j=Array.isArray(l)?l.filter(f=>typeof f=="string"):[];if(m.length+a.length>i){O.error(`You can only upload up to ${i} files.`);return}y([...j,...m,...a])},L=t=>{const a=Array.isArray(l)?[...l]:[];a.splice(t,1),y(a)},W=()=>{I.current?.click()},q=t=>{let a="";if(t instanceof File)a=t.type||"";else if(typeof t=="string"){const m=t.toLowerCase().split(".").pop()||"";["jpg","jpeg","png","gif","webp"].includes(m)?a="image/":m==="pdf"?a="application/pdf":["xls","xlsx"].includes(m)&&(a="application/vnd.ms-excel")}return a&&typeof a=="string"&&a.startsWith("image/")?e.jsx(ae,{className:"text-blue-500 text-2xl"}):a&&typeof a=="string"&&a.includes("pdf")?e.jsx(ne,{className:"text-red-500 text-2xl"}):a&&typeof a=="string"&&(a.includes("excel")||a.includes("spreadsheet"))?e.jsx(oe,{className:"text-green-500 text-2xl"}):e.jsx(K,{className:"text-gray-500 text-2xl"})},z=t=>{if(t===0)return"0 Bytes";const a=1024,m=["Bytes","KB","MB","GB"],j=Math.floor(Math.log(t)/Math.log(a));return parseFloat((t/Math.pow(a,j)).toFixed(2))+" "+m[j]},d=Array.isArray(l)?l.filter(t=>t instanceof File):[],o="https://united.peclick.co.in",P=t=>{if(t instanceof File)return URL.createObjectURL(t);if(!t||typeof t!="string")return"";try{return t.startsWith("http")?t:`${o}/${t}`}catch(a){return console.error("Error in getImageUrl:",a),""}};return e.jsxs("div",{className:"w-full space-y-4",children:[h&&e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[h," ",u&&e.jsx("span",{className:"text-red-500",children:"*"})," (Max"," ",i,")"]}),d.length<i&&e.jsxs("div",{className:`border-2 border-dashed rounded-lg p-6 flex flex-col items-center justify-center cursor-pointer transition-colors ${k?"border-blue-500 bg-blue-50":"border-gray-300 hover:border-gray-400 bg-gray-50"}`,onDragOver:$,onDragLeave:R,onDrop:D,onClick:W,children:[e.jsx("input",{type:"file",ref:I,className:"hidden",accept:w.join(","),multiple:!0,onChange:M}),e.jsx(te,{className:"text-4xl text-gray-400 mb-2"}),e.jsx("p",{className:"text-sm text-gray-500 font-medium",children:"Drag & Drop Files"}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:"or select Images, PDF, Excel files from device"})]}),l&&l.length>0&&e.jsxs("div",{children:[e.jsxs("h4",{className:"text-sm font-medium text-gray-700 mb-2",children:["Files (",l.length,")"]}),e.jsx("div",{className:"space-y-2",children:l.map((t,a)=>{try{const m=t instanceof File;let j="";try{m?j=URL.createObjectURL(t):typeof t=="string"&&(j=P(t))}catch(v){console.error("Error creating URL:",v),j=""}let f="";m?f=t.name.split(".").pop()?.toLowerCase()||"":f=(typeof t=="string"?t:"").split(".").pop()?.toLowerCase()||"";const S=f&&["jpg","jpeg","png","gif","webp"].includes(f);return console.log("objectisImage",S),console.log("objectextension",f),console.log("url",j),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("a",{href:m?j:P(t),target:"_blank",rel:"noopener noreferrer",className:"w-12 h-12 rounded overflow-hidden flex items-center justify-center",children:S?e.jsx("img",{src:j,alt:m?t.name:"Existing file",className:"w-full h-full object-cover"}):q(t)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 truncate",children:m?t.name:t.split("/").pop()}),m&&S&&e.jsx("p",{className:"text-xs text-gray-500",children:z(t.size)}),!m&&e.jsx("p",{className:"text-xs text-gray-500",children:"Existing file"})]})]}),e.jsx("button",{type:"button",onClick:v=>{v.stopPropagation(),L(a)},className:"ml-3 bg-red-500 text-white rounded-full p-1 hover:bg-red-600 transition-colors",children:e.jsx(G,{size:12})})]},a)}catch(m){return console.error("Error rendering file item:",m,t),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-red-50 rounded-lg border border-red-200",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(K,{className:"text-red-500 text-2xl"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-red-900 truncate",children:"Error loading file"}),e.jsx("p",{className:"text-xs text-red-500",children:"Invalid file format"})]})]}),e.jsx("button",{type:"button",onClick:j=>{j.stopPropagation(),L(a)},className:"ml-3 bg-red-500 text-white rounded-full p-1 hover:bg-red-600 transition-colors",children:e.jsx(G,{size:12})})]},a)}})})]}),N&&e.jsx("p",{className:"text-xs text-red-500 mt-1",children:N})]})},Ne=({id:h,title:u,loading:i,children:l,subtitle:y})=>i?e.jsx("div",{className:"flex justify-center items-center h-[500px]",children:e.jsx(de,{})}):e.jsx("div",{className:"w-full h-full p-2 sm:p-4 lg:p-6 overflow-y-auto pb-20",children:e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsx(ce,{title:h?`Edit ${u}`:`Create ${u}`,subtitle:y||(h?`Update ${u} details`:`Create a new ${u}`)}),e.jsx("div",{className:"space-y-4 sm:space-y-6 mt-4",children:l})]})}),E=_.forwardRef(({label:h,error:u,required:i,children:l,className:y="",...N},w)=>e.jsxs("div",{className:"w-full",children:[h&&e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[h," ",i&&e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("select",{ref:w,className:`w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 ${u?"border-red-500":""} ${y}`,...N,children:l}),u&&e.jsx("p",{className:"text-xs text-red-500 mt-1",children:u})]}));E.displayName="Select";const B=_.forwardRef(({label:h,error:u,required:i,className:l="",...y},N)=>e.jsxs("div",{className:"w-full",children:[h&&e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[h," ",i&&e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("textarea",{ref:N,rows:3,className:`w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-vertical ${u?"border-red-500":""} ${l}`,...y}),u&&e.jsx("p",{className:"text-xs text-red-500 mt-1",children:u})]}));B.displayName="TextArea";const b=_.forwardRef(({label:h,error:u,required:i,autofoucs:l,className:y="",...N},w)=>e.jsxs("div",{className:"w-full",children:[h&&e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[h," ",i&&e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{ref:w,autoFocus:l,className:`w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 ${u?"border-red-500":""} ${y}`,...N}),u&&e.jsx("p",{className:"text-xs text-red-500 mt-1",children:u})]}));b.displayName="TextInput";const ve={job_name:"",job_card_no:"",job_date:new Date().toISOString().split("T")[0],department:"Production Department",job_description:"",quantity:1,expected_delivery_date:"",job_type:"",status:"pending",customer_id:"",customer_name:"",customer_contact:"",customer_address:"",operations:[{operation_name:"",supervisor_id:"",start_date:"",end_date:"",machine_id:""}],challan_no:"",challan_date:"",invoice_no:"",po_no:"",remarks:"",note:"",images:[]},qe=()=>{const h=le(),[u]=ie(),i=u.get("editId"),{selectedBranchId:l}=Q(),[y,N]=_.useState(!1),[w,k]=_.useState(!1),[C,I]=_.useState([]),[$,R]=_.useState([]),[D,M]=_.useState([]),[J,L]=_.useState([]),{machines:W,fetchMachines:q}=_e(),{watch:z,control:d,setValue:o,handleSubmit:P,formState:{errors:t,isDirty:a}}=je({defaultValues:ve,mode:"onChange",resolver:fe(he)}),{fields:m,append:j,remove:f,replace:S}=be({control:d,name:"operations"}),v=z("customer_id"),{user:U}=Q(),Z=U?.id,x=X(U?.role?.role_name||"")&&!!i,ee=async()=>{N(!0);try{const r=await T.get(A.job_order.details(Number(i))),s=r.data?.job_card||r.data;if(s){s.branch_id&&await Y(Number(s.branch_id));const g=s.operations.map(c=>({operation_name:c.operation_name||"",supervisor_id:c.supervisor_id?String(c.supervisor_id):"",start_date:c.start_date?c.start_date.split("T")[0]:"",end_date:c.end_date?c.end_date.split("T")[0]:"",machine_id:c.machine_id?String(c.machine_id):""}))||[];S(g.length?g:[{operation_name:"",supervisor_id:"",start_date:"",end_date:"",machine_id:""}]);const n=s.images?.map(c=>c.image_path).flat().filter(c=>typeof c=="string"&&c.trim().length>0)||[];o("job_name",s.job_name||""),o("job_card_no",s.job_card_number||""),o("job_date",s.job_date?s.job_date.split("T")[0]:""),o("department",s.department||"Production Department"),o("job_description",s.job_description||""),o("quantity",s.quantity||1),o("expected_delivery_date",s.expected_delivery_date?s.expected_delivery_date.split("T")[0]:""),o("job_type",s.job_type||""),o("status",s.status||"pending"),o("customer_id",s.customer_id?String(s.customer_id):""),o("customer_name",s.customer?.party_name||""),o("customer_contact",s.customer?.phone||""),o("customer_address",s.customer?.address||""),o("operations",g),o("challan_no",s.challan_number||""),o("challan_date",s.challan_date?s.challan_date.split("T")[0]:""),o("invoice_no",s.invoice_number||""),o("po_no",s.customer_po_number||""),o("remarks",s.remarks||""),o("note",s.note||""),I(n),R([])}}catch(r){console.log(r),O.error("Failed to load job order details")}finally{N(!1)}},Y=async r=>{if(r)try{const g=(await T.get(A.user_management.all,{params:{branch_id:r}})).data.users.filter(n=>X(n.role.role_name));L(g)}catch(s){console.log(s)}},se=async()=>{try{const r=await T.get(A.party_master.all,{params:{party_type:"Customer"}});M(r.data?.parties||r.data?.data||[])}catch(r){console.error("Failed to fetch customers",r)}};_.useEffect(()=>{se(),q(),l&&Y(Number(l)),i&&ee()},[i,l,q]),_.useEffect(()=>{if(v&&D.length>0){const r=D.find(s=>s.id===Number(v));r&&(o("customer_name",r.party_name),o("customer_contact",r.phone||""),o("customer_address",r.address||""))}},[v,D,o]);const re=async r=>{if(i&&!a){h(V.JOB_ORDER.LIST);return}k(!0);try{const s=new FormData;s.append("job_name",r.job_name),s.append("job_date",r.job_date),s.append("department",r.department),s.append("job_description",r.job_description||""),s.append("job_type",r.job_type),s.append("status",r.status),s.append("quantity",String(r.quantity)),s.append("expected_delivery_date",r.expected_delivery_date),s.append("customer_id",String(r.customer_id)),s.append("created_by",String(Z)),s.append("branch_id",String(l)),s.append("challan_no",r.challan_no||""),s.append("challan_date",r.challan_date||""),s.append("invoice_no",r.invoice_no||""),s.append("po_no",r.po_no||""),s.append("remarks",r.remarks||""),s.append("note",r.note||""),r.operations.filter(n=>n.operation_name||n.supervisor_id||n.machine_id).forEach((n,c)=>{s.append(`operations[${c}][operation_name]`,n.operation_name||""),s.append(`operations[${c}][supervisor_id]`,n.supervisor_id||""),s.append(`operations[${c}][start_date]`,n.start_date||""),s.append(`operations[${c}][end_date]`,n.end_date||""),s.append(`operations[${c}][machine_id]`,n.machine_id||"")}),$.forEach((n,c)=>{s.append(`images[${c}]`,n)}),s.append("existing_images",JSON.stringify(C));const g={headers:{"Content-Type":"multipart/form-data"}};i?(await T.post(A.job_order.update(Number(i)),s,g),O.success("Job Order updated successfully")):(await T.post(A.job_order.create,s,g),O.success("Job Order created successfully")),h(V.JOB_ORDER.LIST)}catch(s){O.error(s.response?.data?.message||"Failed to submit job order")}finally{k(!1)}};return e.jsx("form",{onSubmit:P(re),children:e.jsxs(Ne,{id:i,title:"Job Card",loading:y,children:[e.jsxs("div",{className:"grid gap-5 md:grid-cols-4",children:[e.jsx(p,{name:"job_name",control:d,render:({field:r})=>e.jsx(b,{required:!0,autofoucs:!0,...r,label:"Job Name",placeholder:"e.g. Engine Overhaul",readOnly:x,className:x?"bg-gray-100":"",error:t?.job_name?.message})}),i&&e.jsx(p,{name:"job_card_no",control:d,render:({field:r})=>e.jsx(b,{...r,label:"Job Card No.",placeholder:"JC-2023...",readOnly:!0,error:t?.job_card_no?.message})}),e.jsx(p,{name:"job_date",control:d,render:({field:r})=>e.jsx(b,{required:!0,...r,type:"date",label:"Job Date",error:t?.job_date?.message,readOnly:x,className:x?"bg-gray-100":""})}),e.jsx(p,{name:"department",control:d,render:({field:r})=>e.jsx(b,{required:!0,...r,label:"Department",error:t?.department?.message,readOnly:x,className:x?"bg-gray-100":""})})]}),e.jsx("div",{className:"mt-5",children:e.jsx(p,{name:"job_description",control:d,render:({field:r})=>e.jsx(B,{...r,label:"Job Description",placeholder:"Describe the job details...",error:t?.job_description?.message,readOnly:x,className:x?"bg-gray-100":""})})}),e.jsxs("div",{className:"mt-5 grid gap-5 md:grid-cols-3",children:[e.jsx(p,{name:"quantity",control:d,render:({field:r})=>e.jsx(b,{required:!0,...r,type:"number",label:"Quantity",placeholder:"Enter quantity",error:t?.quantity?.message,readOnly:x,className:x?"bg-gray-100":""})}),e.jsx(p,{name:"expected_delivery_date",control:d,render:({field:r})=>e.jsx(b,{required:!0,...r,type:"date",label:"Expected Delivery",readOnly:!!i,error:t?.expected_delivery_date?.message})}),e.jsx(p,{name:"job_type",control:d,render:({field:r})=>e.jsxs(E,{...r,required:!0,label:"Job Type",error:t?.job_type?.message,disabled:x,children:[e.jsx("option",{disabled:!0,value:"",children:"Select job type"}),e.jsx("option",{value:"amc",children:"AMC"}),e.jsx("option",{value:"new_job",children:"New Job"}),e.jsx("option",{value:"in_house_manufacturing",children:"In House"}),e.jsx("option",{value:"repair",children:"Repair"}),e.jsx("option",{value:"service",children:"Service"})]})})]}),e.jsxs("div",{className:"mt-5",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 border-b pb-2 mb-4",children:"Customer Information"}),e.jsxs("div",{className:"grid gap-5 md:grid-cols-3",children:[e.jsx(p,{name:"customer_id",control:d,render:({field:r})=>e.jsxs(E,{...r,required:!0,label:"Customer Name",disabled:x,error:t?.customer_id?.message,children:[e.jsx("option",{disabled:!0,value:"",children:"Select Customer"}),D.filter(s=>s.party_type==="customer").map(s=>e.jsx("option",{value:s.id,children:s.party_name},s.id))]})}),e.jsx(p,{name:"customer_contact",control:d,render:({field:r})=>e.jsx(b,{...r,label:"Customer Contact",placeholder:"Auto-filled from customer",readOnly:!0,className:"bg-gray-100"})}),e.jsx(p,{name:"customer_address",control:d,render:({field:r})=>e.jsx(b,{...r,label:"Customer Address",placeholder:"Auto-filled from customer",readOnly:!0,className:"bg-gray-100"})})]})]}),e.jsxs("div",{className:"mt-5",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:"Operations"}),e.jsx(H,{type:"button",className:"bg-blue-600 text-white",onClick:()=>j({operation_name:"",supervisor_id:"",start_date:"",end_date:"",machine_id:""}),children:"+ Add Operation"})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(me,{children:[e.jsx(pe,{cols:[{title:"Operation Name"},{title:"Supervisor"},{title:"Start Date"},{title:"End Date"},{title:"Machine"},{title:"Actions"}]}),e.jsx("tbody",{children:m.map((r,s)=>e.jsxs(ue,{children:[e.jsx(F,{className:"px-5",children:s+1}),e.jsx(F,{className:"min-w-[200px]",children:e.jsx(p,{name:`operations.${s}.operation_name`,control:d,render:({field:g})=>e.jsx(b,{...g,placeholder:"e.g. Cutting, Welding",error:t.operations?.[s]?.operation_name?.message})})}),e.jsx(F,{className:"min-w-[200px]",children:e.jsx(p,{name:`operations.${s}.supervisor_id`,control:d,render:({field:g})=>e.jsxs(E,{...g,error:t.operations?.[s]?.supervisor_id?.message,children:[e.jsx("option",{value:"",children:"Select Supervisor"}),J?.map(n=>e.jsx("option",{value:n.id,children:n.full_name},n.id))]})})}),e.jsx(F,{className:"min-w-[150px]",children:e.jsx(p,{name:`operations.${s}.start_date`,control:d,render:({field:g})=>e.jsx(b,{...g,type:"date",error:t.operations?.[s]?.start_date?.message})})}),e.jsx(F,{className:"min-w-[150px]",children:e.jsx(p,{name:`operations.${s}.end_date`,control:d,render:({field:g})=>e.jsx(b,{...g,type:"date",error:t.operations?.[s]?.end_date?.message})})}),e.jsx(F,{className:"min-w-[200px]",children:e.jsx(p,{name:`operations.${s}.machine_id`,control:d,render:({field:g})=>e.jsxs(E,{...g,error:t.operations?.[s]?.machine_id?.message,children:[e.jsx("option",{value:"",children:"Select Machine"}),W.map(n=>e.jsx("option",{value:n.id,children:n.name},n.id))]})})}),e.jsx(F,{children:e.jsx(xe,{children:m.length>1&&e.jsx(ge,{onClick:()=>f(s)})})})]},r.id))})]})})]}),e.jsxs("div",{className:"mt-5",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 border-b pb-2 mb-4",children:"Internal Tracking"}),e.jsxs("div",{className:"grid gap-5 md:grid-cols-4",children:[e.jsx(p,{name:"challan_no",control:d,render:({field:r})=>e.jsx(b,{...r,label:"Challan No.",placeholder:"Enter challan number",readOnly:x,className:x?"bg-gray-100":"",error:t?.challan_no?.message})}),e.jsx(p,{name:"challan_date",control:d,render:({field:r})=>e.jsx(b,{...r,type:"date",label:"Challan Date",readOnly:x,className:x?"bg-gray-100":"",error:t?.challan_date?.message})}),e.jsx(p,{name:"invoice_no",control:d,render:({field:r})=>e.jsx(b,{...r,label:"Invoice No.",placeholder:"Enter invoice number",readOnly:x,className:x?"bg-gray-100":"",error:t?.invoice_no?.message})})]})]}),e.jsxs("div",{className:"mt-5 grid gap-5 md:grid-cols-2",children:[e.jsx(p,{name:"remarks",control:d,render:({field:r})=>e.jsx(B,{...r,label:"Remarks",placeholder:"Add any additional notes or remarks...",error:t?.remarks?.message})}),e.jsx(p,{name:"note",control:d,render:({field:r})=>e.jsx(B,{...r,label:"Note",placeholder:"Add any additional notes or comments...",readOnly:x,className:x?"bg-gray-100":"",error:t?.note?.message})})]}),e.jsx("div",{className:"mt-5",children:e.jsx(ye,{label:"Job Images and Documents",value:[...C,...$],maxFiles:10,error:t?.images?.message,onChange:r=>{const s=r.filter(n=>n instanceof File),g=r.filter(n=>typeof n=="string");R(s),I(g)}})}),e.jsxs("div",{className:"mt-8 flex flex-col sm:flex-row justify-end gap-3",children:[e.jsx(H,{type:"button",variant:"outline",className:"w-full sm:w-auto",onClick:()=>h(V.JOB_ORDER.LIST),children:"Cancel"}),e.jsx(H,{type:"submit",loading:w,disabled:w,className:"bg-blue-600 text-white w-full sm:w-auto",children:i?"Update Job Card":"Save Job Card"})]})]})})};export{qe as default};
