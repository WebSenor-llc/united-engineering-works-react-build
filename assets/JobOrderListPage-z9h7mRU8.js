import{r as C,j as e,a as K,ac as o,h as U,e as I,y as w,u as se,k as le,D as z,P as F,A as O}from"./index-jDfkN2r4.js";import{L as ae}from"./ListWrapper-CdcYWlKR.js";import{T as re,a as ne,b as j}from"./TableWrapper-BjLYclM7.js";import{T as oe}from"./TableRow-saOpsf4I.js";import{T as ie}from"./TableActions-CJhLK9s8.js";import{T as ce}from"./TableEdit-CoG230zd.js";import{T as de}from"./TableDelete-BoG9eQR7.js";import{D as me,P as he,S as xe,V as s,I as M,T as l,a as ge,p as ue}from"./react-pdf.browser-BKFnN6L9.js";import{L as pe}from"./Loading-QSf8-D6b.js";import{u as ye}from"./usePagination-DCcA-7np.js";import{c as je,b as Q}from"./rolePermissions-CjenfG1g.js";import{S as fe}from"./StatusFilter-DYnA0uTA.js";import{C as be}from"./CommonFilter-CtbhRV7S.js";import"./index.esm-DafRD7gC.js";import"./TextInput-BI1n9-MI.js";const B=n=>n?new Date(n).toLocaleDateString("en-IN",{day:"2-digit",month:"2-digit",year:"numeric"}):"-",Ce=({jobOrder:n,documents:p=[]})=>{const N=n?.operations||[],g=C.useMemo(()=>p.filter(i=>i.type==="image").slice(0,6),[p]);console.log("objectimages",g),console.log("images",g);const _=p.filter(i=>i.type==="file"),[D,E]=C.useState([]);return C.useEffect(()=>{const i=async()=>{const d=await Promise.all(g.map(async f=>{const c=f.url.startsWith("http")?f.url:`undefined/${f.url}`;try{const x=await(await fetch(c)).blob(),S=await new Promise(m=>{const T=new FileReader;T.onloadend=()=>m(T.result),T.readAsDataURL(x)});return{name:f.name,src:S}}catch(u){return console.error("Failed to load image:",c,u),{name:f.name,src:""}}}));E(d)};g.length>0&&i()},[g]),e.jsx(me,{children:e.jsxs(he,{size:"A4",style:t.page,children:[e.jsxs(s,{style:t.headerContainer,children:[e.jsx(s,{style:t.logoSection,children:e.jsx(M,{src:"/assets/images/logo.png",style:t.logo})}),e.jsxs(s,{style:t.companyInfo,children:[e.jsx(l,{style:t.companyName,children:"UNITED ENGINEERING WORKS"}),e.jsx(l,{style:t.companyAddress,children:"N.H. 8, Nehla Village, By Pass Road, Near Govardhan Vilas, Udaipur- 313001 (Raj.) INDIA"}),e.jsx(l,{style:t.companyContact,children:"Phone: +91-9829232445 +91-9829657145 | GSTIN: 08ABQPK8948J3ZP"}),e.jsx(l,{style:t.companyContact,children:"Email: info@unitedengineeringworks.com"})]})]}),e.jsx(l,{style:t.title,children:"JOB CARD"}),e.jsxs(s,{style:t.jobDetailsContainer,children:[e.jsxs(s,{style:t.gridRow,children:[e.jsxs(s,{style:t.gridCol,children:[e.jsx(l,{style:t.label,children:"Job Name:"}),e.jsx(l,{style:t.value,children:n.job_name||"-"})]}),e.jsxs(s,{style:t.gridCol,children:[e.jsx(l,{style:t.label,children:"Quantity:"}),e.jsx(l,{style:t.value,children:n.quantity||"-"})]})]}),e.jsxs(s,{style:t.gridRow,children:[e.jsxs(s,{style:t.gridCol,children:[e.jsx(l,{style:t.label,children:"Job Card No:"}),e.jsx(l,{style:t.value,children:n.job_card_number||"-"})]}),e.jsxs(s,{style:t.gridCol,children:[e.jsx(l,{style:t.label,children:"Expected Delivery:"}),e.jsx(l,{style:t.value,children:B(n.expected_delivery_date)})]})]}),e.jsxs(s,{style:t.gridRow,children:[e.jsxs(s,{style:t.gridCol,children:[e.jsx(l,{style:t.label,children:"Processing Date:"}),e.jsx(l,{style:t.value,children:B(n.job_date)})]}),e.jsxs(s,{style:t.gridCol,children:[e.jsx(l,{style:t.label,children:"Customer Name:"}),e.jsx(l,{style:t.value,children:n.customer?.party_name||n.customer_name||"-"})]})]}),e.jsxs(s,{style:t.gridRow,children:[e.jsxs(s,{style:t.gridCol,children:[e.jsx(l,{style:t.label,children:"Created By:"}),e.jsx(l,{style:t.value,children:n.created_by?.full_name?`${n.created_by.full_name} (${n.created_by_role??""})`:"-"})]}),e.jsxs(s,{style:t.gridCol,children:[e.jsx(l,{style:t.label,children:"RGP/Invoice no:"}),e.jsx(l,{style:t.value,children:n.rgp_invoice_no||"-"})]})]}),e.jsxs(s,{style:[t.gridRow,{borderBottomWidth:0}],children:[e.jsxs(s,{style:t.gridCol,children:[e.jsx(l,{style:t.label,children:"Branch:"}),e.jsx(l,{style:t.value,children:n.branch?.branch_name||"-"})]}),e.jsx(s,{style:t.gridCol})]})]}),e.jsxs(s,{style:t.descriptionSection,children:[e.jsx(l,{style:t.sectionTitle,children:"Job Description:"}),e.jsx(s,{style:t.descriptionBox,children:e.jsx(l,{style:t.descriptionText,children:n.job_description||"-"})})]}),e.jsxs(s,{style:t.operationsSection,children:[e.jsx(l,{style:t.sectionTitle,children:"List of Operations"}),e.jsxs(s,{style:t.tableContainer,children:[e.jsxs(s,{style:t.tableHeaderRow,children:[e.jsx(s,{style:[t.tableCell,t.snoCol,t.headerCell],children:e.jsx(l,{style:t.headerText,children:"S.no"})}),e.jsx(s,{style:[t.tableCell,t.operationCol,t.headerCell],children:e.jsx(l,{style:t.headerText,children:"Operation Name"})}),e.jsx(s,{style:[t.tableCell,t.supervisorCol,t.headerCell],children:e.jsx(l,{style:t.headerText,children:"Supervisor"})}),e.jsx(s,{style:[t.tableCell,t.startDateCol,t.headerCell],children:e.jsx(l,{style:t.headerText,children:"Start Date"})}),e.jsx(s,{style:[t.tableCell,t.endDateCol,t.headerCell],children:e.jsx(l,{style:t.headerText,children:"End Date"})}),e.jsx(s,{style:[t.tableCell,t.machineCol,t.headerCell],children:e.jsx(l,{style:t.headerText,children:"Machine Name"})})]}),N.length>0?N.map((i,d)=>e.jsxs(s,{style:t.tableRow,children:[e.jsx(s,{style:[t.tableCell,t.snoCol],children:e.jsx(l,{style:t.cellText,children:d+1})}),e.jsx(s,{style:[t.tableCell,t.operationCol],children:e.jsx(l,{style:t.cellText,children:i.operation_name||"-"})}),e.jsx(s,{style:[t.tableCell,t.supervisorCol],children:e.jsx(l,{style:t.cellText,children:i.supervisor?.full_name||"-"})}),e.jsx(s,{style:[t.tableCell,t.startDateCol],children:e.jsx(l,{style:t.cellText,children:B(i.start_date)})}),e.jsx(s,{style:[t.tableCell,t.endDateCol],children:e.jsx(l,{style:t.cellText,children:B(i.end_date)})}),e.jsx(s,{style:[t.tableCell,t.machineCol],children:e.jsx(l,{style:t.cellText,children:i.machine?.name||"-"})})]},d)):Array.from({length:5}).map((i,d)=>e.jsxs(s,{style:t.tableRow,children:[e.jsx(s,{style:[t.tableCell,t.snoCol],children:e.jsx(l,{style:t.cellText})}),e.jsx(s,{style:[t.tableCell,t.operationCol],children:e.jsx(l,{style:t.cellText})}),e.jsx(s,{style:[t.tableCell,t.supervisorCol],children:e.jsx(l,{style:t.cellText})}),e.jsx(s,{style:[t.tableCell,t.startDateCol],children:e.jsx(l,{style:t.cellText})}),e.jsx(s,{style:[t.tableCell,t.endDateCol],children:e.jsx(l,{style:t.cellText})}),e.jsx(s,{style:[t.tableCell,t.machineCol],children:e.jsx(l,{style:t.cellText})})]},d))]})]}),e.jsxs(s,{style:t.remarksSection,children:[e.jsx(l,{style:t.sectionTitle,children:"Additional Remarks/Notes:"}),e.jsx(s,{style:t.remarksBox,children:e.jsx(l,{style:t.remarksText,children:n.remarks||n.note||""})})]}),e.jsxs(s,{style:t.documentsSection,children:[e.jsx(l,{style:t.sectionTitle,children:"Attached Documents"}),g.length>0&&e.jsxs(s,{style:t.imagesContainer,children:[e.jsx(l,{style:t.subSectionTitle,children:"Images:"}),e.jsx(s,{style:t.imagesGrid,children:g.map((i,d)=>e.jsxs(s,{style:t.imageWrapper,children:[e.jsx(s,{style:t.imageContainer,children:e.jsx(M,{src:i.url.startsWith("http")?i.url:`undefined/${i.url}`,style:t.documentImage})}),e.jsx(l,{style:t.imageCaption,children:i.name})]},d))})]}),_.length>0&&e.jsxs(s,{style:t.filesContainer,children:[e.jsx(l,{style:t.subSectionTitle,children:"Files:"}),_.map((i,d)=>e.jsxs(l,{style:t.fileText,children:["• ",i.name]},d))]}),g.length===0&&_.length===0&&e.jsx(s,{style:t.documentsBox,children:e.jsx(l,{style:t.documentsText,children:"No documents attached"})})]})]})})},t=xe.create({page:{padding:20,fontSize:10,fontFamily:"Helvetica",lineHeight:1.3},headerContainer:{flexDirection:"row",alignItems:"center",marginBottom:15,paddingBottom:10,borderBottomWidth:2,borderBottomColor:"#000",gap:10},logoSection:{width:70,marginRight:20},logo:{width:60,height:50},companyInfo:{flex:1,alignItems:"flex-start"},companyName:{fontSize:16,fontWeight:"bold",marginBottom:3},companyAddress:{fontSize:10,marginBottom:2},companyContact:{fontSize:10},title:{fontSize:18,textAlign:"center",marginBottom:15,fontWeight:"bold",textDecoration:"underline"},jobDetailsContainer:{marginBottom:15,borderWidth:1,borderColor:"#000"},gridRow:{flexDirection:"row",borderBottomWidth:.5,borderBottomColor:"#eee",minHeight:25,alignItems:"center"},gridCol:{flexDirection:"row",width:"50%",paddingHorizontal:8,alignItems:"center"},label:{width:"45%",fontSize:9,fontWeight:"bold"},value:{width:"55%",fontSize:9},descriptionSection:{marginBottom:15},sectionTitle:{fontSize:10,fontWeight:"bold",marginBottom:5},descriptionBox:{borderWidth:1,borderColor:"#000",minHeight:60,padding:8},descriptionText:{fontSize:9},operationsSection:{marginBottom:15},tableContainer:{borderWidth:1,borderColor:"#000"},tableHeaderRow:{flexDirection:"row",backgroundColor:"#f0f0f0"},tableRow:{flexDirection:"row",minHeight:25},tableCell:{padding:4,borderWidth:.5,borderColor:"#000",justifyContent:"center",alignItems:"center"},headerCell:{backgroundColor:"#f0f0f0"},headerText:{fontSize:9,fontWeight:"bold",textAlign:"center"},cellText:{fontSize:8,textAlign:"center"},snoCol:{width:"8%"},operationCol:{width:"25%"},supervisorCol:{width:"20%"},startDateCol:{width:"15%"},endDateCol:{width:"15%"},machineCol:{width:"17%"},remarksSection:{marginBottom:15},remarksBox:{borderWidth:1,borderColor:"#000",minHeight:50,padding:8},remarksText:{fontSize:9},documentsSection:{marginBottom:15},documentsBox:{borderWidth:1,borderColor:"#000",minHeight:50,padding:8},documentsText:{fontSize:9},subSectionTitle:{fontSize:9,fontWeight:"bold",marginBottom:5,marginTop:5},imagesContainer:{marginBottom:10},imagesGrid:{flexDirection:"row",flexWrap:"wrap",marginTop:5},imageWrapper:{marginRight:10,marginBottom:10,alignItems:"center"},imageContainer:{borderWidth:1,borderColor:"#ccc",backgroundColor:"#f9f9f9"},documentImage:{width:80,height:80},imagePlaceholder:{width:80,height:80,backgroundColor:"#f0f0f0",borderWidth:1,borderColor:"#ccc",justifyContent:"center",alignItems:"center",padding:4},placeholderText:{fontSize:8,color:"#666",textAlign:"center",marginBottom:2},placeholderUrlText:{fontSize:6,color:"#999",textAlign:"center",maxWidth:70},imageCaption:{fontSize:7,textAlign:"center",marginTop:2,maxWidth:80},filesContainer:{marginTop:5},fileText:{fontSize:9,marginBottom:2,paddingLeft:5}}),_e=({jobOrder:n,onStatusUpdate:p})=>{const[N,g]=C.useState(!1),{user:_}=K(),D=async c=>{g(!0);try{await U.post(I.job_order.statusActions,{job_card_id:n.job_card_id,status:c}),w.success("Status updated successfully"),p()}catch(u){console.error("Failed to update status:",u),w.error(u.response?.data?.message||"Failed to update status")}finally{g(!1)}},i=(()=>{const c=_?.role?.role_name,u=n.status,x=je(c||""),S=Q(c||"")||c==="Super Admin"||x;let m=[];switch(u){case o.PENDING_APPROVAL:x&&(m=[o.APPROVED,o.CANCELLED]);break;case o.APPROVED:S&&(m=[o.IN_PROGRESS]),x&&m.push(o.CANCELLED);break;case o.IN_PROGRESS:S&&(m=[o.COMPLETED,o.CLOSED]),x&&m.push(o.CANCELLED);break;case o.COMPLETED:S&&(m=[o.CLOSED]);break;case o.CANCELLED:x&&(m=[o.PENDING_APPROVAL]);break;case o.CLOSED:break;case o.OVERDUE:S&&(m=[o.IN_PROGRESS,o.COMPLETED]),x&&m.push(o.CANCELLED);break}return m})(),d=c=>c.replace(/_/g," ").replace(/\b\w/g,u=>u.toUpperCase()),f=c=>{switch(c){case o.PENDING_APPROVAL:return"text-yellow-600 bg-yellow-50";case o.APPROVED:return"text-green-600 bg-green-50";case o.IN_PROGRESS:return"text-blue-600 bg-blue-50";case o.COMPLETED:return"text-purple-600 bg-purple-50";case o.CLOSED:return"text-gray-600 bg-gray-50";case o.CANCELLED:return"text-red-600 bg-red-50";case o.OVERDUE:return"text-orange-600 bg-orange-50";default:return"text-gray-600 bg-gray-50"}};return e.jsx("div",{className:"flex items-center gap-2",children:N?e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"}),e.jsx("span",{className:"text-xs text-gray-500",children:"Updating..."})]}):e.jsxs("select",{className:`text-xs border border-gray-300 rounded px-2 py-1 focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white min-w-[120px] ${f(n.status)}`,value:n.status,onChange:c=>{c.target.value!==n.status&&D(c.target.value)},disabled:i.length===0,children:[e.jsx("option",{value:n.status,children:d(n.status)}),i.map(c=>e.jsx("option",{value:c,children:d(c)},c))]})})},Je=()=>{const{page:n,rowsPerPage:p,setTotal:N,renderPagination:g}=ye(),_=se(),{selectedBranchId:D,user:E}=K(),{setJobOrders:i}=le(),[d,f]=C.useState([]),[c,u]=C.useState(!1),[x,S]=C.useState(""),[m,T]=C.useState({}),q=[{name:"jc_number",label:"Job Card Number",placeholder:"Enter Job Card Number"},{name:"date_from",label:"Date From",type:"date"},{name:"date_to",label:"Date To",type:"date"}],P=async a=>{u(!0);try{const h={page:n+1,rowsPerPage:p,...D&&{branch_id:D}};a&&(a.jc_number&&(h.jc_number=a.jc_number),a.date_from&&a.date_to?a.date_from===a.date_to?h.date=a.date_from:(h.date_from=a.date_from,h.date_to=a.date_to):(a.date_from&&(h.date_from=a.date_from),a.date_to&&(h.date_to=a.date_to)));const k=await U.get(I.job_order.list,{params:h}),b=k.data?.job_cards||[],A=k.data?.pagination;f(b),A?.total!==void 0&&N(A.total);const L=E?.role?.role_name;if(Q(L||"")||L==="Super Admin"){const W=b.filter(V=>V.status==="pending").length;i(W)}}catch(h){console.error("Failed to fetch job orders:",h),w.error("Failed to fetch job orders")}finally{u(!1)}},Z=async a=>{try{const h=w.loading("Preparing job card for download..."),b=(await U.get(I.job_order.details(a.id))).data.job_card,A=r=>{if(!r||typeof r!="string")return"file";const y=r.split(".").pop()?.toLowerCase();return y&&["jpg","jpeg","png","gif","bmp","webp"].includes(y)?"image":"file"},L=[b.documents,b.attachments,b.files,b.uploaded_files].filter(Boolean),W=(b.image_path||[]).map(r=>({url:r,name:r.split("/").pop()||"File",type:"auto"})),G=[...L.flat(),...W].filter(r=>typeof r=="string"?!0:r&&(r.url||r.file_path||r.path)).map(r=>{let y,J;return typeof r=="string"?(y=r,J=r.split("/").pop()||"File"):(y=r.url||r.file_path||r.path,J=r.name||r.file_name||r.original_name||r.filename||(typeof y=="string"?y.split("/").pop():"File")),console.log("url url ---->",y),{name:J,type:A(y),url:y}}).filter(r=>r!==null),Y=G.filter(r=>r.type==="image").slice(0,6),ee=G.filter(r=>r.type==="file").slice(0,5),H=Y.map(r=>({...r,corsBlocked:!0,displayUrl:r.url}));console.log("Processed images with CORS handling:",H);const te=await ue(e.jsx(Ce,{jobOrder:b,documents:[...H,...ee]})).toBlob(),$=URL.createObjectURL(te),v=document.createElement("a");v.href=$,v.setAttribute("download",`job-card-${a.job_card_number||a.id}.pdf`),document.body.appendChild(v),v.click(),v.remove(),URL.revokeObjectURL($),w.dismiss(h),w.success("Job card downloaded successfully")}catch(h){console.error("Failed to download job card:",h),w.error("Failed to download job card")}};C.useEffect(()=>{P(m)},[n,p,D]);const X=async a=>{T(a),await P(a)},R=x?d.filter(a=>a.status===x):d;return c?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx(pe,{})}):e.jsxs("div",{className:"space-y-6",children:[e.jsx(be,{fields:q,onFilter:X,defaultValues:m}),e.jsx(fe,{module:"JobOrderStatus",selectedStatus:x,onChange:S}),e.jsxs(ae,{title:`Job Orders (${R.length})`,createOnClick:F.hasPermission("job_card_management_create")?()=>_(O.JOB_ORDER.CREATE):void 0,children:[e.jsxs(re,{children:[e.jsx(ne,{cols:[{title:"Job Card No"},{title:"Job Name"},{title:"Customer"},{title:"Job Date"},{title:"Expected Delivery"},{title:"Job Type"},{title:"Created At"},{title:"Status"},{title:"Actions"}]}),e.jsx("tbody",{children:c?e.jsx("tr",{children:e.jsx("td",{colSpan:10,className:"px-6 py-12 text-center",children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-red-600"}),e.jsx("p",{className:"mt-2 text-sm text-gray-500",children:"Loading job orders..."})]})})}):R.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:10,className:"px-6 py-12 text-center",children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("svg",{className:"w-12 h-12 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),e.jsx("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"No job orders"}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:x?`No job orders found with status "${x}"`:"Get started by creating a new job order."})]})})}):R.map((a,h)=>e.jsxs(oe,{children:[e.jsx(j,{className:"px-5",children:n*p+h+1}),e.jsx(j,{className:"w-40",children:e.jsx("div",{className:"flex items-center",children:e.jsx("div",{className:"text-sm font-medium text-gray-900",children:a.job_card_number||"-"})})}),e.jsx(j,{className:"w-48",children:e.jsx("div",{className:"text-sm text-gray-900",children:a.job_name||"-"})}),e.jsx(j,{className:"w-48",children:e.jsx("div",{className:"flex items-center",children:e.jsx("div",{children:e.jsx("div",{className:"text-sm font-medium text-gray-900",children:a.customer?.party_name||a.customer_name||"—"})})})}),e.jsx(j,{className:"w-32",children:e.jsx("div",{className:"text-sm text-gray-900",children:z.date(a.job_date)})}),e.jsx(j,{className:"w-32",children:e.jsx("div",{className:"text-sm text-gray-900",children:z.date(a.expected_delivery_date)})}),e.jsx(j,{className:"w-32",children:e.jsx("span",{className:"capitalize text-sm text-gray-900",children:a.job_type?.replace(/_/g," ")||"-"})}),e.jsx(j,{className:"w-32",children:e.jsx("div",{className:"text-sm text-gray-500",children:z.date(a.created_at)})}),e.jsx(j,{className:"w-40",children:e.jsx(_e,{jobOrder:{job_card_id:a.id,status:a.status},onStatusUpdate:P})}),e.jsx(j,{className:"w-20",children:e.jsxs(ie,{children:[F.hasPermission("job_card_management_update")&&e.jsx(ce,{onClick:()=>_(`${O.JOB_ORDER.CREATE}?editId=${a.id}`)}),e.jsx(ge,{onClick:()=>Z(a)}),F.hasPermission("job_card_management_delete")&&e.jsx(de,{refetch:P,endpoint:I.job_order.delete(a.id)})]})})]},a.id))})]}),R.length>0&&g()]})]})};export{Je as default};
