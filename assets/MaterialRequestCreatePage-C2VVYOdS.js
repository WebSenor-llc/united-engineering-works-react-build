import{ae as V,h as f,e as v,u as W,i as z,r as p,a as Y,j as e,B as q,y as b,A as E}from"./index-DHxjsmS_.js";import{T as x}from"./TextInput-p5Tar9_e.js";import{S as _}from"./Select-BVH5BbOB.js";import{T as J,a as K}from"./TableDelete-CBS2zXrt.js";import{T as X,a as Z,b as m}from"./TableWrapper-Cc34JFCi.js";import{T as ee}from"./TableRow-CUJFv1cP.js";import{u as se,b as re,c as te,C as l}from"./index.esm-O_A2BQbF.js";import{u as ae}from"./useItemsStore-BquGd8WC.js";import{u as le}from"./useMachineStore-b5E4hC7U.js";import{F as ne}from"./FormHeader-ClhnmCTk.js";import{o as ie,m as oe}from"./yup-BWCmlrJm.js";import{I as ce}from"./ItemSelect-Dz1VRzRP.js";const de=V(h=>({branches:[],loading:!1,error:null,fetchBranches:async()=>{h({loading:!0,error:null});try{const j=await f.get(v.branches.all);h({branches:j.data?.branches||[],loading:!1})}catch(j){h({loading:!1,error:j?.message||"Failed to fetch branches"})}}})),me={department_from:"",department_to:"Store Department",required_date:"",priority:"Normal",purpose:"",Note:"",project_use:"",project_note:"",machine_use:"",machine_note:"",site_use:"",site_note:"",general_use:"",general_note:"",inspection:"",items:[{item_id:0,item_name:"",item_code:"",item_unit:"",req_qty:0,stock:null,remark:"",max_stock_level:0}]},ue="w-full h-10 rounded-md border border-gray-300 px-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white",we=()=>{const h=W(),[j]=z(),o=j.get("id")?Number(j.get("id")):void 0,[M,S]=p.useState(!1),[w,k]=p.useState(!1),[c,P]=p.useState(null),{selectedBranchId:T,user:A}=Y(),{control:t,handleSubmit:$,formState:{errors:i},setValue:u,reset:D}=se({defaultValues:me,resolver:ie(oe)}),{fields:R,append:F,remove:U}=re({control:t,name:"items"}),{items:L,fetchItems:N}=ae(),{machines:B,fetchMachines:C}=le(),{branches:H,fetchBranches:I}=de(),g=A?.role,y=te({control:t});p.useEffect(()=>{N(),C(),I()},[N,C,I]),p.useEffect(()=>{g?.role_name&&(g?.role_name==="Store Manager"&&u("department_from","Store Department"),["Workshop Supervisor","Dept Head","Super Admin"].includes(g?.role_name)&&u("department_from","Production Department"))},[g?.role_name,u]),p.useEffect(()=>{o&&y&&console.log("Current form values:",y)},[y,o]);const O=async()=>{if(o){S(!0);try{const s=await f.get(v.material_requisition.details(o)),r=s.data.data?.material_requisition||s.data.material_requisition||s.data,a=n=>n?new Date(n).toISOString().split("T")[0]:"";if(!r){console.error("No data found in API response"),b.error("No data found for this material request");return}P(r);const d={department_from:r.department||"Production Department",department_to:"Store Department",purpose:r.remarks||"",required_date:a(r.required_by_date||""),priority:r.priority||"Normal",Note:"",project_use:"",project_note:"",machine_use:"",machine_note:"",site_use:"",site_note:"",general_use:"",general_note:"",items:r.items&&r.items.length>0?r.items.map(n=>({item_id:n.item_id||0,item_name:n.item?.item_name||"",item_code:n.item?.item_code||"",item_unit:n.item?.unit?.unit_name||"",req_qty:Number(n.quantity_required||0),approved_qty:null,inspection:"",remark:n.remarks||"",max_stock_level:n.item?.max_stock_level||0,stock:n.item?.current_stock||null})):[{item_id:0,item_name:"",item_code:"",item_unit:"",req_qty:0,stock:null,approved_qty:null,inspection:"",remark:"",max_stock_level:0}]};D(d)}catch(s){console.error("Error loading request details:",s),b.error("Failed to load material request details")}finally{S(!1)}}};p.useEffect(()=>{N().then(()=>{o&&O()})},[o]);const Q=async s=>{k(!0);try{const r={department:s.department_from,required_by_date:s.required_date,priority:s.priority,remarks:s.purpose||"",project_use:s.project_use||null,project_note:s.project_note||null,machine_use:s.machine_use?Number(s.machine_use):null,machine_note:s.machine_note||null,site_use:s.site_use?Number(s.site_use):null,site_note:s.site_note||null,general_use:s.general_use||null,general_note:s.general_note||null,branch_id:T,inspection:s.inspection,items:s.items.map(n=>({item_id:Number(n.item_id),quantity_required:Number(n.req_qty),specification:n.item_unit,remarks:n.remark||""}))},a=o?v.material_requisition.update(o):v.material_requisition.create;await(o?f.put:f.post)(a,r),b.success(o?"Material Request Updated Successfully":"Material Request Created Successfully"),h(E.MATERIAL_REQUEST.LIST)}catch(r){console.error("Error:",r),b.error(r.response?.data?.message||"Failed to save material request")}finally{k(!1)}},G=()=>{h(E.MATERIAL_REQUEST.LIST)};return M?e.jsx("div",{className:"flex justify-center items-center min-h-screen",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-red-600"})}):e.jsx("div",{className:"w-full min-h-screen bg-gray-50 p-4",children:e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsx(ne,{title:"Material Requisition Form",subtitle:"Provide department details and list every item you need in this request."}),e.jsxs("form",{onSubmit:$(Q),className:"space-y-8 mt-8",children:[e.jsxs("section",{className:"bg-white rounded-lg shadow-sm p-4 sm:p-6 space-y-6",children:[e.jsxs("div",{className:"border-b border-gray-200 pb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Request Details"}),e.jsx("div",{className:"text-sm font-semibold text-gray-700 mt-2",children:e.jsx("p",{children:"Please fill atleast one pair among Project use/Machine use/Site use/General use/Note"})})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 sm:gap-6 sm:grid-cols-2 lg:grid-cols-3",children:[o&&c&&e.jsx("div",{className:"col-span-full",children:e.jsxs("div",{className:"bg-gray-50 border border-gray-200 rounded p-3",children:[e.jsx("h4",{className:"font-semibold text-gray-800 mb-2",children:"Material Request Details"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("p",{className:"text-sm text-gray-700",children:[e.jsx("strong",{children:"MR Number:"})," ",c.mr_number||"N/A"]}),e.jsxs("p",{className:"text-sm text-gray-700",children:[e.jsx("strong",{children:"Department:"})," ",c.department||"N/A"]}),e.jsxs("p",{className:"text-sm text-gray-700",children:[e.jsx("strong",{children:"Status:"})," ",c.status||"N/A"]})]}),(c.status?.includes("Cancelled")||c.status?.includes("Rejected"))&&e.jsx("div",{className:"mt-2 p-2 bg-red-50 border border-red-200 rounded",children:e.jsxs("p",{className:"text-sm text-red-800",children:[e.jsxs("strong",{children:[c.status?.includes("Cancelled")?"Cancellation":"Rejection"," Reason:"]})," ",c.cancellation_reason||c.rejection_reason||c.dept_head_comments||c.super_admin_comments||"No reason provided"]})})]})}),e.jsx(l,{name:"department_from",control:t,render:({field:s})=>e.jsxs(_,{...s,label:"Department From",required:!0,error:i.department_from?.message,disabled:!0,children:[e.jsx("option",{value:"Production Department",children:"Production Department"}),e.jsx("option",{value:"Store Department",children:"Store Department"}),e.jsx("option",{value:"Purchase Department",children:"Purchase Department"})]})}),e.jsx(l,{name:"department_to",control:t,render:({field:s})=>e.jsx(x,{required:!0,...s,label:"Department To"})}),e.jsx(l,{name:"required_date",control:t,render:({field:s})=>e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs("label",{className:"text-sm font-semibold text-gray-700",children:["Required Date ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{...s,type:"date",className:ue}),i.required_date&&e.jsx("span",{className:"text-xs text-red-600 mt-1",children:i.required_date?.message})]})}),e.jsx(l,{name:"priority",control:t,render:({field:s})=>e.jsxs(_,{...s,label:"Priority",required:!0,error:i.priority?.message,children:[e.jsx("option",{value:"Urgent",children:"High"}),e.jsx("option",{value:"Emergency",children:"Medium"}),e.jsx("option",{value:"Normal",children:"Low"})]})}),e.jsx(l,{name:"inspection",control:t,render:({field:s})=>e.jsxs(_,{...s,required:!0,label:"Inspection",value:s.value===void 0?"":String(s.value),onChange:r=>s.onChange(r.target.value==="true"),children:[e.jsx("option",{value:"",children:"Select"}),e.jsx("option",{value:"true",children:"Yes"}),e.jsx("option",{value:"false",children:"No"})]})}),e.jsx("div",{className:"col-span-full",children:e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsx(l,{name:"project_use",control:t,render:({field:s})=>e.jsx(x,{...s,value:s.value??"",label:"Project Use",error:i?.project_use?.message,placeholder:"Enter project details"})}),e.jsx(l,{name:"project_note",control:t,render:({field:s})=>e.jsx(x,{...s,value:s.value??"",label:"Project Note",error:i?.project_note?.message,placeholder:"Enter project note"})})]})}),e.jsx("div",{className:"col-span-full",children:e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsx(l,{name:"machine_use",control:t,render:({field:s})=>e.jsxs(_,{...s,value:s.value??"",label:"Machine Use",error:i?.machine_use?.message,children:[e.jsx("option",{value:"",children:"Select Machine"}),B.map(r=>e.jsx("option",{value:r.id,children:r.name},r.id))]})}),e.jsx(l,{name:"machine_note",control:t,render:({field:s})=>e.jsx(x,{...s,value:s.value??"",label:"Machine Note",error:i?.machine_note?.message,placeholder:"Enter machine note"})})]})}),e.jsx("div",{className:"col-span-full",children:e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsx(l,{name:"site_use",control:t,render:({field:s})=>e.jsxs(_,{...s,value:s.value??"",label:"Site Use",error:i?.site_use?.message,children:[e.jsx("option",{value:"",children:"Select Branch"}),H.map(r=>e.jsx("option",{value:r.id,children:r.branch_name},r.id))]})}),e.jsx(l,{name:"site_note",control:t,render:({field:s})=>e.jsx(x,{...s,value:s.value??"",label:"Site Note",error:i?.site_note?.message,placeholder:"Enter site note"})})]})}),e.jsx("div",{className:"col-span-full",children:e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsx(l,{name:"general_use",control:t,render:({field:s})=>e.jsx(x,{...s,value:s.value??"",label:"General Use",error:i?.general_use?.message,placeholder:"Enter general use details"})}),e.jsx(l,{name:"general_note",control:t,render:({field:s})=>e.jsx(x,{...s,value:s.value??"",label:"General Note",error:i?.general_note?.message,placeholder:"Enter general note"})})]})})]})]}),e.jsxs("section",{className:"bg-white rounded-lg shadow-sm p-4 sm:p-6 space-y-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsx("div",{children:e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Items Requested"})}),e.jsx(q,{className:"bg-red-600 text-white px-4 py-2 w-full sm:w-auto",onClick:()=>F({item_id:0,item_name:"",item_code:"",item_unit:"",req_qty:0,stock:null,remark:"",max_stock_level:0}),children:"+Add Item"})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(X,{children:[e.jsx(Z,{cols:[{title:"Item Name"},{title:"Item Code"},{title:"Item Unit"},{title:"Req Qty"},{title:"Stock In Store"},{title:"Remark"},{title:"Actions"}]}),e.jsx("tbody",{children:R.map((s,r)=>e.jsxs(ee,{children:[e.jsx(m,{className:"w-12 text-center font-medium",children:r+1}),e.jsx(m,{className:"w-64 relative",children:e.jsx(l,{name:`items.${r}.item_id`,control:t,render:()=>e.jsx(ce,{control:t,name:`items.${r}.item_id`,disabled:!1,onChange:a=>{const d=L.find(n=>n.id===a);d&&(u(`items.${r}.item_id`,d.id),u(`items.${r}.item_code`,d.item_code),u(`items.${r}.item_name`,d.item_name),u(`items.${r}.item_unit`,d.unit?.unit_name||""))}})})}),e.jsx(m,{className:"w-32",children:e.jsx(l,{name:`items.${r}.item_code`,control:t,render:({field:a})=>e.jsx("input",{...a,className:"w-full h-[45px] border border-gray-300 rounded-lg px-3 text-sm bg-gray-50 font-mono",placeholder:"Code",readOnly:!0})})}),e.jsx(m,{className:"w-24",children:e.jsx(l,{name:`items.${r}.item_unit`,control:t,render:({field:a})=>e.jsx("input",{...a,className:"w-full h-[45px] border border-gray-300 rounded-lg px-3 text-sm bg-gray-50 text-center",placeholder:"Unit",readOnly:!0})})}),e.jsx(m,{className:"w-24",children:e.jsx(l,{name:`items.${r}.req_qty`,control:t,render:({field:a})=>e.jsx("input",{...a,className:"w-full h-[45px] border border-gray-300 rounded-lg px-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-center",placeholder:"Qty",type:"number",min:"1",onFocus:()=>{a.value===0&&a.onChange("")}})})}),e.jsx(m,{className:"w-28",children:e.jsx(l,{name:`items.${r}.stock`,control:t,render:({field:a})=>e.jsx("input",{...a,className:"w-full h-[45px] border border-gray-300 rounded-lg px-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-center",value:a.value??"",placeholder:"Stock",type:"number"})})}),e.jsx(m,{className:"w-40",children:e.jsx(l,{name:`items.${r}.remark`,control:t,render:({field:a})=>e.jsx("input",{...a,className:"w-full h-[45px] border border-gray-300 rounded-lg px-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",value:a.value??"",placeholder:"Remark"})})}),e.jsx(m,{className:"w-16",children:e.jsx(J,{children:e.jsx(K,{onClick:()=>{R.length>1&&U(r)}})})})]},s.id))})]})})]}),Object.keys(i).length>0&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-md p-4",children:e.jsxs("div",{className:"flex",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("svg",{className:"h-5 w-5 text-red-400",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z",clipRule:"evenodd"})})}),e.jsxs("div",{className:"ml-3",children:[e.jsx("h3",{className:"text-sm font-medium text-red-800",children:"Please fix the following errors:"}),e.jsx("div",{className:"mt-2 text-sm text-red-700",children:e.jsx("ul",{className:"list-disc pl-5 space-y-1",children:Object.entries(i).map(([s,r])=>e.jsx("li",{children:r?.message||`${s} is invalid`},s))})})]})]})}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx(q,{variant:"outline",type:"button",onClick:G,children:"Cancel"}),e.jsx(q,{className:"bg-red-600 text-white",type:"submit",loading:w,disabled:w,children:o?"Update Material Request":"Submit Material Request"})]})]})]})})};export{we as default};
