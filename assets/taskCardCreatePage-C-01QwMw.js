import{r as u,j as e,h as S,e as k,W,X as z,y as j,u as K,b as Q,a as I,B as P,A as O}from"./index-Cq0y9b1s.js";import{C as l,u as V}from"./index.esm-Bk38Ypoi.js";import{T as m}from"./TextInput-BsfXuJft.js";import{T as w}from"./TextArea-C-zYOwkd.js";import{S as C}from"./Select-DxjI7zGn.js";import{S as $}from"./SearchableSelect-y5IAJ34l.js";import{F as J}from"./FormHeader-BxKCVI7N.js";import{L as X}from"./Loading-BKbT3m1q.js";import{u as G}from"./useMachineStore-BNTdx_sL.js";import{o as Y,z as Z}from"./yup-BojQMOwg.js";import{b as ee}from"./rolePermissions-BvMMyxfj.js";import{u as re}from"./usePartyStore-BxweyeWe.js";import"./BackButton-zvkksV3N.js";import"./enum-SoLNwffs.js";const se=({control:f,name:g,label:n="Branch",required:c=!1,error:y,disabled:v=!1})=>{const[x,_]=u.useState([]),[p,b]=u.useState(!1);return u.useEffect(()=>{(async()=>{b(!0);try{const h=(await S.get(k.branches.branch)).data?.branches||[];_(h)}catch(i){console.error("BranchSelect: Error fetching branches:",i)}finally{b(!1)}})()},[]),e.jsx(l,{name:g,control:f,render:({field:t})=>e.jsxs(C,{...t,label:n,required:c,error:y,disabled:v||p,onChange:i=>t.onChange(Number(i.target.value)),children:[e.jsx("option",{value:"",children:p?"Loading branches...":"Select Branch"}),x.map(i=>e.jsx("option",{value:i.id,children:i.branch_name},i.id))]})})},ae=({label:f="Upload Images",maxFiles:g=6,value:n,onChange:c,error:y})=>{const[v,x]=u.useState(!1),_=u.useRef(null),p=t=>{const i=t.filter(h=>h.type.startsWith("image/"));if(i.length!==t.length&&j.error("Only image files are allowed here"),n.length+i.length>g){j.error(`Max ${g} files allowed`);return}c([...n,...i])},b=t=>{c(n.filter((i,h)=>h!==t))};return e.jsxs("div",{className:"w-full",children:[e.jsxs("label",{className:"text-sm font-medium text-gray-700 mb-2 block",children:[f," (Max ",g,")"]}),n.length<g&&e.jsxs("div",{className:`border-2 border-dashed rounded-lg p-6 cursor-pointer ${v?"border-blue-500 bg-blue-50":"border-gray-300"}`,onClick:()=>_.current?.click(),onDragOver:t=>{t.preventDefault(),x(!0)},onDragLeave:()=>x(!1),onDrop:t=>{t.preventDefault(),x(!1),p(Array.from(t.dataTransfer.files))},children:[e.jsx("input",{type:"file",ref:_,className:"hidden",accept:"image/*",multiple:!0,onChange:t=>t.target.files&&p(Array.from(t.target.files))}),e.jsx(W,{className:"mx-auto text-3xl text-gray-400"}),e.jsx("p",{className:"text-center text-sm text-gray-500 mt-2",children:"Drag & drop images or click to select"})]}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 mt-4",children:n.map((t,i)=>{const h=typeof t=="string"?t:URL.createObjectURL(t);return typeof t!="string"&&!t.type.startsWith("image/")?null:e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:h,className:"w-full h-32 object-cover rounded border"}),e.jsx("button",{type:"button",onClick:()=>b(i),className:"absolute -top-2 -right-2 bg-red-600 text-white rounded-full p-1",children:e.jsx(z,{size:12})})]},i)})}),y&&e.jsx("p",{className:"text-xs text-red-500 mt-1",children:y})]})},be=()=>{const f=K(),[g]=Q(),n=g.get("editId"),{selectedBranchId:c}=I(),[y,v]=u.useState(!1),[x,_]=u.useState(!1),{parties:p,fetchParties:b}=re(),[t,i]=u.useState(null),{machines:h,fetchMachines:D}=G(),A={job_name:"",task_card_no:"",job_date:new Date().toISOString().split("T")[0],department:"Production Department",job_description:"",quantity:1,expected_delivery_date:"",job_type:"",priority:"Normal",customer_id:"",customer_name:"",customer_contact:"",customer_address:"",supervisor_id:"",supervisor_address:"",branch_id:c?Number(c):0,machine_used:"",challan_no:"",challan_date:"",invoice_no:"",po_no:"",remarks:"",images:[],note:""},{control:o,handleSubmit:B,setValue:N,watch:L,reset:E,formState:{errors:d}}=V({defaultValues:A,resolver:Y(Z,{context:{isEdit:!!n}})}),{user:R}=I(),U=R?.id,T=L("customer_id"),M=async r=>{if(r)try{const a=(await S.get(k.user_management.all,{params:{branch_id:r}})).data.users.filter(q=>ee(q.role.role_name));i(a)}catch(s){console.log(s),j.error("Failed to fetch users")}};u.useEffect(()=>{b(),D(),c&&M(Number(c))},[b,D,c]),u.useEffect(()=>{if(T&&p.length>0){const r=p.find(s=>s.id===Number(T));r&&(N("customer_name",r.party_name),N("customer_contact",r.phone||""),N("customer_address",r.address||""))}},[T,p,N]),u.useEffect(()=>{n&&(async()=>{v(!0);try{const s=await S.get(k.task_cards.details(Number(n))),a=s.data?.task_card||s.data;E({...A,...a,task_card_no:a.task_card_number,branch_id:a.branch_id?Number(a.branch_id):0,supervisor_id:a.allocated_supervisor_id?String(a.allocated_supervisor_id):"",customer_id:a.customer_id?String(a.customer_id):"",customer_name:a.customer?.party_name||"",customer_contact:a.customer?.contact_number||"",customer_address:a.customer?.address||"",po_no:a.customer_po_number||"",challan_no:a.challan_number||"",invoice_no:a.invoice_number||"",machine_used:a.machine_required?String(a.machine_required):"",priority:a.priority||"Normal",job_date:a.task_date?a.task_date.split("T")[0]:"",expected_delivery_date:a.expected_delivery_date?a.expected_delivery_date.split("T")[0]:"",challan_date:a.challan_date?a.challan_date.split("T")[0]:"",note:a.note||""})}catch(s){console.error(s),j.error("Failed to load task order details")}finally{v(!1)}})()},[n,E]);const F=async r=>{_(!0);try{const s={task_date:r.job_date,job_name:r.job_name,created_by:U,department:r.department||"Production Department",customer_id:r.customer_id?Number(r.customer_id):null,branch_id:c?Number(c):null,job_description:r.job_description,job_type:r.job_type,priority:r.priority,quantity:Number(r.quantity),expected_delivery_date:r.expected_delivery_date,allocated_supervisor_id:r.supervisor_id?Number(r.supervisor_id):null,machine_required:r.machine_used?Number(r.machine_used):null,challan_number:r.challan_no,challan_date:r.challan_date,invoice_number:r.invoice_no,customer_po_number:r.po_no,remarks:r.remarks,note:r.note,images:[]};n?(await S.put(k.task_cards.update(Number(n)),s),j.success("Task Card updated successfully")):(await S.post(k.task_cards.create,s),j.success("Task Card created successfully")),f(O.TASK_CARD.LIST)}catch(s){console.error("Submission error:",s),j.error(s.response?.data?.message||"Failed to submit task card")}finally{_(!1)}};return y?e.jsx("div",{className:"flex justify-center items-center h-[500px]",children:e.jsx(X,{})}):e.jsx("div",{className:"w-full h-full p-2 sm:p-4 lg:p-6 overflow-y-auto pb-20",children:e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsx(J,{title:n?"Edit Task Card":"Create Task Card",subtitle:n?"Update Task Order details":"Create a new Task Order"}),e.jsxs("form",{onSubmit:B(F),className:"space-y-4 sm:space-y-6 mt-4",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 sm:gap-4",children:[e.jsx(l,{name:"job_name",control:o,rules:{required:"task Name is required"},render:({field:r})=>e.jsx(m,{...r,label:"Task Name",required:!0,error:d.job_name?.message,placeholder:"e.g. Engine Overhaul"})}),n&&e.jsx(l,{name:"task_card_no",control:o,rules:{required:"Task Card No is required"},render:({field:r})=>e.jsx(m,{...r,label:"Task Card No.",required:!0,error:d.task_card_no?.message,placeholder:"TC-2023...",readOnly:!0})}),e.jsx(l,{name:"job_date",control:o,rules:{required:"Date is required"},render:({field:r})=>e.jsx(m,{...r,type:"date",label:"Date",required:!0,error:d.job_date?.message})}),e.jsx(l,{name:"department",control:o,rules:{required:"Department is required"},render:({field:r})=>e.jsx(m,{...r,type:"department",label:"Department",required:!0,error:d.department?.message})})]}),e.jsx("div",{className:"w-full",children:e.jsx(l,{name:"job_description",control:o,rules:{required:"Job Description is required"},render:({field:r})=>e.jsx(w,{...r,label:"Task Description",placeholder:"Describe the task details...",rows:3,required:!0,error:d.job_description?.message})})}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 sm:gap-4",children:[e.jsx(l,{name:"quantity",control:o,rules:{required:"Quantity is required",min:1},render:({field:r})=>e.jsx(m,{...r,type:"number",label:"Quantity",required:!0,error:d.quantity?.message,placeholder:"Enter quantity"})}),e.jsx(l,{name:"expected_delivery_date",control:o,rules:{required:"Expected Delivery is required"},render:({field:r})=>e.jsx(m,{...r,type:"date",label:"Expected Delivery",required:!0,error:d.expected_delivery_date?.message})}),e.jsx(l,{name:"job_type",control:o,rules:{required:"Task Type is required"},render:({field:r})=>e.jsxs(C,{...r,label:"Task Type",required:!0,error:d.job_type?.message,children:[e.jsx("option",{value:"",children:"Select task type"}),e.jsx("option",{value:"amc",children:"AMC"}),e.jsx("option",{value:"new_job",children:"New Task"}),e.jsx("option",{value:"in_house_manufacturing",children:"In house"}),e.jsx("option",{value:"repair",children:"Repair"}),e.jsx("option",{value:"service",children:"Service"})]})}),e.jsx(l,{name:"priority",control:o,rules:{required:"Priority is required"},render:({field:r})=>e.jsxs(C,{...r,label:"Priority",required:!0,error:d.priority?.message,children:[e.jsx("option",{value:"",children:"Select priority"}),e.jsx("option",{value:"Urgent",children:"High"}),e.jsx("option",{value:"Emergency",children:"Medium"}),e.jsx("option",{value:"Normal",children:"Low"})]})})]}),e.jsx("h3",{className:"text-base sm:text-lg font-semibold text-gray-800 border-b pb-1 mt-4 sm:mt-6",children:"Customer Information"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4",children:[e.jsx(l,{name:"customer_id",control:o,render:({field:r})=>e.jsxs(C,{...r,label:"Customer Name",error:d.customer_id?.message,children:[e.jsx("option",{value:"",children:"Select Customer"}),p.filter(s=>s.party_type==="customer").map(s=>e.jsx("option",{value:s.id,children:s.party_name},s.id))]})}),e.jsx(l,{name:"customer_contact",control:o,render:({field:r})=>e.jsx(m,{...r,label:"Customer Contact",placeholder:"Auto-filled from customer",readOnly:!0,className:"bg-gray-100"})}),e.jsx(l,{name:"customer_address",control:o,render:({field:r})=>e.jsx(m,{...r,label:"Customer Address",placeholder:"Auto-filled from customer",readOnly:!0,className:"bg-gray-100"})})]}),e.jsx("h3",{className:"text-base sm:text-lg font-semibold text-gray-800 border-b pb-1 mt-4 sm:mt-6",children:"Assignment"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4",children:[e.jsx(l,{name:"supervisor_id",control:o,render:({field:r})=>e.jsxs(C,{...r,label:"Allocated Supervisor",error:d.supervisor_id?.message,onChange:s=>{const a=s.target.value;r.onChange(a);const q=t?.find(H=>String(H.id)===String(a));q?N("supervisor_address",q.address||""):N("supervisor_address","")},children:[e.jsx("option",{value:"",children:"Select Supervisor"}),t?.map(s=>e.jsx("option",{value:s.id,children:s.full_name},s.id))]})}),e.jsx(se,{control:o,name:"branch_id",label:"Branch Name",required:!0,error:d.branch_id?.message}),e.jsx(l,{name:"machine_used",control:o,rules:{required:"Machine is required"},render:({field:r})=>e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsxs("label",{className:"text-sm font-semibold text-gray-700",children:["Machine Used ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx($,{value:r.value?Number(r.value):void 0,onChange:s=>r.onChange(String(s)),options:h.map(s=>({value:Number(s.id),label:s.name})),placeholder:"Select Machine",error:d.machine_used?.message})]})})]}),e.jsx("h3",{className:"text-base sm:text-lg font-semibold text-gray-800 border-b pb-1 mt-4 sm:mt-6",children:"Internal Tracking"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 sm:gap-4",children:[e.jsx(l,{name:"challan_no",control:o,render:({field:r})=>e.jsx(m,{...r,label:"Challan No.",placeholder:"Enter challan number"})}),e.jsx(l,{name:"challan_date",control:o,render:({field:r})=>e.jsx(m,{...r,type:"date",label:"Challan Date"})}),e.jsx(l,{name:"invoice_no",control:o,render:({field:r})=>e.jsx(m,{...r,label:"Invoice No.",placeholder:"Enter invoice number"})}),e.jsx(l,{name:"po_no",control:o,render:({field:r})=>e.jsx(m,{...r,label:"PO No.",placeholder:"Enter PO number"})})]}),e.jsx("div",{className:"w-full",children:e.jsx(l,{name:"remarks",control:o,render:({field:r})=>e.jsx(w,{...r,label:"Remarks",placeholder:"Add any additional notes or remarks...",rows:3})})}),e.jsx("div",{className:"w-full",children:e.jsx(l,{name:"note",control:o,render:({field:r})=>e.jsx(w,{...r,label:"Note",placeholder:"Add any additional notes or comments...",error:d.note?.message,rows:3})})}),e.jsx("div",{className:"w-full",children:e.jsx(l,{name:"images",control:o,render:({field:r})=>e.jsx(ae,{value:r.value,onChange:r.onChange,error:d.images?.message,maxFiles:6})})}),e.jsxs("div",{className:"flex flex-col sm:flex-row justify-end gap-3 pt-4 sm:pt-6",children:[e.jsx(P,{variant:"outline",type:"button",className:"w-full sm:w-auto order-2 sm:order-1",onClick:()=>f(O.TASK_CARD.LIST),children:"Cancel"}),e.jsx(P,{type:"submit",loading:x,className:"bg-blue-600 text-white w-full sm:w-auto order-1 sm:order-2",children:n?"Update Task Card":"Save Task Card"})]})]})]})})};export{be as default};
