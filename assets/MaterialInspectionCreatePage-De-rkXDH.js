import{u as X,b as Y,a as Z,r as p,j as e,B as G,A as j,h as y,e as N,y as b}from"./index-tcS5gCoO.js";import{F as ee}from"./FormHeader-B8x7chaq.js";import{T as o}from"./TextInput-DqjxDQ_5.js";import{L as te}from"./ListWrapper-Bq1Gfq5n.js";import{T as ae}from"./TableActions-BTram3Ae.js";import{T as m}from"./TableData-jAiBRPDM.js";import{T as re}from"./TableDelete-DiRjpVQp.js";import{T as se,a as ne}from"./TableWrapper-BOyIOkDJ.js";import{u as ie,b as le,C as c}from"./index.esm-DeJALOLU.js";import{u as ce}from"./useItemsStore-Qkrb_-1t.js";import{L as oe}from"./Loading-BJ2f4d1H.js";import"./BackButton-DnVaUWoS.js";const w={department_from:"Store Department",department_to:"",grn_number:"",grn_date:"",ms:"",items:[{item_id:"",item_code:"",description_of_goods:"",unit:"",qty:"",thick_bl:"",length_bl:"",width_bl:"",thick_actual:"",length_actual:"",width_actual:"",accepted_quantity:"",rejected_quantity:"",reason_if_reject:"",remark:""}]},Ne=()=>{const g=X(),[L]=Y(),_=L.get("id"),l=L.get("grnId"),{selectedBranchId:F}=Z(),[S,E]=p.useState(!1),[B,R]=p.useState(!1),q=p.useRef(null),{control:i,handleSubmit:W,setValue:u,watch:U,reset:$}=ie({defaultValues:w}),[k,P]=p.useState([]),[v,M]=p.useState(!1),[A,I]=p.useState(null),{items:C,loading:V,fetchItems:D}=ce(),{fields:H,append:Q}=le({control:i,name:"items"}),z=async()=>{M(!0);try{const n=await y.get(N.grn.pendingInspection);P(n.data?.grns||[])}catch(n){console.error("Error fetching GRNs for inspection:",n),P([])}finally{M(!1)}};p.useEffect(()=>{D(),z()},[D]),p.useEffect(()=>{if(!_)return;(async()=>{R(!0);try{const a=await y.get(N.material_inspection_report.details(parseInt(_,10))),t=a.data?.report||a.data?.data||a.data,s=(t.items||[]).map(r=>({item_id:r.item_id?.toString()||"",item_code:r.item?.item_code||"",description_of_goods:r.item?.item_name||"",unit:r.item?.unit?.unit_name||"",qty:r.quantity?.toString()||"",thick_bl:r.bill_thick?.toString()||"",length_bl:r.bill_length?.toString()||"",width_bl:r.bill_width?.toString()||"",thick_actual:r.actual_req_thick?.toString()||"",length_actual:r.actual_req_length?.toString()||"",width_actual:r.actual_req_width?.toString()||"",accepted_quantity:r.accepted_quantity?.toString()||"",rejected_quantity:r.rejected_quantity?.toString()||"",reason_if_reject:r.reject_reason||"",remark:""}));$({department_from:t.from_department||w.department_from,department_to:t.to_department||w.department_to,grn_number:t.grn_number||"",grn_date:"",ms:t.ms||"",items:s.length>0?s:w.items})}catch(a){console.error(a),b.error("Failed to load inspection report details"),g(j.MATERIAL_INSPECTION_REPORT.LIST)}finally{R(!1)}})()},[_,$,g]),p.useEffect(()=>{if(!l)return;(async()=>{R(!0);try{const a=await y.get(N.grn.details(parseInt(l,10))),t=a.data?.grn||a.data?.data||a.data;if(!t){b.error("GRN not found"),g(j.GOOD_RECEIVE_REPORT.LIST);return}I(t);const s=r=>{if(!r)return"";const[d]=r.split("T"),[f,T,K]=d.split("-");return`${K}-${T}-${f}`};if(u("grn_number",t.grn_number||""),u("grn_date",s(t.grn_date||"")),u("ms",t.vendor?.party_name||""),t.items?.length){const r=t.items.map(d=>({item_id:d.item_id?.toString()||"",item_code:d.item?.item_code||"",description_of_goods:d.item?.item_name||"",unit:d.item?.unit?.unit_name||"PCS",qty:d.quantity_received?.toString()||"",thick_bl:"",length_bl:"",width_bl:"",thick_actual:"",length_actual:"",width_actual:"",accepted_quantity:d.quantity_received?.toString()||"",rejected_quantity:"0",reason_if_reject:d.inspection_remarks||"",remark:d.remarks||""}));u("items",r)}}catch(a){console.error(a),b.error("Failed to load GRN details"),g(j.GOOD_RECEIVE_REPORT.LIST)}finally{R(!1)}})()},[l,u,g]);const h=p.useMemo(()=>l?[]:k.filter(n=>n.status==="pending_inspection"),[k,l]);p.useEffect(()=>{k.length===0&&console.log("No GRNs available for inspection")},[k.length,h.length,l]);const x=U("grn_number"),O=p.useCallback(n=>{if(!n){q.current=null,I(null),u("items",w.items);return}if(q.current===n||h.length===0)return;const a=h.find(s=>s.grn_number===n);if(!a)return;if(q.current=n,I(a),u("grn_date",(s=>{if(!s)return"";const[r]=s.split("T"),[d,f,T]=r.split("-");return`${T}-${f}-${d}`})(a.grn_date)),u("ms",a.vendor?.party_name||""),a.items?.length){const s=a.items.map(r=>({item_id:r.item_id?.toString()||"",item_code:r.item?.item_code||"",description_of_goods:r.item?.item_name||"",unit:r.item?.unit?.unit_name||"PCS",qty:r.quantity_received?.toString()||"",thick_bl:"",length_bl:"",width_bl:"",thick_actual:"",length_actual:"",width_actual:"",accepted_quantity:r.quantity_received?.toString()||"",rejected_quantity:"0",reason_if_reject:r.inspection_remarks||"",remark:r.remarks||""}));u("items",s,{shouldDirty:!1})}},[h,u]);p.useEffect(()=>{!l&&x&&h.length>0&&O(x)},[x,O,l,h.length]);const J=async n=>{try{E(!0);const a=(n.items||[]).map(s=>({item_id:s.item_id?Number(s.item_id):void 0,quantity:s.qty?Number(s.qty):0,bill_thick:s.thick_bl?Number(s.thick_bl):0,bill_length:s.length_bl?Number(s.length_bl):0,bill_width:s.width_bl?Number(s.width_bl):0,actual_req_thick:s.thick_actual?Number(s.thick_actual):0,actual_req_length:s.length_actual?Number(s.length_actual):0,actual_req_width:s.width_actual?Number(s.width_actual):0,accepted_quantity:s.accepted_quantity?Number(s.accepted_quantity):0,rejected_quantity:s.rejected_quantity?Number(s.rejected_quantity):0,reject_reason:s.reason_if_reject||""})),t={from_department:n.department_from,to_department:n.department_to,grn_number:n.grn_number,ms:n.ms,grn_id:l?parseInt(l,10):A?.id||null,branch_id:F,items:a};_?(await y.put(N.material_inspection_report.update(parseInt(_,10)),t),b.success("Material inspection report updated successfully")):(await y.post(N.material_inspection_report.create,t),b.success("Material inspection report created successfully")),g(j.MATERIAL_INSPECTION_REPORT.LIST)}catch(a){console.error(a),b.error(a?.response?.data?.message||`Failed to ${_?"update":"create"} material inspection report`)}finally{E(!1)}};return B?e.jsx("div",{className:"flex justify-center py-20",children:e.jsx(oe,{})}):e.jsxs("div",{className:"w-full h-full flex flex-col overflow-hidden bg-gray-50",children:[e.jsxs("div",{className:"flex justify-between items-center p-4 bg-white border-b sticky top-0 z-10 shadow-sm shrink-0",children:[e.jsx(ee,{title:_?"Edit Material Inspection Report Form":"Material Inspection Report Form",subtitle:_?"Update the Material Inspection Report details":"Fill out the form to submit a new material inspection report."}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(G,{variant:"outline",onClick:()=>g(j.MATERIAL_INSPECTION_REPORT.LIST),disabled:S,children:"Cancel"}),e.jsx(G,{onClick:W(J),loading:S,disabled:S,children:_?"Update Report":"Submit Report"})]})]}),e.jsxs("div",{className:"flex-1 overflow-auto p-4 space-y-8 pb-20",children:[e.jsx("div",{className:"bg-white rounded-lg shadow p-6",children:e.jsxs("div",{className:"grid grid-cols-2 gap-5",children:[e.jsx(c,{name:"department_from",control:i,render:({field:n})=>e.jsx(o,{required:!0,...n,label:"Department From"})}),e.jsx(c,{name:"department_to",control:i,render:({field:n})=>e.jsx(o,{required:!0,...n,label:"Department To"})}),e.jsx(c,{name:"grn_number",control:i,render:({field:n})=>e.jsxs("div",{children:[e.jsxs("label",{className:"text-sm font-semibold text-gray-700 mb-1",children:["GRN Number",!l&&e.jsx("span",{className:"text-xs text-gray-500 ml-2",children:"(Only GRNs pending inspection)"})]}),l?e.jsx("input",{...n,readOnly:!0,className:"w-full h-[45px] rounded-lg border border-gray-300 px-4 mt-1 text-sm bg-gray-50"}):e.jsxs("select",{...n,className:"w-full h-[45px] rounded-lg border border-gray-300 px-4 mt-1 text-sm",children:[e.jsx("option",{value:"",children:v?"Loading...":"Select GRN"}),h.length===0&&!v?e.jsx("option",{value:"",disabled:!0,children:"No GRNs pending inspection"}):h.map(a=>e.jsxs("option",{value:a.grn_number,children:[a.grn_number," - ",a.vendor?.party_name||"Unknown Vendor"]},a.id))]}),!l&&h.length===0&&!v&&e.jsx("p",{className:"text-xs text-amber-600 mt-1",children:"No GRNs are currently pending inspection. Please ensure GRNs have been created and are awaiting inspection."}),l&&e.jsx("p",{className:"text-xs text-green-600 mt-1",children:"Items loaded from selected GRN for inspection."}),!l&&x&&e.jsx("p",{className:"text-xs text-green-600 mt-1",children:"Items will be automatically loaded from the selected GRN."})]})}),e.jsx(c,{name:"grn_date",control:i,render:({field:n})=>e.jsx(o,{...n,label:"GRN Date",placeholder:"Date",readOnly:!0})}),e.jsx(c,{name:"ms",control:i,render:({field:n})=>e.jsx(o,{...n,label:"M/S"})})]})}),e.jsxs(te,{title:"Items for Inspection",children:[x||l?e.jsx("div",{className:"flex justify-between items-center mb-2",children:e.jsxs("div",{className:"text-sm text-blue-600 bg-blue-50 px-3 py-2 rounded-lg",children:[e.jsx("span",{className:"font-medium",children:"Items loaded from GRN:"})," ",x||A?.grn_number]})}):e.jsx("div",{className:"flex justify-end mb-2",children:e.jsx(G,{className:"bg-red-600 text-white px-3 py-1",onClick:()=>Q({item_id:"",item_code:"",description_of_goods:"",unit:"",qty:"",thick_bl:"",length_bl:"",width_bl:"",thick_actual:"",length_actual:"",width_actual:"",accepted_quantity:"",rejected_quantity:"",reason_if_reject:"",remark:""}),children:"+ Add Item"})}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(se,{children:[e.jsx(ne,{cols:[{title:"Description of Goods"},{title:"Item Code"},{title:"Unit"},{title:"Received Qty"},{title:"Thick in MM (B/L)"},{title:"Length in MM (B/L)"},{title:"Width in MM (B/L)"},{title:"Thick in MM (Actual)"},{title:"Length in MM (Actual)"},{title:"Width in MM (Actual)"},{title:"Accepted Qty"},{title:"Rejected Qty"},{title:"Reason If Reject"},{title:"Remark"},{title:"Actions"}]}),e.jsx("tbody",{children:H.map((n,a)=>e.jsxs("tr",{className:"align-middle",children:[e.jsx(m,{children:a+1}),e.jsx(m,{children:e.jsx(c,{name:`items.${a}.description_of_goods`,control:i,render:({field:t})=>t.value&&(x||l)?e.jsx(o,{...t,readOnly:!0,className:"mb-0 w-full h-[40px] bg-gray-50",placeholder:"Item Name"}):e.jsxs("select",{...t,className:"w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm",onChange:r=>{t.onChange(r);const d=C.find(f=>f.item_name===r.target.value);d&&(u(`items.${a}.item_code`,d.item_code),u(`items.${a}.unit`,d.unit?.unit_name||""),u(`items.${a}.item_id`,d.id.toString()))},children:[e.jsx("option",{value:"",children:V?"Loading...":"Select Item"}),C.map(r=>e.jsx("option",{value:r.item_name,children:r.item_name},r.id))]})})}),e.jsx(m,{children:e.jsx(c,{name:`items.${a}.item_code`,control:i,render:({field:t})=>e.jsx(o,{...t,readOnly:!0,className:"mb-0 w-[80px] h-[40px] bg-gray-50",placeholder:"Code"})})}),e.jsx(m,{children:e.jsx(c,{name:`items.${a}.unit`,control:i,render:({field:t})=>e.jsx(o,{...t,readOnly:!0,className:"mb-0 w-[80px] h-[40px] bg-gray-50",placeholder:"Unit"})})}),e.jsx(m,{children:e.jsx(c,{name:`items.${a}.qty`,control:i,render:({field:t})=>e.jsx(o,{...t,type:"number",className:"mb-0 w-[100px] h-[40px]",placeholder:"0"})})}),e.jsx(m,{children:e.jsx(c,{name:`items.${a}.thick_bl`,control:i,render:({field:t})=>e.jsx(o,{...t,className:"mb-0 w-[127px] h-[40px]",placeholder:"Thick (B/L)"})})}),e.jsx(m,{children:e.jsx(c,{name:`items.${a}.length_bl`,control:i,render:({field:t})=>e.jsx(o,{...t,className:"mb-0 w-[127px] h-[40px]",placeholder:"Length (B/L)"})})}),e.jsx(m,{children:e.jsx(c,{name:`items.${a}.width_bl`,control:i,render:({field:t})=>e.jsx(o,{...t,className:"mb-0 w-[127px] h-[40px]",placeholder:"Width (B/L)"})})}),e.jsx(m,{children:e.jsx(c,{name:`items.${a}.thick_actual`,control:i,render:({field:t})=>e.jsx(o,{...t,className:"mb-0 w-[127px] h-[40px]",placeholder:"Thick (Actual)"})})}),e.jsx(m,{children:e.jsx(c,{name:`items.${a}.length_actual`,control:i,render:({field:t})=>e.jsx(o,{...t,className:"mb-0 w-[127px] h-[40px]",placeholder:"Length (Actual)"})})}),e.jsx(m,{children:e.jsx(c,{name:`items.${a}.width_actual`,control:i,render:({field:t})=>e.jsx(o,{...t,className:"mb-0 w-[127px] h-[40px]",placeholder:"Width (Actual)"})})}),e.jsx(m,{children:e.jsx(c,{name:`items.${a}.accepted_quantity`,control:i,render:({field:t})=>e.jsx(o,{...t,type:"number",className:"mb-0 w-[100px] h-[40px]",placeholder:"0"})})}),e.jsx(m,{children:e.jsx(c,{name:`items.${a}.rejected_quantity`,control:i,render:({field:t})=>e.jsx(o,{...t,type:"number",className:"mb-0 w-[100px] h-[40px]",placeholder:"0"})})}),e.jsx(m,{children:e.jsx(c,{name:`items.${a}.reason_if_reject`,control:i,render:({field:t})=>e.jsx(o,{...t,className:"mb-0 w-full h-[40px]",placeholder:"Reason"})})}),e.jsx(m,{children:e.jsx(c,{name:`items.${a}.remark`,control:i,render:({field:t})=>e.jsx(o,{...t,className:"mb-0 w-full h-[40px]",placeholder:"Remark"})})}),e.jsx(m,{children:e.jsxs(ae,{children:[!(x||l)&&e.jsx(re,{}),(x||l)&&e.jsx("span",{className:"text-xs text-gray-500 px-2",children:"From GRN"})]})})]},n.id))})]})})]})]})]})};export{Ne as default};
