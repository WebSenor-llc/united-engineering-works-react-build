import{r as u,a as A,j as e,ap as a,y as _,h as k,e as E,u as C,D as R,P as w,A as S}from"./index-zSIHDd_i.js";import{L as O}from"./ListWrapper-DoFaRH6P.js";import{T as L,a as I,b as o}from"./TableWrapper-Bwk1LSIu.js";import{T as M}from"./TableRow-F8MSZPbu.js";import{T as G,a as H}from"./TableDelete-BEyOmHVS.js";import{T as $}from"./TableEdit-D3e67rz4.js";import{u as F}from"./usePagination-mcOS4Aak.js";import{a as D}from"./rolePermissions-NXJEoSR0.js";const V=({taskCard:n,onStatusUpdate:f})=>{const[d,g]=u.useState(!1),[m,v]=u.useState({open:!1,action:"",title:""}),[x,r]=u.useState(""),{user:N}=A(),j=()=>{if(!n.expected_delivery_date)return!1;const t=new Date(n.expected_delivery_date),c=new Date;return c.setHours(0,0,0,0),t.setHours(0,0,0,0),t<c&&n.status!==a.COMPLETED},p=()=>{const t=N?.role?.role_name,c=n.status,l=[],h=t?.toLowerCase().replace(/\s+/g,"_");return(t==="Super Admin"||t==="Admin"||D(t)||h==="super_admin"||h==="admin"||h==="workshop_supervisor")&&c===a.PENDING&&l.push({label:"Approve",value:a.APPROVED,variant:"success"},{label:"Reject",value:a.REJECTED,variant:"danger"}),(D(t)||t==="Super Admin"||t==="Admin"||h==="workshop_supervisor"||h==="super_admin"||h==="admin")&&(c===a.APPROVED&&l.push({label:"Start Progress",value:a.IN_PROGRESS,variant:"primary"}),c===a.IN_PROGRESS&&l.push({label:"Mark Completed",value:a.COMPLETED,variant:"success"})),l},s=async t=>{if(t===a.REJECTED){v({open:!0,action:t,title:"Reject Task Card"});return}await i(t)},i=async(t,c)=>{g(!0);try{const l={status:t};c&&(l.reason=c),await k.post(E.task_cards.status(n.id),l),_.success("Status updated successfully"),f()}catch(l){console.error("Failed to update status:",l),_.error(l.response?.data?.message||"Failed to update status")}finally{g(!1)}},y=async()=>{if(!x.trim()){_.error("Please enter a reason");return}await i(m.action,x),P()},P=()=>{v({open:!1,action:"",title:""}),r("")},b=p(),T=(()=>{if(j())return{text:"Overdue",className:"border-red-300 text-red-700"};switch(n.status){case a.PENDING:return{text:"Pending",className:"border-yellow-300 text-yellow-700"};case a.APPROVED:return{text:"Approved",className:"border-green-300 text-green-700"};case a.REJECTED:return{text:"Rejected",className:"border-red-300 text-red-700"};case a.IN_PROGRESS:return{text:"In Progress",className:"border-blue-300 text-blue-700"};case a.COMPLETED:return{text:"Completed",className:"border-purple-300 text-purple-700"};default:return{text:n.status?.replace(/_/g," ")||"Unknown",className:"border-gray-300 text-gray-700"}}})();return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex items-center gap-2 flex-wrap",children:d?e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"}),e.jsx("span",{className:"text-xs text-gray-500",children:"Updating..."})]}):e.jsx(e.Fragment,{children:e.jsxs("select",{className:`text-xs border border-gray-300 rounded px-2 py-1 focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white min-w-[140px] ${b.length===0?"opacity-50 cursor-not-allowed":""} ${T.className.replace("bg-","border-").replace("text-","text-").replace("-100","-300").replace("-800","-700")}`,value:"",onChange:t=>{t.target.value&&b.length>0&&(s(t.target.value),t.target.value="")},disabled:d||b.length===0,children:[e.jsxs("option",{value:"",className:"font-medium",children:[T.text," ",b.length>0?"▼":""]}),b.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))]})})}),m.open&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-md mx-4",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:m.title}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Reason ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("textarea",{className:"w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",rows:4,placeholder:`Enter reason for ${m.action}...`,value:x,onChange:t=>r(t.target.value)})]}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx("button",{className:"px-4 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50",onClick:P,disabled:d,children:"Cancel"}),e.jsx("button",{className:"px-4 py-2 text-sm rounded-lg text-white bg-red-600 hover:bg-red-700",onClick:y,disabled:d,children:d?"Processing...":"Submit"})]})]})})]})},Y=()=>{const{renderPagination:n}=F(),f=C(),{selectedBranchId:d}=A(),[g,m]=u.useState([]),[v,x]=u.useState(!1),[r,N]=u.useState(""),j=async()=>{x(!0);try{const s=await k.get(E.task_cards.list);console.log("Task Cards API Response:",s.data);const i=s.data?.task_cards||s.data?.data||[];m(i)}catch(s){console.error("Failed to fetch task orders:",s)}finally{x(!1)}};u.useEffect(()=>{j()},[d]);const p=r?g.filter(s=>{if(r==="overdue"){const i=new Date(s.expected_delivery_date),y=new Date;return y.setHours(0,0,0,0),i.setHours(0,0,0,0),i<y&&s.status!==a.COMPLETED}return s.status===r}):g;return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"bg-white rounded-lg shadow-sm p-4",children:e.jsxs("div",{className:"flex flex-wrap gap-4 items-center",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Status:"}),e.jsxs("select",{value:r,onChange:s=>N(s.target.value),className:"text-sm border border-gray-300 rounded px-3 py-1 focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white min-w-[150px]",children:[e.jsx("option",{value:"",children:"All Status"}),e.jsx("option",{value:a.PENDING,children:"Pending"}),e.jsx("option",{value:a.APPROVED,children:"Approved"}),e.jsx("option",{value:a.REJECTED,children:"Rejected"}),e.jsx("option",{value:a.IN_PROGRESS,children:"In Progress"}),e.jsx("option",{value:a.COMPLETED,children:"Completed"}),e.jsx("option",{value:"overdue",children:"Overdue"})]})]}),r&&e.jsx("button",{onClick:()=>N(""),className:"text-xs text-blue-600 hover:text-blue-800",children:"Clear Filter"})]})}),e.jsxs(O,{title:`Task Orders (${p?.length||0})`,createOnClick:w.hasPermission("task_card_management_create")?()=>f(S.TASK_CARD.CREATE):void 0,children:[e.jsxs(L,{children:[e.jsx(I,{cols:[{title:"Task Card No"},{title:"Task Name"},{title:"Customer"},{title:"Task Date"},{title:"Expected Delivery"},{title:"Task Type"},{title:"Status"},{title:"Actions"}]}),e.jsx("tbody",{children:v?e.jsx("tr",{children:e.jsx("td",{colSpan:9,className:"px-6 py-12 text-center",children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-red-600"}),e.jsx("p",{className:"mt-2 text-sm text-gray-500",children:"Loading task orders..."})]})})}):p?.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:9,className:"px-6 py-12 text-center",children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("svg",{className:"w-12 h-12 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),e.jsx("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"No task orders"}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:r?`No task orders found with status "${r}"`:"Get started by creating a new task order."})]})})}):p.map((s,i)=>e.jsxs(M,{children:[e.jsx(o,{className:"w-12 text-center font-medium",children:e.jsx("div",{className:"text-sm text-gray-900",children:i+1})}),e.jsx(o,{className:"w-40",children:e.jsx("div",{className:"flex items-center",children:e.jsx("div",{className:"text-sm font-medium text-gray-900",children:s.job_card_number||"-"})})}),e.jsx(o,{className:"w-48",children:e.jsx("div",{className:"text-sm text-gray-900",children:s.job_name||"-"})}),e.jsx(o,{className:"w-48",children:e.jsx("div",{className:"flex items-center",children:e.jsx("div",{children:e.jsx("div",{className:"text-sm font-medium text-gray-900",children:s.customer?.party_name||s.customer_name||"—"})})})}),e.jsx(o,{className:"w-32",children:e.jsx("div",{className:"text-sm text-gray-900",children:R.date(s.task_date)})}),e.jsx(o,{className:"w-32",children:e.jsx("div",{className:"text-sm text-gray-900",children:R.date(s.expected_delivery_date)})}),e.jsx(o,{className:"w-32",children:e.jsx("span",{className:"capitalize text-sm text-gray-900",children:s.job_type?.replace(/_/g," ")||"-"})}),e.jsx(o,{className:"w-40",children:e.jsx(V,{taskCard:{id:s.id,status:s.status,task_card_number:s.job_card_number,expected_delivery_date:s.expected_delivery_date},onStatusUpdate:j})}),e.jsx(o,{className:"w-20",children:e.jsxs(G,{children:[w.hasPermission("task_card_management_update")&&e.jsx($,{onClick:()=>f(`${S.TASK_CARD.CREATE}?editId=${s.id}`)}),w.hasPermission("task_card_management_delete")&&e.jsx(H,{refetch:j,endpoint:E.task_cards.delete(s.id)})]})})]},s.id))})]}),p?.length>0&&n()]})]})};export{Y as default};
