import{r as u,j as e,B,h as U,e as Q,y as R,u as Pe,i as $e,a as Ae,A as le}from"./index-DSLs68fz.js";import{T as _}from"./TextInput-CWb4FDJ1.js";import{S as ce}from"./Select-BUgIEQte.js";import{B as me}from"./BaseModal-ovCwiVDr.js";import{u as ue,C as v,b as Ee}from"./index.esm-51NyA9dG.js";import{o as Fe,p as Re}from"./yup-DwIng6A-.js";import{u as Te}from"./useItemsStore-BvU9hHoo.js";import{u as Me}from"./useMaterialRequestStore-Da1p-v_o.js";import{F as ke}from"./FormHeader-CWTf_50F.js";import{L as Ie}from"./Loading-C52XRUuf.js";import{u as xe}from"./usePartyStore-DNpaRHeF.js";import{C as Oe}from"./CommonFilter-BAP9ZFyE.js";import{S as Le}from"./SearchableSelect-CnFBwF4i.js";import"./BackButton-DsxJG3yl.js";const Be=({open:y,onClose:T,onSuccess:g})=>{const[G,X]=u.useState([]),[S,M]=u.useState([]),[V,k]=u.useState([]),[I,$]=u.useState(!1),{control:f,handleSubmit:O,reset:A,watch:j,formState:{errors:x}}=ue({defaultValues:{party_type:"vendor",party_name:"",company_name:"",address:"",city:"",state:"",pincode:"",gstin:"",contact_person:"",phone:"",credit_limit:"",email:"",country:"India",pan:"",bank_name:"",bank_account_number:"",bank_ifsc_code:"",is_active:!0},resolver:Fe(Re)}),p=j("country"),H=j("state");u.useEffect(()=>{y&&(async()=>{try{const c=await U.get(Q.party_master.countries);X(c.data.data||c.data||[])}catch(c){console.error("Failed to fetch countries",c)}})()},[y]),u.useEffect(()=>{if(!p||!y){M([]);return}(async()=>{const c=G.find(h=>h.name===p);if(c)try{const h=await U.get(`${Q.party_master.states}?country=${c.name}`);M(h.data.data||h.data||[])}catch(h){console.error("Failed to fetch states",h)}})()},[p,G,y]),u.useEffect(()=>{if(!H||!y){k([]);return}(async()=>{const c=S.find(h=>h.name===H);if(c)try{const h=await U.get(`${Q.party_master.cities}?state=${c.name}`);k(h.data.data||h.data||[])}catch(h){console.error("Failed to fetch cities",h)}})()},[H,S,y]);const o=async i=>{$(!0);try{await U.post(Q.party_master.create,i),R.success("Party Created Successfully"),g(),T(),A()}catch(c){console.error(c),R.error(c.response?.data?.message||"Failed to save party")}finally{$(!1)}};return e.jsx(me,{open:y,onClose:()=>{T(),A()},title:"Create New Party",maxWidth:"max-w-4xl",children:e.jsxs("div",{className:"space-y-6 max-h-[80vh] overflow-y-auto px-1 py-2",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[e.jsx(v,{name:"party_type",control:f,render:({field:i})=>e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("label",{className:"text-sm font-semibold text-gray-700 mb-1",children:["Party Type ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{...i,className:"w-full rounded-lg border border-gray-300 mt-1 px-3 py-2 text-gray-700 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white",children:[e.jsx("option",{value:"",children:"Select Party Type"}),e.jsx("option",{value:"vendor",children:"Vendor"}),e.jsx("option",{value:"customer",children:"Customer"})]}),x?.party_type?.message&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:x.party_type.message})]})}),e.jsx(v,{name:"party_name",control:f,render:({field:i})=>e.jsx(_,{required:!0,...i,label:"Party Name",error:x?.party_name?.message,className:"text-sm py-2"})}),e.jsx(v,{name:"contact_person",control:f,render:({field:i})=>e.jsx(_,{required:!0,...i,label:"Contact Person",error:x?.contact_person?.message,className:"text-sm py-2"})}),e.jsx(v,{name:"company_name",control:f,render:({field:i})=>e.jsx(_,{required:!0,...i,label:"Company Name",error:x?.company_name?.message,className:"text-sm py-2"})}),e.jsx(v,{name:"address",control:f,render:({field:i})=>e.jsx(_,{required:!0,...i,label:"Address",error:x?.address?.message,className:"text-sm py-2"})}),e.jsx(v,{name:"country",control:f,render:({field:i})=>e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("label",{className:"text-sm font-semibold text-gray-700 mb-1",children:["Country ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{...i,className:"w-full rounded-lg border border-gray-300 mt-1 px-3 py-2 text-gray-700 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white",children:[e.jsx("option",{value:"",children:"Select Country"}),G.map(c=>e.jsx("option",{value:c.name,children:c.name},c.id||c.name))]}),x?.country?.message&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:x.country.message})]})}),e.jsx(v,{name:"state",control:f,render:({field:i})=>e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("label",{className:"text-sm font-semibold text-gray-700 mb-1",children:["State ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{...i,disabled:!S.length,className:"w-full rounded-lg border border-gray-300 mt-1 px-3 py-2 text-gray-700 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white disabled:bg-gray-100",children:[e.jsx("option",{value:"",children:"Select State"}),S.map(c=>e.jsx("option",{value:c.name,children:c.name},c.id||c.name))]}),x?.state?.message&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:x.state.message})]})}),e.jsx(v,{name:"city",control:f,render:({field:i})=>e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("label",{className:"text-sm font-semibold text-gray-700 mb-1",children:["City ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{...i,disabled:!V.length,className:"w-full rounded-lg border border-gray-300 mt-1 px-3 py-2 text-gray-700 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white disabled:bg-gray-100",children:[e.jsx("option",{value:"",children:"Select City"}),V.map(c=>e.jsx("option",{value:c.name,children:c.name},c.id||c.name))]}),x?.city?.message&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:x.city.message})]})}),e.jsx(v,{name:"pincode",control:f,render:({field:i})=>e.jsx(_,{required:!0,...i,label:"Pincode",error:x?.pincode?.message,className:"text-sm py-2"})}),e.jsx(v,{name:"phone",control:f,render:({field:i})=>e.jsx(_,{required:!0,...i,label:"Mobile No",type:"tel",error:x?.phone?.message,className:"text-sm py-2"})}),e.jsx(v,{name:"email",control:f,render:({field:i})=>e.jsx(_,{required:!0,...i,label:"Email",type:"email",error:x?.email?.message,className:"text-sm py-2"})}),e.jsx(v,{control:f,name:"is_active",render:({field:i})=>e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("label",{className:"block text-sm font-semibold text-gray-700 mb-1",children:["Is Active ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{...i,value:i.value?"true":"false",onChange:c=>i.onChange(c.target.value==="true"),className:"w-full border border-gray-300 rounded-lg px-3 py-2 bg-white text-gray-800 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"true",children:"Active"}),e.jsx("option",{value:"false",children:"Inactive"})]})]})})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t border-slate-200",children:[e.jsx(B,{onClick:()=>{T(),A()},variant:"outline",className:"text-sm px-4",children:"Cancel"}),e.jsx(B,{onClick:O(o),loading:I,disabled:I,className:"bg-red-600 text-white text-sm px-4",children:"Create Party"})]})]})})},pe=u.forwardRef(({value:y,onChange:T,placeholder:g="Select Vendor to Add",disabled:G=!1,error:X,className:S,excludeVendorIds:M=[],onMount:V},k)=>{const{parties:I,fetchParties:$,loading:f}=xe(),O=u.useRef(!1);u.useEffect(()=>{!O.current&&V&&(O.current=!0,V())},[V]);const j=I.filter(p=>(p.party_type?.toLowerCase()==="vendor"||!p.party_type)&&p.is_active&&!M.includes(p.id)).map(p=>({value:p.id,label:p.party_name})),x=p=>{p.length>=3?$({party_name:p,party_type:"Vendor"}):p.length===0&&$({party_type:"Vendor"})};return e.jsx(Le,{ref:k,options:j,value:y?Number(y):void 0,onChange:p=>T(p.toString()),placeholder:f?"Loading vendors...":g,disabled:G||f,error:X,className:S,onSearch:x})});pe.displayName="VendorSearchSelect";const Z={quantity:"",rate:"",discount_percent:"",gst_percent:"",net_amount:"",total_amount:""},st=()=>{const y=Pe(),[T]=$e(),g=T.get("editId"),{items:G,fetchItems:X}=Te(),{materials:S,fetchMaterials:M}=Me(),[V,k]=u.useState(!1),[I,$]=u.useState(!1),{selectedBranchId:f}=Ae(),{parties:O,fetchParties:A}=xe(),j=u.useRef(!1),x=u.useRef(!1),[p,H]=u.useState(!1),[o,i]=u.useState(null),[c,h]=u.useState(""),[D,q]=u.useState(""),[he,oe]=u.useState(!1),de=u.useRef(null),{control:ee,handleSubmit:ge,getValues:L,watch:W,setValue:E,register:z,trigger:te}=ue({defaultValues:{branch_id:"",material_requisition_id:"",items:[]}}),{fields:Y}=Ee({control:ee,name:"items",keyName:"fieldId"}),_e=[{name:"mr_number",label:"MR Number",placeholder:"Enter MR number"},{name:"item_name",label:"Item Name",placeholder:"Enter Item Name"},{name:"date_from",label:"Date From",type:"date",placeholder:"Enter Date from"},{name:"date_to",label:"Date To",type:"date",placeholder:"Enter Date To"}],fe=async t=>{ye(t);const s={};t.mr_number&&(s.mr_number=t.mr_number),t.item_name&&(s.item_name=t.item_name),t.date_from&&t.date_to?t.date_from===t.date_to?s.date=t.date_from:(s.date_from=t.date_from,s.date_to=t.date_to):(t.date_from&&(s.date_from=t.date_from),t.date_to&&(s.date_to=t.date_to)),await M(s)},[N,P]=u.useState({}),[be,ye]=u.useState({});u.useEffect(()=>{X(),M()},[]);const je=async()=>{if(g){k(!0);try{const s=(await U.get(Q.comparative_statement.details(Number(g)))).data?.statement;if(!s){R.error("Comparative statement not found"),y(le.COMPERATIVE_STATEMENT.LIST);return}const a=s.items||[],d=s.material_requisition_id;if(a.length===0){R.error("No items found in comparative statement"),y(le.COMPERATIVE_STATEMENT.LIST);return}E("material_requisition_id",d?String(d):"");const r=[],l={};a.forEach((n,w)=>{const F={item_id:String(n.item_id||n.item?.id||""),item_name:n.item?.item_name||n.item_name||n.name||"",item_unit:n.item?.unit?.unit_name||n.item?.unit?.unit_symbol||n.item_unit||n.unit||"",quantity:String(n.quantity||""),last_purchase_rate:String(n.last_purchase_rate||"0"),selected_vendor_id:n.selected_vendor_id?`v_${n.selected_vendor_id}`:"",vendors:[]};l[w]={};const J=n.vendors||[],b=new Set;if(J.forEach(m=>{const K=`v_${m.vendor_id||m.id}`,ne=m.vendor?.party_name||m.party_name||`Vendor ${m.vendor_id}`;b.has(K)||(F.vendors.push({id:K,name:ne,vendor_id:m.vendor_id||m.id}),b.add(K)),l[w][K]={quantity:String(m.quantity||F.quantity||""),rate:String(m.rate??m.unit_price??m.price??""),discount_percent:String(m.discount_percent??m.discount_percentage??m.discount??""),gst_percent:String(m.gst_percent??m.gst_percentage??m.tax_percent??""),net_amount:String(m.net_amount??""),total_amount:String(m.total_amount??"")}}),n.selected_vendor&&n.selected_vendor_id){const m=`v_${n.selected_vendor_id}`;b.has(m)||(F.vendors.push({id:m,name:n.selected_vendor_rate_details?.vendor_name||n.selected_vendor?.party_name||"Selected Vendor",vendor_id:n.selected_vendor_rate_details?.vendor_id||n.selected_vendor_id}),l[w][m]||(l[w][m]={quantity:String(n.quantity||""),rate:String(n.selected_vendor_rate_details?.rate??""),discount_percent:String(n.selected_vendor_rate_details?.discount_percentage??""),gst_percent:String(n.selected_vendor_rate_details?.gst_percentage??""),net_amount:String(n.selected_vendor_rate_details?.net_amount??""),total_amount:String(n.selected_vendor_rate_details?.total_amount??"")}))}r.push(F)}),E("items",r),P(l),R.success("Comparative statement loaded successfully")}catch(t){console.error("Failed to load comparative statement:",t),console.error("Error response:",t.response?.data),R.error(t.response?.data?.message||"Failed to load comparative statement details")}finally{k(!1)}}};u.useEffect(()=>{g&&je()},[g]);const ve=t=>{if(!t){E("items",[]);return}const s=S?.find(a=>a.id===Number(t));if(s&&s.items&&s.items.length>0){const a=s.items.map(r=>({item_id:String(r.item?.id||r.item_id||""),item_name:r.item?.item_name||r.item_name||r.name||"",item_unit:r.item?.unit?.unit_name||r.item?.unit?.unit_symbol||r.item_unit||r.unit||"",quantity:String(r.quantity_required||r.quantity||""),last_purchase_rate:"0",selected_vendor_id:"",vendors:[]}));E("items",a);const d={};a.forEach((r,l)=>{d[l]={}}),P(d)}},Ne=t=>{i(t),H(!0),!x.current&&!j.current&&(x.current=!0,j.current=!0,A({party_type:"Vendor"}).finally(()=>{j.current=!1}));const s=L(`items.${t}`);s.selected_vendor_id?(q(s.selected_vendor_id),h(s.selected_vendor_id)):s.vendors&&s.vendors.length>0?q(s.vendors[0].id):q("")},ie=()=>{H(!1),i(null),h(""),q("")},Se=(t,s,a)=>{if(!t)return"";const d=t*(s/100||0),r=t-d,l=r*(a/100||0),n=r+l;return Number.isFinite(n)?n.toFixed(2):""},se=(t,s)=>{const a=parseFloat(t)||0,d=parseFloat(s)||0,r=a*d;return Number.isFinite(r)?r.toFixed(2):""},ae=(t,s,a,d)=>{const r={...N,[t]:{...N[t],[s]:{...N[t]?.[s],[a]:d}}};if(a==="quantity"){const K=r[t][s].net_amount,ne=L(`items.${t}.quantity`),qe=se(ne,K);r[t][s].total_amount=qe,P(r);return}const l=r[t][s],n=parseFloat(l?.rate||"0")||0,w=parseFloat(l?.discount_percent||"0")||0,F=parseFloat(l?.gst_percent||"0")||0,J=Se(n,w,F);r[t][s].net_amount=J;const b=L(`items.${t}.quantity`),m=se(b,J);r[t][s].total_amount=m,P(r)},Ce=async t=>{if(!t||o===null)return;const s=parseInt(t);let a=O.find(b=>b.id===s);if(!a&&!j.current){j.current=!0;try{await A({party_type:"Vendor"}),a=O.find(b=>b.id===s)}finally{j.current=!1}if(!a)return}const d=a;if(!d)return;const l=L(`items.${o}`).vendors||[],n=`v_${s}`;if(l.some(b=>b.vendor_id===s)){q(n),P(b=>({...b,[o]:{...b[o],[n]:{...Z}}})),h(""),await te();return}const F={id:n,name:d.party_name,vendor_id:s},J=[...l,F];E(`items.${o}.vendors`,J),q(n),P(b=>({...b,[o]:{...b[o],[n]:{...Z}}})),h(""),await te()},we=async(t,s)=>{const a=L(`items.${t}`),d=a.vendors[s].id,r=a.vendors.filter((l,n)=>n!==s);E(`items.${t}.vendors`,r),P(l=>{const n={...l};return n[t]&&delete n[t][d],n}),a.selected_vendor_id===d&&E(`items.${t}.selected_vendor_id`,""),D===d&&r.length>0&&q(r[0].id),await te()},re=t=>t?!!(t.rate||t.net_amount||t.total_amount):!1,Ve=async t=>{$(!0);const s={branch_id:Number(f),material_requisition_id:t.material_requisition_id?Number(t.material_requisition_id):null,items:t.items.map((a,d)=>({item_id:Number(a.item_id),quantity:Number(a.quantity),last_purchase_rate:Number(a.last_purchase_rate)||0,selected_vendor_id:a.selected_vendor_id?Number(a.selected_vendor_id.replace("v_","")):null,vendors:a.vendors.map(r=>{const l=N[d]?.[r.id]||Z,n=Number(l.discount_percent)||0,w=Number(l.gst_percent)||0;return{vendor_id:r.vendor_id,quantity:Number(l.quantity)||Number(a.quantity),rate:Number(l.rate)||0,unit_price:Number(l.rate)||0,discount_percent:n,gst_percent:w,discount_percentage:n,gst_percentage:w,tax_percentage:w,net_amount:Number(l.net_amount)||0,total_amount:Number(l.total_amount)||0}})}))};console.log("Submitting Comparative Statement Payload:",s);try{const a=g?Q.comparative_statement.update(Number(g)):Q.comparative_statement.create;await(g?U.put:U.post)(a,s),R.success(g?"Comparative statement updated successfully":"Comparative statement created successfully"),y(le.COMPERATIVE_STATEMENT.LIST)}catch(a){console.error(a),R.error(a.response?.data?.message||"Failed to save comparative statement")}finally{$(!1)}};if(V)return e.jsx("div",{className:"flex justify-center py-20",children:e.jsx(Ie,{})});const C=o!==null?L(`items.${o}.vendors`)||[]:[];return e.jsxs("div",{className:"w-full h-full overflow-auto bg-slate-50",children:[e.jsxs("div",{className:"max-w-7xl mx-auto space-y-8 px-6 py-5 pb-10",children:[e.jsx(ke,{title:g?"Edit Comparative Statement":"Create Comparative Statement",subtitle:g?"Update the comparative statement details":"Compare rates from multiple vendors and select the best option."}),e.jsx(Oe,{fields:_e,onFilter:fe,defaultValues:be}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm p-4 sm:p-6 space-y-6",children:[e.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-xs font-semibold text-slate-500 uppercase mb-1",children:"Material Request"}),e.jsx(v,{name:"material_requisition_id",control:ee,render:({field:t})=>e.jsxs(ce,{...t,className:"text-sm py-2",onChange:s=>{t.onChange(s.target.value),ve(s.target.value)},disabled:!!g,children:[e.jsx("option",{value:"",children:"Select Material Request"}),S&&S.length>0&&S.map(s=>e.jsxs("option",{value:s.id,children:[s.mr_number," - ",s.department||"Unknown Dept"]},s.id))]})})]})}),Y.length>0&&e.jsxs("div",{className:"mt-6",children:[e.jsxs("h3",{className:"text-sm font-semibold text-slate-700 mb-3",children:["Material Request Items (",Y.length,")"]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border-collapse",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-slate-100 border-b border-slate-200",children:[e.jsx("th",{className:"text-left text-xs font-semibold text-slate-600 p-3",children:"Item Description"}),e.jsx("th",{className:"text-center text-xs font-semibold text-slate-600 p-3",children:"Unit"}),e.jsx("th",{className:"text-center text-xs font-semibold text-slate-600 p-3",children:"Quantity"}),e.jsx("th",{className:"text-center text-xs font-semibold text-slate-600 p-3",children:"Last Rate"}),e.jsx("th",{className:"text-center text-xs font-semibold text-slate-600 p-3",children:"Selected Vendor"}),e.jsx("th",{className:"text-center text-xs font-semibold text-slate-600 p-3",children:"Action"})]})}),e.jsx("tbody",{children:Y.map((t,s)=>{const a=W(`items.${s}.vendors`)||[],d=W(`items.${s}.selected_vendor_id`),r=a.find(l=>l.id===d);return e.jsxs("tr",{className:"border-b border-slate-100 hover:bg-slate-50",children:[e.jsx("td",{className:"p-3",children:e.jsx(_,{...z(`items.${s}.item_name`),className:"bg-slate-50 border-slate-200 text-sm py-2",readOnly:!0})}),e.jsx("td",{className:"p-3",children:e.jsx(_,{...z(`items.${s}.item_unit`),className:"bg-slate-50 border-slate-200 text-center text-sm py-2",readOnly:!0})}),e.jsx("td",{className:"p-3",children:e.jsx(_,{...z(`items.${s}.quantity`),type:"number",className:"text-center text-sm py-2",placeholder:"0"})}),e.jsx("td",{className:"p-3",children:e.jsx(_,{...z(`items.${s}.last_purchase_rate`),type:"number",className:`text-center text-sm py-2 ${g?"bg-slate-50 border-slate-200":""}`,placeholder:"0.00",readOnly:!!g})}),e.jsx("td",{className:"p-3",children:r?e.jsx("div",{className:"bg-green-50 border border-green-300 rounded px-3 py-2 text-center",children:e.jsx("span",{className:"text-sm font-medium text-green-800",children:r.name})}):e.jsx("div",{className:"bg-gray-50 border border-gray-200 rounded px-3 py-2 text-center",children:e.jsx("span",{className:"text-xs text-gray-400",children:"Not Selected"})})}),e.jsx("td",{className:"p-3 text-center",children:e.jsx(B,{variant:"outline",onClick:()=>Ne(s),className:"text-xs py-1 px-3",children:"Select Vendor"})})]},t.fieldId)})})]})})]}),!L("material_requisition_id")&&e.jsx("div",{className:"text-center p-12 bg-white border border-dashed border-slate-300 rounded-lg text-slate-500",children:"Please select a material request to view items."}),e.jsxs("div",{className:"flex justify-end items-center gap-3 mt-6",children:[e.jsx(B,{variant:"outline",onClick:()=>y(-1),children:"Cancel"}),e.jsx(B,{className:"bg-red-600 text-white",onClick:ge(Ve),loading:I,disabled:I||Y.length===0,children:g?"Update Statement":"Submit Statement"})]})]})]}),e.jsx(me,{open:p,onClose:ie,title:"Select Vendors",maxWidth:"max-w-5xl",children:o!==null&&e.jsxs("div",{className:"space-y-4 max-h-[80vh] overflow-y-auto pr-2",children:[e.jsx("div",{className:"bg-slate-50 p-4 rounded-lg border border-slate-200",children:e.jsxs("div",{className:"grid grid-cols-4 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-xs text-slate-500 block mb-1",children:"Item:"}),e.jsx("p",{className:"font-medium",children:W(`items.${o}.item_name`)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-xs text-slate-500 block mb-1",children:"Unit:"}),e.jsx("p",{className:"font-medium",children:W(`items.${o}.item_unit`)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-slate-500 block mb-1",children:"Quantity:"}),e.jsx(_,{...z(`items.${o}.quantity`),type:"number",className:"text-sm py-2 font-medium",placeholder:"0",onChange:t=>{E(`items.${o}.quantity`,t.target.value),(W(`items.${o}.vendors`)||[]).forEach(a=>{const d=N[o]?.[a.id]?.net_amount||"";if(d){const r=se(t.target.value,d);P(l=>({...l,[o]:{...l[o],[a.id]:{...l[o]?.[a.id],total_amount:r}}}))}})}})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-slate-500 block mb-1",children:"Last Rate:"}),e.jsx(_,{...z(`items.${o}.last_purchase_rate`),type:"number",className:"text-sm py-2 font-medium",placeholder:"0.00"})]})]})}),e.jsxs("div",{className:"flex items-end gap-4 w-full",children:[e.jsxs("div",{className:"flex-1 flex flex-col",children:[e.jsx("label",{className:"text-xs font-semibold text-slate-500 uppercase mb-1 hover:text-black cursor-default transition-colors",children:"Add Vendor"}),e.jsx(pe,{ref:de,value:c,onChange:t=>{h(t),Ce(t)},placeholder:"Select Vendor to Add",disabled:V,excludeVendorIds:C.map(t=>t.vendor_id),onMount:()=>{}})]}),e.jsx("div",{className:"pb-0.5",children:e.jsx(B,{variant:"outline",className:"text-xs py-2 px-4 h-[40px] border-slate-300 hover:bg-slate-100 whitespace-nowrap",onClick:()=>{oe(!0),de.current?.close()},children:"+ Add Party"})}),e.jsxs("div",{className:"flex-1 flex flex-col",children:[e.jsx("label",{className:"text-xs font-semibold text-slate-500 uppercase mb-1",children:"Select Vendor (Final Choice)"}),e.jsx(v,{name:`items.${o}.selected_vendor_id`,control:ee,render:({field:t})=>e.jsxs(ce,{...t,className:"text-sm py-2 bg-green-50 border-green-300",onChange:s=>{const a=s.target.value,d=t.value;t.onChange(a),d&&d!==a&&P(r=>({...r,[o]:{...r[o],[d]:{...Z}}})),a&&q(a)},children:[e.jsx("option",{value:"",children:"Select Vendor"}),C.filter(s=>{const a=N[o]?.[s.id];return re(a)}).map(s=>e.jsx("option",{value:s.id,children:s.name||"Vendor"},s.id))]})})]})]}),C.length>0&&e.jsx("div",{className:"space-y-4",children:(()=>{const t=C.find(a=>a.id===D)||C[0];if(!t)return null;const s=C.findIndex(a=>a.id===t.id);return e.jsxs("div",{className:"bg-slate-50 rounded-lg border border-slate-200 p-4 shadow-sm",children:[e.jsxs("div",{className:"flex justify-between items-center mb-3 pb-2 border-b border-slate-300",children:[e.jsx("span",{className:"font-semibold text-slate-700 text-sm",children:t.name||`Vendor ${s+1}`}),C.length>1&&e.jsx("button",{type:"button",onClick:()=>we(o,s),className:"text-red-400 hover:text-red-600 font-bold ml-2",children:"✕"})]}),e.jsxs("div",{className:"grid grid-cols-5 gap-3",children:[e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-xs text-slate-500 text-center font-medium",children:"Rate"}),e.jsx(_,{type:"number",className:"text-sm text-right py-2 px-2",placeholder:"0.00",value:N[o]?.[t.id]?.rate||"",onChange:a=>{ae(o,t.id,"rate",a.target.value)}})]}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-xs text-slate-500 text-center font-medium",children:"Disc%"}),e.jsx(_,{type:"number",className:"text-sm text-right py-2 px-2",placeholder:"0",value:N[o]?.[t.id]?.discount_percent||"",onChange:a=>{ae(o,t.id,"discount_percent",a.target.value)}})]}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-xs text-slate-500 text-center font-medium",children:"GST%"}),e.jsx(_,{type:"number",className:"text-sm text-right py-2 px-2",placeholder:"0",value:N[o]?.[t.id]?.gst_percent||"",onChange:a=>{ae(o,t.id,"gst_percent",a.target.value)}})]}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-xs text-slate-500 text-center font-medium",children:"Net Amount"}),e.jsx(_,{readOnly:!0,className:"bg-white border-slate-200 text-sm text-right font-medium py-2 px-2",value:N[o]?.[t.id]?.net_amount||""})]}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-xs text-slate-500 text-center font-medium",children:"Total Amount"}),e.jsx(_,{readOnly:!0,className:"bg-blue-50 border-blue-200 text-sm text-right font-semibold py-2 px-2",value:N[o]?.[t.id]?.total_amount||""})]})]})]},t.id)})()}),C.length>0&&e.jsxs("div",{className:"mt-6 border-t border-slate-200 pt-4",children:[e.jsxs("h3",{className:"text-sm font-semibold text-slate-700 mb-3",children:["Participating Vendors (",C.filter(t=>re(N[o]?.[t.id])).length,")"]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:C.map(t=>{const s=t.id===D,a=t.id===W(`items.${o}.selected_vendor_id`);let d,r;a?(d="p-4 border-2 border-green-500 bg-green-50 rounded-lg shadow-sm cursor-pointer",r="font-semibold text-sm text-green-800"):s?(d="p-4 border border-gray-600 bg-gray-400 text-white rounded-lg shadow-sm cursor-pointer",r="font-semibold text-sm text-white"):(d="p-4 border border-slate-200 bg-white rounded-lg shadow-sm cursor-pointer hover:border-slate-300",r="font-semibold text-slate-800 text-sm");const l=N[o]?.[t.id];return re(l)?e.jsxs("div",{className:d,onClick:()=>q(t.id),children:[e.jsx("div",{className:"flex justify-between mb-2 items-center",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h4",{className:r,children:t.name}),a&&e.jsx("span",{className:"text-xs bg-green-500 text-white px-2 py-1 rounded-full",children:"Selected"})]})}),e.jsx("div",{className:"space-y-2",children:e.jsx("div",{className:a?"border border-green-200 rounded p-2 bg-green-100":s?"border border-gray-500/40 rounded p-2 bg-gray-500/30":"border border-slate-100 rounded p-2 bg-slate-50",children:e.jsxs("div",{className:"grid grid-cols-2 gap-1 text-[11px]",children:[e.jsxs("span",{className:a?"text-green-700":s?"text-white":"",children:["Rate: ₹",l?.rate||"0"]}),e.jsxs("span",{className:a?"text-green-700":s?"text-white":"",children:["Disc: ",l?.discount_percent||"0","%"]}),e.jsxs("span",{className:a?"text-green-700":s?"text-white":"",children:["GST: ",l?.gst_percent||"0","%"]}),e.jsxs("span",{className:`col-span-2 font-semibold ${a?"text-green-800":s?"text-white":""}`,children:["Net: ₹",l?.net_amount||"0"]}),e.jsxs("span",{className:`col-span-2 font-semibold ${a?"text-green-800":s?"text-white":"text-blue-700"}`,children:["Total: ₹",l?.total_amount||"0"]})]})})})]},t.id):null})})]}),C.length===0&&e.jsx("div",{className:"text-center p-8 bg-yellow-50 border border-yellow-200 rounded-lg text-yellow-700 text-sm",children:"Please add at least one vendor to compare rates."}),e.jsx("div",{className:"flex justify-end gap-3 mt-6 pt-4 border-t border-slate-200 sticky bottom-0 bg-white",children:e.jsx(B,{variant:"outline",onClick:ie,children:"Close"})})]})}),e.jsx(Be,{open:he,onClose:()=>oe(!1),onSuccess:()=>{j.current||(j.current=!0,A({party_type:"Vendor"}).finally(()=>{j.current=!1}))}})]})};export{st as default};
