import{r as c,a as O,j as e,B as F,y as P,h as $,e as q,u as z,P as A,A as G}from"./index-CHv2um3-.js";import{L as H}from"./ListWrapper-uuw8VAoB.js";import{T as Q}from"./TableActions-FoDa3IvB.js";import{T as V,a as B,b as i}from"./TableWrapper-BsErbKM7.js";import{T as J}from"./TableDelete-B3qkP8R2.js";import{T as K}from"./TableEdit-MrvyJLH-.js";import{T as U}from"./TableRow-sHM44jzA.js";import{u as X}from"./usePagination-BO2EGb_0.js";import{L as Y}from"./Loading-sZj5B-qA.js";import{S as Z}from"./StatusFilter-BmIOfj3H.js";import{B as ee}from"./BaseModal-4qMADl9S.js";import{T as L}from"./TextInput-DLaHSu5O.js";import{S as te}from"./Select-9Gdmfsy8.js";import{T as se}from"./TextArea-CD4GC-Aq.js";import{C as ae}from"./CommonFilter-clCwQ7l9.js";import"./index.esm-BXq0dTbn.js";const ne=({grn:l,onStatusUpdate:h})=>{const[d,k]=c.useState(!1),[u,g]=c.useState({open:!1,action:"",title:""}),[j,S]=c.useState(""),{user:C}=O(),[b,p]=c.useState(!1),[x,_]=c.useState([]),[I,v]=c.useState(""),y=()=>{const t=C?.role?.role_name,a=l.status,r=[],n=t?.toLowerCase().replace(/\s+/g,"_");return(t==="Store Manager"||t==="Super Admin"||t==="Store Executive"||n==="store_manager"||n==="super_admin"||n==="store_executive")&&a==="pending_inspection"&&r.push({label:"Complete Inspection",value:"inspection_completed",variant:"success"}),(t==="Store Manager"||t==="Super Admin"||t==="Store Executive"||n==="store_manager"||n==="super_admin"||n==="store_executive")&&(a==="inspection_completed"||a==="pending_stock_update")&&r.push({label:"Update Stock",value:"stock_updated",variant:"primary"}),(t==="Store Manager"||t==="Super Admin"||t==="Store Executive"||n==="store_manager"||n==="super_admin"||n==="store_executive")&&["pending_inspection","inspection_completed","pending_stock_update"].includes(a)&&r.push({label:"Cancel",value:"cancelled",variant:"danger"}),r},T=async t=>{if(t==="cancelled"){g({open:!0,action:t,title:"Cancel GRN"});return}if(t==="inspection_completed"){p(!0),_(l.items.map(a=>({id:a.id,quantity_accepted:a.quantity_received,quantity_rejected:0,inspection_status:"passed",inspection_remarks:""}))),v("");return}if(t==="stock_updated"){await m("update_stock");return}await m(t)},m=async(t,a,r)=>{k(!0);try{const n={status:t};a&&(n.reason=a),r&&(n.inspection_remarks=r.inspection_remarks,n.items=r.items),await $.post(q.grn.status(l.id),n),P.success("Status updated successfully"),h()}catch(n){console.error("Failed to update status:",n),P.error(n.response?.data?.message||"Failed to update status")}finally{k(!1)}},s=async()=>{if(!j.trim()){P.error("Please enter a reason");return}await m(u.action,j),E()},o=async()=>{await m("inspection_completed",void 0,{inspection_remarks:I,items:x}),N()},E=()=>{g({open:!1,action:"",title:""}),S("")},N=()=>{p(!1),_([]),v("")},f=(t,a,r)=>{const n=[...x];if(n[t]={...n[t],[a]:r},a==="quantity_accepted"||a==="quantity_rejected"){const R=n[t],D=l.items[t];if(D){const W=D.quantity_received;R.quantity_rejected>=W?R.inspection_status="failed":R.quantity_rejected>0?R.inspection_status="partial":R.inspection_status="passed"}}_(n)},w=y(),M=(()=>{switch(l.status){case"inspection_completed":return{text:"Inspection Completed",className:"border-gray-400 text-gray-800"};case"pending_inspection":return{text:"Pending Inspection",className:"border-gray-400 text-gray-800"};case"stock_updated":return{text:"Stock Updated",className:"border-gray-400 text-gray-800"};case"pending_stock_update":return{text:"Pending Stock Update",className:"border-gray-400 text-gray-800"};case"cancelled":return{text:"Cancelled",className:"border-gray-400 text-gray-800"};default:return{text:l.status?.replace(/_/g," ")||"Unknown",className:"border-gray-300 text-gray-700"}}})();return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex items-center gap-2 flex-wrap",children:d?e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"}),e.jsx("span",{className:"text-xs text-gray-500",children:"Updating..."})]}):e.jsx(e.Fragment,{children:e.jsxs("select",{className:`text-xs border rounded px-2 py-1 focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white min-w-[140px] ${w.length===0?"opacity-50 cursor-not-allowed":""} ${M.className}`,value:"",onChange:t=>{t.target.value&&w.length>0&&(T(t.target.value),t.target.value="")},disabled:d||w.length===0,children:[e.jsxs("option",{value:"",className:"font-medium",children:[M.text," ",w.length>0?"â–¼":""]}),w.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))]})})}),u.open&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-md mx-4",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:u.title}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Reason ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("textarea",{className:"w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",rows:4,placeholder:`Enter reason for ${u.action}...`,value:j,onChange:t=>S(t.target.value)})]}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx("button",{className:"px-4 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50",onClick:E,disabled:d,children:"Cancel"}),e.jsx("button",{className:"px-4 py-2 text-sm rounded-lg text-white bg-red-600 hover:bg-red-700",onClick:s,disabled:d,children:d?"Processing...":"Submit"})]})]})}),b&&e.jsx(ee,{open:b,onClose:N,title:`Complete Inspection - ${l.grn_number}`,maxWidth:"max-w-6xl",children:e.jsxs("div",{className:"max-h-[80vh] overflow-y-auto custom-scrollbar",children:[e.jsx("div",{className:"mb-4",children:e.jsxs(V,{children:[e.jsx(B,{cols:[{title:"#"},{title:"Item"},{title:"Received Qty",align:"center"},{title:"Accepted Qty",align:"center"},{title:"Rejected Qty",align:"center"},{title:"Status",align:"center"},{title:"Remarks"}]}),e.jsx("tbody",{children:l.items.map((t,a)=>e.jsxs(U,{children:[e.jsx(i,{children:a+1}),e.jsxs(i,{children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:t.item?.item_name||"-"}),e.jsx("div",{className:"text-xs text-gray-500",children:t.item?.item_code})]}),e.jsx(i,{className:"text-center",children:t.quantity_received}),e.jsx(i,{children:e.jsx(L,{type:"number",className:"w-24 text-center !py-2",value:x[a]?.quantity_accepted||0,onChange:r=>f(a,"quantity_accepted",parseInt(r.target.value)||0),max:t.quantity_received,min:0})}),e.jsx(i,{children:e.jsx(L,{type:"number",className:"w-24 text-center !py-2",value:x[a]?.quantity_rejected||0,onChange:r=>f(a,"quantity_rejected",parseInt(r.target.value)),max:t.quantity_received,min:0})}),e.jsx(i,{children:e.jsxs(te,{className:"!py-2",value:x[a]?.inspection_status||"passed",onChange:r=>f(a,"inspection_status",r.target.value),children:[e.jsx("option",{value:"passed",children:"Passed"}),e.jsx("option",{value:"failed",children:"Failed"}),e.jsx("option",{value:"partial",children:"Partial"})]})}),e.jsx(i,{children:e.jsx(L,{type:"text",className:"w-full !py-2",placeholder:"Remarks",value:x[a]?.inspection_remarks||"",onChange:r=>f(a,"inspection_remarks",r.target.value)})})]},t.id))})]})}),e.jsx("div",{className:"mb-4",children:e.jsx(se,{label:"Overall Inspection Remarks",rows:3,placeholder:"Enter overall inspection remarks...",value:I,onChange:t=>v(t.target.value)})}),e.jsxs("div",{className:"flex justify-end gap-3 sticky bottom-0 bg-white pt-4 border-t mt-4",children:[e.jsx(F,{variant:"outline",onClick:N,disabled:d,children:"Cancel"}),e.jsx(F,{onClick:o,loading:d,disabled:d,children:"Complete Inspection"})]})]})})]})},re=l=>l?new Date(l).toLocaleDateString("en-IN",{day:"2-digit",month:"2-digit",year:"numeric"}):"-",Ne=()=>{const{page:l,rowsPerPage:h,setTotal:d,renderPagination:k}=X(),u=z(),{selectedBranchId:g}=O(),[j,S]=c.useState([]),[C,b]=c.useState(!1),[p,x]=c.useState(""),[_,I]=c.useState({}),v=[{name:"grn_number",label:"GRN Number",placeholder:"Enter GRN Number"},{name:"date_from",label:"Date From",type:"date"},{name:"date_to",label:"Date To",type:"date"}],y=async s=>{b(!0);try{const o={page:l+1,rowsPerPage:h,...g&&{branch_id:g}};s&&(s.grn_number&&(o.grn_number=s.grn_number),s.date_from&&s.date_to?s.date_from===s.date_to?o.date=s.date_from:(o.date_from=s.date_from,o.date_to=s.date_to):(s.date_from&&(o.date_from=s.date_from),s.date_to&&(o.date_to=s.date_to)));const E=await $.get(q.grn.list,{params:o}),{grns:N,pagination:f}=E.data;S(N||[]),d(f?.total||0)}catch(o){console.log(o)}finally{b(!1)}};c.useEffect(()=>{y(_)},[l,h,g]);const T=async s=>{I(s),await y(s)},m=p?j.filter(s=>s.status===p):j;return e.jsxs("div",{className:"space-y-6",children:[e.jsx(ae,{fields:v,onFilter:T,defaultValues:_}),e.jsx(Z,{module:"grn",selectedStatus:p,onChange:s=>x(s)}),e.jsxs(H,{title:`Goods Receipt Notes (${m.length})`,createOnClick:A.hasPermission("inventory_management_create_grn")?()=>u(G.GOOD_RECEIVE_REPORT.CREATE):void 0,children:[C?e.jsx("div",{className:"flex justify-center py-10",children:e.jsx(Y,{})}):e.jsxs(V,{children:[e.jsx(B,{cols:[{title:"GRN Number"},{title:"GRN Date"},{title:"PO Number"},{title:"Total Items"},{title:"M/S"},{title:"Bill Number"},{title:"Status"},{title:"Actions",width:"w-96"}]}),e.jsx("tbody",{children:C?e.jsx("tr",{children:e.jsx("td",{colSpan:9,className:"px-6 py-12 text-center",children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-red-600"}),e.jsx("p",{className:"mt-2 text-sm text-gray-500",children:"Loading GRNs..."})]})})}):m.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:9,className:"px-6 py-12 text-center",children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("svg",{className:"w-12 h-12 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),e.jsx("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"No GRNs found"}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:p?`No GRNs found with status "${p}"`:"Get started by creating a new GRN."})]})})}):m.map((s,o)=>e.jsxs(U,{children:[e.jsx(i,{className:"px-5",children:l*h+o+1}),e.jsx(i,{className:"w-40",children:e.jsx("div",{className:"flex items-center",children:e.jsx("div",{className:"text-sm font-medium text-gray-900",children:s.grn_number})})}),e.jsx(i,{className:"w-32",children:e.jsx("div",{className:"text-sm text-gray-900",children:re(s.grn_date)})}),e.jsx(i,{className:"w-40",children:e.jsx("div",{className:"text-sm text-gray-900",children:s.purchase_order?.po_number||"-"})}),e.jsx(i,{className:"w-20",children:e.jsx("div",{className:"text-sm text-gray-900",children:s.items?.length||0})}),e.jsx(i,{className:"w-48",children:e.jsx("div",{className:"text-sm text-gray-900",children:s.vendor?.party_name||"-"})}),e.jsx(i,{className:"w-32",children:e.jsx("div",{className:"text-sm text-gray-900",children:s.invoice_no||"-"})}),e.jsx(i,{className:"w-40",children:e.jsx(ne,{grn:{id:s.id,status:s.status,grn_number:s.grn_number,items:s.items},onStatusUpdate:y})}),e.jsx(i,{className:"w-20",children:e.jsxs(Q,{children:[s.status==="pending_inspection"&&e.jsx("button",{onClick:()=>u(`${G.MATERIAL_INSPECTION_REPORT.CREATE}?grnId=${s.id}`),className:`flex items-center justify-center w-8 h-8 sm:w-9 sm:h-9 rounded-full  \r
                             hover:bg-blue-200 hover:text-blue-700 transition\r
                             bg-blue-100 text-blue-600\r
                             disabled:cursor-not-allowed disabled:opacity-40 touch-manipulation`,title:"Generate Material Inspection Report",children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})})}),A.hasPermission("inventory_management_update_grn")&&e.jsx(K,{onClick:()=>u(`${G.GOOD_RECEIVE_REPORT.CREATE}?editId=${s.id}`)}),A.hasPermission("inventory_management_delete_grn")&&e.jsx(J,{refetch:y,endpoint:q.grn.delete(s.id)})]})})]},s.id))})]}),m.length>0&&k()]})]})};export{Ne as default};
