import{r as l,a as J,j as e,B as b,h as E,e as I,y as C,b as ne,u as de,A as G}from"./index-CGIu5pUp.js";import{S as ie}from"./Select-CT5rtrfq.js";import{T as g}from"./TextInput-P3yBw3C-.js";import{T as z}from"./TextArea-DYhX1GxB.js";import{L as oe}from"./ListWrapper-BhW5yGza.js";import{T as h}from"./TableData-byLTh03T.js";import{T as ce,a as le}from"./TableWrapper-Cjx3wxVY.js";import{u as K,C as m,c as me}from"./index.esm-D0QEgp94.js";import{o as X,r as _e,t as D,v as pe}from"./yup-DsKEzl86.js";import{L as ue}from"./Loading-vKdaiJgF.js";import{F as xe}from"./FormHeader-CNaRuwC0.js";import{B as he}from"./BaseModal-3UeUAXLu.js";import{C as ge}from"./CommonFilter-eblCVGgp.js";import"./BackButton-EwyJVBX3.js";const ve=_e().shape({expected_delivery_date:D().required("Expected delivery date is required"),delivery_address:D().required("Delivery address is required"),delivery_contact_person:D().required("Contact person is required"),delivery_contact_phone:D().trim().transform(_=>_&&`+91${_.replace(/\D/g,"").replace(/^91/,"")}`).test("is-ten-digits","Phone number must be exactly 10 digits",_=>_?_.replace(/\D/g,"").replace(/^91/,"").length===10:!1).required("Contact phone is required"),special_instructions:D().optional()}),ye=({open:_,onClose:p,vendorId:n,vendorName:j,csId:T,branchId:q,items:f,onSuccess:d})=>{const[F,o]=l.useState(!1),{control:x,handleSubmit:O,formState:{errors:c},reset:A}=K({resolver:X(ve),defaultValues:{expected_delivery_date:"",delivery_address:"",delivery_contact_person:"",delivery_contact_phone:"",special_instructions:""}}),{user:R}=J(),w=R?.id,N=async i=>{o(!0);try{const v={...i,vendor_id:n,created_by:w,comparative_statement_id:T,branch_id:q,items:f.map(u=>({item_id:u.item_id,quantity_ordered:u.quantity_ordered,unit_price:u.rate,discount_percentage:u.discount_percentage,tax_percentage:u.tax_percentage,total_price:u.total_price,branch_id:q}))};await E.post(I.purchase_order.create,v),C.success(`Purchase Order generated for ${j}`),A(),d(),p()}catch(v){console.error(v),C.error("Failed to generate Purchase Order")}finally{o(!1)}};return e.jsx(he,{open:_,onClose:p,title:`Generate PO for ${j}`,maxWidth:"max-w-2xl",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"max-h-[60vh] overflow-y-auto pr-2 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 ml-1",children:[e.jsx(m,{name:"expected_delivery_date",control:x,render:({field:i})=>e.jsx(g,{...i,type:"date",label:"Expected Delivery Date",error:c.expected_delivery_date?.message})}),e.jsx(m,{name:"delivery_contact_person",control:x,render:({field:i})=>e.jsx(g,{...i,label:"Delivery Contact Person",error:c.delivery_contact_person?.message})}),e.jsx(m,{name:"delivery_contact_phone",control:x,render:({field:i})=>e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("label",{className:"text-sm font-semibold text-gray-700 mb-1",children:["Delivery Contact Phone ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"px-3 py-3 bg-gray-100 border border-gray-300 rounded-lg text-gray-700 text-sm",children:"+91"}),e.jsx(g,{...i,type:"tel",maxLength:10,placeholder:"Enter 10 digit mobile number",className:"mb-0 flex-1",onChange:v=>{const u=v.target.value.replace(/\D/g,"");i.onChange(u)}})]}),c.delivery_contact_phone?.message&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:c.delivery_contact_phone.message})]})}),e.jsx(m,{name:"delivery_address",control:x,render:({field:i})=>e.jsx(g,{...i,label:"Delivery Address",error:c.delivery_address?.message})})]}),e.jsx("div",{className:"ml-1",children:e.jsx(m,{name:"special_instructions",control:x,render:({field:i})=>e.jsx(g,{...i,label:"Special Instructions",error:c.special_instructions?.message})})})]}),e.jsxs("div",{className:"flex justify-end pt-4 space-x-3",children:[e.jsx(b,{variant:"outline",onClick:p,disabled:F,children:"Cancel"}),e.jsx(b,{onClick:O(N),loading:F,children:"Generate Purchase Order"})]})]})})},be={vendor_id:0,branch_id:0,comparative_statement_id:0,expected_delivery_date:"",delivery_address:"",delivery_contact_person:"",delivery_contact_phone:"",special_instructions:"",items:[{item_id:0,item_name:"",item_code:"",item_unit:"",quantity_ordered:0,unit:"",unit_price:0,discount_percentage:0,tax_percentage:0,total_price:0,rate:"0"}]},we=()=>{const[_]=ne(),p=de(),n=_.get("editId"),[j,T]=l.useState([]),[q,f]=l.useState(!1),[d,F]=l.useState(null),{selectedBranchId:o}=J(),[x,O]=l.useState(!1),[c,A]=l.useState(null),[R,w]=l.useState({}),[N,i]=l.useState(!1),v=[{name:"statement_number",label:"Statement Number",placeholder:"Enter statement number"},{name:"mr_number",label:"MR Number",placeholder:"Enter MR number"},{name:"item_name",label:"Item Name",placeholder:"Enter item name"},{name:"date_from",label:"Date From",type:"date",placeholder:"Select start date"},{name:"date_to",label:"Date To",type:"date",placeholder:"Select end date"}],u=async t=>{if(!o)return;w(t);const a={branch_id:o};t.statement_number&&(a.statement_number=t.statement_number),t.mr_number&&(a.mr_number=t.mr_number),t.item_name&&(a.item_name=t.item_name),t.date_from&&t.date_to?t.date_from===t.date_to?a.date=t.date_from:(a.date_from=t.date_from,a.date_to=t.date_to):(t.date_from&&(a.date_from=t.date_from),t.date_to&&(a.date_to=t.date_to)),f(!0);try{const r=await E.get(I.comparative_statement.items,{params:a});T(r.data?.statements||[])}catch(r){console.error("Error filtering comparative statements:",r)}finally{f(!1)}},{control:y,setValue:U,reset:k,handleSubmit:Y,formState:{errors:S}}=K({defaultValues:be,resolver:X(pe)}),P=me({control:y,name:"comparative_statement_id"}),B=async()=>{if(o){f(!0);try{const t=await E.get(I.comparative_statement.items,{params:{branch_id:o}});T(t.data?.statements||[])}catch(t){console.error(t)}finally{f(!1)}}};l.useEffect(()=>{B()},[o]),l.useEffect(()=>{if(!n)return;(async()=>{i(!0);try{const a=await E.get(I.purchase_order.details(Number(n))),r=a.data?.purchase_order||a.data?.purchaseOrder||a.data;r&&(F(r),k({branch_id:r.branch_id||o,vendor_id:r.vendor_id||0,comparative_statement_id:r.comparative_statement_id||0,expected_delivery_date:r.expected_delivery_date?r.expected_delivery_date.split("T")[0]:"",delivery_address:r.delivery_address||"",delivery_contact_person:r.delivery_contact_person||"",delivery_contact_phone:r.delivery_contact_phone||"",special_instructions:r.special_instructions||"",items:(r.items||[]).map(s=>({item_id:s.item_id||0,item_name:s.item?.item_name||"",item_code:s.item?.item_code||"",item_unit:s.item?.unit?.unit_symbol||"",quantity_ordered:Number(s.quantity_ordered)||0,unit:s.item?.unit?.unit_symbol||"",unit_price:Number(s.unit_price)||0,discount_percentage:Number(s.discount_percentage)||0,tax_percentage:Number(s.tax_percentage)||0,total_price:Number(s.total_price)||0,rate:String(s.unit_price||0)}))}),U("comparative_statement_id",r.comparative_statement_id||0))}catch(a){console.error("Error loading PO details:",a),C.error("Failed to load Purchase Order details"),p(G.PURCHASE_ORDER.LIST)}finally{i(!1)}})()},[n,U,k,o,p]);const H=l.useMemo(()=>{if(!P)return{};const t=j.find(r=>r.id===P);if(!t||!t.items)return{};console.log("Selected CS:",t);const a={};if(t.items.forEach(r=>{const s=r.selected_vendor?.id||r.selected_vendor_id;if(!s)return;if(!a[s]){const V=t.vendors_with_po_status?.find(se=>se.vendor_id===s);a[s]={vendor:r.selected_vendor,items:[],all_items_have_po:!!V?.allItemsHavePo,po_items:n&&d?(d.items||[]).filter(()=>d.vendor_id===s):[]}}const $=Number(r.quantity)||0,L=Number(r.selected_vendor_rate_details?.rate)||0,M=Number(r.selected_vendor_rate_details?.discount_percentage)||0,W=Number(r.selected_vendor_rate_details?.gst_percentage)||0,ee=L*(M/100),Q=(L-ee)*$,te=Q*(W/100),re=Number((Q+te).toFixed(2)),ae=n&&d&&d.items?.some(V=>V.item_id===r.item_id);a[s].items.push({item_id:r.item_id,item_name:r.item?.item_name||"Unknown Item",quantity_ordered:$,rate:L,discount_percentage:M,tax_percentage:W,total_price:re,has_po:ae})}),n&&d){const r=d.vendor_id,s={};return r&&a[r]&&(s[r]=a[r]),s}return a},[j,P,n,d]),Z=async t=>{if(!n){C.error("Edit mode is required for form submission");return}i(!0);try{const a={...t,branch_id:o};await E.put(I.purchase_order.update(Number(n)),a),C.success("Purchase Order updated successfully"),p(G.PURCHASE_ORDER.LIST)}catch(a){console.error("Error updating Purchase Order:",a),C.error(a.response?.data?.message||"Failed to update Purchase Order")}finally{i(!1)}};return q||N?e.jsx("div",{className:"flex justify-center py-20",children:e.jsx(ue,{})}):e.jsxs("div",{className:"w-full h-full overflow-auto space-y-8 p-4 pb-20",children:[e.jsx("div",{className:"space-y-1 ml-2",children:e.jsx(xe,{title:n?"Edit Purchase Order":"Create Purchase Order",subtitle:n?"Update the Purchase Order details":"Fill out the form to submit a new Purchase Order."})}),e.jsx(ge,{fields:v,onFilter:u,defaultValues:R}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-5 ml-4",children:[e.jsx(m,{name:"comparative_statement_id",control:y,render:({field:t})=>e.jsxs(ie,{...t,label:"Comparative Statement",value:t.value||0,onChange:a=>t.onChange(Number(a.target.value)),disabled:!!n,error:S.comparative_statement_id?.message,children:[e.jsx("option",{value:0,children:"Select Comparative Statement"}),j.map(a=>e.jsx("option",{value:a.id,children:a.statement_number},a.id))]})}),n&&d&&e.jsxs("div",{className:"bg-gray-50 border border-gray-200 rounded p-3",children:[e.jsx("h4",{className:"font-semibold text-gray-800 mb-2",children:"Purchase Order Details"}),e.jsxs("p",{className:"text-sm text-gray-700",children:[e.jsx("strong",{children:"PO Number:"})," ",d.po_number||"N/A"]}),e.jsxs("p",{className:"text-sm text-gray-700",children:[e.jsx("strong",{children:"Vendor:"})," ",d.vendor?.party_name||"N/A"]}),e.jsxs("p",{className:"text-sm text-gray-700",children:[e.jsx("strong",{children:"Status:"})," ",d.status||"N/A"]}),(d.status?.toLowerCase().includes("cancel")||d.status==="Cancelled")&&d.cancellation_reason&&e.jsx("div",{className:"mt-2 p-2 bg-red-50 border border-red-200 rounded",children:e.jsxs("p",{className:"text-sm text-red-800",children:[e.jsx("strong",{children:"Cancellation Reason:"})," ",d.cancellation_reason||"No reason provided"]})})]})]}),n&&d&&e.jsx("form",{onSubmit:Y(Z),className:"space-y-6",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Purchase Order Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx(m,{name:"expected_delivery_date",control:y,render:({field:t})=>e.jsx(g,{...t,type:"date",label:"Expected Delivery Date",error:S.expected_delivery_date?.message})}),e.jsx(m,{name:"delivery_contact_person",control:y,render:({field:t})=>e.jsx(g,{...t,label:"Delivery Contact Person",placeholder:"Enter contact person name",error:S.delivery_contact_person?.message})}),e.jsx(m,{name:"delivery_contact_phone",control:y,render:({field:t})=>e.jsx(g,{...t,label:"Delivery Contact Phone",placeholder:"Enter contact phone number",error:S.delivery_contact_phone?.message})}),e.jsx("div",{className:"md:col-span-2",children:e.jsx(m,{name:"delivery_address",control:y,render:({field:t})=>e.jsx(z,{...t,label:"Delivery Address",placeholder:"Enter delivery address",rows:3,error:S.delivery_address?.message})})}),e.jsx("div",{className:"md:col-span-2",children:e.jsx(m,{name:"special_instructions",control:y,render:({field:t})=>e.jsx(z,{...t,label:"Special Instructions",placeholder:"Enter any special instructions",rows:3,error:S.special_instructions?.message})})})]}),e.jsxs("div",{className:"flex justify-end gap-3 mt-6",children:[e.jsx(b,{type:"button",variant:"outline",onClick:()=>p(G.PURCHASE_ORDER.LIST),disabled:N,children:"Cancel"}),e.jsx(b,{type:"submit",disabled:N,className:"bg-blue-600 text-white",children:N?"Updating...":"Update Purchase Order"})]})]})}),P&&Object.keys(H).length>0?e.jsx("div",{className:"space-y-6",children:Object.entries(H).map(([t,a])=>e.jsxs(oe,{title:`Vendor: ${a.vendor?.party_name||"Unknown"}`,children:[e.jsxs("div",{className:"mb-4 flex justify-between items-center",children:[e.jsxs("div",{className:"text-sm text-gray-600",children:[e.jsxs("p",{children:["Total Items: ",a.items.length]}),e.jsxs("p",{className:"font-semibold text-gray-900",children:["Grand Total: ₹",a.items.reduce((r,s)=>r+s.total_price,0).toLocaleString("en-IN",{minimumFractionDigits:2})]})]}),n?e.jsx(b,{variant:"outline",disabled:!0,className:"bg-green-100 !text-green-600 !border-green-300",children:"Current PO Vendor"}):a.all_items_have_po?e.jsx(b,{variant:"outline",disabled:!0,className:"bg-gray-100 !text-gray-400 !border-gray-300 pointer-events-none",children:"Generated"}):e.jsx(b,{onClick:()=>{A({...a,vendorId:Number(t)}),O(!0)},children:"Generate PO"})]}),e.jsxs(ce,{children:[e.jsx(le,{cols:[{title:"Item"},{title:"Qty"},{title:"Rate"},{title:"Disc%"},{title:"GST%"},{title:"Total"},...n?[{title:"Status"}]:[]]}),e.jsx("tbody",{children:a.items.map((r,s)=>e.jsxs("tr",{className:`border-t ${n&&r.has_po?"bg-green-50":""}`,children:[e.jsx(h,{children:s+1}),e.jsx(h,{children:r.item_name}),e.jsx(h,{children:r.quantity_ordered}),e.jsx(h,{children:r.rate}),e.jsxs(h,{children:[r.discount_percentage,"%"]}),e.jsxs(h,{children:[r.tax_percentage,"%"]}),e.jsxs(h,{children:["₹",r.total_price.toFixed(2)]}),n&&e.jsx(h,{children:r.has_po?e.jsx("span",{className:"text-xs bg-green-100 text-green-800 px-2 py-1 rounded",children:"In PO"}):e.jsx("span",{className:"text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded",children:"Available"})})]},s))})]})]},t))}):e.jsx("div",{className:"p-8 text-center text-gray-500 bg-gray-50 rounded-lg",children:P?"No items found for this Comparative Statement.":"Please select a Comparative Statement to view items grouped by vendor."}),x&&c&&e.jsx(ye,{open:x,onClose:()=>O(!1),vendorId:c.vendorId,vendorName:c.vendor?.party_name||"Unknown",csId:P,branchId:o,items:c.items,onSuccess:()=>{O(!1),B()}})]})};export{we as default};
