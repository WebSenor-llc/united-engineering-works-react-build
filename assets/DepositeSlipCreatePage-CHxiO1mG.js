import{u as H,b as W,a as D,r as n,j as e,B as x,h,e as b,y as f,A as Q}from"./index-CRQb4Yqg.js";import{T as m}from"./TextInput-CzX_TrPD.js";import{L as V}from"./ListWrapper-CR4DwgHS.js";import{T as z}from"./TableActions-0FNBzKkW.js";import{T as c}from"./TableData-CkLqvJ1i.js";import{T as G}from"./TableDelete-D7zkuIZO.js";import{T as J,a as K}from"./TableWrapper-C6CZttTh.js";import{u as X,b as Y,c as Z,C as o}from"./index.esm-WRMWCj7W.js";import{u as ee}from"./useItemsStore-Cp1yXBzI.js";import{L as te}from"./Loading-DoP4UBIK.js";import{F as se}from"./FormHeader-Bu48ZAf1.js";import{B as ie}from"./BranchUserSelect-DXA-mIXH.js";import"./BackButton-BvQEtBeB.js";const ae={reason:"",deposited_by:"",recieved_by:"Store",branch_id:"",material_requisition_id:"",item_id:"",quantity_to_deposit:"",quantity_deposited:"",items:[{item_id:"",item_name:"",item_code:"",item_unit:"",qty_to_deposit:"",qty_deposited:""}]},xe=()=>{const j=H(),[C]=W(),r=C.get("editId"),{selectedBranchId:p}=D(),{control:a,handleSubmit:I,setValue:T,reset:F,formState:{errors:y}}=X({defaultValues:ae}),{fields:L,append:R,remove:A}=Y({control:a,name:"items"}),E=Z({control:a,name:"items"}),{user:g}=D(),{fetchItems:M}=ee(),[P,q]=n.useState(!1),[v,N]=n.useState(!1),[S,$]=n.useState(!1),[u,k]=n.useState([]),[,w]=n.useState(!1),B=async()=>{w(!0);try{const i=await h.get(b.material_requisition.all,{params:{branch_id:p}});k(i.data.material_requisitions||i.data||[])}catch(i){console.error("Failed to fetch material requests",i),f.error("Failed to load material requests")}finally{w(!1)}};n.useEffect(()=>{(async()=>{await M(),await B(),$(!0)})()},[p]);const U=async()=>{if(r){q(!0);try{const i=await h.get(b.deposit_slip.details(Number(r))),s=i.data.slip||i.data;F({branch_id:s.branch_id?String(s.branch_id):p?String(p):"",material_requisition_id:s.material_requisition_id?String(s.material_requisition_id):"",recieved_by:s.recieved_by,deposited_by:s.deposited_by,reason:s.reason||"",items:(s.items||[]).map(t=>({item_id:t.item_id,item_code:t.item?.item_code||"",item_name:t.item?.item_name||"",item_unit:t.unit?.unit_name||"",qty_to_deposit:t.quantity_to_deposit,qty_deposited:t.quantity_deposited}))})}catch(i){console.error("Failed to load details:",i),f.error("Failed to load deposit slip details")}finally{q(!1)}}};n.useEffect(()=>{r&&S&&U()},[r,S]);const O=async i=>{N(!0);const s={branch_id:p,material_requisition_id:i.material_requisition_id?Number(i.material_requisition_id):null,recieved_by:i.recieved_by,deposited_by:i.deposited_by,reason:i.reason,items:i.items.map(t=>({item_id:Number(t.item_id),quantity_to_deposit:Number(t.qty_to_deposit),quantity_deposited:Number(t.qty_deposited)}))};try{const t=r?b.deposit_slip.update(Number(r)):b.deposit_slip.create;await(r?h.put:h.post)(t,s),j(Q.DEPOSITE_SLIP.LIST)}catch(t){console.error(t),f.error(t.response?.data?.message||"Failed to save deposit slip")}finally{N(!1)}};return P?e.jsx("div",{className:"flex justify-center py-20",children:e.jsx(te,{})}):e.jsxs("div",{className:"w-full h-full flex flex-col overflow-hidden bg-gray-50",children:[e.jsxs("div",{className:"flex justify-between items-center p-4 bg-white border-b sticky top-0 z-10 shadow-sm shrink-0",children:[e.jsx("div",{className:"space-y-1 ml-2",children:e.jsx(se,{title:r?"Edit Deposit Slip":"Create Deposit Slip",subtitle:r?"Update the Deposit Slip details":"Fill out the form to submit a new Deposit Slip"})}),e.jsxs("div",{className:"flex justify-end gap-3 mr-5",children:[e.jsx(x,{variant:"outline",onClick:()=>j(-1),children:"Cancel"}),e.jsx(x,{className:"bg-red-600 text-white",onClick:I(O),loading:v,disabled:v,children:r?"Update Deposit Slip":"Submit Deposit Slip"})]})]}),e.jsxs("div",{className:"flex-1 overflow-auto p-4 space-y-8 pb-20",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-5 ml-2 mr-5",children:[e.jsx(o,{name:"material_requisition_id",control:a,render:({field:i})=>e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-semibold text-gray-700 mb-1",children:"Material Request"}),e.jsxs("select",{...i,className:"w-full h-[45px] rounded-lg border border-gray-300 px-4 mt-1 text-sm",onChange:s=>{const t=s.target.value;if(i.onChange(t),t){const d=u&&u.find(_=>_.id===Number(t));if(d&&d.items&&d.items.length>0){const _=d.items.map(l=>({item_id:l.item?.id||l.item_id||"",item_code:l.item?.item_code||"",item_name:l.item?.item_name||"",item_unit:l.item?.unit?.unit_name||"",qty_to_deposit:l.quantity_required||l.quantity||"",qty_deposited:""}));T("items",_)}}},children:[e.jsx("option",{value:"",children:"Select Material Request"}),u&&u.length>0&&u.map(s=>e.jsxs("option",{value:s.id,children:[s.mr_number," - ",s.department||"Unknown Dept"]},s.id))]})]})}),e.jsx(o,{name:"reason",control:a,render:({field:i})=>e.jsx(m,{...i,label:"Reason for deposing",error:y.reason?.message,placeholder:"Enter reason for deposing"})}),e.jsx(ie,{label:"Deposited By",name:"deposited_by",control:a,branchId:g?.branch?.id||g?.branch_id,error:y.deposited_by?.message}),e.jsx(o,{name:"recieved_by",control:a,render:({field:i})=>e.jsx(m,{...i,label:"Recieved By",error:y.recieved_by?.message})})]}),e.jsxs(V,{title:"Items Requested",children:[e.jsx("div",{className:"flex justify-end mb-2",children:e.jsx(x,{className:"bg-red-600 text-white px-3 py-1",onClick:()=>R({item_id:"",item_name:"",item_code:"",item_unit:"",qty_to_deposit:"",qty_deposited:""}),children:"+ Add Item"})}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(J,{children:[e.jsx(K,{cols:[{title:"Item Name"},{title:"Item Code"},{title:"Item Unit"},{title:"Qty to Deposite"},{title:"Qty Deposited"},{title:"Action"}]}),e.jsx("tbody",{children:L.map((i,s)=>e.jsxs("tr",{className:"align-middle",children:[e.jsx(c,{children:s+1}),e.jsxs(c,{children:[e.jsx(o,{name:`items.${s}.item_id`,control:a,render:()=>{const t=E?.[s],d=t?.item_name,_=t?.item_code;return e.jsx(m,{value:d?`${d} (${_})`:"",className:"mb-0 h-[45px] bg-gray-50",placeholder:"Item will be auto-filled from MR",readOnly:!0})}}),e.jsx(o,{name:`items.${s}.item_name`,control:a,render:({field:t})=>e.jsx("input",{...t,type:"hidden"})})]}),e.jsx(c,{children:e.jsx(o,{name:`items.${s}.item_code`,control:a,render:({field:t})=>e.jsx(m,{...t,className:"mb-0 h-[40px] bg-gray-50",placeholder:"Code",readOnly:!0})})}),e.jsx(c,{children:e.jsx(o,{name:`items.${s}.item_unit`,control:a,render:({field:t})=>e.jsx(m,{...t,className:"mb-0 h-[40px] bg-gray-50",placeholder:"Unit",readOnly:!0})})}),e.jsx(c,{children:e.jsx(o,{name:`items.${s}.qty_to_deposit`,control:a,render:({field:t})=>e.jsx(m,{...t,type:"number",className:"mb-0 h-[40px]",placeholder:"0"})})}),e.jsx(c,{children:e.jsx(o,{name:`items.${s}.qty_deposited`,control:a,render:({field:t})=>e.jsx(m,{...t,type:"number",className:"mb-0 h-[40px]",placeholder:"0"})})}),e.jsx(c,{children:e.jsx(z,{children:e.jsx(G,{onClick:()=>A(s)})})})]},i.id))})]})})]})]})]})};export{xe as default};
