import{u as X,i as Y,a as Z,r as o,j as e,B as L,A as q,h as g,e as j,y as h}from"./index-BPpkRjQL.js";import{T as c}from"./TextInput-gfXRTV11.js";import{S as ee}from"./Select-BmBrM02N.js";import{L as re}from"./ListWrapper-CPLeNLbE.js";import{T as ae,a as te,b as m}from"./TableWrapper-DY-gYtcA.js";import{T as se}from"./TableRow-1FqLnTPj.js";import{o as ne,j as ie}from"./yup-Cpl6tZUx.js";import{u as le,b as de,C as d}from"./index.esm-CaQR1vU5.js";import{L as oe}from"./Loading-nJeSTSjR.js";import{F as ce}from"./FormHeader-N4r7k8fv.js";import{C as me}from"./CommonFilter-r2ydAAFD.js";import"./BackButton-DvhqPw91.js";const ue={purchase_order_id:0,grn_date:new Date().toISOString().split("T")[0],delivery_challan_no:"",delivery_challan_date:"",purchase_order_no:"",purchase_order_date:"",items:[]},R=_=>{if(!_)return"";const b=new Date(_);return isNaN(b.getTime())?"":b.toISOString().split("T")[0]};function Pe(){const _=X(),[b]=Y(),i=b.get("editId"),{selectedBranchId:P,user:k}=Z(),[V,A]=o.useState([]),[Q,C]=o.useState(null),[$,v]=o.useState(!1),[S,E]=o.useState(!1),[I,T]=o.useState(!1),[u,U]=o.useState({po_number:"",date_from:"",date_to:""}),{control:l,handleSubmit:B,watch:H,reset:D,setValue:w,formState:{errors:p}}=le({defaultValues:ue,resolver:ne(ie)}),{fields:G,replace:F}=de({control:l,name:"items"}),N=H("purchase_order_id");o.useEffect(()=>{(async()=>{T(!0);try{const r={per_page:1e3,status:["Sent_to_Vendor","partially_received"],is_fully_received:0,branch_id:P};u.po_number&&(r.po_number=u.po_number),u.date_from&&(r.date_from=u.date_from),u.date_to&&(r.date_to=u.date_to);const K=((await g.get(j.purchase_order.list,{params:r,paramsSerializer:y=>{const x=new URLSearchParams;return Object.entries(y).forEach(([O,f])=>{Array.isArray(f)?f.forEach(M=>x.append(`${O}[]`,M)):x.append(O,String(f))}),x.toString()}})).data.purchase_orders||[]).filter(y=>!y.items||y.items.length===0?!1:y.items.some(x=>{const O=x.quantity_ordered||0,f=x.quantity_received||0;return O>f}));A(K)}catch(t){console.log(t),h.error("Failed to fetch Purchase Orders")}finally{T(!1)}})()},[P,u]),o.useEffect(()=>{i&&(async()=>{v(!0);try{const r=(await g.get(j.grn.details(parseInt(i)))).data.grn;D({purchase_order_id:r.purchase_order_id,grn_date:R(r.grn_date),delivery_challan_no:r.delivery_challan_no||"",delivery_challan_date:R(r.delivery_challan_date),items:r.items.map(a=>({id:a.id,po_item_id:a.po_item_id,item_id:a.item_id,item_name:a.item?.item_name||a.item_name||"",item_code:a.item?.item_code||a.item_code||"",unit_name:a.item?.unit?.unit_name||a.item_unit||"",quantity_received:a.quantity_received||0,purchase_order_quantity:a.purchase_order_quantity||0,short_quantity:a.short_quantity||0,excess_quantity:a.excess_quantity||0,remarks:a.remarks||""}))}),C({...r.purchase_order,vendor:r.vendor||r.purchase_order?.vendor,branch:r.branch||r.purchase_order?.branch})}catch(t){console.log(t),h.error("Failed to load GRN data"),_(q.GOOD_RECEIVE_REPORT.LIST)}finally{v(!1)}})()},[i,D,_]),o.useEffect(()=>{(async()=>{if(N&&N>0&&!i){v(!0);try{const t=await g.get(j.purchase_order.details(N)),r=t.data.purchase_order||t.data.data;if(r){C(r),w("purchase_order_no",r.po_number),w("purchase_order_date",R(r.po_date));const a=(r.items||[]).map(n=>({po_item_id:n.id,item_id:n.item_id,item_name:n.item?.item_name||n.item_name||"",item_code:n.item?.item_code||n.item_code||"",unit_name:n.item?.unit?.unit_name||n.item_unit||n.unit||"",quantity_received:0,purchase_order_quantity:n.quantity_ordered||0,short_quantity:0,excess_quantity:0,remarks:""}));F(a)}}catch(t){console.log(t),h.error("Failed to fetch Purchase Order details")}finally{v(!1)}}})()},[N,i,F,w]);const W=[{name:"po_number",label:"PO Number",type:"text",placeholder:"Enter PO Number"},{name:"date_from",label:"Date From",type:"date"},{name:"date_to",label:"Date To",type:"date"}],z=s=>{U(s)},J=async s=>{const t=s.items.map(a=>{const n={po_item_id:a.po_item_id,quantity_received:a.quantity_received,purchase_order_quantity:a.purchase_order_quantity,short_quantity:a.short_quantity,excess_quantity:a.excess_quantity,remarks:a.remarks};return i&&a.id&&(n.id=a.id),n});if(t.length===0){h.error("Please enter quantity received for at least one item");return}const r={grn_date:s.grn_date,delivery_challan_no:s.delivery_challan_no||null,delivery_challan_date:s.delivery_challan_date||null,branch_id:P,items:t,purchase_order_id:s.purchase_order_id};i&&(r.purchase_order_id=s.purchase_order_id),E(!0);try{i?(await g.put(j.grn.update(parseInt(i)),r),h.success("GRN updated successfully")):(await g.post(j.grn.create,r),h.success("GRN created successfully")),_(q.GOOD_RECEIVE_REPORT.LIST)}catch(a){console.log(a),h.error(a.response?.data?.message||"Failed to save GRN")}finally{E(!1)}};return $?e.jsx("div",{className:"flex justify-center py-20",children:e.jsx(oe,{})}):e.jsxs("div",{className:"w-full h-full overflow-auto space-y-8 p-4 pb-20",children:[e.jsx("div",{className:"space-y-1",children:e.jsx(ce,{title:i?"Edit GRN":"Create Goods Receipt Note (GRN)",subtitle:i?"Update the GRN details":"Select a Purchase Order and enter received quantities"})}),e.jsxs(e.Fragment,{children:[e.jsx(me,{fields:W,onFilter:z,defaultValues:u}),e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-lg font-semibold mb-4",children:"GRN Details"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-5",children:[e.jsx(d,{name:"purchase_order_id",control:l,render:({field:s})=>e.jsxs(ee,{...s,label:"Select Purchase Order",required:!0,error:p.purchase_order_id?.message,disabled:!!i||I,onChange:t=>{s.onChange(parseInt(t.target.value)||0)},children:[e.jsx("option",{value:"",children:I?"Loading...":"Select Purchase Order"}),V.map(t=>e.jsxs("option",{value:t.id,children:[t.po_number," - ",t.vendor?.party_name]},t.id))]})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Vendor"}),e.jsx("p",{className:"text-gray-900 bg-gray-100 px-3 py-2 rounded-lg min-h-[42px] flex items-center",children:Q?.vendor?.party_name||"-"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Branch"}),e.jsx("p",{className:"text-gray-900 bg-gray-100 px-3 py-2 rounded-lg min-h-[42px] flex items-center",children:k?.branch?.branch_name||"Udaipur Head Office"})]}),e.jsx(d,{name:"purchase_order_no",control:l,render:({field:s})=>e.jsx(c,{...s,label:"Purchase Order No",placeholder:"Enter Purchase Order No",error:p.purchase_order_no?.message})}),e.jsx(d,{name:"purchase_order_date",control:l,render:({field:s})=>e.jsx(c,{...s,type:"date",label:"Purchase Order Date",error:p.purchase_order_date?.message})}),e.jsx(d,{name:"delivery_challan_no",control:l,render:({field:s})=>e.jsx(c,{...s,label:"Challan/Invoice No",placeholder:"Enter Challan No",error:p.delivery_challan_no?.message})}),e.jsx(d,{name:"delivery_challan_date",control:l,render:({field:s})=>e.jsx(c,{...s,type:"date",label:"Challan Date",error:p.delivery_challan_date?.message})})]})]}),e.jsx(re,{title:"Items to Receive",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(ae,{children:[e.jsx(te,{cols:[{title:"Item Name"},{title:"Item Code"},{title:"Unit"},{title:"Received Qty"},{title:"P.O. Qty"},{title:"Short Qty"},{title:"Excess Qty"},{title:"Remarks"}]}),e.jsx("tbody",{children:G.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:11,className:"text-center py-8 text-gray-500",children:"No items found in selected Purchase Order"})}):G.map((s,t)=>e.jsxs(se,{children:[e.jsx(m,{className:"text-center w-16",children:t+1}),e.jsx(m,{className:"min-w-[200px]",children:e.jsx("span",{className:"font-medium text-sm",children:s.item_name})}),e.jsx(m,{className:"min-w-[120px] text-sm",children:s.item_code}),e.jsx(m,{className:"min-w-[80px] text-sm",children:s.unit_name}),e.jsx(m,{className:"min-w-[120px]",children:e.jsx(d,{name:`items.${t}.quantity_received`,control:l,render:({field:r})=>e.jsx(c,{...r,type:"number",placeholder:"Qty",className:"w-full min-w-[100px]",error:p.items?.[t]?.quantity_received?.message,onChange:a=>r.onChange(a.target.value)})})}),e.jsx(m,{className:"min-w-[100px]",children:e.jsx(d,{name:`items.${t}.purchase_order_quantity`,control:l,render:({field:r})=>e.jsx(c,{...r,type:"number",placeholder:"PO Qty",className:"w-full min-w-[90px]"})})}),e.jsx(m,{className:"min-w-[120px]",children:e.jsx(d,{name:`items.${t}.short_quantity`,control:l,render:({field:r})=>e.jsx(c,{...r,type:"number",placeholder:"Short",className:"w-full min-w-[100px]",onChange:a=>{const n=a.target.value;r.onChange(n===""?"":Number(n))}})})}),e.jsx(m,{className:"min-w-[120px]",children:e.jsx(d,{name:`items.${t}.excess_quantity`,control:l,render:({field:r})=>e.jsx(c,{...r,type:"number",placeholder:"Excess",className:"w-full min-w-[100px]",onChange:a=>{const n=a.target.value;r.onChange(n===""?"":Number(n))}})})}),e.jsx(m,{className:"min-w-[150px]",children:e.jsx(d,{name:`items.${t}.remarks`,control:l,render:({field:r})=>e.jsx(c,{...r,placeholder:"Remarks",className:"w-full min-w-[130px]"})})})]},s.id))})]})})}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx(L,{variant:"outline",onClick:()=>_(q.GOOD_RECEIVE_REPORT.LIST),disabled:S,children:"Cancel"}),e.jsx(L,{onClick:B(J),loading:S,disabled:S,children:i?"Update GRN":"Create GRN"})]})]})]})}export{Pe as default};
