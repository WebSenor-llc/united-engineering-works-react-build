import{u as X,b as Y,a as Z,r as u,j as e,B as G,A as f,h as j,e as y,y as g}from"./index-XrqdkMlQ.js";import{F as ee}from"./FormHeader-BMqyVJC0.js";import{T as k}from"./TextInput-CyxRsiph.js";import{L as te}from"./ListWrapper-n8s5LAbo.js";import{T as re}from"./TableActions-BqxsRnCX.js";import{T as c}from"./TableData-D2335yaW.js";import{T as ae}from"./TableDelete-RE0NQPTb.js";import{T as se,a as ne}from"./TableWrapper-BfKmYKz6.js";import{u as ie,b as le,C as o}from"./index.esm-2ny8XQ-U.js";import{u as oe}from"./useItemsStore-CUODr_Wz.js";import{L as de}from"./Loading-De0ina5-.js";import"./BackButton-BuSwY49K.js";const N={department_from:"Store Department",department_to:"",grn_number:"",grn_date:"",ms:"",items:[{item_id:"",item_code:"",description_of_goods:"",unit:"",qty:"",thick_bl:"",length_bl:"",width_bl:"",thick_actual:"",length_actual:"",width_actual:"",accepted_quantity:"",rejected_quantity:"",reason_if_reject:"",remark:""}]},Ne=()=>{const x=X(),[L]=Y(),p=L.get("id"),l=L.get("grnId"),{selectedBranchId:F}=Z(),[S,E]=u.useState(!1),[B,w]=u.useState(!1),q=u.useRef(null),{control:i,handleSubmit:W,setValue:m,watch:U,reset:$}=ie({defaultValues:N}),[R,P]=u.useState([]),[v,M]=u.useState(!1),[A,I]=u.useState(null),{items:C,loading:V,fetchItems:D}=oe(),{fields:H,append:Q}=le({control:i,name:"items"}),z=async()=>{M(!0);try{const n=await j.get(y.grn.pendingInspection);P(n.data?.grns||[])}catch(n){console.error("Error fetching GRNs for inspection:",n),P([])}finally{M(!1)}};u.useEffect(()=>{D(),z()},[D]),u.useEffect(()=>{if(!p)return;(async()=>{w(!0);try{const r=await j.get(y.material_inspection_report.details(parseInt(p,10))),t=r.data?.report||r.data?.data||r.data,s=(t.items||[]).map(a=>({item_id:a.item_id?.toString()||"",item_code:a.item?.item_code||"",description_of_goods:a.item?.item_name||"",unit:a.item?.unit?.unit_name||"",qty:a.quantity?.toString()||"",thick_bl:a.bill_thick?.toString()||"",length_bl:a.bill_length?.toString()||"",width_bl:a.bill_width?.toString()||"",thick_actual:a.actual_req_thick?.toString()||"",length_actual:a.actual_req_length?.toString()||"",width_actual:a.actual_req_width?.toString()||"",accepted_quantity:a.accepted_quantity?.toString()||"",rejected_quantity:a.rejected_quantity?.toString()||"",reason_if_reject:a.reject_reason||"",remark:""}));$({department_from:t.from_department||N.department_from,department_to:t.to_department||N.department_to,grn_number:t.grn_number||"",grn_date:"",ms:t.ms||"",items:s.length>0?s:N.items})}catch(r){console.error(r),g.error("Failed to load inspection report details"),x(f.MATERIAL_INSPECTION_REPORT.LIST)}finally{w(!1)}})()},[p,$,x]),u.useEffect(()=>{if(!l)return;(async()=>{w(!0);try{const r=await j.get(y.grn.details(parseInt(l,10))),t=r.data?.grn||r.data?.data||r.data;if(!t){g.error("GRN not found"),x(f.GOOD_RECEIVE_REPORT.LIST);return}I(t);const s=a=>{if(!a)return"";const[d]=a.split("T"),[b,T,K]=d.split("-");return`${K}-${T}-${b}`};if(m("grn_number",t.grn_number||""),m("grn_date",s(t.grn_date||"")),m("ms",t.vendor?.party_name||""),t.items?.length){const a=t.items.map(d=>({item_id:d.item_id?.toString()||"",item_code:d.item?.item_code||"",description_of_goods:d.item?.item_name||"",unit:d.item?.unit?.unit_name||"PCS",qty:d.quantity_received?.toString()||"",thick_bl:"",length_bl:"",width_bl:"",thick_actual:"",length_actual:"",width_actual:"",accepted_quantity:d.quantity_received?.toString()||"",rejected_quantity:"0",reason_if_reject:d.inspection_remarks||"",remark:d.remarks||""}));m("items",a)}}catch(r){console.error(r),g.error("Failed to load GRN details"),x(f.GOOD_RECEIVE_REPORT.LIST)}finally{w(!1)}})()},[l,m,x]);const _=u.useMemo(()=>l?[]:R.filter(n=>n.status==="pending_inspection"),[R,l]);u.useEffect(()=>{R.length===0&&console.log("No GRNs available for inspection")},[R.length,_.length,l]);const h=U("grn_number"),O=u.useCallback(n=>{if(!n){q.current=null,I(null),m("items",N.items);return}if(q.current===n||_.length===0)return;const r=_.find(s=>s.grn_number===n);if(!r)return;if(q.current=n,I(r),m("grn_date",(s=>{if(!s)return"";const[a]=s.split("T"),[d,b,T]=a.split("-");return`${T}-${b}-${d}`})(r.grn_date)),m("ms",r.vendor?.party_name||""),r.items?.length){const s=r.items.map(a=>({item_id:a.item_id?.toString()||"",item_code:a.item?.item_code||"",description_of_goods:a.item?.item_name||"",unit:a.item?.unit?.unit_name||"PCS",qty:a.quantity_received?.toString()||"",thick_bl:"",length_bl:"",width_bl:"",thick_actual:"",length_actual:"",width_actual:"",accepted_quantity:a.quantity_received?.toString()||"",rejected_quantity:"0",reason_if_reject:a.inspection_remarks||"",remark:a.remarks||""}));m("items",s,{shouldDirty:!1})}},[_,m]);u.useEffect(()=>{!l&&h&&_.length>0&&O(h)},[h,O,l,_.length]);const J=async n=>{try{E(!0);const r=(n.items||[]).map(s=>({item_id:s.item_id?Number(s.item_id):void 0,quantity:s.qty?Number(s.qty):0,bill_thick:s.thick_bl?Number(s.thick_bl):0,bill_length:s.length_bl?Number(s.length_bl):0,bill_width:s.width_bl?Number(s.width_bl):0,actual_req_thick:s.thick_actual?Number(s.thick_actual):0,actual_req_length:s.length_actual?Number(s.length_actual):0,actual_req_width:s.width_actual?Number(s.width_actual):0,accepted_quantity:s.accepted_quantity?Number(s.accepted_quantity):0,rejected_quantity:s.rejected_quantity?Number(s.rejected_quantity):0,reject_reason:s.reason_if_reject||""})),t={from_department:n.department_from,to_department:n.department_to,grn_number:n.grn_number,ms:n.ms,grn_id:l?parseInt(l,10):A?.id||null,branch_id:F,items:r};p?(await j.put(y.material_inspection_report.update(parseInt(p,10)),t),g.success("Material inspection report updated successfully")):(await j.post(y.material_inspection_report.create,t),g.success("Material inspection report created successfully")),x(f.MATERIAL_INSPECTION_REPORT.LIST)}catch(r){console.error(r),g.error(r?.response?.data?.message||`Failed to ${p?"update":"create"} material inspection report`)}finally{E(!1)}};return B?e.jsx("div",{className:"flex justify-center py-20",children:e.jsx(de,{})}):e.jsxs("div",{className:"w-full h-full flex flex-col overflow-hidden bg-gray-50",children:[e.jsxs("div",{className:"flex justify-between items-center p-4 bg-white border-b sticky top-0 z-10 shadow-sm shrink-0",children:[e.jsx(ee,{title:p?"Edit Material Inspection Report Form":"Material Inspection Report Form",subtitle:p?"Update the Material Inspection Report details":"Fill out the form to submit a new material inspection report."}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(G,{variant:"outline",onClick:()=>x(f.MATERIAL_INSPECTION_REPORT.LIST),disabled:S,children:"Cancel"}),e.jsx(G,{onClick:W(J),loading:S,disabled:S,children:p?"Update Report":"Submit Report"})]})]}),e.jsxs("div",{className:"flex-1 overflow-auto p-4 space-y-8 pb-20",children:[e.jsx("div",{className:"bg-white rounded-lg shadow p-6",children:e.jsxs("div",{className:"grid grid-cols-2 gap-5",children:[e.jsx(o,{name:"department_from",control:i,render:({field:n})=>e.jsx(k,{required:!0,...n,label:"Department From"})}),e.jsx(o,{name:"department_to",control:i,render:({field:n})=>e.jsx(k,{required:!0,...n,label:"Department To"})}),e.jsx(o,{name:"grn_number",control:i,render:({field:n})=>e.jsxs("div",{children:[e.jsxs("label",{className:"text-sm font-semibold text-gray-700 mb-1",children:["GRN Number",!l&&e.jsx("span",{className:"text-xs text-gray-500 ml-2",children:"(Only GRNs pending inspection)"})]}),l?e.jsx("input",{...n,readOnly:!0,className:"w-full h-[45px] rounded-lg border border-gray-300 px-4 mt-1 text-sm bg-gray-50"}):e.jsxs("select",{...n,className:"w-full h-[45px] rounded-lg border border-gray-300 px-4 mt-1 text-sm",children:[e.jsx("option",{value:"",children:v?"Loading...":"Select GRN"}),_.length===0&&!v?e.jsx("option",{value:"",disabled:!0,children:"No GRNs pending inspection"}):_.map(r=>e.jsxs("option",{value:r.grn_number,children:[r.grn_number," - ",r.vendor?.party_name||"Unknown Vendor"]},r.id))]}),!l&&_.length===0&&!v&&e.jsx("p",{className:"text-xs text-amber-600 mt-1",children:"No GRNs are currently pending inspection. Please ensure GRNs have been created and are awaiting inspection."}),l&&e.jsx("p",{className:"text-xs text-green-600 mt-1",children:"Items loaded from selected GRN for inspection."}),!l&&h&&e.jsx("p",{className:"text-xs text-green-600 mt-1",children:"Items will be automatically loaded from the selected GRN."})]})}),e.jsx(o,{name:"grn_date",control:i,render:({field:n})=>e.jsx(k,{...n,label:"GRN Date",placeholder:"Date",readOnly:!0})}),e.jsx(o,{name:"ms",control:i,render:({field:n})=>e.jsx(k,{...n,label:"M/S"})})]})}),e.jsxs(te,{title:"Items for Inspection",children:[h||l?e.jsx("div",{className:"flex justify-between items-center mb-2",children:e.jsxs("div",{className:"text-sm text-blue-600 bg-blue-50 px-3 py-2 rounded-lg",children:[e.jsx("span",{className:"font-medium",children:"Items loaded from GRN:"})," ",h||A?.grn_number]})}):e.jsx("div",{className:"flex justify-end mb-2",children:e.jsx(G,{className:"bg-red-600 text-white px-3 py-1",onClick:()=>Q({item_id:"",item_code:"",description_of_goods:"",unit:"",qty:"",thick_bl:"",length_bl:"",width_bl:"",thick_actual:"",length_actual:"",width_actual:"",accepted_quantity:"",rejected_quantity:"",reason_if_reject:"",remark:""}),children:"+ Add Item"})}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(se,{children:[e.jsx(ne,{cols:[{title:"Description of Goods"},{title:"Item Code"},{title:"Unit"},{title:"Received Qty"},{title:"Thick in MM (B/L)"},{title:"Length in MM (B/L)"},{title:"Width in MM (B/L)"},{title:"Thick in MM (Actual)"},{title:"Length in MM (Actual)"},{title:"Width in MM (Actual)"},{title:"Accepted Qty"},{title:"Rejected Qty"},{title:"Reason If Reject"},{title:"Remark"},{title:"Actions"}]}),e.jsx("tbody",{children:H.map((n,r)=>e.jsxs("tr",{className:"align-middle",children:[e.jsx(c,{children:r+1}),e.jsx(c,{children:e.jsx(o,{name:`items.${r}.description_of_goods`,control:i,render:({field:t})=>t.value&&(h||l)?e.jsx("input",{...t,readOnly:!0,className:"w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm bg-gray-50",placeholder:"Item Name"}):e.jsxs("select",{...t,className:"w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm",onChange:a=>{t.onChange(a);const d=C.find(b=>b.item_name===a.target.value);d&&(m(`items.${r}.item_code`,d.item_code),m(`items.${r}.unit`,d.unit?.unit_name||""),m(`items.${r}.item_id`,d.id.toString()))},children:[e.jsx("option",{value:"",children:V?"Loading...":"Select Item"}),C.map(a=>e.jsx("option",{value:a.item_name,children:a.item_name},a.id))]})})}),e.jsx(c,{children:e.jsx(o,{name:`items.${r}.item_code`,control:i,render:({field:t})=>e.jsx("input",{...t,readOnly:!0,className:"w-[80px] h-[40px] border border-gray-300 rounded-lg px-3 text-sm bg-gray-50",placeholder:"Code"})})}),e.jsx(c,{children:e.jsx(o,{name:`items.${r}.unit`,control:i,render:({field:t})=>e.jsx("input",{...t,readOnly:!0,className:"w-[80px] h-[40px] border border-gray-300 rounded-lg px-3 text-sm bg-gray-50",placeholder:"Unit"})})}),e.jsx(c,{children:e.jsx(o,{name:`items.${r}.qty`,control:i,render:({field:t})=>e.jsx("input",{...t,type:"number",className:"w-[100px] h-[40px] border border-gray-300 rounded-lg px-3 text-sm",placeholder:"0"})})}),e.jsx(c,{children:e.jsx(o,{name:`items.${r}.thick_bl`,control:i,render:({field:t})=>e.jsx("input",{...t,className:"w-[127px] h-[40px] border border-gray-300 rounded-lg px-3 text-sm",placeholder:"Thick (B/L)"})})}),e.jsx(c,{children:e.jsx(o,{name:`items.${r}.length_bl`,control:i,render:({field:t})=>e.jsx("input",{...t,className:"w-[127px] h-[40px] border border-gray-300 rounded-lg px-3 text-sm",placeholder:"Length (B/L)"})})}),e.jsx(c,{children:e.jsx(o,{name:`items.${r}.width_bl`,control:i,render:({field:t})=>e.jsx("input",{...t,className:"w-[127px] h-[40px] border border-gray-300 rounded-lg px-3 text-sm",placeholder:"Width (B/L)"})})}),e.jsx(c,{children:e.jsx(o,{name:`items.${r}.thick_actual`,control:i,render:({field:t})=>e.jsx("input",{...t,className:"w-[127px] h-[40px] border border-gray-300 rounded-lg px-3 text-sm",placeholder:"Thick (Actual)"})})}),e.jsx(c,{children:e.jsx(o,{name:`items.${r}.length_actual`,control:i,render:({field:t})=>e.jsx("input",{...t,className:"w-[127px] h-[40px] border border-gray-300 rounded-lg px-3 text-sm",placeholder:"Length (Actual)"})})}),e.jsx(c,{children:e.jsx(o,{name:`items.${r}.width_actual`,control:i,render:({field:t})=>e.jsx("input",{...t,className:"w-[127px] h-[40px] border border-gray-300 rounded-lg px-3 text-sm",placeholder:"Width (Actual)"})})}),e.jsx(c,{children:e.jsx(o,{name:`items.${r}.accepted_quantity`,control:i,render:({field:t})=>e.jsx("input",{...t,type:"number",className:"w-[100px] h-[40px] border border-gray-300 rounded-lg px-3 text-sm",placeholder:"0"})})}),e.jsx(c,{children:e.jsx(o,{name:`items.${r}.rejected_quantity`,control:i,render:({field:t})=>e.jsx("input",{...t,type:"number",className:"w-[100px] h-[40px] border border-gray-300 rounded-lg px-3 text-sm",placeholder:"0"})})}),e.jsx(c,{children:e.jsx(o,{name:`items.${r}.reason_if_reject`,control:i,render:({field:t})=>e.jsx("input",{...t,className:"w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm",placeholder:"Reason"})})}),e.jsx(c,{children:e.jsx(o,{name:`items.${r}.remark`,control:i,render:({field:t})=>e.jsx("input",{...t,className:"w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm",placeholder:"Remark"})})}),e.jsx(c,{children:e.jsxs(re,{children:[!(h||l)&&e.jsx(ae,{}),(h||l)&&e.jsx("span",{className:"text-xs text-gray-500 px-2",children:"From GRN"})]})})]},n.id))})]})})]})]})]})};export{Ne as default};
