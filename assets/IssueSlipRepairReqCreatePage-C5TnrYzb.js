import{u as G,b as J,a as K,r as o,h as d,e as c,y as l,j as e,B as w,A as E}from"./index-BYQAWDKy.js";import{u as Q,C as x}from"./index.esm-iShP8lPz.js";import{T as u}from"./TextInput-CGamGwLs.js";import{S as X}from"./SearchableSelect-CfHKECjB.js";import{F as Y}from"./FormHeader-DK9L5o4J.js";import{b as Z,c as ee}from"./rolePermissions-BvMMyxfj.js";import{L as se}from"./Loading-C4qpvyij.js";import"./BackButton-DnZXduaT.js";import"./enum-SoLNwffs.js";const ue=()=>{const q=G(),[j]=J(),a=j.get("requisitionId"),t=j.get("editId"),{user:D,selectedBranchId:b}=K(),[L,p]=o.useState(!1),[N,S]=o.useState(!1),[n,_]=o.useState(null),[P,A]=o.useState([]),[C,R]=o.useState(!1),{control:g,handleSubmit:U,formState:{errors:f},reset:F,watch:O}=Q({defaultValues:{to_whom:"",other:"",description:"",repair_requisition_id:a||""}}),[T,k]=o.useState([]),[B,I]=o.useState(!1),y=O("repair_requisition_id");o.useEffect(()=>{H(),!a&&!t&&$(),a&&W(),t&&M()},[a,t]),o.useEffect(()=>{y&&!a&&!t&&V(Number(y))},[y]);const $=async()=>{I(!0);try{const r=((await d.get(c.repair_requisition.list,{params:{...b&&{branch_id:b},status:"ready"}})).data?.data||[]).filter(h=>h.status!=="issued_back"&&h.status!=="Issued Back");k(r)}catch(s){console.error("Error fetching repair requisitions:",s),l.error("Failed to load repair requisitions")}finally{I(!1)}},V=async s=>{p(!0);try{const i=await d.get(c.repair_requisition.details(s)),r=i.data.data||i.data;_(r)}catch(i){console.error("Error loading requisition details:",i),l.error("Failed to load repair requisition details")}finally{p(!1)}},H=async()=>{R(!0);try{const r=((await d.get(c.user_management.all,{params:{branch_id:b}})).data?.users||[]).filter(h=>{const v=h.role?.role_name;return Z(v)||ee(v)});A(r)}catch(s){console.error("Error fetching users:",s),l.error("Failed to load users")}finally{R(!1)}},W=async()=>{if(a){p(!0);try{const s=await d.get(c.repair_requisition.details(Number(a))),i=s.data.data||s.data;_(i)}catch(s){console.error("Error loading requisition details:",s),l.error("Failed to load repair requisition details")}finally{p(!1)}}},M=async()=>{if(t){p(!0);try{const s=await d.get(c.repair_issue_slip.details(Number(t))),i=s.data.data||s.data;if(i&&(F({to_whom:i.to_whom?String(i.to_whom):"",other:i.other||"",description:i.description||""}),i.inhouse_deposit_slip_id)){const r=await d.get(c.repair_requisition.details(i.inhouse_deposit_slip_id)),h=r.data.data||r.data;_(h)}}catch(s){console.error("Error loading issue slip details:",s),l.error("Failed to load issue slip details")}finally{p(!1)}}},z=async s=>{const i=a||s.repair_requisition_id;if(!i&&!t){l.error("Please select a repair requisition");return}S(!0);try{const r={to_whom:s.to_whom?Number(s.to_whom):null,other:s.other||null,description:s.description,inhouse_deposit_slip_id:i?Number(i):null,created_by:D?.id};t?(await d.put(c.repair_issue_slip.update(Number(t)),r),l.success("Issue slip updated successfully")):(await d.post(c.repair_issue_slip.create,r),l.success("Issue slip created successfully")),q(E.REPAIR_ISSUE_SLIP.LIST)}catch(r){console.error("Error saving issue slip:",r),l.error(r.response?.data?.message||"Failed to save issue slip")}finally{S(!1)}};if(L)return e.jsx("div",{className:"flex justify-center py-20",children:e.jsx(se,{})});const m=!!t;return e.jsx("div",{className:"w-full min-h-screen bg-gray-50 p-4",children:e.jsxs("div",{className:"max-w-4xl mx-auto",children:[e.jsx(Y,{title:t?"View Issue Slip":"Create Issue Slip",subtitle:t?"View issue slip details for repair requisition":"Create issue slip for repair requisition"}),e.jsxs("form",{onSubmit:U(z),className:"mt-8 space-y-6",children:[e.jsxs("section",{className:"bg-white rounded-lg shadow-sm p-6 space-y-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 border-b pb-2",children:"Repair Requisition Details"}),!a&&!t&&e.jsxs("div",{className:"mb-4",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Select Repair Requisition ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx(x,{name:"repair_requisition_id",control:g,rules:{required:"Repair Requisition is required"},render:({field:s})=>e.jsxs("select",{...s,className:"w-full h-[45px] rounded-lg border border-gray-300 px-4 text-sm",children:[e.jsx("option",{value:"",children:B?"Loading...":"Select Repair Requisition"}),T.map(i=>e.jsxs("option",{value:i.id,children:[i.repair_item," - ",i.status]},i.id))]})}),f.repair_requisition_id&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:f.repair_requisition_id.message})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-6",children:[e.jsx(u,{label:"Repair Item",value:n?.repair_item||"",readOnly:!0,className:"bg-gray-100"}),e.jsx(u,{label:"Product",value:n?.product?.name||"N/A",readOnly:!0,className:"bg-gray-100"}),e.jsx(u,{label:"Machine",value:n?.machine?.name||"N/A",readOnly:!0,className:"bg-gray-100"}),e.jsx(u,{label:"Item",value:n?.item?`${n.item.item_name} (${n.item.item_code})`:"N/A",readOnly:!0,className:"bg-gray-100"}),e.jsx(u,{label:"Department",value:n?.department||"",readOnly:!0,className:"bg-gray-100"}),e.jsx(u,{label:"Requisition Description",value:n?.description||"",readOnly:!0,className:"bg-gray-100"})]})]}),e.jsxs("section",{className:"bg-white rounded-lg shadow-sm p-6 space-y-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 border-b pb-2",children:"Issue Slip Information"}),e.jsxs("div",{className:"grid grid-cols-1 gap-6",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["To Whom ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx(x,{name:"to_whom",control:g,rules:{required:"To Whom is required"},render:({field:s})=>e.jsx(X,{options:P.map(i=>({value:i.id,label:`${i.full_name} (${i.role?.role_name||"N/A"})`})),value:s.value?Number(s.value):0,onChange:i=>s.onChange(i?String(i):""),placeholder:C?"Loading users...":"Select User",error:f.to_whom?.message,disabled:m})})]}),e.jsx(x,{name:"other",control:g,render:({field:s})=>e.jsx(u,{...s,label:"Other",placeholder:"Enter custom recipient name if not in list",readOnly:m,className:m?"bg-gray-100":""})}),e.jsx(x,{name:"description",control:g,rules:{required:"Description is required"},render:({field:s})=>e.jsx(u,{...s,label:"Issue Description",placeholder:"Enter issue description",error:f.description?.message,readOnly:m,className:m?"bg-gray-100":""})})]})]}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx(w,{variant:"outline",type:"button",onClick:()=>q(E.REPAIR_ISSUE_SLIP.LIST),children:m?"Back":"Cancel"}),!m&&e.jsx(w,{className:"bg-red-600 text-white hover:bg-red-700 transition-colors",type:"submit",loading:N,disabled:N,children:"Create Issue Slip"})]})]})]})})};export{ue as default};
