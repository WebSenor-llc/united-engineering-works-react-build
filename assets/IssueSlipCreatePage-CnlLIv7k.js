import{u as re,i as ae,a as ie,r as c,h as q,e as N,y as f,j as e,B as M,A as le}from"./index-DQLLPGln.js";import{F as ne}from"./FormHeader-QrKZYlW6.js";import{T as S}from"./TextInput-BPUrDGK5.js";import{S as oe}from"./Select-BHdS60jG.js";import{L as de}from"./ListWrapper-BG9lLSAN.js";import{T as me}from"./TableActions-BtqL2JIQ.js";import{T as ue,a as ce,b as p}from"./TableWrapper-dhiQGSew.js";import{T as pe}from"./TableDelete-DNYHMsVC.js";import{u as _e,b as xe,C as u}from"./index.esm-wpl3r5_B.js";import{L as fe}from"./Loading-B1xtHlfm.js";import{u as he}from"./useMachineStore-DfkXaf7g.js";import{u as ye}from"./useMaterialRequestStore-DmVGwaV6.js";import{o as be,k as ge}from"./yup-BlqvSa7I.js";import{C as je}from"./CommonFilter-BoWSMfFa.js";import"./BackButton-Cz3v4pmP.js";const j={mr:"",machine:"",for_party:"",for_mines:"",issued_to:"",purpose:"",items:[{item_name:"",item_code:"",item_id:"",item_unit:"",required_qty:"",issued_qty:""}]},ke=()=>{const v=re(),[A]=ae(),i=A.get("editId"),{selectedBranchId:D}=ie(),{materials:d,fetchMaterials:F}=ye(),[L,w]=c.useState(!1),[T,C]=c.useState(!1),{machines:U,fetchMachines:E}=he(),[qe,V]=c.useState([]),[B,H]=c.useState({}),W=[{name:"mr_number",label:"MR Number",placeholder:"Enter MR Number"},{name:"item_name",label:"Item Name",placeholder:"Enter Item Name"},{name:"date_from",label:"Date From",type:"date"},{name:"date_to",label:"Date To",type:"date"}],{control:m,handleSubmit:Y,setValue:h,reset:R,watch:$,formState:{errors:_}}=_e({defaultValues:j,resolver:be(ge)}),{fields:z,append:G,remove:J}=xe({control:m,name:"items"}),l=$("mr");c.useEffect(()=>{F(),E()},[F,E]),c.useEffect(()=>{d&&d.length>0&&V(d)},[d]);const K=async t=>{H(t);const s={};t.requested_by&&(s.requested_by=t.requested_by),t.mr_number&&(s.mr_number=t.mr_number),t.item_name&&(s.item_name=t.item_name),t.date_from&&t.date_to?t.date_from===t.date_to?s.date=t.date_from:(s.date_from=t.date_from,s.date_to=t.date_to):(t.date_from&&(s.date_from=t.date_from),t.date_to&&(s.date_to=t.date_to)),await F(s)},P=c.useCallback(async t=>{try{const s=d&&d.find(x=>x.mr_number===t);if(!s)return;const r=(await q.get(N.material_requisition.details(s.id))).data?.material_requisition;if(r?.items?.length>0){const x=r.issue_slips||[],y={};x.forEach(n=>{n.items?.forEach(a=>{const g=a.item_id,I=parseFloat(a.issued_qty)||0;y[g]=(y[g]||0)+I})});const b=r.items.map(n=>{const a=n.item,g=a?.id||n.item_id,I=a?.item_name||n.item_name,Z=a?.item_code||n.item_code,ee=a?.unit?.unit_name||n.unit?.unit_name||n.item_unit,O=n.quantity_required||n.quantity||n.required_qty,k=y[g]||0,te=parseFloat(O)||0,se=k>=te;return{item_id:g?.toString()||"",item_name:I||"",item_code:Z||"",item_unit:ee||"",required_qty:O?.toString()||"",issued_qty:"",total_issued_qty:k.toString(),is_fully_fulfilled:se}});h("items",b),f.success(`Loaded ${b.length} items from MR ${t}`)}else h("items",j.items),f.info("No items found for the selected MR")}catch(s){console.error("Failed to fetch MR details:",s),f.error("Failed to load MR details")}},[d,h]),Q=c.useCallback(async()=>{if(i){w(!0);try{const t=await q.get(N.issue_slips.details(Number(i))),s=t.data.slip||t.data.data||t.data;R({mr:s.mr,machine:s.machine_id?String(s.machine_id):s.machine?String(s.machine):"",for_party:s.for_party??"",for_mines:s.for_mines??"",issued_to:s.issued_for??s.issued_to??"",purpose:s.purpose??"",items:s.items?.map(o=>({item_id:o.item_id?.toString()||"",item_code:o.item?.item_code||"",item_name:o.item?.item_name||"",item_unit:o.item?.unit?.unit_name||"",required_qty:o.required_qty?.toString()||"",issued_qty:o.issued_qty?.toString()||""}))||j.items})}finally{w(!1)}}},[i,R]);c.useEffect(()=>{i&&Q()},[i,Q]),c.useEffect(()=>{l&&!i&&d&&d.length>0?P(l):!l&&!i&&h("items",j.items)},[l,i,d,P,h]);const X=async t=>{const s=t.items.filter(r=>r.item_id&&r.issued_qty&&Number(r.issued_qty)>0);if(s.length===0){f.error("Please enter issued quantity for at least one item");return}C(!0);const o={mr:t.mr,branch_id:D,machine_id:t.machine?Number(t.machine):null,for_party:t.for_party||null,for_mines:t.for_mines||null,issued_for:t.issued_to||null,purpose:t.purpose||null,items:s.map(r=>({item_id:Number(r.item_id),required_qty:Number(r.required_qty)||0,issued_qty:Number(r.issued_qty),transaction_type:"opening_stock"}))};console.log("Submitting payload:",o);try{const r=i?N.issue_slips.update(Number(i)):N.issue_slips.create;await(i?q.put:q.post)(r,o),f.success(i?"Issue slip updated successfully":"Issue slip created successfully"),v(le.ISSUE_SLIP.LIST)}catch(r){console.error("Error submitting issue slip:",r),console.error("Error response:",r.response?.data),f.error(r.response?.data?.message||"Failed to save issue slip")}finally{C(!1)}};return L?e.jsx("div",{className:"flex justify-center py-20",children:e.jsx(fe,{})}):e.jsxs("div",{className:"w-full h-full overflow-auto space-y-8 p-4 pb-20",children:[e.jsx(ne,{title:i?"Edit Issue Slip":"Create Issue Slip",subtitle:i?"Update the Issue Slip details":"Fill out the form to submit a new Issue Slip"}),e.jsx(je,{fields:W,onFilter:K,defaultValues:B}),e.jsxs("div",{className:"grid grid-cols-2 gap-5 ml-2 mr-5",children:[e.jsx(u,{name:"mr",control:m,render:({field:t})=>e.jsxs("div",{children:[e.jsxs("label",{className:"text-sm font-semibold text-gray-700 mb-1",children:["Issued To MR ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{...t,disabled:!!i,className:"w-full h-[45px] rounded-lg border border-gray-300 px-4 mt-1 text-sm",children:[e.jsx("option",{value:"",children:"Select Material Requisition"}),d&&d.length>0?d.map(s=>e.jsxs("option",{value:s.mr_number,children:[s.mr_number," - ",s.department||"Unknown Dept"]},s.mr_number)):e.jsx("option",{disabled:!0,children:"No Material Requisitions Available"})]}),_.mr?.message&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:_.mr.message})]})}),e.jsx(u,{name:"machine",control:m,render:({field:t})=>e.jsxs(oe,{...t,label:"For Machine",error:_.machine?.message,children:[e.jsx("option",{value:"",children:"Select Machine (Optional)"}),U.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})}),e.jsx(u,{name:"for_party",control:m,render:({field:t})=>e.jsx(S,{...t,label:"For Party",placeholder:"Enter Party Name (Optional)",error:_.for_party?.message})}),e.jsx(u,{name:"for_mines",control:m,render:({field:t})=>e.jsx(S,{...t,label:"For Mines",placeholder:"Enter Mine (Optional)",error:_.for_mines?.message})}),e.jsx(u,{name:"issued_to",control:m,render:({field:t})=>e.jsx(S,{...t,label:"Issued To",placeholder:"Enter Name (Optional)",error:_.issued_to?.message})}),e.jsx(u,{name:"purpose",control:m,render:({field:t})=>e.jsx(S,{...t,label:"Purpose",placeholder:"Enter Purpose (Optional)",error:_.purpose?.message})})]}),e.jsxs(de,{title:"Items to Issue",children:[e.jsx("div",{className:"flex justify-end mb-2",children:!l&&e.jsx(M,{className:"bg-red-600 text-white px-3 py-1",onClick:()=>G({...j.items[0]}),children:"+ Add Item"})}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(ue,{children:[e.jsx(ce,{cols:[{title:"Item Name"},{title:"Item Code"},{title:"Item Unit"},{title:"Required QTY"},{title:"Total Issued"},{title:"Issued QTY"},{title:"Status"},{title:"Action"}]}),e.jsx("tbody",{children:z.map((t,s)=>{const o=$(`items.${s}`),r=o?.is_fully_fulfilled||!1,x=o?.total_issued_qty||"0",y=parseFloat(o?.required_qty||"0"),b=parseFloat(x),n=Math.max(0,y-b);return e.jsxs("tr",{className:"align-middle",children:[e.jsx(p,{children:s+1}),e.jsx(p,{children:e.jsx(u,{name:`items.${s}.item_name`,control:m,render:({field:a})=>e.jsx("input",{...a,readOnly:!!l,className:`w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm ${l?"bg-gray-50":""}`,placeholder:"Item Name"})})}),e.jsx(p,{children:e.jsx(u,{name:`items.${s}.item_code`,control:m,render:({field:a})=>e.jsx("input",{...a,readOnly:!!l,className:`w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm ${l?"bg-gray-50":""}`,placeholder:"Code"})})}),e.jsx(p,{children:e.jsx(u,{name:`items.${s}.item_unit`,control:m,render:({field:a})=>e.jsx("input",{...a,readOnly:!!l,className:`w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm ${l?"bg-gray-50":""}`,placeholder:"Unit"})})}),e.jsx(p,{children:e.jsx(u,{name:`items.${s}.required_qty`,control:m,render:({field:a})=>e.jsx("input",{...a,type:"number",readOnly:!!l,className:`w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm ${l?"bg-gray-50":""}`,placeholder:"0"})})}),e.jsx(p,{children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:`text-sm font-medium ${r?"text-green-600":"text-gray-700"}`,children:x}),l&&e.jsxs("span",{className:"text-xs text-gray-500",children:["Remaining: ",n.toFixed(3)]})]})}),e.jsx(p,{children:e.jsx(u,{name:`items.${s}.issued_qty`,control:m,render:({field:a})=>e.jsx("input",{...a,type:"number",readOnly:r,disabled:r,className:`w-full h-[40px] border rounded-lg px-3 text-sm ${r?"bg-gray-100 border-gray-300 cursor-not-allowed text-gray-500":"border-gray-300"}`,placeholder:r?"Fulfilled":"0",max:n,title:r?"This item is fully fulfilled":`Maximum: ${n.toFixed(3)}`})})}),e.jsx(p,{children:l&&e.jsx("div",{className:"flex justify-center",children:r?e.jsx("span",{className:"px-2 py-1 text-xs font-semibold text-green-800 bg-green-100 rounded-full",children:"Fulfilled"}):b>0?e.jsx("span",{className:"px-2 py-1 text-xs font-semibold text-yellow-800 bg-yellow-100 rounded-full",children:"Partial"}):e.jsx("span",{className:"px-2 py-1 text-xs font-semibold text-gray-800 bg-gray-100 rounded-full",children:"Pending"})})}),e.jsx(p,{children:e.jsx(me,{children:!l&&e.jsx(pe,{onClick:()=>J(s)})})})]},t.id)})})]})})]}),e.jsxs("div",{className:"flex justify-end gap-3 mr-5",children:[e.jsx(M,{variant:"outline",onClick:()=>v(-1),children:"Cancel"}),e.jsx(M,{className:"bg-red-600 text-white",onClick:Y(X),loading:T,disabled:T,children:i?"Update Issue Slip":"Submit Issue Slip"})]})]})};export{ke as default};
