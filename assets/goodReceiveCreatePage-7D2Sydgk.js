import{u as W,i as z,a as J,r as h,j as e,B as L,A as O,h as f,e as j,y}from"./index-DHxjsmS_.js";import{T as d}from"./TextInput-p5Tar9_e.js";import{S as K}from"./Select-BVH5BbOB.js";import{L as M}from"./ListWrapper-Cc4XzfgT.js";import{T as X,a as Y,b as o}from"./TableWrapper-Cc34JFCi.js";import{T as Z}from"./TableRow-CUJFv1cP.js";import{o as ee,j as re}from"./yup-BWCmlrJm.js";import{u as ae,b as te,C as c}from"./index.esm-O_A2BQbF.js";import{L as se}from"./Loading-CxrkmpiL.js";import{F as ne}from"./FormHeader-ClhnmCTk.js";const le={purchase_order_id:0,grn_date:new Date().toISOString().split("T")[0],delivery_challan_no:"",delivery_challan_date:"",purchase_order_no:"",purchase_order_date:"",items:[]},S=p=>{if(!p)return"";const v=new Date(p);return isNaN(v.getTime())?"":v.toISOString().split("T")[0]};function xe(){const p=W(),[v]=z(),l=v.get("editId"),{selectedBranchId:q,user:k}=J(),[F,Q]=h.useState([]),[A,R]=h.useState(null),[$,N]=h.useState(!1),[w,C]=h.useState(!1),[E,I]=h.useState(!1),{control:i,handleSubmit:V,watch:U,reset:T,setValue:P,formState:{errors:x}}=ae({defaultValues:le,resolver:ee(re)}),{fields:G,replace:D}=te({control:i,name:"items"}),b=U("purchase_order_id");h.useEffect(()=>{(async()=>{I(!0);try{const t=["Sent_to_Vendor"],s=((await f.get(j.purchase_order.list,{params:{per_page:1e3,status:t,is_fully_received:0,branch_id:q},paramsSerializer:m=>{const _=new URLSearchParams;return Object.entries(m).forEach(([u,g])=>{Array.isArray(g)?g.forEach(H=>_.append(`${u}[]`,H)):_.append(u,String(g))}),_.toString()}})).data.purchase_orders||[]).filter(m=>!m.items||m.items.length===0?!1:m.items.some(_=>{const u=_.quantity_ordered||0,g=_.quantity_received||0;return u>g}));Q(s)}catch(t){console.log(t),y.error("Failed to fetch Purchase Orders")}finally{I(!1)}})()},[q]),h.useEffect(()=>{l&&(async()=>{N(!0);try{const a=(await f.get(j.grn.details(parseInt(l)))).data.grn;T({purchase_order_id:a.purchase_order_id,grn_date:S(a.grn_date),delivery_challan_no:a.delivery_challan_no||"",delivery_challan_date:S(a.delivery_challan_date),items:a.items.map(r=>({id:r.id,po_item_id:r.po_item_id,item_id:r.item_id,item_name:r.item?.item_name||r.item_name||"",item_code:r.item?.item_code||r.item_code||"",unit_name:r.item?.unit?.unit_name||r.item_unit||"",quantity_received:r.quantity_received||0,actual_require_qty:r.actual_require_qty||0,purchase_order_quantity:r.purchase_order_quantity||0,short_qty:r.short_qty||0,excess_qty:r.excess_qty||0,pending_quantity:r.pending_quantity||0,remarks:r.remarks||""}))}),R({...a.purchase_order,vendor:a.vendor||a.purchase_order?.vendor,branch:a.branch||a.purchase_order?.branch})}catch(t){console.log(t),y.error("Failed to load GRN data"),p(O.GOOD_RECEIVE_REPORT.LIST)}finally{N(!1)}})()},[l,T,p]),h.useEffect(()=>{(async()=>{if(b&&b>0&&!l){N(!0);try{const t=await f.get(j.purchase_order.details(b)),a=t.data.purchase_order||t.data.data;if(a){R(a),P("purchase_order_no",a.po_number),P("purchase_order_date",S(a.po_date));const r=(a.items||[]).map(s=>{const m=Number(s.quantity_ordered)||0,_=Number(s.quantity_received)||0,u=m-_;return{po_item_id:s.id,item_id:s.item_id,item_name:s.item?.item_name||s.item_name||"",item_code:s.item?.item_code||s.item_code||"",unit_name:s.item?.unit?.unit_name||s.item_unit||s.unit||"",quantity_received:0,actual_require_qty:u>0?u:0,purchase_order_quantity:m,short_qty:0,excess_qty:0,pending_quantity:u>0?u:0,remarks:""}});D(r)}}catch(t){console.log(t),y.error("Failed to fetch Purchase Order details")}finally{N(!1)}}})()},[b,l,D,P]);const B=async n=>{const t=n.items.map(r=>{const s={po_item_id:r.po_item_id,quantity_received:r.quantity_received,actual_require_qty:r.actual_require_qty,purchase_order_quantity:r.purchase_order_quantity,short_qty:r.short_qty,excess_qty:r.excess_qty,pending_quantity:r.pending_quantity,remarks:r.remarks};return l&&r.id&&(s.id=r.id),s});if(t.length===0){y.error("Please enter quantity received for at least one item");return}const a={grn_date:n.grn_date,delivery_challan_no:n.delivery_challan_no||null,delivery_challan_date:n.delivery_challan_date||null,branch_id:q,items:t};l||(a.purchase_order_id=n.purchase_order_id),C(!0);try{l?(await f.put(j.grn.update(parseInt(l)),a),y.success("GRN updated successfully")):(await f.post(j.grn.create,a),y.success("GRN created successfully")),p(O.GOOD_RECEIVE_REPORT.LIST)}catch(r){console.log(r),y.error(r.response?.data?.message||"Failed to save GRN")}finally{C(!1)}};return $?e.jsx("div",{className:"flex justify-center py-20",children:e.jsx(se,{})}):e.jsxs("div",{className:"w-full h-full overflow-auto space-y-8 p-4 pb-20",children:[e.jsx("div",{className:"space-y-1",children:e.jsx(ne,{title:l?"Edit GRN":"Create Goods Receipt Note (GRN)",subtitle:l?"Update the GRN details":"Select a Purchase Order and enter received quantities"})}),e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-lg font-semibold mb-4",children:"GRN Details"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-5",children:[e.jsx(c,{name:"purchase_order_id",control:i,render:({field:n})=>e.jsxs(K,{...n,label:"Select Purchase Order",required:!0,error:x.purchase_order_id?.message,disabled:!!l||E,onChange:t=>{n.onChange(parseInt(t.target.value)||0)},children:[e.jsx("option",{value:"",children:E?"Loading...":"Select Purchase Order"}),F.map(t=>e.jsxs("option",{value:t.id,children:[t.po_number," - ",t.vendor?.party_name]},t.id))]})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Vendor"}),e.jsx("p",{className:"text-gray-900 bg-gray-100 px-3 py-2 rounded-lg min-h-[42px] flex items-center",children:A?.vendor?.party_name||"-"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Branch"}),e.jsx("p",{className:"text-gray-900 bg-gray-100 px-3 py-2 rounded-lg min-h-[42px] flex items-center",children:k?.branch?.branch_name||"Udaipur Head Office"})]}),e.jsx(c,{name:"purchase_order_no",control:i,render:({field:n})=>e.jsx(d,{...n,label:"Purchase Order No",placeholder:"Enter Purchase Order No",error:x.purchase_order_no?.message})}),e.jsx(c,{name:"purchase_order_date",control:i,render:({field:n})=>e.jsx(d,{...n,type:"date",label:"Purchase Order Date",error:x.purchase_order_date?.message})}),e.jsx(c,{name:"delivery_challan_no",control:i,render:({field:n})=>e.jsx(d,{...n,label:"Challan No",placeholder:"Enter Challan No",error:x.delivery_challan_no?.message})}),e.jsx(c,{name:"delivery_challan_date",control:i,render:({field:n})=>e.jsx(d,{...n,type:"date",label:"Challan Date",error:x.delivery_challan_date?.message})})]})]}),e.jsx(M,{title:"Items to Receive",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(X,{children:[e.jsx(Y,{cols:[{title:"Item Name"},{title:"Item Code"},{title:"Unit"},{title:"Received Qty"},{title:"Actual Req Qty"},{title:"P.O. Qty"},{title:"Short Qty"},{title:"Excess Qty"},{title:"Pending Qty"},{title:"Remarks"}]}),e.jsx("tbody",{children:G.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:11,className:"text-center py-8 text-gray-500",children:"No items found in selected Purchase Order"})}):G.map((n,t)=>e.jsxs(Z,{children:[e.jsx(o,{className:"text-center w-16",children:t+1}),e.jsx(o,{className:"min-w-[200px]",children:e.jsx("span",{className:"font-medium text-sm",children:n.item_name})}),e.jsx(o,{className:"min-w-[120px] text-sm",children:n.item_code}),e.jsx(o,{className:"min-w-[80px] text-sm",children:n.unit_name}),e.jsx(o,{className:"min-w-[120px]",children:e.jsx(c,{name:`items.${t}.quantity_received`,control:i,render:({field:a})=>e.jsx(d,{...a,type:"number",placeholder:"Qty",className:"w-full min-w-[100px]",error:x.items?.[t]?.quantity_received?.message,onChange:r=>{const s=r.target.value;a.onChange(s===""?"":Number(s))}})})}),e.jsx(o,{className:"min-w-[100px]",children:e.jsx(c,{name:`items.${t}.actual_require_qty`,control:i,render:({field:a})=>e.jsx(d,{...a,type:"number",placeholder:"Req Qty",className:"w-full min-w-[90px]",onChange:r=>{const s=r.target.value;a.onChange(s===""?"":Number(s))}})})}),e.jsx(o,{className:"min-w-[100px]",children:e.jsx(c,{name:`items.${t}.purchase_order_quantity`,control:i,render:({field:a})=>e.jsx(d,{...a,type:"number",placeholder:"PO Qty",className:"w-full min-w-[90px]"})})}),e.jsx(o,{className:"min-w-[120px]",children:e.jsx(c,{name:`items.${t}.short_qty`,control:i,render:({field:a})=>e.jsx(d,{...a,type:"number",placeholder:"Short",className:"w-full min-w-[100px]",onChange:r=>{const s=r.target.value;a.onChange(s===""?"":Number(s))}})})}),e.jsx(o,{className:"min-w-[120px]",children:e.jsx(c,{name:`items.${t}.excess_qty`,control:i,render:({field:a})=>e.jsx(d,{...a,type:"number",placeholder:"Excess",className:"w-full min-w-[100px]",onChange:r=>{const s=r.target.value;a.onChange(s===""?"":Number(s))}})})}),e.jsx(o,{className:"min-w-[120px]",children:e.jsx(c,{name:`items.${t}.pending_quantity`,control:i,render:({field:a})=>e.jsx(d,{...a,type:"number",placeholder:"Pending",className:"w-full min-w-[100px]",onChange:r=>{const s=r.target.value;a.onChange(s===""?"":Number(s))}})})}),e.jsx(o,{className:"min-w-[150px]",children:e.jsx(c,{name:`items.${t}.remarks`,control:i,render:({field:a})=>e.jsx(d,{...a,placeholder:"Remarks",className:"w-full min-w-[130px]"})})})]},n.id))})]})})}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx(L,{variant:"outline",onClick:()=>p(O.GOOD_RECEIVE_REPORT.LIST),disabled:w,children:"Cancel"}),e.jsx(L,{onClick:V(B),loading:w,disabled:w,children:l?"Update GRN":"Create GRN"})]})]})]})}export{xe as default};
