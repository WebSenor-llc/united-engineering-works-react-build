import{u as z,i as G,a as K,r as p,j as e,B as v,A,h as j,e as x,y as N}from"./index-Cljs0C-M.js";import{u as X,b as Y,C as o}from"./index.esm-C6x9iadA.js";import{T as l}from"./TextInput-Dv2lrd0E.js";import{T as w}from"./TextArea-DHZKG9IS.js";import{S as f}from"./Select-B2d3MOwo.js";import{F as Z}from"./FormHeader-CV1fDnjN.js";import{L as ee}from"./Loading-B5F64OcS.js";import{I as re}from"./ImageUpload-TrlrKpNC.js";import{T as se,a as ae,b as u}from"./TableWrapper-D0x0lFKt.js";import{T as te}from"./TableRow-D3Eqxb8Z.js";import{T as oe,a as ne}from"./TableDelete-C2E6Q8LB.js";import{u as ie}from"./useMachineStore-Ru766iJ6.js";import{o as de,v as le}from"./yup-gmZ66V0a.js";const Ne=()=>{const C=z(),[I]=G(),c=I.get("editId"),{selectedBranchId:b}=K(),[k,S]=p.useState(!1),[q,T]=p.useState(!1),[h,F]=p.useState([]),[P,$]=p.useState(null),{machines:R,fetchMachines:D}=ie(),B={job_name:"",job_card_no:"",job_date:new Date().toISOString().split("T")[0],department:"Production Department",job_description:"",quantity:1,expected_delivery_date:"",job_type:"",status:"pending",customer_id:"",customer_name:"",customer_contact:"",customer_address:"",operations:[{operation_name:"",supervisor_id:"",start_date:"",end_date:"",machine_id:""}],challan_no:"",challan_date:"",invoice_no:"",po_no:"",remarks:"",images:[],files:[],note:""},{control:t,handleSubmit:L,setValue:g,watch:M,reset:O,formState:{errors:m}}=X({defaultValues:B,resolver:de(le),mode:"onChange"}),{fields:J,append:U,remove:H}=Y({control:t,name:"operations"}),y=M("customer_id"),W=async r=>{if(r)try{const s=(await j.get(x.user_management.all,{params:{branch_id:r}})).data.users.filter(i=>i.role.role_name==="Workshop Supervisor");$(s)}catch(a){console.log(a)}};p.useEffect(()=>{(async()=>{try{const a=await j.get(x.party_master.parties,{params:{per_page:1e3,party_type:"Customer"}});F(a.data?.parties||a.data?.data||[])}catch(a){console.error("Failed to fetch customers",a)}})(),D()},[D]),p.useEffect(()=>{if(y&&h.length>0){const r=h.find(a=>a.id===Number(y));r&&(g("customer_name",r.party_name),g("customer_contact",r.phone||""),g("customer_address",r.address||""))}},[y,h,g]),p.useEffect(()=>{b&&W(Number(b))},[b]),p.useEffect(()=>{if(!c)return;(async()=>{S(!0);try{const a=await j.get(x.job_order.details(Number(c))),s=a.data?.job_card||a.data;O({job_name:s.job_name||"",job_card_no:s.job_card_number||"",job_date:s.job_date?.split("T")[0]||"",department:s.department||"Production Department",job_description:s.job_description||"",quantity:s.quantity||1,expected_delivery_date:s.expected_delivery_date?.split("T")[0]||"",job_type:s.job_type||"",status:s.status||"pending",customer_id:s.customer_id?String(s.customer_id):"",customer_name:s.customer?.party_name||"",customer_contact:s.customer?.phone||"",customer_address:s.customer?.address||"",operations:s.operations?.length?s.operations.map(i=>({operation_name:i.operation_name||"",supervisor_id:i.supervisor_id?String(i.supervisor_id):"",start_date:i.start_date?.split("T")[0]||"",end_date:i.end_date?.split("T")[0]||"",machine_id:i.machine_id?String(i.machine_id):""})):[{operation_name:"",supervisor_id:"",start_date:"",end_date:"",machine_id:""}],challan_no:s.challan_number||"",challan_date:s.challan_date?.split("T")[0]||"",invoice_no:s.invoice_number||"",po_no:s.customer_po_number||"",remarks:s.remarks||"",note:s.note||""})}finally{S(!1)}})()},[c,O]);const Q=async r=>{T(!0);try{const a=r.images||[],s=r.files||[],i=[...a,...s],V=i.filter(d=>d instanceof File),E=i.filter(d=>typeof d=="string"),n=new FormData;n.append("job_name",r.job_name),n.append("job_date",r.job_date),n.append("department",r.department),n.append("job_description",r.job_description),n.append("job_type",r.job_type),n.append("status",r.status),n.append("quantity",String(r.quantity)),n.append("expected_delivery_date",r.expected_delivery_date),n.append("customer_id",r.customer_id),n.append("branch_id",String(b)),n.append("remarks",r.remarks||""),n.append("note",r.note||""),V.forEach(d=>{n.append("images[]",d)}),E.length>0&&n.append("existing_images",JSON.stringify(E)),r.operations.filter(d=>d.operation_name||d.supervisor_id||d.machine_id).forEach((d,_)=>{n.append(`operations[${_}][operation_name]`,d.operation_name||""),n.append(`operations[${_}][supervisor_id]`,d.supervisor_id||""),n.append(`operations[${_}][start_date]`,d.start_date||""),n.append(`operations[${_}][end_date]`,d.end_date||""),n.append(`operations[${_}][machine_id]`,d.machine_id||"")}),c?(await j.put(x.job_order.update(Number(c)),n),N.success("Job Order updated successfully")):(await j.post(x.job_order.create,n),N.success("Job Order created successfully")),C(A.JOB_ORDER.LIST)}catch{N.error("Failed to submit job order")}finally{T(!1)}};return k?e.jsx("div",{className:"flex justify-center items-center h-[500px]",children:e.jsx(ee,{})}):e.jsx("div",{className:"w-full h-full p-2 sm:p-4 lg:p-6 overflow-y-auto pb-20",children:e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsx(Z,{title:c?"Edit Job Card":"Create Job Card",subtitle:c?"Update Job Order details":"Create a new Job Order"}),e.jsxs("form",{onSubmit:L(Q),className:"space-y-4 sm:space-y-6 mt-4",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 sm:gap-4",children:[e.jsx(o,{name:"job_name",control:t,rules:{required:"Job Name is required"},render:({field:r})=>e.jsx(l,{...r,label:"Job Name",required:!0,error:m.job_name?.message,placeholder:"e.g. Engine Overhaul"})}),c&&e.jsx(o,{name:"job_card_no",control:t,rules:{required:"Job Card No is required"},render:({field:r})=>e.jsx(l,{...r,label:"Job Card No.",required:!0,error:m.job_card_no?.message,placeholder:"JC-2023...",readOnly:!0})}),e.jsx(o,{name:"job_date",control:t,rules:{required:"Date is required"},render:({field:r})=>e.jsx(l,{...r,type:"date",label:"Date",required:!0,error:m.job_date?.message})}),e.jsx(o,{name:"department",control:t,rules:{required:"Department is required"},render:({field:r})=>e.jsx(l,{...r,type:"department",label:"Department",required:!0,error:m.department?.message})})]}),e.jsx("div",{className:"w-full",children:e.jsx(o,{name:"job_description",control:t,render:({field:r})=>e.jsx(w,{...r,label:"Job Description",placeholder:"Describe the job details...",rows:3})})}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 sm:gap-4",children:[e.jsx(o,{name:"quantity",control:t,rules:{required:"Quantity is required",min:1},render:({field:r})=>e.jsx(l,{...r,type:"number",label:"Quantity",required:!0,error:m.quantity?.message,placeholder:"Enter quantity"})}),e.jsx(o,{name:"expected_delivery_date",control:t,rules:{required:"Expected Delivery is required"},render:({field:r})=>e.jsx(l,{...r,type:"date",label:"Expected Delivery",required:!0,readOnly:!!c,error:m.expected_delivery_date?.message})}),e.jsx(o,{name:"job_type",control:t,rules:{required:"Job Type is required"},render:({field:r})=>e.jsxs(f,{...r,label:"Job Type",required:!0,error:m.job_type?.message,children:[e.jsx("option",{value:"",children:"Select job type"}),e.jsx("option",{value:"amc",children:"AMC"}),e.jsx("option",{value:"new_job",children:"New Job"}),e.jsx("option",{value:"in_house_manufacturing",children:"In house"}),e.jsx("option",{value:"repair",children:"Repair"}),e.jsx("option",{value:"service",children:"Service"})]})})]}),e.jsx("h3",{className:"text-base sm:text-lg font-semibold text-gray-800 border-b pb-1 mt-4 sm:mt-6",children:"Customer Information"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4",children:[e.jsx(o,{name:"customer_id",control:t,rules:{required:"Customer is required"},render:({field:r})=>e.jsxs(f,{...r,label:"Customer Name",required:!0,error:m.customer_id?.message,children:[e.jsx("option",{value:"",children:"Select Customer"}),h.filter(a=>a.party_type==="customer").map(a=>e.jsx("option",{value:a.id,children:a.party_name},a.id))]})}),e.jsx(o,{name:"customer_contact",control:t,render:({field:r})=>e.jsx(l,{...r,label:"Customer Contact",placeholder:"Auto-filled from customer",readOnly:!0,className:"bg-gray-100"})}),e.jsx(o,{name:"customer_address",control:t,render:({field:r})=>e.jsx(l,{...r,label:"Customer Address",placeholder:"Auto-filled from customer",readOnly:!0,className:"bg-gray-100"})})]}),e.jsxs("div",{className:"",children:[e.jsx("h3",{className:"text-base sm:text-lg font-semibold text-gray-800  pb-1 mt-4 sm:mt-6",children:"Operations"}),e.jsx("div",{className:"flex justify-end items-end gap-2",children:e.jsx(v,{type:"button",className:"bg-red-600 text-white  border-red-600",onClick:()=>U({operation_name:"",supervisor_id:"",start_date:"",end_date:"",machine_id:""}),children:"+ Add Operation"})}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(se,{children:[e.jsx(ae,{cols:[{title:"Operation Name"},{title:"Supervisor"},{title:"Start Date"},{title:"End Date"},{title:"Machine"},{title:"Actions"}]}),e.jsx("tbody",{children:J.map((r,a)=>e.jsxs(te,{children:[e.jsx(u,{className:"text-center font-medium w-12",children:a+1}),e.jsx(u,{className:"min-w-[200px]",children:e.jsx(o,{name:`operations.${a}.operation_name`,control:t,render:({field:s})=>e.jsx(l,{...s,placeholder:"e.g. Cutting, Welding",error:m.operations?.[a]?.operation_name?.message})})}),e.jsx(u,{className:"min-w-[200px]",children:e.jsx(o,{name:`operations.${a}.supervisor_id`,control:t,render:({field:s})=>e.jsxs(f,{...s,error:m.operations?.[a]?.supervisor_id?.message,children:[e.jsx("option",{value:"",children:"Select Supervisor"}),P?.map(i=>e.jsx("option",{value:i.id,children:i.full_name},i.id))]})})}),e.jsx(u,{className:"min-w-[150px]",children:e.jsx(o,{name:`operations.${a}.start_date`,control:t,render:({field:s})=>e.jsx(l,{...s,type:"date",error:m.operations?.[a]?.start_date?.message})})}),e.jsx(u,{className:"min-w-[150px]",children:e.jsx(o,{name:`operations.${a}.end_date`,control:t,render:({field:s})=>e.jsx(l,{...s,type:"date",error:m.operations?.[a]?.end_date?.message})})}),e.jsx(u,{className:"min-w-[200px]",children:e.jsx(o,{name:`operations.${a}.machine_id`,control:t,render:({field:s})=>e.jsxs(f,{...s,error:m.operations?.[a]?.machine_id?.message,children:[e.jsx("option",{value:"",children:"Select Machine"}),R.map(i=>e.jsx("option",{value:i.id,children:i.name},i.id))]})})}),e.jsx(oe,{children:J.length>1&&e.jsx(ne,{onClick:()=>H(a)})})]},r.id))})]})})]}),e.jsx("h3",{className:"text-base sm:text-lg font-semibold text-gray-800 border-b pb-1 mt-4 sm:mt-6",children:"Internal Tracking"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 sm:gap-4",children:[e.jsx(o,{name:"challan_no",control:t,render:({field:r})=>e.jsx(l,{...r,label:"Challan No.",placeholder:"Enter challan number"})}),e.jsx(o,{name:"challan_date",control:t,render:({field:r})=>e.jsx(l,{...r,type:"date",label:"Challan Date"})}),e.jsx(o,{name:"invoice_no",control:t,render:({field:r})=>e.jsx(l,{...r,label:"Invoice No.",placeholder:"Enter invoice number"})}),e.jsx(o,{name:"po_no",control:t,render:({field:r})=>e.jsx(l,{...r,label:"PO No.",placeholder:"Enter PO number"})})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-3 sm:gap-4",children:[e.jsx(o,{name:"remarks",control:t,render:({field:r})=>e.jsx(w,{...r,label:"Remarks",placeholder:"Add any additional notes or remarks...",rows:3})}),e.jsx(o,{name:"note",control:t,render:({field:r})=>e.jsx(w,{...r,label:"Note",placeholder:"Add any additional notes or comments...",rows:3})})]}),e.jsx("div",{className:"w-full",children:e.jsx(o,{name:"images",control:t,render:({field:r})=>e.jsx(re,{value:r.value,onChange:r.onChange,error:m.images?.message,maxFiles:6})})}),e.jsxs("div",{className:"flex flex-col sm:flex-row justify-end gap-3 pt-4 sm:pt-6",children:[e.jsx(v,{variant:"outline",type:"button",className:"w-full sm:w-auto order-2 sm:order-1",onClick:()=>C(A.JOB_ORDER.LIST),children:"Cancel"}),e.jsx(v,{type:"submit",loading:q,disabled:q,className:"bg-blue-600 text-white w-full sm:w-auto order-1 sm:order-2",children:c?"Update Job Card":"Save Job Card"})]})]})]})})};export{Ne as default};
