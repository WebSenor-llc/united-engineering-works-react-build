import{r as m,a as M,j as e,B as j,h as I,e as T,y as O,b as oe,u as le,A as V}from"./index-B6B_N_Cs.js";import{S as me}from"./Select-kGNGbSN_.js";import{T as y}from"./TextInput-B4OTG5Ho.js";import{T as $}from"./TextArea-Dp5JfhEl.js";import{L as _e}from"./ListWrapper-BYqYQIfr.js";import{T as l}from"./TableData-C5KeAsrw.js";import{T as pe,a as ue}from"./TableWrapper-Dhfo-hqQ.js";import{u as W,C as _,c as ge}from"./index.esm-CjwelUCb.js";import{o as Q,r as he,t as E,v as xe}from"./yup-DTpCJRmv.js";import{L as ye}from"./Loading-B-WDmzVe.js";import{F as ve}from"./FormHeader-gt-mZ858.js";import{B as be}from"./BaseModal-BlUy4Woj.js";import{C as je}from"./CommonFilter-C4rgzsJ9.js";import"./BackButton-J5klvAi3.js";const fe=he().shape({expected_delivery_date:E().required("Expected delivery date is required"),delivery_address:E().required("Delivery address is required"),delivery_contact_person:E().required("Contact person is required"),delivery_contact_phone:E().trim().transform(p=>p&&`+91${p.replace(/\D/g,"").replace(/^91/,"")}`).test("is-ten-digits","Phone number must be exactly 10 digits",p=>p?p.replace(/\D/g,"").replace(/^91/,"").length===10:!1).required("Contact phone is required"),special_instructions:E().optional()}),Ne=({open:p,onClose:u,vendorId:n,vendorName:f,csId:q,branchId:F,items:N,onSuccess:i})=>{const[w,c]=m.useState(!1),{control:x,handleSubmit:D,formState:{errors:o},reset:A}=W({resolver:Q(fe),defaultValues:{expected_delivery_date:"",delivery_address:"",delivery_contact_person:"",delivery_contact_phone:"",special_instructions:""}}),{user:G}=M(),L=G?.id,S=async d=>{c(!0);try{const v={...d,vendor_id:n,created_by:L,comparative_statement_id:q,branch_id:F,items:N.map(g=>({item_id:g.item_id,quantity_ordered:g.quantity_ordered,unit_price:g.rate,discount_percentage:g.discount_percentage,tax_percentage:g.tax_percentage,total_price:g.total_price,branch_id:F}))};await I.post(T.purchase_order.create,v),O.success(`Purchase Order generated for ${f}`),A(),i(),u()}catch(v){console.error(v),O.error("Failed to generate Purchase Order")}finally{c(!1)}};return e.jsx(be,{open:p,onClose:u,title:`Generate PO for ${f}`,maxWidth:"max-w-2xl",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"max-h-[60vh] overflow-y-auto pr-2 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 ml-1",children:[e.jsx(_,{name:"expected_delivery_date",control:x,render:({field:d})=>e.jsx(y,{...d,type:"date",label:"Expected Delivery Date",error:o.expected_delivery_date?.message})}),e.jsx(_,{name:"delivery_contact_person",control:x,render:({field:d})=>e.jsx(y,{...d,label:"Delivery Contact Person",error:o.delivery_contact_person?.message})}),e.jsx(_,{name:"delivery_contact_phone",control:x,render:({field:d})=>e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("label",{className:"text-sm font-semibold text-gray-700 mb-1",children:["Delivery Contact Phone ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"px-3 py-3 bg-gray-100 border border-gray-300 rounded-lg text-gray-700 text-sm",children:"+91"}),e.jsx(y,{...d,type:"tel",maxLength:10,placeholder:"Enter 10 digit mobile number",className:"mb-0 flex-1",onChange:v=>{const g=v.target.value.replace(/\D/g,"");d.onChange(g)}})]}),o.delivery_contact_phone?.message&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:o.delivery_contact_phone.message})]})}),e.jsx(_,{name:"delivery_address",control:x,render:({field:d})=>e.jsx(y,{...d,label:"Delivery Address",error:o.delivery_address?.message})})]}),e.jsx("div",{className:"ml-1",children:e.jsx(_,{name:"special_instructions",control:x,render:({field:d})=>e.jsx(y,{...d,label:"Special Instructions",error:o.special_instructions?.message})})})]}),e.jsxs("div",{className:"flex justify-end pt-4 space-x-3",children:[e.jsx(j,{variant:"outline",onClick:u,disabled:w,children:"Cancel"}),e.jsx(j,{onClick:D(S),loading:w,children:"Generate Purchase Order"})]})]})})},Se={vendor_id:0,branch_id:0,comparative_statement_id:0,expected_delivery_date:"",delivery_address:"",delivery_contact_person:"",delivery_contact_phone:"",special_instructions:"",items:[{item_id:0,item_name:"",item_code:"",item_unit:"",quantity_ordered:0,unit:"",unit_price:0,discount_percentage:0,tax_percentage:0,total_price:0,rate:"0"}]},Ve=()=>{const[p]=oe(),u=le(),n=p.get("editId"),[f,q]=m.useState([]),[F,N]=m.useState(!1),[i,w]=m.useState(null),{selectedBranchId:c}=M(),[x,D]=m.useState(!1),[o,A]=m.useState(null),[G,L]=m.useState({}),[S,d]=m.useState(!1),v=[{name:"statement_number",label:"Statement Number",placeholder:"Enter statement number"},{name:"mr_number",label:"MR Number",placeholder:"Enter MR number"},{name:"item_name",label:"Item Name",placeholder:"Enter item name"},{name:"date_from",label:"Date From",type:"date",placeholder:"Select start date"},{name:"date_to",label:"Date To",type:"date",placeholder:"Select end date"}],g=async r=>{if(!c)return;L(r);const a={branch_id:c};r.statement_number&&(a.statement_number=r.statement_number),r.mr_number&&(a.mr_number=r.mr_number),r.item_name&&(a.item_name=r.item_name),r.date_from&&r.date_to?r.date_from===r.date_to?a.date=r.date_from:(a.date_from=r.date_from,a.date_to=r.date_to):(r.date_from&&(a.date_from=r.date_from),r.date_to&&(a.date_to=r.date_to)),N(!0);try{const t=await I.get(T.comparative_statement.items,{params:a});q(t.data?.statements||[])}catch(t){console.error("Error filtering comparative statements:",t)}finally{N(!1)}},{control:b,setValue:U,reset:k,handleSubmit:z,formState:{errors:P}}=W({defaultValues:Se,resolver:Q(xe)}),C=ge({control:b,name:"comparative_statement_id"}),B=async()=>{if(c){N(!0);try{const r=await I.get(T.comparative_statement.items,{params:{branch_id:c}});q(r.data?.statements||[])}catch(r){console.error(r)}finally{N(!1)}}};m.useEffect(()=>{B()},[c]),m.useEffect(()=>{if(!n)return;(async()=>{d(!0);try{const a=await I.get(T.purchase_order.details(Number(n))),t=a.data?.purchase_order||a.data?.purchaseOrder||a.data;t&&(w(t),k({branch_id:t.branch_id||c,vendor_id:t.vendor_id||0,comparative_statement_id:t.comparative_statement_id||0,expected_delivery_date:t.expected_delivery_date?t.expected_delivery_date.split("T")[0]:"",delivery_address:t.delivery_address||"",delivery_contact_person:t.delivery_contact_person||"",delivery_contact_phone:t.delivery_contact_phone||"",special_instructions:t.special_instructions||"",items:(t.items||[]).map(s=>({item_id:s.item_id||0,item_name:s.item?.item_name||"",item_code:s.item?.item_code||"",item_unit:s.item?.unit?.unit_symbol||"",quantity_ordered:Number(s.quantity_ordered)||0,unit:s.item?.unit?.unit_symbol||"",unit_price:Number(s.unit_price)||0,discount_percentage:Number(s.discount_percentage)||0,tax_percentage:Number(s.tax_percentage)||0,total_price:Number(s.total_price)||0,rate:String(s.unit_price||0)}))}),U("comparative_statement_id",t.comparative_statement_id||0))}catch(a){console.error("Error loading PO details:",a),O.error("Failed to load Purchase Order details"),u(V.PURCHASE_ORDER.LIST)}finally{d(!1)}})()},[n,U,k,c,u]);const H=m.useMemo(()=>{if(!C)return{};const r=f.find(t=>t.id===C);if(!r||!r.items)return{};console.log("Selected CS:",r);const a={};if(r.items.forEach(t=>{const s=t.selected_vendor?.id||t.selected_vendor_id;if(!s)return;if(!a[s]){const R=r.vendors_with_po_status?.find(ce=>ce.vendor_id===s);a[s]={vendor:t.selected_vendor,items:[],all_items_have_po:!!R?.allItemsHavePo,po_items:n&&i?(i.items||[]).filter(()=>i.vendor_id===s):[]}}const h=t.selected_vendor_rate_details||{},K=Number(t.quantity)||0,X=Number(h.rate)||0,Y=Number(h.discount_percentage)||0,Z=Number(h.gst_percentage)||0,ee=Number(h.loading_charges)||0,te=Number(h.loading_gst_percentage)||0,re=Number(h.freight_charges)||0,ae=Number(h.freight_gst_percentage)||0,se=Number(h.cutting_charges)||0,ne=Number(h.cutting_gst_percentage)||0,ie=Number(h.total_amount)||0,de=n&&i&&i.items?.some(R=>R.item_id===t.item_id);a[s].items.push({item_id:t.item_id,item_name:t.item?.item_name||"Unknown Item",quantity_ordered:K,rate:X,discount_percentage:Y,tax_percentage:Z,loading_charges:ee,loading_gst_percentage:te,freight_charges:re,freight_gst_percentage:ae,cutting_charges:se,cutting_gst_percentage:ne,total_price:ie,has_po:de})}),n&&i){const t=i.vendor_id,s={};return t&&a[t]&&(s[t]=a[t]),s}return a},[f,C,n,i]),J=async r=>{if(!n){O.error("Edit mode is required for form submission");return}d(!0);try{const a={...r,branch_id:c};await I.put(T.purchase_order.update(Number(n)),a),O.success("Purchase Order updated successfully"),u(V.PURCHASE_ORDER.LIST)}catch(a){console.error("Error updating Purchase Order:",a),O.error(a.response?.data?.message||"Failed to update Purchase Order")}finally{d(!1)}};return F||S?e.jsx("div",{className:"flex justify-center py-20",children:e.jsx(ye,{})}):e.jsxs("div",{className:"w-full h-full overflow-auto space-y-8 p-4 pb-20",children:[e.jsx("div",{className:"space-y-1 ml-2",children:e.jsx(ve,{title:n?"Edit Purchase Order":"Create Purchase Order",subtitle:n?"Update the Purchase Order details":"Fill out the form to submit a new Purchase Order."})}),e.jsx(je,{fields:v,onFilter:g,defaultValues:G}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-5 ml-4",children:[e.jsx(_,{name:"comparative_statement_id",control:b,render:({field:r})=>e.jsxs(me,{...r,label:"Comparative Statement",value:r.value||0,onChange:a=>r.onChange(Number(a.target.value)),disabled:!!n,error:P.comparative_statement_id?.message,children:[e.jsx("option",{value:0,children:"Select Comparative Statement"}),f.map(a=>e.jsx("option",{value:a.id,children:a.statement_number},a.id))]})}),n&&i&&e.jsxs("div",{className:"bg-gray-50 border border-gray-200 rounded p-3",children:[e.jsx("h4",{className:"font-semibold text-gray-800 mb-2",children:"Purchase Order Details"}),e.jsxs("p",{className:"text-sm text-gray-700",children:[e.jsx("strong",{children:"PO Number:"})," ",i.po_number||"N/A"]}),e.jsxs("p",{className:"text-sm text-gray-700",children:[e.jsx("strong",{children:"Vendor:"})," ",i.vendor?.party_name||"N/A"]}),e.jsxs("p",{className:"text-sm text-gray-700",children:[e.jsx("strong",{children:"Status:"})," ",i.status||"N/A"]}),(i.status?.toLowerCase().includes("cancel")||i.status==="Cancelled")&&i.cancellation_reason&&e.jsx("div",{className:"mt-2 p-2 bg-red-50 border border-red-200 rounded",children:e.jsxs("p",{className:"text-sm text-red-800",children:[e.jsx("strong",{children:"Cancellation Reason:"})," ",i.cancellation_reason||"No reason provided"]})})]})]}),n&&i&&e.jsx("form",{onSubmit:z(J),className:"space-y-6",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Purchase Order Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx(_,{name:"expected_delivery_date",control:b,render:({field:r})=>e.jsx(y,{...r,type:"date",label:"Expected Delivery Date",error:P.expected_delivery_date?.message})}),e.jsx(_,{name:"delivery_contact_person",control:b,render:({field:r})=>e.jsx(y,{...r,label:"Delivery Contact Person",placeholder:"Enter contact person name",error:P.delivery_contact_person?.message})}),e.jsx(_,{name:"delivery_contact_phone",control:b,render:({field:r})=>e.jsx(y,{...r,label:"Delivery Contact Phone",placeholder:"Enter contact phone number",error:P.delivery_contact_phone?.message})}),e.jsx("div",{className:"md:col-span-2",children:e.jsx(_,{name:"delivery_address",control:b,render:({field:r})=>e.jsx($,{...r,label:"Delivery Address",placeholder:"Enter delivery address",rows:3,error:P.delivery_address?.message})})}),e.jsx("div",{className:"md:col-span-2",children:e.jsx(_,{name:"special_instructions",control:b,render:({field:r})=>e.jsx($,{...r,label:"Special Instructions",placeholder:"Enter any special instructions",rows:3,error:P.special_instructions?.message})})})]}),e.jsxs("div",{className:"flex justify-end gap-3 mt-6",children:[e.jsx(j,{type:"button",variant:"outline",onClick:()=>u(V.PURCHASE_ORDER.LIST),disabled:S,children:"Cancel"}),e.jsx(j,{type:"submit",disabled:S,className:"bg-blue-600 text-white",children:S?"Updating...":"Update Purchase Order"})]})]})}),C&&Object.keys(H).length>0?e.jsx("div",{className:"space-y-6",children:Object.entries(H).map(([r,a])=>e.jsxs(_e,{title:`Vendor: ${a.vendor?.party_name||"Unknown"}`,children:[e.jsxs("div",{className:"mb-4 flex justify-between items-center",children:[e.jsxs("div",{className:"text-sm text-gray-600",children:[e.jsxs("p",{children:["Total Items: ",a.items.length]}),e.jsxs("p",{className:"font-semibold text-gray-900",children:["Grand Total: ₹",a.items.reduce((t,s)=>t+s.total_price,0).toLocaleString("en-IN",{minimumFractionDigits:2})]})]}),n?e.jsx(j,{variant:"outline",disabled:!0,className:"bg-green-100 !text-green-600 !border-green-300",children:"Current PO Vendor"}):a.all_items_have_po?e.jsx(j,{variant:"outline",disabled:!0,className:"bg-gray-100 !text-gray-400 !border-gray-300 pointer-events-none",children:"Generated"}):e.jsx(j,{onClick:()=>{A({...a,vendorId:Number(r)}),D(!0)},children:"Generate PO"})]}),e.jsxs(pe,{children:[e.jsx(ue,{cols:[{title:"Item"},{title:"Qty"},{title:"Rate"},{title:"Disc%"},{title:"GST%"},{title:"Loading"},{title:"Freight"},{title:"Cutting"},{title:"Total"},...n?[{title:"Status"}]:[]]}),e.jsx("tbody",{children:a.items.map((t,s)=>e.jsxs("tr",{className:`border-t ${n&&t.has_po?"bg-green-50":""}`,children:[e.jsx(l,{children:s+1}),e.jsx(l,{children:t.item_name}),e.jsx(l,{children:t.quantity_ordered}),e.jsx(l,{children:t.rate}),e.jsxs(l,{children:[t.discount_percentage,"%"]}),e.jsxs(l,{children:[t.tax_percentage,"%"]}),e.jsxs(l,{children:["₹",t.loading_charges||0,t.loading_gst_percentage?e.jsxs("span",{className:"text-[10px] text-gray-500",children:[" (+",t.loading_gst_percentage,"%)"]}):null]}),e.jsxs(l,{children:["₹",t.freight_charges||0,t.freight_gst_percentage?e.jsxs("span",{className:"text-[10px] text-gray-500",children:[" (+",t.freight_gst_percentage,"%)"]}):null]}),e.jsxs(l,{children:["₹",t.cutting_charges||0,t.cutting_gst_percentage?e.jsxs("span",{className:"text-[10px] text-gray-500",children:[" (+",t.cutting_gst_percentage,"%)"]}):null]}),e.jsxs(l,{children:["₹",t.total_price.toFixed(2)]}),n&&e.jsx(l,{children:t.has_po?e.jsx("span",{className:"text-xs bg-green-100 text-green-800 px-2 py-1 rounded",children:"In PO"}):e.jsx("span",{className:"text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded",children:"Available"})})]},s))})]})]},r))}):e.jsx("div",{className:"p-8 text-center text-gray-500 bg-gray-50 rounded-lg",children:C?"No items found for this Comparative Statement.":"Please select a Comparative Statement to view items grouped by vendor."}),x&&o&&e.jsx(Ne,{open:x,onClose:()=>D(!1),vendorId:o.vendorId,vendorName:o.vendor?.party_name||"Unknown",csId:C,branchId:c,items:o.items,onSuccess:()=>{D(!1),B()}})]})};export{Ve as default};
