import{r as u,a as L,j as e,M as a,y as D,e as m,h,u as B,k as O,D as w,P as y,A as P}from"./index-pN5-d-m8.js";import{L as M}from"./ListWrapper-CqihWRKm.js";import{T as q,a as Y,b as c}from"./TableWrapper-CZQA7s35.js";import{T as k}from"./TableRow-BiiWmwvS.js";import{u as V}from"./usePagination-C2sJmyrq.js";import{T as H}from"./TableActions-DGk_iS9Q.js";import{T as I}from"./TableEdit-DklRpmAs.js";import{T as U}from"./TableDelete-WFkQ4OjU.js";import{R as S}from"./ReasonModal-DYGhKKHm.js";import{c as J}from"./rolePermissions-e5UvjEK3.js";import{S as $}from"./StatusFilter-C9APPsH_.js";import{T as F}from"./TableView-DTgWiU07.js";const W=({materialRequisition:r,onStatusUpdate:j})=>{const[N,b]=u.useState(!1),[A,d]=u.useState(!1),[R,E]=u.useState(!1),[i,p]=u.useState(null),{user:v}=L(),T=async(t,l)=>{b(!0);try{let n="",o={};if((t===a.REJECTED_BY_DEPT_HEAD||t===a.CANCELLED_BY_STORE)&&!l){D.error("Reason is required");return}switch(t){case a.PENDING_DEPT_APPROVAL:n=m.material_requisition.submit(r.id),await h.post(n);break;case a.APPROVED_BY_DEPT_HEAD:n=m.material_requisition.approveDept(r.id),await h.post(n,{action:"approve"});break;case a.REJECTED_BY_DEPT_HEAD:n=m.material_requisition.reject(r.id),o={action:"reject",cancellation_reason:l||"No reason provided"},await h.post(n,o);break;case a.APPROVED_BY_STORE:n=m.material_requisition.approveStore(r.id),await h.post(n);break;case a.CANCELLED_BY_STORE:n=m.material_requisition.cancel(r.id),o={action:"cancel",cancellation_reason:l||"No reason provided"},await h.post(n,o);break;case a.COMPLETED:D.success("Material Requisition marked as Completed");break;default:throw new Error("Invalid status change")}D.success("Status updated successfully"),j()}catch(n){console.error("Failed to update status:",n),D.error(n.response?.data?.message||"Failed to update status")}finally{b(!1)}},_=(()=>{const t=r.status,l=v?.role?.role_name||"";switch(t){case a.PENDING_DEPT_APPROVAL:return J(l)?[{value:a.APPROVED_BY_DEPT_HEAD,label:"Approve"},{value:a.REJECTED_BY_DEPT_HEAD,label:"Reject"}]:[];case a.APPROVED_BY_DEPT_HEAD:if(l==="Store Manager")return[{value:a.APPROVED_BY_STORE,label:"Approve"},{value:a.CANCELLED_BY_STORE,label:"Cancel"}];break;default:return[]}return[]})(),g=t=>{t===a.REJECTED_BY_DEPT_HEAD?(p({status:t,actionType:"reject"}),d(!0)):t===a.CANCELLED_BY_STORE?(p({status:t,actionType:"cancel"}),d(!0)):T(t)},x=t=>{i&&(T(i.status,t),p(null)),d(!1)},s=()=>{p(null),d(!1)};return _.length===0?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs px-2 py-1 bg-gray-100 text-gray-700 rounded border",children:r.status}),(r.status===a.CANCELLED_BY_STORE||r.status===a.REJECTED_BY_DEPT_HEAD)&&r.cancellation_reason&&e.jsx("button",{onClick:()=>E(!0),className:"text-xs px-2 py-1 bg-red-100 text-red-700 rounded border border-red-200 hover:bg-red-200 transition-colors",title:"View reason",children:"View Reason"})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex items-center gap-2",children:N?e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"}),e.jsx("span",{className:"text-xs text-gray-500",children:"Updating..."})]}):e.jsxs(e.Fragment,{children:[e.jsxs("select",{className:"text-xs border border-gray-300 rounded px-2 py-1 focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white min-w-[120px]",value:"",onChange:t=>{t.target.value&&(g(t.target.value),t.target.value="")},children:[e.jsx("option",{value:"",children:r.status}),_.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))]}),(r.status===a.CANCELLED_BY_STORE||r.status===a.REJECTED_BY_DEPT_HEAD)&&r.cancellation_reason&&e.jsx("button",{onClick:()=>E(!0),className:"text-xs px-2 py-1 bg-red-100 text-red-700 rounded border border-red-200 hover:bg-red-200 transition-colors",title:"View reason",children:"View Reason"})]})}),e.jsx(S,{open:R,onClose:()=>E(!1),title:r.status===a.CANCELLED_BY_STORE?"Cancellation Reason":"Rejection Reason",message:r.cancellation_reason||"No reason provided",readonly:!0}),e.jsx(S,{open:A,onClose:s,onSubmit:x,title:i?.actionType==="reject"?"Rejection Reason":"Cancellation Reason",message:i?.actionType==="reject"?"Please provide a reason for rejecting this material request:":"Please provide a reason for cancelling this material request:"})]})},ie=()=>{const{page:r,rowsPerPage:j,setTotal:N,renderPagination:b}=V(),A=B(),{selectedBranchId:d,user:R}=L(),{setMaterialRequisitions:E}=O(),[i,p]=u.useState(""),[v,T]=u.useState([]),[C,_]=u.useState(!0),g=async()=>{_(!0);try{const s=await h.get(m.material_requisition.items,{params:{page:r+1,rowsPerPage:j,...d&&{branch_id:d}}}),t=s.data?.material_requisitions||[],l=s.data?.pagination;T(t),l?.total!==void 0&&N(l.total);const n=R?.role?.role_name;let o=0;n==="Department Head"?o=t.filter(f=>f.status==="Pending Approval (Dept Head)").length:n==="Store Manager"?o=t.filter(f=>f.status==="Approved - With Head").length:n==="Super Admin"&&(o=t.filter(f=>f.status==="Approved - With Store").length),E(o)}catch(s){console.error("Error fetching material requests:",s)}finally{_(!1)}};u.useEffect(()=>{g()},[r,j,d]);const x=i?v.filter(s=>s.status===i):v;return e.jsxs("div",{className:"space-y-6",children:[e.jsx($,{module:"materialRequisition",selectedStatus:i,onChange:s=>p(s)}),e.jsxs(M,{title:`Material Requests (${x.length})`,createOnClick:y.hasPermission("material_requisition_create")?()=>A(P.MATERIAL_REQUEST.CREATE):void 0,children:[e.jsxs(q,{children:[e.jsx(Y,{cols:[{title:"MR Number"},{title:"Department"},{title:"Priority"},{title:"Requested By"},{title:"Required By"},{title:"Status"},{title:"Created At"},{title:"Actions"}]}),e.jsx("tbody",{children:C&&x.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:10,className:"px-6 py-12 text-center",children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("svg",{className:"w-12 h-12 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),e.jsx("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"No material requests"}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:i?`No requests found with status "${i}"`:"Get started by creating a new material request."})]})})}):x.map((s,t)=>e.jsxs(k,{children:[e.jsx(c,{className:"w-12 text-center font-medium",children:e.jsx("div",{className:"text-sm text-gray-900",children:t+1})}),e.jsx(c,{className:"w-40",children:e.jsx("div",{className:"flex items-center",children:e.jsx("div",{className:"text-sm font-medium text-gray-900",children:s.mr_number})})}),e.jsx(c,{className:"w-36",children:e.jsx("div",{className:"text-sm text-gray-900",children:s.department})}),e.jsx(c,{className:"w-28",children:e.jsx("span",{className:"inline-flex items-center justify-center px-2 py-1 text-xs font-medium bg-gray-100 text-gray-800 rounded-full",children:s.priority})}),e.jsx(c,{className:"w-48",children:e.jsx("div",{className:"flex items-center",children:e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:s.requested_by?.full_name||"â€”"}),e.jsx("div",{className:"text-sm text-gray-500",children:s.requested_by?.employee_code||""})]})})}),e.jsx(c,{className:"w-32",children:e.jsx("div",{className:"text-sm text-gray-900",children:w.date(s.required_by_date)})}),e.jsx(c,{className:"w-40",children:e.jsx(W,{materialRequisition:{id:s.id,status:s.status,mr_number:s.mr_number},onStatusUpdate:g})}),e.jsx(c,{className:"w-32",children:e.jsx("div",{className:"text-sm text-gray-500",children:w.date(s.created_at)})}),e.jsx(c,{className:"w-20",children:e.jsxs(H,{children:[e.jsx(F,{url:`${P.MATERIAL_REQUEST.DETAILS.replace(":id","")}${s.id}`,tooltip:"View Material Request Details"}),y.hasPermission("material_requisition_update")&&e.jsx(I,{onClick:()=>A(`${P.MATERIAL_REQUEST.CREATE}?id=${s.id}`)}),y.hasPermission("material_requisition_delete")&&e.jsx(U,{refetch:g,endpoint:m.material_requisition.delete(s.id)})]})})]},s.id))})]}),x.length>0&&b()]})]})};export{ie as default};
