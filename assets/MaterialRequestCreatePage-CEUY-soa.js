import{ad as G,h as b,e as v,u as V,i as W,r as x,a as z,j as e,B as y,y as g,A as P}from"./index-Dpd7qybE.js";import{T as u}from"./TextInput-k8VaqEnw.js";import{S as _}from"./Select-GNnBf5BR.js";import{T as Y,a as J}from"./TableDelete-DH9r8gXr.js";import{T as K,a as X,b as d}from"./TableWrapper-DtKbbg8N.js";import{T as Z}from"./TableRow-DkGT6S5k.js";import{u as ee,b as re,c as se,C as l}from"./index.esm-Csq66oCQ.js";import{u as te}from"./useItemsStore-DGiwN9Tn.js";import{u as ae}from"./useMachineStore-DppBCkfh.js";import{F as ne}from"./FormHeader-CgKyjGwi.js";import{o as le,m as ie}from"./yup-DvkqHPEo.js";const oe=G(p=>({branches:[],loading:!1,error:null,fetchBranches:async()=>{p({loading:!0,error:null});try{const h=await b.get(v.branches.all);p({branches:h.data?.branches||[],loading:!1})}catch(h){p({loading:!1,error:h?.message||"Failed to fetch branches"})}}})),ce={department_from:"",department_to:"Store Department",required_date:"",priority:"Normal",purpose:"",Note:"",project_use:"",project_note:"",machine_use:"",machine_note:"",site_use:"",site_note:"",general_use:"",general_note:"",inspection:"",items:[{item_id:0,item_name:"",item_code:"",item_unit:"",req_qty:0,stock:null,remark:"",max_stock_level:0}]},de="w-full h-10 rounded-md border border-gray-300 px-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white",Ne=()=>{const p=V(),[h]=W(),o=h.get("id")?Number(h.get("id")):void 0,[T,q]=x.useState(!1),[S,w]=x.useState(!1),{selectedBranchId:M,user:A}=z(),{control:a,handleSubmit:F,formState:{errors:i},setValue:m,reset:U}=ee({defaultValues:ce,resolver:le(ie)}),{fields:k,append:$,remove:L}=re({control:a,name:"items"}),{items:R,fetchItems:f}=te(),{machines:B,fetchMachines:C}=ae(),{branches:D,fetchBranches:E}=oe(),j=A?.role,N=se({control:a});x.useEffect(()=>{f(),C(),E()},[f,C,E]),x.useEffect(()=>{j?.role_name&&(j?.role_name==="Store Manager"&&m("department_from","Store Department"),["Workshop Supervisor","Dept Head","Super Admin"].includes(j?.role_name)&&m("department_from","Production Department"))},[j?.role_name,m]),x.useEffect(()=>{o&&N&&console.log("Current form values:",N)},[N,o]);const H=async()=>{if(o){q(!0);try{const r=await b.get(v.material_requisition.details(o)),s=r.data.data?.material_requisition||r.data.material_requisition||r.data,n=t=>t?new Date(t).toISOString().split("T")[0]:"";if(!s){console.error("No data found in API response"),g.error("No data found for this material request");return}const c={department_from:s.department||"Production Department",department_to:"Store Department",purpose:s.remarks||"",required_date:n(s.required_by_date||""),priority:s.priority||"Normal",Note:"",project_use:"",project_note:"",machine_use:"",machine_note:"",site_use:"",site_note:"",general_use:"",general_note:"",items:s.items&&s.items.length>0?s.items.map(t=>({item_id:t.item_id||0,item_name:t.item?.item_name||"",item_code:t.item?.item_code||"",item_unit:t.item?.unit?.unit_name||"",req_qty:Number(t.quantity_required||0),approved_qty:null,inspection:"",remark:t.remarks||"",max_stock_level:t.item?.max_stock_level||0,stock:t.item?.current_stock||null})):[{item_id:0,item_name:"",item_code:"",item_unit:"",req_qty:0,stock:null,approved_qty:null,inspection:"",remark:"",max_stock_level:0}]};U(c)}catch(r){console.error("Error loading request details:",r),g.error("Failed to load material request details")}finally{q(!1)}}};x.useEffect(()=>{f().then(()=>{o&&H()})},[o]);const O=async r=>{w(!0);try{const s={department:r.department_from,required_by_date:r.required_date,priority:r.priority,remarks:r.purpose||"",project_use:r.project_use||null,project_note:r.project_note||null,machine_use:r.machine_use?Number(r.machine_use):null,machine_note:r.machine_note||null,site_use:r.site_use?Number(r.site_use):null,site_note:r.site_note||null,general_use:r.general_use||null,general_note:r.general_note||null,branch_id:M,inspection:r.inspection,items:r.items.map(t=>({item_id:Number(t.item_id),quantity_required:Number(t.req_qty),specification:t.item_unit,remarks:t.remark||""}))},n=o?v.material_requisition.update(o):v.material_requisition.create;await(o?b.put:b.post)(n,s),g.success(o?"Material Request Updated Successfully":"Material Request Created Successfully"),p(P.MATERIAL_REQUEST.LIST)}catch(s){console.error("Error:",s),g.error(s.response?.data?.message||"Failed to save material request")}finally{w(!1)}},Q=()=>{p(P.MATERIAL_REQUEST.LIST)};return T?e.jsx("div",{className:"flex justify-center items-center min-h-screen",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-red-600"})}):e.jsx("div",{className:"w-full min-h-screen bg-gray-50 p-4",children:e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsx(ne,{title:"Material Requisition Form",subtitle:"Provide department details and list every item you need in this request."}),e.jsxs("form",{onSubmit:F(O),className:"space-y-8 mt-8",children:[e.jsxs("section",{className:"bg-white rounded-lg shadow-sm p-4 sm:p-6 space-y-6",children:[e.jsxs("div",{className:"border-b border-gray-200 pb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Request Details"}),e.jsx("div",{className:"text-sm font-semibold text-gray-700 mt-2",children:e.jsx("p",{children:"Please fill atleast one pair among Project use/Machine use/Site use/General use/Note"})})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 sm:gap-6 sm:grid-cols-2 lg:grid-cols-3",children:[e.jsx(l,{name:"department_from",control:a,render:({field:r})=>e.jsxs(_,{...r,label:"Department From",required:!0,error:i.department_from?.message,disabled:!0,children:[e.jsx("option",{value:"Production Department",children:"Production Department"}),e.jsx("option",{value:"Store Department",children:"Store Department"}),e.jsx("option",{value:"Purchase Department",children:"Purchase Department"})]})}),e.jsx(l,{name:"department_to",control:a,render:({field:r})=>e.jsx(u,{required:!0,...r,label:"Department To"})}),e.jsx(l,{name:"required_date",control:a,render:({field:r})=>e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs("label",{className:"text-sm font-semibold text-gray-700",children:["Required Date ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{...r,type:"date",className:de}),i.required_date&&e.jsx("span",{className:"text-xs text-red-600 mt-1",children:i.required_date?.message})]})}),e.jsx(l,{name:"priority",control:a,render:({field:r})=>e.jsxs(_,{...r,label:"Priority",required:!0,error:i.priority?.message,children:[e.jsx("option",{value:"Urgent",children:"High"}),e.jsx("option",{value:"Emergency",children:"Medium"}),e.jsx("option",{value:"Normal",children:"Low"})]})}),e.jsx(l,{name:"inspection",control:a,render:({field:r})=>e.jsxs(_,{...r,required:!0,label:"Inspection",value:r.value===void 0?"":String(r.value),onChange:s=>r.onChange(s.target.value==="true"),children:[e.jsx("option",{value:"",children:"Select"}),e.jsx("option",{value:"true",children:"Yes"}),e.jsx("option",{value:"false",children:"No"})]})}),e.jsx("div",{className:"col-span-full",children:e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsx(l,{name:"project_use",control:a,render:({field:r})=>e.jsx(u,{...r,value:r.value??"",label:"Project Use",error:i?.project_use?.message,placeholder:"Enter project details"})}),e.jsx(l,{name:"project_note",control:a,render:({field:r})=>e.jsx(u,{...r,value:r.value??"",label:"Project Note",error:i?.project_note?.message,placeholder:"Enter project note"})})]})}),e.jsx("div",{className:"col-span-full",children:e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsx(l,{name:"machine_use",control:a,render:({field:r})=>e.jsxs(_,{...r,value:r.value??"",label:"Machine Use",error:i?.machine_use?.message,children:[e.jsx("option",{value:"",children:"Select Machine"}),B.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})}),e.jsx(l,{name:"machine_note",control:a,render:({field:r})=>e.jsx(u,{...r,value:r.value??"",label:"Machine Note",error:i?.machine_note?.message,placeholder:"Enter machine note"})})]})}),e.jsx("div",{className:"col-span-full",children:e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsx(l,{name:"site_use",control:a,render:({field:r})=>e.jsxs(_,{...r,value:r.value??"",label:"Site Use",error:i?.site_use?.message,children:[e.jsx("option",{value:"",children:"Select Branch"}),D.map(s=>e.jsx("option",{value:s.id,children:s.branch_name},s.id))]})}),e.jsx(l,{name:"site_note",control:a,render:({field:r})=>e.jsx(u,{...r,value:r.value??"",label:"Site Note",error:i?.site_note?.message,placeholder:"Enter site note"})})]})}),e.jsx("div",{className:"col-span-full",children:e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsx(l,{name:"general_use",control:a,render:({field:r})=>e.jsx(u,{...r,value:r.value??"",label:"General Use",error:i?.general_use?.message,placeholder:"Enter general use details"})}),e.jsx(l,{name:"general_note",control:a,render:({field:r})=>e.jsx(u,{...r,value:r.value??"",label:"General Note",error:i?.general_note?.message,placeholder:"Enter general note"})})]})})]})]}),e.jsxs("section",{className:"bg-white rounded-lg shadow-sm p-4 sm:p-6 space-y-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsx("div",{children:e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Items Requested"})}),e.jsx(y,{className:"bg-red-600 text-white px-4 py-2 w-full sm:w-auto",onClick:()=>$({item_id:0,item_name:"",item_code:"",item_unit:"",req_qty:0,stock:null,remark:"",max_stock_level:0}),children:"+Add Item"})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(K,{children:[e.jsx(X,{cols:[{title:"Item Name"},{title:"Item Code"},{title:"Item Unit"},{title:"Req Qty"},{title:"Stock In Store"},{title:"Remark"},{title:"Actions"}]}),e.jsx("tbody",{children:k.map((r,s)=>e.jsxs(Z,{children:[e.jsx(d,{className:"w-12 text-center font-medium",children:s+1}),e.jsx(d,{className:"w-64",children:e.jsx(l,{name:`items.${s}.item_id`,control:a,render:({field:n})=>e.jsxs(_,{...n,value:n.value||"",onChange:c=>{const t=R.find(I=>I.id===Number(c.target.value));n.onChange(Number(c.target.value)),t&&(m(`items.${s}.item_id`,t.id),m(`items.${s}.item_code`,t.item_code),m(`items.${s}.item_name`,t.item_name),m(`items.${s}.item_unit`,t.unit?.unit_name))},children:[e.jsx("option",{value:"",children:"Select Item"}),R.map(c=>e.jsx("option",{value:c.id,children:c.item_name},c.id))]})})}),e.jsx(d,{className:"w-32",children:e.jsx(l,{name:`items.${s}.item_code`,control:a,render:({field:n})=>e.jsx("input",{...n,className:"w-full h-[45px] border border-gray-300 rounded-lg px-3 text-sm bg-gray-50 font-mono",placeholder:"Code",readOnly:!0})})}),e.jsx(d,{className:"w-24",children:e.jsx(l,{name:`items.${s}.item_unit`,control:a,render:({field:n})=>e.jsx("input",{...n,className:"w-full h-[45px] border border-gray-300 rounded-lg px-3 text-sm bg-gray-50 text-center",placeholder:"Unit",readOnly:!0})})}),e.jsx(d,{className:"w-24",children:e.jsx(l,{name:`items.${s}.req_qty`,control:a,render:({field:n})=>e.jsx("input",{...n,className:"w-full h-[45px] border border-gray-300 rounded-lg px-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-center",placeholder:"Qty",type:"number",min:"1",onFocus:()=>{n.value===0&&n.onChange("")}})})}),e.jsx(d,{className:"w-28",children:e.jsx(l,{name:`items.${s}.stock`,control:a,render:({field:n})=>e.jsx("input",{...n,className:"w-full h-[45px] border border-gray-300 rounded-lg px-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-center",value:n.value??"",placeholder:"Stock",type:"number"})})}),e.jsx(d,{className:"w-40",children:e.jsx(l,{name:`items.${s}.remark`,control:a,render:({field:n})=>e.jsx("input",{...n,className:"w-full h-[45px] border border-gray-300 rounded-lg px-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",value:n.value??"",placeholder:"Remark"})})}),e.jsx(d,{className:"w-16",children:e.jsx(Y,{children:e.jsx(J,{onClick:()=>{k.length>1&&L(s)}})})})]},r.id))})]})})]}),Object.keys(i).length>0&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-md p-4",children:e.jsxs("div",{className:"flex",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("svg",{className:"h-5 w-5 text-red-400",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z",clipRule:"evenodd"})})}),e.jsxs("div",{className:"ml-3",children:[e.jsx("h3",{className:"text-sm font-medium text-red-800",children:"Please fix the following errors:"}),e.jsx("div",{className:"mt-2 text-sm text-red-700",children:e.jsx("ul",{className:"list-disc pl-5 space-y-1",children:Object.entries(i).map(([r,s])=>e.jsx("li",{children:s?.message||`${r} is invalid`},r))})})]})]})}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx(y,{variant:"outline",type:"button",onClick:Q,children:"Cancel"}),e.jsx(y,{className:"bg-red-600 text-white",type:"submit",loading:S,disabled:S,children:o?"Update Material Request":"Submit Material Request"})]})]})]})})};export{Ne as default};
