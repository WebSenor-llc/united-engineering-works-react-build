import{r as m,j as e,h as q,e as S,ak as z,al as K,y as j,u as Q,i as V,a as I,B as P,A as O}from"./index-BPpkRjQL.js";import{C as i,u as W}from"./index.esm-CaQR1vU5.js";import{T as u}from"./TextInput-gfXRTV11.js";import{T as w}from"./TextArea-B4hqIei3.js";import{S as k}from"./Select-BmBrM02N.js";import{F as $}from"./FormHeader-N4r7k8fv.js";import{L as J}from"./Loading-nJeSTSjR.js";import{u as G}from"./useMachineStore-Ds3Z5V7c.js";import{o as X,z as Y}from"./yup-Cpl6tZUx.js";import{b as Z}from"./rolePermissions-Dm4XNOSj.js";import{u as ee}from"./usePartyStore-DjSl5P8O.js";import"./BackButton-DvhqPw91.js";const re=({control:f,name:g,label:l="Branch",required:c=!1,error:y,disabled:v=!1})=>{const[_,x]=m.useState([]),[p,b]=m.useState(!1);return m.useEffect(()=>{(async()=>{b(!0);try{const h=(await q.get(S.branches.branch)).data?.branches||[];x(h)}catch(n){console.error("BranchSelect: Error fetching branches:",n)}finally{b(!1)}})()},[]),e.jsx(i,{name:g,control:f,render:({field:t})=>e.jsxs(k,{...t,label:l,required:c,error:y,disabled:v||p,onChange:n=>t.onChange(Number(n.target.value)),children:[e.jsx("option",{value:"",children:p?"Loading branches...":"Select Branch"}),_.map(n=>e.jsx("option",{value:n.id,children:n.branch_name},n.id))]})})},se=({label:f="Upload Images",maxFiles:g=6,value:l,onChange:c,error:y})=>{const[v,_]=m.useState(!1),x=m.useRef(null),p=t=>{const n=t.filter(h=>h.type.startsWith("image/"));if(n.length!==t.length&&j.error("Only image files are allowed here"),l.length+n.length>g){j.error(`Max ${g} files allowed`);return}c([...l,...n])},b=t=>{c(l.filter((n,h)=>h!==t))};return e.jsxs("div",{className:"w-full",children:[e.jsxs("label",{className:"text-sm font-medium text-gray-700 mb-2 block",children:[f," (Max ",g,")"]}),l.length<g&&e.jsxs("div",{className:`border-2 border-dashed rounded-lg p-6 cursor-pointer ${v?"border-blue-500 bg-blue-50":"border-gray-300"}`,onClick:()=>x.current?.click(),onDragOver:t=>{t.preventDefault(),_(!0)},onDragLeave:()=>_(!1),onDrop:t=>{t.preventDefault(),_(!1),p(Array.from(t.dataTransfer.files))},children:[e.jsx("input",{type:"file",ref:x,className:"hidden",accept:"image/*",multiple:!0,onChange:t=>t.target.files&&p(Array.from(t.target.files))}),e.jsx(z,{className:"mx-auto text-3xl text-gray-400"}),e.jsx("p",{className:"text-center text-sm text-gray-500 mt-2",children:"Drag & drop images or click to select"})]}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 mt-4",children:l.map((t,n)=>{const h=typeof t=="string"?t:URL.createObjectURL(t);return typeof t!="string"&&!t.type.startsWith("image/")?null:e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:h,className:"w-full h-32 object-cover rounded border"}),e.jsx("button",{type:"button",onClick:()=>b(n),className:"absolute -top-2 -right-2 bg-red-600 text-white rounded-full p-1",children:e.jsx(K,{size:12})})]},n)})}),y&&e.jsx("p",{className:"text-xs text-red-500 mt-1",children:y})]})},ge=()=>{const f=Q(),[g]=V(),l=g.get("editId"),{selectedBranchId:c}=I(),[y,v]=m.useState(!1),[_,x]=m.useState(!1),{parties:p,fetchParties:b}=ee(),[t,n]=m.useState(null),{machines:h,fetchMachines:D}=G(),A={job_name:"",task_card_no:"",job_date:new Date().toISOString().split("T")[0],department:"Production Department",job_description:"",quantity:1,expected_delivery_date:"",job_type:"",priority:"Normal",customer_id:"",customer_name:"",customer_contact:"",customer_address:"",supervisor_id:"",supervisor_address:"",branch_id:c?Number(c):0,machine_used:"",challan_no:"",challan_date:"",invoice_no:"",po_no:"",remarks:"",images:[],note:""},{control:o,handleSubmit:B,setValue:N,watch:L,reset:E,formState:{errors:d}}=W({defaultValues:A,resolver:X(Y,{context:{isEdit:!!l}})}),{user:R}=I(),U=R?.id,T=L("customer_id"),M=async r=>{if(r)try{const a=(await q.get(S.user_management.all,{params:{branch_id:r}})).data.users.filter(C=>Z(C.role.role_name));n(a)}catch(s){console.log(s),j.error("Failed to fetch users")}};m.useEffect(()=>{b(),D(),c&&M(Number(c))},[b,D,c]),m.useEffect(()=>{if(T&&p.length>0){const r=p.find(s=>s.id===Number(T));r&&(N("customer_name",r.party_name),N("customer_contact",r.phone||""),N("customer_address",r.address||""))}},[T,p,N]),m.useEffect(()=>{l&&(async()=>{v(!0);try{const s=await q.get(S.task_cards.details(Number(l))),a=s.data?.task_card||s.data;E({...A,...a,task_card_no:a.task_card_number,branch_id:a.branch_id?Number(a.branch_id):0,supervisor_id:a.allocated_supervisor_id?String(a.allocated_supervisor_id):"",customer_id:a.customer_id?String(a.customer_id):"",customer_name:a.customer?.party_name||"",customer_contact:a.customer?.contact_number||"",customer_address:a.customer?.address||"",po_no:a.customer_po_number||"",challan_no:a.challan_number||"",invoice_no:a.invoice_number||"",machine_used:a.machine_required?String(a.machine_required):"",priority:a.priority||"Normal",job_date:a.task_date?a.task_date.split("T")[0]:"",expected_delivery_date:a.expected_delivery_date?a.expected_delivery_date.split("T")[0]:"",challan_date:a.challan_date?a.challan_date.split("T")[0]:"",note:a.note||""})}catch(s){console.error(s),j.error("Failed to load task order details")}finally{v(!1)}})()},[l,E]);const F=async r=>{x(!0);try{const s={task_date:r.job_date,job_name:r.job_name,created_by:U,department:r.department||"Production Department",customer_id:r.customer_id?Number(r.customer_id):null,branch_id:c?Number(c):null,job_description:r.job_description,job_type:r.job_type,priority:r.priority,quantity:Number(r.quantity),expected_delivery_date:r.expected_delivery_date,allocated_supervisor_id:r.supervisor_id?Number(r.supervisor_id):null,machine_required:r.machine_used?Number(r.machine_used):null,challan_number:r.challan_no,challan_date:r.challan_date,invoice_number:r.invoice_no,customer_po_number:r.po_no,remarks:r.remarks,note:r.note,images:[]};l?(await q.put(S.task_cards.update(Number(l)),s),j.success("Task Card updated successfully")):(await q.post(S.task_cards.create,s),j.success("Task Card created successfully")),f(O.TASK_CARD.LIST)}catch(s){console.error("Submission error:",s),j.error(s.response?.data?.message||"Failed to submit task card")}finally{x(!1)}};return y?e.jsx("div",{className:"flex justify-center items-center h-[500px]",children:e.jsx(J,{})}):e.jsx("div",{className:"w-full h-full p-2 sm:p-4 lg:p-6 overflow-y-auto pb-20",children:e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsx($,{title:l?"Edit Task Card":"Create Task Card",subtitle:l?"Update Task Order details":"Create a new Task Order"}),e.jsxs("form",{onSubmit:B(F),className:"space-y-4 sm:space-y-6 mt-4",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 sm:gap-4",children:[e.jsx(i,{name:"job_name",control:o,rules:{required:"task Name is required"},render:({field:r})=>e.jsx(u,{...r,label:"Task Name",required:!0,error:d.job_name?.message,placeholder:"e.g. Engine Overhaul"})}),l&&e.jsx(i,{name:"task_card_no",control:o,rules:{required:"Task Card No is required"},render:({field:r})=>e.jsx(u,{...r,label:"Task Card No.",required:!0,error:d.task_card_no?.message,placeholder:"TC-2023...",readOnly:!0})}),e.jsx(i,{name:"job_date",control:o,rules:{required:"Date is required"},render:({field:r})=>e.jsx(u,{...r,type:"date",label:"Date",required:!0,error:d.job_date?.message})}),e.jsx(i,{name:"department",control:o,rules:{required:"Department is required"},render:({field:r})=>e.jsx(u,{...r,type:"department",label:"Department",required:!0,error:d.department?.message})})]}),e.jsx("div",{className:"w-full",children:e.jsx(i,{name:"job_description",control:o,rules:{required:"Job Description is required"},render:({field:r})=>e.jsx(w,{...r,label:"Task Description",placeholder:"Describe the task details...",rows:3,required:!0,error:d.job_description?.message})})}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 sm:gap-4",children:[e.jsx(i,{name:"quantity",control:o,rules:{required:"Quantity is required",min:1},render:({field:r})=>e.jsx(u,{...r,type:"number",label:"Quantity",required:!0,error:d.quantity?.message,placeholder:"Enter quantity"})}),e.jsx(i,{name:"expected_delivery_date",control:o,rules:{required:"Expected Delivery is required"},render:({field:r})=>e.jsx(u,{...r,type:"date",label:"Expected Delivery",required:!0,error:d.expected_delivery_date?.message})}),e.jsx(i,{name:"job_type",control:o,rules:{required:"Task Type is required"},render:({field:r})=>e.jsxs(k,{...r,label:"Task Type",required:!0,error:d.job_type?.message,children:[e.jsx("option",{value:"",children:"Select task type"}),e.jsx("option",{value:"amc",children:"AMC"}),e.jsx("option",{value:"new_job",children:"New Task"}),e.jsx("option",{value:"in_house_manufacturing",children:"In house"}),e.jsx("option",{value:"repair",children:"Repair"}),e.jsx("option",{value:"service",children:"Service"})]})}),e.jsx(i,{name:"priority",control:o,rules:{required:"Priority is required"},render:({field:r})=>e.jsxs(k,{...r,label:"Priority",required:!0,error:d.priority?.message,children:[e.jsx("option",{value:"",children:"Select priority"}),e.jsx("option",{value:"Urgent",children:"High"}),e.jsx("option",{value:"Emergency",children:"Medium"}),e.jsx("option",{value:"Normal",children:"Low"})]})})]}),e.jsx("h3",{className:"text-base sm:text-lg font-semibold text-gray-800 border-b pb-1 mt-4 sm:mt-6",children:"Customer Information"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4",children:[e.jsx(i,{name:"customer_id",control:o,rules:{required:"Customer is required"},render:({field:r})=>e.jsxs(k,{...r,label:"Customer Name",required:!0,error:d.customer_id?.message,children:[e.jsx("option",{value:"",children:"Select Customer"}),p.filter(s=>s.party_type==="customer").map(s=>e.jsx("option",{value:s.id,children:s.party_name},s.id))]})}),e.jsx(i,{name:"customer_contact",control:o,render:({field:r})=>e.jsx(u,{...r,label:"Customer Contact",placeholder:"Auto-filled from customer",readOnly:!0,className:"bg-gray-100"})}),e.jsx(i,{name:"customer_address",control:o,render:({field:r})=>e.jsx(u,{...r,label:"Customer Address",placeholder:"Auto-filled from customer",readOnly:!0,className:"bg-gray-100"})})]}),e.jsx("h3",{className:"text-base sm:text-lg font-semibold text-gray-800 border-b pb-1 mt-4 sm:mt-6",children:"Assignment"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4",children:[e.jsx(i,{name:"supervisor_id",control:o,rules:{required:"Supervisor is required"},render:({field:r})=>e.jsxs(k,{...r,label:"Allocated Supervisor",required:!0,error:d.supervisor_id?.message,onChange:s=>{const a=s.target.value;r.onChange(a);const C=t?.find(H=>String(H.id)===String(a));C?N("supervisor_address",C.address||""):N("supervisor_address","")},children:[e.jsx("option",{value:"",children:"Select Supervisor"}),t?.map(s=>e.jsx("option",{value:s.id,children:s.full_name},s.id))]})}),e.jsx(re,{control:o,name:"branch_id",label:"Branch Name",required:!0,error:d.branch_id?.message}),e.jsx(i,{name:"machine_used",control:o,rules:{required:"Machine is required"},render:({field:r})=>e.jsxs(k,{...r,label:"Machine Used",required:!0,error:d.machine_used?.message,children:[e.jsx("option",{value:"",children:"Select Machine"}),h.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})})]}),e.jsx("h3",{className:"text-base sm:text-lg font-semibold text-gray-800 border-b pb-1 mt-4 sm:mt-6",children:"Internal Tracking"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 sm:gap-4",children:[e.jsx(i,{name:"challan_no",control:o,render:({field:r})=>e.jsx(u,{...r,label:"Challan No.",placeholder:"Enter challan number"})}),e.jsx(i,{name:"challan_date",control:o,render:({field:r})=>e.jsx(u,{...r,type:"date",label:"Challan Date"})}),e.jsx(i,{name:"invoice_no",control:o,render:({field:r})=>e.jsx(u,{...r,label:"Invoice No.",placeholder:"Enter invoice number"})}),e.jsx(i,{name:"po_no",control:o,render:({field:r})=>e.jsx(u,{...r,label:"PO No.",placeholder:"Enter PO number"})})]}),e.jsx("div",{className:"w-full",children:e.jsx(i,{name:"remarks",control:o,render:({field:r})=>e.jsx(w,{...r,label:"Remarks",placeholder:"Add any additional notes or remarks...",rows:3})})}),e.jsx("div",{className:"w-full",children:e.jsx(i,{name:"note",control:o,render:({field:r})=>e.jsx(w,{...r,label:"Note",placeholder:"Add any additional notes or comments...",error:d.note?.message,rows:3})})}),e.jsx("div",{className:"w-full",children:e.jsx(i,{name:"images",control:o,render:({field:r})=>e.jsx(se,{value:r.value,onChange:r.onChange,error:d.images?.message,maxFiles:6})})}),e.jsxs("div",{className:"flex flex-col sm:flex-row justify-end gap-3 pt-4 sm:pt-6",children:[e.jsx(P,{variant:"outline",type:"button",className:"w-full sm:w-auto order-2 sm:order-1",onClick:()=>f(O.TASK_CARD.LIST),children:"Cancel"}),e.jsx(P,{type:"submit",loading:_,className:"bg-blue-600 text-white w-full sm:w-auto order-1 sm:order-2",children:l?"Update Task Card":"Save Task Card"})]})]})]})})};export{ge as default};
