import{r as g,a as z,j as e,y as S,e as _,h as C,u as Y,f as W,D as O,P as M,A as q}from"./index-7oOzxGwh.js";import{L as U}from"./ListWrapper-CELDsN7L.js";import{T as h}from"./TableData-CqU7GtnY.js";import{T as F,a as $}from"./TableWrapper-C1yc4sRV.js";import{T as G}from"./TableRow-CWVikOhI.js";import{u as J}from"./usePagination-frhTRjip.js";import{T as Q}from"./TableActions-BrNU5APO.js";import{T as K}from"./TableEdit-C-qnOahi.js";import{T as Z}from"./TableDelete-D2N442VG.js";import{M as o}from"./enum-SoLNwffs.js";import{R as V}from"./ReasonModal-DI3d34yM.js";import{c as X}from"./rolePermissions-BvMMyxfj.js";import{T as ee,a as te}from"./TableDownload-So_yaOEv.js";import{C as se}from"./CommonFilter-CgwCiar7.js";import{Document as ae,Page as le,StyleSheet as re,View as r,Image as ne,Text as a,pdf as ie}from"./react-pdf.browser-CxP9ZOZx.js";import"./index.esm-DVCxdrgQ.js";import"./TextInput-CNXJtGhb.js";const oe=({materialRequisition:s,onStatusUpdate:l})=>{const[D,m]=g.useState(!1),[f,p]=g.useState(!1),[P,R]=g.useState(!1),[x,b]=g.useState(null),{user:B}=z(),v=async(i,y)=>{m(!0);try{let d="",n={};if((i===o.REJECTED_BY_DEPT_HEAD||i===o.CANCELLED_BY_STORE)&&!y){S.error("Reason is required");return}switch(i){case o.PENDING_DEPT_APPROVAL:d=_.material_requisition.submit(s.id),await C.post(d);break;case o.APPROVED_BY_DEPT_HEAD:d=_.material_requisition.approveDept(s.id),await C.post(d,{action:"approve"});break;case o.REJECTED_BY_DEPT_HEAD:d=_.material_requisition.reject(s.id),n={action:"reject",cancellation_reason:y||"No reason provided"},await C.post(d,n);break;case o.APPROVED_BY_STORE:d=_.material_requisition.approveStore(s.id),await C.post(d);break;case o.CANCELLED_BY_STORE:d=_.material_requisition.cancel(s.id),n={action:"cancel",cancellation_reason:y||"No reason provided"},await C.post(d,n);break;case o.COMPLETED:S.success("Material Requisition marked as Completed");break;default:throw new Error("Invalid status change")}S.success("Status updated successfully"),l()}catch(d){console.error("Failed to update status:",d),S.error(d.response?.data?.message||"Failed to update status")}finally{m(!1)}},c=(()=>{const i=s.status,y=B?.role?.role_name||"";switch(i){case o.PENDING_DEPT_APPROVAL:return X(y)?[{value:o.APPROVED_BY_DEPT_HEAD,label:"Approve"},{value:o.REJECTED_BY_DEPT_HEAD,label:"Reject"}]:[];case o.APPROVED_BY_DEPT_HEAD:if(y==="Store Manager")return[{value:o.APPROVED_BY_STORE,label:"Approve"},{value:o.CANCELLED_BY_STORE,label:"Cancel"}];break;default:return[]}return[]})(),L=i=>{i===o.REJECTED_BY_DEPT_HEAD?(b({status:i,actionType:"reject"}),p(!0)):i===o.CANCELLED_BY_STORE?(b({status:i,actionType:"cancel"}),p(!0)):v(i)},w=i=>{x&&(v(x.status,i),b(null)),p(!1)},I=()=>{b(null),p(!1)};return c.length===0?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs px-2 py-1 bg-gray-100 text-gray-700 rounded border",children:s.status}),(s.status===o.CANCELLED_BY_STORE||s.status===o.REJECTED_BY_DEPT_HEAD)&&s.cancellation_reason&&e.jsx("button",{onClick:()=>R(!0),className:"text-xs px-2 py-1 bg-red-100 text-red-700 rounded border border-red-200 hover:bg-red-200 transition-colors",title:"View reason",children:"View Reason"})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex items-center gap-2",children:D?e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"}),e.jsx("span",{className:"text-xs text-gray-500",children:"Updating..."})]}):e.jsxs(e.Fragment,{children:[e.jsxs("select",{className:"text-xs border border-gray-300 rounded px-2 py-1 focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white min-w-[120px]",value:"",onChange:i=>{i.target.value&&(L(i.target.value),i.target.value="")},children:[e.jsx("option",{value:"",children:s.status}),c.map(i=>e.jsx("option",{value:i.value,children:i.label},i.value))]}),(s.status===o.CANCELLED_BY_STORE||s.status===o.REJECTED_BY_DEPT_HEAD)&&s.cancellation_reason&&e.jsx("button",{onClick:()=>R(!0),className:"text-xs px-2 py-1 bg-red-100 text-red-700 rounded border border-red-200 hover:bg-red-200 transition-colors",title:"View reason",children:"View Reason"})]})}),e.jsx(V,{open:P,onClose:()=>R(!1),title:s.status===o.CANCELLED_BY_STORE?"Cancellation Reason":"Rejection Reason",message:s.cancellation_reason||"No reason provided",readonly:!0}),e.jsx(V,{open:f,onClose:I,onSubmit:w,title:x?.actionType==="reject"?"Rejection Reason":"Cancellation Reason",message:x?.actionType==="reject"?"Please provide a reason for rejecting this material request:":"Please provide a reason for cancelling this material request:"})]})},H=s=>s?new Date(s).toLocaleDateString("en-IN",{day:"2-digit",month:"2-digit",year:"numeric"}):"-",de=s=>s?typeof s=="string"?s:s.branch_name||s.name||"-":"-",ce=s=>s?typeof s=="string"?s:s.branch_name||s.name||"-":"-",me=s=>s?typeof s=="string"?s:s.name||"-":"-",ue=s=>({...s,department:de(s.department),machine_use:me(s.machine_use),site_use:ce(s.site_use)}),xe=({mr:s})=>{const l=ue(s),D=l.items||[];return e.jsx(ae,{children:e.jsxs(le,{size:"A4",style:t.page,children:[e.jsxs(r,{style:t.headerContainer,children:[e.jsx(r,{style:t.logoSection,children:e.jsx(ne,{src:"/assets/images/logo.png",style:t.logo})}),e.jsxs(r,{style:t.companyInfo,children:[e.jsx(a,{style:t.companyName,children:"UNITED ENGINEERING WORKS"}),e.jsx(a,{style:t.companyAddress,children:"N.H. 8, Nehla Village, By Pass Road, Near Govardhan Vilas, Udaipur- 313001 (Raj.) INDIA"}),e.jsx(a,{style:t.companyContact,children:"Phone: +91-9829232445 +91-9829657145 | GSTIN: 08ABQPK8948J3ZP | Email: info@unitedengineeringworks.com"})]})]}),e.jsx(a,{style:t.title,children:"MATERIAL REQUISITION"}),e.jsxs(r,{style:t.infoContainer,children:[e.jsxs(r,{style:t.detailsBox,children:[e.jsxs(r,{style:t.detailRow,children:[e.jsx(a,{style:t.label,children:"MR Number:"}),e.jsx(a,{style:t.value,children:l.mr_number||"-"})]}),e.jsxs(r,{style:t.detailRow,children:[e.jsx(a,{style:t.label,children:"Department:"}),e.jsx(a,{style:t.value,children:l.department||"-"})]}),e.jsxs(r,{style:t.detailRow,children:[e.jsx(a,{style:t.label,children:"Required Date:"}),e.jsx(a,{style:t.value,children:H(l.required_by_date)})]}),e.jsxs(r,{style:t.detailRow,children:[e.jsx(a,{style:t.label,children:"Priority:"}),e.jsx(a,{style:t.value,children:l.priority||"-"})]})]}),e.jsxs(r,{style:t.detailsBox,children:[e.jsxs(r,{style:t.detailRow,children:[e.jsx(a,{style:t.label,children:"Requested By:"}),e.jsx(a,{style:t.value,children:l.requested_by?.full_name||"-"})]}),e.jsxs(r,{style:t.detailRow,children:[e.jsx(a,{style:t.label,children:"Employee Code:"}),e.jsx(a,{style:t.value,children:l.requested_by?.employee_code||"-"})]}),e.jsxs(r,{style:t.detailRow,children:[e.jsx(a,{style:t.label,children:"Inspection:"}),e.jsx(a,{style:t.value,children:l.inspection?"Yes":"No"})]}),e.jsxs(r,{style:t.detailRow,children:[e.jsx(a,{style:t.label,children:"Created Date:"}),e.jsx(a,{style:t.value,children:H(l.created_at)})]})]})]}),(l.purpose||l.remarks)&&e.jsxs(r,{style:t.remarksSection,children:[e.jsx(a,{style:t.remarksLabel,children:"Purpose / Remarks:"}),e.jsx(a,{style:t.remarksText,children:l.purpose||l.remarks||"-"})]}),e.jsxs(r,{style:t.tableContainer,children:[e.jsxs(r,{style:t.tableHeaderRow,children:[e.jsx(r,{style:[t.tableCell,t.snoCol,t.headerCell],children:e.jsx(a,{style:t.headerText,children:"S.No"})}),e.jsx(r,{style:[t.tableCell,t.itemNameCol,t.headerCell],children:e.jsx(a,{style:t.headerText,children:"Item Description"})}),e.jsx(r,{style:[t.tableCell,t.itemCodeCol,t.headerCell],children:e.jsx(a,{style:t.headerText,children:"Item Code"})}),e.jsx(r,{style:[t.tableCell,t.unitCol,t.headerCell],children:e.jsx(a,{style:t.headerText,children:"Unit"})}),e.jsx(r,{style:[t.tableCell,t.qtyCol,t.headerCell],children:e.jsx(a,{style:t.headerText,children:"Qty"})}),e.jsx(r,{style:[t.tableCell,t.stockCol,t.headerCell],children:e.jsx(a,{style:t.headerText,children:"Stock in Store"})}),e.jsx(r,{style:[t.tableCell,t.remarksCol,t.headerCell],children:e.jsx(a,{style:t.headerText,children:"Remarks"})})]}),D.map((m,f)=>e.jsxs(r,{style:t.tableRow,children:[e.jsx(r,{style:[t.tableCell,t.snoCol],children:e.jsx(a,{style:t.cellText,children:f+1})}),e.jsx(r,{style:[t.tableCell,t.itemNameCol],children:e.jsx(a,{style:t.cellText,children:m.item?.item_name||"-"})}),e.jsx(r,{style:[t.tableCell,t.itemCodeCol],children:e.jsx(a,{style:t.cellText,children:m.item?.item_code||"-"})}),e.jsx(r,{style:[t.tableCell,t.unitCol],children:e.jsx(a,{style:t.cellText,children:m.item?.unit?.unit_name||"-"})}),e.jsx(r,{style:[t.tableCell,t.qtyCol],children:e.jsx(a,{style:t.cellText,children:m.quantity_required||0})}),e.jsx(r,{style:[t.tableCell,t.stockCol],children:e.jsx(a,{style:t.cellText,children:m.item?.current_stock??"-"})}),e.jsx(r,{style:[t.tableCell,t.remarksCol],children:e.jsx(a,{style:t.cellText,children:m.remarks||"-"})})]},f))]}),(l.project_use||l.machine_use||l.site_use||l.general_use)&&e.jsxs(r,{style:t.usageSection,children:[e.jsx(a,{style:t.usageTitle,children:"Usage Details:"}),l.project_use&&e.jsxs(a,{style:t.usageText,children:["Project Use: ",l.project_use,l.project_note&&` - ${l.project_note}`]}),l.machine_use&&e.jsxs(a,{style:t.usageText,children:["Machine Use: ",l.machine_use,l.machine_note&&` - ${l.machine_note}`]}),l.site_use&&e.jsxs(a,{style:t.usageText,children:["Site Use: ",l.site_use,l.site_note&&` - ${l.site_note}`]}),l.general_use&&e.jsxs(a,{style:t.usageText,children:["General Use: ",l.general_use,l.general_note&&` - ${l.general_note}`]})]}),e.jsxs(r,{style:t.signatureContainer,children:[e.jsxs(r,{style:t.signatureBox,children:[e.jsx(a,{style:t.signatureTitle,children:"Prepared By"}),e.jsx(r,{style:t.signatureLine}),e.jsx(a,{style:t.signatureText,children:"Signature"})]}),e.jsxs(r,{style:t.signatureBox,children:[e.jsx(a,{style:t.signatureTitle,children:"Approved By"}),e.jsx(r,{style:t.signatureLine}),e.jsx(a,{style:t.signatureText,children:"Dept. Head"})]}),e.jsxs(r,{style:t.signatureBox,children:[e.jsx(a,{style:t.signatureTitle,children:"To Purchase Dept."}),e.jsx(r,{style:t.signatureLine}),e.jsx(a,{style:t.signatureText,children:"Signature"})]})]})]})})},t=re.create({page:{padding:20,fontSize:10,fontFamily:"Helvetica",lineHeight:1.3},headerContainer:{flexDirection:"row",alignItems:"center",marginBottom:15,paddingBottom:10,borderBottomWidth:2,borderBottomColor:"#000",gap:20},logoSection:{width:"20%",marginRight:20},logo:{width:90,height:50},companyInfo:{width:"80%",alignItems:"flex-start",paddingLeft:20},companyName:{fontSize:16,fontWeight:"bold",marginBottom:3},companyAddress:{fontSize:10,marginBottom:2},companyContact:{fontSize:10},title:{fontSize:18,textAlign:"center",marginBottom:15,fontWeight:"bold",textDecoration:"underline"},infoContainer:{flexDirection:"row",marginBottom:15,justifyContent:"space-between"},detailsBox:{width:"48%",padding:8},detailRow:{flexDirection:"row",marginBottom:3},label:{width:"40%",fontSize:9,fontWeight:"bold"},value:{width:"60%",fontSize:9},remarksSection:{marginBottom:10,padding:8,backgroundColor:"#f9f9f9",borderWidth:.5,borderColor:"#ccc"},remarksLabel:{fontSize:9,fontWeight:"bold",marginBottom:3},remarksText:{fontSize:9},tableContainer:{marginBottom:15,borderWidth:.25,borderColor:"#000"},tableHeaderRow:{flexDirection:"row",backgroundColor:"#e0e0e0"},tableRow:{flexDirection:"row"},tableCell:{padding:2,borderWidth:.25,borderColor:"#000",justifyContent:"center",alignItems:"center"},headerCell:{backgroundColor:"#f0f0f0"},headerText:{fontSize:9,fontWeight:"bold",textAlign:"center"},cellText:{fontSize:8,textAlign:"center"},snoCol:{width:"8%"},itemNameCol:{width:"25%"},itemCodeCol:{width:"15%"},unitCol:{width:"10%"},qtyCol:{width:"10%"},stockCol:{width:"12%"},remarksCol:{width:"20%"},usageSection:{marginBottom:15,padding:8},usageTitle:{fontSize:9,fontWeight:"bold",marginBottom:5,textDecoration:"underline"},usageText:{fontSize:9,marginBottom:2},signatureContainer:{marginTop:40,flexDirection:"row",justifyContent:"space-between"},signatureBox:{width:"30%",alignItems:"center"},signatureTitle:{fontSize:9,fontWeight:"bold",marginBottom:30},signatureLine:{width:120,height:1,backgroundColor:"#000",marginBottom:5},signatureText:{fontSize:8}}),Se=()=>{const{page:s,rowsPerPage:l,setTotal:D,renderPagination:m}=J(),f=Y(),{selectedBranchId:p,user:P}=z(),{setMaterialRequisitions:R}=W(),[x]=g.useState(""),[b,B]=g.useState([]),[v,k]=g.useState(!0),[c,L]=g.useState({date_from:"",date_to:"",item_name:"",mr_number:""}),w=async()=>{k(!0);try{const n={page:s+1,per_page:l,...p&&{branch_id:p}};c.date_from&&(n.date_from=c.date_from),c.date_to&&(n.date_to=c.date_to),c.item_name&&(n.item_name=c.item_name),c.mr_number&&(n.mr_number=c.mr_number);const u=await C.get(_.material_requisition.items,{params:n}),E=u.data?.material_requisitions||[],A=u.data?.pagination;B(E),A?.last_page!==void 0&&D(A.last_page);const T=P?.role?.role_name;let j=0;T==="Department Head"?j=E.filter(N=>N.status==="Pending Approval (Dept Head)").length:T==="Store Manager"?j=E.filter(N=>N.status==="Approved - With Head").length:T==="Super Admin"&&(j=E.filter(N=>N.status==="Approved - With Store").length),R(j)}catch(n){console.error("Error fetching material requests:",n)}finally{k(!1)}};g.useEffect(()=>{w()},[s,l,p,c]);const I=[{name:"mr_number",label:"MR Number",type:"text",placeholder:"Enter MR Number"},{name:"item_name",label:"Item Name",type:"text",placeholder:"Enter Item Name"},{name:"date_from",label:"Date From",type:"date"},{name:"date_to",label:"Date To",type:"date"}],i=n=>{L(n)},y=async n=>{try{const u=await C.get(_.material_requisition.details(n.id)),E=u.data.data?.material_requisition||u.data.material_requisition||u.data,A=await ie(e.jsx(xe,{mr:E})).toBlob(),T=URL.createObjectURL(A),j=document.createElement("a");j.href=T,j.download=`${n.mr_number}.pdf`,j.click(),URL.revokeObjectURL(T)}catch(u){console.error("Error downloading MR PDF:",u)}},d=x?b.filter(n=>n.status===x):b;return e.jsx("div",{className:"space-y-6",children:e.jsxs(U,{title:`Material Requests (${d.length})`,createOnClick:M.hasPermission("material_requisition_create")?()=>f(q.MATERIAL_REQUEST.CREATE):void 0,children:[e.jsx(se,{fields:I,onFilter:i,defaultValues:c}),e.jsxs(F,{children:[e.jsx($,{cols:[{title:"MR Number"},{title:"Department"},{title:"Priority"},{title:"Requested By"},{title:"Required By"},{title:"Status"},{title:"Created At"},{title:"Actions"}]}),e.jsx("tbody",{children:v&&d.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:10,className:"px-6 py-12 text-center",children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("svg",{className:"w-12 h-12 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),e.jsx("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"No material requests"}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:x?`No requests found with status "${x}"`:"Get started by creating a new material request."})]})})}):d.map((n,u)=>e.jsxs(G,{children:[e.jsx(h,{className:"px-5",children:s*l+u+1}),e.jsx(h,{className:"w-40",children:e.jsx("div",{className:"flex items-center",children:e.jsx("div",{className:"text-sm font-medium text-gray-900",children:n.mr_number})})}),e.jsx(h,{className:"w-36",children:e.jsx("div",{className:"text-sm text-gray-900",children:n.department})}),e.jsx(h,{className:"w-28",children:e.jsx("span",{className:"inline-flex items-center justify-center px-2 py-1 text-xs font-medium bg-gray-100 text-gray-800 rounded-full",children:n.priority})}),e.jsx(h,{className:"w-48",children:e.jsx("div",{className:"flex items-center",children:e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:n.requested_by?.full_name||"â€”"}),e.jsx("div",{className:"text-sm text-gray-500",children:n.requested_by?.employee_code||""})]})})}),e.jsx(h,{className:"w-32",children:e.jsx("div",{className:"text-sm text-gray-900",children:O.date(n.required_by_date)})}),e.jsx(h,{className:"w-40",children:e.jsx(oe,{materialRequisition:{id:n.id,status:n.status,mr_number:n.mr_number},onStatusUpdate:w})}),e.jsx(h,{className:"w-32",children:e.jsx("div",{className:"text-sm text-gray-500",children:O.date(n.created_at)})}),e.jsx(h,{className:"w-52",children:e.jsxs(Q,{children:[e.jsx(ee,{url:`${q.MATERIAL_REQUEST.DETAILS.replace(":id","")}${n.id}`,tooltip:"View Material Request Details"}),M.hasPermission("material_requisition_update")&&e.jsx(K,{onClick:()=>f(`${q.MATERIAL_REQUEST.CREATE}?id=${n.id}`)}),e.jsx(te,{title:"Download MR PDF",onClick:()=>y(n)}),M.hasPermission("material_requisition_delete")&&e.jsx(Z,{refetch:w,endpoint:_.material_requisition.delete(n.id)})]})})]},n.id))})]}),d.length>0&&m()]})})};export{Se as default};
