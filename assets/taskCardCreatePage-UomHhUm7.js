import{r as u,j as e,h as b,e as j,u as U,i as R,a as H,B as P,A as I,y as g}from"./index-Cljs0C-M.js";import{C as o,u as K}from"./index.esm-C6x9iadA.js";import{T as l}from"./TextInput-Dv2lrd0E.js";import{T as w}from"./TextArea-DHZKG9IS.js";import{S as h}from"./Select-B2d3MOwo.js";import{F as Q}from"./FormHeader-CV1fDnjN.js";import{L as V}from"./Loading-B5F64OcS.js";import{I as J}from"./ImageUpload-TrlrKpNC.js";import{u as W}from"./useMachineStore-Ru766iJ6.js";import{o as z,y as G}from"./yup-gmZ66V0a.js";import{u as X}from"./usePartyStore-jLXlDpmD.js";const Y=({control:y,name:q,label:n="Branch",required:c=!1,error:S,disabled:v=!1})=>{const[k,f]=u.useState([]),[m,x]=u.useState(!1);return u.useEffect(()=>{(async()=>{x(!0);try{const C=(await b.get(j.branches.branch)).data?.branches||[];f(C)}catch(d){console.error("BranchSelect: Error fetching branches:",d)}finally{x(!1)}})()},[]),e.jsx(o,{name:q,control:y,render:({field:p})=>e.jsxs(h,{...p,label:n,required:c,error:S,disabled:v||m,onChange:d=>p.onChange(Number(d.target.value)),children:[e.jsx("option",{value:"",children:m?"Loading branches...":"Select Branch"}),k.map(d=>e.jsx("option",{value:d.id,children:d.branch_name},d.id))]})})},de=()=>{const y=U(),[q]=R(),n=q.get("editId"),{selectedBranchId:c}=H(),[S,v]=u.useState(!1),[k,f]=u.useState(!1),{parties:m,fetchParties:x}=X(),[p,d]=u.useState(null),{machines:C,fetchMachines:D}=W(),A={job_name:"",task_card_no:"",job_date:new Date().toISOString().split("T")[0],department:"Production Department",job_description:"",quantity:1,expected_delivery_date:"",job_type:"",priority:"Normal",customer_id:"",customer_name:"",customer_contact:"",customer_address:"",supervisor_id:"",supervisor_address:"",branch_id:c?Number(c):0,machine_used:"",challan_no:"",challan_date:"",invoice_no:"",po_no:"",remarks:"",images:[],note:""},{control:t,handleSubmit:B,setValue:_,watch:F,reset:E,formState:{errors:i}}=K({defaultValues:A,resolver:z(G,{context:{isEdit:!!n}})}),T=F("customer_id"),O=async r=>{if(r)try{const a=(await b.get(j.user_management.all,{params:{branch_id:r}})).data.users.filter(N=>N.role.role_name==="Workshop Supervisor");d(a)}catch(s){console.log(s),g.error("Failed to fetch users")}};u.useEffect(()=>{x(),D(),c&&O(Number(c))},[x,D,c]),u.useEffect(()=>{if(T&&m.length>0){const r=m.find(s=>s.id===Number(T));r&&(_("customer_name",r.party_name),_("customer_contact",r.phone||""),_("customer_address",r.address||""))}},[T,m,_]),u.useEffect(()=>{n&&(async()=>{v(!0);try{const s=await b.get(j.task_cards.details(Number(n))),a=s.data?.task_card||s.data;E({...A,...a,task_card_no:a.task_card_number,branch_id:a.branch_id?Number(a.branch_id):0,supervisor_id:a.allocated_supervisor_id?String(a.allocated_supervisor_id):"",customer_id:a.customer_id?String(a.customer_id):"",customer_name:a.customer?.party_name||"",customer_contact:a.customer?.contact_number||"",customer_address:a.customer?.address||"",po_no:a.customer_po_number||"",challan_no:a.challan_number||"",invoice_no:a.invoice_number||"",machine_used:a.machine_required?String(a.machine_required):"",priority:a.priority||"Normal",job_date:a.task_date?a.task_date.split("T")[0]:"",expected_delivery_date:a.expected_delivery_date?a.expected_delivery_date.split("T")[0]:"",challan_date:a.challan_date?a.challan_date.split("T")[0]:"",note:a.note||""})}catch(s){console.error(s),g.error("Failed to load task order details")}finally{v(!1)}})()},[n,E]);const L=async r=>{console.log("Form submitted with data:",r),console.log("Form errors:",i),f(!0);try{const s={task_date:r.job_date,job_name:r.job_name,department:r.department||"Production Department",customer_id:r.customer_id?Number(r.customer_id):null,branch_id:c?Number(c):null,job_description:r.job_description,job_type:r.job_type,priority:r.priority,quantity:Number(r.quantity),expected_delivery_date:r.expected_delivery_date,allocated_supervisor_id:r.supervisor_id?Number(r.supervisor_id):null,machine_required:r.machine_used?Number(r.machine_used):null,challan_number:r.challan_no,challan_date:r.challan_date,invoice_number:r.invoice_no,customer_po_number:r.po_no,remarks:r.remarks,note:r.note,images:[]};console.log("Payload being sent:",s),n?(await b.put(j.task_cards.update(Number(n)),s),g.success("Task Card updated successfully")):(await b.post(j.task_cards.create,s),g.success("Task Card created successfully")),y(I.TASK_CARD.LIST)}catch(s){console.error("Submission error:",s),g.error(s.response?.data?.message||"Failed to submit task card")}finally{f(!1)}};return S?e.jsx("div",{className:"flex justify-center items-center h-[500px]",children:e.jsx(V,{})}):e.jsx("div",{className:"w-full h-full p-2 sm:p-4 lg:p-6 overflow-y-auto pb-20",children:e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsx(Q,{title:n?"Edit Task Card":"Create Task Card",subtitle:n?"Update Task Order details":"Create a new Task Order"}),e.jsxs("form",{onSubmit:B(L),className:"space-y-4 sm:space-y-6 mt-4",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 sm:gap-4",children:[e.jsx(o,{name:"job_name",control:t,rules:{required:"task Name is required"},render:({field:r})=>e.jsx(l,{...r,label:"Task Name",required:!0,error:i.job_name?.message,placeholder:"e.g. Engine Overhaul"})}),n&&e.jsx(o,{name:"task_card_no",control:t,rules:{required:"Task Card No is required"},render:({field:r})=>e.jsx(l,{...r,label:"Task Card No.",required:!0,error:i.task_card_no?.message,placeholder:"TC-2023...",readOnly:!0})}),e.jsx(o,{name:"job_date",control:t,rules:{required:"Date is required"},render:({field:r})=>e.jsx(l,{...r,type:"date",label:"Date",required:!0,error:i.job_date?.message})}),e.jsx(o,{name:"department",control:t,rules:{required:"Department is required"},render:({field:r})=>e.jsx(l,{...r,type:"department",label:"Department",required:!0,error:i.department?.message})})]}),e.jsx("div",{className:"w-full",children:e.jsx(o,{name:"job_description",control:t,rules:{required:"Job Description is required"},render:({field:r})=>e.jsx(w,{...r,label:"Task Description",placeholder:"Describe the task details...",rows:3,required:!0,error:i.job_description?.message})})}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 sm:gap-4",children:[e.jsx(o,{name:"quantity",control:t,rules:{required:"Quantity is required",min:1},render:({field:r})=>e.jsx(l,{...r,type:"number",label:"Quantity",required:!0,error:i.quantity?.message,placeholder:"Enter quantity"})}),e.jsx(o,{name:"expected_delivery_date",control:t,rules:{required:"Expected Delivery is required"},render:({field:r})=>e.jsx(l,{...r,type:"date",label:"Expected Delivery",required:!0,error:i.expected_delivery_date?.message})}),e.jsx(o,{name:"job_type",control:t,rules:{required:"Task Type is required"},render:({field:r})=>e.jsxs(h,{...r,label:"Task Type",required:!0,error:i.job_type?.message,children:[e.jsx("option",{value:"",children:"Select task type"}),e.jsx("option",{value:"amc",children:"AMC"}),e.jsx("option",{value:"new_job",children:"New Task"}),e.jsx("option",{value:"in_house_manufacturing",children:"In house"}),e.jsx("option",{value:"repair",children:"Repair"}),e.jsx("option",{value:"service",children:"Service"})]})}),e.jsx(o,{name:"priority",control:t,rules:{required:"Priority is required"},render:({field:r})=>e.jsxs(h,{...r,label:"Priority",required:!0,error:i.priority?.message,children:[e.jsx("option",{value:"",children:"Select priority"}),e.jsx("option",{value:"Urgent",children:"High"}),e.jsx("option",{value:"Emergency",children:"Medium"}),e.jsx("option",{value:"Normal",children:"Low"})]})})]}),e.jsx("h3",{className:"text-base sm:text-lg font-semibold text-gray-800 border-b pb-1 mt-4 sm:mt-6",children:"Customer Information"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4",children:[e.jsx(o,{name:"customer_id",control:t,rules:{required:"Customer is required"},render:({field:r})=>e.jsxs(h,{...r,label:"Customer Name",required:!0,error:i.customer_id?.message,children:[e.jsx("option",{value:"",children:"Select Customer"}),m.filter(s=>s.party_type==="customer").map(s=>e.jsx("option",{value:s.id,children:s.party_name},s.id))]})}),e.jsx(o,{name:"customer_contact",control:t,render:({field:r})=>e.jsx(l,{...r,label:"Customer Contact",placeholder:"Auto-filled from customer",readOnly:!0,className:"bg-gray-100"})}),e.jsx(o,{name:"customer_address",control:t,render:({field:r})=>e.jsx(l,{...r,label:"Customer Address",placeholder:"Auto-filled from customer",readOnly:!0,className:"bg-gray-100"})})]}),e.jsx("h3",{className:"text-base sm:text-lg font-semibold text-gray-800 border-b pb-1 mt-4 sm:mt-6",children:"Assignment"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4",children:[e.jsx(o,{name:"supervisor_id",control:t,rules:{required:"Supervisor is required"},render:({field:r})=>e.jsxs(h,{...r,label:"Allocated Supervisor",required:!0,error:i.supervisor_id?.message,onChange:s=>{const a=s.target.value;r.onChange(a);const N=p?.find(M=>String(M.id)===String(a));N?_("supervisor_address",N.address||""):_("supervisor_address","")},children:[e.jsx("option",{value:"",children:"Select Supervisor"}),p?.map(s=>e.jsx("option",{value:s.id,children:s.full_name},s.id))]})}),e.jsx(Y,{control:t,name:"branch_id",label:"Branch Name",required:!0,error:i.branch_id?.message}),e.jsx(o,{name:"machine_used",control:t,rules:{required:"Machine is required"},render:({field:r})=>e.jsxs(h,{...r,label:"Machine Used",required:!0,error:i.machine_used?.message,children:[e.jsx("option",{value:"",children:"Select Machine"}),C.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})})]}),e.jsx("h3",{className:"text-base sm:text-lg font-semibold text-gray-800 border-b pb-1 mt-4 sm:mt-6",children:"Internal Tracking"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 sm:gap-4",children:[e.jsx(o,{name:"challan_no",control:t,render:({field:r})=>e.jsx(l,{...r,label:"Challan No.",placeholder:"Enter challan number"})}),e.jsx(o,{name:"challan_date",control:t,render:({field:r})=>e.jsx(l,{...r,type:"date",label:"Challan Date"})}),e.jsx(o,{name:"invoice_no",control:t,render:({field:r})=>e.jsx(l,{...r,label:"Invoice No.",placeholder:"Enter invoice number"})}),e.jsx(o,{name:"po_no",control:t,render:({field:r})=>e.jsx(l,{...r,label:"PO No.",placeholder:"Enter PO number"})})]}),e.jsx("div",{className:"w-full",children:e.jsx(o,{name:"remarks",control:t,render:({field:r})=>e.jsx(w,{...r,label:"Remarks",placeholder:"Add any additional notes or remarks...",rows:3})})}),e.jsx("div",{className:"w-full",children:e.jsx(o,{name:"note",control:t,render:({field:r})=>e.jsx(w,{...r,label:"Note",placeholder:"Add any additional notes or comments...",error:i.note?.message,rows:3})})}),e.jsx("div",{className:"w-full",children:e.jsx(o,{name:"images",control:t,render:({field:r})=>e.jsx(J,{value:r.value,onChange:r.onChange,error:i.images?.message,maxFiles:6})})}),e.jsxs("div",{className:"flex flex-col sm:flex-row justify-end gap-3 pt-4 sm:pt-6",children:[e.jsx(P,{variant:"outline",type:"button",className:"w-full sm:w-auto order-2 sm:order-1",onClick:()=>y(I.TASK_CARD.LIST),children:"Cancel"}),e.jsx(P,{type:"submit",loading:k,className:"bg-blue-600 text-white w-full sm:w-auto order-1 sm:order-2",children:n?"Update Task Card":"Save Task Card"})]})]})]})})};export{de as default};
