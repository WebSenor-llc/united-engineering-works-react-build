import{r as x,j as e,a as D,M as i,y as w,e as p,h as _,u as T,k as S,D as P,P as A,A as R}from"./index-CbNhh14T.js";import{L as C}from"./ListWrapper-CtE9blfZ.js";import{T as q,a as k,b as u}from"./TableWrapper-tM3Cun3B.js";import{T as L}from"./TableRow-XjmxnSZP.js";import{u as M}from"./usePagination-DcXLmXSb.js";import{T as B,a as O}from"./TableDelete-BtQ4bCNH.js";import{T as H}from"./TableEdit-Bugrl_H8.js";import{S as Y}from"./StatusFilter-BkdONObd.js";const I=({open:l,onClose:g,onSubmit:f,title:b,message:N})=>{const[r,c]=x.useState(""),[o,m]=x.useState(!1),j=async d=>{if(d.preventDefault(),!!r.trim()){m(!0);try{await f(r.trim()),c("")}finally{m(!1)}}},y=()=>{c(""),g()};return l?e.jsx("div",{className:"fixed inset-0 z-50 overflow-y-auto",children:e.jsxs("div",{className:"flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0",children:[e.jsx("div",{className:"fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity",onClick:y}),e.jsx("div",{className:"inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full",children:e.jsxs("form",{onSubmit:j,children:[e.jsx("div",{className:"bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4",children:e.jsxs("div",{className:"sm:flex sm:items-start",children:[e.jsx("div",{className:"mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10",children:e.jsx("svg",{className:"h-6 w-6 text-red-600",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"})})}),e.jsxs("div",{className:"mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full",children:[e.jsx("h3",{className:"text-lg leading-6 font-medium text-gray-900 mb-2",children:b}),e.jsxs("div",{className:"mt-2",children:[e.jsx("p",{className:"text-sm text-gray-500 mb-4",children:N}),e.jsx("textarea",{value:r,onChange:d=>c(d.target.value),className:"w-full h-24 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500 resize-none",placeholder:"Enter your reason here...",required:!0,disabled:o})]})]})]})}),e.jsxs("div",{className:"bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse",children:[e.jsx("button",{type:"submit",disabled:!r.trim()||o,className:"w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm disabled:opacity-50 disabled:cursor-not-allowed",children:o?e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"Submitting..."]}):"Submit"}),e.jsx("button",{type:"button",onClick:y,disabled:o,className:"mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm disabled:opacity-50",children:"Cancel"})]})]})})]})}):null},U=({materialRequisition:l,onStatusUpdate:g})=>{const[f,b]=x.useState(!1),[N,r]=x.useState(!1),[c,o]=x.useState(null),{user:m}=D(),j=async(t,h)=>{b(!0);try{let a="",n={};switch(t){case i.PENDING_DEPT_APPROVAL:a=p.material_requisition.submit(l.id),await _.post(a);break;case i.APPROVED_BY_DEPT_HEAD:a=p.material_requisition.approveDept(l.id),await _.post(a,{action:"approve"});break;case i.REJECTED_BY_DEPT_HEAD:a=p.material_requisition.reject(l.id),n={action:"reject",reason:h||"No reason provided"},await _.post(a,n);break;case i.APPROVED_BY_STORE:a=p.material_requisition.approveStore(l.id),await _.post(a);break;case i.CANCELLED_BY_STORE:a=p.material_requisition.cancel(l.id),n={cancellation_reason:h||"No reason provided"},await _.post(a,n);break;case i.COMPLETED:w.success("Material Requisition marked as Completed");break;default:throw new Error("Invalid status change")}w.success("Status updated successfully"),g()}catch(a){console.error("Failed to update status:",a),w.error(a.response?.data?.message||"Failed to update status")}finally{b(!1)}},d=(()=>{const t=l.status,h=m?.role?.role_name,a=m?.role_id;console.log("Current Status:",t),console.log("User Role Name:",h),console.log("User Role ID:",a),console.log("Full User Object:",m);const n=!!m;switch(t){case i.PENDING_DEPT_APPROVAL:if(n)return[{value:i.APPROVED_BY_DEPT_HEAD,label:"Approve"},{value:i.REJECTED_BY_DEPT_HEAD,label:"Reject"}];break;case i.APPROVED_BY_DEPT_HEAD:if(n)return[{value:i.APPROVED_BY_STORE,label:"Approve"},{value:i.CANCELLED_BY_STORE,label:"Cancel"}];break;default:return[]}return[]})(),v=t=>{t===i.REJECTED_BY_DEPT_HEAD?(o({status:t,actionType:"reject"}),r(!0)):t===i.CANCELLED_BY_STORE?(o({status:t,actionType:"cancel"}),r(!0)):j(t)},s=t=>{c&&(j(c.status,t),o(null)),r(!1)},E=()=>{o(null),r(!1)};return d.length===0?e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("span",{className:"text-xs px-2 py-1 bg-gray-100 text-gray-700 rounded border",children:l.status})}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex items-center gap-2",children:f?e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"}),e.jsx("span",{className:"text-xs text-gray-500",children:"Updating..."})]}):e.jsxs("select",{className:"text-xs border border-gray-300 rounded px-2 py-1 focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white min-w-[120px]",value:"",onChange:t=>{t.target.value&&(v(t.target.value),t.target.value="")},children:[e.jsx("option",{value:"",children:l.status}),d.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))]})}),e.jsx(I,{open:N,onClose:E,onSubmit:s,title:c?.actionType==="reject"?"Rejection Reason":"Cancellation Reason",message:c?.actionType==="reject"?"Please provide a reason for rejecting this material request:":"Please provide a reason for cancelling this material request:"})]})},K=()=>{const{renderPagination:l}=M(),g=T(),{selectedBranchId:f,user:b}=D(),{setMaterialRequisitions:N}=S(),[r,c]=x.useState(""),[o,m]=x.useState([]),[j,y]=x.useState(!0),d=async()=>{y(!0);try{const s=f?`${p.material_requisition.items}&branch_id=${f}`:p.material_requisition.items,t=(await _.get(s)).data?.material_requisitions||[];m(t);const h=b?.role?.role_name;let a=0;h==="Department Head"?a=t.filter(n=>n.status==="Pending Approval (Dept Head)").length:h==="Store Manager"?a=t.filter(n=>n.status==="Approved - With Head").length:h==="Super Admin"&&(a=t.filter(n=>n.status==="Approved - With Store").length),N(a)}catch(s){console.error("Error fetching material requests:",s)}finally{y(!1)}};x.useEffect(()=>{d()},[f]);const v=r?o.filter(s=>s.status===r):o;return e.jsxs("div",{className:"space-y-6",children:[e.jsx(Y,{module:"materialRequisition",selectedStatus:r,onChange:s=>c(s)}),e.jsxs(C,{title:`Material Requests (${v.length})`,createOnClick:A.hasPermission("material_requisition_create")?()=>g(R.MATERIAL_REQUEST.CREATE):void 0,children:[e.jsxs(q,{children:[e.jsx(k,{cols:[{title:"MR Number"},{title:"Department"},{title:"Priority"},{title:"Requested By"},{title:"Required By"},{title:"Status"},{title:"Created At"},{title:"Actions"}]}),e.jsx("tbody",{children:j&&v.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:10,className:"px-6 py-12 text-center",children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("svg",{className:"w-12 h-12 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),e.jsx("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"No material requests"}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:r?`No requests found with status "${r}"`:"Get started by creating a new material request."})]})})}):v.map((s,E)=>e.jsxs(L,{children:[e.jsx(u,{className:"w-12 text-center font-medium",children:e.jsx("div",{className:"text-sm text-gray-900",children:E+1})}),e.jsx(u,{className:"w-40",children:e.jsx("div",{className:"flex items-center",children:e.jsx("div",{className:"text-sm font-medium text-gray-900",children:s.mr_number})})}),e.jsx(u,{className:"w-36",children:e.jsx("div",{className:"text-sm text-gray-900",children:s.department})}),e.jsx(u,{className:"w-28",children:e.jsx("span",{className:"inline-flex items-center justify-center px-2 py-1 text-xs font-medium bg-gray-100 text-gray-800 rounded-full",children:s.priority})}),e.jsx(u,{className:"w-48",children:e.jsx("div",{className:"flex items-center",children:e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:s.requested_by?.full_name||"â€”"}),e.jsx("div",{className:"text-sm text-gray-500",children:s.requested_by?.employee_code||""})]})})}),e.jsx(u,{className:"w-32",children:e.jsx("div",{className:"text-sm text-gray-900",children:P.date(s.required_by_date)})}),e.jsx(u,{className:"w-40",children:e.jsx(U,{materialRequisition:{id:s.id,status:s.status,mr_number:s.mr_number},onStatusUpdate:d})}),e.jsx(u,{className:"w-32",children:e.jsx("div",{className:"text-sm text-gray-500",children:P.date(s.created_at)})}),e.jsx(u,{className:"w-20",children:e.jsxs(B,{children:[A.hasPermission("material_requisition_update")&&e.jsx(H,{onClick:()=>g(`${R.MATERIAL_REQUEST.CREATE}?id=${s.id}`)}),A.hasPermission("material_requisition_delete")&&e.jsx(O,{refetch:d,endpoint:p.material_requisition.delete(s.id)})]})})]},s.id))})]}),v.length>0&&l()]})]})};export{K as default};
