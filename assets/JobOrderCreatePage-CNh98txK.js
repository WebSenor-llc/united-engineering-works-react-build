import{r as j,j as e,af as G,ag as K,ah as Q,ai as Y,aj as X,ak as Z,y as w,u as ee,i as se,a as ae,B as U,A as z,h as C,e as D}from"./index-Dpd7qybE.js";import{L as re}from"./Loading-rkjgGfkz.js";import{F as te}from"./FormHeader-CgKyjGwi.js";import{T as ne,a as oe,b as T}from"./TableWrapper-DtKbbg8N.js";import{T as ie}from"./TableRow-DkGT6S5k.js";import{T as le,a as de}from"./TableDelete-DH9r8gXr.js";import{o as ce,v as me}from"./yup-DvkqHPEo.js";import{u as pe,b as ue,C as c}from"./index.esm-Csq66oCQ.js";import{u as xe}from"./useMachineStore-DppBCkfh.js";const he=({label:x="Upload Files",required:m=!1,maxFiles:d=10,value:i=[],onChange:g,error:b,acceptedTypes:y=["image/*","application/pdf","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"]})=>{const[I,v]=j.useState(!1),S=j.useRef(null),O=r=>{r.preventDefault(),v(!0)},k=r=>{r.preventDefault(),v(!1)},N=r=>{r.preventDefault(),v(!1);const n=Array.from(r.dataTransfer.files);$(n)},R=r=>{if(r.target.files){const n=Array.from(r.target.files);$(n)}},$=r=>{const n=r.filter(f=>{const M=f.type.startsWith("image/"),F=f.type==="application/pdf",B=f.type.includes("excel")||f.type.includes("spreadsheet");return M||F||B});n.length!==r.length&&w.error("Only images, PDF, and Excel files are allowed.");const t=Array.isArray(i)?i.filter(f=>f instanceof File):[],_=Array.isArray(i)?i.filter(f=>typeof f=="string"):[];if(t.length+n.length>d){w.error(`You can only upload up to ${d} files.`);return}g([..._,...t,...n])},q=r=>{const n=Array.isArray(i)?[...i]:[];n.splice(r,1),g(n)},P=()=>{S.current?.click()},E=r=>{let n="";if(r instanceof File)n=r.type;else if(typeof r=="string"){const t=r.toLowerCase().split(".").pop()||"";["jpg","jpeg","png","gif","webp"].includes(t)?n="image/":t==="pdf"?n="application/pdf":["xls","xlsx"].includes(t)&&(n="application/vnd.ms-excel")}return n.startsWith("image/")?e.jsx(Q,{className:"text-blue-500 text-2xl"}):n.includes("pdf")?e.jsx(Y,{className:"text-red-500 text-2xl"}):n.includes("excel")||n.includes("spreadsheet")?e.jsx(X,{className:"text-green-500 text-2xl"}):e.jsx(Z,{className:"text-gray-500 text-2xl"})},L=r=>{if(r===0)return"0 Bytes";const n=1024,t=["Bytes","KB","MB","GB"],_=Math.floor(Math.log(r)/Math.log(n));return parseFloat((r/Math.pow(n,_)).toFixed(2))+" "+t[_]},l=Array.isArray(i)?i.filter(r=>r instanceof File):[];return e.jsxs("div",{className:"w-full space-y-4",children:[x&&e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[x," ",m&&e.jsx("span",{className:"text-red-500",children:"*"})," (Max"," ",d,")"]}),l.length<d&&e.jsxs("div",{className:`border-2 border-dashed rounded-lg p-6 flex flex-col items-center justify-center cursor-pointer transition-colors ${I?"border-blue-500 bg-blue-50":"border-gray-300 hover:border-gray-400 bg-gray-50"}`,onDragOver:O,onDragLeave:k,onDrop:N,onClick:P,children:[e.jsx("input",{type:"file",ref:S,className:"hidden",accept:y.join(","),multiple:!0,onChange:R}),e.jsx(G,{className:"text-4xl text-gray-400 mb-2"}),e.jsx("p",{className:"text-sm text-gray-500 font-medium",children:"Drag & Drop Files"}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:"or select Images, PDF, Excel files from device"})]}),i&&i.length>0&&e.jsxs("div",{children:[e.jsxs("h4",{className:"text-sm font-medium text-gray-700 mb-2",children:["Files (",i.length,")"]}),e.jsx("div",{className:"space-y-2",children:i.map((r,n)=>{const t=r instanceof File,_=t?r.type.startsWith("image/"):r.toLowerCase().match(/\.(jpg|jpeg|png|gif|webp)$/);return e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[_?e.jsx("div",{className:"w-12 h-12 rounded overflow-hidden",children:e.jsx("img",{src:t?URL.createObjectURL(r):r,alt:t?r.name:"Existing image",className:"w-full h-full object-cover"})}):e.jsx("div",{className:"w-12 h-12 flex items-center justify-center",children:E(r)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 truncate",children:t?r.name:r.split("/").pop()}),t&&e.jsx("p",{className:"text-xs text-gray-500",children:L(r.size)}),!t&&e.jsx("p",{className:"text-xs text-gray-500",children:"Existing file"})]})]}),e.jsx("button",{type:"button",onClick:f=>{f.stopPropagation(),q(n)},className:"ml-3 bg-red-500 text-white rounded-full p-1 hover:bg-red-600 transition-colors",children:e.jsx(K,{size:12})})]},n)})})]}),b&&e.jsx("p",{className:"text-xs text-red-500 mt-1",children:b})]})},je=({id:x,title:m,loading:d,children:i,subtitle:g})=>d?e.jsx("div",{className:"flex justify-center items-center h-[500px]",children:e.jsx(re,{})}):e.jsx("div",{className:"w-full h-full p-2 sm:p-4 lg:p-6 overflow-y-auto pb-20",children:e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsx(te,{title:x?`Edit ${m}`:`Create ${m}`,subtitle:g||(x?`Update ${m} details`:`Create a new ${m}`)}),e.jsx("div",{className:"space-y-4 sm:space-y-6 mt-4",children:i})]})}),A=j.forwardRef(({label:x,error:m,required:d,children:i,className:g="",...b},y)=>e.jsxs("div",{className:"w-full",children:[x&&e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[x," ",d&&e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("select",{ref:y,className:`w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 ${m?"border-red-500":""} ${g}`,...b,children:i}),m&&e.jsx("p",{className:"text-xs text-red-500 mt-1",children:m})]}));A.displayName="Select";const J=j.forwardRef(({label:x,error:m,required:d,className:i="",...g},b)=>e.jsxs("div",{className:"w-full",children:[x&&e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[x," ",d&&e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("textarea",{ref:b,rows:3,className:`w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-vertical ${m?"border-red-500":""} ${i}`,...g}),m&&e.jsx("p",{className:"text-xs text-red-500 mt-1",children:m})]}));J.displayName="TextArea";const h=j.forwardRef(({label:x,error:m,required:d,autofoucs:i,className:g="",...b},y)=>e.jsxs("div",{className:"w-full",children:[x&&e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[x," ",d&&e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{ref:y,autoFocus:i,className:`w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 ${m?"border-red-500":""} ${g}`,...b}),m&&e.jsx("p",{className:"text-xs text-red-500 mt-1",children:m})]}));h.displayName="TextInput";const ge={job_name:"",job_card_no:"",job_date:new Date().toISOString().split("T")[0],department:"Production Department",job_description:"",quantity:1,expected_delivery_date:"",job_type:"",status:"pending",customer_id:"",customer_name:"",customer_contact:"",customer_address:"",operations:[{operation_name:"",supervisor_id:"",start_date:"",end_date:"",machine_id:""}],challan_no:"",challan_date:"",invoice_no:"",po_no:"",remarks:"",note:"",images:[]},Ce=()=>{const x=ee(),[m]=se(),d=m.get("editId"),{selectedBranchId:i}=ae(),[g,b]=j.useState(!1),[y,I]=j.useState(!1),[v,S]=j.useState([]),[O,k]=j.useState([]),[N,R]=j.useState([]),[$,q]=j.useState([]),{machines:P,fetchMachines:E}=xe(),{watch:L,control:l,setValue:r,handleSubmit:n,formState:{errors:t}}=pe({defaultValues:ge,mode:"onChange",resolver:ce(me)}),{fields:_,append:f,remove:M}=ue({control:l,name:"operations"}),F=L("customer_id"),B=async()=>{b(!0);try{const a=await C.get(D.job_order.details(Number(d))),s=a.data?.job_card||a.data;if(s){s.branch_id&&await W(Number(s.branch_id));const u=s.operations?.length>0?s.operations.map(p=>({operation_name:p.operation_name||"",supervisor_id:p.supervisor_id?String(p.supervisor_id):"",start_date:p.start_date?p.start_date.split("T")[0]:"",end_date:p.end_date?p.end_date.split("T")[0]:"",machine_id:p.machine_id?String(p.machine_id):""})):[{operation_name:"",supervisor_id:"",start_date:"",end_date:"",machine_id:""}],o=s.images?.map(p=>p.image_path)||[];r("job_name",s.job_name||""),r("job_card_no",s.job_card_number||""),r("job_date",s.job_date?s.job_date.split("T")[0]:""),r("department",s.department||"Production Department"),r("job_description",s.job_description||""),r("quantity",s.quantity||1),r("expected_delivery_date",s.expected_delivery_date?s.expected_delivery_date.split("T")[0]:""),r("job_type",s.job_type||""),r("status",s.status||"pending"),r("customer_id",s.customer_id?String(s.customer_id):""),r("customer_name",s.customer?.party_name||""),r("customer_contact",s.customer?.phone||""),r("customer_address",s.customer?.address||""),r("operations",u),r("challan_no",s.challan_number||""),r("challan_date",s.challan_date?s.challan_date.split("T")[0]:""),r("invoice_no",s.invoice_number||""),r("po_no",s.customer_po_number||""),r("remarks",s.remarks||""),r("note",s.note||""),S(o),k([])}}catch(a){console.log(a),w.error("Failed to load job order details")}finally{b(!1)}},W=async a=>{if(a)try{const u=(await C.get(D.user_management.all,{params:{branch_id:a}})).data.users.filter(o=>o.role.role_name==="Workshop Supervisor");q(u)}catch(s){console.log(s)}},H=async()=>{try{const a=await C.get(D.party_master.parties,{params:{per_page:1e3,party_type:"Customer"}});R(a.data?.parties||a.data?.data||[])}catch(a){console.error("Failed to fetch customers",a)}};j.useEffect(()=>{H(),E(),i&&W(Number(i)),d&&B()},[d,i,E]),j.useEffect(()=>{if(F&&N.length>0){const a=N.find(s=>s.id===Number(F));a&&(r("customer_name",a.party_name),r("customer_contact",a.phone||""),r("customer_address",a.address||""))}},[F,N,r]);const V=async a=>{I(!0);try{const s=new FormData;s.append("job_name",a.job_name),s.append("job_date",a.job_date),s.append("department",a.department),s.append("job_description",a.job_description||""),s.append("job_type",a.job_type),s.append("status",a.status),s.append("quantity",String(a.quantity)),s.append("expected_delivery_date",a.expected_delivery_date),s.append("customer_id",String(a.customer_id)),s.append("branch_id",String(i)),s.append("challan_no",a.challan_no||""),s.append("challan_date",a.challan_date||""),s.append("invoice_no",a.invoice_no||""),s.append("po_no",a.po_no||""),s.append("remarks",a.remarks||""),s.append("note",a.note||""),a.operations.filter(o=>o.operation_name||o.supervisor_id||o.machine_id).forEach((o,p)=>{s.append(`operations[${p}][operation_name]`,o.operation_name||""),s.append(`operations[${p}][supervisor_id]`,o.supervisor_id||""),s.append(`operations[${p}][start_date]`,o.start_date||""),s.append(`operations[${p}][end_date]`,o.end_date||""),s.append(`operations[${p}][machine_id]`,o.machine_id||"")}),O.forEach((o,p)=>{s.append(`images[${p}]`,o)}),s.append("existing_images",JSON.stringify(v));const u={headers:{"Content-Type":"multipart/form-data"}};d?(await C.put(D.job_order.update(Number(d)),s,u),w.success("Job Order updated successfully")):(await C.post(D.job_order.create,s,u),w.success("Job Order created successfully")),x(z.JOB_ORDER.LIST)}catch(s){console.error("Submit error:",s),w.error(s.response?.data?.message||"Failed to submit job order")}finally{I(!1)}};return e.jsx("form",{onSubmit:n(V),children:e.jsxs(je,{id:d,title:"Job Card",loading:g,children:[e.jsxs("div",{className:"grid gap-5 md:grid-cols-4",children:[e.jsx(c,{name:"job_name",control:l,render:({field:a})=>e.jsx(h,{required:!0,autofoucs:!0,...a,label:"Job Name",placeholder:"e.g. Engine Overhaul",error:t?.job_name?.message})}),d&&e.jsx(c,{name:"job_card_no",control:l,render:({field:a})=>e.jsx(h,{...a,label:"Job Card No.",placeholder:"JC-2023...",readOnly:!0,error:t?.job_card_no?.message})}),e.jsx(c,{name:"job_date",control:l,render:({field:a})=>e.jsx(h,{required:!0,...a,type:"date",label:"Job Date",error:t?.job_date?.message})}),e.jsx(c,{name:"department",control:l,render:({field:a})=>e.jsx(h,{required:!0,...a,label:"Department",error:t?.department?.message})})]}),e.jsx("div",{className:"mt-5",children:e.jsx(c,{name:"job_description",control:l,render:({field:a})=>e.jsx(J,{...a,label:"Job Description",placeholder:"Describe the job details...",error:t?.job_description?.message})})}),e.jsxs("div",{className:"mt-5 grid gap-5 md:grid-cols-3",children:[e.jsx(c,{name:"quantity",control:l,render:({field:a})=>e.jsx(h,{required:!0,...a,type:"number",label:"Quantity",placeholder:"Enter quantity",error:t?.quantity?.message})}),e.jsx(c,{name:"expected_delivery_date",control:l,render:({field:a})=>e.jsx(h,{required:!0,...a,type:"date",label:"Expected Delivery",readOnly:!!d,error:t?.expected_delivery_date?.message})}),e.jsx(c,{name:"job_type",control:l,render:({field:a})=>e.jsxs(A,{...a,required:!0,label:"Job Type",error:t?.job_type?.message,children:[e.jsx("option",{disabled:!0,value:"",children:"Select job type"}),e.jsx("option",{value:"amc",children:"AMC"}),e.jsx("option",{value:"new_job",children:"New Job"}),e.jsx("option",{value:"in_house_manufacturing",children:"In House"}),e.jsx("option",{value:"repair",children:"Repair"}),e.jsx("option",{value:"service",children:"Service"})]})})]}),e.jsxs("div",{className:"mt-5",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 border-b pb-2 mb-4",children:"Customer Information"}),e.jsxs("div",{className:"grid gap-5 md:grid-cols-3",children:[e.jsx(c,{name:"customer_id",control:l,render:({field:a})=>e.jsxs(A,{...a,required:!0,label:"Customer Name",error:t?.customer_id?.message,children:[e.jsx("option",{disabled:!0,value:"",children:"Select Customer"}),N.filter(s=>s.party_type==="customer").map(s=>e.jsx("option",{value:s.id,children:s.party_name},s.id))]})}),e.jsx(c,{name:"customer_contact",control:l,render:({field:a})=>e.jsx(h,{...a,label:"Customer Contact",placeholder:"Auto-filled from customer",readOnly:!0,className:"bg-gray-100"})}),e.jsx(c,{name:"customer_address",control:l,render:({field:a})=>e.jsx(h,{...a,label:"Customer Address",placeholder:"Auto-filled from customer",readOnly:!0,className:"bg-gray-100"})})]})]}),e.jsxs("div",{className:"mt-5",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:"Operations"}),e.jsx(U,{type:"button",className:"bg-blue-600 text-white",onClick:()=>f({operation_name:"",supervisor_id:"",start_date:"",end_date:"",machine_id:""}),children:"+ Add Operation"})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(ne,{children:[e.jsx(oe,{cols:[{title:"Operation Name"},{title:"Supervisor"},{title:"Start Date"},{title:"End Date"},{title:"Machine"},{title:"Actions"}]}),e.jsx("tbody",{children:_.map((a,s)=>e.jsxs(ie,{children:[e.jsx(T,{className:"min-w-[200px]",children:e.jsx(c,{name:`operations.${s}.operation_name`,control:l,render:({field:u})=>e.jsx(h,{...u,placeholder:"e.g. Cutting, Welding",error:t.operations?.[s]?.operation_name?.message})})}),e.jsx(T,{className:"min-w-[200px]",children:e.jsx(c,{name:`operations.${s}.supervisor_id`,control:l,render:({field:u})=>e.jsxs(A,{...u,error:t.operations?.[s]?.supervisor_id?.message,children:[e.jsx("option",{value:"",children:"Select Supervisor"}),$?.map(o=>e.jsx("option",{value:o.id,children:o.full_name},o.id))]})})}),e.jsx(T,{className:"min-w-[150px]",children:e.jsx(c,{name:`operations.${s}.start_date`,control:l,render:({field:u})=>e.jsx(h,{...u,type:"date",error:t.operations?.[s]?.start_date?.message})})}),e.jsx(T,{className:"min-w-[150px]",children:e.jsx(c,{name:`operations.${s}.end_date`,control:l,render:({field:u})=>e.jsx(h,{...u,type:"date",error:t.operations?.[s]?.end_date?.message})})}),e.jsx(T,{className:"min-w-[200px]",children:e.jsx(c,{name:`operations.${s}.machine_id`,control:l,render:({field:u})=>e.jsxs(A,{...u,error:t.operations?.[s]?.machine_id?.message,children:[e.jsx("option",{value:"",children:"Select Machine"}),P.map(o=>e.jsx("option",{value:o.id,children:o.name},o.id))]})})}),e.jsx(le,{children:_.length>1&&e.jsx(de,{onClick:()=>M(s)})})]},a.id))})]})})]}),e.jsxs("div",{className:"mt-5",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 border-b pb-2 mb-4",children:"Internal Tracking"}),e.jsxs("div",{className:"grid gap-5 md:grid-cols-4",children:[e.jsx(c,{name:"challan_no",control:l,render:({field:a})=>e.jsx(h,{...a,label:"Challan No.",placeholder:"Enter challan number",error:t?.challan_no?.message})}),e.jsx(c,{name:"challan_date",control:l,render:({field:a})=>e.jsx(h,{...a,type:"date",label:"Challan Date",error:t?.challan_date?.message})}),e.jsx(c,{name:"invoice_no",control:l,render:({field:a})=>e.jsx(h,{...a,label:"Invoice No.",placeholder:"Enter invoice number",error:t?.invoice_no?.message})}),e.jsx(c,{name:"po_no",control:l,render:({field:a})=>e.jsx(h,{...a,label:"PO No.",placeholder:"Enter PO number",error:t?.po_no?.message})})]})]}),e.jsxs("div",{className:"mt-5 grid gap-5 md:grid-cols-2",children:[e.jsx(c,{name:"remarks",control:l,render:({field:a})=>e.jsx(J,{...a,label:"Remarks",placeholder:"Add any additional notes or remarks...",error:t?.remarks?.message})}),e.jsx(c,{name:"note",control:l,render:({field:a})=>e.jsx(J,{...a,label:"Note",placeholder:"Add any additional notes or comments...",error:t?.note?.message})})]}),e.jsx("div",{className:"mt-5",children:e.jsx(he,{label:"Job Images and Documents",value:[...v,...O],maxFiles:10,error:t?.images?.message,onChange:a=>{const s=a.filter(o=>o instanceof File),u=a.filter(o=>typeof o=="string");k(s),S(u)}})}),e.jsxs("div",{className:"mt-8 flex flex-col sm:flex-row justify-end gap-3",children:[e.jsx(U,{type:"button",variant:"outline",className:"w-full sm:w-auto",onClick:()=>x(z.JOB_ORDER.LIST),children:"Cancel"}),e.jsx(U,{type:"submit",loading:y,disabled:y,className:"bg-blue-600 text-white w-full sm:w-auto",children:d?"Update Job Card":"Save Job Card"})]})]})})};export{Ce as default};
