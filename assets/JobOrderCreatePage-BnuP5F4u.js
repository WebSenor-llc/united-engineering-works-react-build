import{r as f,j as e,ak as ee,al as se,am as ae,an as re,ao as te,ap as ne,y as O,u as oe,i as le,a as G,B as H,A as K,h as A,e as I}from"./index-B2Kq7pF4.js";import{L as ie}from"./Loading-OOr2nQlv.js";import{F as de}from"./FormHeader-CQNygXHB.js";import{T as ce,a as me,b as S}from"./TableWrapper-jqHXbh_L.js";import{T as pe}from"./TableRow-BJlAj-zV.js";import{T as ue}from"./TableActions-v4FwT6Lt.js";import{T as xe}from"./TableDelete-DKVpIjq0.js";import{o as ge,w as he}from"./yup-CzgU9FQc.js";import{u as be,b as je,C as c}from"./index.esm-B19_P2AP.js";import{u as fe}from"./useMachineStore-BtQAFOMp.js";import{b as Q}from"./rolePermissions-B_cCEq_W.js";import"./BackButton-D6lHrR0A.js";const _e=({label:g="Upload Files",required:m=!1,maxFiles:d=10,value:l=[],onChange:_,error:y,acceptedTypes:w=["image/*","application/pdf","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"]})=>{const[$,F]=f.useState(!1),T=f.useRef(null),E=r=>{r.preventDefault(),F(!0)},R=r=>{r.preventDefault(),F(!1)},C=r=>{r.preventDefault(),F(!1);const t=Array.from(r.dataTransfer.files);J(t)},B=r=>{if(r.target.files){const t=Array.from(r.target.files);J(t)}},J=r=>{const t=r.filter(j=>{const v=j.type.startsWith("image/"),D=j.type==="application/pdf",z=j.type.includes("excel")||j.type.includes("spreadsheet");return v||D||z});t.length!==r.length&&O.error("Only images, PDF, and Excel files are allowed.");const h=Array.isArray(l)?l.filter(j=>j instanceof File):[],N=Array.isArray(l)?l.filter(j=>typeof j=="string"):[];if(h.length+t.length>d){O.error(`You can only upload up to ${d} files.`);return}_([...N,...h,...t])},M=r=>{const t=Array.isArray(l)?[...l]:[];t.splice(r,1),_(t)},U=()=>{T.current?.click()},q=r=>{let t="";if(r instanceof File)t=r.type;else if(typeof r=="string"){const h=r.toLowerCase().split(".").pop()||"";["jpg","jpeg","png","gif","webp"].includes(h)?t="image/":h==="pdf"?t="application/pdf":["xls","xlsx"].includes(h)&&(t="application/vnd.ms-excel")}return t.startsWith("image/")?e.jsx(ae,{className:"text-blue-500 text-2xl"}):t.includes("pdf")?e.jsx(re,{className:"text-red-500 text-2xl"}):t.includes("excel")||t.includes("spreadsheet")?e.jsx(te,{className:"text-green-500 text-2xl"}):e.jsx(ne,{className:"text-gray-500 text-2xl"})},W=r=>{if(r===0)return"0 Bytes";const t=1024,h=["Bytes","KB","MB","GB"],N=Math.floor(Math.log(r)/Math.log(t));return parseFloat((r/Math.pow(t,N)).toFixed(2))+" "+h[N]},i=Array.isArray(l)?l.filter(r=>r instanceof File):[],o="https://united.peclick.co.in",L=r=>r?r.startsWith("http")?r:`${o}/${r}`:"";return e.jsxs("div",{className:"w-full space-y-4",children:[g&&e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[g," ",m&&e.jsx("span",{className:"text-red-500",children:"*"})," (Max"," ",d,")"]}),i.length<d&&e.jsxs("div",{className:`border-2 border-dashed rounded-lg p-6 flex flex-col items-center justify-center cursor-pointer transition-colors ${$?"border-blue-500 bg-blue-50":"border-gray-300 hover:border-gray-400 bg-gray-50"}`,onDragOver:E,onDragLeave:R,onDrop:C,onClick:U,children:[e.jsx("input",{type:"file",ref:T,className:"hidden",accept:w.join(","),multiple:!0,onChange:B}),e.jsx(ee,{className:"text-4xl text-gray-400 mb-2"}),e.jsx("p",{className:"text-sm text-gray-500 font-medium",children:"Drag & Drop Files"}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:"or select Images, PDF, Excel files from device"})]}),l&&l.length>0&&e.jsxs("div",{children:[e.jsxs("h4",{className:"text-sm font-medium text-gray-700 mb-2",children:["Files (",l.length,")"]}),e.jsx("div",{className:"space-y-2",children:l.map((r,t)=>{const h=r instanceof File,N=h?URL.createObjectURL(r):L(r),j=N.split(".").pop()?.toLowerCase(),v=j&&["jpg","jpeg","png","gif","webp"].includes(j);return console.log("objectisImage",v),console.log("objectextension",j),console.log("url",N),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("a",{href:L(r),target:"_blank",rel:"noopener noreferrer",className:"w-12 h-12 rounded overflow-hidden flex items-center justify-center",children:v?e.jsx("img",{src:N,alt:h?r.name:"Existing file",className:"w-full h-full object-cover"}):q(r)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 truncate",children:h?r.name:r.split("/").pop()}),h&&v&&e.jsx("p",{className:"text-xs text-gray-500",children:W(r.size)}),!h&&e.jsx("p",{className:"text-xs text-gray-500",children:"Existing file"})]})]}),e.jsx("button",{type:"button",onClick:D=>{D.stopPropagation(),M(t)},className:"ml-3 bg-red-500 text-white rounded-full p-1 hover:bg-red-600 transition-colors",children:e.jsx(se,{size:12})})]},t)})})]}),y&&e.jsx("p",{className:"text-xs text-red-500 mt-1",children:y})]})},ye=({id:g,title:m,loading:d,children:l,subtitle:_})=>d?e.jsx("div",{className:"flex justify-center items-center h-[500px]",children:e.jsx(ie,{})}):e.jsx("div",{className:"w-full h-full p-2 sm:p-4 lg:p-6 overflow-y-auto pb-20",children:e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsx(de,{title:g?`Edit ${m}`:`Create ${m}`,subtitle:_||(g?`Update ${m} details`:`Create a new ${m}`)}),e.jsx("div",{className:"space-y-4 sm:space-y-6 mt-4",children:l})]})}),k=f.forwardRef(({label:g,error:m,required:d,children:l,className:_="",...y},w)=>e.jsxs("div",{className:"w-full",children:[g&&e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[g," ",d&&e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("select",{ref:w,className:`w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 ${m?"border-red-500":""} ${_}`,...y,children:l}),m&&e.jsx("p",{className:"text-xs text-red-500 mt-1",children:m})]}));k.displayName="Select";const P=f.forwardRef(({label:g,error:m,required:d,className:l="",..._},y)=>e.jsxs("div",{className:"w-full",children:[g&&e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[g," ",d&&e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("textarea",{ref:y,rows:3,className:`w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-vertical ${m?"border-red-500":""} ${l}`,..._}),m&&e.jsx("p",{className:"text-xs text-red-500 mt-1",children:m})]}));P.displayName="TextArea";const b=f.forwardRef(({label:g,error:m,required:d,autofoucs:l,className:_="",...y},w)=>e.jsxs("div",{className:"w-full",children:[g&&e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[g," ",d&&e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{ref:w,autoFocus:l,className:`w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 ${m?"border-red-500":""} ${_}`,...y}),m&&e.jsx("p",{className:"text-xs text-red-500 mt-1",children:m})]}));b.displayName="TextInput";const Ne={job_name:"",job_card_no:"",job_date:new Date().toISOString().split("T")[0],department:"Production Department",job_description:"",quantity:1,expected_delivery_date:"",job_type:"",status:"pending",customer_id:"",customer_name:"",customer_contact:"",customer_address:"",operations:[{operation_name:"",supervisor_id:"",start_date:"",end_date:"",machine_id:""}],challan_no:"",challan_date:"",invoice_no:"",po_no:"",remarks:"",note:"",images:[]},Re=()=>{const g=oe(),[m]=le(),d=m.get("editId"),{selectedBranchId:l}=G(),[_,y]=f.useState(!1),[w,$]=f.useState(!1),[F,T]=f.useState([]),[E,R]=f.useState([]),[C,B]=f.useState([]),[J,M]=f.useState([]),{machines:U,fetchMachines:q}=fe(),{watch:W,control:i,setValue:o,handleSubmit:L,formState:{errors:r}}=be({defaultValues:Ne,mode:"onChange",resolver:ge(he)}),{fields:t,append:h,remove:N,replace:j}=je({control:i,name:"operations"}),v=W("customer_id"),{user:D}=G(),z=D?.id,p=Q(D?.role?.role_name||"")&&!!d,Y=async()=>{y(!0);try{const a=await A.get(I.job_order.details(Number(d))),s=a.data?.job_card||a.data;if(s){s.branch_id&&await V(Number(s.branch_id));const u=s.operations.map(x=>({operation_name:x.operation_name||"",supervisor_id:x.supervisor_id?String(x.supervisor_id):"",start_date:x.start_date?x.start_date.split("T")[0]:"",end_date:x.end_date?x.end_date.split("T")[0]:"",machine_id:x.machine_id?String(x.machine_id):""}))||[];j(u.length?u:[{operation_name:"",supervisor_id:"",start_date:"",end_date:"",machine_id:""}]);const n=s.images?.map(x=>x.image_path)||[];o("job_name",s.job_name||""),o("job_card_no",s.job_card_number||""),o("job_date",s.job_date?s.job_date.split("T")[0]:""),o("department",s.department||"Production Department"),o("job_description",s.job_description||""),o("quantity",s.quantity||1),o("expected_delivery_date",s.expected_delivery_date?s.expected_delivery_date.split("T")[0]:""),o("job_type",s.job_type||""),o("status",s.status||"pending"),o("customer_id",s.customer_id?String(s.customer_id):""),o("customer_name",s.customer?.party_name||""),o("customer_contact",s.customer?.phone||""),o("customer_address",s.customer?.address||""),o("operations",u),o("challan_no",s.challan_number||""),o("challan_date",s.challan_date?s.challan_date.split("T")[0]:""),o("invoice_no",s.invoice_number||""),o("po_no",s.customer_po_number||""),o("remarks",s.remarks||""),o("note",s.note||""),T(n),R([])}}catch(a){console.log(a),O.error("Failed to load job order details")}finally{y(!1)}},V=async a=>{if(a)try{const u=(await A.get(I.user_management.all,{params:{branch_id:a}})).data.users.filter(n=>Q(n.role.role_name));M(u)}catch(s){console.log(s)}},X=async()=>{try{const a=await A.get(I.party_master.all,{params:{party_type:"Customer"}});B(a.data?.parties||a.data?.data||[])}catch(a){console.error("Failed to fetch customers",a)}};f.useEffect(()=>{X(),q(),l&&V(Number(l)),d&&Y()},[d,l,q]),f.useEffect(()=>{if(v&&C.length>0){const a=C.find(s=>s.id===Number(v));a&&(o("customer_name",a.party_name),o("customer_contact",a.phone||""),o("customer_address",a.address||""))}},[v,C,o]);const Z=async a=>{$(!0);try{const s=new FormData;s.append("job_name",a.job_name),s.append("job_date",a.job_date),s.append("department",a.department),s.append("job_description",a.job_description||""),s.append("job_type",a.job_type),s.append("status",a.status),s.append("quantity",String(a.quantity)),s.append("expected_delivery_date",a.expected_delivery_date),s.append("customer_id",String(a.customer_id)),s.append("created_by",String(z)),s.append("branch_id",String(l)),s.append("challan_no",a.challan_no||""),s.append("challan_date",a.challan_date||""),s.append("invoice_no",a.invoice_no||""),s.append("po_no",a.po_no||""),s.append("remarks",a.remarks||""),s.append("note",a.note||""),a.operations.filter(n=>n.operation_name||n.supervisor_id||n.machine_id).forEach((n,x)=>{s.append(`operations[${x}][operation_name]`,n.operation_name||""),s.append(`operations[${x}][supervisor_id]`,n.supervisor_id||""),s.append(`operations[${x}][start_date]`,n.start_date||""),s.append(`operations[${x}][end_date]`,n.end_date||""),s.append(`operations[${x}][machine_id]`,n.machine_id||"")}),E.forEach((n,x)=>{s.append(`images[${x}]`,n)}),s.append("existing_images",JSON.stringify(F));const u={headers:{"Content-Type":"multipart/form-data"}};d?(await A.put(I.job_order.update(Number(d)),s,u),O.success("Job Order updated successfully")):(await A.post(I.job_order.create,s,u),O.success("Job Order created successfully")),g(K.JOB_ORDER.LIST)}catch(s){O.error(s.response?.data?.message||"Failed to submit job order")}finally{$(!1)}};return e.jsx("form",{onSubmit:L(Z),children:e.jsxs(ye,{id:d,title:"Job Card",loading:_,children:[e.jsxs("div",{className:"grid gap-5 md:grid-cols-4",children:[e.jsx(c,{name:"job_name",control:i,render:({field:a})=>e.jsx(b,{required:!0,autofoucs:!0,...a,label:"Job Name",placeholder:"e.g. Engine Overhaul",readOnly:p,className:p?"bg-gray-100":"",error:r?.job_name?.message})}),d&&e.jsx(c,{name:"job_card_no",control:i,render:({field:a})=>e.jsx(b,{...a,label:"Job Card No.",placeholder:"JC-2023...",readOnly:!0,error:r?.job_card_no?.message})}),e.jsx(c,{name:"job_date",control:i,render:({field:a})=>e.jsx(b,{required:!0,...a,type:"date",label:"Job Date",error:r?.job_date?.message,readOnly:p,className:p?"bg-gray-100":""})}),e.jsx(c,{name:"department",control:i,render:({field:a})=>e.jsx(b,{required:!0,...a,label:"Department",error:r?.department?.message,readOnly:p,className:p?"bg-gray-100":""})})]}),e.jsx("div",{className:"mt-5",children:e.jsx(c,{name:"job_description",control:i,render:({field:a})=>e.jsx(P,{...a,label:"Job Description",placeholder:"Describe the job details...",error:r?.job_description?.message,readOnly:p,className:p?"bg-gray-100":""})})}),e.jsxs("div",{className:"mt-5 grid gap-5 md:grid-cols-3",children:[e.jsx(c,{name:"quantity",control:i,render:({field:a})=>e.jsx(b,{required:!0,...a,type:"number",label:"Quantity",placeholder:"Enter quantity",error:r?.quantity?.message,readOnly:p,className:p?"bg-gray-100":""})}),e.jsx(c,{name:"expected_delivery_date",control:i,render:({field:a})=>e.jsx(b,{required:!0,...a,type:"date",label:"Expected Delivery",readOnly:!!d,error:r?.expected_delivery_date?.message})}),e.jsx(c,{name:"job_type",control:i,render:({field:a})=>e.jsxs(k,{...a,required:!0,label:"Job Type",error:r?.job_type?.message,disabled:p,children:[e.jsx("option",{disabled:!0,value:"",children:"Select job type"}),e.jsx("option",{value:"amc",children:"AMC"}),e.jsx("option",{value:"new_job",children:"New Job"}),e.jsx("option",{value:"in_house_manufacturing",children:"In House"}),e.jsx("option",{value:"repair",children:"Repair"}),e.jsx("option",{value:"service",children:"Service"})]})})]}),e.jsxs("div",{className:"mt-5",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 border-b pb-2 mb-4",children:"Customer Information"}),e.jsxs("div",{className:"grid gap-5 md:grid-cols-3",children:[e.jsx(c,{name:"customer_id",control:i,render:({field:a})=>e.jsxs(k,{...a,required:!0,label:"Customer Name",disabled:p,error:r?.customer_id?.message,children:[e.jsx("option",{disabled:!0,value:"",children:"Select Customer"}),C.filter(s=>s.party_type==="customer").map(s=>e.jsx("option",{value:s.id,children:s.party_name},s.id))]})}),e.jsx(c,{name:"customer_contact",control:i,render:({field:a})=>e.jsx(b,{...a,label:"Customer Contact",placeholder:"Auto-filled from customer",readOnly:!0,className:"bg-gray-100"})}),e.jsx(c,{name:"customer_address",control:i,render:({field:a})=>e.jsx(b,{...a,label:"Customer Address",placeholder:"Auto-filled from customer",readOnly:!0,className:"bg-gray-100"})})]})]}),e.jsxs("div",{className:"mt-5",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:"Operations"}),e.jsx(H,{type:"button",className:"bg-blue-600 text-white",onClick:()=>h({operation_name:"",supervisor_id:"",start_date:"",end_date:"",machine_id:""}),children:"+ Add Operation"})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(ce,{children:[e.jsx(me,{cols:[{title:"Operation Name"},{title:"Supervisor"},{title:"Start Date"},{title:"End Date"},{title:"Machine"},{title:"Actions"}]}),e.jsx("tbody",{children:t.map((a,s)=>e.jsxs(pe,{children:[e.jsx(S,{className:"px-5",children:s+1}),e.jsx(S,{className:"min-w-[200px]",children:e.jsx(c,{name:`operations.${s}.operation_name`,control:i,render:({field:u})=>e.jsx(b,{...u,placeholder:"e.g. Cutting, Welding",error:r.operations?.[s]?.operation_name?.message})})}),e.jsx(S,{className:"min-w-[200px]",children:e.jsx(c,{name:`operations.${s}.supervisor_id`,control:i,render:({field:u})=>e.jsxs(k,{...u,error:r.operations?.[s]?.supervisor_id?.message,children:[e.jsx("option",{value:"",children:"Select Supervisor"}),J?.map(n=>e.jsx("option",{value:n.id,children:n.full_name},n.id))]})})}),e.jsx(S,{className:"min-w-[150px]",children:e.jsx(c,{name:`operations.${s}.start_date`,control:i,render:({field:u})=>e.jsx(b,{...u,type:"date",error:r.operations?.[s]?.start_date?.message})})}),e.jsx(S,{className:"min-w-[150px]",children:e.jsx(c,{name:`operations.${s}.end_date`,control:i,render:({field:u})=>e.jsx(b,{...u,type:"date",error:r.operations?.[s]?.end_date?.message})})}),e.jsx(S,{className:"min-w-[200px]",children:e.jsx(c,{name:`operations.${s}.machine_id`,control:i,render:({field:u})=>e.jsxs(k,{...u,error:r.operations?.[s]?.machine_id?.message,children:[e.jsx("option",{value:"",children:"Select Machine"}),U.map(n=>e.jsx("option",{value:n.id,children:n.name},n.id))]})})}),e.jsx(S,{children:e.jsx(ue,{children:t.length>1&&e.jsx(xe,{onClick:()=>N(s)})})})]},a.id))})]})})]}),e.jsxs("div",{className:"mt-5",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 border-b pb-2 mb-4",children:"Internal Tracking"}),e.jsxs("div",{className:"grid gap-5 md:grid-cols-4",children:[e.jsx(c,{name:"challan_no",control:i,render:({field:a})=>e.jsx(b,{...a,label:"Challan No.",placeholder:"Enter challan number",readOnly:p,className:p?"bg-gray-100":"",error:r?.challan_no?.message})}),e.jsx(c,{name:"challan_date",control:i,render:({field:a})=>e.jsx(b,{...a,type:"date",label:"Challan Date",readOnly:p,className:p?"bg-gray-100":"",error:r?.challan_date?.message})}),e.jsx(c,{name:"invoice_no",control:i,render:({field:a})=>e.jsx(b,{...a,label:"Invoice No.",placeholder:"Enter invoice number",readOnly:p,className:p?"bg-gray-100":"",error:r?.invoice_no?.message})})]})]}),e.jsxs("div",{className:"mt-5 grid gap-5 md:grid-cols-2",children:[e.jsx(c,{name:"remarks",control:i,render:({field:a})=>e.jsx(P,{...a,label:"Remarks",placeholder:"Add any additional notes or remarks...",error:r?.remarks?.message})}),e.jsx(c,{name:"note",control:i,render:({field:a})=>e.jsx(P,{...a,label:"Note",placeholder:"Add any additional notes or comments...",readOnly:p,className:p?"bg-gray-100":"",error:r?.note?.message})})]}),e.jsx("div",{className:"mt-5",children:e.jsx(_e,{label:"Job Images and Documents",value:[...F,...E],maxFiles:10,error:r?.images?.message,onChange:a=>{const s=a.filter(n=>n instanceof File),u=a.filter(n=>typeof n=="string");R(s),T(u)}})}),e.jsxs("div",{className:"mt-8 flex flex-col sm:flex-row justify-end gap-3",children:[e.jsx(H,{type:"button",variant:"outline",className:"w-full sm:w-auto",onClick:()=>g(K.JOB_ORDER.LIST),children:"Cancel"}),e.jsx(H,{type:"submit",loading:w,disabled:w,className:"bg-blue-600 text-white w-full sm:w-auto",children:d?"Update Job Card":"Save Job Card"})]})]})})};export{Re as default};
