import{u as U,i as L,a as M,r as d,j as e,B as C,A as w,h as c,e as m,y as u}from"./index-CbNhh14T.js";import{u as H,C as o}from"./index.esm-CzaEKZ5d.js";import{T as i}from"./TextInput-B3FUDRfG.js";import{T as J}from"./TextArea-CSFBQe0e.js";import{S as b}from"./Select-DdY8wYe_.js";import{F as Q}from"./FormHeader-Ck__6gFL.js";import{B as V,I as W}from"./ImageUpload-DmenJsnb.js";import{L as z}from"./Loading-DBMuoTO4.js";import{u as G}from"./useMachineStore-DsGA3JCJ.js";import{o as K,v as X}from"./yup-3BgDdNf1.js";const ie=()=>{const x=U(),[E]=L(),n=E.get("editId"),{selectedBranchId:g}=M(),[O,y]=d.useState(!1),[D,f]=d.useState(!1),[p,I]=d.useState([]),[T,A]=d.useState(null),{machines:P,fetchMachines:v}=G(),N={job_name:"",job_card_no:"",job_date:new Date().toISOString().split("T")[0],department:"Production Department",job_description:"",quantity:1,expected_delivery_date:"",job_type:"",status:"In Progress",customer_id:"",customer_name:"",customer_contact:"",customer_address:"",supervisor_id:"",branch_id:g?Number(g):0,machine_used:"",challan_no:"",challan_date:"",invoice_no:"",po_no:"",remarks:"",images:[],note:""},{control:t,handleSubmit:k,setValue:_,watch:q,reset:S,formState:{errors:l}}=H({defaultValues:N,resolver:K(X,{context:{isEdit:!!n}})}),h=q("customer_id"),B=async r=>{if(r)try{const a=(await c.get(m.user_management.all,{params:{branch_id:r}})).data.users.filter(R=>R.role.role_name==="Workshop Supervisor");A(a)}catch(s){console.log(s),u.error("Failed to fetch users")}};d.useEffect(()=>{(async()=>{try{const s=await c.get(m.party_master.parties,{params:{per_page:1e3,party_type:"Customer"}});I(s.data?.parties||s.data?.data||[])}catch(s){console.error("Failed to fetch customers",s)}})(),v()},[v]),d.useEffect(()=>{if(h&&p.length>0){const r=p.find(s=>s.id===Number(h));r&&(_("customer_name",r.party_name),_("customer_contact",r.phone||""),_("customer_address",r.address||""))}},[h,p,_]);const j=q("branch_id");d.useEffect(()=>{j&&B(Number(j))},[j]),d.useEffect(()=>{n&&(async()=>{y(!0);try{const s=await c.get(m.job_order.details(Number(n))),a=s.data?.job_order||s.data;S({...N,...a,job_card_no:a.job_card_number,branch_id:a.branch_id?Number(a.branch_id):0,supervisor_id:a.allocated_supervisor_id?String(a.allocated_supervisor_id):"",customer_id:a.customer_id?String(a.customer_id):"",customer_name:a.customer?.party_name||"",customer_contact:a.customer?.contact_number||"",customer_address:a.customer?.address||"",po_no:a.customer_po_number||"",challan_no:a.challan_number||"",invoice_no:a.invoice_number||"",machine_used:a.machine_required?String(a.machine_required):"",job_date:a.job_date?a.job_date.split("T")[0]:"",expected_delivery_date:a.expected_delivery_date?a.expected_delivery_date.split("T")[0]:"",challan_date:a.challan_date?a.challan_date.split("T")[0]:""})}catch(s){console.error(s),u.error("Failed to load job order details")}finally{y(!1)}})()},[n,S]);const F=async r=>{f(!0);try{const s={job_date:r.job_date,job_name:r.job_name,department:r.department||"Production Department",customer_id:r.customer_id?Number(r.customer_id):null,branch_id:Number(r.branch_id),job_description:r.job_description,job_type:r.job_type,status:r.status,quantity:Number(r.quantity),expected_delivery_date:r.expected_delivery_date,allocated_supervisor_id:r.supervisor_id?Number(r.supervisor_id):null,machine_required:r.machine_used?Number(r.machine_used):null,challan_number:r.challan_no,challan_date:r.challan_date,invoice_number:r.invoice_no,customer_po_number:r.po_no,remarks:r.remarks,images:[]};n?(await c.put(m.job_order.update(Number(n)),s),u.success("Job Order updated successfully")):(await c.post(m.job_order.create,s),u.success("Job Order created successfully")),x(w.JOB_ORDER.LIST)}catch(s){console.error(s),u.error(s.response?.data?.message||"Failed to submit job order")}finally{f(!1)}};return O?e.jsx("div",{className:"flex justify-center items-center h-[500px]",children:e.jsx(z,{})}):e.jsx("div",{className:"w-full h-full p-2 sm:p-4 lg:p-6 overflow-y-auto pb-20",children:e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsx(Q,{title:n?"Edit Job Card":"Create Job Card",subtitle:n?"Update Job Order details":"Create a new Job Order"}),e.jsxs("form",{onSubmit:k(F),className:"space-y-4 sm:space-y-6 mt-4",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 sm:gap-4",children:[e.jsx(o,{name:"job_name",control:t,rules:{required:"Job Name is required"},render:({field:r})=>e.jsx(i,{...r,label:"Job Name",required:!0,error:l.job_name?.message,placeholder:"e.g. Engine Overhaul"})}),n&&e.jsx(o,{name:"job_card_no",control:t,rules:{required:"Job Card No is required"},render:({field:r})=>e.jsx(i,{...r,label:"Job Card No.",required:!0,error:l.job_card_no?.message,placeholder:"JC-2023...",readOnly:!0})}),e.jsx(o,{name:"job_date",control:t,rules:{required:"Date is required"},render:({field:r})=>e.jsx(i,{...r,type:"date",label:"Date",required:!0,error:l.job_date?.message})}),e.jsx(o,{name:"department",control:t,rules:{required:"Department is required"},render:({field:r})=>e.jsx(i,{...r,type:"department",label:"Department",required:!0,error:l.department?.message})})]}),e.jsx("div",{className:"w-full",children:e.jsx(o,{name:"job_description",control:t,render:({field:r})=>e.jsx(J,{...r,label:"Job Description",placeholder:"Describe the job details...",rows:3})})}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 sm:gap-4",children:[e.jsx(o,{name:"quantity",control:t,rules:{required:"Quantity is required",min:1},render:({field:r})=>e.jsx(i,{...r,type:"number",label:"Quantity",required:!0,error:l.quantity?.message,placeholder:"Enter quantity"})}),e.jsx(o,{name:"expected_delivery_date",control:t,rules:{required:"Expected Delivery is required"},render:({field:r})=>e.jsx(i,{...r,type:"date",label:"Expected Delivery",required:!0,error:l.expected_delivery_date?.message})}),e.jsx(o,{name:"job_type",control:t,rules:{required:"Job Type is required"},render:({field:r})=>e.jsxs(b,{...r,label:"Job Type",required:!0,error:l.job_type?.message,children:[e.jsx("option",{value:"",children:"Select job type"}),e.jsx("option",{value:"amc",children:"AMC"}),e.jsx("option",{value:"new_job",children:"New Job"}),e.jsx("option",{value:"in_house_manufacturing",children:"In house"}),e.jsx("option",{value:"repair",children:"Repair"}),e.jsx("option",{value:"service",children:"Service"})]})})]}),e.jsx("h3",{className:"text-base sm:text-lg font-semibold text-gray-800 border-b pb-1 mt-4 sm:mt-6",children:"Customer Information"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4",children:[e.jsx(o,{name:"customer_id",control:t,rules:{required:"Customer is required"},render:({field:r})=>e.jsxs(b,{...r,label:"Customer Name",required:!0,error:l.customer_id?.message,children:[e.jsx("option",{value:"",children:"Select Customer"}),p.filter(s=>s.party_type==="customer").map(s=>e.jsx("option",{value:s.id,children:s.party_name},s.id))]})}),e.jsx(o,{name:"customer_contact",control:t,render:({field:r})=>e.jsx(i,{...r,label:"Customer Contact",placeholder:"Auto-filled from customer",readOnly:!0,className:"bg-gray-100"})}),e.jsx(o,{name:"customer_address",control:t,render:({field:r})=>e.jsx(i,{...r,label:"Customer Address",placeholder:"Auto-filled from customer",readOnly:!0,className:"bg-gray-100"})})]}),e.jsx("h3",{className:"text-base sm:text-lg font-semibold text-gray-800 border-b pb-1 mt-4 sm:mt-6",children:"Assignment"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4",children:[e.jsx(o,{name:"supervisor_id",control:t,render:({field:r})=>e.jsxs(b,{...r,label:"Allocated Supervisor",error:l.supervisor_id?.message,children:[e.jsx("option",{value:"",children:"Select Supervisor"}),T?.map(s=>e.jsx("option",{value:s.id,children:s.full_name},s.id))]})}),e.jsx(V,{control:t,name:"branch_id",label:"Branch Name",required:!0,error:l.branch_id?.message}),e.jsx(o,{name:"machine_used",control:t,render:({field:r})=>e.jsxs(b,{...r,label:"Machine Used",error:l.machine_used?.message,children:[e.jsx("option",{value:"",children:"Select Machine"}),P.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})})]}),e.jsx("h3",{className:"text-base sm:text-lg font-semibold text-gray-800 border-b pb-1 mt-4 sm:mt-6",children:"Internal Tracking"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 sm:gap-4",children:[e.jsx(o,{name:"challan_no",control:t,render:({field:r})=>e.jsx(i,{...r,label:"Challan No.",placeholder:"Enter challan number"})}),e.jsx(o,{name:"challan_date",control:t,render:({field:r})=>e.jsx(i,{...r,type:"date",label:"Challan Date"})}),e.jsx(o,{name:"invoice_no",control:t,render:({field:r})=>e.jsx(i,{...r,label:"Invoice No.",placeholder:"Enter invoice number"})}),e.jsx(o,{name:"po_no",control:t,render:({field:r})=>e.jsx(i,{...r,label:"PO No.",placeholder:"Enter PO number"})})]}),e.jsx("div",{className:"w-full",children:e.jsx(o,{name:"remarks",control:t,render:({field:r})=>e.jsx(J,{...r,label:"Remarks",placeholder:"Add any additional notes or remarks...",rows:3})})}),e.jsx("div",{className:"w-full",children:e.jsx(o,{name:"images",control:t,render:({field:r})=>e.jsx(W,{value:r.value,onChange:r.onChange,error:l.images?.message,maxFiles:6})})}),e.jsxs("div",{className:"flex flex-col sm:flex-row justify-end gap-3 pt-4 sm:pt-6",children:[e.jsx(C,{variant:"outline",type:"button",className:"w-full sm:w-auto order-2 sm:order-1",onClick:()=>x(w.JOB_ORDER.LIST),children:"Cancel"}),e.jsx(C,{type:"submit",loading:D,className:"bg-blue-600 text-white w-full sm:w-auto order-1 sm:order-2",children:n?"Update Job Card":"Save Job Card"})]})]})]})})};export{ie as default};
