import{r as u,a as D,j as e,ao as a,y as _,h as A,e as E,u as k,D as S,P as w,A as R}from"./index-DHxjsmS_.js";import{L as C}from"./ListWrapper-Cc4XzfgT.js";import{T as O,a as L,b as c}from"./TableWrapper-Cc34JFCi.js";import{T as I}from"./TableRow-CUJFv1cP.js";import{T as M,a as G}from"./TableDelete-CBS2zXrt.js";import{T as H}from"./TableEdit-DAgKBokJ.js";import{u as $}from"./usePagination-CsbUaw-r.js";const F=({taskCard:n,onStatusUpdate:b})=>{const[d,g]=u.useState(!1),[x,f]=u.useState({open:!1,action:"",title:""}),[m,r]=u.useState(""),{user:N}=D(),j=()=>{if(!n.expected_delivery_date)return!1;const t=new Date(n.expected_delivery_date),o=new Date;return o.setHours(0,0,0,0),t.setHours(0,0,0,0),t<o&&n.status!==a.COMPLETED},p=()=>{const t=N?.role?.role_name,o=n.status,l=[],h=t?.toLowerCase().replace(/\s+/g,"_");return(t==="Super Admin"||t==="Admin"||t==="Workshop Supervisor"||h==="super_admin"||h==="admin"||h==="workshop_supervisor")&&o===a.PENDING&&l.push({label:"Approve",value:a.APPROVED,variant:"success"},{label:"Reject",value:a.REJECTED,variant:"danger"}),(t==="Workshop Supervisor"||t==="Super Admin"||t==="Admin"||h==="workshop_supervisor"||h==="super_admin"||h==="admin")&&(o===a.APPROVED&&l.push({label:"Start Progress",value:a.IN_PROGRESS,variant:"primary"}),o===a.IN_PROGRESS&&l.push({label:"Mark Completed",value:a.COMPLETED,variant:"success"})),l},s=async t=>{if(t===a.REJECTED){f({open:!0,action:t,title:"Reject Task Card"});return}await i(t)},i=async(t,o)=>{g(!0);try{const l={status:t};o&&(l.reason=o),await A.post(E.task_cards.status(n.id),l),_.success("Status updated successfully"),b()}catch(l){console.error("Failed to update status:",l),_.error(l.response?.data?.message||"Failed to update status")}finally{g(!1)}},y=async()=>{if(!m.trim()){_.error("Please enter a reason");return}await i(x.action,m),P()},P=()=>{f({open:!1,action:"",title:""}),r("")},v=p(),T=(()=>{if(j())return{text:"Overdue",className:"border-red-300 text-red-700"};switch(n.status){case a.PENDING:return{text:"Pending",className:"border-yellow-300 text-yellow-700"};case a.APPROVED:return{text:"Approved",className:"border-green-300 text-green-700"};case a.REJECTED:return{text:"Rejected",className:"border-red-300 text-red-700"};case a.IN_PROGRESS:return{text:"In Progress",className:"border-blue-300 text-blue-700"};case a.COMPLETED:return{text:"Completed",className:"border-purple-300 text-purple-700"};default:return{text:n.status?.replace(/_/g," ")||"Unknown",className:"border-gray-300 text-gray-700"}}})();return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex items-center gap-2 flex-wrap",children:d?e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"}),e.jsx("span",{className:"text-xs text-gray-500",children:"Updating..."})]}):e.jsx(e.Fragment,{children:e.jsxs("select",{className:`text-xs border border-gray-300 rounded px-2 py-1 focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white min-w-[140px] ${v.length===0?"opacity-50 cursor-not-allowed":""} ${T.className.replace("bg-","border-").replace("text-","text-").replace("-100","-300").replace("-800","-700")}`,value:"",onChange:t=>{t.target.value&&v.length>0&&(s(t.target.value),t.target.value="")},disabled:d||v.length===0,children:[e.jsxs("option",{value:"",className:"font-medium",children:[T.text," ",v.length>0?"▼":""]}),v.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))]})})}),x.open&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-md mx-4",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:x.title}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Reason ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("textarea",{className:"w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",rows:4,placeholder:`Enter reason for ${x.action}...`,value:m,onChange:t=>r(t.target.value)})]}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx("button",{className:"px-4 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50",onClick:P,disabled:d,children:"Cancel"}),e.jsx("button",{className:"px-4 py-2 text-sm rounded-lg text-white bg-red-600 hover:bg-red-700",onClick:y,disabled:d,children:d?"Processing...":"Submit"})]})]})})]})},Q=()=>{const{renderPagination:n}=$(),b=k(),{selectedBranchId:d}=D(),[g,x]=u.useState([]),[f,m]=u.useState(!1),[r,N]=u.useState(""),j=async()=>{m(!0);try{const s=await A.get(E.task_cards.list);console.log("Task Cards API Response:",s.data);const i=s.data?.task_cards||s.data?.data||[];x(i)}catch(s){console.error("Failed to fetch task orders:",s)}finally{m(!1)}};u.useEffect(()=>{j()},[d]);const p=r?g.filter(s=>{if(r==="overdue"){const i=new Date(s.expected_delivery_date),y=new Date;return y.setHours(0,0,0,0),i.setHours(0,0,0,0),i<y&&s.status!==a.COMPLETED}return s.status===r}):g;return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"bg-white rounded-lg shadow-sm p-4",children:e.jsxs("div",{className:"flex flex-wrap gap-4 items-center",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Status:"}),e.jsxs("select",{value:r,onChange:s=>N(s.target.value),className:"text-sm border border-gray-300 rounded px-3 py-1 focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white min-w-[150px]",children:[e.jsx("option",{value:"",children:"All Status"}),e.jsx("option",{value:a.PENDING,children:"Pending"}),e.jsx("option",{value:a.APPROVED,children:"Approved"}),e.jsx("option",{value:a.REJECTED,children:"Rejected"}),e.jsx("option",{value:a.IN_PROGRESS,children:"In Progress"}),e.jsx("option",{value:a.COMPLETED,children:"Completed"}),e.jsx("option",{value:"overdue",children:"Overdue"})]})]}),r&&e.jsx("button",{onClick:()=>N(""),className:"text-xs text-blue-600 hover:text-blue-800",children:"Clear Filter"})]})}),e.jsxs(C,{title:`Task Orders (${p?.length||0})`,createOnClick:w.hasPermission("task_card_management_create")?()=>b(R.TASK_CARD.CREATE):void 0,children:[e.jsxs(O,{children:[e.jsx(L,{cols:[{title:"Task Card No"},{title:"Task Name"},{title:"Customer"},{title:"Task Date"},{title:"Expected Delivery"},{title:"Task Type"},{title:"Status"},{title:"Actions"}]}),e.jsx("tbody",{children:f?e.jsx("tr",{children:e.jsx("td",{colSpan:9,className:"px-6 py-12 text-center",children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-red-600"}),e.jsx("p",{className:"mt-2 text-sm text-gray-500",children:"Loading task orders..."})]})})}):p?.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:9,className:"px-6 py-12 text-center",children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("svg",{className:"w-12 h-12 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),e.jsx("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"No task orders"}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:r?`No task orders found with status "${r}"`:"Get started by creating a new task order."})]})})}):p.map((s,i)=>e.jsxs(I,{children:[e.jsx(c,{className:"w-12 text-center font-medium",children:e.jsx("div",{className:"text-sm text-gray-900",children:i+1})}),e.jsx(c,{className:"w-40",children:e.jsx("div",{className:"flex items-center",children:e.jsx("div",{className:"text-sm font-medium text-gray-900",children:s.job_card_number||"-"})})}),e.jsx(c,{className:"w-48",children:e.jsx("div",{className:"text-sm text-gray-900",children:s.job_name||"-"})}),e.jsx(c,{className:"w-48",children:e.jsx("div",{className:"flex items-center",children:e.jsx("div",{children:e.jsx("div",{className:"text-sm font-medium text-gray-900",children:s.customer?.party_name||s.customer_name||"—"})})})}),e.jsx(c,{className:"w-32",children:e.jsx("div",{className:"text-sm text-gray-900",children:S.date(s.task_date)})}),e.jsx(c,{className:"w-32",children:e.jsx("div",{className:"text-sm text-gray-900",children:S.date(s.expected_delivery_date)})}),e.jsx(c,{className:"w-32",children:e.jsx("span",{className:"capitalize text-sm text-gray-900",children:s.job_type?.replace(/_/g," ")||"-"})}),e.jsx(c,{className:"w-40",children:e.jsx(F,{taskCard:{id:s.id,status:s.status,task_card_number:s.job_card_number,expected_delivery_date:s.expected_delivery_date},onStatusUpdate:j})}),e.jsx(c,{className:"w-20",children:e.jsxs(M,{children:[w.hasPermission("task_card_management_update")&&e.jsx(H,{onClick:()=>b(`${R.TASK_CARD.CREATE}?editId=${s.id}`)}),w.hasPermission("task_card_management_delete")&&e.jsx(G,{refetch:j,endpoint:E.task_cards.delete(s.id)})]})})]},s.id))})]}),p?.length>0&&n()]})]})};export{Q as default};
