import{r as u,a as S,j as e,y as w,h as A,e as P,G as D,u as T,k as E,P as _,A as C}from"./index-CbNhh14T.js";import{L}from"./ListWrapper-CtE9blfZ.js";import{T as O,a as I,b as c}from"./TableWrapper-tM3Cun3B.js";import{T as M}from"./TableRow-XjmxnSZP.js";import{u as V}from"./usePagination-DcXLmXSb.js";import{T as $,a as F}from"./TableDelete-BtQ4bCNH.js";import{L as U}from"./Loading-DBMuoTO4.js";import{S as H}from"./StatusFilter-BkdONObd.js";const B=({purchaseOrder:a,onStatusUpdate:x})=>{const[o,f]=u.useState(!1),[i,m]=u.useState({open:!1,action:"",title:""}),[h,j]=u.useState(""),{user:y}=S(),N=()=>{const s=y?.role?.role_name,r=a.status,n=[];return s==="Super Admin"&&(r==="Pending_Approval"||r==="Pending Approval"||r==="pending_approval"||r==="pending_admin_approval")&&n.push({label:"Approve",value:"Approved",variant:"success"},{label:"Reject",value:"Rejected",variant:"danger"}),s==="Purchase Manager"&&r==="Approved"&&n.push({label:"Send to Vendor",value:"Sent_to_Vendor",variant:"primary"}),n},b=async s=>{if(s==="Rejected"){m({open:!0,action:s,title:"Reject Purchase Order"});return}await g(s)},g=async(s,r)=>{f(!0);try{const n={status:s};r&&(n.reason=r),await A.post(P.purchase_order.status(a.id),n),w.success("Status updated successfully"),x()}catch(n){console.error("Failed to update status:",n),w.error(n.response?.data?.message||"Failed to update status")}finally{f(!1)}},d=async()=>{if(!h.trim()){w.error("Please enter a reason");return}await g(i.action,h),v()},v=()=>{m({open:!1,action:"",title:""}),j("")},l=N(),t=(()=>{switch(a.status){case"Approved":return{text:"Approved",className:"border-gray-400 text-gray-800"};case"Pending_Approval":case"Pending Approval":case"pending_approval":case"pending_admin_approval":return{text:a.status.replace(/_/g," "),className:"border-gray-400 text-gray-800"};case"Rejected":return{text:"Rejected",className:"border-gray-400 text-gray-800"};case"Sent_to_Vendor":case"Sent to Vendor":return{text:a.status.replace(/_/g," "),className:"border-gray-400 text-gray-800"};case"Cancelled":return{text:"Cancelled",className:"border-gray-300 text-gray-800"};default:return{text:a.status?.replace(/_/g," ")||"Unknown",className:"border-gray-400 text-gray-800"}}})();return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex items-center gap-2 flex-wrap",children:o?e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"}),e.jsx("span",{className:"text-xs text-gray-500",children:"Updating..."})]}):e.jsx(e.Fragment,{children:e.jsxs("select",{className:`text-xs border rounded px-2 py-1 focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white min-w-[140px] ${l.length===0?"opacity-50 cursor-not-allowed":""} ${t.className}`,value:"",onChange:s=>{s.target.value&&l.length>0&&(b(s.target.value),s.target.value="")},disabled:o||l.length===0,children:[e.jsxs("option",{value:"",className:"font-medium",children:[t.text," ",l.length>0?"â–¼":""]}),l.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))]})})}),i.open&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-md mx-4",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:i.title}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Reason ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("textarea",{className:"w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",rows:4,placeholder:`Enter reason for ${i.action}...`,value:h,onChange:s=>j(s.target.value)})]}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx("button",{className:"px-4 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50",onClick:v,disabled:o,children:"Cancel"}),e.jsx("button",{className:`px-4 py-2 text-sm rounded-lg text-white ${i.action==="Cancelled"?"bg-red-600 hover:bg-red-700":"bg-yellow-500 hover:bg-yellow-600"}`,onClick:d,disabled:o,children:o?"Processing...":"Submit"})]})]})})]})};function G(a){return D({attr:{viewBox:"0 0 24 24"},child:[{tag:"path",attr:{fill:"none",strokeWidth:"2",d:"M12,21 C7,21 1,16 1,12 C1,8 7,3 12,3 C17,3 23,8 23,12 C23,16 17,21 12,21 Z M12,7 C9.23875,7 7,9.23875 7,12 C7,14.76125 9.23875,17 12,17 C14.76125,17 17,14.76125 17,12 C17,9.23875 14.76125,7 12,7 L12,7 Z"},child:[]}]})(a)}const W=a=>new Intl.NumberFormat("en-IN",{style:"currency",currency:"INR",maximumFractionDigits:2}).format(a),z=a=>a?new Date(a).toLocaleDateString("en-IN",{day:"2-digit",month:"2-digit",year:"numeric"}):"-",te=()=>{const{page:a,rowsPerPage:x,setTotal:o,renderPagination:f}=V(),i=T(),{selectedBranchId:m,user:h}=S(),{setPurchaseOrders:j}=E(),[y,N]=u.useState([]),[b,g]=u.useState(!1),[d,v]=u.useState(""),l=async()=>{g(!0);try{const t=await A.get(P.purchase_order.list,{params:{page:a+1,per_page:x,...m&&{branch_id:m}}}),{purchase_orders:s,pagination:r}=t.data;if(N(s||[]),o(r?.total||0),h?.role?.role_name==="Purchase Manager"){const R=(s||[]).filter(k=>k.status==="Pending Approval").length;j(R)}}catch(t){console.log(t)}finally{g(!1)}};u.useEffect(()=>{l()},[a,x,m]);const p=d?y.filter(t=>t.status===d):y;return e.jsxs("div",{className:"space-y-6",children:[e.jsx(H,{module:"purchaseOrder",selectedStatus:d,onChange:t=>v(t)}),e.jsxs(L,{title:`Purchase Orders (${p.length})`,createOnClick:_.hasPermission("purchase_order_create")?()=>i(C.PURCHASE_ORDER.CREATE):void 0,children:[b?e.jsx("div",{className:"flex justify-center py-10",children:e.jsx(U,{})}):e.jsxs(O,{children:[e.jsx(I,{cols:[{title:"PO Number"},{title:"PO Date"},{title:"Vendor"},{title:"Branch"},{title:"Items"},{title:"Total Amount"},{title:"Status"},{title:"Actions",width:"w-96"}]}),e.jsx("tbody",{children:b?e.jsx("tr",{children:e.jsx("td",{colSpan:9,className:"px-6 py-12 text-center",children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-red-600"}),e.jsx("p",{className:"mt-2 text-sm text-gray-500",children:"Loading purchase orders..."})]})})}):p.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:9,className:"px-6 py-12 text-center",children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("svg",{className:"w-12 h-12 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),e.jsx("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"No purchase orders"}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:d?`No orders found with status "${d}"`:"Get started by creating a new purchase order."})]})})}):p.map((t,s)=>e.jsxs(M,{children:[e.jsx(c,{className:"w-12 text-center font-medium",children:e.jsx("div",{className:"text-sm text-gray-900",children:s+1})}),e.jsx(c,{className:"w-40",children:e.jsx("div",{className:"flex items-center",children:e.jsx("div",{className:"text-sm font-medium text-gray-900",children:t.po_number})})}),e.jsx(c,{className:"w-32",children:e.jsx("div",{className:"text-sm text-gray-900",children:z(t.po_date)})}),e.jsx(c,{className:"w-48",children:e.jsx("div",{className:"text-sm text-gray-900",children:t.vendor?.party_name||"-"})}),e.jsx(c,{className:"w-32",children:e.jsx("div",{className:"text-sm text-gray-900",children:t.branch?.branch_name||"-"})}),e.jsx(c,{className:"w-20",children:e.jsx("div",{className:"text-sm text-gray-900",children:t.items?.length||0})}),e.jsx(c,{className:"w-32",children:e.jsx("div",{className:"text-sm text-gray-900",children:W(t.total_amount||0)})}),e.jsx(c,{className:"w-40",children:e.jsx(B,{purchaseOrder:{id:t.id,status:t.status,po_number:t.po_number},onStatusUpdate:l})}),e.jsx(c,{className:"w-20",children:e.jsxs($,{children:[_.hasPermission("purchase_order_update")&&e.jsx("div",{className:`flex items-center justify-center w-8 h-8 sm:w-9 sm:h-9 rounded-full  \r
                   hover:bg-gray-200 hover:text-gray-700 transition\r
                   bg-gray-200 text-gray-700\r
                   disabled:cursor-not-allowed disabled:opacity-40 touch-manipulation`,children:e.jsx(G,{onClick:()=>i(`${C.PURCHASE_ORDER.CREATE}?editId=${t.id}`)})}),_.hasPermission("purchase_order_delete")&&e.jsx(F,{refetch:l,endpoint:P.purchase_order.delete(t.id)})]})})]},t.id))})]}),p.length>0&&f()]})]})};export{te as default};
