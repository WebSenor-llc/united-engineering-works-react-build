import{u as k,i as O,a as w,r as p,j as e,B as b,h as x,e as y,y as D,A as H}from"./index-jDfkN2r4.js";import{T as C}from"./TextInput-BI1n9-MI.js";import{L as W}from"./ListWrapper-CdcYWlKR.js";import{T as Q}from"./TableActions-CJhLK9s8.js";import{T as V,a as z,b as l}from"./TableWrapper-BjLYclM7.js";import{T as G}from"./TableDelete-BoG9eQR7.js";import{u as J,b as K,c as X,C as o}from"./index.esm-DafRD7gC.js";import{u as Y}from"./useItemsStore-C3LUPxMY.js";import{u as Z}from"./useMaterialRequestStore-rqVy3SuX.js";import{L as ee}from"./Loading-QSf8-D6b.js";import{F as te}from"./FormHeader-rtnPN1Zb.js";import{B as ie}from"./BranchUserSelect-C1Fn0rAh.js";import"./BackButton-DFo0oY_K.js";const se={reason:"",deposited_by:"",recieved_by:"Store",branch_id:"",material_requisition_id:"",item_id:"",quantity_to_deposit:"",quantity_deposited:"",items:[{item_id:"",item_name:"",item_code:"",item_unit:"",qty_to_deposit:"",qty_deposited:""}]},ye=()=>{const h=k(),[I]=O(),r=I.get("editId"),{selectedBranchId:u}=w(),{control:a,handleSubmit:T,setValue:R,reset:L,formState:{errors:_}}=J({defaultValues:se}),{fields:P,append:A,remove:E}=K({control:a,name:"items"}),F=X({control:a,name:"items"}),{user:f}=w(),{fetchItems:j}=Y(),{materials:m,fetchMaterials:g}=Z(),[$,q]=p.useState(!1),[S,v]=p.useState(!1),[N,B]=p.useState(!1);p.useEffect(()=>{(async()=>{await Promise.all([j(),g()]),B(!0)})()},[j,g]);const M=async()=>{if(r){q(!0);try{const s=await x.get(y.deposit_slip.details(Number(r))),i=s.data.slip||s.data;L({branch_id:i.branch_id?String(i.branch_id):u?String(u):"",material_requisition_id:i.material_requisition_id?String(i.material_requisition_id):"",recieved_by:i.recieved_by,deposited_by:i.deposited_by,reason:i.reason||"",items:(i.items||[]).map(t=>({item_id:t.item_id,item_code:t.item?.item_code||"",item_name:t.item?.item_name||"",item_unit:t.unit?.unit_name||"",qty_to_deposit:t.quantity_to_deposit,qty_deposited:t.quantity_deposited}))})}catch(s){console.error("Failed to load details:",s),D.error("Failed to load deposit slip details")}finally{q(!1)}}};p.useEffect(()=>{r&&N&&M()},[r,N]);const U=async s=>{v(!0);const i={branch_id:u,material_requisition_id:s.material_requisition_id?Number(s.material_requisition_id):null,recieved_by:s.recieved_by,deposited_by:s.deposited_by,reason:s.reason,items:s.items.map(t=>({item_id:Number(t.item_id),quantity_to_deposit:Number(t.qty_to_deposit),quantity_deposited:Number(t.qty_deposited)}))};try{const t=r?y.deposit_slip.update(Number(r)):y.deposit_slip.create;await(r?x.put:x.post)(t,i),h(H.DEPOSITE_SLIP.LIST)}catch(t){console.error(t),D.error(t.response?.data?.message||"Failed to save deposit slip")}finally{v(!1)}};return $?e.jsx("div",{className:"flex justify-center py-20",children:e.jsx(ee,{})}):e.jsxs("div",{className:"w-full h-full overflow-auto space-y-8 p-4 pb-20",children:[e.jsx("div",{className:"space-y-1 ml-2",children:e.jsx(te,{title:r?"Edit Deposite Slip":"Create Deposite Slip",subtitle:r?"Update the Deposite Slip details":"Fill out the form to submit a new Deposite Slip"})}),e.jsxs("div",{className:"grid grid-cols-2 gap-5 ml-2 mr-5",children:[e.jsx(o,{name:"material_requisition_id",control:a,render:({field:s})=>e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-semibold text-gray-700 mb-1",children:"Material Request"}),e.jsxs("select",{...s,className:"w-full h-[45px] rounded-lg border border-gray-300 px-4 mt-1 text-sm",onChange:i=>{const t=i.target.value;if(s.onChange(t),t){const d=m&&m.find(c=>c.id===Number(t));if(d&&d.items&&d.items.length>0){const c=d.items.map(n=>({item_id:n.item?.id||n.item_id||"",item_code:n.item?.item_code||"",item_name:n.item?.item_name||"",item_unit:n.item?.unit?.unit_name||"",qty_to_deposit:n.quantity_required||n.quantity||"",qty_deposited:""}));R("items",c)}}},children:[e.jsx("option",{value:"",children:"Select Material Request"}),m&&m.length>0&&m.map(i=>e.jsxs("option",{value:i.id,children:[i.mr_number," - ",i.department||"Unknown Dept"]},i.id))]})]})}),e.jsx(o,{name:"reason",control:a,render:({field:s})=>e.jsx(C,{...s,label:"Reason for deposing",error:_.reason?.message,placeholder:"Enter reason for deposing"})}),e.jsx(ie,{label:"Deposited By",name:"deposited_by",control:a,branchId:f?.branch?.id||f?.branch_id,error:_.deposited_by?.message}),e.jsx(o,{name:"recieved_by",control:a,render:({field:s})=>e.jsx(C,{...s,label:"Recieved By",error:_.recieved_by?.message})})]}),e.jsxs(W,{title:"Items Requested",children:[e.jsx("div",{className:"flex justify-end mb-2",children:e.jsx(b,{className:"bg-red-600 text-white px-3 py-1",onClick:()=>A({item_id:"",item_name:"",item_code:"",item_unit:"",qty_to_deposit:"",qty_deposited:""}),children:"+ Add Item"})}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(V,{children:[e.jsx(z,{cols:[{title:"Item Name"},{title:"Item Code"},{title:"Item Unit"},{title:"Qty to Deposite"},{title:"Qty Deposited"},{title:"Action"}]}),e.jsx("tbody",{children:P.map((s,i)=>e.jsxs("tr",{className:"align-middle",children:[e.jsx(l,{children:i+1}),e.jsxs(l,{children:[e.jsx(o,{name:`items.${i}.item_id`,control:a,render:()=>{const t=F?.[i],d=t?.item_name,c=t?.item_code;return e.jsx("input",{value:d?`${d} (${c})`:"",className:"w-full h-[45px] rounded-lg border border-gray-300 px-5 mt-1 text-sm bg-gray-50",placeholder:"Item will be auto-filled from MR",readOnly:!0})}}),e.jsx(o,{name:`items.${i}.item_name`,control:a,render:({field:t})=>e.jsx("input",{...t,type:"hidden"})})]}),e.jsx(l,{children:e.jsx(o,{name:`items.${i}.item_code`,control:a,render:({field:t})=>e.jsx("input",{...t,className:"w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm bg-gray-50",placeholder:"Code",readOnly:!0})})}),e.jsx(l,{children:e.jsx(o,{name:`items.${i}.item_unit`,control:a,render:({field:t})=>e.jsx("input",{...t,className:"w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm bg-gray-50",placeholder:"Unit",readOnly:!0})})}),e.jsx(l,{children:e.jsx(o,{name:`items.${i}.qty_to_deposit`,control:a,render:({field:t})=>e.jsx("input",{...t,type:"number",className:"w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm",placeholder:"0"})})}),e.jsx(l,{children:e.jsx(o,{name:`items.${i}.qty_deposited`,control:a,render:({field:t})=>e.jsx("input",{...t,type:"number",className:"w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm",placeholder:"0"})})}),e.jsx(l,{children:e.jsx(Q,{children:e.jsx(G,{onClick:()=>E(i)})})})]},s.id))})]})})]}),e.jsxs("div",{className:"flex justify-end gap-3 mr-5",children:[e.jsx(b,{variant:"outline",onClick:()=>h(-1),children:"Cancel"}),e.jsx(b,{className:"bg-red-600 text-white",onClick:T(U),loading:S,disabled:S,children:r?"Update Deposit Slip":"Submit Deposit Slip"})]})]})};export{ye as default};
