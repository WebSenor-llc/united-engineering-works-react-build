import{u as k,i as M,a as w,r as u,j as e,B as x,h as b,e as y,y as D,A as H}from"./index-B2Kq7pF4.js";import{T as I}from"./TextInput-D6Nk2HMm.js";import{L as Q}from"./ListWrapper-BCNScaty.js";import{T as V}from"./TableActions-v4FwT6Lt.js";import{T as W,a as O,b as l}from"./TableWrapper-jqHXbh_L.js";import{T as z}from"./TableDelete-DKVpIjq0.js";import{u as G,b as J,C as n}from"./index.esm-B19_P2AP.js";import{u as K}from"./useItemsStore-bYVehqqh.js";import{u as X}from"./useMaterialRequestStore-7-sZ9I5l.js";import{L as Y}from"./Loading-OOr2nQlv.js";import{F as Z}from"./FormHeader-CQNygXHB.js";import{B as ee}from"./BranchUserSelect-CRs_p7G6.js";import"./BackButton-D6lHrR0A.js";const te={reason:"",deposited_by:"",recieved_by:"Store",branch_id:"",material_requisition_id:"",item_id:"",quantity_to_deposit:"",quantity_deposited:"",items:[{item_name:"",item_code:"",item_id:"",item_unit:"",qty_to_deposit:"",qty_deposited:""}]},he=()=>{const f=k(),[T]=M(),o=T.get("editId"),{selectedBranchId:_}=w(),{control:d,handleSubmit:R,setValue:c,reset:$,formState:{errors:h}}=G({defaultValues:te}),{fields:A,append:E,remove:F}=J({control:d,name:"items"}),{user:j}=w(),{items:g,fetchItems:q}=K(),{materials:p,fetchMaterials:v}=X();u.useEffect(()=>{q(),v()},[q,v]);const[P,S]=u.useState(!1),[N,C]=u.useState(!1),B=async()=>{if(o){S(!0);try{const s=await b.get(y.deposit_slip.details(Number(o))),i=s.data.slip||s.data;$({branch_id:i.branch_id?String(i.branch_id):_?String(_):"",material_requisition_id:i.material_requisition_id?String(i.material_requisition_id):"",recieved_by:i.recieved_by,deposited_by:i.deposited_by,reason:i.reason||"",items:(i.items||[]).map(t=>({item_id:t.item_id,item_code:t.item?.item_code||"",item_name:t.item?.item_name||"",item_unit:t.unit?.unit_name||"",qty_to_deposit:t.quantity_to_deposit,qty_deposited:t.quantity_deposited}))})}catch(s){console.error("Failed to load details:",s),D.error("Failed to load deposit slip details")}finally{S(!1)}}};u.useEffect(()=>{o&&B()},[o]);const L=async s=>{C(!0);const i={branch_id:_,material_requisition_id:s.material_requisition_id?Number(s.material_requisition_id):null,recieved_by:s.recieved_by,deposited_by:s.deposited_by,reason:s.reason,items:s.items.map(t=>({item_id:Number(t.item_id),quantity_to_deposit:Number(t.qty_to_deposit),quantity_deposited:Number(t.qty_deposited)}))};try{const t=o?y.deposit_slip.update(Number(o)):y.deposit_slip.create;await(o?b.put:b.post)(t,i),f(H.DEPOSITE_SLIP.LIST)}catch(t){console.error(t),D.error(t.response?.data?.message||"Failed to save deposit slip")}finally{C(!1)}};return P?e.jsx("div",{className:"flex justify-center py-20",children:e.jsx(Y,{})}):e.jsxs("div",{className:"w-full h-full overflow-auto space-y-8 p-4 pb-20",children:[e.jsx("div",{className:"space-y-1 ml-2",children:e.jsx(Z,{title:o?"Edit Deposite Slip":"Create Deposite Slip",subtitle:o?"Update the Deposite Slip details":"Fill out the form to submit a new Deposite Slip"})}),e.jsxs("div",{className:"grid grid-cols-2 gap-5 ml-2 mr-5",children:[e.jsx(n,{name:"material_requisition_id",control:d,render:({field:s})=>e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-semibold text-gray-700 mb-1",children:"Material Request"}),e.jsxs("select",{...s,className:"w-full h-[45px] rounded-lg border border-gray-300 px-4 mt-1 text-sm",onChange:i=>{const t=i.target.value;if(s.onChange(t),t){const a=p&&p.find(m=>m.id===Number(t));if(a&&a.items&&a.items.length>0){const m=a.items.map(r=>({item_id:r.item?.id||r.item_id||"",item_code:r.item?.item_code||"",item_name:r.item?.item_name||"",item_unit:r.item?.unit?.unit_name||"",qty_to_deposit:r.quantity_required||r.quantity||"",qty_deposited:""}));c("items",m)}}},children:[e.jsx("option",{value:"",children:"Select Material Request"}),p&&p.length>0&&p.map(i=>e.jsxs("option",{value:i.id,children:[i.mr_number," - ",i.department||"Unknown Dept"]},i.id))]})]})}),e.jsx(n,{name:"reason",control:d,render:({field:s})=>e.jsx(I,{...s,label:"Reason for deposing",error:h.reason?.message,placeholder:"Enter reason for deposing"})}),e.jsx(ee,{label:"Deposited By",name:"deposited_by",control:d,branchId:j?.branch?.id||j?.branch_id,error:h.deposited_by?.message}),e.jsx(n,{name:"recieved_by",control:d,render:({field:s})=>e.jsx(I,{...s,label:"Recieved By",error:h.recieved_by?.message})})]}),e.jsxs(Q,{title:"Items Requested",children:[e.jsx("div",{className:"flex justify-end mb-2",children:e.jsx(x,{className:"bg-red-600 text-white px-3 py-1",onClick:()=>E({item_name:"",item_code:"",item_id:"",item_unit:"",qty_to_deposit:"",qty_deposited:""}),children:"+ Add Item"})}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(W,{children:[e.jsx(O,{cols:[{title:"Item Name"},{title:"Item Code"},{title:"Item Unit"},{title:"Qty to Deposite"},{title:"Qty Deposited"},{title:"Action"}]}),e.jsx("tbody",{children:A.map((s,i)=>e.jsxs("tr",{className:"align-middle",children:[e.jsx(l,{children:i+1}),e.jsx(l,{children:e.jsx(n,{name:`items.${i}.item_code`,control:d,render:({field:t})=>e.jsxs("select",{...t,className:"w-full h-[45px] rounded-lg border border-gray-300 px-5 mt-1 text-sm",onChange:a=>{const m=a.target.value;t.onChange(m);const r=g.find(U=>U.item_code===m);r&&(c(`items.${i}.item_name`,r.item_name),c(`items.${i}.item_code`,r.item_code),c(`items.${i}.item_unit`,r.unit?.unit_name||""),c(`items.${i}.item_id`,r.id))},children:[e.jsx("option",{value:"",children:"Select Item"}),g.map(a=>e.jsxs("option",{value:a.item_code,children:[a.item_name," (",a.item_code,")"]},a.id))]})})}),e.jsx(l,{children:e.jsx(n,{name:`items.${i}.item_code`,control:d,render:({field:t})=>e.jsx("input",{...t,className:"w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm",placeholder:"Code"})})}),e.jsx(l,{children:e.jsx(n,{name:`items.${i}.item_unit`,control:d,render:({field:t})=>e.jsx("input",{...t,className:"w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm",placeholder:"Unit"})})}),e.jsx(l,{children:e.jsx(n,{name:`items.${i}.qty_to_deposit`,control:d,render:({field:t})=>e.jsx("input",{...t,type:"number",className:"w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm",placeholder:"0"})})}),e.jsx(l,{children:e.jsx(n,{name:`items.${i}.qty_deposited`,control:d,render:({field:t})=>e.jsx("input",{...t,type:"number",className:"w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm",placeholder:"0"})})}),e.jsx(l,{children:e.jsx(V,{children:e.jsx(z,{onClick:()=>F(i)})})})]},s.id))})]})})]}),e.jsxs("div",{className:"flex justify-end gap-3 mr-5",children:[e.jsx(x,{variant:"outline",onClick:()=>f(-1),children:"Cancel"}),e.jsx(x,{className:"bg-red-600 text-white",onClick:R(L),loading:N,disabled:N,children:o?"Update Deposit Slip":"Submit Deposit Slip"})]})]})};export{he as default};
