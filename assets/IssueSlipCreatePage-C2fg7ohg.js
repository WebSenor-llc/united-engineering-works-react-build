import{u as Y,i as z,a as G,r as d,h as y,e as b,y as f,j as e,B as S,A as J}from"./index-DhMZcEWH.js";import{F as K}from"./FormHeader-q8flXnZy.js";import{T as j}from"./TextInput-CdFPDpMI.js";import{S as X}from"./Select-B4-faB1N.js";import{L as Z}from"./ListWrapper-CgjZDznb.js";import{T as ee}from"./TableActions-CbKw7GQR.js";import{T as se,a as te,b as u}from"./TableWrapper-oo68n9a4.js";import{T as re}from"./TableDelete-CFuZEci9.js";import{u as ie,b as ae,C as n}from"./index.esm-1Qhp7SJI.js";import{L as le}from"./Loading-DarExsNw.js";import{u as ne}from"./useMachineStore-DusRefB4.js";import{u as oe}from"./useMaterialRequestStore-DusWmTpJ.js";import{o as me,k as de}from"./yup-BkN1j3wo.js";import"./BackButton-BoDxxzd1.js";const h={mr:"",machine:"",for_party:"",for_mines:"",issued_to:"",purpose:"",items:[{item_name:"",item_code:"",item_id:"",item_unit:"",required_qty:"",issued_qty:""}]},Ie=()=>{const q=Y(),[E]=z(),i=E.get("editId"),{selectedBranchId:F}=G(),{materials:o,fetchMaterials:N}=oe(),[P,I]=d.useState(!1),[v,M]=d.useState(!1),{machines:$,fetchMachines:w}=ne(),{control:l,handleSubmit:k,setValue:c,reset:C,watch:A,formState:{errors:p}}=ie({defaultValues:h,resolver:me(de)}),{fields:L,append:D,remove:U}=ae({control:l,name:"items"}),a=A("mr");d.useEffect(()=>{N(),w()},[N,w]);const T=d.useCallback(async t=>{try{const s=o&&o.find(_=>_.mr_number===t);if(!s)return;const g=(await y.get(b.material_requisition.details(s.id))).data?.material_requisition;if(g?.items?.length>0){const _=g.items.map(m=>{const x=m.item,B=x?.id||m.item_id,H=x?.item_name||m.item_name,Q=x?.item_code||m.item_code,V=x?.unit?.unit_name||m.unit?.unit_name||m.item_unit,W=m.quantity_required||m.quantity||m.required_qty;return{item_id:B?.toString()||"",item_name:H||"",item_code:Q||"",item_unit:V||"",required_qty:W?.toString()||"",issued_qty:""}});c("items",_),f.success(`Loaded ${_.length} items from MR ${t}`)}else c("items",h.items),f.info("No items found for the selected MR")}catch(s){console.error("Failed to fetch MR details:",s),f.error("Failed to load MR details")}},[o,c]),R=d.useCallback(async()=>{if(i){I(!0);try{const t=await y.get(b.issue_slips.details(Number(i))),s=t.data.slip||t.data.data||t.data;C({mr:s.mr,machine:s.machine?String(s.machine):"",for_party:s.for_party??"",for_mines:s.for_mines??"",issued_to:s.issued_for??"",purpose:s.purpose??"",items:s.items?.map(r=>({item_id:r.item_id?.toString()||"",item_code:r.item?.item_code||"",item_name:r.item?.item_name||"",item_unit:r.item?.unit?.unit_name||"",required_qty:r.required_qty?.toString()||"",issued_qty:r.issued_qty?.toString()||""}))||h.items})}finally{I(!1)}}},[i,C]);d.useEffect(()=>{i&&R()},[i,R]),d.useEffect(()=>{a&&!i&&o&&o.length>0?T(a):!a&&!i&&c("items",h.items)},[a,i,o,T,c]);const O=async t=>{M(!0);const s={mr:t.mr,branch_id:F,machine_id:t.machine?Number(t.machine):null,for_party:t.for_party,for_mines:t.for_mines,issued_for:t.issued_to,purpose:t.purpose,items:t.items.filter(r=>r.item_id).map(r=>({item_id:Number(r.item_id),required_qty:Number(r.required_qty)||0,issued_qty:Number(r.issued_qty),transaction_type:"opening_stock"}))};try{const r=i?b.issue_slips.update(Number(i)):b.issue_slips.create;await(i?y.put:y.post)(r,s),f.success(i?"Issue slip updated successfully":"Issue slip created successfully"),q(J.ISSUE_SLIP.LIST)}catch(r){console.error(r),f.error(r.response?.data?.message||"Failed to save issue slip")}finally{M(!1)}};return P?e.jsx("div",{className:"flex justify-center py-20",children:e.jsx(le,{})}):e.jsxs("div",{className:"w-full h-full overflow-auto space-y-8 p-4 pb-20",children:[e.jsx(K,{title:i?"Edit Issue Slip":"Create Issue Slip",subtitle:i?"Update the Issue Slip details":"Fill out the form to submit a new Issue Slip"}),e.jsxs("div",{className:"grid grid-cols-2 gap-5 ml-2 mr-5",children:[e.jsx(n,{name:"mr",control:l,render:({field:t})=>e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-semibold text-gray-700 mb-1",children:"Issued To MR"}),e.jsxs("select",{...t,disabled:!!i,className:"w-full h-[45px] rounded-lg border border-gray-300 px-4 mt-1 text-sm",children:[e.jsx("option",{value:"",children:"Select Material Requisition"}),o&&o.length>0?o.map(s=>e.jsxs("option",{value:s.mr_number,children:[s.mr_number," - ",s.department||"Unknown Dept"]},s.mr_number)):e.jsx("option",{disabled:!0,children:"No Material Requisitions Available"})]})]})}),e.jsx(n,{name:"machine",control:l,render:({field:t})=>e.jsxs(X,{...t,label:"For Machine",error:p.machine?.message,children:[e.jsx("option",{value:"",children:"Select Machine"}),$.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})}),e.jsx(n,{name:"for_party",control:l,render:({field:t})=>e.jsx(j,{...t,label:"For Party",placeholder:"Enter Party Name",error:p.for_party?.message})}),e.jsx(n,{name:"for_mines",control:l,render:({field:t})=>e.jsx(j,{...t,label:"For Mines",placeholder:"Enter Mine",error:p.for_mines?.message})}),e.jsx(n,{name:"issued_to",control:l,render:({field:t})=>e.jsx(j,{...t,label:"Issued To",placeholder:"Enter Name ",error:p.issued_to?.message})}),e.jsx(n,{name:"purpose",control:l,render:({field:t})=>e.jsx(j,{...t,label:"Purpose",placeholder:"Enter Purpose",error:p.purpose?.message})})]}),e.jsxs(Z,{title:"Items to Issue",children:[e.jsx("div",{className:"flex justify-end mb-2",children:!a&&e.jsx(S,{className:"bg-red-600 text-white px-3 py-1",onClick:()=>D({...h.items[0]}),children:"+ Add Item"})}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(se,{children:[e.jsx(te,{cols:[{title:"Item Name"},{title:"Item Code"},{title:"Item Unit"},{title:"Required QTY"},{title:"Issued QTY"},{title:"Action"}]}),e.jsx("tbody",{children:L.map((t,s)=>e.jsxs("tr",{className:"align-middle",children:[e.jsx(u,{children:s+1}),e.jsx(u,{children:e.jsx(n,{name:`items.${s}.item_name`,control:l,render:({field:r})=>e.jsx("input",{...r,readOnly:!!a,className:`w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm ${a?"bg-gray-50":""}`,placeholder:"Item Name"})})}),e.jsx(u,{children:e.jsx(n,{name:`items.${s}.item_code`,control:l,render:({field:r})=>e.jsx("input",{...r,readOnly:!!a,className:`w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm ${a?"bg-gray-50":""}`,placeholder:"Code"})})}),e.jsx(u,{children:e.jsx(n,{name:`items.${s}.item_unit`,control:l,render:({field:r})=>e.jsx("input",{...r,readOnly:!!a,className:`w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm ${a?"bg-gray-50":""}`,placeholder:"Unit"})})}),e.jsx(u,{children:e.jsx(n,{name:`items.${s}.required_qty`,control:l,render:({field:r})=>e.jsx("input",{...r,type:"number",readOnly:!!a,className:`w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm ${a?"bg-gray-50":""}`,placeholder:"0"})})}),e.jsx(u,{children:e.jsx(n,{name:`items.${s}.issued_qty`,control:l,render:({field:r})=>e.jsx("input",{...r,type:"number",className:"w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm",placeholder:"0"})})}),e.jsx(ee,{children:!a&&e.jsx(re,{onClick:()=>U(s)})})]},t.id))})]})})]}),e.jsxs("div",{className:"flex justify-end gap-3 mr-5",children:[e.jsx(S,{variant:"outline",onClick:()=>q(-1),children:"Cancel"}),e.jsx(S,{className:"bg-red-600 text-white",onClick:k(O),loading:v,disabled:v,children:i?"Update Issue Slip":"Submit Issue Slip"})]})]})};export{Ie as default};
