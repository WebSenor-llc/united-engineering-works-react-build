import{u as X,i as Y,a as Z,r as p,j as e,B as I,h as f,e as j,y as g,A as w}from"./index-B2Kq7pF4.js";import{F as ee}from"./FormHeader-CQNygXHB.js";import{T as q}from"./TextInput-D6Nk2HMm.js";import{L as te}from"./ListWrapper-BCNScaty.js";import{T as re}from"./TableActions-v4FwT6Lt.js";import{T as ae,a as se,b as d}from"./TableWrapper-jqHXbh_L.js";import{T as ne}from"./TableDelete-DKVpIjq0.js";import{u as ie,b as le,C as o}from"./index.esm-B19_P2AP.js";import{u as oe}from"./useItemsStore-bYVehqqh.js";import{L as ce}from"./Loading-OOr2nQlv.js";import"./BackButton-D6lHrR0A.js";const y={department_from:"Store Department",department_to:"",grn_number:"",grn_date:"",ms:"",items:[{item_id:"",item_code:"",description_of_goods:"",unit:"",qty:"",thick_bl:"",length_bl:"",width_bl:"",thick_actual:"",length_actual:"",width_actual:"",accepted_qty:"",rejected_qty:"",reason_if_reject:"",remark:""}]},ye=()=>{const x=X(),[G]=Y(),u=G.get("id"),l=G.get("grnId"),{selectedBranchId:O}=Z(),[T,L]=p.useState(!1),[F,N]=p.useState(!1),k=p.useRef(null),{control:i,handleSubmit:B,setValue:m,watch:W,reset:$}=ie({defaultValues:y}),[R,E]=p.useState([]),[S,M]=p.useState(!1),[P,U]=p.useState(null),{items:A,loading:V,fetchItems:C}=oe(),{fields:H,append:Q}=le({control:i,name:"items"}),z=async()=>{M(!0);try{const n=await f.get(j.grn.pendingInspection);E(n.data?.grns||n.data?.data||[])}catch(n){console.error("Error fetching GRNs for inspection:",n),E([])}finally{M(!1)}};p.useEffect(()=>{C(),z()},[C]),p.useEffect(()=>{if(!u)return;(async()=>{N(!0);try{const r=await f.get(j.material_inspection_report.details(parseInt(u,10))),t=r.data?.report||r.data?.data||r.data,s=(t.items||[]).map(a=>({item_id:a.item_id?.toString()||"",item_code:a.item?.item_code||"",description_of_goods:a.item?.item_name||"",unit:a.item?.unit?.unit_name||"",qty:a.quantity?.toString()||"",thick_bl:a.bill_thick?.toString()||"",length_bl:a.bill_length?.toString()||"",width_bl:a.bill_width?.toString()||"",thick_actual:a.actual_req_thick?.toString()||"",length_actual:a.actual_req_length?.toString()||"",width_actual:a.actual_req_width?.toString()||"",accepted_qty:a.accepted_quantity?.toString()||"",rejected_qty:a.rejected_quantity?.toString()||"",reason_if_reject:a.reject_reason||"",remark:""}));$({department_from:t.from_department||y.department_from,department_to:t.to_department||y.department_to,grn_number:t.grn_number||"",grn_date:"",ms:t.ms||"",items:s.length>0?s:y.items})}catch(r){console.error(r),g.error("Failed to load inspection report details"),x(w.MATERIAL_INSPECTION_REPORT.LIST)}finally{N(!1)}})()},[u,$,x]),p.useEffect(()=>{if(!l)return;(async()=>{N(!0);try{const r=await f.get(j.grn.details(parseInt(l,10))),t=r.data?.grn||r.data?.data||r.data;if(!t){g.error("GRN not found"),x(w.GOOD_RECEIVE_REPORT.LIST);return}U(t);const s=a=>{if(!a)return"";const[c]=a.split("T"),[b,v,K]=c.split("-");return`${K}-${v}-${b}`};if(m("grn_number",t.grn_number||""),m("grn_date",s(t.grn_date||"")),m("ms",t.vendor?.party_name||""),t.items?.length){const a=t.items.map(c=>({item_id:c.item_id?.toString()||"",item_code:c.item?.item_code||"",description_of_goods:c.item?.item_name||"",unit:c.item?.unit?.unit_name||"PCS",qty:c.quantity_received?.toString()||"",thick_bl:"",length_bl:"",width_bl:"",thick_actual:"",length_actual:"",width_actual:"",accepted_qty:c.quantity_received?.toString()||"",rejected_qty:"0",reason_if_reject:c.inspection_remarks||"",remark:c.remarks||""}));m("items",a)}}catch(r){console.error(r),g.error("Failed to load GRN details"),x(w.GOOD_RECEIVE_REPORT.LIST)}finally{N(!1)}})()},[l,m,x]);const _=p.useMemo(()=>l?[]:R.filter(n=>n.status==="pending_inspection"),[R,l]);p.useEffect(()=>{R.length===0&&console.log("No GRNs available for inspection")},[R.length,_.length,l]);const h=W("grn_number"),D=p.useCallback(n=>{if(!n){k.current=null,m("items",y.items);return}if(k.current===n||_.length===0)return;const r=_.find(s=>s.grn_number===n);if(!r)return;if(k.current=n,m("grn_date",(s=>{if(!s)return"";const[a]=s.split("T"),[c,b,v]=a.split("-");return`${v}-${b}-${c}`})(r.grn_date)),m("ms",r.vendor?.party_name||""),r.items?.length){const s=r.items.map(a=>({item_id:a.item_id?.toString()||"",item_code:a.item?.item_code||"",description_of_goods:a.item?.item_name||"",unit:a.item?.unit?.unit_name||"PCS",qty:a.quantity_received?.toString()||"",thick_bl:"",length_bl:"",width_bl:"",thick_actual:"",length_actual:"",width_actual:"",accepted_qty:a.quantity_received?.toString()||"",rejected_qty:"0",reason_if_reject:a.inspection_remarks||"",remark:a.remarks||""}));m("items",s,{shouldDirty:!1})}},[_,m]);p.useEffect(()=>{!l&&h&&_.length>0&&D(h)},[h,D,l,_.length]);const J=async n=>{try{L(!0);const r=(n.items||[]).map(s=>({item_id:s.item_id?Number(s.item_id):void 0,quantity:s.qty?Number(s.qty):0,bill_thick:s.thick_bl?Number(s.thick_bl):0,bill_length:s.length_bl?Number(s.length_bl):0,bill_width:s.width_bl?Number(s.width_bl):0,actual_req_thick:s.thick_actual?Number(s.thick_actual):0,actual_req_length:s.length_actual?Number(s.length_actual):0,actual_req_width:s.width_actual?Number(s.width_actual):0,accepted_quantity:s.accepted_qty?Number(s.accepted_qty):0,rejected_quantity:s.rejected_qty?Number(s.rejected_qty):0,reject_reason:s.reason_if_reject||""})),t={from_department:n.department_from,to_department:n.department_to,grn_number:n.grn_number,ms:n.ms,grn_id:l?parseInt(l,10):P?.id||null,branch_id:O,items:r};u?(await f.put(j.material_inspection_report.update(parseInt(u,10)),t),g.success("Material inspection report updated successfully")):(await f.post(j.material_inspection_report.create,t),g.success("Material inspection report created successfully")),x(w.MATERIAL_INSPECTION_REPORT.LIST)}catch(r){console.error(r),g.error(r?.response?.data?.message||`Failed to ${u?"update":"create"} material inspection report`)}finally{L(!1)}};return F?e.jsx("div",{className:"flex justify-center py-20",children:e.jsx(ce,{})}):e.jsxs("div",{className:"w-full h-full overflow-auto space-y-8 p-4 pb-20",children:[e.jsx("div",{className:"space-y-1 ml-2",children:e.jsx(ee,{title:u?"Edit Material Inspection Report Form":"Material Inspection Report Form",subtitle:u?"Update the Material Inspection Report details":"Fill out the form to submit a new material inspection report."})}),e.jsxs("div",{className:"grid grid-cols-2 gap-5 ml-2 mr-5",children:[e.jsx(o,{name:"department_from",control:i,render:({field:n})=>e.jsx(q,{required:!0,...n,label:"Department From"})}),e.jsx(o,{name:"department_to",control:i,render:({field:n})=>e.jsx(q,{required:!0,...n,label:"Department To"})}),e.jsx(o,{name:"grn_number",control:i,render:({field:n})=>e.jsxs("div",{children:[e.jsxs("label",{className:"text-sm font-semibold text-gray-700 mb-1",children:["GRN Number",!l&&e.jsx("span",{className:"text-xs text-gray-500 ml-2",children:"(Only GRNs pending inspection)"})]}),l?e.jsx("input",{...n,readOnly:!0,className:"w-full h-[45px] rounded-lg border border-gray-300 px-4 mt-1 text-sm bg-gray-50"}):e.jsxs("select",{...n,className:"w-full h-[45px] rounded-lg border border-gray-300 px-4 mt-1 text-sm",children:[e.jsx("option",{value:"",children:S?"Loading...":"Select GRN"}),_.length===0&&!S?e.jsx("option",{value:"",disabled:!0,children:"No GRNs pending inspection"}):_.map(r=>e.jsxs("option",{value:r.grn_number,children:[r.grn_number," - ",r.vendor?.party_name||"Unknown Vendor"]},r.id))]}),!l&&_.length===0&&!S&&e.jsx("p",{className:"text-xs text-amber-600 mt-1",children:"No GRNs are currently pending inspection. Please ensure GRNs have been created and are awaiting inspection."}),l&&e.jsx("p",{className:"text-xs text-green-600 mt-1",children:"Items loaded from selected GRN for inspection."}),!l&&h&&e.jsx("p",{className:"text-xs text-green-600 mt-1",children:"Items will be automatically loaded from the selected GRN."})]})}),e.jsx(o,{name:"grn_date",control:i,render:({field:n})=>e.jsx(q,{...n,label:"GRN Date",placeholder:"Date",readOnly:!0})}),e.jsx(o,{name:"ms",control:i,render:({field:n})=>e.jsx(q,{...n,label:"M/S"})})]}),e.jsxs(te,{title:"Items for Inspection",children:[h||l?e.jsx("div",{className:"flex justify-between items-center mb-2",children:e.jsxs("div",{className:"text-sm text-blue-600 bg-blue-50 px-3 py-2 rounded-lg",children:[e.jsx("span",{className:"font-medium",children:"Items loaded from GRN:"})," ",h||P?.grn_number]})}):e.jsx("div",{className:"flex justify-end mb-2",children:e.jsx(I,{className:"bg-red-600 text-white px-3 py-1",onClick:()=>Q({item_id:"",item_code:"",description_of_goods:"",unit:"",qty:"",thick_bl:"",length_bl:"",width_bl:"",thick_actual:"",length_actual:"",width_actual:"",accepted_qty:"",rejected_qty:"",reason_if_reject:"",remark:""}),children:"+ Add Item"})}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(ae,{children:[e.jsx(se,{cols:[{title:"Description of Goods"},{title:"Item Code"},{title:"Unit"},{title:"Received Qty"},{title:"Thick in MM (B/L)"},{title:"Length in MM (B/L)"},{title:"Width in MM (B/L)"},{title:"Thick in MM (Actual)"},{title:"Length in MM (Actual)"},{title:"Width in MM (Actual)"},{title:"Accepted Qty"},{title:"Rejected Qty"},{title:"Reason If Reject"},{title:"Remark"},{title:"Actions"}]}),e.jsx("tbody",{children:H.map((n,r)=>e.jsxs("tr",{className:"align-middle",children:[e.jsx(d,{children:r+1}),e.jsx(d,{children:e.jsx(o,{name:`items.${r}.description_of_goods`,control:i,render:({field:t})=>t.value&&(h||l)?e.jsx("input",{...t,readOnly:!0,className:"w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm bg-gray-50",placeholder:"Item Name"}):e.jsxs("select",{...t,className:"w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm",onChange:a=>{t.onChange(a);const c=A.find(b=>b.item_name===a.target.value);c&&(m(`items.${r}.item_code`,c.item_code),m(`items.${r}.unit`,c.unit?.unit_name||""),m(`items.${r}.item_id`,c.id.toString()))},children:[e.jsx("option",{value:"",children:V?"Loading...":"Select Item"}),A.map(a=>e.jsx("option",{value:a.item_name,children:a.item_name},a.id))]})})}),e.jsx(d,{children:e.jsx(o,{name:`items.${r}.item_code`,control:i,render:({field:t})=>e.jsx("input",{...t,readOnly:!0,className:"w-[80px] h-[40px] border border-gray-300 rounded-lg px-3 text-sm bg-gray-50",placeholder:"Code"})})}),e.jsx(d,{children:e.jsx(o,{name:`items.${r}.unit`,control:i,render:({field:t})=>e.jsx("input",{...t,readOnly:!0,className:"w-[80px] h-[40px] border border-gray-300 rounded-lg px-3 text-sm bg-gray-50",placeholder:"Unit"})})}),e.jsx(d,{children:e.jsx(o,{name:`items.${r}.qty`,control:i,render:({field:t})=>e.jsx("input",{...t,type:"number",className:"w-[100px] h-[40px] border border-gray-300 rounded-lg px-3 text-sm",placeholder:"0"})})}),e.jsx(d,{children:e.jsx(o,{name:`items.${r}.thick_bl`,control:i,render:({field:t})=>e.jsx("input",{...t,className:"w-[127px] h-[40px] border border-gray-300 rounded-lg px-3 text-sm",placeholder:"Thick (B/L)"})})}),e.jsx(d,{children:e.jsx(o,{name:`items.${r}.length_bl`,control:i,render:({field:t})=>e.jsx("input",{...t,className:"w-[127px] h-[40px] border border-gray-300 rounded-lg px-3 text-sm",placeholder:"Length (B/L)"})})}),e.jsx(d,{children:e.jsx(o,{name:`items.${r}.width_bl`,control:i,render:({field:t})=>e.jsx("input",{...t,className:"w-[127px] h-[40px] border border-gray-300 rounded-lg px-3 text-sm",placeholder:"Width (B/L)"})})}),e.jsx(d,{children:e.jsx(o,{name:`items.${r}.thick_actual`,control:i,render:({field:t})=>e.jsx("input",{...t,className:"w-[127px] h-[40px] border border-gray-300 rounded-lg px-3 text-sm",placeholder:"Thick (Actual)"})})}),e.jsx(d,{children:e.jsx(o,{name:`items.${r}.length_actual`,control:i,render:({field:t})=>e.jsx("input",{...t,className:"w-[127px] h-[40px] border border-gray-300 rounded-lg px-3 text-sm",placeholder:"Length (Actual)"})})}),e.jsx(d,{children:e.jsx(o,{name:`items.${r}.width_actual`,control:i,render:({field:t})=>e.jsx("input",{...t,className:"w-[127px] h-[40px] border border-gray-300 rounded-lg px-3 text-sm",placeholder:"Width (Actual)"})})}),e.jsx(d,{children:e.jsx(o,{name:`items.${r}.accepted_qty`,control:i,render:({field:t})=>e.jsx("input",{...t,type:"number",className:"w-[100px] h-[40px] border border-gray-300 rounded-lg px-3 text-sm",placeholder:"0"})})}),e.jsx(d,{children:e.jsx(o,{name:`items.${r}.rejected_qty`,control:i,render:({field:t})=>e.jsx("input",{...t,type:"number",className:"w-[100px] h-[40px] border border-gray-300 rounded-lg px-3 text-sm",placeholder:"0"})})}),e.jsx(d,{children:e.jsx(o,{name:`items.${r}.reason_if_reject`,control:i,render:({field:t})=>e.jsx("input",{...t,className:"w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm",placeholder:"Reason"})})}),e.jsx(d,{children:e.jsx(o,{name:`items.${r}.remark`,control:i,render:({field:t})=>e.jsx("input",{...t,className:"w-full h-[40px] border border-gray-300 rounded-lg px-3 text-sm",placeholder:"Remark"})})}),e.jsx(d,{children:e.jsxs(re,{children:[!(h||l)&&e.jsx(ne,{}),(h||l)&&e.jsx("span",{className:"text-xs text-gray-500 px-2",children:"From GRN"})]})})]},n.id))})]})})]}),e.jsxs("div",{className:"flex justify-end gap-3 mr-5",children:[e.jsx(I,{variant:"outline",onClick:()=>x(-1),children:"Cancel"}),e.jsx(I,{className:"bg-red-600 text-white",onClick:B(J),loading:T,disabled:T,children:u?"Update Report":"Submit Report"})]})]})};export{ye as default};
