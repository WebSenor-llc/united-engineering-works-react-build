import{u as L,i as R,a as H,r as m,j as e,B as T,A as w,h as x,e as g,y as u}from"./index-CbNhh14T.js";import{u as K,C as o}from"./index.esm-CzaEKZ5d.js";import{T as l}from"./TextInput-B3FUDRfG.js";import{T as j}from"./TextArea-CSFBQe0e.js";import{S as p}from"./Select-DdY8wYe_.js";import{F as Q}from"./FormHeader-Ck__6gFL.js";import{B as V,I as J}from"./ImageUpload-DmenJsnb.js";import{L as W}from"./Loading-DBMuoTO4.js";import{u as z}from"./useMachineStore-DsGA3JCJ.js";import{o as G,y as X}from"./yup-3BgDdNf1.js";import{u as Y}from"./usePartyStore-8wvpsiGV.js";const de=()=>{const y=L(),[A]=R(),n=A.get("editId"),{selectedBranchId:d}=H(),[D,v]=m.useState(!1),[E,f]=m.useState(!1),{parties:_,fetchParties:N}=Y(),[q,P]=m.useState(null),{machines:I,fetchMachines:k}=z(),S={job_name:"",task_card_no:"",job_date:new Date().toISOString().split("T")[0],department:"Production Department",job_description:"",quantity:1,expected_delivery_date:"",job_type:"",priority:"Normal",customer_id:"",customer_name:"",customer_contact:"",customer_address:"",supervisor_id:"",supervisor_address:"",branch_id:d?Number(d):0,machine_used:"",challan_no:"",challan_date:"",invoice_no:"",po_no:"",remarks:"",images:[],note:""},{control:t,handleSubmit:F,setValue:c,watch:O,reset:C,formState:{errors:i}}=K({defaultValues:S,resolver:G(X,{context:{isEdit:!!n}})}),b=O("customer_id"),M=async r=>{if(r)try{const a=(await x.get(g.user_management.all,{params:{branch_id:r}})).data.users.filter(h=>h.role.role_name==="Workshop Supervisor");P(a)}catch(s){console.log(s),u.error("Failed to fetch users")}};m.useEffect(()=>{N(),k(),d&&M(Number(d))},[N,k,d]),m.useEffect(()=>{if(b&&_.length>0){const r=_.find(s=>s.id===Number(b));r&&(c("customer_name",r.party_name),c("customer_contact",r.phone||""),c("customer_address",r.address||""))}},[b,_,c]),m.useEffect(()=>{n&&(async()=>{v(!0);try{const s=await x.get(g.task_cards.details(Number(n))),a=s.data?.task_card||s.data;C({...S,...a,task_card_no:a.task_card_number,branch_id:a.branch_id?Number(a.branch_id):0,supervisor_id:a.allocated_supervisor_id?String(a.allocated_supervisor_id):"",customer_id:a.customer_id?String(a.customer_id):"",customer_name:a.customer?.party_name||"",customer_contact:a.customer?.contact_number||"",customer_address:a.customer?.address||"",po_no:a.customer_po_number||"",challan_no:a.challan_number||"",invoice_no:a.invoice_number||"",machine_used:a.machine_required?String(a.machine_required):"",priority:a.priority||"Normal",job_date:a.task_date?a.task_date.split("T")[0]:"",expected_delivery_date:a.expected_delivery_date?a.expected_delivery_date.split("T")[0]:"",challan_date:a.challan_date?a.challan_date.split("T")[0]:"",note:a.note||""})}catch(s){console.error(s),u.error("Failed to load task order details")}finally{v(!1)}})()},[n,C]);const U=async r=>{console.log("Form submitted with data:",r),console.log("Form errors:",i),f(!0);try{const s={task_date:r.job_date,job_name:r.job_name,department:r.department||"Production Department",customer_id:r.customer_id?Number(r.customer_id):null,branch_id:d?Number(d):null,job_description:r.job_description,job_type:r.job_type,priority:r.priority,quantity:Number(r.quantity),expected_delivery_date:r.expected_delivery_date,allocated_supervisor_id:r.supervisor_id?Number(r.supervisor_id):null,machine_required:r.machine_used?Number(r.machine_used):null,challan_number:r.challan_no,challan_date:r.challan_date,invoice_number:r.invoice_no,customer_po_number:r.po_no,remarks:r.remarks,note:r.note,images:[]};console.log("Payload being sent:",s),n?(await x.put(g.task_cards.update(Number(n)),s),u.success("Task Card updated successfully")):(await x.post(g.task_cards.create,s),u.success("Task Card created successfully")),y(w.TASK_CARD.LIST)}catch(s){console.error("Submission error:",s),u.error(s.response?.data?.message||"Failed to submit task card")}finally{f(!1)}};return D?e.jsx("div",{className:"flex justify-center items-center h-[500px]",children:e.jsx(W,{})}):e.jsx("div",{className:"w-full h-full p-2 sm:p-4 lg:p-6 overflow-y-auto pb-20",children:e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsx(Q,{title:n?"Edit Task Card":"Create Task Card",subtitle:n?"Update Task Order details":"Create a new Task Order"}),e.jsxs("form",{onSubmit:F(U),className:"space-y-4 sm:space-y-6 mt-4",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 sm:gap-4",children:[e.jsx(o,{name:"job_name",control:t,rules:{required:"task Name is required"},render:({field:r})=>e.jsx(l,{...r,label:"Task Name",required:!0,error:i.job_name?.message,placeholder:"e.g. Engine Overhaul"})}),n&&e.jsx(o,{name:"task_card_no",control:t,rules:{required:"Task Card No is required"},render:({field:r})=>e.jsx(l,{...r,label:"Task Card No.",required:!0,error:i.task_card_no?.message,placeholder:"TC-2023...",readOnly:!0})}),e.jsx(o,{name:"job_date",control:t,rules:{required:"Date is required"},render:({field:r})=>e.jsx(l,{...r,type:"date",label:"Date",required:!0,error:i.job_date?.message})}),e.jsx(o,{name:"department",control:t,rules:{required:"Department is required"},render:({field:r})=>e.jsx(l,{...r,type:"department",label:"Department",required:!0,error:i.department?.message})})]}),e.jsx("div",{className:"w-full",children:e.jsx(o,{name:"job_description",control:t,rules:{required:"Job Description is required"},render:({field:r})=>e.jsx(j,{...r,label:"Task Description",placeholder:"Describe the task details...",rows:3,required:!0,error:i.job_description?.message})})}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 sm:gap-4",children:[e.jsx(o,{name:"quantity",control:t,rules:{required:"Quantity is required",min:1},render:({field:r})=>e.jsx(l,{...r,type:"number",label:"Quantity",required:!0,error:i.quantity?.message,placeholder:"Enter quantity"})}),e.jsx(o,{name:"expected_delivery_date",control:t,rules:{required:"Expected Delivery is required"},render:({field:r})=>e.jsx(l,{...r,type:"date",label:"Expected Delivery",required:!0,error:i.expected_delivery_date?.message})}),e.jsx(o,{name:"job_type",control:t,rules:{required:"Task Type is required"},render:({field:r})=>e.jsxs(p,{...r,label:"Task Type",required:!0,error:i.job_type?.message,children:[e.jsx("option",{value:"",children:"Select task type"}),e.jsx("option",{value:"amc",children:"AMC"}),e.jsx("option",{value:"new_job",children:"New Task"}),e.jsx("option",{value:"in_house_manufacturing",children:"In house"}),e.jsx("option",{value:"repair",children:"Repair"}),e.jsx("option",{value:"service",children:"Service"})]})}),e.jsx(o,{name:"priority",control:t,rules:{required:"Priority is required"},render:({field:r})=>e.jsxs(p,{...r,label:"Priority",required:!0,error:i.priority?.message,children:[e.jsx("option",{value:"",children:"Select priority"}),e.jsx("option",{value:"Urgent",children:"High"}),e.jsx("option",{value:"Emergency",children:"Medium"}),e.jsx("option",{value:"Normal",children:"Low"})]})})]}),e.jsx("h3",{className:"text-base sm:text-lg font-semibold text-gray-800 border-b pb-1 mt-4 sm:mt-6",children:"Customer Information"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4",children:[e.jsx(o,{name:"customer_id",control:t,rules:{required:"Customer is required"},render:({field:r})=>e.jsxs(p,{...r,label:"Customer Name",required:!0,error:i.customer_id?.message,children:[e.jsx("option",{value:"",children:"Select Customer"}),_.filter(s=>s.party_type==="customer").map(s=>e.jsx("option",{value:s.id,children:s.party_name},s.id))]})}),e.jsx(o,{name:"customer_contact",control:t,render:({field:r})=>e.jsx(l,{...r,label:"Customer Contact",placeholder:"Auto-filled from customer",readOnly:!0,className:"bg-gray-100"})}),e.jsx(o,{name:"customer_address",control:t,render:({field:r})=>e.jsx(l,{...r,label:"Customer Address",placeholder:"Auto-filled from customer",readOnly:!0,className:"bg-gray-100"})})]}),e.jsx("h3",{className:"text-base sm:text-lg font-semibold text-gray-800 border-b pb-1 mt-4 sm:mt-6",children:"Assignment"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4",children:[e.jsx(o,{name:"supervisor_id",control:t,rules:{required:"Supervisor is required"},render:({field:r})=>e.jsxs(p,{...r,label:"Allocated Supervisor",required:!0,error:i.supervisor_id?.message,onChange:s=>{const a=s.target.value;r.onChange(a);const h=q?.find(B=>String(B.id)===String(a));h?c("supervisor_address",h.address||""):c("supervisor_address","")},children:[e.jsx("option",{value:"",children:"Select Supervisor"}),q?.map(s=>e.jsx("option",{value:s.id,children:s.full_name},s.id))]})}),e.jsx(V,{control:t,name:"branch_id",label:"Branch Name",required:!0,error:i.branch_id?.message}),e.jsx(o,{name:"machine_used",control:t,rules:{required:"Machine is required"},render:({field:r})=>e.jsxs(p,{...r,label:"Machine Used",required:!0,error:i.machine_used?.message,children:[e.jsx("option",{value:"",children:"Select Machine"}),I.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})})]}),e.jsx("h3",{className:"text-base sm:text-lg font-semibold text-gray-800 border-b pb-1 mt-4 sm:mt-6",children:"Internal Tracking"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 sm:gap-4",children:[e.jsx(o,{name:"challan_no",control:t,render:({field:r})=>e.jsx(l,{...r,label:"Challan No.",placeholder:"Enter challan number"})}),e.jsx(o,{name:"challan_date",control:t,render:({field:r})=>e.jsx(l,{...r,type:"date",label:"Challan Date"})}),e.jsx(o,{name:"invoice_no",control:t,render:({field:r})=>e.jsx(l,{...r,label:"Invoice No.",placeholder:"Enter invoice number"})}),e.jsx(o,{name:"po_no",control:t,render:({field:r})=>e.jsx(l,{...r,label:"PO No.",placeholder:"Enter PO number"})})]}),e.jsx("div",{className:"w-full",children:e.jsx(o,{name:"remarks",control:t,render:({field:r})=>e.jsx(j,{...r,label:"Remarks",placeholder:"Add any additional notes or remarks...",rows:3})})}),e.jsx("div",{className:"w-full",children:e.jsx(o,{name:"note",control:t,render:({field:r})=>e.jsx(j,{...r,label:"Note",placeholder:"Add any additional notes or comments...",error:i.note?.message,rows:3})})}),e.jsx("div",{className:"w-full",children:e.jsx(o,{name:"images",control:t,render:({field:r})=>e.jsx(J,{value:r.value,onChange:r.onChange,error:i.images?.message,maxFiles:6})})}),e.jsxs("div",{className:"flex flex-col sm:flex-row justify-end gap-3 pt-4 sm:pt-6",children:[e.jsx(T,{variant:"outline",type:"button",className:"w-full sm:w-auto order-2 sm:order-1",onClick:()=>y(w.TASK_CARD.LIST),children:"Cancel"}),e.jsx(T,{type:"submit",loading:E,className:"bg-blue-600 text-white w-full sm:w-auto order-1 sm:order-2",children:n?"Update Task Card":"Save Task Card"})]})]})]})})};export{de as default};
