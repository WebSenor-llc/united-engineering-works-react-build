import{r as w,j as e,a as $,ab as n,h as z,e as A,y as _,u as Z,k as X,D as W,P as J,A as H}from"./index-gVZAAP-J.js";import{L as Y}from"./ListWrapper-CDXR4yYu.js";import{T as ee,a as te,b as p}from"./TableWrapper-D8zDqKY_.js";import{T as se}from"./TableRow-D4vG6bsd.js";import{T as le}from"./TableActions-CBCEPdci.js";import{T as ae}from"./TableEdit-59jRdv9L.js";import{T as re}from"./TableDelete-Cqy9W1lx.js";import{D as ne,P as ie,S as oe,V as s,I as V,T as l,a as ce,p as de}from"./react-pdf.browser-C-wkEINR.js";import{L as me}from"./Loading-D4JR0vbX.js";import{u as he}from"./usePagination-Jfc51W3i.js";import{c as xe,b as O}from"./rolePermissions-Bo7kfMMU.js";import{S as ge}from"./StatusFilter-DcaBw2v6.js";const R=r=>r?new Date(r).toLocaleDateString("en-IN",{day:"2-digit",month:"2-digit",year:"numeric"}):"-",ue=({jobOrder:r,documents:y=[]})=>{const N=r?.operations||[],x=w.useMemo(()=>y.filter(o=>o.type==="image").slice(0,6),[y]);console.log("objectimages",x),console.log("images",x);const b=y.filter(o=>o.type==="file"),[D,E]=w.useState([]);return w.useEffect(()=>{const o=async()=>{const d=await Promise.all(x.map(async j=>{const c=j.url.startsWith("http")?j.url:`undefined/${j.url}`;try{const h=await(await fetch(c)).blob(),C=await new Promise(m=>{const T=new FileReader;T.onloadend=()=>m(T.result),T.readAsDataURL(h)});return{name:j.name,src:C}}catch(g){return console.error("Failed to load image:",c,g),{name:j.name,src:""}}}));E(d)};x.length>0&&o()},[x]),e.jsx(ne,{children:e.jsxs(ie,{size:"A4",style:t.page,children:[e.jsxs(s,{style:t.headerContainer,children:[e.jsx(s,{style:t.logoSection,children:e.jsx(V,{src:"/assets/images/logo.png",style:t.logo})}),e.jsxs(s,{style:t.companyInfo,children:[e.jsx(l,{style:t.companyName,children:"UNITED ENGINEERING WORKS"}),e.jsx(l,{style:t.companyAddress,children:"N.H. 8, Nehla Village, By Pass Road, Near Govardhan Vilas, Udaipur- 313001 (Raj.) INDIA"}),e.jsx(l,{style:t.companyContact,children:"Phone: +91-9829232445 +91-9829657145 | GSTIN: 08ABQPK8948J3ZP"}),e.jsx(l,{style:t.companyContact,children:"Email: info@unitedengineeringworks.com"})]})]}),e.jsx(l,{style:t.title,children:"JOB CARD"}),e.jsxs(s,{style:t.jobDetailsContainer,children:[e.jsxs(s,{style:t.gridRow,children:[e.jsxs(s,{style:t.gridCol,children:[e.jsx(l,{style:t.label,children:"Job Name:"}),e.jsx(l,{style:t.value,children:r.job_name||"-"})]}),e.jsxs(s,{style:t.gridCol,children:[e.jsx(l,{style:t.label,children:"Quantity:"}),e.jsx(l,{style:t.value,children:r.quantity||"-"})]})]}),e.jsxs(s,{style:t.gridRow,children:[e.jsxs(s,{style:t.gridCol,children:[e.jsx(l,{style:t.label,children:"Job Card No:"}),e.jsx(l,{style:t.value,children:r.job_card_number||"-"})]}),e.jsxs(s,{style:t.gridCol,children:[e.jsx(l,{style:t.label,children:"Expected Delivery:"}),e.jsx(l,{style:t.value,children:R(r.expected_delivery_date)})]})]}),e.jsxs(s,{style:t.gridRow,children:[e.jsxs(s,{style:t.gridCol,children:[e.jsx(l,{style:t.label,children:"Processing Date:"}),e.jsx(l,{style:t.value,children:R(r.job_date)})]}),e.jsxs(s,{style:t.gridCol,children:[e.jsx(l,{style:t.label,children:"Customer Name:"}),e.jsx(l,{style:t.value,children:r.customer?.party_name||r.customer_name||"-"})]})]}),e.jsxs(s,{style:t.gridRow,children:[e.jsxs(s,{style:t.gridCol,children:[e.jsx(l,{style:t.label,children:"Created By:"}),e.jsx(l,{style:t.value,children:r.created_by?.full_name?`${r.created_by.full_name} (${r.created_by_role??""})`:"-"})]}),e.jsxs(s,{style:t.gridCol,children:[e.jsx(l,{style:t.label,children:"RGP/Invoice no:"}),e.jsx(l,{style:t.value,children:r.rgp_invoice_no||"-"})]})]}),e.jsxs(s,{style:[t.gridRow,{borderBottomWidth:0}],children:[e.jsxs(s,{style:t.gridCol,children:[e.jsx(l,{style:t.label,children:"Branch:"}),e.jsx(l,{style:t.value,children:r.branch?.branch_name||"-"})]}),e.jsx(s,{style:t.gridCol})]})]}),e.jsxs(s,{style:t.descriptionSection,children:[e.jsx(l,{style:t.sectionTitle,children:"Job Description:"}),e.jsx(s,{style:t.descriptionBox,children:e.jsx(l,{style:t.descriptionText,children:r.job_description||"-"})})]}),e.jsxs(s,{style:t.operationsSection,children:[e.jsx(l,{style:t.sectionTitle,children:"List of Operations"}),e.jsxs(s,{style:t.tableContainer,children:[e.jsxs(s,{style:t.tableHeaderRow,children:[e.jsx(s,{style:[t.tableCell,t.snoCol,t.headerCell],children:e.jsx(l,{style:t.headerText,children:"S.no"})}),e.jsx(s,{style:[t.tableCell,t.operationCol,t.headerCell],children:e.jsx(l,{style:t.headerText,children:"Operation Name"})}),e.jsx(s,{style:[t.tableCell,t.supervisorCol,t.headerCell],children:e.jsx(l,{style:t.headerText,children:"Supervisor"})}),e.jsx(s,{style:[t.tableCell,t.startDateCol,t.headerCell],children:e.jsx(l,{style:t.headerText,children:"Start Date"})}),e.jsx(s,{style:[t.tableCell,t.endDateCol,t.headerCell],children:e.jsx(l,{style:t.headerText,children:"End Date"})}),e.jsx(s,{style:[t.tableCell,t.machineCol,t.headerCell],children:e.jsx(l,{style:t.headerText,children:"Machine Name"})})]}),N.length>0?N.map((o,d)=>e.jsxs(s,{style:t.tableRow,children:[e.jsx(s,{style:[t.tableCell,t.snoCol],children:e.jsx(l,{style:t.cellText,children:d+1})}),e.jsx(s,{style:[t.tableCell,t.operationCol],children:e.jsx(l,{style:t.cellText,children:o.operation_name||"-"})}),e.jsx(s,{style:[t.tableCell,t.supervisorCol],children:e.jsx(l,{style:t.cellText,children:o.supervisor?.full_name||"-"})}),e.jsx(s,{style:[t.tableCell,t.startDateCol],children:e.jsx(l,{style:t.cellText,children:R(o.start_date)})}),e.jsx(s,{style:[t.tableCell,t.endDateCol],children:e.jsx(l,{style:t.cellText,children:R(o.end_date)})}),e.jsx(s,{style:[t.tableCell,t.machineCol],children:e.jsx(l,{style:t.cellText,children:o.machine?.name||"-"})})]},d)):Array.from({length:5}).map((o,d)=>e.jsxs(s,{style:t.tableRow,children:[e.jsx(s,{style:[t.tableCell,t.snoCol],children:e.jsx(l,{style:t.cellText})}),e.jsx(s,{style:[t.tableCell,t.operationCol],children:e.jsx(l,{style:t.cellText})}),e.jsx(s,{style:[t.tableCell,t.supervisorCol],children:e.jsx(l,{style:t.cellText})}),e.jsx(s,{style:[t.tableCell,t.startDateCol],children:e.jsx(l,{style:t.cellText})}),e.jsx(s,{style:[t.tableCell,t.endDateCol],children:e.jsx(l,{style:t.cellText})}),e.jsx(s,{style:[t.tableCell,t.machineCol],children:e.jsx(l,{style:t.cellText})})]},d))]})]}),e.jsxs(s,{style:t.remarksSection,children:[e.jsx(l,{style:t.sectionTitle,children:"Additional Remarks/Notes:"}),e.jsx(s,{style:t.remarksBox,children:e.jsx(l,{style:t.remarksText,children:r.remarks||r.note||""})})]}),e.jsxs(s,{style:t.documentsSection,children:[e.jsx(l,{style:t.sectionTitle,children:"Attached Documents"}),x.length>0&&e.jsxs(s,{style:t.imagesContainer,children:[e.jsx(l,{style:t.subSectionTitle,children:"Images:"}),e.jsx(s,{style:t.imagesGrid,children:x.map((o,d)=>e.jsxs(s,{style:t.imageWrapper,children:[e.jsx(s,{style:t.imageContainer,children:e.jsx(V,{src:o.url.startsWith("http")?o.url:`undefined/${o.url}`,style:t.documentImage})}),e.jsx(l,{style:t.imageCaption,children:o.name})]},d))})]}),b.length>0&&e.jsxs(s,{style:t.filesContainer,children:[e.jsx(l,{style:t.subSectionTitle,children:"Files:"}),b.map((o,d)=>e.jsxs(l,{style:t.fileText,children:["• ",o.name]},d))]}),x.length===0&&b.length===0&&e.jsx(s,{style:t.documentsBox,children:e.jsx(l,{style:t.documentsText,children:"No documents attached"})})]})]})})},t=oe.create({page:{padding:20,fontSize:10,fontFamily:"Helvetica",lineHeight:1.3},headerContainer:{flexDirection:"row",alignItems:"center",marginBottom:15,paddingBottom:10,borderBottomWidth:2,borderBottomColor:"#000",gap:10},logoSection:{width:70,marginRight:20},logo:{width:60,height:50},companyInfo:{flex:1,alignItems:"flex-start"},companyName:{fontSize:16,fontWeight:"bold",marginBottom:3},companyAddress:{fontSize:10,marginBottom:2},companyContact:{fontSize:10},title:{fontSize:18,textAlign:"center",marginBottom:15,fontWeight:"bold",textDecoration:"underline"},jobDetailsContainer:{marginBottom:15,borderWidth:1,borderColor:"#000"},gridRow:{flexDirection:"row",borderBottomWidth:.5,borderBottomColor:"#eee",minHeight:25,alignItems:"center"},gridCol:{flexDirection:"row",width:"50%",paddingHorizontal:8,alignItems:"center"},label:{width:"45%",fontSize:9,fontWeight:"bold"},value:{width:"55%",fontSize:9},descriptionSection:{marginBottom:15},sectionTitle:{fontSize:10,fontWeight:"bold",marginBottom:5},descriptionBox:{borderWidth:1,borderColor:"#000",minHeight:60,padding:8},descriptionText:{fontSize:9},operationsSection:{marginBottom:15},tableContainer:{borderWidth:1,borderColor:"#000"},tableHeaderRow:{flexDirection:"row",backgroundColor:"#f0f0f0"},tableRow:{flexDirection:"row",minHeight:25},tableCell:{padding:4,borderWidth:.5,borderColor:"#000",justifyContent:"center",alignItems:"center"},headerCell:{backgroundColor:"#f0f0f0"},headerText:{fontSize:9,fontWeight:"bold",textAlign:"center"},cellText:{fontSize:8,textAlign:"center"},snoCol:{width:"8%"},operationCol:{width:"25%"},supervisorCol:{width:"20%"},startDateCol:{width:"15%"},endDateCol:{width:"15%"},machineCol:{width:"17%"},remarksSection:{marginBottom:15},remarksBox:{borderWidth:1,borderColor:"#000",minHeight:50,padding:8},remarksText:{fontSize:9},documentsSection:{marginBottom:15},documentsBox:{borderWidth:1,borderColor:"#000",minHeight:50,padding:8},documentsText:{fontSize:9},subSectionTitle:{fontSize:9,fontWeight:"bold",marginBottom:5,marginTop:5},imagesContainer:{marginBottom:10},imagesGrid:{flexDirection:"row",flexWrap:"wrap",marginTop:5},imageWrapper:{marginRight:10,marginBottom:10,alignItems:"center"},imageContainer:{borderWidth:1,borderColor:"#ccc",backgroundColor:"#f9f9f9"},documentImage:{width:80,height:80},imagePlaceholder:{width:80,height:80,backgroundColor:"#f0f0f0",borderWidth:1,borderColor:"#ccc",justifyContent:"center",alignItems:"center",padding:4},placeholderText:{fontSize:8,color:"#666",textAlign:"center",marginBottom:2},placeholderUrlText:{fontSize:6,color:"#999",textAlign:"center",maxWidth:70},imageCaption:{fontSize:7,textAlign:"center",marginTop:2,maxWidth:80},filesContainer:{marginTop:5},fileText:{fontSize:9,marginBottom:2,paddingLeft:5}}),pe=({jobOrder:r,onStatusUpdate:y})=>{const[N,x]=w.useState(!1),{user:b}=$(),D=async c=>{x(!0);try{await z.post(A.job_order.statusActions,{job_card_id:r.job_card_id,status:c}),_.success("Status updated successfully"),y()}catch(g){console.error("Failed to update status:",g),_.error(g.response?.data?.message||"Failed to update status")}finally{x(!1)}},o=(()=>{const c=b?.role?.role_name,g=r.status,h=xe(c||""),C=O(c||"")||c==="Super Admin"||h;let m=[];switch(g){case n.PENDING_APPROVAL:h&&(m=[n.APPROVED,n.CANCELLED]);break;case n.APPROVED:C&&(m=[n.IN_PROGRESS]),h&&m.push(n.CANCELLED);break;case n.IN_PROGRESS:C&&(m=[n.COMPLETED,n.CLOSED]),h&&m.push(n.CANCELLED);break;case n.COMPLETED:C&&(m=[n.CLOSED]);break;case n.CANCELLED:h&&(m=[n.PENDING_APPROVAL]);break;case n.CLOSED:break;case n.OVERDUE:C&&(m=[n.IN_PROGRESS,n.COMPLETED]),h&&m.push(n.CANCELLED);break}return m})(),d=c=>c.replace(/_/g," ").replace(/\b\w/g,g=>g.toUpperCase()),j=c=>{switch(c){case n.PENDING_APPROVAL:return"text-yellow-600 bg-yellow-50";case n.APPROVED:return"text-green-600 bg-green-50";case n.IN_PROGRESS:return"text-blue-600 bg-blue-50";case n.COMPLETED:return"text-purple-600 bg-purple-50";case n.CLOSED:return"text-gray-600 bg-gray-50";case n.CANCELLED:return"text-red-600 bg-red-50";case n.OVERDUE:return"text-orange-600 bg-orange-50";default:return"text-gray-600 bg-gray-50"}};return e.jsx("div",{className:"flex items-center gap-2",children:N?e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"}),e.jsx("span",{className:"text-xs text-gray-500",children:"Updating..."})]}):e.jsxs("select",{className:`text-xs border border-gray-300 rounded px-2 py-1 focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white min-w-[120px] ${j(r.status)}`,value:r.status,onChange:c=>{c.target.value!==r.status&&D(c.target.value)},disabled:o.length===0,children:[e.jsx("option",{value:r.status,children:d(r.status)}),o.map(c=>e.jsx("option",{value:c,children:d(c)},c))]})})},Pe=()=>{const{page:r,rowsPerPage:y,setTotal:N,renderPagination:x}=he(),b=Z(),{selectedBranchId:D,user:E}=$(),{setJobOrders:o}=X(),[d,j]=w.useState([]),[c,g]=w.useState(!1),[h,C]=w.useState(""),m=async()=>{g(!0);try{const i=await z.get(A.job_order.list,{params:{page:r+1,rowsPerPage:y,...D&&{branch_id:D}}}),S=i.data?.job_cards||[],L=i.data?.pagination;j(S),L?.total!==void 0&&N(L.total);const f=E?.role?.role_name;if(O(f||"")||f==="Super Admin"){const B=S.filter(I=>I.status==="pending").length;o(B)}}catch(i){console.error("Failed to fetch job orders:",i),_.error("Failed to fetch job orders")}finally{g(!1)}},T=async i=>{try{const S=_.loading("Preparing job card for download..."),f=(await z.get(A.job_order.details(i.id))).data.job_card,B=a=>{if(!a||typeof a!="string")return"file";const u=a.split(".").pop()?.toLowerCase();return u&&["jpg","jpeg","png","gif","bmp","webp"].includes(u)?"image":"file"},I=[f.documents,f.attachments,f.files,f.uploaded_files].filter(Boolean),M=(f.image_path||[]).map(a=>({url:a,name:a.split("/").pop()||"File",type:"auto"})),U=[...I.flat(),...M].filter(a=>typeof a=="string"?!0:a&&(a.url||a.file_path||a.path)).map(a=>{let u,k;return typeof a=="string"?(u=a,k=a.split("/").pop()||"File"):(u=a.url||a.file_path||a.path,k=a.name||a.file_name||a.original_name||a.filename||(typeof u=="string"?u.split("/").pop():"File")),console.log("url url ---->",u),{name:k,type:B(u),url:u}}).filter(a=>a!==null),K=U.filter(a=>a.type==="image").slice(0,6),Q=U.filter(a=>a.type==="file").slice(0,5),F=K.map(a=>({...a,corsBlocked:!0,displayUrl:a.url}));console.log("Processed images with CORS handling:",F);const q=await de(e.jsx(ue,{jobOrder:f,documents:[...F,...Q]})).toBlob(),G=URL.createObjectURL(q),v=document.createElement("a");v.href=G,v.setAttribute("download",`job-card-${i.job_card_number||i.id}.pdf`),document.body.appendChild(v),v.click(),v.remove(),URL.revokeObjectURL(G),_.dismiss(S),_.success("Job card downloaded successfully")}catch(S){console.error("Failed to download job card:",S),_.error("Failed to download job card")}};w.useEffect(()=>{m()},[r,y,D]);const P=h?d.filter(i=>i.status===h):d;return c?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx(me,{})}):e.jsxs("div",{className:"space-y-6",children:[e.jsx(ge,{module:"JobOrderStatus",selectedStatus:h,onChange:C}),e.jsxs(Y,{title:`Job Orders (${P.length})`,createOnClick:J.hasPermission("job_card_management_create")?()=>b(H.JOB_ORDER.CREATE):void 0,children:[e.jsxs(ee,{children:[e.jsx(te,{cols:[{title:"Job Card No"},{title:"Job Name"},{title:"Customer"},{title:"Job Date"},{title:"Expected Delivery"},{title:"Job Type"},{title:"Created At"},{title:"Status"},{title:"Actions"}]}),e.jsx("tbody",{children:c?e.jsx("tr",{children:e.jsx("td",{colSpan:10,className:"px-6 py-12 text-center",children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-red-600"}),e.jsx("p",{className:"mt-2 text-sm text-gray-500",children:"Loading job orders..."})]})})}):P.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:10,className:"px-6 py-12 text-center",children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("svg",{className:"w-12 h-12 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),e.jsx("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"No job orders"}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:h?`No job orders found with status "${h}"`:"Get started by creating a new job order."})]})})}):P.map((i,S)=>e.jsxs(se,{children:[e.jsx(p,{className:"w-12 text-center font-medium",children:e.jsx("div",{className:"text-sm text-gray-900",children:S+1})}),e.jsx(p,{className:"w-40",children:e.jsx("div",{className:"flex items-center",children:e.jsx("div",{className:"text-sm font-medium text-gray-900",children:i.job_card_number||"-"})})}),e.jsx(p,{className:"w-48",children:e.jsx("div",{className:"text-sm text-gray-900",children:i.job_name||"-"})}),e.jsx(p,{className:"w-48",children:e.jsx("div",{className:"flex items-center",children:e.jsx("div",{children:e.jsx("div",{className:"text-sm font-medium text-gray-900",children:i.customer?.party_name||i.customer_name||"—"})})})}),e.jsx(p,{className:"w-32",children:e.jsx("div",{className:"text-sm text-gray-900",children:W.date(i.job_date)})}),e.jsx(p,{className:"w-32",children:e.jsx("div",{className:"text-sm text-gray-900",children:W.date(i.expected_delivery_date)})}),e.jsx(p,{className:"w-32",children:e.jsx("span",{className:"capitalize text-sm text-gray-900",children:i.job_type?.replace(/_/g," ")||"-"})}),e.jsx(p,{className:"w-32",children:e.jsx("div",{className:"text-sm text-gray-500",children:W.date(i.created_at)})}),e.jsx(p,{className:"w-40",children:e.jsx(pe,{jobOrder:{job_card_id:i.id,status:i.status},onStatusUpdate:m})}),e.jsx(p,{className:"w-20",children:e.jsxs(le,{children:[J.hasPermission("job_card_management_update")&&e.jsx(ae,{onClick:()=>b(`${H.JOB_ORDER.CREATE}?editId=${i.id}`)}),e.jsx(ce,{onClick:()=>T(i)}),J.hasPermission("job_card_management_delete")&&e.jsx(re,{refetch:m,endpoint:A.job_order.delete(i.id)})]})})]},i.id))})]}),P.length>0&&x()]})]})};export{Pe as default};
