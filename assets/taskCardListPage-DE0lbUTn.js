import{r as m,a as k,j as e,y as E,h as C,e as P,u as O,D as R,P as T,A as D}from"./index-DZUejYSu.js";import{L}from"./ListWrapper-B8opYR8T.js";import{T as c}from"./TableData-CgIR3Yxt.js";import{T as I,a as M}from"./TableWrapper-eUq9a7Bu.js";import{T as G}from"./TableRow-BwaacXN6.js";import{T as H}from"./TableActions-Df8LXwIU.js";import{T as $}from"./TableEdit-Cg5PE5iE.js";import{T as F}from"./TableDelete-DqVMD4Nf.js";import{u as V}from"./usePagination-TzSKWAro.js";import{T as a}from"./enum-SoLNwffs.js";import{b as A}from"./rolePermissions-BvMMyxfj.js";const U=({taskCard:l,onStatusUpdate:b})=>{const[d,v]=m.useState(!1),[u,x]=m.useState({open:!1,action:"",title:""}),[p,N]=m.useState(""),{user:w}=k(),y=()=>{if(!l.expected_delivery_date)return!1;const t=new Date(l.expected_delivery_date),o=new Date;return o.setHours(0,0,0,0),t.setHours(0,0,0,0),t<o&&l.status!==a.COMPLETED},i=()=>{const t=w?.role?.role_name,o=l.status,n=[],j=t?.toLowerCase().replace(/\s+/g,"_");return(t==="Super Admin"||t==="Admin"||A(t)||j==="super_admin"||j==="admin"||j==="workshop_supervisor")&&o===a.PENDING&&n.push({label:"Approve",value:a.APPROVED,variant:"success"},{label:"Reject",value:a.REJECTED,variant:"danger"}),(A(t)||t==="Super Admin"||t==="Admin"||j==="workshop_supervisor"||j==="super_admin"||j==="admin")&&(o===a.APPROVED&&n.push({label:"Start Progress",value:a.IN_PROGRESS,variant:"primary"}),o===a.IN_PROGRESS&&n.push({label:"Mark Completed",value:a.COMPLETED,variant:"success"})),n},_=async t=>{if(t===a.REJECTED){x({open:!0,action:t,title:"Reject Task Card"});return}await h(t)},h=async(t,o)=>{v(!0);try{const n={status:t};o&&(n.reason=o),await C.post(P.task_cards.status(l.id),n),E.success("Status updated successfully"),b()}catch(n){console.error("Failed to update status:",n),E.error(n.response?.data?.message||"Failed to update status")}finally{v(!1)}},g=async()=>{if(!p.trim()){E.error("Please enter a reason");return}await h(u.action,p),s()},s=()=>{x({open:!1,action:"",title:""}),N("")},r=i(),S=(()=>{if(y())return{text:"Overdue",className:"border-red-300 text-red-700"};switch(l.status){case a.PENDING:return{text:"Pending",className:"border-yellow-300 text-yellow-700"};case a.APPROVED:return{text:"Approved",className:"border-green-300 text-green-700"};case a.REJECTED:return{text:"Rejected",className:"border-red-300 text-red-700"};case a.IN_PROGRESS:return{text:"In Progress",className:"border-blue-300 text-blue-700"};case a.COMPLETED:return{text:"Completed",className:"border-purple-300 text-purple-700"};default:return{text:l.status?.replace(/_/g," ")||"Unknown",className:"border-gray-300 text-gray-700"}}})();return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex items-center gap-2 flex-wrap",children:d?e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"}),e.jsx("span",{className:"text-xs text-gray-500",children:"Updating..."})]}):e.jsx(e.Fragment,{children:e.jsxs("select",{className:`text-xs border border-gray-300 rounded px-2 py-1 focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white min-w-[140px] ${r.length===0?"opacity-50 cursor-not-allowed":""} ${S.className.replace("bg-","border-").replace("text-","text-").replace("-100","-300").replace("-800","-700")}`,value:"",onChange:t=>{t.target.value&&r.length>0&&(_(t.target.value),t.target.value="")},disabled:d||r.length===0,children:[e.jsxs("option",{value:"",className:"font-medium",children:[S.text," ",r.length>0?"â–¼":""]}),r.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))]})})}),u.open&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-md mx-4",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:u.title}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Reason ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("textarea",{className:"w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",rows:4,placeholder:`Enter reason for ${u.action}...`,value:p,onChange:t=>N(t.target.value)})]}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx("button",{className:"px-4 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50",onClick:s,disabled:d,children:"Cancel"}),e.jsx("button",{className:"px-4 py-2 text-sm rounded-lg text-white bg-red-600 hover:bg-red-700",onClick:g,disabled:d,children:d?"Processing...":"Submit"})]})]})})]})},se=()=>{const{page:l,rowsPerPage:b,setTotal:d,renderPagination:v}=V(),u=O(),{selectedBranchId:x}=k(),[p,N]=m.useState([]),[w,y]=m.useState(!1),[i,_]=m.useState(""),h=async()=>{y(!0);try{const s=await C.get(P.task_cards.list,{params:{page:l+1,per_page:b,...x&&{branch_id:x}}}),r=s.data?.task_cards||s.data?.data||[],f=s.data?.pagination;N(r),f?.last_page!==void 0&&d(f.last_page)}catch(s){console.error("Failed to fetch task orders:",s)}finally{y(!1)}};m.useEffect(()=>{h()},[l,b,x]);const g=i?p.filter(s=>{if(i==="overdue"){const r=new Date(s.expected_delivery_date),f=new Date;return f.setHours(0,0,0,0),r.setHours(0,0,0,0),r<f&&s.status!==a.COMPLETED}return s.status===i}):p;return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"bg-white rounded-lg shadow-sm p-4",children:e.jsxs("div",{className:"flex flex-wrap gap-4 items-center",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Status:"}),e.jsxs("select",{value:i,onChange:s=>_(s.target.value),className:"text-sm border border-gray-300 rounded px-3 py-1 focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white min-w-[150px]",children:[e.jsx("option",{value:"",children:"All Status"}),e.jsx("option",{value:a.PENDING,children:"Pending"}),e.jsx("option",{value:a.APPROVED,children:"Approved"}),e.jsx("option",{value:a.REJECTED,children:"Rejected"}),e.jsx("option",{value:a.IN_PROGRESS,children:"In Progress"}),e.jsx("option",{value:a.COMPLETED,children:"Completed"}),e.jsx("option",{value:"overdue",children:"Overdue"})]})]}),i&&e.jsx("button",{onClick:()=>_(""),className:"text-xs text-blue-600 hover:text-blue-800",children:"Clear Filter"})]})}),e.jsxs(L,{title:`Task Orders (${g?.length||0})`,createOnClick:T.hasPermission("task_card_management_create")?()=>u(D.TASK_CARD.CREATE):void 0,children:[e.jsxs(I,{children:[e.jsx(M,{cols:[{title:"Task Card No"},{title:"Task Name"},{title:"Task Date"},{title:"Expected Delivery"},{title:"Task Type"},{title:"Status"},{title:"Actions"}]}),e.jsx("tbody",{children:w?e.jsx("tr",{children:e.jsx("td",{colSpan:9,className:"px-6 py-12 text-center",children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-red-600"}),e.jsx("p",{className:"mt-2 text-sm text-gray-500",children:"Loading task orders..."})]})})}):g?.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:9,className:"px-6 py-12 text-center",children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("svg",{className:"w-12 h-12 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),e.jsx("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"No task orders"}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:i?`No task orders found with status "${i}"`:"Get started by creating a new task order."})]})})}):g.map((s,r)=>e.jsxs(G,{children:[e.jsx(c,{className:"w-12 text-center font-medium",children:e.jsx("div",{className:"px-5 text-sm text-gray-900",children:r+1})}),e.jsx(c,{className:"w-40",children:e.jsx("div",{className:"flex items-center",children:e.jsx("div",{className:"text-sm font-medium text-gray-900",children:s.job_card_number||"-"})})}),e.jsx(c,{className:"w-48",children:e.jsx("div",{className:"text-sm text-gray-900",children:s.job_name||"-"})}),e.jsx(c,{className:"w-32",children:e.jsx("div",{className:"text-sm text-gray-900",children:R.date(s.task_date)})}),e.jsx(c,{className:"w-32",children:e.jsx("div",{className:"text-sm text-gray-900",children:R.date(s.expected_delivery_date)})}),e.jsx(c,{className:"w-32",children:e.jsx("span",{className:"capitalize text-sm text-gray-900",children:s.job_type?.replace(/_/g," ")||"-"})}),e.jsx(c,{className:"w-40",children:e.jsx(U,{taskCard:{id:s.id,status:s.status,task_card_number:s.job_card_number,expected_delivery_date:s.expected_delivery_date},onStatusUpdate:h})}),e.jsx(c,{className:"w-20",children:e.jsxs(H,{children:[T.hasPermission("task_card_management_update")&&e.jsx($,{onClick:()=>u(`${D.TASK_CARD.CREATE}?editId=${s.id}`)}),T.hasPermission("task_card_management_delete")&&e.jsx(F,{refetch:h,endpoint:P.task_cards.delete(s.id)})]})})]},s.id))})]}),g?.length>0&&v()]})]})};export{se as default};
