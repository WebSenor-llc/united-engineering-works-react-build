import{r as g,j as e,B as H,h as z,e as J,y as W,u as Ve,b as $e,a as qe,A as re}from"./index-K9d2s2ak.js";import{T as _}from"./TextInput-C-uPTskM.js";import{S as ie}from"./Select-CMA8nb1i.js";import{B as de}from"./BaseModal-BjDXyqU3.js";import{u as oe,C as V,b as Te}from"./index.esm-Ct0RaNqj.js";import{o as Fe,e as Pe}from"./yup-CSrqxQ2C.js";import{u as Ee}from"./useItemsStore-CNV44N9A.js";import{u as Re}from"./useMaterialRequestStore-7T2HHZHi.js";import{F as Ae}from"./FormHeader-DX0ub5SD.js";import{L as ke}from"./Loading-BgP_rkDi.js";import{u as me}from"./usePartyStore-BqfSZEmm.js";import{C as Me}from"./CommonFilter-Biy-cRRg.js";import{S as Ie}from"./SearchableSelect-BZLgYAYc.js";import"./BackButton-pmq9AY_B.js";const Oe=({open:x,onClose:P,onSuccess:b})=>{const[k,T]=g.useState([]),[w,M]=g.useState([]),[$,E]=g.useState([]),[I,q]=g.useState(!1),{control:y,handleSubmit:F,reset:j,watch:O,formState:{errors:h}}=oe({defaultValues:{party_type:"vendor",party_name:"",company_name:"",address:"",city:"",state:"",pincode:"",gstin:"",contact_person:"",phone:"",credit_limit:"",email:"",country:"India",pan:"",bank_name:"",bank_account_number:"",bank_ifsc_code:"",is_active:!0},resolver:Fe(Pe)}),f=O("country"),n=O("state");g.useEffect(()=>{x&&(async()=>{try{const d=await z.get(J.party_master.countries);T(d.data.data||d.data||[])}catch(d){console.error("Failed to fetch countries",d)}})()},[x]),g.useEffect(()=>{if(!f||!x){M([]);return}(async()=>{const d=k.find(v=>v.name===f);if(d)try{const v=await z.get(`${J.party_master.states}?country=${d.name}`);M(v.data.data||v.data||[])}catch(v){console.error("Failed to fetch states",v)}})()},[f,k,x]),g.useEffect(()=>{if(!n||!x){E([]);return}(async()=>{const d=w.find(v=>v.name===n);if(d)try{const v=await z.get(`${J.party_master.cities}?state=${d.name}`);E(v.data.data||v.data||[])}catch(v){console.error("Failed to fetch cities",v)}})()},[n,w,x]);const K=async m=>{q(!0);try{await z.post(J.party_master.create,m),W.success("Party Created Successfully"),b(),P(),j()}catch(d){console.error(d),W.error(d.response?.data?.message||"Failed to save party")}finally{q(!1)}};return e.jsx(de,{open:x,onClose:()=>{P(),j()},title:"Create New Party",maxWidth:"max-w-4xl",children:e.jsxs("div",{className:"space-y-6 max-h-[80vh] overflow-y-auto px-1 py-2",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[e.jsx(V,{name:"party_type",control:y,render:({field:m})=>e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("label",{className:"text-sm font-semibold text-gray-700 mb-1",children:["Party Type ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{...m,className:"w-full rounded-lg border border-gray-300 mt-1 px-3 py-2 text-gray-700 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white",children:[e.jsx("option",{value:"",children:"Select Party Type"}),e.jsx("option",{value:"vendor",children:"Vendor"}),e.jsx("option",{value:"customer",children:"Customer"})]}),h?.party_type?.message&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:h.party_type.message})]})}),e.jsx(V,{name:"party_name",control:y,render:({field:m})=>e.jsx(_,{required:!0,...m,label:"Party Name",error:h?.party_name?.message,className:"text-sm py-2"})}),e.jsx(V,{name:"contact_person",control:y,render:({field:m})=>e.jsx(_,{required:!0,...m,label:"Contact Person",error:h?.contact_person?.message,className:"text-sm py-2"})}),e.jsx(V,{name:"company_name",control:y,render:({field:m})=>e.jsx(_,{required:!0,...m,label:"Company Name",error:h?.company_name?.message,className:"text-sm py-2"})}),e.jsx(V,{name:"address",control:y,render:({field:m})=>e.jsx(_,{required:!0,...m,label:"Address",error:h?.address?.message,className:"text-sm py-2"})}),e.jsx(V,{name:"country",control:y,render:({field:m})=>e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("label",{className:"text-sm font-semibold text-gray-700 mb-1",children:["Country ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{...m,className:"w-full rounded-lg border border-gray-300 mt-1 px-3 py-2 text-gray-700 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white",children:[e.jsx("option",{value:"",children:"Select Country"}),k.map(d=>e.jsx("option",{value:d.name,children:d.name},d.id||d.name))]}),h?.country?.message&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:h.country.message})]})}),e.jsx(V,{name:"state",control:y,render:({field:m})=>e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("label",{className:"text-sm font-semibold text-gray-700 mb-1",children:["State ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{...m,disabled:!w.length,className:"w-full rounded-lg border border-gray-300 mt-1 px-3 py-2 text-gray-700 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white disabled:bg-gray-100",children:[e.jsx("option",{value:"",children:"Select State"}),w.map(d=>e.jsx("option",{value:d.name,children:d.name},d.id||d.name))]}),h?.state?.message&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:h.state.message})]})}),e.jsx(V,{name:"city",control:y,render:({field:m})=>e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("label",{className:"text-sm font-semibold text-gray-700 mb-1",children:["City ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{...m,disabled:!$.length,className:"w-full rounded-lg border border-gray-300 mt-1 px-3 py-2 text-gray-700 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white disabled:bg-gray-100",children:[e.jsx("option",{value:"",children:"Select City"}),$.map(d=>e.jsx("option",{value:d.name,children:d.name},d.id||d.name))]}),h?.city?.message&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:h.city.message})]})}),e.jsx(V,{name:"pincode",control:y,render:({field:m})=>e.jsx(_,{required:!0,...m,label:"Pincode",error:h?.pincode?.message,className:"text-sm py-2"})}),e.jsx(V,{name:"phone",control:y,render:({field:m})=>e.jsx(_,{required:!0,...m,label:"Mobile No",type:"tel",error:h?.phone?.message,className:"text-sm py-2"})}),e.jsx(V,{name:"email",control:y,render:({field:m})=>e.jsx(_,{required:!0,...m,label:"Email",type:"email",error:h?.email?.message,className:"text-sm py-2"})}),e.jsx(V,{control:y,name:"is_active",render:({field:m})=>e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("label",{className:"block text-sm font-semibold text-gray-700 mb-1",children:["Is Active ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{...m,value:m.value?"true":"false",onChange:d=>m.onChange(d.target.value==="true"),className:"w-full border border-gray-300 rounded-lg px-3 py-2 bg-white text-gray-800 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"true",children:"Active"}),e.jsx("option",{value:"false",children:"Inactive"})]})]})})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t border-slate-200",children:[e.jsx(H,{onClick:()=>{P(),j()},variant:"outline",className:"text-sm px-4",children:"Cancel"}),e.jsx(H,{onClick:F(K),loading:I,disabled:I,className:"bg-red-600 text-white text-sm px-4",children:"Create Party"})]})]})})},ue=g.forwardRef(({value:x,onChange:P,placeholder:b="Select Vendor to Add",disabled:k=!1,error:T,className:w,excludeVendorIds:M=[],onMount:$},E)=>{const{parties:I,fetchParties:q,loading:y}=me(),F=g.useRef(!1);g.useEffect(()=>{!F.current&&$&&(F.current=!0,$())},[$]);const j=I.filter(f=>(f.party_type?.toLowerCase()==="vendor"||!f.party_type)&&f.is_active&&!M.includes(f.id));console.log("Available Vendors:",j);const O=j.map(f=>({value:f.id,label:f.party_name})),h=g.useCallback(f=>{f.length>=3?q({search:f,party_type:"Vendor"}):f.length===0&&q({party_type:"Vendor"})},[q]);return e.jsx(Ie,{ref:E,options:O,value:x?Number(x):void 0,onChange:f=>P(f.toString()),placeholder:y?"Loading vendors...":b,disabled:k,loading:y,error:T,className:w,onSearch:h})});ue.displayName="VendorSearchSelect";const ce=x=>{const P=parseFloat(String(x.rate))||0,b=parseFloat(String(x.quantity))||0,k=parseFloat(String(x.discount_percent))||0,T=parseFloat(String(x.gst_percent))||0,w=parseFloat(String(x.freight_charges))||0,M=parseFloat(String(x.freight_gst_percentage))||0,$=parseFloat(String(x.cutting_charges))||0,E=parseFloat(String(x.loading_charges))||0,I=P*(k/100),q=P-I,y=q*(T/100),F=q+y,j=F*b,O=w*(M/100),h=w+O,f=j+h+$+E,n=q*b,K=n+h+$+E;return{net_amount:F.toFixed(2),total_amount:f.toFixed(2),base_total:n.toFixed(2),total_before_item_gst:K.toFixed(2)}},Le={quantity:"",rate:"",discount_percent:"",gst_percent:"",net_amount:"",total_amount:"",loading_charges:"",loading_gst_percentage:"",freight_charges:"",freight_gst_percentage:"",cutting_charges:"",cutting_gst_percentage:""},st=()=>{const x=Ve(),[P]=$e(),b=P.get("editId"),{fetchItems:k}=Ee(),{materials:T,fetchMaterials:w}=Re(),[M,$]=g.useState(!1),[E,I]=g.useState(!1),{selectedBranchId:q}=qe(),{parties:y,fetchParties:F}=me(),j=g.useRef(!1),O=g.useRef(!1),[h,f]=g.useState(!1),[n,K]=g.useState(null),[m,d]=g.useState(""),[v,G]=g.useState(""),[ge,ae]=g.useState(!1),ne=g.useRef(null),{control:ee,handleSubmit:xe,getValues:X,watch:Y,setValue:L,register:U,trigger:te}=oe({defaultValues:{branch_id:"",material_requisition_id:"",items:[]}}),{fields:D}=Te({control:ee,name:"items",keyName:"fieldId"}),pe=[{name:"mr_number",label:"MR Number",placeholder:"Enter MR number"},{name:"item_name",label:"Item Name",placeholder:"Enter Item Name"},{name:"date_from",label:"Date From",type:"date",placeholder:"Enter Date from"},{name:"date_to",label:"Date To",type:"date",placeholder:"Enter Date To"}],_e=async t=>{fe(t);const s={};t.mr_number&&(s.mr_number=t.mr_number),t.item_name&&(s.item_name=t.item_name),t.branch_id&&(s.branch_id=t.branch_id),t.date_from&&t.date_to?t.date_from===t.date_to?s.date=t.date_from:(s.date_from=t.date_from,s.date_to=t.date_to):(t.date_from&&(s.date_from=t.date_from),t.date_to&&(s.date_to=t.date_to)),await w(s)},[N,Z]=g.useState({}),[he,fe]=g.useState({});g.useEffect(()=>{k(),w()},[]);const be=async()=>{if(b){$(!0);try{const s=(await z.get(J.comparative_statement.details(Number(b)))).data?.statement;if(!s){W.error("Comparative statement not found"),x(re.COMPERATIVE_STATEMENT.LIST);return}const r=s.items||[],c=s.material_requisition_id;if(r.length===0){W.error("No items found in comparative statement"),x(re.COMPERATIVE_STATEMENT.LIST);return}c&&(T?.some(u=>u.id===c)||await w()),L("material_requisition_id",c?String(c):"");const a=[],o={};r.forEach((l,u)=>{const p={item_id:String(l.item_id||l.item?.id||""),item_name:l.item?.item_name||l.item_name||l.name||"",item_unit:l.item?.unit?.unit_name||l.item?.unit?.unit_symbol||l.item_unit||l.unit||"",description:l.item?.description||l.description||"",quantity:String(l.quantity||""),last_purchase_rate:String(l.last_purchase_rate||"0"),selected_vendor_id:l.selected_vendor_id?`v_${l.selected_vendor_id}`:"",vendors:[]};o[u]={};const B=l.vendors||[],S=new Set;if(B.forEach(i=>{const A=`v_${i.vendor_id||i.id}`,C=i.vendor?.party_name||i.party_name||`Vendor ${i.vendor_id}`;S.has(A)||(p.vendors.push({id:A,name:C,vendor_id:i.vendor_id||i.id}),S.add(A)),o[u][A]={quantity:String(i.quantity||p.quantity||""),rate:String(i.rate??i.unit_price??i.price??""),discount_percent:String(i.discount_percent??i.discount_percentage??i.discount??""),gst_percent:String(i.gst_percent??i.gst_percentage??i.tax_percent??""),net_amount:String(i.net_amount??""),total_amount:String(i.total_amount??""),loading_charges:String(i.loading_charges??""),loading_gst_percentage:String(i.loading_gst_percentage??""),freight_charges:String(i.freight_charges??""),freight_gst_percentage:String(i.freight_gst_percentage??""),cutting_charges:String(i.cutting_charges??""),cutting_gst_percentage:String(i.cutting_gst_percentage??"")}}),l.selected_vendor&&l.selected_vendor_id){const i=`v_${l.selected_vendor_id}`;S.has(i)||(p.vendors.push({id:i,name:l.selected_vendor_rate_details?.vendor_name||l.selected_vendor?.party_name||"Selected Vendor",vendor_id:l.selected_vendor_rate_details?.vendor_id||l.selected_vendor_id}),o[u][i]||(o[u][i]={quantity:String(l.quantity||""),rate:String(l.selected_vendor_rate_details?.rate??""),discount_percent:String(l.selected_vendor_rate_details?.discount_percentage??""),gst_percent:String(l.selected_vendor_rate_details?.gst_percentage??""),net_amount:String(l.selected_vendor_rate_details?.net_amount??""),total_amount:String(l.selected_vendor_rate_details?.total_amount??""),loading_charges:String(l.selected_vendor_rate_details?.loading_charges??""),loading_gst_percentage:String(l.selected_vendor_rate_details?.loading_gst_percentage??""),freight_charges:String(l.selected_vendor_rate_details?.freight_charges??""),freight_gst_percentage:String(l.selected_vendor_rate_details?.freight_gst_percentage??""),cutting_charges:String(l.selected_vendor_rate_details?.cutting_charges??""),cutting_gst_percentage:String(l.selected_vendor_rate_details?.cutting_gst_percentage??"")}))}a.push(p)}),L("items",a),Z(o),W.success("Comparative statement loaded successfully")}catch(t){console.error("Failed to load comparative statement:",t),console.error("Error response:",t.response?.data),W.error(t.response?.data?.message||"Failed to load comparative statement details")}finally{$(!1)}}};g.useEffect(()=>{(async()=>{b&&(await w(),await be())})()},[b]);const ye=t=>{if(!t){L("items",[]);return}const s=T?.find(r=>r.id===Number(t));if(s&&s.items&&s.items.length>0){const r=s.items.map(a=>({item_id:String(a.item?.id||a.item_id||""),item_name:a.item?.item_name||a.item_name||a.name||"",item_unit:a.item?.unit?.unit_name||a.item?.unit?.unit_symbol||a.item_unit||a.unit||"",description:a.item?.description||a.description||"",quantity:String(a.quantity_required||a.quantity||""),last_purchase_rate:"0",selected_vendor_id:"",vendors:[]}));L("items",r);const c={};r.forEach((a,o)=>{c[o]={}}),Z(c)}},je=t=>{K(t),f(!0),!O.current&&!j.current&&(O.current=!0,j.current=!0,F({party_type:"Vendor"}).finally(()=>{j.current=!1}));const s=X(`items.${t}`);s.selected_vendor_id?(G(s.selected_vendor_id),d(s.selected_vendor_id)):s.vendors&&s.vendors.length>0?G(s.vendors[0].id):G("")},le=()=>{f(!1),K(null),d(""),G("")},Ne=(t,s,r,c)=>{const a=ce({rate:r.rate,quantity:c,discount_percent:r.discount_percent,gst_percent:r.gst_percent,freight_charges:r.freight_charges,freight_gst_percentage:r.freight_gst_percentage,cutting_charges:r.cutting_charges,loading_charges:r.loading_charges});return{...r,net_amount:a.net_amount,total_amount:a.total_amount}},Q=(t,s,r,c)=>{const a={...N,[t]:{...N[t],[s]:{...N[t]?.[s],[r]:c}}},o=X(`items.${t}.quantity`),l=a[t][s],u=Ne(t,s,l,o);a[t][s]=u,Z(a)},ve=async t=>{if(!t||n===null)return;const s=parseInt(t);let r=y.find(C=>C.id===s);if(!r&&!j.current){j.current=!0;try{await F({party_type:"Vendor"}),r=y.find(C=>C.id===s)}finally{j.current=!1}if(!r)return}const c=r;if(!c)return;const o=X(`items.${n}`).vendors||[],l=o.filter(C=>C.vendor_id===s),u=l.length+1,p=`v_${s}_${u}`,B=l.length>0?`${c.party_name} (Rate ${u})`:c.party_name,S={id:p,name:c.party_name,vendor_id:s,rate_tier:u,display_name:B},i=[...o,S];L(`items.${n}.vendors`,i),G(p);const A=i.map(C=>C.vendor_id===s&&i.filter(we=>we.vendor_id===s).length>1?{...C,display_name:`${C.name} (Rate ${C.rate_tier||1})`}:C);L(`items.${n}.vendors`,A),Z(C=>({...C,[n]:{...C[n],[p]:{...Le}}})),d(""),await te()},Se=async(t,s)=>{const r=X(`items.${t}`),c=r.vendors[s],a=c.id,o=r.vendors.filter((u,p)=>p!==s),l=o.map((u,p)=>{if(u.vendor_id===c.vendor_id){const B=o.filter(i=>i.vendor_id===u.vendor_id).length,S=o.filter((i,A)=>i.vendor_id===u.vendor_id&&A<=p).length;return B>1?{...u,rate_tier:S,display_name:`${u.name} (Rate ${S})`,id:`v_${u.vendor_id}_${S}`}:{...u,rate_tier:1,display_name:u.name,id:`v_${u.vendor_id}_1`}}return u});L(`items.${t}.vendors`,l),Z(u=>{const p={...u};if(p[t]){delete p[t][a];const B={};l.forEach(S=>{const i=Object.keys(p[t]).find(A=>A.startsWith(`v_${S.vendor_id}_`));i&&i!==S.id?(B[S.id]=p[t][i],delete p[t][i]):p[t][S.id]&&(B[S.id]=p[t][S.id])}),p[t]={...p[t],...B}}return p}),r.selected_vendor_id===a&&L(`items.${t}.selected_vendor_id`,""),v===a&&l.length>0&&G(l[0].id),await te()},se=t=>t?!!(t.rate||t.net_amount||t.total_amount):!1,Ce=async t=>{I(!0);const s={branch_id:Number(q),material_requisition_id:t.material_requisition_id?Number(t.material_requisition_id):null,items:t.items.map((r,c)=>{const a=r.selected_vendor_id?N[c]?.[r.selected_vendor_id]:null;return{item_id:Number(r.item_id),quantity:Number(r.quantity),last_purchase_rate:Number(r.last_purchase_rate)||0,selected_vendor_id:r.selected_vendor_id?Number(r.selected_vendor_id.replace(/^v_(\d+)(_\d+)?$/,"$1")):null,vendors:r.selected_vendor_id?[{vendor_id:Number(r.selected_vendor_id.replace(/^v_(\d+)(_\d+)?$/,"$1")),quantity:Number(r.quantity),rate:a&&Number(a.rate)||0,unit_price:a&&Number(a.rate)||0,discount_percent:a&&Number(a.discount_percent)||0,gst_percent:a&&Number(a.gst_percent)||0,discount_percentage:a&&Number(a.discount_percent)||0,gst_percentage:a&&Number(a.gst_percent)||0,tax_percentage:a&&Number(a.gst_percent)||0,net_amount:a&&Number(a.net_amount)||0,total_amount:a&&Number(a.total_amount)||0,loading_charges:a&&Number(a.loading_charges)||0,loading_gst_percentage:a&&Number(a.loading_gst_percentage)||0,freight_charges:a&&Number(a.freight_charges)||0,freight_gst_percentage:a&&Number(a.freight_gst_percentage)||0,cutting_charges:a&&Number(a.cutting_charges)||0,cutting_gst_percentage:a&&Number(a.cutting_gst_percentage)||0}]:[]}}).filter(r=>r.selected_vendor_id)};try{const r=b?J.comparative_statement.update(Number(b)):J.comparative_statement.create;await(b?z.put:z.post)(r,s),W.success(b?"Comparative statement updated successfully":"Comparative statement created successfully"),x(re.COMPERATIVE_STATEMENT.LIST)}catch(r){console.error(r),W.error(r.response?.data?.message||"Failed to save comparative statement")}finally{I(!1)}};if(M)return e.jsx("div",{className:"flex justify-center py-20",children:e.jsx(ke,{})});const R=n!==null?X(`items.${n}.vendors`)||[]:[];return e.jsxs("div",{className:"w-full h-full overflow-auto bg-slate-50",children:[e.jsxs("div",{className:"max-w-7xl mx-auto space-y-8 px-6 py-5 pb-10",children:[e.jsx(Ae,{title:b?"Edit Comparative Statement":"Create Comparative Statement",subtitle:b?"Update the comparative statement details":"Compare rates from multiple vendors and select the best option."}),e.jsx(Me,{fields:pe,onFilter:_e,defaultValues:he}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm p-4 sm:p-6 space-y-6",children:[e.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-xs font-semibold text-slate-500 uppercase mb-1",children:"Material Request"}),e.jsx(V,{name:"material_requisition_id",control:ee,render:({field:t})=>e.jsxs(ie,{...t,className:"text-sm py-2",onChange:s=>{t.onChange(s.target.value),ye(s.target.value)},disabled:!!b,children:[e.jsx("option",{value:"",children:"Select Material Request"}),T&&T.length>0&&T.map(s=>e.jsxs("option",{value:s.id,children:[s.mr_number," - ",s.department||"Unknown Dept"," -"," ",s.branch.branch_name]},s.id))]})})]})}),D.length>0&&e.jsxs("div",{className:"mt-6",children:[e.jsxs("h3",{className:"text-sm font-semibold text-slate-700 mb-3",children:["Material Request Items (",D.length,")"]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border-collapse",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-slate-100 border-b border-slate-200",children:[e.jsx("th",{className:"text-left text-xs font-semibold text-slate-600 p-3",children:"Item Name"}),e.jsx("th",{className:"text-center text-xs font-semibold text-slate-600 p-3",children:"Unit"}),e.jsx("th",{className:"text-left text-xs font-semibold text-slate-600 p-3",children:"Item Description"}),e.jsx("th",{className:"text-center text-xs font-semibold text-slate-600 p-3",children:"Quantity"}),e.jsx("th",{className:"text-center text-xs font-semibold text-slate-600 p-3",children:"Last Rate"}),e.jsx("th",{className:"text-center text-xs font-semibold text-slate-600 p-3",children:"Selected Vendor"}),e.jsx("th",{className:"text-center text-xs font-semibold text-slate-600 p-3",children:"Action"})]})}),e.jsx("tbody",{children:D.map((t,s)=>{const r=Y(`items.${s}.vendors`)||[],c=Y(`items.${s}.selected_vendor_id`),a=r.find(o=>o.id===c);return e.jsxs("tr",{className:"border-b border-slate-100 hover:bg-slate-50",children:[e.jsx("td",{className:"p-3",children:e.jsx(_,{...U(`items.${s}.item_name`),className:"bg-slate-50 border-slate-200 text-sm py-2",readOnly:!0})}),e.jsx("td",{className:"p-3",children:e.jsx(_,{...U(`items.${s}.item_unit`),className:"bg-slate-50 border-slate-200 text-center text-sm py-2",readOnly:!0})}),e.jsx("td",{className:"p-3",children:e.jsx(_,{...U(`items.${s}.description`),className:"bg-slate-50 border-slate-200 text-sm py-2",readOnly:!0,placeholder:"No description"})}),e.jsx("td",{className:"p-3",children:e.jsx(_,{...U(`items.${s}.quantity`),type:"number",className:"text-center text-sm py-2",placeholder:"0"})}),e.jsx("td",{className:"p-3",children:e.jsx(_,{...U(`items.${s}.last_purchase_rate`),type:"number",className:`text-center text-sm py-2 ${b?"bg-slate-50 border-slate-200":""}`,placeholder:"0.00",readOnly:!!b})}),e.jsx("td",{className:"p-3",children:a?e.jsx("div",{className:"bg-green-50 border border-green-300 rounded px-3 py-2 text-center",children:e.jsx("span",{className:"text-sm font-medium text-green-800",children:a.name})}):e.jsx("div",{className:"bg-gray-50 border border-gray-200 rounded px-3 py-2 text-center",children:e.jsx("span",{className:"text-xs text-gray-400",children:"Not Selected"})})}),e.jsx("td",{className:"p-3 text-center",children:e.jsx(H,{variant:"outline",onClick:()=>je(s),className:"text-xs py-1 px-3",children:"Select Vendor"})})]},t.fieldId)})})]})})]}),!X("material_requisition_id")&&e.jsx("div",{className:"text-center p-12 bg-white border border-dashed border-slate-300 rounded-lg text-slate-500",children:"Please select a material request to view items."}),e.jsxs("div",{className:"flex justify-end items-center gap-3 mt-6",children:[e.jsx(H,{variant:"outline",onClick:()=>x(-1),children:"Cancel"}),e.jsx(H,{className:"bg-red-600 text-white",onClick:xe(Ce),loading:E,disabled:E||D.length===0,children:b?"Update Statement":"Submit Statement"})]})]})]}),e.jsx(de,{open:h,onClose:le,title:"Select Vendors",maxWidth:"max-w-5xl",children:n!==null&&e.jsxs("div",{className:"space-y-4 max-h-[80vh] overflow-y-auto pr-2",children:[e.jsx("div",{className:"bg-slate-50 p-4 rounded-lg border border-slate-200",children:e.jsxs("div",{className:"grid grid-cols-4 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-xs text-slate-500 block mb-1",children:"Item:"}),e.jsx("p",{className:"font-medium",children:Y(`items.${n}.item_name`)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-xs text-slate-500 block mb-1",children:"Unit:"}),e.jsx("p",{className:"font-medium",children:Y(`items.${n}.item_unit`)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-slate-500 block mb-1",children:"Quantity:"}),e.jsx(_,{...U(`items.${n}.quantity`),type:"number",className:"text-sm py-2 font-medium",placeholder:"0",onChange:t=>{L(`items.${n}.quantity`,t.target.value),(Y(`items.${n}.vendors`)||[]).forEach(r=>{const c=N[n]?.[r.id];if(c){const a=ce({rate:c.rate,quantity:t.target.value,discount_percent:c.discount_percent,gst_percent:c.gst_percent,freight_charges:c.freight_charges,freight_gst_percentage:c.freight_gst_percentage,cutting_charges:c.cutting_charges,loading_charges:c.loading_charges});Z(o=>({...o,[n]:{...o[n],[r.id]:{...o[n]?.[r.id],total_amount:a.total_amount,net_amount:a.net_amount}}}))}})}})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-slate-500 block mb-1",children:"Last Rate:"}),e.jsx(_,{...U(`items.${n}.last_purchase_rate`),type:"number",className:"text-sm py-2 font-medium",placeholder:"0.00"})]})]})}),e.jsxs("div",{className:"flex items-end gap-4 w-full",children:[e.jsxs("div",{className:"flex-1 flex flex-col",children:[e.jsx("label",{className:"text-xs font-semibold text-slate-500 uppercase mb-1 hover:text-black cursor-default transition-colors",children:"Add Vendor"}),e.jsx(ue,{ref:ne,value:m,onChange:t=>{d(t),ve(t)},placeholder:"Select Vendor to Add",disabled:M,excludeVendorIds:[],onMount:()=>{}})]}),e.jsx("div",{className:"pb-0.5",children:e.jsx(H,{variant:"outline",className:"text-xs py-2 px-4 h-[40px] border-slate-300 hover:bg-slate-100 whitespace-nowrap",onClick:()=>{ae(!0),ne.current?.close()},children:"+ Add Party"})}),e.jsxs("div",{className:"flex-1 flex flex-col",children:[e.jsx("label",{className:"text-xs font-semibold text-slate-500 uppercase mb-1",children:"Select Vendor (Final Choice)"}),e.jsx(V,{name:`items.${n}.selected_vendor_id`,control:ee,render:({field:t})=>e.jsxs(ie,{...t,className:"text-sm py-2 bg-green-50 border-green-300",onChange:s=>{const r=s.target.value;t.onChange(r),r&&G(r),te(`items.${n}.selected_vendor_id`)},children:[e.jsx("option",{value:"",children:"Select Vendor"}),R.filter(s=>{const r=N[n]?.[s.id];return se(r)}).map(s=>e.jsxs("option",{value:s.id,children:[s.display_name||s.name||"Vendor"," - ₹",N[n]?.[s.id]?.rate||"0"]},s.id))]})})]})]}),R.length>0&&e.jsx("div",{className:"space-y-4",children:(()=>{const t=R.find(r=>r.id===v)||R[0];if(!t)return null;const s=R.findIndex(r=>r.id===t.id);return e.jsxs("div",{className:"bg-slate-50 rounded-lg border border-slate-200 p-4 shadow-sm",children:[e.jsxs("div",{className:"flex justify-between items-center mb-3 pb-2 border-b border-slate-300",children:[e.jsx("span",{className:"font-semibold text-slate-700 text-sm",children:t.display_name||t.name||`Vendor ${s+1}`}),R.length>1&&e.jsx("button",{type:"button",onClick:()=>Se(n,s),className:"text-red-400 hover:text-red-600 font-bold ml-2",children:"✕"})]}),e.jsxs("div",{className:"grid grid-cols-5 gap-3",children:[e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-xs text-slate-500 text-center font-medium",children:"Rate"}),e.jsx(_,{type:"number",className:"text-sm text-right py-2 px-2",placeholder:"0.00",value:N[n]?.[t.id]?.rate||"",onChange:r=>{Q(n,t.id,"rate",r.target.value)}})]}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-xs text-slate-500 text-center font-medium",children:"Disc%"}),e.jsx(_,{type:"number",className:"text-sm text-right py-2 px-2",placeholder:"0",value:N[n]?.[t.id]?.discount_percent||"",onChange:r=>{Q(n,t.id,"discount_percent",r.target.value)}})]}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-xs text-slate-500 text-center font-medium",children:"GST%"}),e.jsx(_,{type:"number",className:"text-sm text-right py-2 px-2",placeholder:"0",value:N[n]?.[t.id]?.gst_percent||"",onChange:r=>{Q(n,t.id,"gst_percent",r.target.value)}})]}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-xs text-slate-500 text-center font-medium",children:"Net Amount"}),e.jsx(_,{readOnly:!0,className:"bg-white border-slate-200 text-sm text-right font-medium py-2 px-2",value:N[n]?.[t.id]?.net_amount||""})]}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-xs text-slate-500 text-center font-medium",children:"Total Amount"}),e.jsx(_,{readOnly:!0,className:"bg-blue-50 border-blue-200 text-sm text-right font-semibold py-2 px-2",value:N[n]?.[t.id]?.total_amount||""})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mt-3 pt-3 border-t border-slate-200",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-xs text-slate-500 text-center font-medium",children:"Freight Charges"}),e.jsx(_,{type:"number",className:"text-sm text-right py-2 px-2",placeholder:"0.00",value:N[n]?.[t.id]?.freight_charges||"",onChange:r=>{Q(n,t.id,"freight_charges",r.target.value)}})]}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-xs text-slate-500 text-center font-medium",children:"Freight GST%"}),e.jsx(_,{type:"number",className:"text-sm text-right py-2 px-2",placeholder:"0",value:N[n]?.[t.id]?.freight_gst_percentage||"",onChange:r=>{Q(n,t.id,"freight_gst_percentage",r.target.value)}})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-xs text-slate-500 text-center font-medium",children:"Cutting Charges"}),e.jsx(_,{type:"number",className:"text-sm text-right py-2 px-2",placeholder:"0.00",value:N[n]?.[t.id]?.cutting_charges||"",onChange:r=>{Q(n,t.id,"cutting_charges",r.target.value)}})]}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-xs text-slate-500 text-center font-medium",children:"Loading Charges"}),e.jsx(_,{type:"number",className:"text-sm text-right py-2 px-2",placeholder:"0.00",value:N[n]?.[t.id]?.loading_charges||"",onChange:r=>{Q(n,t.id,"loading_charges",r.target.value)}})]})]})]})]},t.id)})()}),R.length>0&&e.jsxs("div",{className:"mt-6 border-t border-slate-200 pt-4",children:[e.jsxs("h3",{className:"text-sm font-semibold text-slate-700 mb-3",children:["Participating Vendors (",R.filter(t=>se(N[n]?.[t.id])).length,")"]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:R.map(t=>{const s=t.id===v,r=t.id===Y(`items.${n}.selected_vendor_id`);let c,a;r?(c="p-4 border-2 border-green-500 bg-green-50 rounded-lg shadow-sm cursor-pointer",a="font-semibold text-sm text-green-800"):s?(c="p-4 border border-gray-600 bg-gray-400 text-white rounded-lg shadow-sm cursor-pointer",a="font-semibold text-sm text-white"):(c="p-4 border border-slate-200 bg-white rounded-lg shadow-sm cursor-pointer hover:border-slate-300",a="font-semibold text-slate-800 text-sm");const o=N[n]?.[t.id];return se(o)?e.jsxs("div",{className:c,onClick:()=>G(t.id),children:[e.jsx("div",{className:"flex justify-between mb-2 items-center",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h4",{className:a,children:t.display_name||t.name}),r&&e.jsx("span",{className:"text-xs bg-green-500 text-white px-2 py-1 rounded-full",children:"Selected"})]})}),e.jsx("div",{className:"space-y-2",children:e.jsx("div",{className:r?"border border-green-200 rounded p-2 bg-green-100":s?"border border-gray-500/40 rounded p-2 bg-gray-500/30":"border border-slate-100 rounded p-2 bg-slate-50",children:e.jsxs("div",{className:"grid grid-cols-2 gap-1 text-[11px]",children:[e.jsxs("span",{className:r?"text-green-700":s?"text-white":"",children:["Rate: ₹",o?.rate||"0"]}),e.jsxs("span",{className:r?"text-green-700":s?"text-white":"",children:["Disc: ",o?.discount_percent||"0","%"]}),e.jsxs("span",{className:r?"text-green-700":s?"text-white":"",children:["GST: ",o?.gst_percent||"0","%"]}),e.jsxs("span",{className:`font-semibold ${r?"text-green-700":s?"text-white":""}`,children:["Net: ₹",o?.net_amount||"0"]}),(o?.loading_charges||o?.freight_charges||o?.cutting_charges)&&e.jsxs(e.Fragment,{children:[e.jsxs("span",{className:`text-[10px] ${r?"text-green-600":s?"text-white/90":"text-slate-600"}`,children:["Load: ₹",o?.loading_charges||"0"]}),e.jsxs("span",{className:`text-[10px] ${r?"text-green-600":s?"text-white/90":"text-slate-600"}`,children:["Freight: ₹",o?.freight_charges||"0"]}),e.jsxs("span",{className:`text-[10px] col-span-2 ${r?"text-green-600":s?"text-white/90":"text-slate-600"}`,children:["Cutting: ₹",o?.cutting_charges||"0"]})]}),e.jsxs("span",{className:`col-span-2 font-semibold ${r?"text-green-800":s?"text-white":"text-blue-700"}`,children:["Total: ₹",o?.total_amount||"0"]})]})})})]},t.id):null})})]}),R.length===0&&e.jsx("div",{className:"text-center p-8 bg-yellow-50 border border-yellow-200 rounded-lg text-yellow-700 text-sm",children:"Please add at least one vendor to compare rates."}),e.jsx("div",{className:"flex justify-end gap-3 mt-6 pt-4 border-t border-slate-200 sticky bottom-0 bg-white",children:e.jsx(H,{variant:"outline",onClick:le,children:"Close"})})]})}),e.jsx(Oe,{open:ge,onClose:()=>ae(!1),onSuccess:()=>{j.current||(j.current=!0,F({party_type:"Vendor"}).finally(()=>{j.current=!1}))}})]})};export{st as default};
