import{u as X,i as Y,a as Z,r as h,j as e,B as k,A as E,h as v,e as N,y as g}from"./index-CyRDNjis.js";import{T as p}from"./TextInput-DXETAqIv.js";import{S as ee}from"./Select-DOk7PkI7.js";import{L as re}from"./ListWrapper-CN8TGvDX.js";import{T as ae,a as te,b as m}from"./TableWrapper-CafYCdV6.js";import{T as se}from"./TableRow-D_ujNsvm.js";import{o as ne,j as le}from"./yup-D3aNZiQj.js";import{u as ie,b as de,C as _}from"./index.esm-w4ySVjAd.js";import{L as oe}from"./Loading-BBJJw7ob.js";import{F as ce}from"./FormHeader-BOf-iER0.js";import{C as me}from"./CommonFilter-Dp-i3AIl.js";import"./BackButton-Brb_nHm3.js";const ue={purchase_order_id:0,grn_date:new Date().toISOString().split("T")[0],delivery_challan_no:"",delivery_challan_date:"",purchase_order_no:"",purchase_order_date:"",items:[]},F=y=>{if(!y)return"";const O=new Date(y);return isNaN(O.getTime())?"":O.toISOString().split("T")[0]};function we(){const y=X(),[O]=Y(),o=O.get("editId"),{selectedBranchId:R,user:V}=Z(),[A,U]=h.useState([]),[B,C]=h.useState(null),[H,w]=h.useState(!1),[S,I]=h.useState(!1),[T,D]=h.useState(!1),[x,M]=h.useState({po_number:"",date_from:"",date_to:""}),{control:c,handleSubmit:W,watch:G,reset:$,setValue:q,formState:{errors:b}}=ie({defaultValues:ue,resolver:ne(le)}),{fields:L,replace:Q}=de({control:c,name:"items"}),P=G("purchase_order_id");h.useEffect(()=>{(async()=>{D(!0);try{const a={per_page:1e3,status:["Sent_to_Vendor","partially_received"],is_fully_received:0,branch_id:R};x.po_number&&(a.po_number=x.po_number),x.date_from&&(a.date_from=x.date_from),x.date_to&&(a.date_to=x.date_to);const j=((await v.get(N.purchase_order.list,{params:a,paramsSerializer:l=>{const i=new URLSearchParams;return Object.entries(l).forEach(([n,d])=>{Array.isArray(d)?d.forEach(f=>i.append(`${n}[]`,f)):i.append(n,String(d))}),i.toString()}})).data.purchase_orders||[]).filter(l=>!l.items||l.items.length===0?!1:l.items.some(i=>{const n=i.quantity_ordered||0,d=i.quantity_received||0;return n>d}));U(j)}catch(t){console.log(t),g.error("Failed to fetch Purchase Orders")}finally{D(!1)}})()},[R,x]),h.useEffect(()=>{o&&(async()=>{w(!0);try{const a=(await v.get(N.grn.details(parseInt(o)))).data.grn;$({purchase_order_id:a.purchase_order_id,grn_date:F(a.grn_date),delivery_challan_no:a.delivery_challan_no||"",delivery_challan_date:F(a.delivery_challan_date),items:a.items.map(r=>({id:r.id,po_item_id:r.po_item_id,item_id:r.item_id,item_name:r.item?.item_name||r.item_name||"",item_code:r.item?.item_code||r.item_code||"",unit_name:r.item?.unit?.unit_name||r.item_unit||"",quantity_received:r.quantity_received||0,purchase_order_quantity:r.purchase_order_quantity||0,short_quantity:r.short_quantity||0,excess_quantity:r.excess_quantity||0,remarks:r.remarks||""}))}),C({...a.purchase_order,vendor:a.vendor||a.purchase_order?.vendor,branch:a.branch||a.purchase_order?.branch})}catch(t){console.log(t),g.error("Failed to load GRN data"),y(E.GOOD_RECEIVE_REPORT.LIST)}finally{w(!1)}})()},[o,$,y]),h.useEffect(()=>{(async()=>{if(P&&P>0&&!o){w(!0);try{const t=await v.get(N.purchase_order.details(P)),a=t.data.purchase_order||t.data.data;if(a){C(a),q("purchase_order_no",a.po_number),q("purchase_order_date",F(a.po_date));const r=a.grns||[],u={};r.forEach(l=>{l.items?.forEach(i=>{const n=i.po_item_id,d=parseFloat(i.quantity_received)||0;u[n]=(u[n]||0)+d})});const j=(a.items||[]).map(l=>{const i=parseFloat(l.quantity_ordered)||0,n=u[l.id]||0,d=n>=i;return{po_item_id:l.id,item_id:l.item_id,item_name:l.item?.item_name||l.item_name||"",item_code:l.item?.item_code||l.item_code||"",unit_name:l.item?.unit?.unit_name||l.item_unit||l.unit||"",quantity_received:0,purchase_order_quantity:i,short_quantity:0,excess_quantity:0,remarks:"",total_received_qty:n,is_fully_received:d}});Q(j)}}catch(t){console.log(t),g.error("Failed to fetch Purchase Order details")}finally{w(!1)}}})()},[P,o,Q,q]);const z=[{name:"po_number",label:"PO Number",type:"text",placeholder:"Enter PO Number"},{name:"date_from",label:"Date From",type:"date"},{name:"date_to",label:"Date To",type:"date"}],J=s=>{M(s)},K=async s=>{const t=s.items.map(r=>{const u={po_item_id:r.po_item_id,quantity_received:r.quantity_received,purchase_order_quantity:r.purchase_order_quantity,short_quantity:r.short_quantity,excess_quantity:r.excess_quantity,remarks:r.remarks};return o&&r.id&&(u.id=r.id),u});if(t.length===0){g.error("Please enter quantity received for at least one item");return}const a={grn_date:s.grn_date,delivery_challan_no:s.delivery_challan_no||null,delivery_challan_date:s.delivery_challan_date||null,branch_id:R,items:t,purchase_order_id:s.purchase_order_id};o&&(a.purchase_order_id=s.purchase_order_id),I(!0);try{o?(await v.put(N.grn.update(parseInt(o)),a),g.success("GRN updated successfully")):(await v.post(N.grn.create,a),g.success("GRN created successfully")),y(E.GOOD_RECEIVE_REPORT.LIST)}catch(r){console.log(r),g.error(r.response?.data?.message||"Failed to save GRN")}finally{I(!1)}};return H?e.jsx("div",{className:"flex justify-center py-20",children:e.jsx(oe,{})}):e.jsxs("div",{className:"w-full h-full overflow-auto space-y-8 p-4 pb-20",children:[e.jsx("div",{className:"space-y-1",children:e.jsx(ce,{title:o?"Edit GRN":"Create Goods Receipt Note (GRN)",subtitle:o?"Update the GRN details":"Select a Purchase Order and enter received quantities"})}),e.jsxs(e.Fragment,{children:[e.jsx(me,{fields:z,onFilter:J,defaultValues:x}),e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-lg font-semibold mb-4",children:"GRN Details"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-5",children:[e.jsx(_,{name:"purchase_order_id",control:c,render:({field:s})=>e.jsxs(ee,{...s,label:"Select Purchase Order",required:!0,error:b.purchase_order_id?.message,disabled:!!o||T,onChange:t=>{s.onChange(parseInt(t.target.value)||0)},children:[e.jsx("option",{value:"",children:T?"Loading...":"Select Purchase Order"}),A.map(t=>e.jsxs("option",{value:t.id,children:[t.po_number," - ",t.vendor?.party_name]},t.id))]})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Vendor"}),e.jsx("p",{className:"text-gray-900 bg-gray-100 px-3 py-2 rounded-lg min-h-[42px] flex items-center",children:B?.vendor?.party_name||"-"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Branch"}),e.jsx("p",{className:"text-gray-900 bg-gray-100 px-3 py-2 rounded-lg min-h-[42px] flex items-center",children:V?.branch?.branch_name||"Udaipur Head Office"})]}),e.jsx(_,{name:"purchase_order_no",control:c,render:({field:s})=>e.jsx(p,{...s,label:"Purchase Order No",placeholder:"Enter Purchase Order No",error:b.purchase_order_no?.message})}),e.jsx(_,{name:"purchase_order_date",control:c,render:({field:s})=>e.jsx(p,{...s,type:"date",label:"Purchase Order Date",error:b.purchase_order_date?.message})}),e.jsx(_,{name:"delivery_challan_no",control:c,render:({field:s})=>e.jsx(p,{...s,label:"Challan/Invoice No",placeholder:"Enter Challan No",error:b.delivery_challan_no?.message})}),e.jsx(_,{name:"delivery_challan_date",control:c,render:({field:s})=>e.jsx(p,{...s,type:"date",label:"Challan Date",error:b.delivery_challan_date?.message})})]})]}),e.jsx(re,{title:"Items to Receive",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(ae,{children:[e.jsx(te,{cols:[{title:"Item Name"},{title:"Item Code"},{title:"Unit"},{title:"P.O. Qty"},{title:"Total Received"},{title:"Received Qty"},{title:"Short Qty"},{title:"Excess Qty"},{title:"Status"},{title:"Remarks"}]}),e.jsx("tbody",{children:L.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:11,className:"text-center py-8 text-gray-500",children:"No items found in selected Purchase Order"})}):L.map((s,t)=>{const a=G(`items.${t}`),r=a?.is_fully_received||!1,u=a?.total_received_qty||0,j=parseFloat(a?.purchase_order_quantity||"0"),l=parseFloat(u),i=Math.max(0,j-l);return e.jsxs(se,{children:[e.jsx(m,{className:"text-center w-16",children:t+1}),e.jsx(m,{className:"min-w-[200px]",children:e.jsx("span",{className:"font-medium text-sm",children:s.item_name})}),e.jsx(m,{className:"min-w-[120px] text-sm",children:s.item_code}),e.jsx(m,{className:"min-w-[80px] text-sm",children:s.unit_name}),e.jsx(m,{className:"min-w-[100px]",children:e.jsx(_,{name:`items.${t}.purchase_order_quantity`,control:c,render:({field:n})=>e.jsx(p,{...n,type:"number",placeholder:"PO Qty",className:"w-full min-w-[90px] bg-gray-50",readOnly:!0})})}),e.jsx(m,{className:"min-w-[120px]",children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:`text-sm font-medium ${r?"text-green-600":"text-gray-700"}`,children:u}),e.jsxs("span",{className:"text-xs text-gray-500",children:["Remaining: ",i.toFixed(3)]})]})}),e.jsx(m,{className:"min-w-[120px]",children:e.jsx(_,{name:`items.${t}.quantity_received`,control:c,render:({field:n})=>e.jsx(p,{...n,type:"number",placeholder:r?"Fulfilled":"Qty",className:`w-full min-w-[100px] ${r?"bg-gray-100 cursor-not-allowed":""}`,error:b.items?.[t]?.quantity_received?.message,onChange:d=>n.onChange(d.target.value),readOnly:r,disabled:r,max:i,title:r?"This item is fully received":`Maximum: ${i.toFixed(3)}`})})}),e.jsx(m,{className:"min-w-[120px]",children:e.jsx(_,{name:`items.${t}.short_quantity`,control:c,render:({field:n})=>e.jsx(p,{...n,type:"number",placeholder:"Short",className:`w-full min-w-[100px] ${r?"bg-gray-100 cursor-not-allowed":""}`,onChange:d=>{const f=d.target.value;n.onChange(f===""?"":Number(f))},readOnly:r,disabled:r})})}),e.jsx(m,{className:"min-w-[120px]",children:e.jsx(_,{name:`items.${t}.excess_quantity`,control:c,render:({field:n})=>e.jsx(p,{...n,type:"number",placeholder:"Excess",className:`w-full min-w-[100px] ${r?"bg-gray-100 cursor-not-allowed":""}`,onChange:d=>{const f=d.target.value;n.onChange(f===""?"":Number(f))},readOnly:r,disabled:r})})}),e.jsx(m,{className:"min-w-[100px]",children:e.jsx("div",{className:"flex justify-center",children:r?e.jsx("span",{className:"px-2 py-1 text-xs font-semibold text-green-800 bg-green-100 rounded-full",children:"Fulfilled"}):l>0?e.jsx("span",{className:"px-2 py-1 text-xs font-semibold text-yellow-800 bg-yellow-100 rounded-full",children:"Partial"}):e.jsx("span",{className:"px-2 py-1 text-xs font-semibold text-gray-800 bg-gray-100 rounded-full",children:"Pending"})})}),e.jsx(m,{className:"min-w-[150px]",children:e.jsx(_,{name:`items.${t}.remarks`,control:c,render:({field:n})=>e.jsx(p,{...n,placeholder:"Remarks",className:`w-full min-w-[130px] ${r?"bg-gray-100 cursor-not-allowed":""}`,readOnly:r,disabled:r})})})]},s.id)})})]})})}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx(k,{variant:"outline",onClick:()=>y(E.GOOD_RECEIVE_REPORT.LIST),disabled:S,children:"Cancel"}),e.jsx(k,{onClick:W(K),loading:S,disabled:S,children:o?"Update GRN":"Create GRN"})]})]})]})}export{we as default};
